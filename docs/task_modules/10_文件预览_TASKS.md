# 文件预览（PDF 原生预览） - Task 分解

> **来源**: docs/design/mvp/10_文件预览.md  
> **总工作量**: 80h  
> **优先级**: P1（MVP 功能）  
> **依赖**: 文档管理模块（TASK-001）

---

## Task 统计

| 类型 | 数量 | 工作量 |
|------|------|--------|
| 数据模型 | 0 | 0h（复用已有表） |
| 后端 API | 1 | 16h |
| 前端 UI | 2 | 32h |
| 测试 | 2 | 32h |
| **总计** | **5** | **80h** |

---

## TASK-118: 实现文件预签名 URL 生成 API

**类型**: 后端 API
**工作量**: 16h
**优先级**: P1
**依赖**: TASK-004（MinIO 文件上传服务）

**描述**: 实现文件预签名 URL 生成 API，用于 PDF 预览。

**API 端点**:
- GET /api/v1/documents/:id/preview-url

**验收标准**:
- [ ] 生成 MinIO 预签名 URL（有效期 15 分钟）
- [ ] 权限校验（只有授权用户可获取预签名 URL）
- [ ] 异常处理（文档不存在、无权限、生成失败）
- [ ] 单元测试覆盖率 ≥ 80%（核心业务逻辑必须 100%，边缘逻辑可低于 80%）
- [ ] API 文档（Swagger）生成

**技术要点**:
- 使用 MinIO SDK 生成预签名 URL
- 设置 URL 有效期为 15 分钟

**相关文件**:
- server/src/modules/document/document.controller.ts
- server/src/modules/minio/minio.service.ts

---

## TASK-119: 实现 PDF 预览组件（前端）

**类型**: 前端 UI
**工作量**: 24h
**优先级**: P1
**依赖**: TASK-118

**描述**: 实现 PDF 预览组件，支持原生 PDF 预览。

**功能要求**:
- 使用 `<embed>` 或 `<iframe>` 标签原生预览 PDF
- 支持缩放、翻页
- 支持全屏预览
- 显示加载进度

**验收标准**:
- [ ] PDF 预览功能正常（调用 TASK-118 API 获取预签名 URL）
- [ ] 支持缩放、翻页
- [ ] 支持全屏预览
- [ ] 加载进度显示正确
- [ ] 异常处理（加载失败、网络错误）
- [ ] 权限校验（无权限时禁用预览）
- [ ] 响应式布局

**技术要点**:
- 浏览器兼容性处理：
  - Chrome/Edge/Firefox: 优先使用 <embed> 标签（原生支持）
  - Safari: 使用 <iframe> 标签
  - 移动端浏览器: 降级到下载提示（提示用户下载后查看）
  - 检测浏览器类型: 使用 navigator.userAgent

**主要组件**:
- PdfViewer.vue - PDF 预览组件

**相关文件**:
- client/src/components/PdfViewer.vue

---

## TASK-120: 实现文件预览对话框（前端）

**类型**: 前端 UI
**工作量**: 8h
**优先级**: P1
**依赖**: TASK-119

**描述**: 实现文件预览对话框，支持弹窗预览 PDF。

**功能要求**:
- 预览按钮
- 预览对话框（全屏）
- 关闭按钮

**验收标准**:
- [ ] 预览按钮正确显示
- [ ] 点击后弹出预览对话框
- [ ] 对话框全屏显示
- [ ] 关闭按钮功能正常
- [ ] 异常处理

**相关文件**:
- client/src/views/document/DocumentDetail.vue

---

## TASK-121: 编写文件预览单元测试（后端）

**类型**: 测试
**工作量**: 16h
**优先级**: P1
**依赖**: TASK-118

**描述**: 编写文件预览模块的单元测试。

**测试范围**:
- 预签名 URL 生成逻辑

**验收标准**:
- [ ] 单元测试覆盖率 ≥ 80%（核心业务逻辑必须 100%，边缘逻辑可低于 80%）
- [ ] 所有测试通过

**相关文件**:
- server/test/minio.service.spec.ts

---

## TASK-122: 编写前端组件单元测试

**类型**: 测试
**工作量**: 16h
**优先级**: P2
**依赖**: TASK-119, TASK-120

**描述**: 编写前端组件的单元测试。

**测试范围**:
- PdfViewer.vue

**验收标准**:
- [ ] 所有核心组件有对应测试用例
- [ ] 所有测试通过

**相关文件**:
- client/src/components/__tests__/PdfViewer.spec.ts

---

**本文档完成 ✅**
