# 数据导出（Excel 导出） - Task 分解

> **来源**: docs/design/mvp/09_数据导出.md  
> **总工作量**: 120h  
> **优先级**: P1（MVP 功能）  
> **依赖**: 文档管理模块（TASK-001）、任务管理模块（TASK-038）

---

## Task 统计

| 类型 | 数量 | 工作量 |
|------|------|--------|
| 数据模型 | 0 | 0h（复用已有表） |
| 后端 API | 4 | 64h |
| 前端 UI | 2 | 32h |
| 测试 | 2 | 24h |
| **总计** | **8** | **120h** |

---

## TASK-110: 实现文档列表导出 API

**类型**: 后端 API
**工作量**: 16h
**优先级**: P1
**依赖**: TASK-001

**描述**: 实现文档列表导出 API，导出为 Excel 文件。

**API 端点**:
- GET /api/v1/documents/export

**验收标准**:
- [ ] 支持导出所有文档列表
- [ ] 支持筛选条件导出（级别、部门、状态）
- [ ] 导出字段：编号、标题、版本、状态、创建人、创建时间
- [ ] 使用 xlsx 库生成 Excel 文件
- [ ] 设置正确的 Content-Type 和文件名
- [ ] 权限校验
- [ ] 异常处理
- [ ] 单元测试覆盖率 ≥ 80%（核心业务逻辑必须 100%，边缘逻辑可低于 80%）

**相关文件**:
- server/src/modules/document/document.controller.ts
- server/src/modules/export/export.service.ts

---

## TASK-111: 实现任务记录导出 API

**类型**: 后端 API
**工作量**: 24h
**优先级**: P1
**依赖**: TASK-038

**描述**: 实现任务记录导出 API，导出动态表单数据为 Excel 文件。

**API 端点**:
- GET /api/v1/tasks/:id/export

**验收标准**:
- [ ] 导出任务基本信息（模板名称、执行部门、截止时间、状态）
- [ ] 导出动态表单数据（字段名称、字段值）
- [ ] 复杂字段类型处理正确：
  - 文本/数值/日期字段: 直接导出原始值
  - 下拉/单选/复选框字段: 导出选项文本（非 ID）
  - 上传/图片字段: 导出 MinIO URL（完整 HTTP 路径）
  - 签名字段: 导出 base64 字符串或转为图片 URL
  - 富文本字段: 导出纯文本（使用 strip-html 去除 HTML 标签）
  - 级联选择/树选择: 导出完整路径（用 / 分隔，如 "浙江省/杭州市/西湖区"）
  - 位置字段: 导出经纬度（格式: "lat,lng"）
  - 扫码字段: 导出扫描结果文本
- [ ] 支持多任务批量导出
- [ ] 使用 xlsx 库生成 Excel 文件
- [ ] 设置正确的 Content-Type 和文件名
- [ ] 权限校验
- [ ] 异常处理
- [ ] 单元测试覆盖率 ≥ 80%（核心业务逻辑必须 100%，边缘逻辑可低于 80%）

**相关文件**:
- server/src/modules/task/task.controller.ts
- server/src/modules/export/export.service.ts

---

## TASK-112: 实现统计报表导出 API

**类型**: 后端 API
**工作量**: 16h
**优先级**: P1
**依赖**: TASK-100, TASK-101, TASK-102

**描述**: 实现统计报表导出 API，导出统计数据为 Excel 文件。

**API 端点**:
- GET /api/v1/statistics/export

**验收标准**:
- [ ] 支持导出文档统计报表
- [ ] 支持导出任务统计报表
- [ ] 支持导出审批统计报表
- [ ] 使用 xlsx 库生成 Excel 文件
- [ ] 设置正确的 Content-Type 和文件名
- [ ] 权限校验
- [ ] 异常处理
- [ ] 单元测试覆盖率 ≥ 80%（核心业务逻辑必须 100%，边缘逻辑可低于 80%）

**相关文件**:
- server/src/modules/statistics/statistics.controller.ts
- server/src/modules/export/export.service.ts

---

## TASK-113: 实现偏离报告导出 API

**类型**: 后端 API
**工作量**: 8h
**优先级**: P1
**依赖**: TASK-087

**描述**: 实现偏离报告导出 API，导出为 Excel 文件。

**API 端点**:
- GET /api/v1/deviations/export

**验收标准**:
- [ ] 支持导出所有偏离报告
- [ ] 支持筛选条件导出（状态、日期范围）
- [ ] 导出字段：字段名称、期望值、实际值、偏离量、原因、状态
- [ ] 使用 xlsx 库生成 Excel 文件
- [ ] 设置正确的 Content-Type 和文件名
- [ ] 权限校验
- [ ] 异常处理
- [ ] 单元测试覆盖率 ≥ 80%（核心业务逻辑必须 100%，边缘逻辑可低于 80%）

**相关文件**:
- server/src/modules/deviation/deviation.controller.ts
- server/src/modules/export/export.service.ts

---

## TASK-114: 实现导出按钮组件（前端）

**类型**: 前端 UI
**工作量**: 16h
**优先级**: P1
**依赖**: TASK-110, TASK-111, TASK-112, TASK-113

**描述**: 实现导出按钮组件，支持各种列表的导出功能。

**功能要求**:
- 导出按钮
- 下载进度提示
- 下载成功提示

**验收标准**:
- [ ] 导出按钮正确显示
- [ ] 点击后调用对应的导出 API
- [ ] 下载进度提示正确
- [ ] 下载成功后提示信息
- [ ] 异常处理（导出失败、网络错误）
- [ ] 权限校验（无权限时禁用按钮）

**相关文件**:
- client/src/components/ExportButton.vue

---

## TASK-115: 实现批量导出功能（前端）

**类型**: 前端 UI
**工作量**: 16h
**优先级**: P1
**依赖**: TASK-111

**描述**: 实现批量导出功能，支持勾选多条记录批量导出。

**功能要求**:
- 复选框选择多条记录
- 批量导出按钮
- 下载进度提示

**验收标准**:
- [ ] 复选框选择功能正常
- [ ] 批量导出按钮正确显示
- [ ] 批量导出功能正常（调用 TASK-111 API）
- [ ] 导出数据量限制（单次最多 10,000 条记录）
- [ ] 超过限制时提示用户分批导出
  - 提示文案: "数据量过大，请缩小筛选范围或分批导出"
- [ ] 下载进度提示正确
- [ ] 异常处理
- [ ] 权限校验

**相关文件**:
- client/src/views/task/TaskList.vue

---

## TASK-116: 编写数据导出单元测试（后端）

**类型**: 测试
**工作量**: 12h
**优先级**: P1
**依赖**: TASK-110, TASK-111, TASK-112, TASK-113

**描述**: 编写数据导出模块的单元测试。

**测试范围**:
- 文档列表导出逻辑
- 任务记录导出逻辑
- 统计报表导出逻辑
- 偏离报告导出逻辑

**验收标准**:
- [ ] 单元测试覆盖率 ≥ 80%（核心业务逻辑必须 100%，边缘逻辑可低于 80%）
- [ ] 所有测试通过

**相关文件**:
- server/test/export.service.spec.ts

---

## TASK-117: 编写数据导出集成测试（后端）

**类型**: 测试
**工作量**: 12h
**优先级**: P1
**依赖**: TASK-110, TASK-111, TASK-112, TASK-113

**描述**: 编写数据导出模块的集成测试。

**测试范围**:
- GET /api/v1/documents/export
- GET /api/v1/tasks/:id/export
- GET /api/v1/statistics/export
- GET /api/v1/deviations/export

**验收标准**:
- [ ] 所有 API 端点有对应测试用例
- [ ] 验证 Excel 文件生成正确
- [ ] 所有测试通过

**相关文件**:
- server/test/export.e2e-spec.ts

---

**本文档完成 ✅**
