# 文档管理系统 - 完整需求设计文档

> 最后更新: 2026-02-06
> 文档版本: 3.0
> MVP Phase 1-6 完成 98.1% | Phase 7-12 详细设计完成（PRD + LLD）

---

## 目录

1. [项目概述](#一项目概述)
2. [技术架构](#二技术架构)
3. [文档分级体系](#三文档分级体系)
4. [核心功能模块](#四核心功能模块)
5. [业务规则](#五业务规则)
6. [工程化约束](#六工程化约束)
7. [数据模型](#七数据模型)
8. [API设计](#八api设计)
9. [前端设计](#九前端设计)
10. [90个已确认细节](#九十个已确认细节)
11. [开发顺序建议](#十一开发顺序建议)
12. [额外建议](#十二额外建议)
13. [项目里程碑](#十三项目里程碑)
14. [MVP Issue清单](#十四mvp-issue清单)
15. [待办事项](#十五待办事项)
16. [完整版扩展规划](#十六完整版扩展规划)
17. [MVP范围说明](#十七mvp范围说明)

---

## 一、项目概述

### 1.1 项目目标

建立一个企业内部文档管理系统，支持：
- 四级文件体系管理（一级/二级/三级/四级）
- 文档上传、审批、版本管理
- 四级文件模板创建与任务分发
- 用户与权限管理

### 1.2 技术栈

| 层级 | 技术 | 版本 | 说明 |
|------|------|------|------|
| 前端 | Vue 3 + Element Plus + Vite + Pinia | ^3.4.0 / ^2.5.0 / ^5.0.0 / ^2.1.0 | 上手简单，生态丰富 |
| 后端 | Node.js + NestJS + TypeScript + Prisma | 18.x / ^10.0.0 / ^5.3.0 / ^5.7.0 | 企业级框架，稳定 |
| 数据库 | PostgreSQL + Redis | >=15.0 / >=7.0 | JSON支持好，适合动态表单 |
| 文件存储 | MinIO | Latest | 本地部署，数据自主可控 |
| 部署 | Docker + Docker Compose | >=24.0 / >=2.20 | 环境一致，不出错 |
| 共享 | TypeScript 类型定义 | packages/types | 前后端类型共享 |

### 1.3 目录结构

```
noidear/
├── client/                    # 前端 Vue 3 项目
│   ├── src/
│   ├── public/
│   └── package.json
├── server/                    # 后端 NestJS 项目
│   ├── src/
│   │   ├── modules/          # 按域分模块
│   │   │   ├── auth/         # 认证模块
│   │   │   ├── user/         # 用户模块
│   │   │   ├── department/   # 部门模块
│   │   │   ├── document/     # 文档模块
│   │   │   ├── template/     # 模板模块
│   │   │   ├── task/         # 任务模块
│   │   │   └── approval/     # 审批模块
│   │   ├── common/           # 公共模块
│   │   └── prisma/           # 数据库模型
│   └── package.json
├── packages/                  # 共享包
│   └── types/                 # TypeScript 类型定义
│       ├── index.ts           # 导出所有类型
│       ├── user.ts            # 用户相关类型
│       ├── document.ts        # 文档相关类型
│       ├── template.ts        # 模板相关类型
│       ├── task.ts            # 任务相关类型
│       └── api.ts             # API 响应类型
├── docker-compose.yml         # 开发环境 Docker 配置
├── docker-compose.prod.yml    # 生产环境 Docker 配置
├── data/                      # 数据持久化目录
│   ├── postgres/              # PostgreSQL 数据
│   └── minio/                 # MinIO 数据
└── uploads/                   # 本地临时文件目录
```

### 1.4 数据库

- 数据库名称: `document_system`
- 主键类型: 雪花ID（Snowflake ID）
- 软删除: `deleted_at` 字段（datetime）
- 事务: 创建文件时使用（编号+记录一起成功或失败）
- 并发: 任务提交加锁，数据库事务保证数据一致性

---

## 二、技术架构

### 2.1 开发环境

| 服务 | 端口 | 说明 |
|------|------|------|
| PostgreSQL | 5432 | 主数据库 |
| Redis | 6379 | 缓存 |
| MinIO | 9000 | 对象存储 |
| MinIO Console | 9001 | 管理界面 |
| NestJS | 3000 | 后端API |
| Vue Dev | 5173 | 前端开发 |

### 2.2 部署方案

- 开发环境: Docker Compose
- Docker 配置: 分开两份（dev/prod）
- 文件存储: MinIO，按部门分桶
- 访问方式: VPN + 内网
- HTTPS: 暂时不需要，公网访问时再加

### 2.3 安全配置

- 密码加密: bcrypt（自动加盐）
- 登录锁定: 5次失败锁定账号
- Token: Header 传递 `Authorization: Bearer xxx`
- 验证码: 不需要（MVP阶段）
- 接口限流: 不限流

---

## 三、文档分级体系

### 3.1 四级文件定义

| 级别 | 文件类型 | 说明 | 上传/创建方式 | 审批流程 |
|------|----------|------|---------------|----------|
| 一级 | 管理手册 | 质量方针、目标 | 上传文件（PDF/Word/Excel） | 上传→提交审批→通过→发布 |
| 二级 | 程序文件 | 管理制度、流程 | 上传文件（PDF/Word/Excel） | 上传→提交审批→通过→发布 |
| 三级 | 作业指导书 | 操作规范、标准 | 上传文件（PDF/Word/Excel） | 上传→提交审批→通过→发布 |
| 四级 | 记录表单 | 填写记录、证据 | 创建表单模板 | 创建模板→发布→任务分发→填写→审批 |

### 3.2 编号规则

**编号格式**: `{级别}-{部门代码}-{序号}`

示例:
```
1-RD-001    （一级文件）
2-RD-001    （二级文件）
3-RD-001    （三级文件）
4-RD-001    （四级文件）
```

**规则**:
- 文件编号生成后不能修改
- 编号删除后记录待补齐，下次新建时优先使用
- 不同级别的文件使用不同的编号序列

---

## 四、核心功能模块

### 4.1 用户管理

| 功能 | 说明 |
|------|------|
| 用户列表 | 查看所有用户 |
| 新增用户 | 手动添加 |
| 编辑用户 | 修改信息、状态、部门 |
| 删除用户 | 软删除（deleted_at） |
| 修改密码 | 用户可修改自己的密码 |
| 批量导入 | MVP不支持 |

**用户状态**: 启用/禁用

### 4.2 组织架构

| 功能 | 说明 |
|------|------|
| 部门列表 | 查看所有部门 |
| 新增部门 | 支持2级（公司→部门） |
| 编辑部门 | 修改名称、上级部门 |
| 删除部门 | 检查后删除（有文件时提示） |
| 停用部门 | 用户转无部门状态 |

**规则**:
- 一人只能属一个部门
- 一人只能有一个上级
- 部门停用后用户转"无部门"

### 4.3 文件管理

| 功能 | 说明 |
|------|------|
| 文件上传 | 支持拖拽、批量上传 |
| 文件列表 | 显示编号、名称、状态、创建人、创建时间 |
| 文件搜索 | 支持名称和编号搜索 |
| 文件排序 | 支持创建时间、编号排序 |
| 文件删除 | 草稿/待审批可删；已发布不能删除只能停用；停用后可彻底删除 |
| 文件下载 | 有权限才能下载 |
| 版本管理 | 修改后自动+版本号，旧版本可查看但不能下载，MVP不支持回滚 |

**文件类型**: PDF、Word、Excel
**文件大小限制**: 10MB
**文件名**: 需要填写，可重复时提示用户修改

### 4.4 审批流程

| 功能 | 说明 |
|------|------|
| 提交审批 | 上传文件后提交 |
| 审批操作 | 通过（选填意见）/ 驳回（必填意见） |
| 审批历史 | 能查看自己审批过的文件 |
| 意见可见 | 依次审批时能看到前面人的意见 |
| 驳回处理 | 驳回后状态变"草稿"，修改后重新提交 |

**审批人确定**: 从用户的上级中选择（用户必须有上级）
**会签**: 支持多人同时审批（需全部通过）
**依次审批**: 支持一人审批后下一人审批
**兜底**: Admin可以审批任何文件

### 4.5 四级模板管理

| 功能 | 说明 |
|------|------|
| 模板创建 | Excel上传解析 / 手动创建 |
| 模板字段 | 文本、长文本、数值、日期、下拉、是/否 |
| 字段排序 | 支持拖拽排序 |
| 字段默认值 | 支持设置默认值 |
| 模板复制 | 支持复制模板 |
| 模板列表 | 显示编号、名称、版本、创建人、创建时间 |
| 模板筛选 | 支持筛选 |
| 模板停用 | 停用后已分发任务不受影响 |
| 模板删除 | 支持删除 |

### 4.6 任务分发

| 功能 | 说明 |
|------|------|
| 任务分发 | 发给部门，部门内人人都能看到 |
| 任务列表 | 显示模板名称、执行人、截止时间、状态 |
| 任务筛选 | Tabs切换（全部/待完成/已完成） |
| 任务填写 | 部门内任意一人填写 |
| 任务提交 | 第一人提交后锁定，不能修改 |
| 任务取消 | 发起人可以取消任务 |
| 任务转发 | 不支持 |
| 逾期标记 | 红色标记 |

**截止日期**: 必填，过期站内消息提醒
**执行规则**: 部门内任意一人都可以填写，第一人提交后锁定

### 4.7 站内消息

| 功能 | 说明 |
|------|------|
| 消息类型 | 任务通知、审批通知、逾期提醒 |
| 已读状态 | 显示已读/未读 |
| 消息保留 | 30天自动清理 |

---

## 五、业务规则

| 规则编号 | 规则描述 |
|---------|----------|
| BR-001 | 编号规则配置后，新文件自动按规则生成文件编号 |
| BR-002 | 一级/二级/三级文件创建后必须提交审批，不审批不可发布 |
| BR-003 | 四级文件（模板）创建后直接发布，无需审批 |
| BR-004 | 四级文件（记录）填写后提交审批，审批通过后归档 |
| BR-005 | 模板停用后，不可再新建数据，历史数据可查询 |
| BR-006 | 文件提交后不允许修改，只能查看或撤回 |
| BR-007 | 文件名称同级别内不可重复 |
| BR-008 | 编号删除后，系统记录待补齐编号，下次新建时优先使用 |
| BR-009 | 任务必须指定执行人，否则无法分发 |
| BR-010 | 归档后的数据不可修改，只能查看 |
| BR-011 | 不同级别的文件使用不同的编号序列 |
| BR-012 | 审批驳回时必须填写驳回原因 |
| BR-013 | 文件修改后自动+版本号（1.0→1.1→1.2） |
| BR-014 | 任务第一人提交后，其他人不能再提交，只能查看 |
| BR-014a | 任务发给部门，部门内任意一人都可填写 |
| BR-015 | 用户名唯一，英文+数字，最小3位 |
| BR-016 | 密码最小8位，无需复杂度和特殊字符 |

---

## 六、工程化约束

> **目的**：防止AI乱发挥，确保模块独立、可维护
> **适用范围**：所有开发者/AI Agent

### 6.1 模块化约束

| 约束 | 说明 | 违规处理 |
|------|------|----------|
| **模块独立** | 新增模块不修改现有模块代码 | 重构到独立模块 |
| **API稳定** | 现有API端点不变 | 禁止修改已有API |
| **数据库隔离** | 新功能新建表，不改现有表结构 | 禁止修改现有表 |
| **组件复用** | 相同UI必须提取到components/ | 禁止重复实现 |

### 6.2 代码规范约束

| 约束 | 要求 | 来源 |
|------|------|------|
| 函数长度 | < 50行 | Good Taste |
| 缩进层数 | < 3层 | Good Taste |
| 向后兼容 | 不破坏现有功能 | Never break userspace |
| 异常处理 | 所有API必须有try-catch | 安全规范 |

### 6.3 新增模块步骤

> 以下步骤为AI/开发者必须遵守

```
1. 前端：在 views/ 新建模块目录
2. 前端：在 api/ 新建模块API文件
3. 后端：在 modules/ 新建模块目录
4. 后端：在 prisma/schema.prisma 新增模型（禁止修改现有模型）
5. 路由：在 router/index.js 添加路由
6. 菜单：根据角色动态显示（配置文件控制）
```

### 6.4 禁止行为清单

- ❌ 引入未在技术栈清单中的库
- ❌ 更换框架（Vue 3 → React）
- ❌ 修改项目目录结构
- ❌ 硬编码密码/密钥
- ❌ 使用裸SQL（必须用Prisma）
- ❌ 修改现有API端点
- ❌ 添加MVP范围外功能

---

## 七、数据模型

### 6.1 核心表

```sql
-- 用户表
users (
  id              SnowflakeID   PRIMARY KEY,
  username        VARCHAR(50)   UNIQUE NOT NULL,    -- 用户名（英文+数字）
  password        VARCHAR(255)  NOT NULL,           -- bcrypt加密
  name            VARCHAR(100)  NOT NULL,           -- 姓名
  department_id   SnowflakeID   REFERENCES departments(id),
  role            VARCHAR(20)   NOT NULL DEFAULT 'user',  -- user/leader/admin
  superior_id     SnowflakeID   REFERENCES users(id),     -- 上级ID
  status          VARCHAR(10)   NOT NULL DEFAULT 'active', -- active/inactive
  login_attempts  INT           DEFAULT 0,               -- 登录失败次数
  locked_until    TIMESTAMP,                            -- 锁定截止时间
  created_at      TIMESTAMP   DEFAULT NOW(),
  updated_at      TIMESTAMP   DEFAULT NOW(),
  deleted_at      TIMESTAMP                              -- 软删除
);

-- 部门表
departments (
  id          SnowflakeID   PRIMARY KEY,
  code        VARCHAR(20)   UNIQUE NOT NULL,    -- 部门代码
  name        VARCHAR(100)  NOT NULL,           -- 部门名称
  parent_id   SnowflakeID   REFERENCES departments(id),  -- 上级部门
  status      VARCHAR(10)   NOT NULL DEFAULT 'active',   -- active/inactive
  created_at  TIMESTAMP   DEFAULT NOW(),
  updated_at  TIMESTAMP   DEFAULT NOW(),
  deleted_at  TIMESTAMP                              -- 软删除
);

-- 编号规则表
number_rules (
  id              SnowflakeID   PRIMARY KEY,
  level           INT           NOT NULL,        -- 1/2/3/4级
  department_id   SnowflakeID   REFERENCES departments(id),
  sequence        INT           NOT NULL DEFAULT 0,  -- 当前序号
  created_at      TIMESTAMP   DEFAULT NOW(),
  updated_at      TIMESTAMP   DEFAULT NOW()
);

-- 文档文件表（一/二/三级）
documents (
  id          SnowflakeID   PRIMARY KEY,
  level       INT           NOT NULL,            -- 1/2/3级
  number      VARCHAR(50)   UNIQUE NOT NULL,     -- 文件编号
  title       VARCHAR(200)  NOT NULL,            -- 文件标题
  file_path   VARCHAR(500)  NOT NULL,            -- MinIO路径
  file_name   VARCHAR(200)  NOT NULL,            -- 原始文件名
  file_size   BIGINT        NOT NULL,            -- 文件大小
  file_type   VARCHAR(50)   NOT NULL,            -- 文件类型
  version     DECIMAL(3,1)  NOT NULL DEFAULT 1.0, -- 版本号
  status      VARCHAR(20)   NOT NULL,            -- draft/pending/approved/rejected/archived
  creator_id  SnowflakeID   REFERENCES users(id),
  approver_id SnowflakeID   REFERENCES users(id),    -- 审批人
  approved_at TIMESTAMP,                              -- 审批时间
  created_at  TIMESTAMP   DEFAULT NOW(),
  updated_at  TIMESTAMP   DEFAULT NOW(),
  deleted_at  TIMESTAMP                              -- 软删除
);

-- 文档版本历史表
document_versions (
  id          SnowflakeID   PRIMARY KEY,
  document_id SnowflakeID   REFERENCES documents(id),
  version     DECIMAL(3,1)  NOT NULL,
  file_path   VARCHAR(500)  NOT NULL,
  file_name   VARCHAR(200)  NOT NULL,
  file_size   BIGINT        NOT NULL,
  creator_id  SnowflakeID   REFERENCES users(id),
  created_at  TIMESTAMP   DEFAULT NOW()
);

-- 模板表（四级）
templates (
  id          SnowflakeID   PRIMARY KEY,
  level       INT           NOT NULL DEFAULT 4,
  number      VARCHAR(50)   UNIQUE NOT NULL,
  title       VARCHAR(200)  NOT NULL,
  fields_json JSONB         NOT NULL,            -- 字段配置
  version     DECIMAL(3,1)  NOT NULL DEFAULT 1.0,
  status      VARCHAR(20)   NOT NULL DEFAULT 'active', -- active/inactive
  creator_id  SnowflakeID   REFERENCES users(id),
  created_at  TIMESTAMP   DEFAULT NOW(),
  updated_at  TIMESTAMP   DEFAULT NOW(),
  deleted_at  TIMESTAMP                              -- 软删除
);

-- 任务表
tasks (
  id          SnowflakeID   PRIMARY KEY,
  template_id SnowflakeID   REFERENCES templates(id),
  department_id SnowflakeID REFERENCES departments(id), -- 执行部门
  deadline    TIMESTAMP   NOT NULL,            -- 截止日期
  status      VARCHAR(20)  NOT NULL DEFAULT 'pending', -- pending/completed/cancelled
  creator_id  SnowflakeID   REFERENCES users(id),       -- 分发人
  created_at  TIMESTAMP   DEFAULT NOW(),
  updated_at  TIMESTAMP   DEFAULT NOW(),
  deleted_at  TIMESTAMP                              -- 软删除
);

-- 任务记录表（四级填写）
task_records (
  id          SnowflakeID   PRIMARY KEY,
  task_id     SnowflakeID   REFERENCES tasks(id),
  template_id SnowflakeID   REFERENCES templates(id),
  data_json   JSONB         NOT NULL,            -- 填写数据
  status      VARCHAR(20)   NOT NULL DEFAULT 'pending', -- pending/submitted/approved/rejected
  submitter_id SnowflakeID  REFERENCES users(id),    -- 提交人（第一人提交后锁定）
  submitted_at TIMESTAMP,
  approver_id SnowflakeID   REFERENCES users(id),
  approved_at TIMESTAMP,
  created_at  TIMESTAMP   DEFAULT NOW(),
  updated_at  TIMESTAMP   DEFAULT NOW(),
  deleted_at  TIMESTAMP                              -- 软删除
);

-- 说明：每个任务只能有一条提交后的记录（第一人提交后锁定）

-- 审批记录表
approvals (
  id          SnowflakeID   PRIMARY KEY,
  document_id SnowflakeID   REFERENCES documents(id),
  record_id   SnowflakeID   REFERENCES task_records(id),
  approver_id SnowflakeID   REFERENCES users(id),
  status      VARCHAR(20)   NOT NULL,            -- approved/rejected
  comment     TEXT,
  created_at  TIMESTAMP   DEFAULT NOW()
);

-- 操作日志表
operation_logs (
  id          SnowflakeID   PRIMARY KEY,
  user_id     SnowflakeID   REFERENCES users(id),
  action      VARCHAR(50)   NOT NULL,            -- login/upload/approve/edit/delete
  module      VARCHAR(50)   NOT NULL,            -- auth/document/template/task
  object_id   SnowflakeID,
  object_type VARCHAR(50),
  details     JSONB,
  ip          VARCHAR(50),
  created_at  TIMESTAMP   DEFAULT NOW()
);

-- 站内消息表
notifications (
  id          SnowflakeID   PRIMARY KEY,
  user_id     SnowflakeID   REFERENCES users(id),
  type        VARCHAR(50)   NOT NULL,            -- task/approval/reminder
  title       VARCHAR(200)  NOT NULL,
  content     TEXT,
  is_read     BOOLEAN       DEFAULT FALSE,
  read_at     TIMESTAMP,
  created_at  TIMESTAMP   DEFAULT NOW()
);
```

### 6.2 扩展字段预留（后续加）

| 字段 | 表 | 用途 |
|------|------|------|
| email | users | 后续邮件通知 |
| phone | users | 后续短信通知 |
| workflow_config | documents | 后续多级审批配置 |
| tags | documents/templates | 后续标签搜索 |
| description | departments | 部门描述 |

---

## 七、API设计

### 7.1 API规范

| 项目 | 值 |
|------|------|
| 前缀 | /api/v1 |
| 认证 | Header: `Authorization: Bearer <token>` |
| 分页 | `?page=1&limit=20` |
| 日期格式 | ISO 8601 (YYYY-MM-DDTHH:mm:ssZ) |
| 错误格式 | `{ code: number, message: string, details: any }` |
| 文件上传 | multipart/form-data |
| 超时时间 | 30秒 |

### 7.2 核心API

| 模块 | 端点 | 方法 | 说明 |
|------|------|------|------|
| **认证** | | | |
| | /api/v1/auth/login | POST | 登录 |
| | /api/v1/auth/me | GET | 获取当前用户 |
| | /api/v1/auth/password | PUT | 修改密码 |
| | /api/v1/auth/logout | POST | 登出 |
| **用户** | | | |
| | /api/v1/users | GET | 用户列表 |
| | /api/v1/users | POST | 创建用户 |
| | /api/v1/users/:id | GET | 用户详情 |
| | /api/v1/users/:id | PUT | 更新用户 |
| | /api/v1/users/:id | DELETE | 删除用户 |
| **部门** | | | |
| | /api/v1/departments | GET | 部门列表 |
| | /api/v1/departments | POST | 创建部门 |
| | /api/v1/departments/:id | PUT | 更新部门 |
| | /api/v1/departments/:id | DELETE | 删除部门 |
| **文档** | | | |
| | /api/v1/documents/level/:level | GET | 文档列表 |
| | /api/v1/documents | POST | 上传文档 |
| | /api/v1/documents/:id | GET | 文档详情 |
| | /api/v1/documents/:id | PUT | 更新文档 |
| | /api/v1/documents/:id | DELETE | 删除文档 |
| | /api/v1/documents/:id/download | GET | 下载文档 |
| | /api/v1/documents/:id/versions | GET | 版本历史 |
| **审批** | | | |
| | /api/v1/approvals/pending | GET | 待审批列表 |
| | /api/v1/approvals/history | GET | 审批历史 |
| | /api/v1/approvals | POST | 提交审批 |
| | /api/v1/approvals/:id | PUT | 审批操作 |
| **模板** | | | |
| | /api/v1/templates | GET | 模板列表 |
| | /api/v1/templates | POST | 创建模板 |
| | /api/v1/templates/:id | GET | 模板详情 |
| | /api/v1/templates/:id | PUT | 更新模板 |
| | /api/v1/templates/:id | DELETE | 删除模板 |
| | /api/v1/templates/:id/copy | POST | 复制模板 |
| | /api/v1/templates/parse-excel | POST | 解析Excel |
| **任务** | | | |
| | /api/v1/tasks | GET | 任务列表 |
| | /api/v1/tasks | POST | 分发任务 |
| | /api/v1/tasks/:id | GET | 任务详情 |
| | /api/v1/tasks/:id | DELETE | 取消任务 |
| | /api/v1/tasks/:id/submit | POST | 提交任务 |
| **记录** | | | |
| | /api/v1/records | GET | 记录列表 |
| | /api/v1/records/:id | GET | 记录详情 |
| **消息** | | | |
| | /api/v1/notifications | GET | 消息列表 |
| | /api/v1/notifications/:id/read | PUT | 标记已读 |
| | /api/v1/notifications/read-all | PUT | 全部已读 |
| **日志** | | | |
| | /api/v1/logs | GET | 操作日志（管理员） |

---

## 八、前端设计

### 8.1 页面结构

**侧边栏层级**: 二级（按功能模块分类）

```
侧边栏:
├── 一级文件管理
│   ├── 文件列表
│   └── 上传文件
├── 二级文件管理
│   ├── 文件列表
│   └── 上传文件
├── 三级文件管理
│   ├── 文件列表
│   └── 上传文件
├── 四级模板
│   ├── 模板列表
│   └── 创建模板
├── 任务管理
│   ├── 我的任务
│   └── 分发任务（部门负责人）
├── 审批中心
├── 用户管理（Admin）
└── 部门管理（Admin）
```

### 8.2 交互规范

| 项目 | 值 |
|------|------|
| 每页条数 | 20条（可切换10/20/50） |
| 列表加载 | 分页 |
| 表单验证 | 红色文字在字段下方 |
| 审批意见 | 驳回时必填，通过时选填 |
| 文件上传 | 拖拽上传 + 批量上传 + 进度条 |
| 文件名显示 | 显示文件名 |
| 批量操作 | 批量删除 |
| 任务筛选 | Tabs切换 |

### 8.3 组件预留扩展

| 组件 | 用途 | 后续扩展 |
|------|------|----------|
| UserAvatar | 用户头像 | 后续支持上传 |
| VersionCompare | 版本对比 | 后续加 |
| DataExport | 数据导出 | 后续加Excel导出 |
| WorkflowDesigner | 工作流设计 | 后续加可视化设计 |

### 8.4 响应式设计

> **适用范围**：Phase 1-6 所有页面
> **响应式目标**：手机、平板、电脑均可正常使用核心功能

#### 8.4.1 支持设备

| 设备 | 宽度范围 | 支持级别 |
|------|----------|----------|
| 手机 | 375px - 428px | 完全支持 |
| iPad | 768px - 1024px | 完全支持 |
| 桌面 | ≥1200px | 完全支持（主适配） |

#### 8.4.2 断点定义

```css
/* 桌面 ≥1200px */
@media (min-width: 1200px) { /* 桌面布局 */ }

/* iPad 768px - 1199px */
@media (min-width: 768px) and (max-width: 1199px) { /* iPad布局 */ }

/* 手机 <768px */
@media (max-width: 767px) { /* 手机布局 */ }
```

#### 8.4.3 各端适配规则

| 功能 | 手机 | iPad | 桌面 |
|------|------|------|------|
| 侧边栏 | 汉堡菜单（折叠） | 可折叠 | 固定显示 |
| 文档列表 | 卡片式 | 表格+卡片 | 表格 |
| 任务填写 | 全屏表单 | 分栏布局 | 分栏布局 |
| 审批操作 | 全屏弹窗 | 弹窗 | 弹窗 |
| 文件上传 | 拍照/选择文件 | 拖拽+选择 | 拖拽+批量 |
| 按钮大小 | ≥44px（手指操作） | ≥40px | ≥32px |

#### 8.4.4 禁止行为

- ❌ 禁止使用fixed定位导致手机端底部被遮挡
- ❌ 禁止表格超过屏幕宽度出现横向滚动
- ❌ 禁止弹窗超过100%高度
- ❌ 禁止使用hover交互（手机无hover）

---

## 九、90个已确认细节

### 9.1 用户与权限（19题）

| 题号 | 问题 | 你的选择 |
|------|------|----------|
| 1 | 部门层级 | 2级（公司→部门） |
| 2 | 用户角色 | 普通用户、部门负责人、管理员 |
| 3 | 审批人确定 | 从上级选 |
| 19 | 一人多部门 | 不支持 |
| 20 | 一人多上级 | 不支持 |
| 21 | 部门停用 | 用户转无部门 |
| 22 | 修改密码 | 能 |
| 23 | 用户状态 | 启用/禁用 |
| 46 | 用户头像 | 不支持 |
| 47 | 我的文件 | 能查看 |
| 48 | 审批历史 | 能查看 |
| 49 | 登录锁定 | 5次锁定 |
| 50 | 查看日志 | 不能（只有管理员） |
| 53 | 批量导入用户 | 不能 |
| 76 | 验证码 | 不需要 |
| 77 | 用户名唯一 | 是 |
| 78 | 用户名格式 | 英文+数字 |
| 79 | 用户名最小长度 | 3位 |
| 80 | 密码最小长度 | 8位 |
| 81 | 密码复杂度 | 不需要 |

### 9.2 文件管理（16题）

| 题号 | 问题 | 你的选择 |
|------|------|----------|
| 4 | 文件类型 | PDF、Word、Excel |
| 5 | 文件名重复 | 提示用户手动修改 |
| 6 | 旧版本查看 | 能查看不能下载 |
| 7 | 版本对比 | 不需要 |
| 26 | 文件名填写 | 需要填写 |
| 27 | 文件大小 | 10MB |
| 28 | 文件下载 | 有权限才能下 |
| 29 | 版本排序 | 时间倒序 |
| 54 | 文件列表字段 | 编号、名称、状态、创建人、时间 |
| 55 | 文件排序 | 创建时间、编号 |
| 56 | 审批时限 | 没有时限，站内消息提醒审批人，不做自动处理 |
| 57 | 驳回状态 | 草稿 |
| 58 | 删除已发布文件 | 不能 |
| 59 | 拖拽上传 | 支持 |
| 60 | 批量上传 | 支持 |
| 83 | 文件预览 | 不支持 |
| 88 | 文件编号修改 | 不能 |
| 90 | 上传文件名显示 | 显示文件名 |

### 9.3 审批流程（3题）

| 题号 | 问题 | 你的选择 |
|------|------|----------|
| 24 | 审批历史 | 能 |
| 25 | 审批意见可见 | 能 |
| 14 | 审批意见 | 驳回必填 |

### 9.4 四级模板（5题）

| 题号 | 问题 | 你的选择 |
|------|------|----------|
| 30 | 模板复制 | 能 |
| 61 | 模板列表字段 | 编号、名称、版本、创建人、时间 |
| 62 | 导出模板 | 不能 |
| 69 | 字段拖拽排序 | 支持 |
| 70 | 停用模板影响 | 任务不受影响 |
| 82 | 字段默认值 | 支持 |

### 9.5 任务分发（5题）

| 题号 | 问题 | 你的选择 |
|------|------|----------|
| 8 | 过期提醒 | 站内消息 |
| 9 | 任务筛选 | Tabs切换 |
| 31 | 任务取消 | 能 |
| 63 | 任务列表字段 | 名称、执行人、截止时间、状态 |
| 64 | 转发任务 | 不能 |
| 65 | 修改已提交任务 | 不能 |
| 66 | 逾期标记 | 红色标记 |

### 9.6 Excel与数据（2题）

| 题号 | 问题 | 你的选择 |
|------|------|----------|
| 67 | Excel解析匹配 | 手动映射 |
| 68 | 数据导出 | 能（Excel） |

### 9.7 系统配置（21题）

| 题号 | 问题 | 你的选择 |
|------|------|----------|
| 10 | 分页方式 | page+limit |
| 11 | 错误码设计 | 详细 |
| 12 | 侧边栏层级 | 二级 |
| 13 | 表单验证 | 红色文字 |
| 15 | 主键类型 | 雪花ID |
| 16 | 软删除 | deleted_at |
| 17 | Docker配置 | 分开两份 |
| 18 | MinIO桶 | 按部门分开 |
| 32 | 每页条数 | 20条 |
| 33 | Token位置 | Header |
| 34 | 上传格式 | multipart |
| 35 | 事务 | 需要 |
| 36 | 操作日志 | 关键操作 |
| 37 | 超时时间 | 30秒 |
| 38 | 重试次数 | 1次 |
| 39 | 上传进度 | 进度条 |
| 40 | 系统语言 | 可扩展 |
| 41 | 前端目录 | 默认结构 |
| 42 | 后端目录 | 按域分 |
| 43 | 错误格式 | 详细 |
| 44 | 密码加密 | bcrypt |
| 45 | 数据库连接 | Docker |

### 9.8 消息与其他（6题）

| 题号 | 问题 | 你的选择 |
|------|------|----------|
| 71 | 消息已读 | 有 |
| 72 | 消息保留 | 30天 |
| 73 | 搜索功能 | 有 |
| 74 | 搜索字段 | 名称和编号 |
| 75 | 批量操作 | 批量删除 |
| 84 | 接口限流 | 不限流 |
| 85 | 回收站 | 有（7天） |
| 86 | 加载方式 | 分页 |
| 87 | 日期格式 | YYYY-MM-DD |
| 89 | 清空功能 | 没有 |
| 52 | 删除部门 | 能（有检查） |
| 51 | 部门层级数 | 2级 |

---

## 十、开发顺序建议

| 顺序 | 模块 | 理由 |
|------|------|------|
| 1 | 用户登录 + 用户管理 | 基础，先能登录 |
| 2 | 组织架构（部门管理） | 用户需要关联部门 |
| 3 | 一级文件上传 + 审批 | 最简单，先验证流程 |
| 4 | 二级/三级文件 | 复用一级逻辑 |
| 5 | 四级模板管理 | 复杂，需要Excel解析 |
| 6 | 任务分发 + 填写 | 基于模板 |
| 7 | 站内消息 | 最后再加 |

---

## 十一、额外建议

### 11.1 代码规范

- **提交规范**: 每天至少提交一次，commit message 用中文
- **命名规范**: 数据库字段用 snake_case，代码变量用 camelCase
- **注释规范**: 复杂逻辑必须注释，简单逻辑可不写

### 11.2 测试建议

- **单元测试**: 先测核心逻辑（审批流程、编号生成）
- **手动测试清单**: 整理一份测试用例，开发完自己测一遍
- **测试账号**: 准备几个测试账号（admin、普通用户、部门负责人）

### 11.3 文档建议

- **README**: 项目启动说明
- **API文档**: 用 Swagger 自动生成
- **数据字典**: 数据库表结构说明

### 11.4 安全性（生产环境）

- 生产环境记得改数据库密码
- 不要把配置文件提交到 git
- 定期备份数据库

### 11.5 扩展性预留

| 字段 | 表 | 用途 |
|------|------|------|
| email | users | 后续邮件通知 |
| phone | users | 后续短信通知 |
| workflow_config | documents | 后续多级审批配置 |
| tags | documents/templates | 后续标签搜索 |
| description | departments | 部门描述 |

---

## 十二、项目里程碑

> **重要说明**：
> - **MVP范围**：Phase 1-6（当前开发，完成后开箱即用）
> - **扩展范围**：Phase 7-14（后续扩展，不在当前计划内）

### Phase 1-6: MVP版本（当前开发）

| Phase | 模块 | Issue数 | 状态 |
|-------|------|---------|------|
| Phase 1 | 基础配置 | 8个 | 待开发 |
| Phase 2 | 一级文件 | 10个 | 待开发 |
| Phase 3 | 二三级文件 | 6个 | 待开发 |
| Phase 4 | 四级模板 | 12个 | 待开发 |
| Phase 5 | 任务分发 | 10个 | 待开发 |
| Phase 6 | 消息与优化 | 6个 | 待开发 |
| **合计** | | **52个** | |

### Phase 7-14: 完整版扩展（后续规划）

> 以下功能不在当前开发范围内，仅作为预留扩展空间

| Phase | 模块 | 说明 |
|-------|------|------|
| Phase 7 | 数据联动 | 创建下游报表时自动带入上游配方 |
| Phase 8 | 版本联动 | 上游变更后下游自动更新 |
| Phase 9 | 数据导出 | Excel批量导出 |
| Phase 10 | 工作流配置 | 可视化审批流程设计 |
| Phase 11 | 文件预览 | 在线预览PDF/Word/Excel |
| Phase 12 | 统计分析 | 报表和图表展示 |
| Phase 13 | 多语言 | 中英文切换 |
| Phase 14 | 邮件通知 | SMTP邮件通知（留接口） |

---

## 十三、MVP Issue清单

> **说明**：以下Issue按Phase分组，每个Issue包含约束，防止AI乱发挥
> **约束规则**：严格按Issue描述实现，禁止添加Issue未定义的功能

### Phase 1: 基础配置（8个Issue）

| Issue | 名称 | 依赖 | 约束 |
|-------|------|------|------|
| #1 | 项目骨架搭建 | 无 | 只能用：Vue 3 + Element Plus + Vite + Pinia + NestJS + TypeScript + Prisma |
| #2 | Docker Compose配置 | 无 | 必须包含：PostgreSQL、Redis、MinIO；禁止添加其他服务 |
| #3 | Prisma模型定义 | #2 | 严格按照DESIGN.md数据模型创建，禁止添加未定义的表或字段 |
| #4 | 用户登录功能 | #3 | 只能用：bcrypt加密、jsonwebtoken生成Token；禁止添加验证码 |
| #5 | 用户管理CRUD | #4 | Admin专属；禁止批量导入；用户必须关联部门和上级 |
| #6 | 部门管理CRUD | #3 | 2级结构（公司→部门）；禁止超过2级；一人只能属一个部门 |
| #7 | 公共组件开发 | #1 | FileUpload（拖拽+进度条）、TablePagination（分页封装）；禁止使用其他UI库 |
| #8 | 布局组件开发 | #1, #7 | 侧边栏+顶栏；响应式适配（手机/iPad/桌面）；禁止自定义样式，紧跟Element Plus |

### Phase 2: 一级文件（10个Issue）

| Issue | 名称 | 依赖 | 约束 |
|-------|------|------|------|
| #9 | 文件上传组件 | #7 | 只能用multipart/form-data；限制：PDF/Word/Excel，单文件≤10MB；禁止其他类型 |
| #10 | MinIO文件存储 | #9 | 必须上传到MinIO，禁止存数据库；按部门分桶；禁止直接调用MinIO API，必须用file.util.ts封装 |
| #11 | 一级文件列表 | #10 | 显示：编号、名称、状态、创建人、创建时间；支持：搜索、排序、分页；禁止添加标签筛选 |
| #12 | 一级文件详情 | #11 | 显示：文件信息+版本历史；禁止：文件预览（仅显示下载链接） |
| #13 | 文件下载功能 | #10 | 有权限才能下载；权限规则：创建人/审批人/Admin；禁止匿名下载 |
| #14 | 提交审批功能 | #11 | 提交给上级审批；一人只能有一个上级；Admin可以审批任何文件 |
| #15 | 待审批列表 | #14 | 审批人查看待自己审批的文件；会签（多人同时审批）不支持，仅单级审批 |
| #16 | 审批通过功能 | #15 | 通过+选填意见；通过后状态变为"已发布"；禁止自定义审批流程 |
| #17 | 审批驳回功能 | #15 | 驳回+必填意见；驳回后状态变为"草稿"；禁止驳回不填意见 |
| #18 | 审批历史记录 | #16, #17 | 查看自己审批过的文件；按时间倒序；禁止查看他人审批历史 |

### Phase 3: 二三级文件（6个Issue）

| Issue | 名称 | 依赖 | 约束 |
|-------|------|------|------|
| #19 | 二级文件管理 | #9-#18 | **复用Phase 2逻辑**，仅改变level字段为2；禁止添加新功能 |
| #20 | 三级文件管理 | #9-#18 | **复用Phase 2逻辑**，仅改变level字段为3；禁止添加新功能 |
| #21 | 文件版本管理 | #19, #20 | 修改后自动+版本号（1.0→1.1）；禁止：版本回滚 |
| #22 | 版本历史查看 | #21 | 显示版本列表（时间倒序）；旧版本只能查看，不能下载；禁止版本对比 |
| #23 | 文件状态流转 | #19-#22 | 草稿→待审批→已发布/已驳回→已停用；禁止添加其他状态 |
| #24 | 文件停用功能 | #23 | 已发布文件不能删除，只能停用；停用后不可下载；禁止彻底删除已发布文件 |

### Phase 4: 四级模板（12个Issue）

| Issue | 名称 | 依赖 | 约束 |
|-------|------|------|------|
| #25 | Excel解析功能 | 无 | 只能用：xlsx库；解析后手动映射字段类型；禁止自动推断字段类型 |
| #26 | 模板创建-Excel方式 | #25 | 上传Excel→解析→生成字段；支持：文本、数字、日期、下拉、是/否；禁止其他字段类型 |
| #27 | 模板创建-手动方式 | 无 | 手动添加字段；字段类型同#26；禁止自定义字段类型 |
| #28 | 模板字段配置 | #26, #27 | 支持：拖拽排序、设置默认值、必填/选填；禁止：字段联动、公式计算 |
| #29 | 字段拖拽排序 | #28 | 只能用：SortableJS；禁止使用其他拖拽库 |
| #30 | 字段默认值设置 | #28 | 支持文本默认值、数字默认值、日期默认值；禁止：动态默认值 |
| #31 | 模板列表 | #26-#30 | 显示：编号、名称、版本、创建人、创建时间、状态；支持：筛选、搜索 |
| #32 | 模板详情查看 | #31 | 显示字段配置；禁止：在线预览表单 |
| #33 | 模板编辑功能 | #32 | 修改字段配置；版本号自动+0.1；禁止：修改模板关联的任务 |
| #34 | 模板复制功能 | #31 | 一键复制模板；新模板编号不同，名称加"副本"；禁止：批量复制 |
| #35 | 模板停用功能 | #31 | 停用后不可再新建任务；历史任务不受影响；禁止：删除正在使用的模板 |
| #36 | 模板删除功能 | #35 | 仅能删除草稿状态的模板；禁止：删除已停用的模板 |

### Phase 5: 任务分发（10个Issue）

| Issue | 名称 | 依赖 | 约束 |
|-------|------|------|------|
| #37 | 表单渲染组件 | #28 | 根据JSON字段配置渲染表单；支持：文本框、数字框、日期选择器、下拉选择器、开关；禁止：复杂表单组件 |
| #38 | 任务分发功能 | #31, #37 | 选择模板→选择部门→选择截止日期；截止日期必填；禁止：指定具体执行人（发给部门即可） |
| #39 | 任务列表-My | #38 | 显示：模板名称、部门、截止时间、状态；Tabs筛选：全部/待完成/已完成；禁止：高级筛选 |
| #40 | 任务列表-All | #39 | 部门负责人查看本部门所有任务；显示：执行人（填写后显示）；禁止：查看其他部门任务 |
| #41 | 任务筛选 | #39, #40 | Tabs切换；禁止：搜索框、筛选器 |
| #42 | 任务填写功能 | #37, #39 | 动态表单填写；支持：保存草稿、提交；禁止：文件上传组件 |
| #43 | 任务提交功能 | #42 | 第一人提交后锁定；其他人只能查看；提交后不可修改；禁止：取消提交 |
| #44 | 任务取消功能 | #38 | 发起人可以取消任务；取消后任务删除；禁止：取消已提交的任务 |
| #45 | 逾期红色标记 | #39 | 截止日期过期显示红色；站内消息提醒；禁止：自动处理 |
| #46 | 任务审批功能 | #43 | 任务填写后提交审批；审批通过后归档；禁止：驳回重填（取消任务重填） |

### Phase 6: 消息与优化（6个Issue）

| Issue | 名称 | 依赖 | 约束 |
|-------|------|------|------|
| #47 | 站内消息功能 | #4 | 消息类型：任务通知、审批通知、逾期提醒；保存30天；禁止：消息推送其他渠道 |
| #48 | 消息列表 | #47 | 显示：标题、时间、未读/已读状态；按时间倒序；禁止：消息搜索 |
| #49 | 消息已读功能 | #48 | 点击消息标记已读；支持批量已读；禁止：删除消息 |
| #50 | 操作日志 | #4 | 记录：登录、上传、审批、删除关键操作；日志保留7天；禁止：记录密码等敏感信息 |
| #51 | 回收站功能 | #5, #6, #24, #36, #44 | 恢复已删除的数据；删除后7天彻底删除；禁止：永久保留 |
| #52 | 细节优化 | #1-#51 | 加载状态、空状态、错误提示；响应式适配；禁止：添加新功能 |

---

## 十四、待办事项

### 技术待办
- [ ] 项目初始化（Vue 3 + NestJS）
- [ ] Docker Compose 配置
- [ ] Prisma 模型定义
- [ ] Swagger API 文档

### 文档待办
- [ ] README.md
- [ ] API 文档
- [ ] 数据字典

### 测试待办
- [ ] 测试用例清单
- [ ] 测试账号准备

---

## 十四、待办事项

### 技术待办
- [ ] 项目初始化（Vue 3 + NestJS）
- [ ] Docker Compose 配置
- [ ] Prisma 模型定义
- [ ] Swagger API 文档

### 文档待办
- [ ] README.md
- [ ] API 文档
- [ ] 数据字典

### 测试待办
- [ ] 测试用例清单
- [ ] 测试账号准备

---

## 十五、待补充细节

> 以下是待讨论或待确认的细节，在后续会议中补充

| 序号 | 分类 | 问题 | 状态 |
|------|------|------|------|
| 1 | | | 待讨论 |
| 2 | | | 待讨论 |
| 3 | | | 待讨论 |

---

## 十六、完整版扩展规划（Phase 7-12 详细设计）

> **重要说明**：
> - MVP Phase 1-6 已完成 98.1%（51/52个Issue）
> - 本章节详细描述 Phase 7-12 的业务需求和功能规格
> - 基于用户确认的需求：**偏离检测、2级审批、数据导出、文件预览、偏离统计**
> - **不包含**：多语言（Phase 13）、邮件通知（Phase 14）

### 16.0 Phase 7-12 功能总览

| Phase | 功能 | 核心业务价值 | 实施优先级 |
|-------|------|-------------|-----------|
| **Phase 7-8** | 配方偏离检测与版本管理 | 配方公差定义 → 自动偏离检测 → 强制说明原因 → 生成报告 → 触发额外审批 | P0（最高） |
| **Phase 9** | 数据导出 | Excel 批量导出文档、任务记录、偏离报告 | P1 |
| **Phase 10** | 2级审批流程 | 主管→经理 固定2级审批链 | P0 |
| **Phase 11** | 文件预览 | PDF/Word/Excel 全格式原生预览 | P2 |
| **Phase 12** | 偏离统计分析 | 偏离次数、类型分布、趋势统计 | P1 |

**实施顺序建议**：
```
Phase 7-8（偏离检测）→ Phase 10（2级审批）→ Phase 12（统计）→ Phase 9（导出）→ Phase 11（预览）
```

---

### 16.1 Phase 7-8：配方偏离检测与版本管理

#### 16.1.1 业务背景

**核心问题**：
1. 生产过程中，员工填写生产记录时，实际值可能偏离配方标准值
2. 当前系统无法自动检测偏离，依赖人工审核，效率低且易漏检
3. 偏离原因无法追溯，质量问题难以分析

**业务目标**：
- 在模板（配方）中定义公差范围，员工填写时自动检测偏离
- 偏离时强制填写原因，生成偏离报告，触发额外审批流程
- 支持偏离数据统计分析，为质量改进提供数据支持

#### 16.1.2 用户故事

**故事1：配方管理员定义公差**
```
作为：配方管理员（研发部）
我想要：在工艺配方中定义每个字段的公差范围
以便：系统能自动检测生产记录的偏离情况

验收标准：
- 能为数值型字段设置公差（范围公差：±5g、百分比公差：±5%）
- 公差配置保存在模板中，不影响已有字段
- 公差配置可修改，但不影响历史记录的偏离判断（版本锁定）
```

**故事2：生产员工填写记录时偏离检测**
```
作为：生产员工
我想要：填写生产记录时，系统自动检测我填的值是否偏离配方
以便：及时发现异常情况并记录原因

验收标准：
- 输入数值后，系统实时显示是否在公差范围内（✅正常 / ❌偏离）
- 偏离时弹窗强制填写偏离原因（不填无法提交）
- 偏离原因保存在偏离报告中，方便后续审批和追溯
```

**故事3：质量主管审批偏离报告**
```
作为：质量主管
我想要：查看包含偏离的生产记录，并审批偏离是否可接受
以便：确保质量可控，不合格的偏离不能归档

验收标准：
- 偏离记录提交后，触发额外的审批流程（正常记录→主管审批；偏离记录→主管+质量主管）
- 审批时能看到偏离字段、期望值、实际值、偏离量、偏离原因
- 审批拒绝后，记录回到草稿状态，员工可修改后重新提交
```

**故事4：版本锁定（防止历史数据混乱）**
```
作为：配方管理员
我想要：配方更新后，已填写的生产记录不受影响
以便：历史数据准确反映当时的配方要求，不会因配方变更而改变偏离判断

验收标准：
- 员工提交记录时，系统锁定配方版本号
- 配方从 v1.0 更新到 v1.1 后，已提交的记录仍按 v1.0 判断偏离
- 未提交的记录自动使用最新版本 v1.1
```

#### 16.1.3 功能需求

##### 16.1.3.1 配方公差定义

**输入**：
- 字段名称（如：temperature）
- 字段类型（必须为 number）
- 公差类型（范围公差 / 百分比公差）
- 公差参数：
  - 范围公差：最小值、最大值（如：175°C ~ 185°C）
  - 百分比公差：百分比（如：±5%）

**输出**：
- 模板 fieldsJson 中增加 tolerance 配置
- 前端表单显示公差提示（如：温度：___°C（标准：180±5°C））

**业务规则**：
- 仅数值型字段支持公差配置
- 公差配置为可选项，不配置则不检测偏离
- 公差配置修改后，版本号+0.1，历史记录不受影响

##### 16.1.3.2 自动偏离检测

**触发时机**：
- 员工填写表单时（实时检测，前端显示）
- 员工提交表单时（后端验证，生成偏离报告）

**检测逻辑**：
```
IF 字段有公差配置 THEN
  IF 范围公差 THEN
    偏离 = (实际值 < 最小值) OR (实际值 > 最大值)
    偏离量 = MIN(|实际值 - 最小值|, |实际值 - 最大值|)
  ELSE IF 百分比公差 THEN
    期望值 = (最小值 + 最大值) / 2
    偏离率 = (实际值 - 期望值) / 期望值 * 100%
    偏离 = |偏离率| > 百分比阈值
  END IF
END IF
```

**输出**：
- 前端：偏离字段标红，显示偏离提示
- 后端：返回偏离字段列表（字段名、期望值、实际值、偏离量）

**业务规则**：
- 偏离检测结果实时显示，不阻塞填写
- 提交时若有偏离，强制弹窗填写原因（每个偏离字段一个原因）
- 偏离原因最少10个字符，最多500个字符

##### 16.1.3.3 偏离报告生成

**触发时机**：员工提交包含偏离的任务记录时

**报告内容**：
| 字段 | 说明 | 示例 |
|------|------|------|
| recordId | 任务记录ID | xxx-xxx |
| templateId | 配方模板ID | 3-RD-001 |
| fieldName | 偏离字段名称 | temperature |
| expectedValue | 期望值（配方值） | 180°C |
| actualValue | 实际值（填写值） | 190°C |
| toleranceMin | 公差最小值 | 175°C |
| toleranceMax | 公差最大值 | 185°C |
| deviationAmount | 偏离量（绝对值） | 5°C |
| deviationRate | 偏离率（百分比） | 5.6% |
| reason | 偏离原因（员工填写） | 生产线温度控制器故障，已报修 |
| status | 报告状态 | pending（待审批）|
| reportedBy | 报告人 | 张三 |
| reportedAt | 报告时间 | 2026-02-05 14:30:00 |

**输出**：
- 生成偏离报告记录（存入 DeviationReport 表）
- 任务记录标记为"包含偏离"（hasDeviation = true, deviationCount = N）
- 触发额外审批流程（见 Phase 10）

**业务规则**：
- 一个任务记录可以包含多个偏离字段，每个字段生成一条偏离报告
- 偏离报告状态：pending（待审批）→ approved（通过）/ rejected（拒绝）
- 偏离报告不可修改，只能查看和审批

##### 16.1.3.4 版本锁定机制

**目标**：配方更新后，已提交的记录不受影响，保证历史数据准确性

**实现方式**：
- 任务记录表新增字段：
  - `relatedTemplateId`（关联的配方模板ID）
  - `relatedTemplateVersion`（锁定的配方版本号）
- 员工提交记录时，系统自动记录当前配方版本号
- 偏离检测和统计时，使用锁定的版本号对应的公差配置

**业务规则**：
- 提交后的记录，版本号永久锁定，不可修改
- 未提交的记录（草稿状态），每次打开时使用最新版本
- 配方版本号格式：1.0, 1.1, 1.2...（修改字段配置时自动递增）

#### 16.1.4 业务规则（新增）

| 规则编号 | 规则描述 |
|---------|----------|
| BR-017 | 数值型字段可配置公差（范围公差 or 百分比公差），非数值型字段不支持 |
| BR-018 | 偏离检测在前端实时显示，后端提交时强制验证 |
| BR-019 | 偏离时必须填写偏离原因（最少10字，最多500字） |
| BR-020 | 偏离报告自动生成，不可手动修改，只能审批通过/拒绝 |
| BR-021 | 包含偏离的记录触发额外审批流程（正常：1级审批；偏离：2级审批） |
| BR-022 | 任务记录提交时锁定配方版本号，后续配方更新不影响已提交记录 |
| BR-023 | 配方公差配置修改后，版本号自动+0.1，历史记录按旧版本判断偏离 |
| BR-024 | 偏离报告状态：pending（待审批）→ approved（归档）/ rejected（驳回到创建人） |

#### 16.1.5 数据实体

##### Template.fieldsJson 扩展（向后兼容）

```typescript
// 现有字段结构（MVP Phase 1-6，保持不变）
interface TemplateField {
  name: string          // 字段名称
  label: string         // 字段标签
  type: 'text' | 'textarea' | 'number' | 'date' | 'select' | 'boolean'
  required: boolean
  defaultValue?: string | number | boolean
  options?: { label: string; value: string | number }[]  // 下拉选项
  sort: number          // 排序
}

// 新增字段（Phase 7+）
interface TemplateFieldV2 extends TemplateField {
  tolerance?: {                    // 公差配置（仅 number 类型有效）
    type: 'range' | 'percentage'   // 范围公差 vs 百分比公差
    min?: number                   // 最小值（如：95）
    max?: number                   // 最大值（如：105）
    percentage?: number            // 百分比（如：5，表示±5%）
    unit?: string                  // 单位（如：°C, g, min）
  }
  relatedTemplateId?: string       // 关联的上游配方ID（用于自动带入）
}
```

**示例**：
```json
{
  "name": "temperature",
  "label": "温度",
  "type": "number",
  "required": true,
  "defaultValue": 180,
  "tolerance": {
    "type": "range",
    "min": 175,
    "max": 185,
    "unit": "°C"
  }
}
```

##### DeviationReport（新增表）

**业务概念**：偏离报告，记录生产记录中偏离配方标准的字段详情

| 字段 | 类型 | 说明 |
|------|------|------|
| id | SnowflakeID | 主键 |
| recordId | SnowflakeID | 关联的任务记录ID |
| templateId | SnowflakeID | 关联的配方模板ID |
| fieldName | String | 偏离字段名称 |
| expectedValue | String | 期望值（配方标准值） |
| actualValue | String | 实际值（员工填写值） |
| toleranceMin | Float | 公差最小值 |
| toleranceMax | Float | 公差最大值 |
| deviationAmount | Float | 偏离量（绝对值） |
| deviationRate | Float | 偏离率（百分比） |
| reason | String | 偏离原因（员工填写，10-500字符） |
| status | String | 报告状态（pending/approved/rejected） |
| reportedBy | SnowflakeID | 报告人（员工ID） |
| reportedAt | DateTime | 报告时间 |
| approvedBy | SnowflakeID | 审批人ID |
| approvedAt | DateTime | 审批时间 |
| createdAt | DateTime | 创建时间 |
| updatedAt | DateTime | 更新时间 |
| deletedAt | DateTime | 软删除 |

##### TaskRecord 扩展

**新增字段**：
| 字段 | 类型 | 说明 |
|------|------|------|
| relatedTemplateId | SnowflakeID | 关联的配方模板ID（用于版本锁定） |
| relatedTemplateVersion | Float | 锁定的配方版本号（如：1.0, 1.1） |
| hasDeviation | Boolean | 是否包含偏离（true/false） |
| deviationCount | Int | 偏离字段数量 |

#### 16.1.6 业务流程

##### 流程图：配方偏离检测与审批

```
┌──────────────────────────────────────────────────────────────────┐
│                   配方偏离检测与审批流程                            │
└──────────────────────────────────────────────────────────────────┘

Step 1: 配方管理员创建/更新配方
    ↓
   配方模板（三级文件）
   - 原料A: 100g ±5g
   - 温度: 180°C ±5°C
   - 时间: 30min ±2min
   版本号：v1.0

Step 2: 生产员工填写生产记录
    ↓
   员工输入：
   - 原料A = 103g  →  ✅ 正常（100-105范围内）
   - 温度 = 190°C  →  ❌ 偏离（175-185范围外）
   - 时间 = 28min  →  ✅ 正常（28-32范围内）
    ↓
   前端实时显示：
   - 温度字段标红
   - 提示：偏离配方标准值5°C

Step 3: 提交时强制填写偏离原因
    ↓
   弹窗：请填写"温度"字段偏离原因
   员工输入：生产线温度控制器故障，已报修
    ↓
   系统生成偏离报告：
   - 字段：temperature
   - 期望值：180°C
   - 实际值：190°C
   - 偏离量：5°C
   - 原因：生产线温度控制器故障，已报修

Step 4: 触发2级审批流程（Phase 10）
    ↓
   1级审批（生产主管）：
   - 查看生产记录 + 偏离报告
   - 通过/拒绝
    ↓（通过后）
   2级审批（质量主管）：
   - 查看偏离报告，判断是否可接受
   - 通过（归档）/ 拒绝（回到员工，修改后重新提交）

Step 5: 归档或驳回
    ↓
   通过：记录归档，偏离报告状态 = approved
   拒绝：记录回到草稿，偏离报告状态 = rejected
```

#### 16.1.7 成功指标

| 指标 | 目标值 | 数据来源 |
|------|--------|----------|
| 偏离检出率 | ≥95% | 实际偏离数 / 人工审核发现的偏离数 |
| 偏离报告完成率 | 100% | 偏离记录中填写原因的比例 |
| 偏离审批及时率 | ≥90% 在24小时内完成审批 | 审批完成时间 - 提交时间 |
| 版本锁定准确率 | 100% | 历史记录的配方版本不受更新影响 |
| 用户满意度 | ≥4.0/5.0 | 生产员工和质量主管的反馈评分 |

#### 16.1.8 验收标准

**Phase 7-8 功能验收清单**：

- [ ] 配方管理员能在模板中为数值型字段配置公差（范围公差 + 百分比公差）
- [ ] 公差配置修改后，模板版本号自动递增（1.0 → 1.1）
- [ ] 员工填写表单时，偏离字段实时标红显示
- [ ] 提交时若有偏离，强制弹窗填写原因（不填无法提交）
- [ ] 偏离原因限制10-500字符，少于10字符提示错误
- [ ] 提交后自动生成偏离报告，包含字段名、期望值、实际值、偏离量、原因
- [ ] 任务记录提交时锁定配方版本号，后续配方更新不影响已提交记录
- [ ] 未提交的草稿记录，每次打开时自动使用最新配方版本
- [ ] 包含偏离的记录触发2级审批流程（Phase 10依赖）
- [ ] 偏离报告审批通过后，状态变为 approved，记录归档
- [ ] 偏离报告审批拒绝后，状态变为 rejected，记录回到草稿状态
- [ ] 偏离报告不可手动修改，只能查看和审批

---

### 16.2 Phase 9：数据导出

#### 16.2.1 业务背景

**核心问题**：
1. 管理层需要定期汇报生产数据、偏离情况、审批效率等指标
2. 当前系统只能在页面查看，无法导出Excel进行二次分析
3. 数据分析师需要批量导出数据进行统计分析

**业务目标**：
- 支持批量导出文档列表、任务记录、偏离报告为 Excel 格式
- 导出文件包含必要的字段和过滤条件，方便二次分析
- 导出过程不阻塞用户操作，大批量导出时异步生成

#### 16.2.2 用户故事

**故事1：部门主管导出文档列表**
```
作为：部门主管
我想要：导出本部门的所有一级/二级/三级文件列表（Excel）
以便：进行文档盘点和合规性检查

验收标准：
- 能按文档级别（1/2/3）、部门、状态、时间范围筛选导出
- 导出字段：编号、名称、版本、状态、创建人、创建时间、审批人、审批时间
- 导出文件名格式：文档列表_部门名称_20260205.xlsx
- 导出后自动下载或提供下载链接
```

**故事2：质量主管导出偏离报告**
```
作为：质量主管
我想要：导出某个时间段内的所有偏离报告（Excel）
以便：分析偏离趋势，制定改进措施

验收标准：
- 能按模板、部门、时间范围筛选导出
- 导出字段：记录ID、配方名称、字段名称、期望值、实际值、偏离量、偏离率、原因、审批状态
- 每个偏离报告单独一行，便于统计分析
- 支持导出超过1000条数据（异步导出）
```

**故事3：数据分析师导出任务记录**
```
作为：数据分析师
我想要：导出某个模板的所有任务填写记录（Excel）
以便：分析生产数据，发现规律和异常

验收标准：
- 导出表头包含固定列（任务ID、提交人、提交时间、状态）+ 动态列（模板字段）
- 动态列根据模板字段动态生成（如：原料A、温度、时间...）
- 支持导出多个部门的数据
- 导出后文件大小不超过 50MB（超过则分批导出）
```

#### 16.2.3 功能需求

##### 16.2.3.1 文档列表导出

**输入参数**：
- level：文档级别（1/2/3）
- departmentId：部门ID（可选）
- status：文档状态（可选：draft/pending/approved/rejected/inactive）
- startDate：开始日期（可选）
- endDate：结束日期（可选）

**输出**：
- Excel 文件（.xlsx格式）
- 文件名：文档列表_{level}级_{部门名称}_{日期}.xlsx

**导出字段**：
| 字段名 | 数据来源 |
|-------|---------|
| 文档编号 | Document.number |
| 文档标题 | Document.title |
| 版本号 | Document.version |
| 状态 | Document.status |
| 创建人 | User.name |
| 创建时间 | Document.createdAt |
| 审批人 | User.name |
| 审批时间 | Document.approvedAt |

**业务规则**：
- 仅导出当前用户有权限查看的文档
- 软删除的文档不导出
- 导出数量 ≤1000条：同步导出，直接返回文件
- 导出数量 >1000条：异步导出，返回任务ID，用户轮询下载

##### 16.2.3.2 任务记录导出

**输入参数**：
- templateId：模板ID（必填）
- departmentId：部门ID（可选）
- startDate：开始日期（必填）
- endDate：结束日期（必填）

**输出**：
- Excel 文件（.xlsx格式）
- 文件名：任务记录_{模板名称}_{日期}.xlsx

**导出字段**（动态列）：
| 固定列 | 说明 |
|--------|------|
| 任务ID | Task.id |
| 模板名称 | Template.title |
| 提交人 | User.name |
| 提交时间 | TaskRecord.submittedAt |
| 审批状态 | TaskRecord.status |
| 是否偏离 | TaskRecord.hasDeviation |

| 动态列 | 说明 |
|--------|------|
| {字段标签} | TaskRecord.dataJson[字段名称] |

**示例**：
```
| 任务ID | 模板名称 | 提交人 | 提交时间 | 审批状态 | 是否偏离 | 原料A(g) | 温度(°C) | 时间(min) |
|--------|---------|--------|----------|----------|---------|---------|---------|----------|
| xxx-1  | 生产记录  | 张三   | 2026-02-05 | approved | 是      | 103     | 190     | 28       |
| xxx-2  | 生产记录  | 李四   | 2026-02-06 | approved | 否      | 100     | 180     | 30       |
```

**业务规则**：
- 动态列根据模板 fieldsJson 动态生成
- 数值型字段显示数值，日期型字段格式化为 YYYY-MM-DD
- 下拉型字段显示选项标签（label），不是值（value）
- 仅导出已提交的记录（status = submitted/approved/rejected）

##### 16.2.3.3 偏离报告导出

**输入参数**：
- templateId：模板ID（可选）
- departmentId：部门ID（可选）
- startDate：开始日期（必填）
- endDate：结束日期（必填）

**输出**：
- Excel 文件（.xlsx格式）
- 文件名：偏离报告_{时间段}.xlsx

**导出字段**：
| 字段名 | 数据来源 |
|--------|---------|
| 记录ID | TaskRecord.id |
| 配方模板 | Template.title |
| 配方版本 | TaskRecord.relatedTemplateVersion |
| 字段名称 | DeviationReport.fieldName |
| 期望值 | DeviationReport.expectedValue |
| 实际值 | DeviationReport.actualValue |
| 公差最小值 | DeviationReport.toleranceMin |
| 公差最大值 | DeviationReport.toleranceMax |
| 偏离量 | DeviationReport.deviationAmount |
| 偏离率(%) | DeviationReport.deviationRate |
| 偏离原因 | DeviationReport.reason |
| 报告人 | User.name |
| 报告时间 | DeviationReport.reportedAt |
| 审批状态 | DeviationReport.status |
| 审批人 | User.name |
| 审批时间 | DeviationReport.approvedAt |

**业务规则**：
- 一个任务记录有多个偏离字段时，每个字段单独一行
- 仅导出已生成偏离报告的记录（hasDeviation = true）
- 按报告时间倒序排序

#### 16.2.4 业务规则（新增）

| 规则编号 | 规则描述 |
|---------|----------|
| BR-025 | 导出功能仅限有权限的用户使用（Admin可导出全部，Leader可导出本部门） |
| BR-026 | 导出数量 ≤1000条：同步导出；>1000条：异步导出，生成下载链接 |
| BR-027 | 异步导出文件保留7天，超期自动删除 |
| BR-028 | 导出文件名格式：{类型}_{筛选条件}_{日期时间}.xlsx |
| BR-029 | 动态列导出时，字段顺序与模板字段排序一致 |
| BR-030 | 导出文件大小限制：单个文件最大 50MB |

#### 16.2.5 导出格式定义

**Excel 样式规范**：
- 表头行：粗体 + 背景色（浅蓝色）+ 冻结首行
- 数据行：偶数行浅灰色背景（条纹样式）
- 列宽：自动调整（根据内容长度）
- 日期格式：YYYY-MM-DD HH:mm:ss
- 数值格式：保留2位小数

**文件命名规范**：
```
文档列表_{level}级_{部门名称}_{YYYYMMDD}.xlsx
任务记录_{模板名称}_{YYYYMMDD}.xlsx
偏离报告_{YYYYMMDD_HHMMSS}.xlsx
```

#### 16.2.6 权限控制

| 角色 | 权限范围 |
|------|---------|
| Admin | 可导出所有部门的数据 |
| Leader | 可导出本部门的数据 |
| User | 可导出自己创建/提交的数据 |

**权限验证逻辑**：
```
IF role = 'admin' THEN
  允许导出所有数据
ELSE IF role = 'leader' THEN
  过滤条件：departmentId = 用户所在部门ID
ELSE IF role = 'user' THEN
  过滤条件：creatorId = 当前用户ID 或 submitterId = 当前用户ID
END IF
```

#### 16.2.7 验收标准

**Phase 9 功能验收清单**：

- [ ] 部门主管能按级别、部门、状态、时间范围导出文档列表
- [ ] 导出的文档列表包含编号、名称、版本、状态、创建人、审批人、时间等字段
- [ ] 质量主管能按模板、部门、时间范围导出偏离报告
- [ ] 偏离报告导出包含字段名称、期望值、实际值、偏离量、偏离率、原因等字段
- [ ] 数据分析师能导出任务记录，表头包含固定列+动态列（模板字段）
- [ ] 动态列根据模板字段自动生成，顺序与模板一致
- [ ] 导出数量 ≤1000条时，同步返回文件，直接下载
- [ ] 导出数量 >1000条时，异步生成文件，返回任务ID，提供下载链接
- [ ] 异步导出文件保留7天，超期自动删除
- [ ] 导出权限控制：Admin可导出全部，Leader可导出本部门，User可导出自己的
- [ ] 导出文件命名规范，易于识别
- [ ] Excel 样式规范：表头粗体+背景色，数据行条纹样式，列宽自动调整

---

### 16.3 Phase 10：2级审批流程

#### 16.3.1 业务背景

**核心问题**：
1. MVP Phase 1-6 仅支持单级审批（创建人→上级），无法满足质量控制要求
2. 包含偏离的生产记录需要质量主管额外审批，当前审批流程无法支持
3. 审批驳回后的处理流程不清晰，缺少状态追踪

**业务目标**：
- 支持固定2级审批流程：主管（Supervisor）→ 经理（Manager）
- 偏离记录自动触发2级审批，正常记录走1级审批
- 审批驳回后记录回到创建人，可修改后重新提交
- 审批记录可追溯，支持审批历史查询

#### 16.3.2 用户故事

**故事1：正常记录的1级审批**
```
作为：生产员工
我想要：提交正常的生产记录后，由直属主管审批即可
以便：快速完成归档，不延误生产节奏

验收标准：
- 提交不含偏离的记录时，自动发起1级审批（主管审批）
- 主管审批通过后，记录状态变为"已归档"
- 主管驳回后，记录回到草稿状态，我可以修改后重新提交
```

**故事2：偏离记录的2级审批**
```
作为：生产员工
我想要：提交包含偏离的生产记录后，由主管和质量经理两级审批
以便：确保偏离情况得到充分审查，质量可控

验收标准：
- 提交含偏离的记录时，自动发起2级审批（主管→经理）
- 主管审批通过后，流转到经理审批（状态：主管已通过，待经理审批）
- 经理审批通过后，记录状态变为"已归档"
- 任一级审批驳回，记录回到草稿状态，我可以修改后重新提交
```

**故事3：主管审批操作**
```
作为：部门主管
我想要：查看待审批的生产记录，了解详细信息后决定通过或驳回
以便：履行审批职责，把关生产质量

验收标准：
- 在"待办事项"看到待审批记录数量
- 点击进入审批详情，看到记录内容、偏离信息（如果有）、偏离原因
- 可以通过或驳回，驳回时必须填写驳回原因
- 审批后记录自动流转（通过→下一级；驳回→创建人）
```

**故事4：经理审批操作**
```
作为：质量经理
我想要：审批主管已通过的偏离记录，确认偏离可接受
以便：确保质量控制标准得到执行，不合格偏离不归档

验收标准：
- 在"待办事项"看到待审批的偏离记录（主管已通过）
- 看到主管审批意见和偏离详情
- 可以通过或驳回，驳回时必须填写驳回原因
- 审批通过后，记录归档；驳回后，记录回到创建人（需重新走完整流程）
```

**故事5：审批记录追溯**
```
作为：质量审计员
我想要：查看某条记录的完整审批历史
以便：审计时了解审批过程，判断是否合规

验收标准：
- 查看记录时，能看到审批历史（谁在什么时间审批的，意见是什么）
- 能看到审批流程状态（当前在哪一级、是否已完成）
- 驳回记录能看到驳回原因和驳回时间
```

#### 16.3.3 功能需求

##### 16.3.3.1 审批链配置

**触发时机**：任务记录提交时

**审批链规则**：
| 场景 | 审批链 | 说明 |
|------|--------|------|
| 正常记录（无偏离） | 主管（Level 1） | 主管审批通过后归档 |
| 偏离记录（有偏离） | 主管（Level 1）→ 经理（Level 2） | 两级都通过才能归档 |

**审批人确定规则**：
- Level 1 审批人（主管）：提交人的直属上级（User.reportTo）
- Level 2 审批人（经理）：部门经理（Department.managerId）
- 如果提交人的 reportTo 为空，审批流程无法发起，提示"未配置直属上级"
- 如果部门 managerId 为空，2级审批无法发起，提示"未配置部门经理"

**输出**：
- 生成审批链记录（Approval 表）
- 记录状态变为"审批中"（TaskRecord.status = 'pending_approval'）
- 审批人收到待办提醒（通知计数+1）

##### 16.3.3.2 级联审批

**审批操作**：
- **通过**：审批人点击"通过"按钮，可选填审批意见
- **驳回**：审批人点击"驳回"按钮，必填驳回原因（最少10字）

**状态流转**：
```
1级审批（主管）：
  - 通过 + 无偏离 → 记录归档（archived）
  - 通过 + 有偏离 → 流转到2级审批（pending_level2）
  - 驳回 → 记录回到草稿（draft），通知创建人

2级审批（经理）：
  - 通过 → 记录归档（archived）
  - 驳回 → 记录回到草稿（draft），通知创建人
```

**业务规则**：
- 审批必须按顺序进行（1级→2级），不能跳级审批
- 审批人不能审批自己创建的记录（系统自动过滤）
- 审批操作不可撤销（通过/驳回后无法修改）
- 审批意见最多500个字符

##### 16.3.3.3 驳回处理

**驳回后流程**：
1. 记录状态回到"草稿"（draft）
2. 审批链标记为"已取消"（cancelled）
3. 创建人收到通知：记录被驳回，可修改后重新提交
4. 重新提交时，生成新的审批链（重新走完整流程）

**驳回原因显示**：
- 记录详情页显示驳回原因
- 审批历史中记录驳回时间、驳回人、驳回原因

#### 16.3.4 业务规则（新增）

| 规则编号 | 规则描述 |
|---------|----------|
| BR-031 | 正常记录（无偏离）：1级审批（主管）；偏离记录（有偏离）：2级审批（主管→经理） |
| BR-032 | 审批人确定规则：Level 1=提交人的reportTo，Level 2=部门managerId |
| BR-033 | 审批人不能审批自己创建的记录，系统自动过滤 |
| BR-034 | 审批操作不可撤销，审批意见最多500字符 |
| BR-035 | 驳回时必须填写驳回原因，最少10字，最多500字 |
| BR-036 | 任一级驳回，记录回到草稿状态，需重新提交（重新走完整审批链） |
| BR-037 | 审批必须按顺序进行（1级→2级），不能跳级审批 |
| BR-038 | 提交人未配置reportTo或部门未配置managerId时，审批流程无法发起，提示用户 |
| BR-039 | 审批链记录状态：pending（待审批）→ approved（通过）/ rejected（驳回）/ cancelled（取消） |
| BR-040 | 审批历史永久保存，支持追溯审计 |

#### 16.3.5 数据实体

##### Approval 表扩展

**新增字段**：
| 字段名 | 类型 | 说明 |
|--------|------|------|
| level | Integer | 审批级别（1=主管，2=经理） |
| prevApproverId | SnowflakeID | 上一级审批人ID（2级审批时，指向1级审批人） |
| nextApproverId | SnowflakeID | 下一级审批人ID（1级审批通过后，指向2级审批人） |
| approvalChainId | SnowflakeID | 审批链ID（同一次提交的审批链共享同一个ID） |
| rejectionReason | String | 驳回原因（驳回时必填） |

**现有字段保留**：
- id, recordId, approverId, status, comment, createdAt, updatedAt

**审批链记录示例**（偏离记录）：
```
记录1提交 → 生成2条审批记录

审批记录1（主管审批）：
{
  id: 'approval-001',
  recordId: 'record-001',
  approverId: 'user-supervisor',
  level: 1,
  prevApproverId: null,
  nextApproverId: 'approval-002',
  approvalChainId: 'chain-001',
  status: 'approved',
  comment: '生产数据正常，同意归档'
}

审批记录2（经理审批）：
{
  id: 'approval-002',
  recordId: 'record-001',
  approverId: 'user-manager',
  level: 2,
  prevApproverId: 'approval-001',
  nextApproverId: null,
  approvalChainId: 'chain-001',
  status: 'pending',
  comment: null
}
```

##### TaskRecord 表扩展

**新增字段**：
| 字段名 | 类型 | 说明 |
|--------|------|------|
| currentApprovalLevel | Integer | 当前审批级别（0=未提交，1=主管审批中，2=经理审批中） |
| approvalChainId | SnowflakeID | 当前审批链ID（驳回后重新提交会生成新ID） |

#### 16.3.6 审批流程图

```
┌─────────────────┐
│ 员工提交记录      │
└────────┬─────────┘
         │
         ▼
    有偏离？
    /     \
  否       是
  │        │
  ▼        ▼
┌──────────────┐  ┌──────────────┐
│ 1级审批       │  │ 1级审批       │
│ （主管）      │  │ （主管）      │
└──┬────────┬──┘  └──┬────────┬──┘
   │        │        │        │
  通过     驳回     通过     驳回
   │        │        │        │
   ▼        │        ▼        │
┌─────────┐ │   ┌──────────────┐│
│ 归档     │ │   │ 2级审批       ││
└─────────┘ │   │ （经理）      ││
           │   └──┬────────┬──┘│
           │      │        │   │
           │     通过     驳回  │
           │      │        │   │
           │      ▼        │   │
           │   ┌─────────┐ │   │
           │   │ 归档     │ │   │
           │   └─────────┘ │   │
           │                │   │
           ▼                ▼   ▼
        ┌─────────────────────────┐
        │ 回到草稿，通知创建人      │
        │ 可修改后重新提交          │
        └─────────────────────────┘
```

#### 16.3.7 成功指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 审批流程准确率 | 100% | 正常记录走1级，偏离记录走2级，无误触发 |
| 审批操作响应时间 | < 2秒 | 审批通过/驳回操作响应时间 |
| 审批历史完整性 | 100% | 所有审批操作可追溯，无丢失记录 |
| 驳回处理正确率 | 100% | 驳回后记录回到草稿，通知准确发送 |
| 审批人匹配准确率 | 100% | 审批人根据reportTo和managerId准确匹配 |

#### 16.3.8 验收标准

**功能验收**：
- [ ] 正常记录（无偏离）提交后，自动发起1级审批（主管）
- [ ] 偏离记录（有偏离）提交后，自动发起2级审批（主管→经理）
- [ ] 主管审批通过正常记录，记录归档，状态变为"archived"
- [ ] 主管审批通过偏离记录，流转到经理审批，状态变为"pending_level2"
- [ ] 经理审批通过偏离记录，记录归档，状态变为"archived"
- [ ] 任一级驳回，记录回到草稿状态，创建人收到通知
- [ ] 驳回时必须填写驳回原因，否则无法提交
- [ ] 审批历史完整记录每次审批操作（时间、人员、意见）
- [ ] 审批人不能审批自己创建的记录（前端隐藏、后端校验）
- [ ] 提交人未配置reportTo时，提示"未配置直属上级，无法发起审批"
- [ ] 部门未配置managerId且记录有偏离时，提示"未配置部门经理，无法发起2级审批"
- [ ] 审批操作不可撤销，通过/驳回后无法修改

**性能验收**：
- [ ] 审批操作响应时间 < 2秒
- [ ] 审批列表查询时间 < 1秒（100条记录以内）

**安全验收**：
- [ ] 审批权限校验：只有审批人可以审批当前记录
- [ ] 审批人身份验证：Token 校验，防止伪造审批
- [ ] 审批历史不可篡改：审批记录 created_at 不可修改

---

### 16.4 Phase 11：文件预览

#### 16.4.1 业务背景

**核心问题**：
1. 四级文档体系中，Level 1-3 为上传的文件（PDF/Word/Excel），用户需要下载后才能查看内容
2. 下载查看效率低，尤其在移动端或网络不佳的情况下体验差
3. 无法快速确认文件内容是否正确，导致重复下载

**业务目标**：
- 支持 PDF/Word/Excel 全格式在线预览，无需下载
- 预览性能优化，首屏加载时间 < 5秒
- 支持预览缓存，相同文件二次访问更快
- 移动端自适应，支持缩放、翻页等基础操作

#### 16.4.2 用户故事

**故事1：快速预览文档**
```
作为：质量主管
我想要：在文档列表中点击文件名，直接在浏览器中预览文件内容
以便：快速确认文件内容，无需下载到本地

验收标准：
- 点击文件名，弹出预览窗口，显示文件内容
- 支持 PDF、Word（.doc/.docx）、Excel（.xls/.xlsx）三种格式
- 预览窗口支持关闭、下载、打印操作
- 预览失败时，提示用户并提供下载链接
```

**故事2：Excel 表格预览**
```
作为：生产员工
我想要：预览 Excel 文件时，能看到完整的表格结构和数据
以便：确认配料表或配方表的内容准确性

验收标准：
- Excel 预览保留原始样式（字体、颜色、边框）
- 支持多 Sheet 切换（如果文件有多个工作表）
- 支持列宽自适应，表格内容不截断
- 预览窗口支持缩放（放大/缩小）
```

**故事3：Word 文档预览**
```
作为：研发工程师
我想要：预览 Word 文档时，能看到完整的格式和图片
以便：确认工艺文件的排版和内容无误

验收标准：
- Word 预览保留原始格式（标题、段落、列表）
- 图片和表格正常显示
- 支持滚动翻页
- 预览窗口支持全屏模式
```

**故事4：PDF 文档预览**
```
作为：质量审计员
我想要：预览 PDF 文件时，能逐页查看并快速跳转到指定页
以便：审查文档内容，定位关键信息

验收标准：
- PDF 预览显示页码，支持输入页码跳转
- 支持上一页/下一页按钮
- 支持缩放（适应宽度、适应高度、自定义比例）
- 预览清晰度高，文字可正常阅读
```

**故事5：预览性能优化**
```
作为：系统用户
我想要：预览文件时加载速度快，不卡顿
以便：提高工作效率，减少等待时间

验收标准：
- 首次预览文件，加载时间 < 5秒（10MB 以内文件）
- 二次预览相同文件，加载时间 < 1秒（使用缓存）
- 预览加载时，显示进度条或加载动画
- 超大文件（>10MB）提示用户文件较大，建议下载查看
```

#### 16.4.3 功能需求

##### 16.4.3.1 PDF 预览

**技术方案**：
- 前端使用 PDF.js 直接渲染 PDF 文件
- 后端提供文件流接口，支持分段加载（HTTP Range 请求）

**功能列表**：
- ✅ 逐页渲染，支持翻页（上一页/下一页/跳转页）
- ✅ 缩放控制（放大/缩小/适应宽度/适应高度）
- ✅ 全屏模式
- ✅ 下载原文件
- ✅ 打印（调用浏览器打印功能）

**业务规则**：
- PDF 文件 ≤10MB 直接预览
- PDF 文件 >10MB 提示"文件较大，建议下载查看"，但仍可强制预览

##### 16.4.3.2 Word 预览

**技术方案**：
- 后端使用 LibreOffice 转换 Word → HTML
- 前端渲染 HTML 内容，保留格式和图片

**功能列表**：
- ✅ 保留原始格式（标题、段落、列表、表格）
- ✅ 图片正常显示（嵌入图片转为 Base64 或 MinIO URL）
- ✅ 支持滚动浏览
- ✅ 全屏模式
- ✅ 下载原文件

**业务规则**：
- Word 文件转换后缓存 HTML，有效期 7 天
- 转换失败（如文件损坏）时，提示用户并提供下载链接
- 转换超时时间：30 秒

##### 16.4.3.3 Excel 预览

**技术方案**：
- 后端使用 LibreOffice 转换 Excel → HTML
- 前端渲染 HTML 表格，支持多 Sheet 切换

**功能列表**：
- ✅ 保留原始样式（字体、颜色、边框、对齐方式）
- ✅ 多 Sheet 切换（Tab 标签页）
- ✅ 列宽自适应
- ✅ 支持缩放（放大/缩小）
- ✅ 下载原文件

**业务规则**：
- Excel 文件转换后缓存 HTML，有效期 7 天
- 单 Sheet 行数 >1000 时，分页显示（每页 100 行）
- 转换失败时，提示用户并提供下载链接

##### 16.4.3.4 预览缓存机制

**目标**：减少重复转换，提高二次访问速度

**缓存策略**：
| 文件类型 | 缓存内容 | 缓存时长 | 缓存存储 |
|---------|---------|---------|---------|
| PDF | 无需缓存（直接渲染） | - | - |
| Word | 转换后的 HTML | 7天 | MinIO（/preview-cache） |
| Excel | 转换后的 HTML | 7天 | MinIO（/preview-cache） |

**缓存失效条件**：
- 文件被更新（Version 表新增版本记录）
- 缓存超过 7 天（定时任务清理）

**缓存键生成**：
```
cacheKey = `preview_${fileId}_${versionId}_${fileHash}`
```

#### 16.4.4 业务规则（新增）

| 规则编号 | 规则描述 |
|---------|----------|
| BR-041 | 支持 PDF、Word（.doc/.docx）、Excel（.xls/.xlsx）三种格式在线预览 |
| BR-042 | PDF 文件直接渲染，Word/Excel 文件需后端转换为 HTML 后预览 |
| BR-043 | 预览文件大小限制：≤10MB 直接预览，>10MB 提示建议下载（可强制预览） |
| BR-044 | Word/Excel 转换后的 HTML 缓存 7 天，文件更新后缓存失效 |
| BR-045 | 预览加载超时时间：转换 30 秒，渲染 10 秒，超时提示并提供下载链接 |
| BR-046 | 预览权限：拥有文档查看权限的用户才能预览文件 |
| BR-047 | Excel 多 Sheet 文件支持 Sheet 切换，单 Sheet 行数 >1000 时分页显示 |
| BR-048 | 预览窗口支持全屏、缩放、下载、打印（PDF）等操作 |
| BR-049 | 预览失败时，显示友好错误提示，并提供下载原文件的备用方案 |
| BR-050 | 预览缓存存储在 MinIO（/preview-cache 目录），定时任务每日清理过期缓存 |

#### 16.4.5 数据实体

##### FilePreview 表（新增）

**用途**：记录文件预览缓存信息，便于管理和清理

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | SnowflakeID | 主键 |
| fileId | SnowflakeID | 文件ID（关联 Document 或 TaskRecord） |
| versionId | SnowflakeID | 文件版本ID（关联 DocumentVersion） |
| fileType | String | 文件类型（pdf/word/excel） |
| originalFileUrl | String | 原文件 MinIO 路径 |
| previewCacheUrl | String | 预览缓存文件 MinIO 路径（HTML） |
| fileHash | String | 文件哈希值（MD5，用于缓存失效判断） |
| conversionStatus | String | 转换状态（pending/success/failed） |
| conversionError | String | 转换失败原因（如有） |
| expiresAt | DateTime | 缓存过期时间（创建时间 + 7 天） |
| createdAt | DateTime | 创建时间 |

**索引**：
- `idx_file_version`：(fileId, versionId) - 查询缓存时使用
- `idx_expires_at`：expiresAt - 定时清理过期缓存

#### 16.4.6 技术选型

| 文件类型 | 技术方案 | 说明 |
|---------|---------|------|
| PDF | PDF.js（前端） | Mozilla 开源库，支持 Canvas/SVG 渲染，兼容性好 |
| Word/Excel | LibreOffice（后端） | 开源办公套件，支持 .doc/.docx/.xls/.xlsx 转 HTML |
| 预览缓存 | MinIO | 对象存储，支持分布式，成本低 |

**LibreOffice 部署**：
- Docker 容器部署（libreoffice-online 或 unoconv）
- 提供 HTTP API 接口，接收文件路径，返回 HTML
- 转换命令示例：
  ```bash
  libreoffice --headless --convert-to html --outdir /tmp input.docx
  ```

#### 16.4.7 性能要求

| 指标 | 目标值 | 说明 |
|------|--------|------|
| PDF 首次加载 | < 3秒 | 10MB 以内文件 |
| Word/Excel 首次转换 | < 5秒 | 10MB 以内文件 |
| 缓存命中加载 | < 1秒 | 使用缓存的 HTML |
| 转换并发数 | ≥5 | 同时支持 5 个文件转换请求 |
| 预览缓存存储 | 100GB | 预估可缓存 10,000+ 文件 |

#### 16.4.8 验收标准

**功能验收**：
- [ ] PDF 文件点击预览，使用 PDF.js 渲染，支持翻页、缩放、全屏
- [ ] Word 文件点击预览，后端转换为 HTML，保留格式和图片
- [ ] Excel 文件点击预览，后端转换为 HTML，支持多 Sheet 切换
- [ ] 预览窗口支持下载原文件、全屏模式、缩放操作
- [ ] 文件 ≤10MB 直接预览，>10MB 提示建议下载（可强制预览）
- [ ] Word/Excel 预览缓存 7 天，二次访问加载 < 1秒
- [ ] 预览失败时，显示错误提示并提供下载链接
- [ ] 预览权限校验：只有拥有文档查看权限的用户才能预览
- [ ] Excel 多 Sheet 文件支持 Sheet 切换，单 Sheet 行数 >1000 时分页显示
- [ ] 预览加载时，显示进度条或加载动画

**性能验收**：
- [ ] PDF 预览首次加载时间 < 3秒（10MB 以内）
- [ ] Word/Excel 预览首次转换时间 < 5秒（10MB 以内）
- [ ] 预览缓存命中时，加载时间 < 1秒
- [ ] LibreOffice 转换并发数 ≥5

**安全验收**：
- [ ] 预览文件前校验用户权限，无权限返回 403
- [ ] 预览缓存文件存储在 MinIO，使用签名 URL 访问
- [ ] 转换失败时，不暴露服务器路径或敏感信息

---

### 16.5 Phase 12：偏离统计分析

#### 16.5.1 业务背景

**核心问题**：
1. Phase 7-8 实现偏离检测和报告生成，但缺少统计分析能力
2. 质量管理需要了解偏离发生频率、类型分布、趋势变化，指导改进
3. 数据分散在各个偏离报告中，无法快速获取全局视图

**业务目标**：
- 提供偏离统计分析功能，支持按时间、部门、模板、字段等维度分析
- 可视化展示偏离趋势、类型分布、高频偏离字段
- 为质量改进提供数据支持，识别薄弱环节

#### 16.5.2 用户故事

**故事1：偏离次数统计**
```
作为：质量经理
我想要：查看指定时间范围内的偏离次数统计
以便：了解整体偏离情况，评估质量控制效果

验收标准：
- 选择时间范围（本周/本月/本季度/自定义），显示偏离总次数
- 显示偏离率（偏离记录数 / 总记录数）
- 对比上期数据，显示增长率（↑10% / ↓5%）
- 支持按部门筛选（仅看本部门的偏离）
```

**故事2：偏离类型分布**
```
作为：质量主管
我想要：查看偏离字段的分布情况，了解哪些字段容易偏离
以便：针对性地加强培训或调整工艺参数

验收标准：
- 饼图显示偏离字段分布（如：温度 40%、压力 30%、时间 20%、其他 10%）
- 列表显示偏离字段排名（字段名、偏离次数、占比）
- 点击字段名，查看该字段的偏离详情列表
```

**故事3：偏离趋势分析**
```
作为：质量审计员
我想要：查看偏离趋势变化，了解质量控制是否有改善
以便：评估质量改进措施的有效性

验收标准：
- 折线图显示偏离趋势（横轴：日期，纵轴：偏离次数）
- 支持按日/周/月聚合数据
- 支持多字段对比（同时显示温度偏离和压力偏离的趋势）
- 异常峰值标注（偏离次数突增的日期）
```

**故事4：部门偏离对比**
```
作为：总经理
我想要：对比各部门的偏离情况，了解哪个部门质量控制较好
以便：表彰优秀部门，督促改进不足部门

验收标准：
- 柱状图显示各部门偏离次数对比
- 显示部门偏离率排名（偏离率 = 偏离记录数 / 总记录数）
- 支持按时间范围筛选（本月/本季度/本年度）
```

**故事5：高频偏离报告导出**
```
作为：质量分析师
我想要：导出偏离统计报告（Excel），用于月度质量会议
以便：向管理层汇报质量数据，支持决策

验收标准：
- 支持导出偏离统计数据（时间范围、部门、字段分布、趋势数据）
- Excel 包含多个 Sheet（总览、字段分布、部门对比、趋势数据）
- 导出文件命名规范：偏离统计报告_2026年2月_质量部.xlsx
```

#### 16.5.3 功能需求

##### 16.5.3.1 偏离次数统计

**输入**：
- 时间范围（开始日期、结束日期）
- 部门筛选（可选，默认全部）
- 模板筛选（可选，默认全部）

**输出**：
| 指标 | 说明 | 示例 |
|------|------|------|
| 偏离总次数 | 偏离报告数量 | 125 次 |
| 偏离记录数 | 包含偏离的任务记录数 | 85 条（一条记录可能有多个偏离） |
| 总记录数 | 所有任务记录数 | 1,000 条 |
| 偏离率 | 偏离记录数 / 总记录数 | 8.5% |
| 环比增长 | 对比上期偏离率变化 | ↑2.3%（上期 6.2%） |

**业务规则**：
- 统计时间范围：支持预设（本周/本月/本季度）和自定义
- 偏离率计算公式：`偏离率 = (包含偏离的记录数 / 总记录数) * 100%`
- 环比增长计算：`增长率 = (本期偏离率 - 上期偏离率) / 上期偏离率 * 100%`

##### 16.5.3.2 偏离类型分布

**输入**：
- 时间范围
- 部门筛选（可选）

**输出**：
| 偏离字段 | 偏离次数 | 占比 | 平均偏离量 |
|---------|---------|------|----------|
| 温度（temperature） | 50 | 40% | 8.5°C |
| 压力（pressure） | 38 | 30.4% | 0.3MPa |
| 时间（duration） | 25 | 20% | 15min |
| 湿度（humidity） | 12 | 9.6% | 5% |

**可视化**：
- 饼图：显示各字段偏离占比
- 柱状图：显示各字段偏离次数排名

**业务规则**：
- 按偏离次数降序排列
- 占比计算公式：`占比 = (该字段偏离次数 / 总偏离次数) * 100%`
- 平均偏离量：该字段所有偏离的偏离量平均值

##### 16.5.3.3 偏离趋势分析

**输入**：
- 时间范围
- 聚合维度（日/周/月）
- 字段筛选（可选，默认全部偏离）

**输出**：
| 时间点 | 偏离次数 | 偏离率 |
|-------|---------|--------|
| 2026-02-01 | 5 | 5% |
| 2026-02-02 | 8 | 8% |
| 2026-02-03 | 3 | 3% |
| ... | ... | ... |

**可视化**：
- 折线图：横轴时间，纵轴偏离次数/偏离率
- 支持多字段对比（多条折线）
- 异常峰值标注（偏离次数 > 平均值 + 2*标准差）

**业务规则**：
- 日聚合：按提交日期（TaskRecord.createdAt）分组
- 周聚合：按周（ISO Week）分组
- 月聚合：按月（YYYY-MM）分组
- 趋势线平滑：支持移动平均（7日/30日）

##### 16.5.3.4 部门偏离对比

**输入**：
- 时间范围

**输出**：
| 部门 | 总记录数 | 偏离记录数 | 偏离率 | 排名 |
|------|---------|----------|--------|------|
| 生产一部 | 500 | 25 | 5% | 1（最优） |
| 生产二部 | 450 | 36 | 8% | 2 |
| 质检部 | 300 | 30 | 10% | 3 |

**可视化**：
- 柱状图：横轴部门，纵轴偏离率
- 颜色标识：偏离率 <5% 绿色，5%-10% 黄色，>10% 红色

**业务规则**：
- 按偏离率升序排列（偏离率低的排名靠前）
- 只统计有记录的部门（总记录数 >0）

#### 16.5.4 业务规则（新增）

| 规则编号 | 规则描述 |
|---------|----------|
| BR-051 | 偏离率 = (包含偏离的记录数 / 总记录数) * 100%，保留 2 位小数 |
| BR-052 | 统计时间范围支持预设（本周/本月/本季度）和自定义（开始日期-结束日期） |
| BR-053 | 偏离趋势支持按日/周/月聚合，周聚合按 ISO Week，月聚合按 YYYY-MM |
| BR-054 | 偏离字段分布按偏离次数降序排列，显示占比（保留 1 位小数） |
| BR-055 | 部门偏离对比按偏离率升序排列，偏离率低的部门排名靠前 |
| BR-056 | 偏离统计权限：Admin 可查看全部部门，Leader 可查看本部门，User 不可访问统计页面 |
| BR-057 | 异常峰值标注：偏离次数 > 平均值 + 2*标准差 的日期标记为异常 |
| BR-058 | 偏离统计数据可导出 Excel，包含多个 Sheet（总览、字段分布、部门对比、趋势数据） |
| BR-059 | 统计计算基于 DeviationReport 表，不直接查询 TaskRecord（性能优化） |
| BR-060 | 偏离统计支持实时刷新（点击刷新按钮，重新计算最新数据） |

#### 16.5.5 数据实体

##### DeviationStatistics 表（新增，可选）

**用途**：预聚合偏离统计数据，提高查询性能（适用于数据量大的场景）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | SnowflakeID | 主键 |
| statDate | Date | 统计日期（按日聚合） |
| departmentId | SnowflakeID | 部门ID（null 表示全局统计） |
| templateId | SnowflakeID | 模板ID（null 表示全模板统计） |
| fieldName | String | 偏离字段名（null 表示全字段统计） |
| totalRecords | Integer | 总记录数 |
| deviationRecords | Integer | 偏离记录数 |
| deviationCount | Integer | 偏离次数（一条记录可能有多个偏离） |
| deviationRate | Float | 偏离率（百分比） |
| avgDeviationAmount | Float | 平均偏离量 |
| createdAt | DateTime | 创建时间 |

**索引**：
- `idx_stat_date_dept`：(statDate, departmentId) - 查询部门统计
- `idx_stat_date_field`：(statDate, fieldName) - 查询字段统计

**说明**：
- 此表为可选优化方案，适用于数据量 >10万条记录的场景
- 通过定时任务（每日凌晨）预计算统计数据，减少实时查询压力
- 如果数据量不大，可直接从 DeviationReport 表实时计算

#### 16.5.6 可视化需求

| 图表类型 | 用途 | 数据源 |
|---------|------|--------|
| 数字卡片 | 显示偏离总次数、偏离率、环比增长 | 偏离次数统计 |
| 饼图 | 显示偏离字段分布占比 | 偏离类型分布 |
| 柱状图 | 显示偏离字段次数排名、部门偏离对比 | 偏离类型分布、部门对比 |
| 折线图 | 显示偏离趋势（日/周/月） | 偏离趋势分析 |

**前端图表库**：
- 推荐使用 ECharts 5.x（Apache 开源，功能强大）
- 或 Element Plus 自带图表组件（简单场景）

#### 16.5.7 成功指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 统计查询响应时间 | < 2秒 | 1万条记录以内 |
| 图表渲染时间 | < 1秒 | 加载并渲染图表 |
| 统计数据准确率 | 100% | 与源数据（DeviationReport）一致 |
| 统计维度覆盖率 | 100% | 支持时间、部门、模板、字段四个维度 |

#### 16.5.8 验收标准

**功能验收**：
- [ ] 支持选择时间范围（本周/本月/本季度/自定义），显示偏离总次数和偏离率
- [ ] 显示环比增长率（对比上期），↑表示增长，↓表示下降
- [ ] 饼图显示偏离字段分布（字段名、占比），柱状图显示字段次数排名
- [ ] 折线图显示偏离趋势（日/周/月聚合），支持多字段对比
- [ ] 柱状图显示部门偏离对比（部门名、偏离率），按偏离率排序
- [ ] 支持按部门筛选统计数据（Leader 只能看本部门，Admin 可看全部）
- [ ] 点击偏离字段，跳转到该字段的偏离详情列表
- [ ] 支持导出偏离统计报告（Excel），包含多个 Sheet
- [ ] 统计页面支持实时刷新按钮，重新计算最新数据
- [ ] 统计权限校验：User 角色无法访问统计页面，提示权限不足

**性能验收**：
- [ ] 统计查询响应时间 < 2秒（1万条记录以内）
- [ ] 图表渲染时间 < 1秒
- [ ] 大数据量场景（>10万条记录）使用预聚合表优化，查询时间 < 3秒

**准确性验收**：
- [ ] 偏离率计算准确（手动抽查 10 条记录对比）
- [ ] 环比增长率计算准确（对比上期数据）
- [ ] 偏离字段占比总和 = 100%
- [ ] 部门偏离对比数据与源数据一致

---

### 16.6 数据模型汇总（Phase 7-12）

#### 16.6.1 新增数据表

| 表名 | 用途 | 依赖阶段 |
|------|------|---------|
| DeviationReport | 偏离报告明细（字段、期望值、实际值、偏离量、原因） | Phase 7-8 |
| FilePreview | 文件预览缓存信息（转换状态、缓存路径、过期时间） | Phase 11 |
| DeviationStatistics | 偏离统计预聚合数据（可选，性能优化） | Phase 12 |

#### 16.6.2 扩展现有表

##### Template 表扩展

**新增字段**：
| 字段名 | 类型 | 说明 | 启用阶段 |
|--------|------|------|---------|
| version | String | 模板版本号（1.0, 1.1, ...） | Phase 7-8 |

**fieldsJson 结构扩展**：
```typescript
interface TemplateFieldV2 extends TemplateField {
  tolerance?: {
    type: 'range' | 'percentage'  // 范围公差 or 百分比公差
    min?: number                  // 范围公差最小值
    max?: number                  // 范围公差最大值
    percentage?: number           // 百分比公差（如 5 表示 ±5%）
    unit?: string                 // 单位（如 °C、g、MPa）
  }
}
```

##### TaskRecord 表扩展

**新增字段**：
| 字段名 | 类型 | 说明 | 启用阶段 |
|--------|------|------|---------|
| hasDeviation | Boolean | 是否包含偏离 | Phase 7-8 |
| deviationCount | Integer | 偏离字段数量 | Phase 7-8 |
| relatedTemplateId | SnowflakeID | 关联的配方模板ID | Phase 7-8 |
| relatedTemplateVersion | String | 锁定的配方版本号 | Phase 7-8 |
| currentApprovalLevel | Integer | 当前审批级别（0/1/2） | Phase 10 |
| approvalChainId | SnowflakeID | 当前审批链ID | Phase 10 |

##### Approval 表扩展

**新增字段**：
| 字段名 | 类型 | 说明 | 启用阶段 |
|--------|------|------|---------|
| level | Integer | 审批级别（1=主管，2=经理） | Phase 10 |
| prevApproverId | SnowflakeID | 上一级审批人ID | Phase 10 |
| nextApproverId | SnowflakeID | 下一级审批人ID | Phase 10 |
| approvalChainId | SnowflakeID | 审批链ID | Phase 10 |
| rejectionReason | String | 驳回原因 | Phase 10 |

#### 16.6.3 完整版数据模型 ER 图

```
┌─────────────┐        ┌──────────────┐        ┌─────────────┐
│  Template   │        │  TaskRecord  │        │  Approval   │
│  (配方)      │◄───────│  (任务记录)   │───────►│  (审批)      │
└─────────────┘        └──────────┬───┘        └─────────────┘
       │                          │
       │ version                  │ hasDeviation
       │ fieldsJson.tolerance     │ relatedTemplateVersion
       │                          │
       │                          ▼
       │                ┌──────────────────┐
       └───────────────►│ DeviationReport  │
                        │ (偏离报告)         │
                        └──────────────────┘
                                 │
                                 ▼
                        ┌───────────────────┐
                        │ DeviationStatistics│
                        │ (偏离统计)          │
                        └───────────────────┘

┌─────────────┐        ┌──────────────┐
│  Document   │        │  FilePreview │
│  (文档)      │───────►│  (预览缓存)   │
└─────────────┘        └──────────────┘
```

---

### 16.7 完整版业务规则汇总（BR-017 ~ BR-060）

#### Phase 7-8：配方偏离检测与版本管理

| 规则编号 | 规则描述 |
|---------|----------|
| BR-017 | 数值型字段可配置公差（范围公差 or 百分比公差），非数值型字段不支持 |
| BR-018 | 偏离检测在前端实时显示，后端提交时强制验证 |
| BR-019 | 偏离时必须填写偏离原因（最少10字，最多500字） |
| BR-020 | 偏离报告自动生成，不可手动修改，只能审批通过/拒绝 |
| BR-021 | 包含偏离的记录触发额外审批流程（正常：1级审批；偏离：2级审批） |
| BR-022 | 任务记录提交时锁定配方版本号，后续配方更新不影响已提交记录 |
| BR-023 | 配方公差配置修改后，版本号自动+0.1，历史记录按旧版本判断偏离 |
| BR-024 | 偏离报告状态：pending（待审批）→ approved（归档）/ rejected（驳回到创建人） |

#### Phase 9：数据导出

| 规则编号 | 规则描述 |
|---------|----------|
| BR-025 | 支持导出文档列表（Excel）、任务记录（Excel）、偏离报告（Excel） |
| BR-026 | 任务记录导出表头 = 固定列（ID、标题、状态、创建人、创建时间）+ 动态列（模板字段） |
| BR-027 | 动态列根据 Template.fieldsJson 自动生成，字段顺序与模板一致 |
| BR-028 | 导出权限：Admin 可导出全部，Leader 可导出本部门，User 可导出自己的 |
| BR-029 | 导出数量 ≤1000条同步返回，>1000条异步生成（返回任务ID，提供下载链接） |
| BR-030 | 异步导出文件保留7天，超期自动删除 |

#### Phase 10：2级审批流程

| 规则编号 | 规则描述 |
|---------|----------|
| BR-031 | 正常记录（无偏离）：1级审批（主管）；偏离记录（有偏离）：2级审批（主管→经理） |
| BR-032 | 审批人确定规则：Level 1=提交人的reportTo，Level 2=部门managerId |
| BR-033 | 审批人不能审批自己创建的记录，系统自动过滤 |
| BR-034 | 审批操作不可撤销，审批意见最多500字符 |
| BR-035 | 驳回时必须填写驳回原因，最少10字，最多500字 |
| BR-036 | 任一级驳回，记录回到草稿状态，需重新提交（重新走完整审批链） |
| BR-037 | 审批必须按顺序进行（1级→2级），不能跳级审批 |
| BR-038 | 提交人未配置reportTo或部门未配置managerId时，审批流程无法发起，提示用户 |
| BR-039 | 审批链记录状态：pending（待审批）→ approved（通过）/ rejected（驳回）/ cancelled（取消） |
| BR-040 | 审批历史永久保存，支持追溯审计 |

#### Phase 11：文件预览

| 规则编号 | 规则描述 |
|---------|----------|
| BR-041 | 支持 PDF、Word（.doc/.docx）、Excel（.xls/.xlsx）三种格式在线预览 |
| BR-042 | PDF 文件直接渲染，Word/Excel 文件需后端转换为 HTML 后预览 |
| BR-043 | 预览文件大小限制：≤10MB 直接预览，>10MB 提示建议下载（可强制预览） |
| BR-044 | Word/Excel 转换后的 HTML 缓存 7 天，文件更新后缓存失效 |
| BR-045 | 预览加载超时时间：转换 30 秒，渲染 10 秒，超时提示并提供下载链接 |
| BR-046 | 预览权限：拥有文档查看权限的用户才能预览文件 |
| BR-047 | Excel 多 Sheet 文件支持 Sheet 切换，单 Sheet 行数 >1000 时分页显示 |
| BR-048 | 预览窗口支持全屏、缩放、下载、打印（PDF）等操作 |
| BR-049 | 预览失败时，显示友好错误提示，并提供下载原文件的备用方案 |
| BR-050 | 预览缓存存储在 MinIO（/preview-cache 目录），定时任务每日清理过期缓存 |

#### Phase 12：偏离统计分析

| 规则编号 | 规则描述 |
|---------|----------|
| BR-051 | 偏离率 = (包含偏离的记录数 / 总记录数) * 100%，保留 2 位小数 |
| BR-052 | 统计时间范围支持预设（本周/本月/本季度）和自定义（开始日期-结束日期） |
| BR-053 | 偏离趋势支持按日/周/月聚合，周聚合按 ISO Week，月聚合按 YYYY-MM |
| BR-054 | 偏离字段分布按偏离次数降序排列，显示占比（保留 1 位小数） |
| BR-055 | 部门偏离对比按偏离率升序排列，偏离率低的部门排名靠前 |
| BR-056 | 偏离统计权限：Admin 可查看全部部门，Leader 可查看本部门，User 不可访问统计页面 |
| BR-057 | 异常峰值标注：偏离次数 > 平均值 + 2*标准差 的日期标记为异常 |
| BR-058 | 偏离统计数据可导出 Excel，包含多个 Sheet（总览、字段分布、部门对比、趋势数据） |
| BR-059 | 统计计算基于 DeviationReport 表，不直接查询 TaskRecord（性能优化） |
| BR-060 | 偏离统计支持实时刷新（点击刷新按钮，重新计算最新数据） |

---

### 16.8 完整版开发顺序与依赖

#### 16.8.1 推荐开发顺序

```
Phase 10（2级审批）
    ↓
Phase 7-8（偏离检测）─────┐
    ↓                    │
Phase 12（偏离统计）      │
    ↓                    │
Phase 9（数据导出）────────┤
    ↓                    │
Phase 11（文件预览）      │（独立功能，可并行）
```

**说明**：
1. **Phase 10 优先**：2级审批是偏离检测的前置依赖（偏离记录需要2级审批）
2. **Phase 7-8 次之**：偏离检测是统计分析的数据来源
3. **Phase 12 第三**：统计分析依赖偏离数据积累，可与导出并行开发
4. **Phase 9 第四**：导出功能需要偏离报告和统计数据完善后再实现
5. **Phase 11 最后**：文件预览是独立功能，可与其他 Phase 并行开发

#### 16.8.2 依赖关系矩阵

| Phase | 依赖 Phase | 依赖原因 |
|-------|-----------|---------|
| Phase 7-8 | Phase 10 | 偏离记录触发2级审批，需要先实现审批链机制 |
| Phase 9 | Phase 7-8, Phase 12 | 导出偏离报告和统计数据，需要先有数据源 |
| Phase 10 | - | 独立功能，无依赖 |
| Phase 11 | - | 独立功能，无依赖 |
| Phase 12 | Phase 7-8 | 统计偏离数据，需要先有偏离报告数据 |

#### 16.8.3 数据表创建顺序

```
1. Approval 表扩展（Phase 10）
   ↓
2. Template 表扩展 + TaskRecord 表扩展（Phase 7-8）
   ↓
3. DeviationReport 表（Phase 7-8）
   ↓
4. DeviationStatistics 表（Phase 12，可选）
   ↓
5. FilePreview 表（Phase 11）
```

---

### 16.9 完整版工作量估算

#### 16.9.1 开发工作量估算（人天）

| Phase | 后端开发 | 前端开发 | 测试 | 总计 |
|-------|---------|---------|------|------|
| Phase 7-8（偏离检测） | 8 天 | 10 天 | 4 天 | 22 天 |
| Phase 9（数据导出） | 5 天 | 3 天 | 2 天 | 10 天 |
| Phase 10（2级审批） | 6 天 | 8 天 | 3 天 | 17 天 |
| Phase 11（文件预览） | 7 天 | 5 天 | 3 天 | 15 天 |
| Phase 12（偏离统计） | 6 天 | 8 天 | 3 天 | 17 天 |
| **总计** | **32 天** | **34 天** | **15 天** | **81 天** |

**说明**：
- 按 1 个后端工程师 + 1 个前端工程师 + 1 个测试工程师计算
- 实际工期约 **2-3 个月**（考虑并行开发和缓冲时间）
- Phase 11 可与其他 Phase 并行开发，节省 1-2 周

#### 16.9.2 详细工作量分解

##### Phase 7-8：偏离检测与版本管理（22 天）

**后端（8 天）**：
- 数据库扩展（Template/TaskRecord/DeviationReport）：1 天
- 偏离检测逻辑（范围公差+百分比公差）：2 天
- 版本锁定机制：1 天
- 偏离报告生成：2 天
- API 接口开发：2 天

**前端（10 天）**：
- 配方公差配置 UI：3 天
- 实时偏离检测（表单验证+标红提示）：3 天
- 偏离原因弹窗（强制填写）：2 天
- 偏离报告展示：2 天

**测试（4 天）**：
- 单元测试（偏离检测逻辑）：2 天
- 集成测试（端到端流程）：2 天

##### Phase 9：数据导出（10 天）

**后端（5 天）**：
- Excel 生成库集成（xlsx）：1 天
- 文档列表导出：1 天
- 任务记录导出（动态列生成）：2 天
- 偏离报告导出：1 天

**前端（3 天）**：
- 导出按钮 UI：1 天
- 异步导出任务状态查询：1 天
- 下载链接处理：1 天

**测试（2 天）**：
- 导出数据准确性测试：1 天
- 导出性能测试（大数据量）：1 天

##### Phase 10：2级审批流程（17 天）

**后端（6 天）**：
- Approval 表扩展：1 天
- 审批链生成逻辑：2 天
- 级联审批流转：2 天
- 驳回处理：1 天

**前端（8 天）**：
- 审批详情页：3 天
- 审批操作（通过/驳回）：2 天
- 审批历史展示：2 天
- 审批状态流转 UI：1 天

**测试（3 天）**：
- 审批流程测试（正常/偏离）：2 天
- 驳回场景测试：1 天

##### Phase 11：文件预览（15 天）

**后端（7 天）**：
- LibreOffice 部署配置：2 天
- Word/Excel 转 HTML 接口：2 天
- 预览缓存机制：2 天
- API 接口开发：1 天

**前端（5 天）**：
- PDF.js 集成：2 天
- Word/Excel HTML 渲染：2 天
- 预览窗口 UI（缩放/翻页）：1 天

**测试（3 天）**：
- 三种格式预览测试：2 天
- 预览性能测试：1 天

##### Phase 12：偏离统计分析（17 天）

**后端（6 天）**：
- 偏离统计逻辑：2 天
- 统计 API 接口：2 天
- 预聚合表（可选）：2 天

**前端（8 天）**：
- ECharts 集成：1 天
- 偏离次数统计 UI：2 天
- 偏离趋势图表：2 天
- 部门对比图表：2 天
- 导出统计报告：1 天

**测试（3 天）**：
- 统计数据准确性测试：2 天
- 统计性能测试：1 天

---

### 16.10 技术风险与解决方案

#### 16.10.1 Phase 7-8 风险

| 风险 | 影响 | 概率 | 解决方案 |
|------|------|------|---------|
| 偏离检测逻辑复杂，边界条件多 | 高 | 中 | 编写详细的单元测试，覆盖各种公差配置场景 |
| 版本锁定机制实现不当，导致历史数据混乱 | 高 | 低 | 提交时强制记录版本号，代码审查确保逻辑正确 |
| 偏离报告数据量大，查询性能差 | 中 | 中 | 建立索引（recordId, templateId, createdAt），考虑分表或归档 |

#### 16.10.2 Phase 9 风险

| 风险 | 影响 | 概率 | 解决方案 |
|------|------|------|---------|
| 动态列导出逻辑复杂，字段映射错误 | 高 | 中 | 编写测试用例，对比导出数据与源数据一致性 |
| 大数据量导出超时（>10000条） | 中 | 高 | 使用异步导出 + 分页查询 + 流式写入 Excel |
| 导出文件格式不兼容（Excel 版本） | 低 | 低 | 使用标准 xlsx 格式（xlsx 库默认支持） |

#### 16.10.3 Phase 10 风险

| 风险 | 影响 | 概率 | 解决方案 |
|------|------|------|---------|
| 审批链状态机复杂，驳回逻辑处理不当 | 高 | 中 | 绘制状态流转图，编写集成测试覆盖所有路径 |
| 审批人配置缺失（reportTo/managerId 为空） | 中 | 中 | 提交时校验，提示用户配置审批人 |
| 审批历史数据量大，查询慢 | 中 | 低 | 建立索引（recordId, createdAt），分页查询 |

#### 16.10.4 Phase 11 风险

| 风险 | 影响 | 概率 | 解决方案 |
|------|------|------|---------|
| LibreOffice 转换性能差，首次预览慢 | 高 | 高 | 使用缓存机制，二次访问加载缓存；转换超时提示用户下载 |
| Word/Excel 转 HTML 格式丢失 | 中 | 中 | 测试常见文件格式，发现问题调整转换参数；复杂格式提示下载查看 |
| 预览缓存占用存储空间大 | 中 | 中 | 设置缓存过期时间（7天），定时任务清理过期缓存 |
| LibreOffice 转换失败（文件损坏） | 低 | 低 | 转换失败时提示用户并提供下载链接，不阻塞业务流程 |

#### 16.10.5 Phase 12 风险

| 风险 | 影响 | 概率 | 解决方案 |
|------|------|------|---------|
| 统计查询性能差（数据量大） | 高 | 高 | 使用预聚合表（DeviationStatistics），定时任务每日预计算 |
| 偏离率计算不准确 | 高 | 低 | 编写单元测试，手动抽查验证计算公式正确性 |
| 图表渲染慢（大数据量） | 中 | 中 | 限制图表数据点数量（最多 365 天），支持数据采样 |
| 统计维度组合爆炸（部门×模板×字段） | 中 | 低 | 限制统计维度数量，提供预设统计报表 |

#### 16.10.6 通用技术风险

| 风险 | 影响 | 概率 | 解决方案 |
|------|------|------|---------|
| 数据库迁移失败（扩展字段） | 高 | 低 | 备份数据库，灰度发布，回滚方案 |
| 向后兼容性问题（影响 MVP） | 高 | 低 | 扩展字段为可选项（nullable），不修改现有逻辑 |
| 第三方库版本冲突（xlsx/LibreOffice） | 中 | 低 | 锁定依赖版本，测试环境验证后再部署 |
| 性能退化（完整版功能增加） | 中 | 中 | 性能测试，关键路径优化（索引、缓存、分页） |

---

### 14.2 预留扩展字段

以下字段已在数据模型中预留，后续直接启用：

| 字段 | 表 | 用途 | 启用条件 |
|------|------|------|----------|
| email | users | 邮件地址 | 启用邮件通知功能 |
| phone | users | 手机号码 | 启用短信/微信通知 |
| workflow_config | documents | 审批流程配置 | 启用自定义审批流程 |
| tags | documents | 标签列表 | 启用标签搜索功能 |
| tags | templates | 标签列表 | 启用标签筛选功能 |
| description | departments | 部门描述 | 部门信息完善时 |

### 14.3 完整版数据模型扩展

```sql
-- 审批流程配置表（完整版）
approval_workflows (
  id              SnowflakeID   PRIMARY KEY,
  name            VARCHAR(100)  NOT NULL,           -- 流程名称
  levels          JSONB         NOT NULL,            -- 审批级别配置
  condition       JSONB,                            -- 触发条件
  timeout_hours   INT,                              -- 超时时间
  status          VARCHAR(10)  NOT NULL DEFAULT 'active',
  created_at      TIMESTAMP   DEFAULT NOW(),
  updated_at      TIMESTAMP   DEFAULT NOW()
);

-- 标签表
tags (
  id          SnowflakeID   PRIMARY KEY,
  name        VARCHAR(50)   NOT NULL,               -- 标签名称
  color       VARCHAR(20),                          -- 标签颜色
  type        VARCHAR(20)   NOT NULL,               -- document/template
  created_at  TIMESTAMP   DEFAULT NOW()
);

-- 文件标签关联表
document_tags (
  id          SnowflakeID   PRIMARY KEY,
  document_id SnowflakeID   REFERENCES documents(id),
  tag_id      SnowflakeID   REFERENCES tags(id),
  created_at  TIMESTAMP   DEFAULT NOW()
);

-- 邮件配置表
email_config (
  id          SnowflakeID   PRIMARY KEY,
  host        VARCHAR(100)  NOT NULL,               -- SMTP服务器
  port        INT           NOT NULL,               -- 端口
  username    VARCHAR(100)  NOT NULL,               -- 发件账号
  password    VARCHAR(255)  NOT NULL,               -- 发件密码
  from_name   VARCHAR(100),                         -- 发件人名称
  status      VARCHAR(10)   NOT NULL DEFAULT 'active',
  created_at  TIMESTAMP   DEFAULT NOW(),
  updated_at  TIMESTAMP   DEFAULT NOW()
);

-- 系统配置表
system_config (
  id          SnowflakeID   PRIMARY KEY,
  key         VARCHAR(50)   UNIQUE NOT NULL,        -- 配置键
  value       TEXT,                                 -- 配置值
  description VARCHAR(200),                         -- 说明
  updated_at  TIMESTAMP   DEFAULT NOW()
);
```

### 14.4 完整版API扩展

| 模块 | 端点 | 方法 | 说明 |
|------|------|------|------|
| **工作流** | | | |
| | /api/v1/workflows | GET | 流程列表 |
| | /api/v1/workflows | POST | 创建流程 |
| | /api/v1/workflows/:id | PUT | 更新流程 |
| | /api/v1/workflows/:id | DELETE | 删除流程 |
| **标签** | | | |
| | /api/v1/tags | GET | 标签列表 |
| | /api/v1/tags | POST | 创建标签 |
| | /api/v1/tags/:id | DELETE | 删除标签 |
| | /api/v1/tags/:id/documents | GET | 标签下的文档 |
| **统计** | | | |
| | /api/v1/stats/documents | GET | 文档统计 |
| | /api/v1/stats/approvals | GET | 审批统计 |
| | /api/v1/stats/tasks | GET | 任务统计 |
| **系统** | | | |
| | /api/v1/config | GET | 系统配置 |
| | /api/v1/config | PUT | 更新配置 |
| | /api/v1/email/test | POST | 发送测试邮件 |

### 14.5 完整版前端页面

在 MVP 侧边栏基础上，完整版增加：

```
侧边栏扩展:
├── 系统管理（Admin）
│   ├── 工作流配置 ← 新增
│   ├── 标签管理 ← 新增
│   ├── 邮件配置 ← 新增
│   └── 系统参数 ← 新增
├── 统计分析 ← 新增
│   ├── 文档统计
│   ├── 审批统计
│   └── 任务统计
└── 我的
    ├── 我的归档 ← 新增
    └── 个人设置 ← 新增（语言切换、邮箱绑定）
```

### 14.6 完整版组件扩展

| 组件 | 用途 | 说明 |
|------|------|------|
| WorkflowDesigner | 工作流设计器 | 可视化拖拽配置审批流程 |
| VersionCompare | 版本对比 | 文档版本差异对比 |
| TagManager | 标签管理 | 批量打标签、标签筛选 |
| DataExport | 数据导出 | 批量导出Excel |
| EmailSettings | 邮件设置 | SMTP配置、测试发送 |
| StatsDashboard | 统计面板 | 图表展示统计数据 |
| LanguageSwitch | 语言切换 | 中英文切换 |
| FilePreview | 文件预览 | 在线预览PDF/Word/Excel |

### 14.7 完整版开发顺序（Phase 7+）

| Phase | 模块 | 说明 |
|-------|------|------|
| Phase 7 | 数据联动（自动带入） | 创建下游报表时自动带入上游配方数据 |
| Phase 8 | 版本联动（自动更新） | 上游配方变更后，下游报表自动更新 |
| Phase 9 | 数据导出 | Excel批量导出 |
| Phase 10 | 工作流配置 | 可视化工作流设计器 |
| Phase 11 | 文件预览 | 在线预览功能 |
| Phase 12 | 统计分析 | 报表和图表展示 |
| Phase 13 | 多语言 | 中英文切换框架 |
| Phase 14 | 邮件通知 | 留接口，不实现 |

### 14.8 数据联动与版本联动说明

#### 数据联动（自动带入）
**触发时机**：创建下游报表时
**业务场景**：配料表创建时，自动带入工艺配方的原料和比例

```
步骤：
1. 打开"配料表"模板创建新记录
2. 选择关联的"工艺配方"（比如：配方A）
3. 系统自动把配方A的原料和比例带入配料表
4. 保存 → 完成
```

#### 版本联动（自动更新）
**触发时机**：上游配方变更时
**业务场景**：配方从v1.0更新到v1.1，所有关联的生产记录自动更新

```
步骤：
1. 配方A版本从1.0更新到1.1（原料比例变了）
2. 系统检测到变更
3. 自动找到所有关联的生产记录
4. 把这些记录中的配方数据更新到1.1版本
```

#### 业务关系图
```
┌─────────────┐    创建时带入     ┌─────────────┐
│  工艺配方    │ ───────────────> │  生产报表   │
│  (配方A v1.0)│                  │  (带配方A)  │
└─────────────┘                  └─────────────┘
       │
       │ 配方更新 v1.0 → v1.1
       │
       ▼
┌─────────────┐    自动更新       ┌─────────────┐
│  工艺配方    │ ───────────────> │  生产报表   │
│  (配方A v1.1)│                  │  (同步更新) │
└─────────────┘                  └─────────────┘
```

### 14.9 完整版注意事项

1. **向后兼容**: 完整版改动不能影响 MVP 已有功能
2. **数据迁移**: 新增表需要处理存量数据
3. **平滑升级**: 支持配置开关控制功能启用/禁用
4. **性能考虑**: 大数据量时需要分表或归档策略
5. **安全增强**: 完整版需要更严格的权限校验和审计日志

---

## 十五、待补充细节

> 以下是待讨论或待确认的细节，在后续会议中补充

| 序号 | 分类 | 问题 | 状态 |
|------|------|------|------|
| 1 | | | 待讨论 |
| 2 | | | 待讨论 |
| 3 | | | 待讨论 |

---

**文档版本**: 3.0
**最后更新**: 2026-02-06
**更新内容**:
- ✅ 完成 Phase 7-12 完整版 PRD 详细设计（十六章节）
- ✅ 完成 Phase 7-12 技术实现方案（LLD 级别）
- ✅ 新增配方偏离检测与版本管理（Phase 7-8）- 含算法设计、Service 实现、API 接口
- ✅ 新增数据导出功能（Phase 9）- 含 ExcelJS 动态列导出、样式设置
- ✅ 新增2级审批流程（Phase 10）- 含审批链状态机、级联审批逻辑
- ✅ 新增文件预览功能（Phase 11）- 含 LibreOffice Docker 部署、PDF.js 集成
- ✅ 新增偏离统计分析（Phase 12）- 含 ECharts 图表、Redis 缓存策略
- ✅ 完整版业务规则汇总（BR-017 ~ BR-060）
- ✅ 完整版数据模型汇总（3张新表 + 3张扩展表 + 完整 Prisma Schema）
- ✅ 完整版开发顺序与依赖关系
- ✅ 完整版工作量估算（81人天，2-3个月）
- ✅ 技术风险与解决方案
- ✅ 核心 Service 实现代码（DeviationService、ApprovalService、ExportService、FilePreviewService、StatisticsService）
- ✅ 前端组件设计（DeviationChecker、ApprovalDetailDialog、FilePreview、StatisticsDashboard）

**状态**:
- MVP Phase 1-6: 完成 98.1%（51/52 Issue），仅回收站 UI 待完善
- Phase 7-12: PRD + LLD 已完成，可作为后续开发的技术蓝图
- 建议：优先完成 MVP Phase 1-6 剩余 Issue，再启动 Phase 7-12 开发
