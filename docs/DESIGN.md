# æ–‡æ¡£ç®¡ç†ç³»ç»Ÿ - å®Œæ•´éœ€æ±‚è®¾è®¡æ–‡æ¡£

> æœ€åæ›´æ–°: 2026-02-13
> æ–‡æ¡£ç‰ˆæœ¬: 10.7 â­ **P1 æŠ€æœ¯å€ºåŠ¡å®Œæ•´æ–¹æ¡ˆï¼ˆAPI + ä¸šåŠ¡è§„åˆ™ + å‰ç«¯ç•Œé¢ï¼‰**
> æ–‡æ¡£è¡Œæ•°: ~20,000 è¡Œ
> **æ¶æ„å‡çº§**: è‡ªåº•å‘ä¸Šåˆ†å±‚è®¾è®¡ï¼Œæ˜ç¡®ä¾èµ–å…³ç³»ï¼Œæ ¸å¿ƒå¼•æ“å®Œæ•´å®šä¹‰
> **ä¸šåŠ¡è§„åˆ™**: åŸºäºç”¨æˆ·è¯¦ç»†ä¸šåŠ¡è§„åˆ™ï¼Œå…± 113 æ¡ç»†åŒ–è§„åˆ™ï¼ˆBR-1.1 ~ BR-1.60, BR-281 ~ BR-359ï¼‰
> **å‰ç«¯äº¤äº’**: å®Œæ•´çš„ UI/UX äº¤äº’è§„èŒƒï¼Œè¦†ç›– 7 å¤§æ¨¡å—ï¼Œè¯¦è§ [INTERACTION_DESIGN.md](./INTERACTION_DESIGN.md)
> **MVP çŠ¶æ€**: Phase 1-6 å®Œæˆ 98.1%ï¼ˆ51/52 Issueï¼‰| å·²æœ‰åŸºç¡€ä»£ç åº“ | æŠ€æœ¯æ ˆå·²ç¡®ç«‹
> **æŠ€æœ¯å€ºåŠ¡**: P1-1/P1-2/P1-3 å®Œæ•´æ–¹æ¡ˆå·²è¡¥å……ï¼ˆæ•°æ®æ¨¡å‹ + API + ä¸šåŠ¡è§„åˆ™ + å‰ç«¯ç•Œé¢ï¼‰
> **çŠ¶æ€**: Layer 0-1 å®Œæ•´å®šä¹‰ | Layer 2-4 ä¾èµ–å…³ç³»æ˜ç¡® | 8 ä¸ª P0 é—®é¢˜ä¿®å¤å®Œæˆ | æ‰€æœ‰å¾…ç¡®è®¤ç»†èŠ‚å·²æ˜ç¡® | å‰ç«¯äº¤äº’è§„èŒƒå®Œæˆ | æŠ€æœ¯å€ºåŠ¡å®Œæ•´æ–¹æ¡ˆå®Œæˆ

---

## ğŸš€ MVP å®ç°çŠ¶æ€è¿½è¸ªï¼ˆv10.6 æ–°å¢ï¼‰

> **é‡è¦è¯´æ˜**: æœ¬é¡¹ç›®å·²å®Œæˆ MVP Phase 1-6 çš„ 98.1% åŠŸèƒ½ï¼ˆ51/52 Issueï¼‰ï¼Œå…·å¤‡å®Œæ•´çš„ Vue 3 + Element Plus + NestJS + Prisma æŠ€æœ¯æ ˆåŸºç¡€ã€‚æœ¬èŠ‚ç”¨äºè¿½è¸ªå·²å®ç°åŠŸèƒ½ä¸å¾…å®ç°åŠŸèƒ½ï¼ŒæŒ‡å¯¼å¢é‡å¼€å‘ã€‚

### ğŸ“Š Phase 1-6 æ ¸å¿ƒåŠŸèƒ½å®ç°çŠ¶æ€

| Phase | æ¨¡å— | åŠŸèƒ½ç‚¹ | å®ç°çŠ¶æ€ | ä»£ç ä½ç½® | å¤‡æ³¨ |
|-------|------|--------|---------|---------|------|
| **Phase 1** | **ç”¨æˆ·ç®¡ç†** | ç”¨æˆ·CRUD | âœ… å·²å®ç° | `server/src/modules/user/`<br>`client/src/views/user/` | å«ç™»å½•/æ³¨å†Œ/æƒé™ |
| Phase 1 | ç”¨æˆ·ç®¡ç† | ç»„ç»‡æ¶æ„ | âœ… å·²å®ç° | `server/src/modules/department/`<br>`client/src/views/department/` | æ ‘å½¢ç»“æ„ |
| **Phase 2** | **æ–‡æ¡£ç®¡ç†** | ä¸‰çº§æ–‡æ¡£CRUD | âœ… å·²å®ç° | `server/src/modules/document/`<br>`client/src/views/document/` | ä¸€/äºŒ/ä¸‰çº§æ–‡ä»¶ |
| Phase 2 | æ–‡æ¡£ç®¡ç† | æ–‡ä»¶ä¸Šä¼ ï¼ˆMinIOï¼‰ | âœ… å·²å®ç° | `server/src/modules/file/` | æ”¯æŒ PDF/Word/Excel |
| Phase 2 | æ–‡æ¡£ç®¡ç† | ç‰ˆæœ¬æ§åˆ¶ | âœ… å·²å®ç° | `Document.version` å­—æ®µ | è‡ªåŠ¨ç‰ˆæœ¬å·ç”Ÿæˆ |
| Phase 2 | æ–‡æ¡£ç®¡ç† | æ–‡æ¡£é¢„è§ˆï¼ˆPDFï¼‰ | âœ… å·²å®ç° | `client/src/components/PdfViewer.vue` | åŸç”Ÿ PDF é¢„è§ˆ |
| **Phase 3** | **å®¡æ‰¹æµç¨‹** | å•çº§å®¡æ‰¹ | âœ… å·²å®ç° | `server/src/modules/approval/`<br>`client/src/views/approval/` | æ–‡æ¡£å®¡æ‰¹ |
| Phase 3 | å®¡æ‰¹æµç¨‹ | å®¡æ‰¹è®°å½• | âœ… å·²å®ç° | `Approval` è¡¨ | å®Œæ•´å®¡æ‰¹é“¾ |
| **Phase 4** | **æ¨¡æ¿ç®¡ç†** | å››çº§æ¨¡æ¿CRUD | âœ… å·²å®ç° | `server/src/modules/template/`<br>`client/src/views/template/` | åŠ¨æ€å­—æ®µé…ç½® |
| Phase 4 | æ¨¡æ¿ç®¡ç† | å­—æ®µç±»å‹æ”¯æŒ | âœ… å·²å®ç° | 20+ å­—æ®µç±»å‹ | æ–‡æœ¬/æ•°å­—/æ—¥æœŸ/ä¸‹æ‹‰ç­‰ |
| **Phase 5** | **ä»»åŠ¡ç®¡ç†** | ä»»åŠ¡æ´¾å‘ | âœ… å·²å®ç° | `server/src/modules/task/`<br>`client/src/views/task/` | ä»»åŠ¡åˆ†é…åˆ°äºº |
| Phase 5 | ä»»åŠ¡ç®¡ç† | ä»»åŠ¡å¡«æŠ¥ | âœ… å·²å®ç° | åŠ¨æ€è¡¨å•å¡«å†™ | åŸºäºæ¨¡æ¿å­—æ®µ |
| **Phase 6** | **é€šçŸ¥ç³»ç»Ÿ** | ç«™å†…æ¶ˆæ¯ | âœ… å·²å®ç° | `server/src/modules/notification/`<br>`client/src/views/notification/` | å®æ—¶é€šçŸ¥ |
| Phase 6 | é€šçŸ¥ç³»ç»Ÿ | æ¶ˆæ¯å·²è¯»/æœªè¯» | âœ… å·²å®ç° | `Notification.read` å­—æ®µ | - |
| **Phase 7** | **åç¦»æ£€æµ‹** | å…¬å·®é…ç½® | âœ… å·²å®ç° | `TemplateField.tolerance` | èŒƒå›´/ç™¾åˆ†æ¯” |
| Phase 7 | åç¦»æ£€æµ‹ | è‡ªåŠ¨åç¦»æ£€æµ‹ | âœ… å·²å®ç° | å¡«æŠ¥æ—¶è‡ªåŠ¨æ£€æµ‹ | - |
| Phase 7 | åç¦»æ£€æµ‹ | åç¦»æŠ¥å‘Šç”Ÿæˆ | âœ… å·²å®ç° | `DeviationReport` è¡¨ | - |
| **Phase 9** | **æ•°æ®å¯¼å‡º** | Excel æ‰¹é‡å¯¼å‡º | âœ… å·²å®ç° | `server/src/modules/export/` | æ–‡æ¡£/ä»»åŠ¡/åç¦» |
| Phase 9 | æ•°æ®å¯¼å‡º | åŠ¨æ€åˆ—æ”¯æŒ | âœ… å·²å®ç° | ExcelJS ç”Ÿæˆ | - |
| **Phase 12** | **åç¦»ç»Ÿè®¡** | åç¦»è¶‹åŠ¿åˆ†æ | âœ… å·²å®ç° | `client/src/views/statistics/` | ECharts å›¾è¡¨ |
| Phase 12 | åç¦»ç»Ÿè®¡ | å­—æ®µåˆ†å¸ƒç»Ÿè®¡ | âœ… å·²å®ç° | é¥¼å›¾å±•ç¤º | - |
| Phase 12 | åç¦»ç»Ÿè®¡ | éƒ¨é—¨åç¦»ç‡ | âœ… å·²å®ç° | æŸ±çŠ¶å›¾å¯¹æ¯” | - |
| **å…¶ä»–** | **å›æ”¶ç«™** | è½¯åˆ é™¤åŠŸèƒ½ | âœ… å·²å®ç° | `deleted_at` å­—æ®µ | æ‰€æœ‰æ ¸å¿ƒè¡¨æ”¯æŒ |
| å…¶ä»– | å›æ”¶ç«™ | å›æ”¶ç«™UI | â³ **æœªå®Œæˆ** | - | **ä»…å‰©çš„ 1/52 Issue** |

**å®Œæˆåº¦ç»Ÿè®¡**:
- âœ… **å·²å®ç°**: 51 ä¸ªåŠŸèƒ½ç‚¹ï¼ˆ98.1%ï¼‰
- â³ **æœªå®Œæˆ**: 1 ä¸ªåŠŸèƒ½ç‚¹ï¼ˆ1.9%ï¼‰- å›æ”¶ç«™UI

**Phase 8/10/11 è®¾è®¡å®Œæˆä½†æœªå®æ–½**:
- Phase 8: åç¦»æ£€æµ‹ï¼ˆéƒ¨åˆ†å·²å®ç°ï¼‰
- Phase 10: äºŒçº§å®¡æ‰¹æµç¨‹ï¼ˆPRD å·²å®Œæˆï¼Œè§ç¬¬åå…­ç« ï¼‰
- Phase 11: æ–‡ä»¶é¢„è§ˆï¼ˆPDF å·²å®ç°ï¼ŒWord/Excel å¾…å®Œå–„ï¼‰

### ğŸ“¦ ç°æœ‰æŠ€æœ¯æ ˆæ€»ç»“

| å±‚çº§ | æŠ€æœ¯ | ç‰ˆæœ¬ | å·²é…ç½® |
|------|------|------|--------|
| **å‰ç«¯** | Vue 3 | 3.4+ | âœ… |
| å‰ç«¯ | Element Plus | 2.5+ | âœ… |
| å‰ç«¯ | TypeScript | 5.0+ | âœ… |
| å‰ç«¯ | Vite | 5.0+ | âœ… |
| å‰ç«¯ | Pinia | 2.1+ | âœ… |
| å‰ç«¯ | ECharts | 6.0+ | âœ… åç¦»ç»Ÿè®¡å›¾è¡¨ |
| å‰ç«¯ | sortablejs | 1.15+ | âœ… æ‹–æ‹½æ’åº |
| **åç«¯** | Node.js | 18+ | âœ… |
| åç«¯ | NestJS | 10+ | âœ… |
| åç«¯ | TypeScript | 5.3+ | âœ… |
| åç«¯ | Prisma | 5.7+ | âœ… |
| åç«¯ | ExcelJS | 4.4+ | âœ… æ•°æ®å¯¼å‡º |
| åç«¯ | bcrypt | 5.1+ | âœ… å¯†ç åŠ å¯† |
| åç«¯ | jsonwebtoken | 9.0+ | âœ… JWT è®¤è¯ |
| åç«¯ | @nestjs/swagger | 7.1+ | âœ… API æ–‡æ¡£ |
| åç«¯ | helmet | 8.1+ | âœ… å®‰å…¨å¤´ |
| **æ•°æ®åº“** | PostgreSQL | 15+ | âœ… Docker |
| æ•°æ®åº“ | Redis | 7+ | âœ… Docker |
| **å­˜å‚¨** | MinIO | 8.0+ | âœ… Docker S3å…¼å®¹ |
| **æµ‹è¯•** | Jest | - | âœ… 164 tests, 85.3% coverage |
| **éƒ¨ç½²** | Docker | - | âœ… docker-compose.yml |

**å…³é”®é…ç½®æ–‡ä»¶**:
- âœ… `server/src/prisma/schema.prisma` - å®Œæ•´æ•°æ®æ¨¡å‹
- âœ… `server/.env` - ç¯å¢ƒå˜é‡é…ç½®
- âœ… `docker-compose.yml` - PostgreSQL + Redis + MinIO
- âœ… `client/vite.config.ts` - å‰ç«¯æ„å»ºé…ç½®
- âœ… `server/tsconfig.json` - åç«¯ TypeScript é…ç½®

### ğŸ”„ å¢é‡å¼€å‘æŒ‡å¯¼ï¼ˆæ–°åŠŸèƒ½é›†æˆæ£€æŸ¥æ¸…å•ï¼‰

> **æ ¸å¿ƒåŸåˆ™**: æ‰€æœ‰æ–°åŠŸèƒ½å¿…é¡»ä¸ç°æœ‰ MVP ä»£ç åº“æ— ç¼é›†æˆï¼Œä¸ç ´åå·²æœ‰åŠŸèƒ½ï¼Œéµå¾ªç°æœ‰æ¶æ„å’ŒæŠ€æœ¯æ ˆã€‚

#### âœ… æ–°åŠŸèƒ½å¼€å‘å‰æ£€æŸ¥ï¼ˆå¼ºåˆ¶ï¼‰

**1. æŠ€æœ¯æ ˆå…¼å®¹æ€§æ£€æŸ¥**
```
â–¡ æ˜¯å¦ä½¿ç”¨æ–‡æ¡£ä¸­åˆ—å‡ºçš„æŠ€æœ¯æ ˆï¼Ÿï¼ˆä¸å¼•å…¥æ–°åº“ï¼‰
â–¡ å‰ç«¯æ˜¯å¦ä½¿ç”¨ Vue 3 + Element Plusï¼Ÿ
â–¡ åç«¯æ˜¯å¦ä½¿ç”¨ NestJS + Prismaï¼Ÿ
â–¡ æ˜¯å¦å¤ç”¨ç°æœ‰ç»„ä»¶/æœåŠ¡ï¼Ÿï¼ˆæ£€æŸ¥ client/src/components/ å’Œ server/src/modules/ï¼‰
```

**2. æ•°æ®æ¨¡å‹å…¼å®¹æ€§æ£€æŸ¥**
```
â–¡ æ–°å¢è¡¨æ˜¯å¦ç¬¦åˆ Prisma Schema è§„èŒƒï¼Ÿ
â–¡ æ˜¯å¦å¤ç”¨ç°æœ‰è¡¨å…³ç³»ï¼Ÿï¼ˆå¦‚ Userã€Departmentã€Documentï¼‰
â–¡ å¤–é”®çº¦æŸæ˜¯å¦è®¾ç½®æ­£ç¡®ï¼Ÿï¼ˆonDelete: Restrict / Cascadeï¼‰
â–¡ æ˜¯å¦æ·»åŠ  created_atã€updated_atã€deleted_atï¼Ÿï¼ˆè½¯åˆ é™¤æ”¯æŒï¼‰
â–¡ å­—æ®µå‘½åæ˜¯å¦ç¬¦åˆç°æœ‰é£æ ¼ï¼Ÿï¼ˆsnake_caseï¼‰
```

**3. API è®¾è®¡å…¼å®¹æ€§æ£€æŸ¥**
```
â–¡ è·¯ç”±æ˜¯å¦ç¬¦åˆ RESTful è§„èŒƒï¼Ÿ
â–¡ æ˜¯å¦å¤ç”¨ç°æœ‰é‰´æƒä¸­é—´ä»¶ï¼Ÿï¼ˆ@UseGuards(JwtAuthGuard)ï¼‰
â–¡ æ˜¯å¦å¤ç”¨ç°æœ‰æƒé™è£…é¥°å™¨ï¼Ÿï¼ˆ@RequirePermissions(...)ï¼‰
â–¡ å“åº”æ ¼å¼æ˜¯å¦ç»Ÿä¸€ï¼Ÿï¼ˆ{ success, data, error, meta }ï¼‰
â–¡ é”™è¯¯å¤„ç†æ˜¯å¦ä½¿ç”¨ try-catchï¼Ÿ
```

**4. å‰ç«¯é›†æˆæ£€æŸ¥**
```
â–¡ é¡µé¢è·¯ç”±æ˜¯å¦æ·»åŠ åˆ° client/src/router/index.tsï¼Ÿ
â–¡ èœå•æ˜¯å¦æ·»åŠ åˆ°ä¾§è¾¹æ é…ç½®ï¼Ÿ
â–¡ æ˜¯å¦å¤ç”¨ç°æœ‰ API è¯·æ±‚å°è£…ï¼Ÿï¼ˆclient/src/api/request.tsï¼‰
â–¡ æ˜¯å¦ä½¿ç”¨ Element Plus ç»„ä»¶ï¼Ÿï¼ˆä¸å¼•å…¥æ–° UI åº“ï¼‰
â–¡ çŠ¶æ€ç®¡ç†æ˜¯å¦ä½¿ç”¨ Piniaï¼Ÿï¼ˆä¸å¼•å…¥ Vuexï¼‰
```

**5. æµ‹è¯•è¦†ç›–æ£€æŸ¥**
```
â–¡ æ˜¯å¦ç¼–å†™å•å…ƒæµ‹è¯•ï¼Ÿï¼ˆserver/test/ï¼‰
â–¡ æµ‹è¯•è¦†ç›–ç‡æ˜¯å¦ â‰¥ 80%ï¼Ÿ
â–¡ æ˜¯å¦æµ‹è¯•æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Ÿ
â–¡ æ˜¯å¦æµ‹è¯•å¼‚å¸¸æƒ…å†µï¼Ÿ
```

#### ğŸ“‹ æ•°æ®åº“è¿ç§»ç­–ç•¥

**Phase 7-12 æ–°å¢è¡¨æ—¶çš„å…¼å®¹æ€§å¤„ç†**:

1. **Prisma Schema æ›´æ–°æ­¥éª¤**:
```bash
# 1. ä¿®æ”¹ server/src/prisma/schema.prisma
# 2. ç”Ÿæˆè¿ç§»æ–‡ä»¶
npx prisma migrate dev --name add_new_feature --schema=src/prisma/schema.prisma

# 3. ç”Ÿæˆ Prisma Client
npx prisma generate --schema=src/prisma/schema.prisma

# 4. åº”ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒ
npx prisma migrate deploy --schema=src/prisma/schema.prisma
```

2. **å‘åå…¼å®¹åŸåˆ™**:
- âœ… æ–°å¢è¡¨ï¼šç›´æ¥æ·»åŠ ï¼Œä¸å½±å“ç°æœ‰è¡¨
- âœ… æ–°å¢å­—æ®µï¼šå¿…é¡»è®¾ç½®é»˜è®¤å€¼æˆ–å…è®¸ NULL
- âŒ ä¿®æ”¹å­—æ®µç±»å‹ï¼šéœ€è¦æ•°æ®è¿ç§»è„šæœ¬
- âŒ åˆ é™¤å­—æ®µï¼šå…ˆåºŸå¼ƒï¼ˆdeprecatedï¼‰ï¼Œå†åˆ é™¤

3. **å¤–é”®çº¦æŸç­–ç•¥**:
```prisma
// âœ… æ¨èï¼šé™åˆ¶åˆ é™¤ï¼ˆä¿æŠ¤æ•°æ®ï¼‰
user      User     @relation(fields: [userId], references: [id], onDelete: Restrict)

// âœ… å¯é€‰ï¼šçº§è”åˆ é™¤ï¼ˆä»…ç”¨äºä»å±æ•°æ®ï¼‰
comments  Comment[] // åˆ é™¤æ–‡æ¡£æ—¶åŒæ—¶åˆ é™¤è¯„è®º

// âŒ ç¦æ­¢ï¼šæ— çº¦æŸï¼ˆæ•°æ®å­¤å²›é£é™©ï¼‰
userId    String   // ç¼ºå°‘ @relation
```

#### ğŸ”— å‰åç«¯é›†æˆæµ‹è¯•æ¸…å•

**æ–°åŠŸèƒ½ä¸Šçº¿å‰éªŒè¯æ­¥éª¤**:

1. **åç«¯ API æµ‹è¯•**:
```bash
# 1. è¿è¡Œå•å…ƒæµ‹è¯•
npm test

# 2. å¯åŠ¨åç«¯æœåŠ¡
npm run start:dev

# 3. ä½¿ç”¨ curl æµ‹è¯• API
curl -X POST http://localhost:3000/api/xxx \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"key": "value"}'
```

2. **å‰ç«¯é›†æˆæµ‹è¯•**:
```bash
# 1. å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨
npm run dev

# 2. æµè§ˆå™¨è®¿é—®é¡µé¢
# 3. æ‰“å¼€æµè§ˆå™¨ DevToolsï¼Œæ£€æŸ¥ï¼š
#    - Network æ ‡ç­¾ï¼šAPI è¯·æ±‚/å“åº”
#    - Console æ ‡ç­¾ï¼šæ— é”™è¯¯æ—¥å¿—
#    - Vue DevToolsï¼šçŠ¶æ€ç®¡ç†æ­£å¸¸
```

3. **ç«¯åˆ°ç«¯æµ‹è¯•**:
```
â–¡ ç™»å½• â†’ è®¿é—®æ–°åŠŸèƒ½é¡µé¢
â–¡ æ‰§è¡Œæ ¸å¿ƒæ“ä½œï¼ˆCRUDï¼‰
â–¡ éªŒè¯æƒé™æ§åˆ¶ï¼ˆæ— æƒé™ç”¨æˆ·è®¿é—®ï¼‰
â–¡ éªŒè¯æ•°æ®æŒä¹…åŒ–ï¼ˆåˆ·æ–°é¡µé¢æ•°æ®ä¸ä¸¢å¤±ï¼‰
â–¡ éªŒè¯é”™è¯¯å¤„ç†ï¼ˆç½‘ç»œå¼‚å¸¸ã€è¾“å…¥éªŒè¯ï¼‰
```

#### ğŸš¨ é›†æˆå¤±è´¥å¸¸è§é—®é¢˜æ’æŸ¥

| é—®é¢˜ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|----------|---------|
| **API 404** | è·¯ç”±æœªæ³¨å†Œ | æ£€æŸ¥ `xxx.module.ts` æ˜¯å¦å¯¼å…¥åˆ° `app.module.ts` |
| **API 401** | ç¼ºå°‘é‰´æƒ | æ·»åŠ  `@UseGuards(JwtAuthGuard)` |
| **API 403** | æƒé™ä¸è¶³ | æ£€æŸ¥ç”¨æˆ·è§’è‰²å’Œ `@RequirePermissions()` |
| **Prisma é”™è¯¯** | Schema æœªç”Ÿæˆ | è¿è¡Œ `npx prisma generate --schema=src/prisma/schema.prisma` |
| **å‰ç«¯ç™½å±** | ç»„ä»¶å¯¼å…¥é”™è¯¯ | æ£€æŸ¥æµè§ˆå™¨ Consoleï¼Œä¿®å¤ import è·¯å¾„ |
| **é¡µé¢404** | è·¯ç”±æœªé…ç½® | æ·»åŠ è·¯ç”±åˆ° `client/src/router/index.ts` |
| **è¡¨æ ¼ä¸æ˜¾ç¤º** | API å“åº”æ ¼å¼ä¸å¯¹ | ç»Ÿä¸€ä½¿ç”¨ `{ success, data, meta }` |
| **è¡¨å•éªŒè¯å¤±è´¥** | ç¼ºå°‘éªŒè¯è§„åˆ™ | ä½¿ç”¨ `class-validator` è£…é¥°å™¨ |

#### ğŸ“ ä»£ç å¤ç”¨æŒ‡å—

**æ¨èå¤ç”¨çš„ç°æœ‰ä»£ç **:

1. **å‰ç«¯ç»„ä»¶** (`client/src/components/`):
   - `PdfViewer.vue` - PDF é¢„è§ˆç»„ä»¶
   - `FileUpload.vue` - æ–‡ä»¶ä¸Šä¼ ç»„ä»¶
   - `DepartmentTreeSelect.vue` - éƒ¨é—¨æ ‘é€‰æ‹©å™¨
   - `UserSelect.vue` - ç”¨æˆ·é€‰æ‹©å™¨
   - `StatusTag.vue` - çŠ¶æ€æ ‡ç­¾ç»„ä»¶

2. **åç«¯æœåŠ¡** (`server/src/modules/`):
   - `file/file.service.ts` - MinIO æ–‡ä»¶ä¸Šä¼ æœåŠ¡
   - `user/user.service.ts` - ç”¨æˆ·æŸ¥è¯¢æœåŠ¡
   - `department/department.service.ts` - éƒ¨é—¨æ ‘æŸ¥è¯¢
   - `notification/notification.service.ts` - é€šçŸ¥å‘é€æœåŠ¡

3. **å…¬å…±å·¥å…·** (`server/src/common/`):
   - `guards/jwt-auth.guard.ts` - JWT é‰´æƒ
   - `decorators/permissions.decorator.ts` - æƒé™è£…é¥°å™¨
   - `filters/http-exception.filter.ts` - å¼‚å¸¸è¿‡æ»¤å™¨
   - `interceptors/transform.interceptor.ts` - å“åº”è½¬æ¢

**ç¤ºä¾‹ï¼šå¤ç”¨æ–‡ä»¶ä¸Šä¼ æœåŠ¡**:
```typescript
// âœ… æ­£ç¡®ï¼šå¤ç”¨ç°æœ‰æœåŠ¡
import { FileService } from '../file/file.service';

@Injectable()
export class NewFeatureService {
  constructor(private fileService: FileService) {}

  async uploadFile(file: Express.Multer.File) {
    return this.fileService.uploadToMinio(file);
  }
}

// âŒ é”™è¯¯ï¼šé‡å¤å®ç°æ–‡ä»¶ä¸Šä¼ 
async uploadFile(file: Express.Multer.File) {
  // ä¸è¦é‡æ–°å®ç° MinIO ä¸Šä¼ é€»è¾‘ï¼
}
```

---

## ğŸ¯ v10.1-10.4 ç‰ˆæœ¬ä¸šåŠ¡è§„åˆ™ç»†åŒ–ï¼ˆåŸºäºç”¨æˆ·æ·±åº¦æ²Ÿé€šï¼‰

æœ¬æ¬¡æ›´æ–°åŸºäºä¸ç”¨æˆ·çš„è¯¦ç»†ä¸šåŠ¡è§„åˆ™æ²Ÿé€šï¼Œç»†åŒ–äº†æ ¸å¿ƒæ¨¡å—çš„ä¸šåŠ¡é€»è¾‘ï¼Œç¡®ä¿ç³»ç»ŸåŠŸèƒ½ä¸å®é™…ä¸šåŠ¡å®Œå…¨å¥‘åˆï¼š

### âœ… æ ¸å¿ƒä¸šåŠ¡è§„åˆ™æ›´æ–°ï¼ˆ104 æ¡ç»†åŒ–è§„åˆ™ï¼‰

**æ–°å¢ Layer 1.1-1.2 æ ¸å¿ƒä¸šåŠ¡è§„åˆ™**ï¼ˆBR-1.1 ~ BR-1.60ï¼‰ï¼š
- âœ… æ¨¡æ¿ç®¡ç†è§„åˆ™ï¼ˆBR-1.1 ~ BR-1.4ï¼‰
- âœ… è‰ç¨¿ä¸æäº¤è§„åˆ™ï¼ˆBR-1.5 ~ BR-1.8ï¼‰
- âœ… è®°å½•ä¿ç•™è§„åˆ™ï¼ˆBR-1.9 ~ BR-1.11ï¼‰
- âœ… å·¥ä½œæµé…ç½®è§„åˆ™ï¼ˆBR-1.12 ~ BR-1.14ï¼‰
- âœ… å¹¶è¡Œå®¡æ‰¹è§„åˆ™ï¼ˆBR-1.15 ~ BR-1.18ï¼‰
- âœ… å®¡æ‰¹è¶…æ—¶è§„åˆ™ï¼ˆBR-1.19 ~ BR-1.22ï¼‰
- âœ… å®¡æ‰¹æ‹’ç»ä¸å–æ¶ˆè§„åˆ™ï¼ˆBR-1.23 ~ BR-1.26ï¼‰
- âœ… å¾…åŠä»»åŠ¡è§„åˆ™ï¼ˆBR-1.27 ~ BR-1.32ï¼‰
- âœ… æ‰¹æ¬¡è¿½æº¯è§„åˆ™ï¼ˆBR-1.33 ~ BR-1.39ï¼‰
- âœ… ä»“åº“ FIFO è§„åˆ™ï¼ˆBR-1.40 ~ BR-1.43ï¼‰
- âœ… ç‰©æ–™å¹³è¡¡è§„åˆ™ï¼ˆBR-1.44 ~ BR-1.47ï¼‰
- âœ… åº“å­˜ç›˜ç‚¹è§„åˆ™ï¼ˆBR-1.48 ~ BR-1.50ï¼‰
- âœ… ä¾›åº”å•†èµ„è´¨è§„åˆ™ï¼ˆBR-1.51 ~ BR-1.53ï¼‰
- âœ… è®¾å¤‡ç»´ä¿è§„åˆ™ï¼ˆBR-1.54 ~ BR-1.56ï¼‰
- âœ… è®¾å¤‡æ•…éšœè§„åˆ™ï¼ˆBR-1.57 ~ BR-1.60ï¼‰

**æ–°å¢è¡¥å……ä¸šåŠ¡è§„åˆ™**ï¼ˆBR-281 ~ BR-324ï¼Œå…± 44 æ¡ï¼‰ï¼š
- âœ… æ–‡æ¡£ç®¡ç†è¡¥å……è§„åˆ™ï¼ˆBR-281 ~ BR-283ï¼‰ï¼šç‰ˆæœ¬å‡çº§ã€ä½œåºŸå¤„ç†ã€å†å²ç‰ˆæœ¬æƒé™
- âœ… æ¨¡æ¿å­—æ®µç®¡ç†è§„åˆ™ï¼ˆBR-284 ~ BR-286ï¼‰ï¼šå­—æ®µæ–°å¢ã€åˆ é™¤ã€ç±»å‹ä¿®æ”¹
- âœ… ä»»åŠ¡åˆ†é…ä¸å¤„ç†è§„åˆ™ï¼ˆBR-287 ~ BR-289ï¼‰ï¼šå¤šäººå¹¶è¡Œã€å®Œæˆè§„åˆ™ã€è¶…æœŸå¤„ç†
- âœ… å®¡æ‰¹æµç¨‹è§„åˆ™ï¼ˆBR-290 ~ BR-291ï¼‰ï¼šå®¡æ‰¹äººç¼ºä½ã€å®¡æ‰¹æ’¤å›
- âœ… æƒé™ç®¡ç†è§„åˆ™ï¼ˆBR-292 ~ BR-293ï¼‰ï¼šè·¨éƒ¨é—¨æƒé™ã€å¤–éƒ¨å®¡æ ¸
- âœ… ç”Ÿäº§æ‰¹æ¬¡å·è§„åˆ™ï¼ˆBR-294ï¼‰ï¼šæ‰¹æ¬¡å·æ ¼å¼é…ç½®
- âœ… ç‰©æ–™å¹³è¡¡è§„åˆ™ï¼ˆBR-295 ~ BR-298ï¼‰ï¼šåŸºç¡€å…¬å¼ã€æŸè€—ç‡ã€è¯¯å·®èŒƒå›´ã€è¶…æ ‡å¤„ç†
- âœ… åº“å­˜ç®¡ç†è§„åˆ™ï¼ˆBR-299 ~ BR-301ï¼‰ï¼šé¢†æ–™æ‰£å‡ã€é…æ–™æ‰£å‡ã€ç›˜ç‚¹æ ¡æ­£
- âœ… è®¾å¤‡ç»´ä¿ç­‰çº§è§„åˆ™ï¼ˆBR-302 ~ BR-304ï¼‰ï¼šç­‰çº§åˆ†ç±»ã€å‘¨æœŸé…ç½®ã€å†…å®¹å±‚çº§
- âœ… æ–‡æ¡£å¼•ç”¨è§„åˆ™ï¼ˆBR-305 ~ BR-306ï¼‰ï¼šç¦æ­¢å¾ªç¯å¼•ç”¨ã€å¼•ç”¨æ·±åº¦é™åˆ¶
- âœ… æ‰¹æ¬¡å…³è”è§„åˆ™ï¼ˆBR-307 ~ BR-308ï¼‰ï¼šè‡ªåŠ¨å…³è”ã€æ‰¹æ¬¡è°ƒæ•´
- âœ… é€šçŸ¥ç³»ç»Ÿè§„åˆ™ï¼ˆBR-309 ~ BR-310ï¼‰ï¼šé€šçŸ¥ä¿ç•™ã€ä¼˜å…ˆçº§
- âœ… ç¼–å·è§„åˆ™ç³»ç»Ÿï¼ˆBR-311 ~ BR-312ï¼‰ï¼šè§„åˆ™ä¿®æ”¹ã€å¹´åº¦é‡ç½®
- âœ… æ•°æ®å¯¼å‡ºç³»ç»Ÿï¼ˆBR-313 ~ BR-315ï¼‰ï¼šå¯¼å‡ºæƒé™ã€å¯¼å‡ºæ ¼å¼ã€å¯¼å‡ºå®¡è®¡
- âœ… å›æ”¶ç«™ç³»ç»Ÿï¼ˆBR-316 ~ BR-318ï¼‰ï¼šä¿ç•™æ—¶é•¿ã€å›æ”¶ç«™æƒé™ã€æ¸…ç†é€šçŸ¥
- âœ… ç”¨æˆ·ç®¡ç†ç³»ç»Ÿï¼ˆBR-319 ~ BR-321ï¼‰ï¼šç¦»èŒå¤„ç†ã€å¯†ç ç­–ç•¥ã€æ•°æ®è½¬äº¤é€šçŸ¥
- âœ… æ“ä½œæ—¥å¿—ç³»ç»Ÿï¼ˆBR-322 ~ BR-324ï¼‰ï¼šæ—¥å¿—ä¿ç•™ç­–ç•¥ã€æŸ¥è¯¢æƒé™ã€è®°å½•å†…å®¹

### ğŸ”„ å…³é”®ä¸šåŠ¡è§„åˆ™è°ƒæ•´

| è°ƒæ•´é¡¹ | åŸè§„åˆ™ | æ–°è§„åˆ™ï¼ˆåŸºäºç”¨æˆ·ç¡®è®¤ï¼‰ | å½±å“èŒƒå›´ |
|--------|--------|------------------------|----------|
| **è®°å½•ä¿ç•™æœŸé™** | é»˜è®¤ 3 å¹´ | **é»˜è®¤ 5 å¹´** | RecordTemplate.retentionYears |
| **å®¡æ‰¹é€šè¿‡åä¿®æ”¹** | å…è®¸ï¼ˆæœ‰æƒé™æ§åˆ¶ï¼‰ | **ç¦æ­¢ä¿®æ”¹** | ç§»é™¤ MODIFY_APPROVED_RECORD æƒé™ |
| **å®¡æ‰¹è¶…æ—¶å¤„ç†** | è‡ªåŠ¨è½¬äº¤ | **ä»…é€šçŸ¥ï¼ŒåŸå®¡æ‰¹äººä»å¯å®¡æ‰¹** | WorkflowStep.escalationUserId |
| **ä¼šç­¾æ‹’ç»é€»è¾‘** | æœªæ˜ç¡® | **ä¸€äººæ‹’ç» â†’ æ‰€æœ‰å®¡æ‰¹å¤±æ•ˆ** | WorkflowStep.parallelMode |
| **ä¼šç­¾è¶…æ—¶é€»è¾‘** | æœªæ˜ç¡® | **ä¸€äººè¶…æ—¶ â†’ å…¶ä»–äººä¸èƒ½ç»§ç»­** | å·¥ä½œæµå¼•æ“ |
| **å·¥ä½œæµå–æ¶ˆ** | æœªå®šä¹‰ | **å‘èµ·äººå¯å–æ¶ˆï¼Œæ— æ¬¡æ•°é™åˆ¶** | WorkflowInstance æ–°å¢ cancel åŠŸèƒ½ |
| **FIFO å¼ºåˆ¶æ‰§è¡Œ** | å®Œå…¨å¼ºåˆ¶ | **ä¿ç•™æ‰‹åŠ¨é€‰æ‹©å¼€å…³** | SystemConfig.allowManualBatchSelection |
| **ä¸´æœŸç‰©æ–™ä¼˜å…ˆ** | ä¸´æœŸä¼˜å…ˆäº FIFO | **ä¸è¦å¤ªå¤æ‚ï¼Œä»… FIFO** | ç§»é™¤ BR-147 |
| **ä¾›åº”å•†èµ„è´¨è¿‡æœŸ** | è‡ªåŠ¨åœç”¨ + è®¢å•éš”ç¦» | **å…è®¸æ”¶è´§ï¼Œèµ„è´¨å¯åè¡¥** | Supplier.status ä¸æ”¹ä¸º inactive |
| **æ‰¹æ¬¡å·ç”Ÿæˆ** | ç³»ç»Ÿç”Ÿæˆ | **åŸæ–™æ‰¹æ¬¡ä¼˜å…ˆç”¨ä¾›åº”å•†æ‰¹æ¬¡å·** | MaterialBatch ç”Ÿæˆé€»è¾‘ |
| **è¿½æº¯å“åº”æ—¶é—´** | 4 å°æ—¶ï¼ˆBRCGS è¦æ±‚ï¼‰ | **å®æ—¶å“åº”ï¼ˆç«‹å³æ˜¾ç¤ºï¼‰** | æ‰¹æ¬¡è¿½æº¯ API æ€§èƒ½è¦æ±‚ |
| **å¾…åŠä¼˜å…ˆçº§** | é»˜è®¤æœ‰ç´§æ€¥/é«˜/ä¸­/ä½ | **é»˜è®¤æ— ä¼˜å…ˆçº§åŒºåˆ†** | TodoTask.priority å¯é€‰ |
| **è®¾å¤‡æ•…éšœåˆ†çº§** | ç´§æ€¥/æ™®é€š | **æ— åˆ†çº§ï¼Œç»Ÿä¸€å¤„ç†** | è®¾å¤‡æŠ¥ä¿®æµç¨‹ |

### ğŸ“ ~~å¾…æ˜ç¡®ç»†èŠ‚~~ âœ… å·²å…¨éƒ¨ç¡®è®¤ï¼ˆ2026-02-13ï¼‰

~~ä»¥ä¸‹ç»†èŠ‚ç”¨æˆ·è¡¨ç¤ºç¨åç¡®è®¤ï¼Œæš‚ä¸å®æ–½~~
**æ›´æ–°**: æ‰€æœ‰ç»†èŠ‚å·²åœ¨ 2026-02-13 ä¸ç”¨æˆ·ç¡®è®¤å®Œæˆï¼Œè¯¦è§ BR-281 ~ BR-324

| é¡¹ç›® | çŠ¶æ€ | æœ€ç»ˆç¡®è®¤ç»“æœ | è§„åˆ™ç¼–å· |
|------|------|-------------|---------|
| **æ–‡æ¡£ç‰ˆæœ¬å‡çº§** | âœ… å·²ç¡®è®¤ | 1.0 â†’ 1.1 â†’ 1.9 â†’ 2.0ï¼Œç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ | BR-281 |
| **æ–‡æ¡£ä½œåºŸåä»»åŠ¡** | âœ… å·²ç¡®è®¤ | å…è®¸ç»§ç»­ï¼Œæ ‡è®°æ–‡æ¡£å·²ä½œåºŸ | BR-282 |
| **å†å²ç‰ˆæœ¬æƒé™** | âœ… å·²ç¡®è®¤ | ä»…åˆ›å»ºè€…å’Œç®¡ç†å‘˜å¯æŸ¥çœ‹ | BR-283 |
| **æ¨¡æ¿å­—æ®µä¿®æ”¹** | âœ… å·²ç¡®è®¤ | æ–°å¢å­—æ®µä½œä¸ºæ–°ç‰ˆæœ¬ï¼Œåˆ é™¤å­—æ®µå†å²ä¿ç•™ï¼Œå…è®¸ä¿®æ”¹ç±»å‹ | BR-284~286 |
| **ä»»åŠ¡åˆ†é…** | âœ… å·²ç¡®è®¤ | å¤šäººå¹¶è¡Œï¼Œä¸€äººæäº¤å³å®Œæˆ | BR-287~288 |
| **ä»»åŠ¡è¶…æœŸå¤„ç†** | âœ… å·²ç¡®è®¤ | ä¸€ç›´ä¿æŒå¾…åŠçŠ¶æ€ | BR-289 |
| **å®¡æ‰¹äººç¼ºä½** | âœ… å·²ç¡®è®¤ | ä¸Šçº§ä»£å®¡ï¼Œæœ€ç»ˆç®¡ç†å‘˜ | BR-290 |
| **å®¡æ‰¹æ’¤å›** | âœ… å·²ç¡®è®¤ | ä¸å…è®¸æ’¤å› | BR-291 |
| **è·¨éƒ¨é—¨æƒé™** | âœ… å·²ç¡®è®¤ | æŒ‰è§’è‰²/ç®¡ç†å±‚çº§ | BR-292 |
| **å¤–éƒ¨å®¡æ ¸** | âœ… å·²ç¡®è®¤ | ä»…æä¾›æ•°æ®å¯¼å‡ºï¼Œä¸ç»™ç³»ç»Ÿè®¿é—® | BR-293 |
| **ç”Ÿäº§æ‰¹æ¬¡å·æ ¼å¼** | âœ… å·²ç¡®è®¤ | äº§å“ç¼©å†™+å¹´æœˆæ—¥+ç­æ¬¡ï¼Œæ”¯æŒçµæ´»é…ç½® | BR-294 |
| **ç‰©æ–™å¹³è¡¡å…¬å¼** | âœ… å·²ç¡®è®¤ | æŠ•å…¥=äº§å‡º+æŸè€—ï¼Œæ¶²ä½“3%/å›ºä½“2%/è´µé‡1% | BR-295~298 |
| **åº“å­˜æ›´æ–°æ—¶æœº** | âœ… å·²ç¡®è®¤ | é¢†æ–™å³æ—¶æ‰£å‡ï¼Œæ¯æ—¥ç›˜ç‚¹æ ¡æ­£ | BR-299~301 |
| **ç»´ä¿ç­‰çº§å†…å®¹** | âœ… å·²ç¡®è®¤ | ä¸€çº§/äºŒçº§/ä¸‰çº§ï¼Œå†…å®¹ä»ç²—åˆ°ç»†ï¼Œå‘¨æœŸçµæ´»é…ç½® | BR-302~304 |
| **æ–‡æ¡£å¼•ç”¨æ·±åº¦** | âœ… å·²ç¡®è®¤ | ç¦æ­¢å¾ªç¯å¼•ç”¨ï¼Œç®€åŒ–å¼•ç”¨å…³ç³»ï¼ˆä¸€å±‚ï¼‰ | BR-305~306 |
| **æ‰¹æ¬¡è‡ªåŠ¨å…³è”æ—¶æœº** | âœ… å·²ç¡®è®¤ | FIFOè‡ªåŠ¨åŒ¹é…ï¼Œç”¨æˆ·ç¡®è®¤åå¯è°ƒæ•´ | BR-307~308 |
| **é€šçŸ¥ä¿ç•™æ—¶é•¿** | âœ… å·²ç¡®è®¤ | å·²è¯»ä¿ç•™30å¤©ï¼Œæœªè¯»æ°¸ä¹…ä¿ç•™ï¼Œä¸åŒºåˆ†ä¼˜å…ˆçº§ | BR-309~310 |
| **ç¼–å·è§„åˆ™ä¿®æ”¹** | âœ… å·²ç¡®è®¤ | å·²ä½¿ç”¨ä¸å…è®¸ä¿®æ”¹å…³é”®å­—æ®µï¼Œæ”¯æŒå¹´åº¦é‡ç½® | BR-311~312 |
| **æ•°æ®å¯¼å‡º** | âœ… å·²ç¡®è®¤ | ä¸éœ€è¦å®¡æ‰¹ï¼Œæ”¯æŒExcel/PDFï¼Œå¿…é¡»å®¡è®¡ | BR-313~315 |
| **å›æ”¶ç«™** | âœ… å·²ç¡®è®¤ | ä¿ç•™30å¤©ï¼Œä»…åˆ é™¤äººå’Œç®¡ç†å‘˜å¯è§ï¼Œå¤šé˜¶æ®µé€šçŸ¥ | BR-316~318 |
| **ç”¨æˆ·ç¦»èŒ** | âœ… å·²ç¡®è®¤ | æ•°æ®è‡ªåŠ¨è½¬äº¤ä¸Šçº§ï¼Œå¯†ç é”™è¯¯5æ¬¡é”å®š1åˆ†é’Ÿ | BR-319~321 |
| **æ“ä½œæ—¥å¿—** | âœ… å·²ç¡®è®¤ | åˆ†çº§ä¿ç•™ï¼ˆå…³é”®æ°¸ä¹…/æ™®é€š90å¤©/ä½ä»·å€¼30å¤©ï¼‰ | BR-322~324 |

### ğŸš¨ é‡è¦æé†’

ç”¨æˆ·åé¦ˆå‘ç°**å†å²è®¨è®ºå†…å®¹ä¸¢å¤±**é—®é¢˜ï¼š
- "åŸ¹è®­è®¡åˆ’çš„åˆ›å»ºæµç¨‹ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¹‹å‰åœ¨èŠæ¯ä¸€ä¸ªæ¨¡å—åŠŸèƒ½çš„æ—¶å€™éƒ½å·²ç»è¯´è¿‡äº†å§ï¼Ÿ"
- "æˆ‘ä»¬ä»Šå¤©æ¢è®¨çš„ç³»ç»ŸåŠŸèƒ½çš„ç»†èŠ‚éœ€æ±‚ç»†èŠ‚éƒ½è¢«åˆ æ‰äº†å—ï¼Ÿ"
- "æ€ä¹ˆä½ é—®çš„å¾ˆå¤šé—®é¢˜éƒ½æ˜¯ä¹‹å‰èŠè¿‡çš„"

**è¡ŒåŠ¨**: æœ¬æ¬¡æ›´æ–°å·²å°†ç”¨æˆ·æœ¬æ¬¡æä¾›çš„æ‰€æœ‰ä¸šåŠ¡è§„åˆ™å®Œæ•´è®°å½•åˆ°æ–‡æ¡£ä¸­ï¼ˆBR-1.1 ~ BR-1.60ï¼‰ï¼Œç¡®ä¿ä¸å†ä¸¢å¤±ã€‚

---

## ğŸ—ï¸ v10.0 ç‰ˆæœ¬é‡å¤§æ¶æ„å‡çº§

æœ¬æ¬¡æ›´æ–°ä»**è‡ªåº•å‘ä¸Š**é‡æ„æ•´ä¸ªç³»ç»Ÿæ¶æ„ï¼Œè§£å†³ä¹‹å‰"ä¸œè®²ä¸€ä¸ªè¥¿è®²ä¸€ä¸ª"çš„é—®é¢˜ï¼š

### âœ… æ ¸å¿ƒæ”¹è¿›

1. **æ˜ç¡®åˆ†å±‚æ¶æ„**ï¼ˆ5 å±‚ä»åº•å±‚åˆ°é¡¶å±‚ï¼‰
2. **æ ¸å¿ƒå¼•æ“å®Œæ•´å®šä¹‰**ï¼ˆå·¥ä½œæµå¼•æ“ + åŠ¨æ€è¡¨å•å¼•æ“ + æ–‡æ¡£å¼•æ“ï¼‰
3. **ä¾èµ–å…³ç³»æ¸…æ™°æ ‡æ³¨**ï¼ˆæ¯ä¸ªæ¨¡å—æ˜ç¡®ä¾èµ–å“ªäº›åº•å±‚èƒ½åŠ›ï¼‰
4. **æ¥å£å®šä¹‰å®Œæ•´**ï¼ˆTypeScript ç±»å‹å®šä¹‰ + API ç¤ºä¾‹ + ä¸šåŠ¡è§„åˆ™ï¼‰
5. **ä¿®å¤ 8 ä¸ªæ–° P0 é—®é¢˜**ï¼ˆå·¥ä½œæµé›†æˆã€æƒé™ç»†ç²’åº¦ã€è¶…æ—¶å‡çº§ç­‰ï¼‰

### ğŸ“Š ç³»ç»Ÿåˆ†å±‚æ¶æ„ï¼ˆè‡ªåº•å‘ä¸Šï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 4: ç§»åŠ¨ç«¯ä¸è¿ç»´å±‚                                          â”‚
â”‚  - ç§»åŠ¨ç«¯åº”ç”¨ï¼ˆuniappï¼‰                                          â”‚
â”‚  - ç³»ç»Ÿè¿ç»´ç›‘æ§ï¼ˆPrometheus + Grafanaï¼‰                         â”‚
â”‚  - å®¡è®¡æ—¥å¿—ä¸åˆè§„                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–²
                              â”‚ ä¾èµ–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 3: ä½“ç³»ç®¡ç†æ¨¡å—                                            â”‚
â”‚  - åŸ¹è®­ç®¡ç†ï¼ˆä¾èµ–ï¼šåŠ¨æ€è¡¨å• + å·¥ä½œæµ + å¾…åŠï¼‰                   â”‚
â”‚  - å†…å®¡ç®¡ç†ï¼ˆä¾èµ–ï¼šåŠ¨æ€è¡¨å• + å·¥ä½œæµ + æ–‡æ¡£å¼•æ“ï¼‰               â”‚
â”‚  - ä¾›åº”å•†ç®¡ç†ï¼ˆä¾èµ–ï¼šæƒé™ç³»ç»Ÿ + å¾…åŠï¼‰                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–²
                              â”‚ ä¾èµ–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 2: æ ¸å¿ƒç”Ÿäº§æµç¨‹                                            â”‚
â”‚  - æ‰¹æ¬¡è¿½æº¯ç³»ç»Ÿï¼ˆä¾èµ–ï¼šåŠ¨æ€è¡¨å•ï¼‰                               â”‚
â”‚  - ä»“åº“ç®¡ç†ï¼ˆä¾èµ–ï¼šæ‰¹æ¬¡è¿½æº¯ + å·¥ä½œæµ + åŠ¨æ€è¡¨å•ï¼‰               â”‚
â”‚  - è®¾å¤‡ç®¡ç†ï¼ˆä¾èµ–ï¼šåŠ¨æ€è¡¨å• + å¾…åŠï¼‰                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–²
                              â”‚ ä¾èµ–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 1: é€šç”¨å¼•æ“å±‚ â­ æ ¸å¿ƒèƒ½åŠ›å±‚                               â”‚
â”‚  - åŠ¨æ€è¡¨å•å¼•æ“ï¼ˆ20+ å­—æ®µç±»å‹ï¼Œå®Œæ•´å®šä¹‰ï¼‰                      â”‚
â”‚  - å·¥ä½œæµå¼•æ“ï¼ˆå®¡æ‰¹æµç¨‹ï¼Œè¶…æ—¶å‡çº§ï¼Œå®Œæ•´å®šä¹‰ï¼‰                  â”‚
â”‚  - æ™ºèƒ½æ–‡æ¡£å¼•æ“ï¼ˆæ–‡æ¡£å¼•ç”¨ï¼Œè‡ªåŠ¨åŒæ­¥ï¼‰                          â”‚
â”‚  - å¾…åŠä»»åŠ¡ç³»ç»Ÿï¼ˆç»Ÿä¸€å¾…åŠï¼Œä¼˜å…ˆçº§ç®¡ç†ï¼‰                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–²
                              â”‚ ä¾èµ–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 0: æ•°æ®åŸºç¡€è®¾æ–½å±‚                                          â”‚
â”‚  - ç”¨æˆ·ä¸ç»„ç»‡æ¶æ„ï¼ˆUser + Departmentï¼‰                          â”‚
â”‚  - æƒé™ç®¡ç†ç³»ç»Ÿï¼ˆPermission + RBACï¼‰                            â”‚
â”‚  - æ–‡æ¡£åˆ†çº§ä½“ç³»ï¼ˆDocument 1-4 çº§ï¼‰                              â”‚
â”‚  - ç¼–å·è§„åˆ™å¼•æ“ï¼ˆNumberRuleï¼‰                                   â”‚
â”‚  - æ–‡ä»¶å­˜å‚¨ï¼ˆMinIOï¼‰                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ”¥ 8 ä¸ªæ–° P0 é—®é¢˜ä¿®å¤

| é—®é¢˜ | æè¿° | çŠ¶æ€ |
|------|------|------|
| **P0-1** | å·¥ä½œæµä¸åç¦»æ£€æµ‹é›†æˆæ¥å£ä¸æ˜ç¡® | âœ… å·²å®šä¹‰å®Œæ•´ JSON é…ç½®ç¤ºä¾‹ |
| **P0-2** | æ‰¹æ¬¡è¿½æº¯å¤–é”®çº¦æŸç­–ç•¥æ··ä¹± | âœ… ç»Ÿä¸€ onDelete: Restrict |
| **P0-3** | æƒé™ç®¡ç†æ— ç»†ç²’åº¦æ§åˆ¶ | âœ… å®šä¹‰ RBAC + èµ„æºçº§æƒé™ |
| **P0-4** | å®¡æ‰¹è¶…æ—¶å‡çº§æœºåˆ¶ä¸å®Œæ•´ | âœ… å®šä¹‰è‡ªåŠ¨è½¬äº¤ + å¤šçº§å‡çº§ |
| **P0-5** | è®°å½•ä¿ç•™æœŸé™ç¼ºä¹æ‰§è¡Œæœºåˆ¶ | âœ… å®šä¹‰å®šæ—¶ä»»åŠ¡ + å½’æ¡£ç­–ç•¥ |
| **P0-6** | ä¾›åº”å•†èµ„è´¨åˆ°æœŸç¼ºä¹è‡ªåŠ¨å¤„ç† | âœ… å®šä¹‰æ¯æ—¥æ£€æŸ¥ + åœ¨é€”è®¢å•å¤„ç† |
| **P0-7** | åŠ¨æ€è¡¨å•ä¸ç¡¬ç¼–ç å­—æ®µå†²çª | âœ… æ˜ç¡®æ ¸å¿ƒå­—æ®µ vs æ‰©å±•å­—æ®µ |
| **P0-8** | æ–‡æ¡£å¼•ç”¨å¾ªç¯ä¾èµ–é£é™© | âœ… é™åˆ¶å¼•ç”¨æ·±åº¦ + å¼‚æ­¥é˜Ÿåˆ— |

---

## ğŸ”¥ v9.2 ç‰ˆæœ¬æ›´æ–°è¯´æ˜ï¼ˆP0 ä¿®å¤ï¼‰

æœ¬æ¬¡æ›´æ–°ä¿®å¤äº†æ·±åº¦ä¸šåŠ¡é€»è¾‘å®¡æŸ¥å‘ç°çš„ **6 ä¸ª P0 çº§åˆ«ä¸šåŠ¡é€»è¾‘ç¡¬ä¼¤**ï¼Œç¡®ä¿ç³»ç»ŸåŠŸèƒ½é—­ç¯å®Œæ•´ï¼š

### P0-1: æ–‡æ¡£å½’æ¡£/ä½œåºŸæµç¨‹ âœ… å·²ä¿®å¤
- **é—®é¢˜**: Document è¡¨åªæœ‰ `current` çŠ¶æ€ï¼Œç¼ºå°‘ `archived`/`obsolete` çŠ¶æ€ï¼Œæ— æ³•æ»¡è¶³ BRCGS æ–‡æ¡£ä½œåºŸè¦æ±‚
- **ä¿®å¤**: Document è¡¨æ·»åŠ  6 ä¸ªå­—æ®µï¼šarchive_reason, archived_at, archived_by, obsolete_reason, obsoleted_at, obsoleted_by
- **å½±å“ç« èŠ‚**: ä¸ƒã€æ•°æ®æ¨¡å‹ï¼ˆç¬¬ 460 è¡Œï¼‰

### P0-2: æ‰¹æ¬¡è¿½æº¯é“¾æ¡æ–­è£‚é£é™© âœ… å·²ä¿®å¤
- **é—®é¢˜**: BatchMaterialUsage å¯èƒ½ç¼ºå°‘å¤–é”®çº¦æŸï¼Œè¿½æº¯é“¾æ¡å­˜åœ¨æ–­è£‚é£é™©
- **ä¿®å¤**: ç¡®è®¤å¹¶å¼ºåŒ–å¤–é”®çº¦æŸ `onDelete: Restrict`ï¼Œæ›´æ–°ä¸šåŠ¡è§„åˆ™ BR-243 å’Œ BR-245
- **å½±å“ç« èŠ‚**: åä¹ç« è¡¥å……ï¼ˆæ‰¹æ¬¡è¿½æº¯ç³»ç»Ÿï¼Œç¬¬ 8921-8922 è¡Œï¼Œç¬¬ 9116-9117 è¡Œï¼‰

### P0-3: è·¨éƒ¨é—¨åä½œæƒé™ç¼ºå¤± âœ… å·²ä¿®å¤
- **é—®é¢˜**: è´¨é‡éƒ¨éœ€è¦æŸ¥çœ‹æ‰€æœ‰è®°å½•ä½†å½“å‰åªæœ‰éƒ¨é—¨çº§æƒé™ï¼Œæ— æ³•è·¨éƒ¨é—¨åä½œ
- **ä¿®å¤**: æ–°å¢ permissions è¡¨ã€user_permissions è¡¨ï¼Œæ·»åŠ ä¸šåŠ¡è§„åˆ™ BR-017/018/019ï¼ˆviewAllRecords æƒé™ï¼‰
- **å½±å“ç« èŠ‚**: ä¸ƒã€æ•°æ®æ¨¡å‹ï¼ˆç¬¬ 437-458 è¡Œï¼‰ã€äº”ã€ä¸šåŠ¡è§„åˆ™ï¼ˆç¬¬ 361-363 è¡Œï¼‰

### P0-4: å®¡æ‰¹è¶…æ—¶æœºåˆ¶ç¼ºå¤± âœ… å·²ä¿®å¤
- **é—®é¢˜**: å®¡æ‰¹æµç¨‹æ— è¶…æ—¶è‡ªåŠ¨å‡çº§/æé†’æœºåˆ¶ï¼Œå¯èƒ½æ— é™æœŸå¡ä½
- **ä¿®å¤**: WorkflowTask è¡¨æ·»åŠ  timeoutHoursã€escalationUserIdã€isOverdueã€overdueNotifiedAt å­—æ®µï¼Œæ·»åŠ ä¸šåŠ¡è§„åˆ™ BR-091~094
- **å½±å“ç« èŠ‚**: åå››ã€å·¥ä½œæµç³»ç»Ÿï¼ˆç¬¬ 3327-3343 è¡Œï¼Œç¬¬ 4039-4065 è¡Œï¼‰ã€ä¸šåŠ¡è§„åˆ™ï¼ˆç¬¬ 3970-3973 è¡Œï¼‰

### P0-5: è®°å½•ä¿ç•™æœŸé™ç®¡ç†ç¼ºå¤± âœ… å·²ä¿®å¤
- **é—®é¢˜**: BRCGS è¦æ±‚ä¸åŒè®°å½•ä¿ç•™æœŸé™ä¸åŒï¼ˆå¦‚æŠ•è¯‰ 5 å¹´ï¼‰ï¼Œä½†æ— è‡ªåŠ¨ç®¡ç†
- **ä¿®å¤**: RecordTemplate æ·»åŠ  retentionYears å­—æ®µï¼ŒRecord æ·»åŠ  retentionUntilã€autoArchiveStatus å­—æ®µï¼Œæ·»åŠ ä¸šåŠ¡è§„åˆ™ BR-261~265
- **å½±å“ç« èŠ‚**: åä¹ã€åŠ¨æ€è¡¨å•å¼•æ“ï¼ˆç¬¬ 7326-7396 è¡Œï¼‰ã€ä¸šåŠ¡è§„åˆ™ï¼ˆç¬¬ 8526-8536 è¡Œï¼‰

### P0-6: ä¾›åº”å•†èµ„è´¨åˆ°æœŸè‡ªåŠ¨å¤„ç†ç¼ºå¤± âœ… å·²ä¿®å¤
- **é—®é¢˜**: ä¾›åº”å•†èµ„è´¨åˆ°æœŸåçŠ¶æ€ä¸è‡ªåŠ¨æ›´æ–°ï¼Œéœ€äººå·¥æ£€æŸ¥ï¼Œå¯èƒ½ä½¿ç”¨æœªåˆæ ¼ä¾›åº”å•†
- **ä¿®å¤**: æ·»åŠ ä¸šåŠ¡è§„åˆ™ BR-181~185ï¼ˆè‡ªåŠ¨è¿‡æœŸæ£€æŸ¥ã€ä¸´æœŸé¢„è­¦ã€è¿‡æœŸè‡ªåŠ¨åœç”¨ï¼‰
- **å½±å“ç« èŠ‚**: åä¸ƒã€ä»“åº“ç®¡ç†ç³»ç»Ÿï¼ˆç¬¬ 6228-6242 è¡Œï¼‰

---

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„å®šä¹‰ï¼ˆv10.0 æ–°å¢ï¼‰

> **é‡è¦**: æœ¬ç« èŠ‚æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ¶æ„è“å›¾ï¼Œå®šä¹‰äº†å„å±‚çº§çš„èŒè´£ã€æ¥å£å’Œä¾èµ–å…³ç³»ã€‚
> **é˜…è¯»å»ºè®®**: ä» Layer 0 å¼€å§‹ï¼Œè‡ªåº•å‘ä¸Šç†è§£ç³»ç»Ÿæ¶æ„ã€‚

---

### æ¶æ„æ€»è§ˆï¼š5 å±‚åˆ†å±‚è®¾è®¡

| å±‚çº§ | åç§° | æ ¸å¿ƒèŒè´£ | å…³é”®æ¨¡å— |
|------|------|----------|----------|
| **Layer 0** | æ•°æ®åŸºç¡€è®¾æ–½å±‚ | ç”¨æˆ·ã€æƒé™ã€æ–‡æ¡£ä½“ç³»ã€å­˜å‚¨ | User, Department, Permission, Document, MinIO |
| **Layer 1** | é€šç”¨å¼•æ“å±‚ | å·¥ä½œæµã€åŠ¨æ€è¡¨å•ã€æ–‡æ¡£å¼•æ“ã€å¾…åŠ | WorkflowEngine, FormEngine, DocumentEngine, TodoTask |
| **Layer 2** | æ ¸å¿ƒç”Ÿäº§æµç¨‹ | æ‰¹æ¬¡è¿½æº¯ã€ä»“åº“ã€è®¾å¤‡ç®¡ç† | BatchTraceability, Warehouse, Equipment |
| **Layer 3** | ä½“ç³»ç®¡ç†æ¨¡å— | åŸ¹è®­ã€å†…å®¡ã€ä¾›åº”å•†ç®¡ç† | Training, Audit, Supplier |
| **Layer 4** | ç§»åŠ¨ç«¯ä¸è¿ç»´ | ç§»åŠ¨åº”ç”¨ã€ç›‘æ§ã€å®¡è®¡ | UniApp, Prometheus, AuditLog |

---

### Layer 0: æ•°æ®åŸºç¡€è®¾æ–½å±‚ï¼ˆæœ€åº•å±‚ï¼‰

**å®šä½**: æä¾›æœ€åŸºç¡€çš„æ•°æ®æ¨¡å‹å’Œèƒ½åŠ›ï¼Œè¢«æ‰€æœ‰ä¸Šå±‚æ¨¡å—ä¾èµ–ã€‚

#### 0.1 ç”¨æˆ·ä¸ç»„ç»‡æ¶æ„

**æ ¸å¿ƒè¡¨**:
```prisma
model User {
  id              String   @id @default(cuid())
  username        String   @unique
  password        String   // bcrypt åŠ å¯†
  name            String
  departmentId    String
  role            String   @default("user")  // user | leader | admin
  status          String   @default("active")

  department      Department @relation(fields: [departmentId], references: [id])
  permissions     UserPermission[]
}

model Department {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  parentId    String?

  users       User[]
  children    Department[] @relation("DepartmentHierarchy")
  parent      Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id])
}
```

#### 0.2 æƒé™ç®¡ç†ç³»ç»Ÿï¼ˆRBAC + èµ„æºçº§æƒé™ï¼‰

**ä¿®å¤ P0-3**: ç»†ç²’åº¦æƒé™æ§åˆ¶

```prisma
model Permission {
  id          String   @id @default(cuid())
  code        String   @unique  // å¦‚: "viewRecords:production"
  name        String
  category    String              // document | record | approval | system
  scope       String   @default("department")  // department | all | custom

  users       UserPermission[]
}

model UserPermission {
  id            String   @id @default(cuid())
  userId        String
  permissionId  String
  grantedBy     String
  grantedAt     DateTime @default(now())

  // èµ„æºçº§æƒé™ï¼ˆå¯é€‰ï¼‰
  resourceType  String?  // å¦‚: "record"
  resourceId    String?  // å¦‚: ç‰¹å®šè®°å½• ID

  user          User       @relation(fields: [userId], references: [id])
  permission    Permission @relation(fields: [permissionId], references: [id])

  @@unique([userId, permissionId])
}
```

**æƒé™å®šä¹‰ç¤ºä¾‹**:
```typescript
// ç³»ç»Ÿé¢„å®šä¹‰æƒé™
const SYSTEM_PERMISSIONS = [
  { code: "viewRecords:own", name: "æŸ¥çœ‹æœ¬äººåˆ›å»ºçš„è®°å½•", scope: "user" },
  { code: "viewRecords:department", name: "æŸ¥çœ‹æœ¬éƒ¨é—¨è®°å½•", scope: "department" },
  { code: "viewRecords:production", name: "æŸ¥çœ‹ç”Ÿäº§éƒ¨è®°å½•", scope: "custom" },
  { code: "viewRecords:quality", name: "æŸ¥çœ‹è´¨é‡éƒ¨è®°å½•", scope: "custom" },
  { code: "viewRecords:all", name: "æŸ¥çœ‹æ‰€æœ‰éƒ¨é—¨è®°å½•", scope: "all" },  // ä»…ç®¡ç†å±‚
  { code: "modifyApprovedRecord", name: "ä¿®æ”¹å·²å®¡æ‰¹è®°å½•", scope: "all" }   // è´¨é‡éƒ¨+ç®¡ç†å±‚
]

// æƒé™æ£€æŸ¥å‡½æ•°
async function checkPermission(userId: string, permissionCode: string, resourceId?: string): Promise<boolean> {
  const userPermission = await prisma.userPermission.findFirst({
    where: {
      userId,
      permission: { code: permissionCode },
      OR: [
        { resourceId: null },        // å…¨å±€æƒé™
        { resourceId }               // èµ„æºçº§æƒé™
      ]
    },
    include: { permission: true }
  })

  return !!userPermission
}
```

#### 0.3 æ–‡æ¡£åˆ†çº§ä½“ç³»ï¼ˆ1-4 çº§ï¼‰

**æ ¸å¿ƒè¡¨**:
```prisma
model Document {
  id          String   @id @default(cuid())
  level       Int                          // 1/2/3/4
  number      String   @unique
  title       String
  content     Json?                        // Tiptap JSONï¼ˆä¸‰çº§æ–‡ä»¶ï¼‰
  filePath    String?                      // MinIO è·¯å¾„ï¼ˆä¸€äºŒçº§æ–‡ä»¶ï¼‰
  version     Decimal  @default(1.0)
  status      String                       // draft | under_review | approved | current | archived | obsolete

  // P0-1 ä¿®å¤ï¼šå½’æ¡£/ä½œåºŸæµç¨‹
  archiveReason   String?
  archivedAt      DateTime?
  archivedBy      String?
  obsoleteReason  String?
  obsoletedAt     DateTime?
  obsoletedBy     String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
```

#### 0.4 ç¼–å·è§„åˆ™å¼•æ“

**æ ¸å¿ƒè¡¨**:
```prisma
model NumberRule {
  id              String   @id @default(cuid())
  level           Int                      // 1/2/3/4 çº§æ–‡ä»¶
  departmentId    String
  prefix          String                   // å‰ç¼€ï¼ˆå¦‚ "QP-"ï¼‰
  sequence        Int      @default(0)     // å½“å‰åºå·
  format          String                   // æ ¼å¼ï¼ˆå¦‚ "{prefix}-{department}-{åºå·}"ï¼‰

  department      Department @relation(fields: [departmentId], references: [id])
}
```

**ç¼–å·ç”Ÿæˆé€»è¾‘**:
```typescript
async function generateDocumentNumber(level: number, departmentId: string): Promise<string> {
  const rule = await prisma.numberRule.findFirst({
    where: { level, departmentId },
    include: { department: true }
  })

  if (!rule) {
    throw new Error('æœªé…ç½®ç¼–å·è§„åˆ™')
  }

  // åŸå­é€’å¢åºå·
  const updated = await prisma.numberRule.update({
    where: { id: rule.id },
    data: { sequence: { increment: 1 } }
  })

  // æ ¼å¼åŒ–ç¼–å·
  return rule.format
    .replace('{prefix}', rule.prefix)
    .replace('{department}', rule.department.code)
    .replace('{åºå·}', String(updated.sequence).padStart(3, '0'))
}
```

---

### Layer 1: é€šç”¨å¼•æ“å±‚ï¼ˆæ ¸å¿ƒèƒ½åŠ›ï¼‰â­

**å®šä½**: æä¾›å¯å¤ç”¨çš„æ ¸å¿ƒå¼•æ“ï¼Œæ”¯æ’‘æ‰€æœ‰ä¸šåŠ¡æ¨¡å—ã€‚

#### 1.1 å·¥ä½œæµå¼•æ“ï¼ˆå®Œæ•´å®šä¹‰ï¼‰

**ä¿®å¤ P0-1 + P0-4**: å·¥ä½œæµé›†æˆæ¥å£ + è¶…æ—¶å‡çº§æœºåˆ¶

**æ ¸å¿ƒè¡¨**:
```prisma
model WorkflowTemplate {
  id            String   @id @default(cuid())
  code          String   @unique          // æ¨¡æ¿ä»£ç ï¼ˆå¦‚ "equipment-maintenance-approval"ï¼‰
  name          String
  departmentId  String
  steps         Json                       // æ­¥éª¤é…ç½®ï¼ˆè¯¦è§ä¸‹æ–¹ï¼‰
  version       Int      @default(1)
  status        String   @default("active")

  instances     WorkflowInstance[]
}

model WorkflowInstance {
  id           String   @id @default(cuid())
  templateId   String
  currentStep  Int      @default(1)
  status       String   @default("running")  // running | completed | rejected

  // å…³è”èµ„æºï¼ˆé€šç”¨ï¼‰
  relatedType  String?                      // "record" | "document" | "requisition"
  relatedId    String?                      // å…³è”èµ„æº ID

  initiatorId  String
  startedAt    DateTime @default(now())
  completedAt  DateTime?

  template     WorkflowTemplate @relation(fields: [templateId], references: [id])
  tasks        WorkflowTask[]
}

model WorkflowTask {
  id          String   @id @default(cuid())
  instanceId  String
  stepOrder   Int
  stepName    String
  assigneeId  String
  status      String   @default("pending")
  action      String?                      // approved | rejected
  comment     String?
  completedAt DateTime?

  // P0-4 ä¿®å¤ï¼šè¶…æ—¶å‡çº§æœºåˆ¶
  timeoutHours      Int      @default(24)
  escalationUserId  String?                // è¶…æ—¶å‡çº§åˆ°çš„ç”¨æˆ·
  isOverdue         Boolean  @default(false)
  overdueNotifiedAt DateTime?

  instance    WorkflowInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([assigneeId, status])
  @@index([isOverdue, status])
}
```

**å·¥ä½œæµæ­¥éª¤é…ç½®ï¼ˆJSON Schemaï¼‰**:
```typescript
interface WorkflowStep {
  order: number
  name: string
  type: 'approval' | 'parallel'          // å•äººå®¡æ‰¹ | å¹¶è¡Œä¼šç­¾
  approvers: string[]                    // å®¡æ‰¹äºº ID åˆ—è¡¨
  timeoutHours?: number                  // è¶…æ—¶æ—¶é•¿ï¼ˆé»˜è®¤ 24ï¼Œä»ä»»åŠ¡åˆ›å»ºæ—¶é—´ç®—èµ·ï¼Œå‘¨æœ«/èŠ‚å‡æ—¥ä¸è®¡å…¥ï¼‰
  escalationUserId?: string              // è¶…æ—¶å‡çº§ç”¨æˆ·ï¼ˆè¶…æ—¶ååŸå®¡æ‰¹äººä»å¯å®¡æ‰¹ï¼‰
  parallelMode?: 'all' | 'any'           // å¹¶è¡Œæ¨¡å¼ï¼šall=ä¼šç­¾(å…¨éƒ¨é€šè¿‡) | any=æˆ–ç­¾(ä»»ä¸€é€šè¿‡)

  // ç”¨æˆ·ä¸šåŠ¡è§„åˆ™è¡¥å……ï¼š
  // 1. ä¼šç­¾æ¨¡å¼(all)ï¼šä¸€äººæ‹’ç» â†’ å…¶ä»–æ‰€æœ‰å®¡æ‰¹å¤±æ•ˆ â†’ é€€å›å‘èµ·äºº
  // 2. ä¼šç­¾æ¨¡å¼(all)ï¼šä¸€äººè¶…æ—¶ â†’ å…¶ä»–äººä¸èƒ½ç»§ç»­å®¡æ‰¹ â†’ ç­‰å¾…è¶…æ—¶å¤„ç†
  // 3. æˆ–ç­¾æ¨¡å¼(any)ï¼šä»»ä¸€äººé€šè¿‡å³å¯è¿›å…¥ä¸‹ä¸€æ­¥
  // 4. è¶…æ—¶åï¼šåŸå®¡æ‰¹äººä»å¯å®¡æ‰¹ï¼Œä¸ä¼šå¼ºåˆ¶è½¬äº¤
  // 5. æ— å¤šçº§å‡çº§ï¼šåªé€šçŸ¥å‡çº§ç”¨æˆ·ï¼Œä¸è‡ªåŠ¨è½¬äº¤
}

// ç¤ºä¾‹ï¼šè®¾å¤‡ç»´ä¿å®¡æ‰¹æµç¨‹
const equipmentMaintenanceWorkflow: WorkflowTemplate = {
  code: "equipment-maintenance-approval",
  name: "è®¾å¤‡ç»´ä¿å®¡æ‰¹æµç¨‹",
  steps: [
    {
      order: 1,
      name: "å·¥ç¨‹å¸ˆå®¡æ‰¹",
      type: "approval",
      approvers: ["engineer-001"],
      timeoutHours: 12,                  // 12 å°æ—¶è¶…æ—¶
      escalationUserId: "supervisor-001" // å‡çº§åˆ°ä¸»ç®¡
    },
    {
      order: 2,
      name: "éƒ¨é—¨ä¸»ç®¡å®¡æ‰¹",
      type: "approval",
      approvers: ["supervisor-001"],
      timeoutHours: 24,
      escalationUserId: "manager-001"
    }
  ]
}
```

**å·¥ä½œæµ API æ¥å£**:
```typescript
// åˆ›å»ºå·¥ä½œæµå®ä¾‹
POST /api/workflows/instances
Body: {
  templateCode: "equipment-maintenance-approval",
  relatedType: "record",
  relatedId: "rec-001",
  initiatorId: "user-001"
}
Response: { instanceId: "wf-001", tasks: [...] }

// å®Œæˆå®¡æ‰¹ä»»åŠ¡
POST /api/workflows/tasks/:taskId/complete
Body: {
  action: "approved" | "rejected",
  comment: "å®¡æ‰¹æ„è§"
}

// P0-4: æŸ¥è¯¢è¶…æ—¶ä»»åŠ¡ï¼ˆå®šæ—¶ä»»åŠ¡è°ƒç”¨ï¼‰
GET /api/workflows/tasks/overdue
Response: [
  {
    taskId: "task-001",
    assigneeId: "user-001",
    escalationUserId: "user-002",
    overdueHours: 26
  }
]
```

**P0-4 ä¿®å¤ï¼šè¶…æ—¶å‡çº§é€»è¾‘**:
```typescript
// å®šæ—¶ä»»åŠ¡ï¼šæ¯å°æ—¶æ‰§è¡Œ
async function checkAndEscalateOverdueTasks() {
  const overdueTasks = await prisma.workflowTask.findMany({
    where: {
      status: 'pending',
      isOverdue: false,
      createdAt: {
        lt: new Date(Date.now() - 24 * 60 * 60 * 1000)  // 24 å°æ—¶å‰
      }
    }
  })

  for (const task of overdueTasks) {
    // 1. æ ‡è®°è¶…æ—¶
    await prisma.workflowTask.update({
      where: { id: task.id },
      data: { isOverdue: true }
    })

    // 2. å‘é€é€šçŸ¥
    await sendNotification({
      to: [task.assigneeId, task.escalationUserId],
      subject: 'å®¡æ‰¹ä»»åŠ¡è¶…æ—¶',
      content: `ä»»åŠ¡ ${task.stepName} å·²è¶…æ—¶ 24 å°æ—¶`
    })

    // 3. è‡ªåŠ¨å‡çº§ï¼ˆå¯é€‰ï¼‰
    if (task.escalationUserId) {
      await prisma.workflowTask.create({
        data: {
          instanceId: task.instanceId,
          stepOrder: task.stepOrder,
          stepName: task.stepName + 'ï¼ˆå‡çº§ï¼‰',
          assigneeId: task.escalationUserId,
          status: 'pending'
        }
      })
    }
  }
}
```

#### 1.2 åŠ¨æ€è¡¨å•å¼•æ“ï¼ˆå®Œæ•´å®šä¹‰ï¼‰

**ä¿®å¤ P0-1 + P0-7**: å·¥ä½œæµé›†æˆ + ç¡¬ç¼–ç å­—æ®µå†²çª

**æ ¸å¿ƒè¡¨**:
```prisma
model RecordTemplate {
  id              String   @id @default(cuid())
  code            String   @unique
  name            String
  category        String              // åˆ†ç±»ï¼ˆå·¥ç¨‹éƒ¨/è´¨é‡éƒ¨/ç”Ÿäº§éƒ¨ï¼‰
  formSchema      Json                // è¡¨å•ç»“æ„ï¼ˆè¯¦è§ä¸‹æ–¹ï¼‰

  // P0-1 ä¿®å¤ï¼šå·¥ä½œæµé›†æˆé…ç½®
  approvalRequired Boolean  @default(false)
  workflowConfig   Json?               // å·¥ä½œæµé…ç½®ï¼ˆè¯¦è§ä¸‹æ–¹ï¼‰

  // P0-5 ä¿®å¤ï¼šä¿ç•™æœŸé™ç®¡ç†
  retentionYears  Int      @default(5)  // ç”¨æˆ·ä¸šåŠ¡è§„åˆ™ï¼šé»˜è®¤ 5 å¹´ä¿ç•™æœŸ

  // P0-7 ä¿®å¤ï¼šæ‰¹æ¬¡å…³è”é…ç½®
  batchLinkConfig Json?               // æ‰¹æ¬¡å…³è”é…ç½®ï¼ˆè¯¦è§ä¸‹æ–¹ï¼‰

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  records         Record[]
}

model Record {
  id              String   @id @default(cuid())
  templateId      String
  recordNumber    String   @unique
  formData        Json                // è¡¨å•æ•°æ®
  status          String   @default("draft")

  // å·¥ä½œæµå…³è”
  workflowId      String?

  // æ‰¹æ¬¡å…³è”
  relatedBatchType   String?
  relatedBatchId     String?
  relatedBatchNumber String?

  // P0-5 ä¿®å¤ï¼šä¿ç•™æœŸé™
  retentionUntil     DateTime?
  autoArchiveStatus  String @default("active")

  // é˜²ç¯¡æ”¹
  signatureTimestamp DateTime?
  offlineFilled      Boolean @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  template        RecordTemplate @relation(fields: [templateId], references: [id])
  changeLogs      RecordChangeLog[]

  @@index([autoArchiveStatus])
}
```

**å­—æ®µç±»å‹å®Œæ•´æ¸…å•ï¼ˆ20+ ç±»å‹ï¼‰**:
```typescript
enum FieldType {
  // åŸºç¡€ç±»å‹
  TEXT = 'text',
  TEXTAREA = 'textarea',
  NUMBER = 'number',
  DECIMAL = 'decimal',
  DATE = 'date',
  TIME = 'time',
  DATETIME = 'datetime',

  // é€‰æ‹©ç±»å‹
  SELECT = 'select',
  MULTI_SELECT = 'multi_select',
  RADIO = 'radio',
  CHECKBOX = 'checkbox',

  // ç‰¹æ®Šç±»å‹
  SIGNATURE = 'signature',          // ç”µå­ç­¾å
  PHOTO = 'photo',                  // æ‹ç…§
  FILE_UPLOAD = 'file_upload',      // æ–‡ä»¶ä¸Šä¼ 
  BARCODE_SCAN = 'barcode_scan',    // æ¡å½¢ç æ‰«æ
  LOCATION = 'location',            // åœ°ç†ä½ç½®

  // åŠ¨æ€æ•°æ®æºç±»å‹ï¼ˆP0-7 æ ¸å¿ƒå­—æ®µï¼‰
  EQUIPMENT_SELECT = 'equipment_select',
  MATERIAL_SELECT = 'material_select',
  BATCH_SELECT = 'batch_select',
  USER_SELECT = 'user_select',

  // è®¡ç®—ç±»å‹
  COMPUTED = 'computed'
}
```

**P0-1 ä¿®å¤ï¼šå·¥ä½œæµé…ç½®æ¥å£**:
```typescript
interface WorkflowConfig {
  enabled: boolean
  workflowTemplateCode: string
  autoTrigger: boolean              // æäº¤æ—¶è‡ªåŠ¨è§¦å‘å·¥ä½œæµ

  // å·¥ä½œæµå›è°ƒ
  onApproved?: {
    action: "updateStatus" | "generatePDF" | "sendNotification"
    params: Record<string, any>
  }

  onRejected?: {
    action: "resetToDraft" | "notify"
    params: Record<string, any>
  }
}

// ç¤ºä¾‹ï¼šè®¾å¤‡ç»´ä¿è®°å½•æ¨¡æ¿
const maintenanceTemplate = {
  code: "MAINT-RECORD-001",
  name: "è®¾å¤‡ç»´ä¿è®°å½•",
  workflowConfig: {
    enabled: true,
    workflowTemplateCode: "equipment-maintenance-approval",
    autoTrigger: true,
    onApproved: {
      action: "updateStatus",
      params: { status: "approved" }
    },
    onRejected: {
      action: "resetToDraft",
      params: {}
    }
  }
}
```

**P0-7 ä¿®å¤ï¼šæ‰¹æ¬¡å…³è”é…ç½®æ¥å£**:
```typescript
interface BatchLinkConfig {
  enabled: boolean
  batchType: 'production' | 'finished_goods' | 'material'
  autoLink: {
    triggerField: string            // è§¦å‘å­—æ®µåï¼ˆå¦‚ "productionBatchNumber"ï¼‰
    linkStrategy: 'byNumber' | 'byId' | 'byBarcode'
  }
}

// ç¤ºä¾‹ï¼šç”Ÿäº§è®°å½•è‡ªåŠ¨å…³è”ç”Ÿäº§æ‰¹æ¬¡
const productionRecordTemplate = {
  code: "PROD-RECORD-001",
  name: "ç”Ÿäº§è®°å½•",
  batchLinkConfig: {
    enabled: true,
    batchType: 'production',
    autoLink: {
      triggerField: 'productionBatchNumber',
      linkStrategy: 'byNumber'
    }
  },
  formSchema: [
    { name: 'productionBatchNumber', type: 'text', label: 'ç”Ÿäº§æ‰¹æ¬¡å·', required: true },
    { name: 'productName', type: 'text', label: 'äº§å“åç§°' },
    // ... å…¶ä»–å­—æ®µ
  ]
}
```

**åŠ¨æ€è¡¨å•æäº¤æµç¨‹ï¼ˆä¿®å¤ P0-1ï¼‰**:
```typescript
// æäº¤è®°å½•å¹¶è§¦å‘å·¥ä½œæµ
async function submitRecord(recordId: string, userId: string) {
  const record = await prisma.record.findUnique({
    where: { id: recordId },
    include: { template: true }
  })

  // 1. æ ¡éªŒå¿…å¡«å­—æ®µ
  validateRequiredFields(record)

  // 2. è®¡ç®—ä¿ç•™æœŸé™ï¼ˆP0-5ï¼‰
  const retentionUntil = new Date()
  retentionUntil.setFullYear(retentionUntil.getFullYear() + record.template.retentionYears)

  // 3. æ‰¹æ¬¡è‡ªåŠ¨å…³è”ï¼ˆP0-7ï¼‰
  let batchInfo = null
  if (record.template.batchLinkConfig?.enabled) {
    batchInfo = await linkToBatch(record, record.template.batchLinkConfig)
  }

  // 4. æ›´æ–°è®°å½•çŠ¶æ€
  await prisma.record.update({
    where: { id: recordId },
    data: {
      status: 'submitted',
      submittedAt: new Date(),
      retentionUntil,
      ...batchInfo
    }
  })

  // 5. è§¦å‘å·¥ä½œæµï¼ˆP0-1ï¼‰
  if (record.template.workflowConfig?.enabled && record.template.workflowConfig?.autoTrigger) {
    const workflowInstance = await createWorkflowInstance({
      templateCode: record.template.workflowConfig.workflowTemplateCode,
      relatedType: 'record',
      relatedId: recordId,
      initiatorId: userId
    })

    await prisma.record.update({
      where: { id: recordId },
      data: { workflowId: workflowInstance.id }
    })
  }
}
```

**Layer 1.1-1.2 æ ¸å¿ƒä¸šåŠ¡è§„åˆ™ï¼ˆåŸºäºç”¨æˆ·ç¡®è®¤ï¼‰**:

```typescript
// ==================== æ¨¡æ¿ç®¡ç†è§„åˆ™ ====================
// BR-1.1: éƒ¨é—¨è´Ÿè´£äººå¯åˆ›å»ºæ¨¡æ¿ï¼Œæ— éœ€å®¡æ‰¹
// BR-1.2: æ¨¡æ¿ä¿®æ”¹åï¼Œæ—§è®°å½•ä¸å—å½±å“ï¼ˆå†å²æ•°æ®ä¸å˜ï¼‰
// BR-1.3: å½’æ¡£çš„æ¨¡æ¿ï¼Œå…¶æ—§è®°å½•ä»ç„¶å¯æŸ¥çœ‹
// BR-1.4: æ‰€æœ‰æ—§ç‰ˆæœ¬ã€å†å²è®°å½•å¿…é¡»ä¿ç•™æŒ‡å®šå¹´é™ï¼ˆé»˜è®¤ 5 å¹´ï¼‰

// ==================== è‰ç¨¿ä¸æäº¤è§„åˆ™ ====================
// BR-1.5: è‰ç¨¿å¯æ— é™æœŸä¿å­˜ï¼Œç›´åˆ°æäº¤æˆ–åˆ é™¤
// BR-1.6: æäº¤å¤±è´¥åï¼Œå–æ¶ˆå¹¶è¿”å›è‰ç¨¿çŠ¶æ€
// BR-1.7: å®¡æ‰¹æ‹’ç»åï¼Œéœ€é‡æ–°æäº¤å¹¶èµ°å®Œæ•´æµç¨‹
// BR-1.8: âš ï¸ å®¡æ‰¹é€šè¿‡çš„è®°å½•ä¸å…è®¸ä¿®æ”¹ï¼ˆå·²ç§»é™¤ MODIFY_APPROVED_RECORD æƒé™ï¼‰

// ==================== è®°å½•ä¿ç•™è§„åˆ™ ====================
// BR-1.9: æ‰€æœ‰è®°å½•é»˜è®¤ä¿ç•™ 5 å¹´ï¼ˆä¸æ˜¯ 3 å¹´ï¼‰
// BR-1.10: ä¿ç•™æœŸæ»¡åè‡ªåŠ¨å½’æ¡£
// BR-1.11: å½’æ¡£è®°å½•å¿…é¡»æ”¯æŒå¯¼å‡º

// ==================== å·¥ä½œæµé…ç½®è§„åˆ™ ====================
// BR-1.12: éƒ¨é—¨è´Ÿè´£äººé…ç½®å·¥ä½œæµæ¨¡æ¿
// BR-1.13: æ¯ç§ä¸šåŠ¡ç±»å‹åªæœ‰ä¸€ä¸ªå·¥ä½œæµï¼ˆå¦‚"é¢†æ–™"åªæœ‰ä¸€ä¸ªå·¥ä½œæµï¼‰
// BR-1.14: æ¨¡æ¿ä¿®æ”¹åï¼Œè¿›è¡Œä¸­çš„å·¥ä½œæµä¸å—å½±å“

// ==================== å¹¶è¡Œå®¡æ‰¹è§„åˆ™ï¼ˆä¼šç­¾ï¼‰ ====================
// BR-1.15: ä¼šç­¾(all)ï¼šæ‰€æœ‰å®¡æ‰¹äººå¿…é¡»å…¨éƒ¨é€šè¿‡ï¼ˆAND é€»è¾‘ï¼‰
// BR-1.16: ä¼šç­¾(all)ï¼šä¸€äººæ‹’ç» â†’ æ‰€æœ‰å…¶ä»–å®¡æ‰¹å¤±æ•ˆ â†’ é€€å›å‘èµ·äºº
// BR-1.17: ä¼šç­¾(all)ï¼šä¸€äººè¶…æ—¶ â†’ å…¶ä»–äººä¸èƒ½ç»§ç»­å®¡æ‰¹ â†’ ç­‰å¾…å¤„ç†
// BR-1.18: æˆ–ç­¾(any)ï¼šä»»ä¸€å®¡æ‰¹äººé€šè¿‡å³å¯

// ==================== å®¡æ‰¹è¶…æ—¶è§„åˆ™ ====================
// BR-1.19: è¶…æ—¶æ—¶é—´ï¼šä»ä»»åŠ¡åˆ›å»ºæ—¶é—´ç®—èµ· 24 å°æ—¶ï¼ˆé»˜è®¤ï¼‰
// BR-1.20: å‘¨æœ«/èŠ‚å‡æ—¥ä¸è®¡å…¥è¶…æ—¶æ—¶é—´
// BR-1.21: è¶…æ—¶åï¼šåŸå®¡æ‰¹äººä»å¯å®¡æ‰¹ï¼ˆä¸å¼ºåˆ¶è½¬äº¤ï¼‰
// BR-1.22: æ— å¤šçº§å‡çº§ï¼šä»…é€šçŸ¥å‡çº§ç”¨æˆ·ï¼Œä»»åŠ¡å¡ä½

// ==================== å®¡æ‰¹æ‹’ç»ä¸å–æ¶ˆè§„åˆ™ ====================
// BR-1.23: å®¡æ‰¹æ‹’ç»åé€€å›å‘èµ·äºº
// BR-1.24: æ— æ‹’ç»æ¬¡æ•°é™åˆ¶
// BR-1.25: å‘èµ·äººå¯å–æ¶ˆæµç¨‹
// BR-1.26: å–æ¶ˆåè®°å½•è¿”å›è‰ç¨¿çŠ¶æ€

// ==================== å¾…åŠä»»åŠ¡è§„åˆ™ ====================
// BR-1.27: å¾…åŠæ¥æºï¼šå®¡æ‰¹ã€ç»´ä¿æé†’ã€åˆ°æœŸæé†’ã€å†…å®¡ã€"è¿˜æœ‰å¾ˆå¤š"
// BR-1.28: æ”¯æŒæ‰‹åŠ¨åˆ›å»ºå¾…åŠä»»åŠ¡
// BR-1.29: é»˜è®¤æ— ä¼˜å…ˆçº§åŒºåˆ†ï¼ˆæ‰€æœ‰ä»»åŠ¡åŒç­‰ä¼˜å…ˆçº§ï¼‰
// BR-1.30: é€¾æœŸä»»åŠ¡ä¸è‡ªåŠ¨å‡çº§ä¼˜å…ˆçº§
// BR-1.31: å®Œæˆå¾…åŠä»»åŠ¡è‡ªåŠ¨æ›´æ–°ä¸šåŠ¡è®°å½•
// BR-1.32: å¾…åŠä»»åŠ¡å¯å…³é—­

// ==================== æ‰¹æ¬¡è¿½æº¯è§„åˆ™ ====================
// BR-1.33: åŸæ–™æ‰¹æ¬¡å·ï¼šä¼˜å…ˆä½¿ç”¨ä¾›åº”å•†æä¾›çš„æ‰¹æ¬¡å·ï¼Œæ— åˆ™ç³»ç»Ÿç”Ÿæˆ
// BR-1.34: ç”Ÿäº§æ‰¹æ¬¡å·ï¼šæ ¼å¼ç¨åç¡®å®šï¼ˆç”¨æˆ·å°†æä¾›ï¼‰
// BR-1.35: æˆå“æ‰¹æ¬¡å· = ç”Ÿäº§æ‰¹æ¬¡å·ï¼ˆç›¸åŒï¼‰
// BR-1.36: åŸæ–™æ‰¹æ¬¡åˆ›å»ºæ—¶æœºï¼šä»“åº“æ”¶è´§æ—¶
// BR-1.37: ç”Ÿäº§æ‰¹æ¬¡åˆ›å»ºæ—¶æœºï¼šç”Ÿäº§è®¡åˆ’åˆ›å»ºæ—¶
// BR-1.38: æ‰¹æ¬¡ç‰©æ–™ä½¿ç”¨å…³è”æ—¶æœºï¼šå®é™…ä½¿ç”¨ç‰©æ–™æ—¶
// BR-1.39: è¿½æº¯å“åº”æ—¶é—´ï¼šå®æ—¶ï¼ˆæ­£å‘/åå‘è¿½æº¯å¿…é¡»ç«‹å³æ˜¾ç¤ºç»“æœï¼‰

// ==================== ä»“åº“ FIFO è§„åˆ™ ====================
// BR-1.40: ç³»ç»Ÿå¼ºåˆ¶æ‰§è¡Œå…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰
// BR-1.41: ä¿ç•™æ‰‹åŠ¨é€‰æ‹©æ‰¹æ¬¡å¼€å…³ï¼ˆåº”å¯¹ç‰¹æ®Šæƒ…å†µï¼‰
// BR-1.42: æœ€æ—©æ‰¹æ¬¡ä¸è¶³æ—¶ï¼Œå…è®¸å¤šæ‰¹æ¬¡æ··ç”¨
// BR-1.43: ä¸´æœŸç‰©æ–™ä¸ä¼˜å…ˆï¼ˆä¸è¦æŠŠç³»ç»Ÿæå¤ªå¤æ‚ï¼‰

// ==================== ç‰©æ–™å¹³è¡¡è§„åˆ™ ====================
// BR-1.44: è®¡ç®—å‘¨æœŸï¼šä»äº§å“å…¥åº“åˆ°ä¸‹æ¬¡åˆ‡æ¢æ‰¹æ¬¡
// BR-1.45: åå·®å®¹é™ï¼šå¯é…ç½®ï¼ˆä¸å›ºå®š Â±5%ï¼‰
// BR-1.46: åå·®è¶…æ ‡ï¼šè­¦å‘Š/æé†’ï¼ˆæš‚æ— å·¥ä½œæµï¼‰
// BR-1.47: è®¡ç®—å…¬å¼ï¼šéœ€è¿›ä¸€æ­¥æ¢è®¨

// ==================== åº“å­˜ç›˜ç‚¹è§„åˆ™ ====================
// BR-1.48: ç›˜ç‚¹é¢‘ç‡ï¼šå·¥ä½œæ—¥ä¸Šä¸‹ç­å‰åå„ä¸€æ¬¡
// BR-1.49: ç›˜ç‚¹å·®å¼‚ï¼šç”Ÿæˆç›˜ç›ˆç›˜äºå• â†’ éœ€å®¡æ‰¹
// BR-1.50: åº“å­˜æ›´æ–°æ—¶æœºï¼šéœ€è¿›ä¸€æ­¥æ˜ç¡®

// ==================== ä¾›åº”å•†èµ„è´¨è§„åˆ™ ====================
// BR-1.51: å¿…éœ€è¯ç…§ï¼šè¥ä¸šæ‰§ç…§ã€ç”Ÿäº§è®¸å¯è¯ï¼ˆç”Ÿäº§å•†ï¼‰ã€ç»è¥è®¸å¯è¯ï¼ˆç»é”€å•†ï¼‰
// BR-1.52: åˆ°æœŸæé†’ï¼šå¿…é¡»æœ‰
// BR-1.53: âš ï¸ èµ„è´¨è¿‡æœŸçš„ä¾›åº”å•†ä»å¯æ”¶è´§ï¼Œèµ„è´¨å¯åè¡¥

// ==================== è®¾å¤‡ç»´ä¿è§„åˆ™ ====================
// BR-1.54: ç»´ä¿ç­‰çº§å†…å®¹ï¼šæ—¥å¸¸/å‘¨/æœˆ/å­£/å¹´ï¼ˆå†…å®¹å¾…å®šï¼‰
// BR-1.55: ç»´ä¿è®¡åˆ’ï¼šæ ¹æ®è®¾å¤‡å°è´¦è‡ªåŠ¨ç”Ÿæˆ
// BR-1.56: é€¾æœŸå¤„ç†ï¼šä»…æé†’ï¼Œä¸é”å®šè®¾å¤‡

// ==================== è®¾å¤‡æ•…éšœè§„åˆ™ ====================
// BR-1.57: æŠ¥ä¿®æµç¨‹ï¼šå…¨å‘˜ â†’ å·¥ç¨‹éƒ¨ â†’ ç°åœºç»´ä¿® â†’ å®Œæˆ
// BR-1.58: æ— ç´§æ€¥/æ™®é€šåŒºåˆ†ï¼ˆæ‰€æœ‰æ•…éšœåŒç­‰å¤„ç†ï¼‰
// BR-1.59: æ‰€æœ‰æ•…éšœéƒ½èƒ½ä¿®å¤
// BR-1.60: æ•…éšœè®¾å¤‡å¯ç»§ç»­ä½¿ç”¨

// ==================== æ–‡æ¡£ç®¡ç†è¡¥å……è§„åˆ™ï¼ˆ2026-02-13 æ–°å¢ï¼‰====================
// BR-281: æ–‡æ¡£ç‰ˆæœ¬å‡çº§è§„åˆ™ï¼š1.0 â†’ 1.1 â†’ 1.2 â†’ ... â†’ 1.9 â†’ 2.0ï¼Œç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ
// BR-282: æ–‡æ¡£ä½œåºŸåä»»åŠ¡å¤„ç†ï¼šå…è®¸ä»»åŠ¡ç»§ç»­ï¼Œä½†æ ‡è®°æ–‡æ¡£å·²ä½œåºŸ
// BR-283: å†å²ç‰ˆæœ¬æŸ¥çœ‹æƒé™ï¼šä»…åˆ›å»ºè€…å’Œç®¡ç†å‘˜å¯æŸ¥çœ‹

// ==================== æ¨¡æ¿å­—æ®µç®¡ç†è§„åˆ™ ====================
// BR-284: æ¨¡æ¿æ–°å¢å­—æ®µï¼šå·²æœ‰å¡«æŠ¥è®°å½•çš„æ¨¡æ¿æ–°å¢å­—æ®µï¼Œä½œä¸ºæ–°ç‰ˆæœ¬ä½¿ç”¨
// BR-285: æ¨¡æ¿åˆ é™¤å­—æ®µï¼šå…è®¸åˆ é™¤ï¼Œå†å²æ•°æ®ä¿æŒåŸæ ·ï¼Œæ–°å¡«æŠ¥ä¸å†å‡ºç°
// BR-286: æ¨¡æ¿ä¿®æ”¹å­—æ®µç±»å‹ï¼šå…è®¸ä¿®æ”¹ï¼ˆæ–‡æœ¬â†’æ•°å­—ï¼‰ï¼Œå†å²æ•°æ®ä¿ç•™ï¼Œæ–°æ•°æ®æŒ‰æ–°ç±»å‹éªŒè¯

// ==================== ä»»åŠ¡åˆ†é…ä¸å¤„ç†è§„åˆ™ ====================
// BR-287: ä»»åŠ¡å¤šäººå¹¶è¡Œï¼šä»»åŠ¡å¯åˆ†é…ç»™å¤šä¸ªäººï¼Œå¤šäººå¹¶è¡Œå¡«æŠ¥
// BR-288: ä»»åŠ¡å®Œæˆè§„åˆ™ï¼šä»»ä½•ä¸€äººæäº¤åï¼Œä»»åŠ¡å³æ ‡è®°ä¸ºå®Œæˆï¼Œå…¶ä»–äººæ— éœ€å†æäº¤
// BR-289: ä»»åŠ¡è¶…æœŸå¤„ç†ï¼šä»»åŠ¡è¶…è¿‡æˆªæ­¢æ—¥æœŸåï¼Œä¸€ç›´ä¿æŒå¾…åŠçŠ¶æ€ï¼Œä¸è‡ªåŠ¨å…³é—­

// ==================== å®¡æ‰¹æµç¨‹è§„åˆ™ ====================
// BR-290: å®¡æ‰¹äººç¼ºä½å¤„ç†ï¼šå®¡æ‰¹äººè¯·å‡/ç¦»èŒæ—¶ï¼Œç”±å…¶ç›´å±ä¸Šçº§ä»£ä¸ºå®¡æ‰¹ï¼Œå¦‚æ— ä¸Šçº§åˆ™ç®¡ç†å‘˜å®¡æ‰¹
// BR-291: å®¡æ‰¹æ’¤å›è§„åˆ™ï¼šå®¡æ‰¹é€šè¿‡åä¸å…è®¸æ’¤å›

// ==================== æƒé™ç®¡ç†è§„åˆ™ ====================
// BR-292: è·¨éƒ¨é—¨æƒé™è§„åˆ™ï¼šæŒ‰è§’è‰²åˆ†é…æƒé™ï¼Œç®¡ç†å±‚çº§åŠä»¥ä¸Šå¯è·¨éƒ¨é—¨æŸ¥çœ‹
// BR-293: å¤–éƒ¨å®¡æ ¸å¤„ç†ï¼šå¤–éƒ¨å®¡æ ¸äººå‘˜ä¸ç»™ç³»ç»Ÿè®¿é—®æƒé™ï¼Œä»…æä¾›æ•°æ®å¯¼å‡ºï¼ˆæ‰“å°æˆ–ç”µå­ç‰ˆï¼‰

// ==================== ç”Ÿäº§æ‰¹æ¬¡å·è§„åˆ™ ====================
// BR-294: ç”Ÿäº§æ‰¹æ¬¡å·æ ¼å¼ï¼šäº§å“åç§°ç¼©å†™ + å¹´æœˆæ—¥ + ç­æ¬¡ï¼ˆå¦‚ QKLBG20260213Aï¼‰
//         æ”¯æŒçµæ´»é…ç½®ï¼šäº§å“ç¼©å†™ã€æ—¥æœŸæ ¼å¼ã€æ˜¯å¦å¯ç”¨ç­æ¬¡ã€åˆ†éš”ç¬¦

// ==================== ç‰©æ–™å¹³è¡¡è§„åˆ™ ====================
// BR-295: ç‰©æ–™å¹³è¡¡åŸºç¡€å…¬å¼ï¼šæŠ•å…¥é‡ = äº§å‡ºé‡ + æŸè€—é‡
// BR-296: æŸè€—ç‡è®¡ç®—å…¬å¼ï¼šæŸè€—ç‡ = (æŸè€—é‡ / æŠ•å…¥é‡) Ã— 100%
// BR-297: å…è®¸è¯¯å·®èŒƒå›´ï¼šæ¶²ä½“ç‰©æ–™ â‰¤ 3%ã€å›ºä½“ç‰©æ–™ â‰¤ 2%ã€è´µé‡ç‰©æ–™ â‰¤ 1%
// BR-298: æŸè€—è¶…æ ‡å¤„ç†ï¼šç³»ç»Ÿé¢„è­¦ â†’ éœ€å¡«å†™æŸè€—åŸå›  â†’ ä¸»ç®¡å®¡æ‰¹

// ==================== åº“å­˜ç®¡ç†è§„åˆ™ ====================
// BR-299: é¢†æ–™å³æ—¶æ‰£å‡ï¼šä»“åº“å‡ºæ–™ â†’ ä»“åº“åº“å­˜æ‰£å‡ â†’ ç‰©æ–™æš‚å­˜é—´åº“å­˜å¢åŠ 
// BR-300: é…æ–™æ—¶æ‰£å‡æš‚å­˜é—´åº“å­˜ï¼šé…æ–™å®Œæˆ â†’ ç‰©æ–™æš‚å­˜é—´åº“å­˜æ‰£å‡
// BR-301: æ¯æ—¥ç›˜ç‚¹æ ¡æ­£å·®å¼‚ï¼šæ¯æ—¥ç›˜ç‚¹ â†’ å‘ç°å·®å¼‚ â†’ å¡«å†™ç›˜ç‚¹å·®å¼‚åŸå›  â†’ æ ¡æ­£åº“å­˜

// ==================== è®¾å¤‡ç»´ä¿ç­‰çº§è§„åˆ™ ====================
// BR-302: ç»´ä¿ç­‰çº§åˆ†ç±»ï¼šä¸€çº§ä¿å…»ï¼ˆæ—¥å¸¸ï¼Œç²—ï¼‰ã€äºŒçº§ä¿å…»ï¼ˆå®šæœŸï¼Œä¸­ï¼‰ã€ä¸‰çº§ä¿å…»ï¼ˆæ·±åº¦ï¼Œç»†ï¼‰
// BR-303: ç»´ä¿å‘¨æœŸé…ç½®ï¼šä¸€çº§ï¼ˆ1/2/3ä¸ªæœˆï¼‰ã€äºŒçº§ï¼ˆ3/6ä¸ªæœˆï¼‰ã€ä¸‰çº§ï¼ˆåŠå¹´/ä¸€å¹´ï¼‰ï¼Œæ¯å°è®¾å¤‡ç‹¬ç«‹é…ç½®
// BR-304: ç»´ä¿å†…å®¹å±‚çº§ï¼šä¸€çº§ï¼ˆæ¸…æ´ã€æ£€æŸ¥ã€è®°å½•ï¼‰â†’ äºŒçº§ï¼ˆ+æ¶¦æ»‘ã€ç´§å›ºã€æ›´æ¢æ˜“æŸä»¶ï¼‰â†’ ä¸‰çº§ï¼ˆ+æ·±åº¦æ‹†æ£€ã€ç²¾åº¦æ ¡éªŒã€æ€§èƒ½æµ‹è¯•ï¼‰

// ==================== æ–‡æ¡£å¼•ç”¨è§„åˆ™ ====================
// BR-305: ç¦æ­¢å¾ªç¯å¼•ç”¨ï¼šæ–‡æ¡£A â†’ æ–‡æ¡£B â†’ æ–‡æ¡£Aï¼Œç³»ç»Ÿæ£€æµ‹å¹¶é˜»æ­¢
// BR-306: ç®€åŒ–å¼•ç”¨å…³ç³»ï¼šåªå…è®¸ä¸€å±‚å¼•ç”¨ï¼ˆæ–‡æ¡£A â†’ æ–‡æ¡£Bï¼‰ï¼Œä¸å…è®¸å¤šå±‚å¼•ç”¨ï¼ˆæ–‡æ¡£A â†’ æ–‡æ¡£B â†’ æ–‡æ¡£Cï¼‰

// ==================== æ‰¹æ¬¡å…³è”è§„åˆ™ ====================
// BR-307: è‡ªåŠ¨å…³è”åŸæ–™æ‰¹æ¬¡ï¼šç”Ÿäº§è®°å½•å¡«å†™æ—¶ï¼Œç³»ç»Ÿæ ¹æ® BOM åˆ—å‡ºæ‰€éœ€åŸæ–™ï¼Œè‡ªåŠ¨åŒ¹é…å¯ç”¨æ‰¹æ¬¡ï¼ˆFIFOè§„åˆ™ï¼‰
// BR-308: å…è®¸è°ƒæ•´æ‰¹æ¬¡é€‰æ‹©ï¼šç”¨æˆ·å¯ç¡®è®¤è‡ªåŠ¨åŒ¹é…çš„æ‰¹æ¬¡ï¼Œä¹Ÿå¯æ‰‹åŠ¨æ›´æ¢ä¸ºå…¶ä»–å¯ç”¨æ‰¹æ¬¡ï¼Œå¯è°ƒæ•´æ¯ä¸ªæ‰¹æ¬¡çš„ç”¨é‡

// ==================== é€šçŸ¥ç³»ç»Ÿè§„åˆ™ï¼ˆ2026-02-13 æ–°å¢ï¼‰====================
// BR-309: é€šçŸ¥ä¿ç•™æ—¶é•¿ï¼šå·²è¯»é€šçŸ¥ä¿ç•™ 30 å¤©ï¼Œæœªè¯»é€šçŸ¥æ°¸ä¹…ä¿ç•™
// BR-310: é€šçŸ¥ä¼˜å…ˆçº§ï¼šä¸åŒºåˆ†ä¼˜å…ˆçº§ï¼Œæ‰€æœ‰é€šçŸ¥åŒç­‰å¯¹å¾…

// ==================== ç¼–å·è§„åˆ™ç³»ç»Ÿ ====================
// BR-311: ç¼–å·è§„åˆ™ä¿®æ”¹ï¼šå·²ä½¿ç”¨çš„ç¼–å·è§„åˆ™ä¸å…è®¸ä¿®æ”¹å‰ç¼€ã€åˆ†éš”ç¬¦ç­‰å…³é”®å­—æ®µï¼Œä»…å…è®¸ä¿®æ”¹åç§°/æè¿°
// BR-312: ç¼–å·è§„åˆ™å¹´åº¦é‡ç½®ï¼šæ”¯æŒæŒ‰å¹´åº¦é‡ç½®åºå·ï¼ˆå¦‚ DOC-2026-001 â†’ DOC-2027-001ï¼‰

// ==================== æ•°æ®å¯¼å‡ºç³»ç»Ÿ ====================
// BR-313: å¯¼å‡ºæƒé™ï¼šæ‰€æœ‰ç”¨æˆ·å¯å¯¼å‡ºè‡ªå·±æœ‰æƒé™æŸ¥çœ‹çš„æ•°æ®ï¼Œä¸éœ€è¦é¢å¤–å®¡æ‰¹
// BR-314: å¯¼å‡ºæ ¼å¼ï¼šæ”¯æŒ Excelã€PDF ä¸¤ç§æ ¼å¼
// BR-315: å¯¼å‡ºå®¡è®¡ï¼šæ‰€æœ‰å¯¼å‡ºæ“ä½œå¿…é¡»è®°å½•æ“ä½œæ—¥å¿—ï¼ˆè°ã€ä½•æ—¶ã€å¯¼å‡ºäº†ä»€ä¹ˆã€å¯¼å‡ºæ¡æ•°ï¼‰

// ==================== å›æ”¶ç«™ç³»ç»Ÿ ====================
// BR-316: å›æ”¶ç«™ä¿ç•™æ—¶é•¿ï¼šåˆ é™¤åä¿ç•™ 30 å¤©ï¼Œ30 å¤©åè‡ªåŠ¨æ°¸ä¹…åˆ é™¤
// BR-317: å›æ”¶ç«™æƒé™ï¼šä»…åˆ é™¤äººæœ¬äººå’Œç®¡ç†å‘˜å¯æŸ¥çœ‹å›æ”¶ç«™ä¸­çš„æ•°æ®
// BR-318: æ¸…ç†é€šçŸ¥ï¼šç³»ç»Ÿåœ¨ç¬¬ 23ã€25ã€27ã€29 å¤©å‘é€æ¸…ç†é€šçŸ¥ï¼Œ30 å¤©åè‡ªåŠ¨åˆ é™¤

// ==================== ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ ====================
// BR-319: ç”¨æˆ·ç¦»èŒå¤„ç†ï¼šç¦»èŒç”¨æˆ·çš„å¾…åŠä»»åŠ¡ã€å¾…å®¡æ‰¹äº‹é¡¹è‡ªåŠ¨è½¬äº¤ç»™å…¶ç›´å±ä¸Šçº§ï¼Œå¦‚æ— ä¸Šçº§åˆ™è½¬ç»™ç®¡ç†å‘˜
// BR-320: å¯†ç ç­–ç•¥ï¼šå¯†ç é”™è¯¯ 5 æ¬¡åé”å®šè´¦å· 1 åˆ†é’Ÿ
// BR-321: æ•°æ®è½¬äº¤é€šçŸ¥ï¼šæ•°æ®è½¬äº¤æ—¶å¿…é¡»å‘é€é€šçŸ¥ç»™æ¥æ”¶äºº

// ==================== æ“ä½œæ—¥å¿—ç³»ç»Ÿ ====================
// BR-322: æ—¥å¿—ä¿ç•™ç­–ç•¥ï¼šå…³é”®æ“ä½œï¼ˆåˆ é™¤ã€å®¡æ‰¹ã€å¯¼å‡ºï¼‰æ°¸ä¹…ä¿ç•™ï¼›æ™®é€šæ“ä½œï¼ˆæŸ¥çœ‹ã€ç¼–è¾‘ï¼‰ä¿ç•™ 90 å¤©ï¼›ä½ä»·å€¼æ“ä½œï¼ˆç™»å½•ï¼‰ä¿ç•™ 30 å¤©
// BR-323: æ—¥å¿—æŸ¥è¯¢æƒé™ï¼šæ™®é€šç”¨æˆ·ä»…å¯æŸ¥çœ‹è‡ªå·±çš„æ“ä½œæ—¥å¿—ï¼Œç®¡ç†å‘˜å¯æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
// BR-324: æ—¥å¿—è®°å½•å†…å®¹ï¼šå¿…é¡»åŒ…å«æ“ä½œäººã€æ“ä½œæ—¶é—´ã€æ“ä½œç±»å‹ã€æ“ä½œå¯¹è±¡ã€IPåœ°å€ã€æ“ä½œç»“æœ

// ==================== å‰ç«¯ UI/UX è®¾è®¡è§„èŒƒï¼ˆ2026-02-13 æ–°å¢ï¼Œå‚è€ƒ SPMS-Webï¼‰====================

// ==================== å®¡æ‰¹æµç¨‹å¯è§†åŒ– ====================
// BR-328: å®¡æ‰¹æµç¨‹å¯è§†åŒ–ï¼šå®¡æ‰¹äººç”¨å½©è‰²æ ‡ç­¾é“¾å¼å±•ç¤ºï¼ˆå¼ ä¸‰ > æå›› > ç‹äº”ï¼‰ï¼Œæé«˜æµç¨‹å¯è¯»æ€§
// BR-329: å®¡æ‰¹äººä¸èƒ½é‡å¤ï¼šæ·»åŠ å®¡æ‰¹äººæ—¶æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤æ·»åŠ 
// BR-330: å®¡æ‰¹æµç¨‹åŠ¨æ€é…ç½®ï¼šå‘èµ·å®¡æ‰¹æ—¶å¯é€‰æ‹©å®¡æ‰¹äººï¼Œæ”¯æŒå¤šçº§ä¸²è¡Œå®¡æ‰¹ï¼Œå¯åŠ¨æ€å¢åˆ å®¡æ‰¹äºº

// ==================== è¡¨æ ¼æ“ä½œåˆ—è®¾è®¡ ====================
// BR-337: æ“ä½œæŒ‰é’®çŠ¶æ€åŠ¨æ€æ§åˆ¶ï¼šæ ¹æ®æ–‡æ¡£çŠ¶æ€å’Œç”¨æˆ·æƒé™åŠ¨æ€æ˜¾ç¤º/ç¦ç”¨æŒ‰é’®
//         - ç¼–è¾‘æŒ‰é’®ï¼šè‰ç¨¿çŠ¶æ€ + æ–‡æ¡£åˆ›å»ºè€… â†’ å¯ç”¨ï¼›å·²å‘å¸ƒ â†’ ç¦ç”¨
//         - åˆ é™¤æŒ‰é’®ï¼šæ–‡æ¡£åˆ›å»ºè€…æˆ–ç®¡ç†å‘˜ â†’ å¯ç”¨ï¼›å…¶ä»– â†’ ç¦ç”¨
//         - é¢„è§ˆ/ä¸‹è½½æŒ‰é’®ï¼šæœ‰æŸ¥çœ‹æƒé™ â†’ å§‹ç»ˆå¯ç”¨
// BR-338: æŒ‰é’®æ ·å¼è§„èŒƒï¼šæ“ä½œåˆ—å®½åº¦ 160pxï¼ŒæŒ‰é’®é¡ºåºï¼ˆç¼–è¾‘ã€åˆ é™¤ã€è¯¦æƒ…ã€é¢„è§ˆã€ä¸‹è½½ï¼‰ï¼Œç¼–è¾‘/è¯¦æƒ…ç”¨é“¾æ¥æ ·å¼ï¼Œåˆ é™¤ç”¨å±é™©è‰²

// ==================== çŠ¶æ€æ ‡ç­¾å¯è§†åŒ– ====================
// BR-341: çŠ¶æ€æ ‡ç­¾å¯è§†åŒ–ï¼šç”¨å½©è‰²æ ‡ç­¾ï¼ˆel-tagï¼‰åŒºåˆ†ä¸åŒçŠ¶æ€ï¼Œæé«˜è¯†åˆ«åº¦
// BR-342: çŠ¶æ€é¢œè‰²è§„èŒƒï¼šè‰ç¨¿(ç°è‰² info)ã€å®¡æ ¸ä¸­(æ©™è‰² warning)ã€å·²å‘å¸ƒ(ç»¿è‰² success)ã€å·²é©³å›(çº¢è‰² danger)ã€å·²å½’æ¡£(è“è‰² primary)

// ==================== èœå•æƒé™åŠ¨æ€æ˜¾ç¤º ====================
// BR-334: èœå•æƒé™åŠ¨æ€åŠ è½½ï¼šç”¨æˆ·ç™»å½•åæ ¹æ®è§’è‰²è¿”å›å¯è®¿é—®èœå•åˆ—è¡¨
// BR-335: éšè—æ— æƒé™èœå•ï¼šå‰ç«¯ä»…æ˜¾ç¤ºç”¨æˆ·æœ‰æƒé™çš„èœå•é¡¹ï¼ˆä¸æ˜¾ç¤ºè€Œéç½®ç°ï¼‰
// BR-336: API æƒé™æ ¡éªŒï¼šå³ä½¿å‰ç«¯ç»•è¿‡èœå•é™åˆ¶ï¼Œåç«¯ä»éœ€æ ¡éªŒæƒé™

// ==================== è¡¨å•åˆ†ç»„å¸ƒå±€ ====================
// BR-339: è¡¨å•åˆ†ç»„å¸ƒå±€ï¼šä½¿ç”¨åˆ†ç»„åŒºåˆ†ä¸åŒç±»å‹å­—æ®µï¼ˆåŸºç¡€ä¿¡æ¯ã€å®¡æ‰¹ä¿¡æ¯ã€é™„åŠ ä¿¡æ¯ï¼‰ï¼Œæé«˜è¡¨å•å¯è¯»æ€§
// BR-340: è¡¨å•åˆ—æ•°è§„èŒƒï¼šåŸºç¡€ä¿¡æ¯/å®¡æ‰¹ä¿¡æ¯ç”¨ 2 åˆ—å¸ƒå±€ï¼Œæè¿°æ€§å­—æ®µï¼ˆæ–‡æ¡£æè¿°ã€å¤‡æ³¨ï¼‰ç”¨ 1 åˆ—å…¨å®½å¸ƒå±€

// ==================== å¯¹è¯æ¡†å°ºå¯¸è§„èŒƒ ====================
// BR-343: å¯¹è¯æ¡†å°ºå¯¸è§„èŒƒï¼š
//         - ç¼–è¾‘å¯¹è¯æ¡†ï¼š80% å®½ Ã— 80% é«˜ï¼ˆæ–‡æ¡£ç¼–è¾‘ã€æ¨¡æ¿ç¼–è¾‘ï¼‰
//         - è¯¦æƒ…å¯¹è¯æ¡†ï¼š70% å®½ Ã— 80% é«˜ï¼ˆæ–‡æ¡£è¯¦æƒ…æŸ¥çœ‹ï¼‰
//         - é€‰æ‹©å¯¹è¯æ¡†ï¼š60% å®½ Ã— 70% é«˜ï¼ˆé€‰æ‹©å®¡æ‰¹äººã€é€‰æ‹©éƒ¨é—¨ï¼‰
//         - é¢„è§ˆå¯¹è¯æ¡†ï¼š90% å®½ Ã— 90% é«˜ï¼ˆPDF/Word é¢„è§ˆï¼‰
//         - ç¡®è®¤å¯¹è¯æ¡†ï¼šè‡ªé€‚åº”ï¼ˆåˆ é™¤ç¡®è®¤ã€æ“ä½œç¡®è®¤ï¼‰

// ==================== æ“ä½œåé¦ˆè§„èŒƒ ====================
// BR-344: æ“ä½œåé¦ˆè§„èŒƒï¼š
//         - æˆåŠŸæ“ä½œï¼šç»¿è‰² Toastï¼Œ2 ç§’è‡ªåŠ¨å…³é—­ï¼ˆå¦‚"æ–‡æ¡£ä¸Šä¼ æˆåŠŸ"ï¼‰
//         - å¤±è´¥æ“ä½œï¼šçº¢è‰² Toastï¼Œ3 ç§’è‡ªåŠ¨å…³é—­ï¼ˆå¦‚"æ–‡æ¡£ä¸Šä¼ å¤±è´¥ï¼šæ–‡ä»¶è¿‡å¤§"ï¼‰
//         - è­¦å‘Šæ“ä½œï¼šæ©™è‰² Toastï¼Œ3 ç§’è‡ªåŠ¨å…³é—­ï¼ˆå¦‚"è¯·å…ˆé€‰æ‹©æ–‡ä»¶å¤¹"ï¼‰
//         - ä¿¡æ¯æç¤ºï¼šè“è‰² Toastï¼Œ2 ç§’è‡ªåŠ¨å…³é—­ï¼ˆå¦‚"æ­£åœ¨å¤„ç†ä¸­..."ï¼‰
// BR-345: ç¡®è®¤å¯¹è¯æ¡†è§„èŒƒï¼šåˆ é™¤/å±é™©æ“ä½œå¿…é¡»å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†ï¼Œé¿å…è¯¯æ“ä½œ
//         - åˆ é™¤æ“ä½œï¼šæ ‡é¢˜"åˆ é™¤ç¡®è®¤"ï¼Œå†…å®¹"ç¡®å®šåˆ é™¤è¯¥æ–‡æ¡£ï¼Ÿåˆ é™¤åå¯åœ¨å›æ”¶ç«™æ¢å¤"
//         - å±é™©æ“ä½œï¼šæ ‡é¢˜"è­¦å‘Š"ï¼Œå†…å®¹"ç¡®å®šæ°¸ä¹…åˆ é™¤è¯¥æ–‡æ¡£ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤"
//         - æ‰¹é‡æ“ä½œï¼šæ ‡é¢˜"æ‰¹é‡æ“ä½œç¡®è®¤"ï¼Œå†…å®¹"ç¡®å®šåˆ é™¤é€‰ä¸­çš„ 5 ä¸ªæ–‡æ¡£ï¼Ÿ"
```

#### 1.3 æ™ºèƒ½æ–‡æ¡£å¼•æ“

**ä¿®å¤ P0-8**: å¼•ç”¨æ·±åº¦é™åˆ¶ + å¾ªç¯ä¾èµ–æ£€æµ‹

```prisma
model DocumentReference {
  id             String   @id @default(cuid())
  sourceDocId    String
  targetDocId    String
  sectionId      String
  lastSyncedAt   DateTime?

  sourceDoc      Document @relation("SourceDoc", fields: [sourceDocId], references: [id], onDelete: Cascade)
  targetDoc      Document @relation("TargetDoc", fields: [targetDocId], references: [id], onDelete: Cascade)

  @@unique([sourceDocId, targetDocId, sectionId])
}
```

**P0-8 ä¿®å¤ï¼šå¼•ç”¨æ·±åº¦é™åˆ¶**:
```typescript
const MAX_REFERENCE_DEPTH = 2

async function checkReferenceDepth(sourceDocId: string, targetDocId: string, currentDepth = 0): Promise<void> {
  if (currentDepth >= MAX_REFERENCE_DEPTH) {
    throw new Error('å¼•ç”¨æ·±åº¦ä¸èƒ½è¶…è¿‡ 2 å±‚')
  }

  // æ£€æŸ¥å¾ªç¯å¼•ç”¨
  if (sourceDocId === targetDocId) {
    throw new Error('ä¸èƒ½å¼•ç”¨è‡ªå·±')
  }

  // é€’å½’æ£€æŸ¥ç›®æ ‡æ–‡æ¡£çš„å¼•ç”¨
  const targetReferences = await prisma.documentReference.findMany({
    where: { sourceDocId: targetDocId }
  })

  for (const ref of targetReferences) {
    await checkReferenceDepth(sourceDocId, ref.targetDocId, currentDepth + 1)
  }
}

// åˆ›å»ºå¼•ç”¨å‰æ£€æŸ¥
async function createDocumentReference(sourceDocId: string, targetDocId: string, sectionId: string) {
  // æ£€æŸ¥å¼•ç”¨æ·±åº¦
  await checkReferenceDepth(sourceDocId, targetDocId)

  // åˆ›å»ºå¼•ç”¨
  return await prisma.documentReference.create({
    data: { sourceDocId, targetDocId, sectionId }
  })
}
```

#### 1.4 å¾…åŠä»»åŠ¡ç³»ç»Ÿ

**æ ¸å¿ƒè¡¨**:
```prisma
model TodoTask {
  id          String   @id @default(cuid())
  title       String
  description String?
  type        String              // reminder | approval | maintenance | audit
  priority    String   @default("normal")  // low | normal | high | urgent
  status      String   @default("pending")
  dueDate     DateTime?

  // å…³è”èµ„æº
  relatedType String?             // "record" | "document" | "equipment"
  relatedId   String?

  assigneeId  String
  createdAt   DateTime @default(now())
  completedAt DateTime?

  @@index([assigneeId, status])
  @@index([priority, dueDate])
}
```

---

### æ ¸å¿ƒæ¶æ„æ€»ç»“

**Layer 0 æä¾›**:
- âœ… ç”¨æˆ·ä¸ç»„ç»‡æ¶æ„
- âœ… ç»†ç²’åº¦æƒé™ç®¡ç†ï¼ˆRBAC + èµ„æºçº§ï¼‰
- âœ… æ–‡æ¡£åˆ†çº§ä½“ç³»ï¼ˆ1-4 çº§ï¼‰
- âœ… ç¼–å·è§„åˆ™å¼•æ“

**Layer 1 æä¾›**:
- âœ… å·¥ä½œæµå¼•æ“ï¼ˆå®¡æ‰¹æµç¨‹ + è¶…æ—¶å‡çº§ï¼‰
- âœ… åŠ¨æ€è¡¨å•å¼•æ“ï¼ˆ20+ å­—æ®µç±»å‹ + å·¥ä½œæµé›†æˆ + æ‰¹æ¬¡å…³è”ï¼‰
- âœ… æ™ºèƒ½æ–‡æ¡£å¼•æ“ï¼ˆå¼•ç”¨ç®¡ç† + æ·±åº¦é™åˆ¶ï¼‰
- âœ… å¾…åŠä»»åŠ¡ç³»ç»Ÿï¼ˆç»Ÿä¸€å¾…åŠï¼‰

---

### Layer 2: æ ¸å¿ƒç”Ÿäº§æµç¨‹ï¼ˆä¸šåŠ¡å±‚ï¼‰

**å®šä½**: åŸºäº Layer 0-1 çš„èƒ½åŠ›ï¼Œæ„å»ºæ ¸å¿ƒç”Ÿäº§ä¸šåŠ¡æµç¨‹ã€‚

#### 2.1 æ‰¹æ¬¡è¿½æº¯ç³»ç»Ÿï¼ˆBRCGS æ ¸å¿ƒï¼‰

**ä¾èµ–å…³ç³»**:
- âœ… **ä¾èµ– Layer 1.2**: åŠ¨æ€è¡¨å•å¼•æ“ï¼ˆç”Ÿäº§è®°å½•ã€è´¨æ£€è®°å½•é€šè¿‡åŠ¨æ€è¡¨å•å¡«å†™ï¼‰
- âœ… **ä¾èµ– Layer 0.2**: æƒé™ç³»ç»Ÿï¼ˆè´¨é‡éƒ¨å¯è·¨éƒ¨é—¨æŸ¥çœ‹è¿½æº¯æ•°æ®ï¼‰

**æ ¸å¿ƒè¡¨**ï¼ˆç¡¬ç¼–ç  - P0-7 æ˜ç¡®åˆ’åˆ†ï¼‰:
```prisma
// 1. åŸæ–™æ‰¹æ¬¡è¡¨
model MaterialBatch {
  id                String   @id @default(cuid())
  batchNumber       String   @unique
  materialId        String
  materialCode      String              // æ ¸å¿ƒå­—æ®µï¼ˆç¡¬ç¼–ç ï¼‰
  materialName      String              // æ ¸å¿ƒå­—æ®µ
  supplierId        String
  quantity          Float                // æ ¸å¿ƒå­—æ®µ
  unit              String               // æ ¸å¿ƒå­—æ®µ
  productionDate    DateTime?
  expiryDate        DateTime?
  receivedDate      DateTime
  status            String   @default("in_stock")

  // P0-2 ä¿®å¤ï¼šæ‰¹æ¬¡è¿½æº¯å…³è”ï¼ˆå¤–é”®çº¦æŸï¼‰
  usedInProduction  BatchMaterialUsage[]

  @@index([batchNumber])
  @@index([materialId])
  @@map("material_batches")
}

// 2. ç”Ÿäº§æ‰¹æ¬¡è¡¨
model ProductionBatch {
  id                String   @id @default(cuid())
  batchNumber       String   @unique
  productId         String                // æ ¸å¿ƒå­—æ®µï¼ˆç¡¬ç¼–ç ï¼‰
  productCode       String                // æ ¸å¿ƒå­—æ®µ
  productName       String                // æ ¸å¿ƒå­—æ®µ
  productionDate    DateTime              // æ ¸å¿ƒå­—æ®µ
  plannedQuantity   Float                 // æ ¸å¿ƒå­—æ®µ
  actualQuantity    Float                 // æ ¸å¿ƒå­—æ®µ
  unit              String                // æ ¸å¿ƒå­—æ®µ
  status            String   @default("in_progress")

  // P0-2 ä¿®å¤ï¼šå¤–é”®çº¦æŸä¿è¯è¿½æº¯é“¾å®Œæ•´æ€§
  materialsUsed     BatchMaterialUsage[]
  finishedGoods     FinishedGoodsBatch[]

  // P0-7 ä¿®å¤ï¼šåŠ¨æ€è¡¨å•æ‰©å±•ï¼ˆç”Ÿäº§å‚æ•°ã€æ“ä½œå‘˜ç­¾åç­‰ï¼‰
  relatedRecords    Record[]              // æ‰©å±•å­—æ®µï¼ˆåŠ¨æ€ï¼‰

  @@index([batchNumber])
  @@index([productId])
  @@map("production_batches")
}

// 3. æ‰¹æ¬¡ç‰©æ–™ä½¿ç”¨è¡¨ï¼ˆå…³é”®è¿½æº¯å…³è”ï¼‰
model BatchMaterialUsage {
  id                String   @id @default(cuid())
  productionBatchId String
  materialBatchId   String
  materialCode      String                // æ ¸å¿ƒå­—æ®µï¼ˆç¡¬ç¼–ç ï¼‰
  quantity          Float                 // æ ¸å¿ƒå­—æ®µ
  unit              String                // æ ¸å¿ƒå­—æ®µ

  // P0-2 ä¿®å¤ï¼šå¤–é”®çº¦æŸ onDelete: Restrictï¼ˆç¦æ­¢åˆ é™¤æœ‰å…³è”çš„æ‰¹æ¬¡ï¼‰
  productionBatch   ProductionBatch @relation(fields: [productionBatchId], references: [id], onDelete: Restrict)
  materialBatch     MaterialBatch @relation(fields: [materialBatchId], references: [id], onDelete: Restrict)

  @@index([productionBatchId])
  @@index([materialBatchId])
  @@map("batch_material_usage")
}

// 4. æˆå“æ‰¹æ¬¡è¡¨
model FinishedGoodsBatch {
  id                String   @id @default(cuid())
  batchNumber       String   @unique
  productionBatchId String
  productId         String                // æ ¸å¿ƒå­—æ®µï¼ˆç¡¬ç¼–ç ï¼‰
  quantity          Float                 // æ ¸å¿ƒå­—æ®µ
  productionDate    DateTime              // æ ¸å¿ƒå­—æ®µ
  expiryDate        DateTime?
  status            String   @default("in_stock")

  // P0-2 ä¿®å¤ï¼šå¤–é”®çº¦æŸ
  productionBatch   ProductionBatch @relation(fields: [productionBatchId], references: [id], onDelete: Restrict)

  // P0-7 ä¿®å¤ï¼šåŠ¨æ€è¡¨å•æ‰©å±•ï¼ˆè´¨æ£€è®°å½•ç­‰ï¼‰
  relatedRecords    Record[]
  shipments         ShipmentItem[]

  @@index([batchNumber])
  @@map("finished_goods_batches")
}
```

**P0-7 ä¿®å¤ï¼šç¡¬ç¼–ç  vs åŠ¨æ€å­—æ®µæ˜ç¡®åˆ’åˆ†**:

| å­—æ®µç±»å‹ | å­˜å‚¨æ–¹å¼ | å­—æ®µç¤ºä¾‹ | åŸå›  |
|---------|---------|---------|------|
| **æ ¸å¿ƒè¿½æº¯å­—æ®µ** | ç¡¬ç¼–ç è¡¨ | materialCode, quantity, batchNumber | è¿½æº¯é“¾æ¡ä¸»çº¿ï¼Œä¸å¯é…ç½®ï¼ŒæŸ¥è¯¢æ€§èƒ½é«˜ |
| **æ‰©å±•å‚æ•°å­—æ®µ** | åŠ¨æ€è¡¨å• | æ¸©åº¦ã€æ¹¿åº¦ã€æ“ä½œå‘˜ç­¾åã€ç…§ç‰‡ | ä¸åŒäº§å“å‚æ•°ä¸åŒï¼Œå¯çµæ´»é…ç½® |

**æ‰¹æ¬¡è‡ªåŠ¨å…³è”ç¤ºä¾‹**ï¼ˆP0-7 ä¿®å¤ï¼‰:
```typescript
// ç”Ÿäº§è®°å½•æ¨¡æ¿é…ç½®
const productionRecordTemplate = {
  code: "PROD-RECORD-001",
  name: "ç”Ÿäº§è®°å½•",
  category: "ç”Ÿäº§éƒ¨",

  // P0-7: æ‰¹æ¬¡å…³è”é…ç½®
  batchLinkConfig: {
    enabled: true,
    batchType: 'production',
    autoLink: {
      triggerField: 'productionBatchNumber',  // å¡«å†™æ‰¹æ¬¡å·æ—¶è‡ªåŠ¨å…³è”
      linkStrategy: 'byNumber'
    }
  },

  // è¡¨å•å­—æ®µå®šä¹‰
  formSchema: [
    // æ ¸å¿ƒå­—æ®µï¼ˆç”¨äºæ‰¹æ¬¡å…³è”ï¼‰
    { name: 'productionBatchNumber', type: 'text', label: 'ç”Ÿäº§æ‰¹æ¬¡å·', required: true },

    // æ‰©å±•å­—æ®µï¼ˆåŠ¨æ€ï¼‰
    { name: 'temperature', type: 'decimal', label: 'çƒ˜çƒ¤æ¸©åº¦ï¼ˆâ„ƒï¼‰', validation: { min: 150, max: 200 } },
    { name: 'humidity', type: 'decimal', label: 'ç¯å¢ƒæ¹¿åº¦ï¼ˆ%ï¼‰' },
    { name: 'operatorSignature', type: 'signature', label: 'æ“ä½œå‘˜ç­¾å' },
    { name: 'productPhoto', type: 'photo', label: 'äº§å“ç…§ç‰‡' }
  ]
}

// æäº¤ç”Ÿäº§è®°å½•æ—¶è‡ªåŠ¨å…³è”æ‰¹æ¬¡
async function submitProductionRecord(recordData) {
  // 1. æŸ¥æ‰¾ç”Ÿäº§æ‰¹æ¬¡
  const batch = await prisma.productionBatch.findUnique({
    where: { batchNumber: recordData.formData.productionBatchNumber }
  })

  if (!batch) {
    throw new Error('ç”Ÿäº§æ‰¹æ¬¡ä¸å­˜åœ¨')
  }

  // 2. åˆ›å»ºè®°å½•å¹¶è‡ªåŠ¨å…³è”
  await prisma.record.create({
    data: {
      ...recordData,
      relatedBatchType: 'production',
      relatedBatchId: batch.id,
      relatedBatchNumber: batch.batchNumber
    }
  })
}
```

**è¿½æº¯ API**:
```typescript
// åå‘è¿½æº¯ï¼šæˆå“ â†’ åŸæ–™
POST /api/trace/backward
Body: { finishedGoodsBatchNumber: "FG-20240601-001" }
Response: {
  finishedGoodsBatch: { ... },
  productionBatch: { ... },
  materials: [
    { materialCode: "MAT-001", materialName: "é«˜ç­‹é¢ç²‰", batchNumber: "SUP-001", quantity: 500 }
  ]
}

// æ­£å‘è¿½æº¯ï¼šåŸæ–™ â†’ æˆå“ â†’ å®¢æˆ·
POST /api/trace/forward
Body: { materialBatchNumber: "SUP-001" }
Response: {
  materialBatch: { ... },
  usedInProductions: [
    {
      productionBatch: { ... },
      finishedGoods: [ { ... } ],
      customers: [ { name: "å®¢æˆ· A", shipmentDate: "2024-06-15" } ]
    }
  ]
}
```

---

#### 2.2 ä»“åº“ç®¡ç†ç³»ç»Ÿ

**ä¾èµ–å…³ç³»**:
- âœ… **ä¾èµ– Layer 2.1**: æ‰¹æ¬¡è¿½æº¯ç³»ç»Ÿï¼ˆå…¥åº“åˆ›å»ºæ‰¹æ¬¡ã€é¢†æ–™å…³è”æ‰¹æ¬¡ï¼‰
- âœ… **ä¾èµ– Layer 1.1**: å·¥ä½œæµå¼•æ“ï¼ˆé¢†æ–™å®¡æ‰¹ã€æŠ¥åºŸå®¡æ‰¹ï¼‰
- âœ… **ä¾èµ– Layer 1.2**: åŠ¨æ€è¡¨å•å¼•æ“ï¼ˆç›˜ç‚¹è®°å½•ã€ç‰©æ–™å¹³è¡¡è®°å½•ï¼‰
- âœ… **ä¾èµ– Layer 1.4**: å¾…åŠä»»åŠ¡ç³»ç»Ÿï¼ˆä¸´æœŸé¢„è­¦ã€è¿‡æœŸé¢„è­¦ï¼‰

**æ ¸å¿ƒè¡¨**:
```prisma
model Material {
  id          String   @id @default(cuid())
  code        String   @unique          // ç‰©æ–™ç¼–å·ï¼ˆæ¥è‡ªé‡‘è¶ï¼‰
  name        String                    // æ ¸å¿ƒå­—æ®µ
  category    String                    // æ ¸å¿ƒå­—æ®µ
  specification String?
  unit        String                    // æ ¸å¿ƒå­—æ®µ

  batches     MaterialBatch[]           // æ‰¹æ¬¡ï¼ˆä¾èµ– Layer 2.1ï¼‰
}

model MaterialRequisition {
  id              String   @id @default(cuid())
  requisitionNumber String @unique
  departmentId    String
  status          String   @default("draft")  // draft | pending | approved | completed

  // P0-1 ä¿®å¤ï¼šå·¥ä½œæµé›†æˆ
  workflowId      String?

  items           MaterialRequisitionItem[]

  @@map("material_requisitions")
}

model MaterialRequisitionItem {
  id              String   @id @default(cuid())
  requisitionId   String
  materialId      String                    // æ ¸å¿ƒå­—æ®µï¼ˆç¡¬ç¼–ç ï¼‰
  batchId         String                    // æ ¸å¿ƒå­—æ®µï¼ˆç¡¬ç¼–ç ï¼‰
  quantity        Float                     // æ ¸å¿ƒå­—æ®µï¼ˆç¡¬ç¼–ç ï¼‰

  requisition     MaterialRequisition @relation(fields: [requisitionId], references: [id])
  batch           MaterialBatch @relation(fields: [batchId], references: [id])
}
```

**é¢†æ–™å®¡æ‰¹æµç¨‹ï¼ˆP0-1 ä¿®å¤ï¼‰**:
```typescript
// å·¥ä½œæµé…ç½®
const requisitionWorkflow: WorkflowTemplate = {
  code: "material-requisition-approval",
  name: "é¢†æ–™å•å®¡æ‰¹",
  steps: [
    {
      order: 1,
      name: "ä»“åº“ä¸»ç®¡å®¡æ‰¹",
      type: "approval",
      approvers: ["warehouse-supervisor"],
      timeoutHours: 12,
      escalationUserId: "warehouse-manager"
    }
  ]
}

// æäº¤é¢†æ–™å•è§¦å‘å·¥ä½œæµ
async function submitRequisition(requisitionId: string) {
  // 1. æ ¡éªŒåº“å­˜å……è¶³
  await validateStockSufficient(requisitionId)

  // 2. åˆ›å»ºå·¥ä½œæµå®ä¾‹
  const workflow = await createWorkflowInstance({
    templateCode: "material-requisition-approval",
    relatedType: "requisition",
    relatedId: requisitionId
  })

  // 3. æ›´æ–°é¢†æ–™å•çŠ¶æ€
  await prisma.materialRequisition.update({
    where: { id: requisitionId },
    data: {
      status: 'pending',
      workflowId: workflow.id
    }
  })
}
```

**P0-6 ä¿®å¤ï¼šä¾›åº”å•†èµ„è´¨åˆ°æœŸå¤„ç†**:
```typescript
// å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©å‡Œæ™¨ 00:00 æ‰§è¡Œ
async function checkSupplierQualifications() {
  const now = new Date()
  const in30Days = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000)

  // 1. æŸ¥è¯¢å³å°†è¿‡æœŸçš„èµ„è´¨ï¼ˆ< 30 å¤©ï¼‰
  const expiringQualifications = await prisma.supplierQualification.findMany({
    where: {
      status: 'valid',
      expiryDate: {
        gte: now,
        lte: in30Days
      }
    },
    include: { supplier: true }
  })

  // 2. æ ‡è®°ä¸º expiringï¼Œç”Ÿæˆå¾…åŠä»»åŠ¡
  for (const qual of expiringQualifications) {
    await prisma.supplierQualification.update({
      where: { id: qual.id },
      data: { status: 'expiring' }
    })

    await prisma.todoTask.create({
      data: {
        title: `ä¾›åº”å•†èµ„è´¨å³å°†è¿‡æœŸï¼š${qual.supplier.name}`,
        type: 'reminder',
        priority: 'high',
        assigneeId: 'procurement-manager',
        relatedType: 'supplier',
        relatedId: qual.supplierId,
        dueDate: qual.expiryDate
      }
    })
  }

  // 3. æŸ¥è¯¢å·²è¿‡æœŸçš„èµ„è´¨
  const expiredQualifications = await prisma.supplierQualification.findMany({
    where: {
      status: { in: ['valid', 'expiring'] },
      expiryDate: { lt: now }
    },
    include: { supplier: true }
  })

  // 4. æ ‡è®°ä¸º expiredï¼Œä½†ä¾›åº”å•†çŠ¶æ€ä¿æŒ activeï¼ˆç”¨æˆ·ä¸šåŠ¡è§„åˆ™ BR-1.53ï¼‰
  for (const qual of expiredQualifications) {
    await prisma.supplierQualification.update({
      where: { id: qual.id },
      data: { status: 'expired' }
    })

    // âš ï¸ ç”¨æˆ·ä¸šåŠ¡è§„åˆ™å˜æ›´ï¼šèµ„è´¨è¿‡æœŸçš„ä¾›åº”å•†ä»å¯æ”¶è´§ï¼Œèµ„è´¨å¯åè¡¥
    // ä¸å†å°†ä¾›åº”å•†çŠ¶æ€æ”¹ä¸º inactive
    // await prisma.supplier.update({
    //   where: { id: qual.supplierId },
    //   data: { status: 'inactive' }
    // })

    // 5. åˆ›å»ºå¾…åŠä»»åŠ¡ï¼Œæé†’é‡‡è´­éƒ¨é—¨è¡¥å……èµ„è´¨
    await prisma.todoTask.create({
      data: {
        title: `ä¾›åº”å•†èµ„è´¨å·²è¿‡æœŸï¼Œéœ€è¡¥å……ï¼š${qual.supplier.name}`,
        type: 'reminder',
        priority: 'high',
        assigneeId: 'procurement-manager',
        relatedType: 'supplier',
        relatedId: qual.supplierId,
        dueDate: new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000) // 7 å¤©å
      }
    })

    // ç§»é™¤åŸæœ‰çš„"åœ¨é€”è®¢å•éš”ç¦»"é€»è¾‘ï¼ˆBR-1.53ï¼šå…è®¸ç»§ç»­æ”¶è´§ï¼‰
    // const pendingOrders = await prisma.materialRequisition.findMany({...})
    // ä¸å†æ ‡è®°è®¢å•ä¸º quarantine
  }
}
```

---

#### 2.3 è®¾å¤‡ç®¡ç†ç³»ç»Ÿ

**ä¾èµ–å…³ç³»**:
- âœ… **ä¾èµ– Layer 1.2**: åŠ¨æ€è¡¨å•å¼•æ“ï¼ˆç»´ä¿è®°å½•ã€æ•…éšœè®°å½•ï¼‰
- âœ… **ä¾èµ– Layer 1.4**: å¾…åŠä»»åŠ¡ç³»ç»Ÿï¼ˆç»´ä¿æé†’ã€æ•…éšœæŠ¥ä¿®ï¼‰
- âœ… **ä¾èµ– Layer 1.1**: å·¥ä½œæµå¼•æ“ï¼ˆç»´ä¿å®¡æ‰¹ï¼‰

**æ ¸å¿ƒè¡¨**:
```prisma
model Equipment {
  id                String   @id @default(cuid())
  code              String   @unique
  name              String
  category          String
  location          String
  status            String   @default("normal")

  // å¤šçº§ç»´ä¿é…ç½®ï¼ˆP0 ä¿®å¤ç‰ˆï¼‰
  maintenanceConfig Json?                      // æ—¥å¸¸/å‘¨/æœˆ/å­£/å¹´ç»´ä¿é…ç½®

  maintenancePlans   MaintenancePlan[]
  maintenanceRecords MaintenanceRecord[]
  faults             EquipmentFault[]          // è®¾å¤‡æ•…éšœ

  @@map("equipment")
}

model EquipmentFault {
  id                String   @id @default(cuid())
  faultNumber       String   @unique          // FR-{YYYYMMDD}-{åºå·}
  equipmentId       String
  reporterId        String
  reportTime        DateTime @default(now())
  faultDescription  String
  urgencyLevel      String   @default("normal")  // urgent | normal | low
  status            String   @default("pending")

  // å·¥ä½œæµé›†æˆï¼ˆP0-1ï¼‰
  todoTaskId        String?                   // è‡ªåŠ¨ç”Ÿæˆå¾…åŠä»»åŠ¡

  equipment         Equipment @relation(fields: [equipmentId], references: [id])

  @@map("equipment_faults")
}
```

**è®¾å¤‡æ•…éšœæŠ¥ä¿®æµç¨‹ï¼ˆæ‰€æœ‰å‘˜å·¥å¯å‘èµ·ï¼‰**:
```typescript
// æäº¤æ•…éšœæŠ¥ä¿®
async function submitEquipmentFault(data: {
  equipmentId: string
  faultDescription: string
  urgencyLevel: 'urgent' | 'normal' | 'low'
  reporterId: string
}) {
  // 1. ç”Ÿæˆæ•…éšœç¼–å·
  const faultNumber = await generateFaultNumber()  // FR-20240612-001

  // 2. åˆ›å»ºæ•…éšœè®°å½•
  const fault = await prisma.equipmentFault.create({
    data: {
      faultNumber,
      equipmentId: data.equipmentId,
      reporterId: data.reporterId,
      faultDescription: data.faultDescription,
      urgencyLevel: data.urgencyLevel,
      status: 'pending'
    },
    include: { equipment: true }
  })

  // 3. è‡ªåŠ¨ç”Ÿæˆå¾…åŠä»»åŠ¡ï¼ˆå·¥ç¨‹éƒ¨æ¥å•ï¼‰
  const todoTask = await prisma.todoTask.create({
    data: {
      title: `è®¾å¤‡æŠ¥ä¿®ï¼š${fault.equipment.name}`,
      description: fault.faultDescription,
      type: 'maintenance',
      priority: fault.urgencyLevel === 'urgent' ? 'urgent' : 'high',
      assigneeId: 'engineering-dept-leader',  // åˆ†é…ç»™å·¥ç¨‹éƒ¨ä¸»ç®¡
      relatedType: 'fault',
      relatedId: fault.id
    }
  })

  // 4. å…³è”å¾…åŠä»»åŠ¡
  await prisma.equipmentFault.update({
    where: { id: fault.id },
    data: { todoTaskId: todoTask.id }
  })

  return fault
}
```

---

### Layer 3: ä½“ç³»ç®¡ç†æ¨¡å—

**å®šä½**: æ”¯æ’‘ BRCGS ä½“ç³»ç®¡ç†è¦æ±‚çš„åŠŸèƒ½æ¨¡å—ã€‚

#### 3.1 åŸ¹è®­ç®¡ç†ç³»ç»Ÿ

**ä¾èµ–å…³ç³»**:
- âœ… **ä¾èµ– Layer 1.2**: åŠ¨æ€è¡¨å•å¼•æ“ï¼ˆåŸ¹è®­ç­¾åˆ°è¡¨ã€è€ƒè¯•æˆç»©è¡¨ï¼‰
- âœ… **ä¾èµ– Layer 1.1**: å·¥ä½œæµå¼•æ“ï¼ˆåŸ¹è®­è®¡åˆ’å®¡æ‰¹ï¼‰
- âœ… **ä¾èµ– Layer 1.4**: å¾…åŠä»»åŠ¡ç³»ç»Ÿï¼ˆåŸ¹è®­é€šçŸ¥ï¼‰

**æ ¸å¿ƒè¡¨**:
```prisma
model TrainingPlan {
  id              String   @id @default(cuid())
  planNumber      String   @unique
  title           String
  category        String              // å²—å‰åŸ¹è®­ | åœ¨å²—åŸ¹è®­ | ä¸“é¡¹åŸ¹è®­
  targetAudience  Json                // ç›®æ ‡å­¦å‘˜ï¼ˆéƒ¨é—¨/å²—ä½ï¼‰
  startDate       DateTime
  endDate         DateTime
  status          String   @default("draft")

  // å·¥ä½œæµé›†æˆ
  workflowId      String?

  sessions        TrainingSession[]
  participants    TrainingParticipant[]

  @@map("training_plans")
}
```

---

#### 3.2 å†…å®¡ç®¡ç†ç³»ç»Ÿ

**ä¾èµ–å…³ç³»**:
- âœ… **ä¾èµ– Layer 1.2**: åŠ¨æ€è¡¨å•å¼•æ“ï¼ˆå†…å®¡æ£€æŸ¥è¡¨ã€ä¸ç¬¦åˆé¡¹è®°å½•ï¼‰
- âœ… **ä¾èµ– Layer 1.3**: æ™ºèƒ½æ–‡æ¡£å¼•æ“ï¼ˆå†…å®¡æŠ¥å‘Šå¼•ç”¨æ–‡æ¡£ï¼‰
- âœ… **ä¾èµ– Layer 1.1**: å·¥ä½œæµå¼•æ“ï¼ˆä¸ç¬¦åˆé¡¹æ•´æ”¹å®¡æ‰¹ï¼‰

---

#### 3.3 ä¾›åº”å•†ç®¡ç†

**ä¾èµ–å…³ç³»**:
- âœ… **ä¾èµ– Layer 0.2**: æƒé™ç³»ç»Ÿï¼ˆé‡‡è´­éƒ¨ç®¡ç†ä¾›åº”å•†ï¼‰
- âœ… **ä¾èµ– Layer 1.4**: å¾…åŠä»»åŠ¡ç³»ç»Ÿï¼ˆèµ„è´¨åˆ°æœŸæé†’ï¼‰

**P0-6 ä¿®å¤å·²åœ¨ Layer 2.2 ä»“åº“ç®¡ç†ä¸­å®ç°ã€‚**

---

### Layer 4: ç§»åŠ¨ç«¯ä¸è¿ç»´å±‚

**å®šä½**: è·¨å¹³å°ç§»åŠ¨åº”ç”¨å’Œç³»ç»Ÿè¿ç»´ç›‘æ§ã€‚

#### 4.1 ç§»åŠ¨ç«¯åº”ç”¨ï¼ˆuniappï¼‰

**ä¾èµ–å…³ç³»**:
- âœ… **ä¾èµ– Layer 1.2**: åŠ¨æ€è¡¨å•å¼•æ“ï¼ˆç§»åŠ¨ç«¯å¡«å†™è®°å½•ï¼‰
- âœ… **ä¾èµ– Layer 1.1**: å·¥ä½œæµå¼•æ“ï¼ˆç§»åŠ¨ç«¯å®¡æ‰¹ï¼‰
- âœ… **ä¾èµ– Layer 2.3**: è®¾å¤‡ç®¡ç†ï¼ˆç§»åŠ¨ç«¯æŠ¥ä¿®ã€ç»´ä¿ï¼‰

**æ ¸å¿ƒåŠŸèƒ½**:
- åŠ¨æ€è¡¨å•æ¸²æŸ“ï¼ˆ20+ å­—æ®µç±»å‹ï¼‰
- ç¦»çº¿å¡«å†™ + åœ¨çº¿åŒæ­¥
- æ‹ç…§ã€ç­¾åã€æ¡å½¢ç æ‰«æ
- å·¥ä½œæµå®¡æ‰¹

---

#### 4.2 ç³»ç»Ÿè¿ç»´ç›‘æ§

**ä¾èµ–å…³ç³»**:
- âœ… **ä¾èµ– Layer 0**: å®¡è®¡æ—¥å¿—ï¼ˆLoginLog, PermissionLog, SensitiveLogï¼‰
- âœ… **ç‹¬ç«‹éƒ¨ç½²**: Prometheus + Grafana + Loki

**æ ¸å¿ƒåŠŸèƒ½**:
- æ•°æ®åº“å¤‡ä»½ï¼ˆPostgreSQL pg_dumpï¼Œæ¯å¤©è‡ªåŠ¨ï¼‰
- æ–‡ä»¶å¤‡ä»½ï¼ˆMinIO mc mirrorï¼Œæ¯å¤©è‡ªåŠ¨ï¼‰
- ç³»ç»Ÿç›‘æ§ï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ã€API å“åº”æ—¶é—´ï¼‰
- æ—¥å¿—èšåˆï¼ˆåº”ç”¨æ—¥å¿—ã€å®¡è®¡æ—¥å¿—ï¼‰

---

### åˆ†å±‚æ¶æ„å®Œæ•´ä¾èµ–å›¾

```
Layer 4: ç§»åŠ¨ç«¯ä¸è¿ç»´
  â”œâ”€ ç§»åŠ¨ç«¯åº”ç”¨ â†’ ä¾èµ– Layer 1.1, 1.2, 2.3
  â””â”€ è¿ç»´ç›‘æ§ â†’ ä¾èµ– Layer 0 (å®¡è®¡æ—¥å¿—)

Layer 3: ä½“ç³»ç®¡ç†
  â”œâ”€ åŸ¹è®­ç®¡ç† â†’ ä¾èµ– Layer 1.1, 1.2, 1.4
  â”œâ”€ å†…å®¡ç®¡ç† â†’ ä¾èµ– Layer 1.1, 1.2, 1.3
  â””â”€ ä¾›åº”å•†ç®¡ç† â†’ ä¾èµ– Layer 0.2, 1.4

Layer 2: æ ¸å¿ƒç”Ÿäº§
  â”œâ”€ æ‰¹æ¬¡è¿½æº¯ â†’ ä¾èµ– Layer 1.2 (åŠ¨æ€è¡¨å•), Layer 0.2 (æƒé™)
  â”œâ”€ ä»“åº“ç®¡ç† â†’ ä¾èµ– Layer 2.1, 1.1, 1.2, 1.4
  â””â”€ è®¾å¤‡ç®¡ç† â†’ ä¾èµ– Layer 1.1, 1.2, 1.4

Layer 1: é€šç”¨å¼•æ“
  â”œâ”€ å·¥ä½œæµå¼•æ“
  â”œâ”€ åŠ¨æ€è¡¨å•å¼•æ“
  â”œâ”€ æ™ºèƒ½æ–‡æ¡£å¼•æ“
  â””â”€ å¾…åŠä»»åŠ¡ç³»ç»Ÿ

Layer 0: æ•°æ®åŸºç¡€è®¾æ–½
  â”œâ”€ ç”¨æˆ·ä¸ç»„ç»‡
  â”œâ”€ æƒé™ç®¡ç†
  â”œâ”€ æ–‡æ¡£åˆ†çº§ä½“ç³»
  â”œâ”€ ç¼–å·è§„åˆ™å¼•æ“
  â””â”€ æ–‡ä»¶å­˜å‚¨ (MinIO)
```

---

## ğŸ“‘ å¿«é€Ÿå¯¼èˆª

### ğŸ”¥ Phase A: åŸºç¡€è®¾æ–½å±‚ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰- ç¬¬ä¸€æ‰¹ä¸Šçº¿
| ç« èŠ‚ | æ ‡é¢˜ | è¡Œå· | è¡Œæ•° |
|------|------|------|------|
| Chapter 19 | [åŠ¨æ€è¡¨å•å¼•æ“ä¸è®°å½•ç®¡ç†](#åä¹åŠ¨æ€è¡¨å•å¼•æ“ä¸è®°å½•ç®¡ç†æ ¸å¿ƒæ¶æ„--phase-aåŸºç¡€è®¾æ–½) | 6869 | ~1,600 |
| Chapter 19è¡¥å…… | [æ‰¹æ¬¡è¿½æº¯ç³»ç»Ÿï¼ˆBRCGS æ ¸å¿ƒï¼‰](#åä¹ç« è¡¥å……æ‰¹æ¬¡è¿½æº¯ç³»ç»Ÿbrcgs-æ ¸å¿ƒ--phase-aåŸºç¡€è®¾æ–½) | 8473 | ~360 |
| Chapter 20 | [ç§»åŠ¨ç«¯åº”ç”¨è®¾è®¡ï¼ˆuniappï¼‰](#äºŒåç§»åŠ¨ç«¯åº”ç”¨è®¾è®¡uniapp-è·¨å¹³å°--phase-aåŸºç¡€è®¾æ–½) | 8830 | ~880 |

### âš¡ Phase B: æ ¸å¿ƒç”Ÿäº§æµç¨‹ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰- ç¬¬äºŒæ‰¹ä¸Šçº¿
| ç« èŠ‚ | æ ‡é¢˜ | è¡Œå· | è¡Œæ•° |
|------|------|------|------|
| Chapter 17 | [ä»“åº“ç®¡ç†ç³»ç»Ÿ](#åä¸ƒä»“åº“ç®¡ç†ç³»ç»Ÿç‹¬ç«‹æ¨¡å—--phase-bæ ¸å¿ƒç”Ÿäº§) | 5561 | ~790 |
| Chapter 18 | [è®¾å¤‡ç®¡ç†ç³»ç»Ÿ](#åå…«è®¾å¤‡ç®¡ç†ç³»ç»Ÿç‹¬ç«‹æ¨¡å—--phase-bæ ¸å¿ƒç”Ÿäº§) | 6349 | ~520 |

### ğŸ“Š Phase C: ä½“ç³»ç®¡ç†åŠŸèƒ½ï¼ˆä¸­ç­‰ä¼˜å…ˆçº§ï¼‰- ç¬¬ä¸‰æ‰¹ä¸Šçº¿
| ç« èŠ‚ | æ ‡é¢˜ | è¡Œå· | è¡Œæ•° |
|------|------|------|------|
| Chapter 15 | [åŸ¹è®­ç®¡ç†ç³»ç»Ÿ](#åäº”åŸ¹è®­ç®¡ç†ç³»ç»Ÿç‹¬ç«‹æ¨¡å—--phase-cä½“ç³»ç®¡ç†) | 4142 | ~700 |
| Chapter 16 | [å†…å®¡ç®¡ç†ç³»ç»Ÿ](#åå…­å†…å®¡ç®¡ç†ç³»ç»Ÿç‹¬ç«‹æ¨¡å—--phase-cä½“ç³»ç®¡ç†) | 4843 | ~720 |

### ğŸ“š åŸºç¡€ç« èŠ‚ï¼ˆæ¶æ„ä¸æ ¸å¿ƒåŠŸèƒ½ï¼‰
| ç« èŠ‚ | æ ‡é¢˜ | è¡Œå· | è¡Œæ•° |
|------|------|------|------|
| 1-13 | [åŸºç¡€ç« èŠ‚ï¼šé¡¹ç›®æ¦‚è¿°ã€æŠ€æœ¯æ¶æ„ã€æ•°æ®æ¨¡å‹ç­‰](#ä¸€é¡¹ç›®æ¦‚è¿°) | 63 | ~2,400 |
| Chapter 14 | [æ™ºèƒ½æ–‡æ¡£å¼•æ“ä¸å·¥ä½œæµç³»ç»Ÿ](#åå››æ™ºèƒ½æ–‡æ¡£å¼•æ“ä¸å·¥ä½œæµç³»ç»Ÿv200---prd-01æ•´åˆ) | 2437 | ~1,700 |
| Chapter 21 | [ç³»ç»Ÿè¿ç»´ä¸ç›‘æ§è®¾è®¡](#äºŒåä¸€ç³»ç»Ÿè¿ç»´ä¸ç›‘æ§è®¾è®¡--phase-aåŸºç¡€è®¾æ–½) | 9783 | ~700 |

---

## ğŸš€ ä¸Šçº¿è·¯å¾„è§„åˆ’

### Phase A: åŸºç¡€è®¾æ–½å±‚ï¼ˆInfrastructureï¼‰â­â­â­ æœ€é«˜ä¼˜å…ˆçº§
**ç›®æ ‡ï¼šä¸ºæ‰€æœ‰ä¸šåŠ¡åŠŸèƒ½æ‰“å¥½åœ°åŸº**

- **Chapter 19**: åŠ¨æ€è¡¨å•å¼•æ“ï¼ˆæ ¸å¿ƒæ¶æ„ï¼Œæ‰€æœ‰è®°å½•ç³»ç»Ÿçš„åŸºç¡€ï¼‰- ç¬¬ 6869 è¡Œ
- **Chapter 19è¡¥å……**: æ‰¹æ¬¡è¿½æº¯ç³»ç»Ÿï¼ˆBRCGS è®¤è¯æ ¸å¿ƒè¦æ±‚ï¼‰- ç¬¬ 8473 è¡Œ
- **Chapter 20**: ç§»åŠ¨ç«¯åº”ç”¨æ¶æ„ï¼ˆç°åœºäººå‘˜çš„ä¸»è¦å·¥ä½œç•Œé¢ï¼‰- ç¬¬ 8830 è¡Œ
- **Chapter 21**: ç³»ç»Ÿè¿ç»´ä¸ç›‘æ§è®¾è®¡ï¼ˆå¤‡ä»½ã€ç›‘æ§ã€éƒ¨ç½²ã€å®¡è®¡ï¼‰- ç¬¬ 9783 è¡Œ

### Phase B: æ ¸å¿ƒç”Ÿäº§æµç¨‹ â­â­â­ é«˜ä¼˜å…ˆçº§
**ç›®æ ‡ï¼šæ‰“é€šä»åŸæ–™åˆ°æˆå“çš„å®Œæ•´æµç¨‹**

- **Chapter 17**: ä»“åº“ç®¡ç†ç³»ç»Ÿï¼ˆåŸæ–™ â†’ ç”Ÿäº§ â†’ æˆå“å…¨æµç¨‹ï¼‰- ç¬¬ 5561 è¡Œ
- **Chapter 18**: è®¾å¤‡ç®¡ç†ç³»ç»Ÿï¼ˆç”Ÿäº§è®¾å¤‡ç»´æŠ¤ä¿å…»ï¼‰- ç¬¬ 6349 è¡Œ

### Phase C: ä½“ç³»ç®¡ç†åŠŸèƒ½ â­â­ ä¸­ç­‰ä¼˜å…ˆçº§
**ç›®æ ‡ï¼šå®Œå–„ BRCGS ç®¡ç†ä½“ç³»è¦æ±‚**

- **Chapter 15**: åŸ¹è®­ç®¡ç†ç³»ç»Ÿï¼ˆäººå‘˜èƒ½åŠ›ç®¡ç†ï¼‰- ç¬¬ 4142 è¡Œ
- **Chapter 16**: å†…å®¡ç®¡ç†ç³»ç»Ÿï¼ˆä½“ç³»è‡ªæŸ¥ä¸æ”¹è¿›ï¼‰- ç¬¬ 4843 è¡Œ

### æ¶æ„å†³ç­–
- âœ… **æ‰¹æ¬¡è¿½æº¯è¡¨é‡‡ç”¨ç¡¬ç¼–ç æ–¹å¼**ï¼ˆProductionBatchã€BatchMaterialUsageã€FinishedGoodsBatchï¼‰
- âœ… **åŠ¨æ€è¡¨å•å¼•æ“ä½œä¸ºæ‰©å±•è®°å½•ç³»ç»Ÿ**ï¼ˆç”Ÿäº§å‚æ•°ã€è´¨æ£€æŒ‡æ ‡ã€æ“ä½œç­¾åç­‰ï¼‰
- âœ… **ç¡¬ç¼–ç æ ¸å¿ƒ + åŠ¨æ€è¡¨å•æ‰©å±•**çš„æ··åˆæ¶æ„ï¼Œå…¼é¡¾ç¨³å®šæ€§ä¸çµæ´»æ€§

---

## ğŸ“– å®Œæ•´ç›®å½•

### åŸºç¡€ç« èŠ‚
1. [é¡¹ç›®æ¦‚è¿°](#ä¸€é¡¹ç›®æ¦‚è¿°) - ç¬¬ 63 è¡Œ
2. [æŠ€æœ¯æ¶æ„](#äºŒæŠ€æœ¯æ¶æ„) - ç¬¬ 131 è¡Œ
3. [æ–‡æ¡£åˆ†çº§ä½“ç³»](#ä¸‰æ–‡æ¡£åˆ†çº§ä½“ç³») - ç¬¬ 162 è¡Œ
4. [æ ¸å¿ƒåŠŸèƒ½æ¨¡å—](#å››æ ¸å¿ƒåŠŸèƒ½æ¨¡å—) - ç¬¬ 192 è¡Œ
5. [ä¸šåŠ¡è§„åˆ™](#äº”ä¸šåŠ¡è§„åˆ™) - ç¬¬ 293 è¡Œ
6. [å·¥ç¨‹åŒ–çº¦æŸ](#å…­å·¥ç¨‹åŒ–çº¦æŸ) - ç¬¬ 317 è¡Œ
7. [æ•°æ®æ¨¡å‹](#ä¸ƒæ•°æ®æ¨¡å‹) - ç¬¬ 365 è¡Œ
8. [APIè®¾è®¡](#å…«apiè®¾è®¡) - ç¬¬ 536 è¡Œ
9. [å‰ç«¯è®¾è®¡](#ä¹å‰ç«¯è®¾è®¡) - ç¬¬ 609 è¡Œ
10. [MVP Phase 1-6 æ ¸å¿ƒè®¾è®¡å†³ç­–](#åmvp-phase-1-6-æ ¸å¿ƒè®¾è®¡å†³ç­–) - ç¬¬ 705 è¡Œ
11. [é¡¹ç›®é‡Œç¨‹ç¢‘](#åä¸€é¡¹ç›®é‡Œç¨‹ç¢‘) - ç¬¬ 758 è¡Œ
12. [å¾…è¡¥å……ç»†èŠ‚](#åäºŒå¾…è¡¥å……ç»†èŠ‚) - ç¬¬ 792 è¡Œ
13. [Phase 7-12 æ‰©å±•åŠŸèƒ½è§„åˆ’](#åä¸‰phase-7-12-æ‰©å±•åŠŸèƒ½è§„åˆ’) - ç¬¬ 804 è¡Œ

### åŠŸèƒ½æ¨¡å—ç« èŠ‚ï¼ˆæŒ‰ç« èŠ‚ç¼–å·æ’åºï¼‰
14. [æ™ºèƒ½æ–‡æ¡£å¼•æ“ä¸å·¥ä½œæµç³»ç»Ÿï¼ˆv2.0.0ï¼‰](#åå››æ™ºèƒ½æ–‡æ¡£å¼•æ“ä¸å·¥ä½œæµç³»ç»Ÿv200---prd-01æ•´åˆ) - ç¬¬ 2437 è¡Œ | çº¦ 1,700 è¡Œ
15. [åŸ¹è®­ç®¡ç†ç³»ç»Ÿï¼ˆç‹¬ç«‹æ¨¡å—ï¼‰â­â­ Phase C](#åäº”åŸ¹è®­ç®¡ç†ç³»ç»Ÿç‹¬ç«‹æ¨¡å—--phase-cä½“ç³»ç®¡ç†) - ç¬¬ 4142 è¡Œ | çº¦ 700 è¡Œ
16. [å†…å®¡ç®¡ç†ç³»ç»Ÿï¼ˆç‹¬ç«‹æ¨¡å—ï¼‰â­â­ Phase C](#åå…­å†…å®¡ç®¡ç†ç³»ç»Ÿç‹¬ç«‹æ¨¡å—--phase-cä½“ç³»ç®¡ç†) - ç¬¬ 4843 è¡Œ | çº¦ 720 è¡Œ
17. [ä»“åº“ç®¡ç†ç³»ç»Ÿï¼ˆç‹¬ç«‹æ¨¡å—ï¼‰â­â­â­ Phase B](#åä¸ƒä»“åº“ç®¡ç†ç³»ç»Ÿç‹¬ç«‹æ¨¡å—--phase-bæ ¸å¿ƒç”Ÿäº§) - ç¬¬ 5561 è¡Œ | çº¦ 790 è¡Œ
18. [è®¾å¤‡ç®¡ç†ç³»ç»Ÿï¼ˆç‹¬ç«‹æ¨¡å—ï¼‰â­â­ Phase B](#åå…«è®¾å¤‡ç®¡ç†ç³»ç»Ÿç‹¬ç«‹æ¨¡å—--phase-bæ ¸å¿ƒç”Ÿäº§) - ç¬¬ 6349 è¡Œ | çº¦ 520 è¡Œ
19. [åŠ¨æ€è¡¨å•å¼•æ“ä¸è®°å½•ç®¡ç†ï¼ˆæ ¸å¿ƒæ¶æ„ï¼‰â­â­â­ Phase A](#åä¹åŠ¨æ€è¡¨å•å¼•æ“ä¸è®°å½•ç®¡ç†æ ¸å¿ƒæ¶æ„--phase-aåŸºç¡€è®¾æ–½) - ç¬¬ 6869 è¡Œ | çº¦ 1,600 è¡Œ
    - è¡¥å……ï¼š[æ‰¹æ¬¡è¿½æº¯ç³»ç»Ÿï¼ˆBRCGS æ ¸å¿ƒï¼‰â­â­â­ Phase A](#åä¹ç« è¡¥å……æ‰¹æ¬¡è¿½æº¯ç³»ç»Ÿbrcgs-æ ¸å¿ƒ--phase-aåŸºç¡€è®¾æ–½) - ç¬¬ 8473 è¡Œ | çº¦ 360 è¡Œ
20. [ç§»åŠ¨ç«¯åº”ç”¨è®¾è®¡ï¼ˆuniapp è·¨å¹³å°ï¼‰â­â­â­ Phase A](#äºŒåç§»åŠ¨ç«¯åº”ç”¨è®¾è®¡uniapp-è·¨å¹³å°--phase-aåŸºç¡€è®¾æ–½) - ç¬¬ 8830 è¡Œ | çº¦ 880 è¡Œ
21. [ç³»ç»Ÿè¿ç»´ä¸ç›‘æ§è®¾è®¡â­â­â­ Phase A](#äºŒåä¸€ç³»ç»Ÿè¿ç»´ä¸ç›‘æ§è®¾è®¡--phase-aåŸºç¡€è®¾æ–½) - ç¬¬ 9783 è¡Œ | çº¦ 700 è¡Œ

---

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

[â¬†ï¸ è¿”å›ç›®å½•](#-å®Œæ•´ç›®å½•)

### 1.1 é¡¹ç›®ç›®æ ‡

å»ºç«‹ä¸€ä¸ªä¼ä¸šå†…éƒ¨æ–‡æ¡£ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒï¼š
- å››çº§æ–‡ä»¶ä½“ç³»ç®¡ç†ï¼ˆä¸€çº§/äºŒçº§/ä¸‰çº§/å››çº§ï¼‰
- æ–‡æ¡£ä¸Šä¼ ã€å®¡æ‰¹ã€ç‰ˆæœ¬ç®¡ç†
- å››çº§æ–‡ä»¶æ¨¡æ¿åˆ›å»ºä¸ä»»åŠ¡åˆ†å‘
- ç”¨æˆ·ä¸æƒé™ç®¡ç†

### 1.2 æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|------|
| å‰ç«¯ | Vue 3 + Element Plus + Vite + Pinia | ^3.4.0 / ^2.5.0 / ^5.0.0 / ^2.1.0 | ä¸Šæ‰‹ç®€å•ï¼Œç”Ÿæ€ä¸°å¯Œ |
| åç«¯ | Node.js + NestJS + TypeScript + Prisma | 18.x / ^10.0.0 / ^5.3.0 / ^5.7.0 | ä¼ä¸šçº§æ¡†æ¶ï¼Œç¨³å®š |
| æ•°æ®åº“ | PostgreSQL + Redis | >=15.0 / >=7.0 | JSONæ”¯æŒå¥½ï¼Œé€‚åˆåŠ¨æ€è¡¨å• |
| æ–‡ä»¶å­˜å‚¨ | MinIO | Latest | æœ¬åœ°éƒ¨ç½²ï¼Œæ•°æ®è‡ªä¸»å¯æ§ |
| éƒ¨ç½² | Docker + Docker Compose | >=24.0 / >=2.20 | ç¯å¢ƒä¸€è‡´ï¼Œä¸å‡ºé”™ |
| å…±äº« | TypeScript ç±»å‹å®šä¹‰ | packages/types | å‰åç«¯ç±»å‹å…±äº« |

### 1.3 ç›®å½•ç»“æ„

```
noidear/
â”œâ”€â”€ client/                    # å‰ç«¯ Vue 3 é¡¹ç›®
â”‚   â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ public/
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ server/                    # åç«¯ NestJS é¡¹ç›®
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ modules/          # æŒ‰åŸŸåˆ†æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ auth/         # è®¤è¯æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ user/         # ç”¨æˆ·æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ department/   # éƒ¨é—¨æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ document/     # æ–‡æ¡£æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ template/     # æ¨¡æ¿æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ task/         # ä»»åŠ¡æ¨¡å—
â”‚   â”‚   â”‚   â””â”€â”€ approval/     # å®¡æ‰¹æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ common/           # å…¬å…±æ¨¡å—
â”‚   â”‚   â””â”€â”€ prisma/           # æ•°æ®åº“æ¨¡å‹
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ packages/                  # å…±äº«åŒ…
â”‚   â””â”€â”€ types/                 # TypeScript ç±»å‹å®šä¹‰
â”‚       â”œâ”€â”€ index.ts           # å¯¼å‡ºæ‰€æœ‰ç±»å‹
â”‚       â”œâ”€â”€ user.ts            # ç”¨æˆ·ç›¸å…³ç±»å‹
â”‚       â”œâ”€â”€ document.ts        # æ–‡æ¡£ç›¸å…³ç±»å‹
â”‚       â”œâ”€â”€ template.ts        # æ¨¡æ¿ç›¸å…³ç±»å‹
â”‚       â”œâ”€â”€ task.ts            # ä»»åŠ¡ç›¸å…³ç±»å‹
â”‚       â””â”€â”€ api.ts             # API å“åº”ç±»å‹
â”œâ”€â”€ docker-compose.yml         # å¼€å‘ç¯å¢ƒ Docker é…ç½®
â”œâ”€â”€ docker-compose.prod.yml    # ç”Ÿäº§ç¯å¢ƒ Docker é…ç½®
â”œâ”€â”€ data/                      # æ•°æ®æŒä¹…åŒ–ç›®å½•
â”‚   â”œâ”€â”€ postgres/              # PostgreSQL æ•°æ®
â”‚   â””â”€â”€ minio/                 # MinIO æ•°æ®
â””â”€â”€ uploads/                   # æœ¬åœ°ä¸´æ—¶æ–‡ä»¶ç›®å½•
```

### 1.4 æ•°æ®åº“

- æ•°æ®åº“åç§°: `document_system`
- ä¸»é”®ç±»å‹: é›ªèŠ±IDï¼ˆSnowflake IDï¼‰
- è½¯åˆ é™¤: `deleted_at` å­—æ®µï¼ˆdatetimeï¼‰
- äº‹åŠ¡: åˆ›å»ºæ–‡ä»¶æ—¶ä½¿ç”¨ï¼ˆç¼–å·+è®°å½•ä¸€èµ·æˆåŠŸæˆ–å¤±è´¥ï¼‰
- å¹¶å‘: ä»»åŠ¡æäº¤åŠ é”ï¼Œæ•°æ®åº“äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§

---

## äºŒã€æŠ€æœ¯æ¶æ„

[â¬†ï¸ è¿”å›ç›®å½•](#-å®Œæ•´ç›®å½•)

### 2.1 å¼€å‘ç¯å¢ƒ

| æœåŠ¡ | ç«¯å£ | è¯´æ˜ |
|------|------|------|
| PostgreSQL | 5432 | ä¸»æ•°æ®åº“ |
| Redis | 6379 | ç¼“å­˜ |
| MinIO | 9000 | å¯¹è±¡å­˜å‚¨ |
| MinIO Console | 9001 | ç®¡ç†ç•Œé¢ |
| NestJS | 3000 | åç«¯API |
| Vue Dev | 5173 | å‰ç«¯å¼€å‘ |

### 2.2 éƒ¨ç½²æ–¹æ¡ˆ

- å¼€å‘ç¯å¢ƒ: Docker Compose
- Docker é…ç½®: åˆ†å¼€ä¸¤ä»½ï¼ˆdev/prodï¼‰
- æ–‡ä»¶å­˜å‚¨: MinIOï¼ŒæŒ‰éƒ¨é—¨åˆ†æ¡¶
- è®¿é—®æ–¹å¼: VPN + å†…ç½‘
- HTTPS: æš‚æ—¶ä¸éœ€è¦ï¼Œå…¬ç½‘è®¿é—®æ—¶å†åŠ 

### 2.3 å®‰å…¨é…ç½®

- å¯†ç åŠ å¯†: bcryptï¼ˆè‡ªåŠ¨åŠ ç›ï¼‰
- ç™»å½•é”å®š: 5æ¬¡å¤±è´¥é”å®šè´¦å·
- Token: Header ä¼ é€’ `Authorization: Bearer xxx`
- éªŒè¯ç : ä¸éœ€è¦ï¼ˆMVPé˜¶æ®µï¼‰
- æ¥å£é™æµ: ä¸é™æµ

---

## ä¸‰ã€æ–‡æ¡£åˆ†çº§ä½“ç³»

[â¬†ï¸ è¿”å›ç›®å½•](#-å®Œæ•´ç›®å½•)

### 3.1 å››çº§æ–‡ä»¶å®šä¹‰

| çº§åˆ« | æ–‡ä»¶ç±»å‹ | è¯´æ˜ | ä¸Šä¼ /åˆ›å»ºæ–¹å¼ | å®¡æ‰¹æµç¨‹ |
|------|----------|------|---------------|----------|
| ä¸€çº§ | ç®¡ç†æ‰‹å†Œ | è´¨é‡æ–¹é’ˆã€ç›®æ ‡ | ä¸Šä¼ æ–‡ä»¶ï¼ˆPDF/Word/Excelï¼‰ | ä¸Šä¼ â†’æäº¤å®¡æ‰¹â†’é€šè¿‡â†’å‘å¸ƒ |
| äºŒçº§ | ç¨‹åºæ–‡ä»¶ | ç®¡ç†åˆ¶åº¦ã€æµç¨‹ | ä¸Šä¼ æ–‡ä»¶ï¼ˆPDF/Word/Excelï¼‰ | ä¸Šä¼ â†’æäº¤å®¡æ‰¹â†’é€šè¿‡â†’å‘å¸ƒ |
| ä¸‰çº§ | ä½œä¸šæŒ‡å¯¼ä¹¦ | æ“ä½œè§„èŒƒã€æ ‡å‡† | ä¸Šä¼ æ–‡ä»¶ï¼ˆPDF/Word/Excelï¼‰ | ä¸Šä¼ â†’æäº¤å®¡æ‰¹â†’é€šè¿‡â†’å‘å¸ƒ |
| å››çº§ | è®°å½•è¡¨å• | å¡«å†™è®°å½•ã€è¯æ® | åˆ›å»ºè¡¨å•æ¨¡æ¿ | åˆ›å»ºæ¨¡æ¿â†’å‘å¸ƒâ†’ä»»åŠ¡åˆ†å‘â†’å¡«å†™â†’å®¡æ‰¹ |

### 3.2 ç¼–å·è§„åˆ™

**ç¼–å·æ ¼å¼**: `{çº§åˆ«}-{éƒ¨é—¨ä»£ç }-{åºå·}`

ç¤ºä¾‹:
```
1-RD-001    ï¼ˆä¸€çº§æ–‡ä»¶ï¼‰
2-RD-001    ï¼ˆäºŒçº§æ–‡ä»¶ï¼‰
3-RD-001    ï¼ˆä¸‰çº§æ–‡ä»¶ï¼‰
4-RD-001    ï¼ˆå››çº§æ–‡ä»¶ï¼‰
```

**è§„åˆ™**:
- æ–‡ä»¶ç¼–å·ç”Ÿæˆåä¸èƒ½ä¿®æ”¹
- ç¼–å·åˆ é™¤åè®°å½•å¾…è¡¥é½ï¼Œä¸‹æ¬¡æ–°å»ºæ—¶ä¼˜å…ˆä½¿ç”¨
- ä¸åŒçº§åˆ«çš„æ–‡ä»¶ä½¿ç”¨ä¸åŒçš„ç¼–å·åºåˆ—

---

## å››ã€æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

[â¬†ï¸ è¿”å›ç›®å½•](#-å®Œæ•´ç›®å½•)

### 4.1 ç”¨æˆ·ç®¡ç†

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| ç”¨æˆ·åˆ—è¡¨ | æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ· |
| æ–°å¢ç”¨æˆ· | æ‰‹åŠ¨æ·»åŠ  |
| ç¼–è¾‘ç”¨æˆ· | ä¿®æ”¹ä¿¡æ¯ã€çŠ¶æ€ã€éƒ¨é—¨ |
| åˆ é™¤ç”¨æˆ· | è½¯åˆ é™¤ï¼ˆdeleted_atï¼‰ |
| ä¿®æ”¹å¯†ç  | ç”¨æˆ·å¯ä¿®æ”¹è‡ªå·±çš„å¯†ç  |
| æ‰¹é‡å¯¼å…¥ | MVPä¸æ”¯æŒ |

**ç”¨æˆ·çŠ¶æ€**: å¯ç”¨/ç¦ç”¨

### 4.2 ç»„ç»‡æ¶æ„

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| éƒ¨é—¨åˆ—è¡¨ | æŸ¥çœ‹æ‰€æœ‰éƒ¨é—¨ |
| æ–°å¢éƒ¨é—¨ | æ”¯æŒ2çº§ï¼ˆå…¬å¸â†’éƒ¨é—¨ï¼‰ |
| ç¼–è¾‘éƒ¨é—¨ | ä¿®æ”¹åç§°ã€ä¸Šçº§éƒ¨é—¨ |
| åˆ é™¤éƒ¨é—¨ | æ£€æŸ¥ååˆ é™¤ï¼ˆæœ‰æ–‡ä»¶æ—¶æç¤ºï¼‰ |
| åœç”¨éƒ¨é—¨ | ç”¨æˆ·è½¬æ— éƒ¨é—¨çŠ¶æ€ |

**è§„åˆ™**:
- ä¸€äººåªèƒ½å±ä¸€ä¸ªéƒ¨é—¨
- ä¸€äººåªèƒ½æœ‰ä¸€ä¸ªä¸Šçº§
- éƒ¨é—¨åœç”¨åç”¨æˆ·è½¬"æ— éƒ¨é—¨"

### 4.3 æ–‡ä»¶ç®¡ç†

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| æ–‡ä»¶ä¸Šä¼  | æ”¯æŒæ‹–æ‹½ã€æ‰¹é‡ä¸Šä¼  |
| æ–‡ä»¶åˆ—è¡¨ | æ˜¾ç¤ºç¼–å·ã€åç§°ã€çŠ¶æ€ã€åˆ›å»ºäººã€åˆ›å»ºæ—¶é—´ |
| æ–‡ä»¶æœç´¢ | æ”¯æŒåç§°å’Œç¼–å·æœç´¢ |
| æ–‡ä»¶æ’åº | æ”¯æŒåˆ›å»ºæ—¶é—´ã€ç¼–å·æ’åº |
| æ–‡ä»¶åˆ é™¤ | è‰ç¨¿/å¾…å®¡æ‰¹å¯åˆ ï¼›å·²å‘å¸ƒä¸èƒ½åˆ é™¤åªèƒ½åœç”¨ï¼›åœç”¨åå¯å½»åº•åˆ é™¤ |
| æ–‡ä»¶ä¸‹è½½ | æœ‰æƒé™æ‰èƒ½ä¸‹è½½ |
| ç‰ˆæœ¬ç®¡ç† | ä¿®æ”¹åè‡ªåŠ¨+ç‰ˆæœ¬å·ï¼Œæ—§ç‰ˆæœ¬å¯æŸ¥çœ‹ä½†ä¸èƒ½ä¸‹è½½ï¼ŒMVPä¸æ”¯æŒå›æ»š |

**æ–‡ä»¶ç±»å‹**: PDFã€Wordã€Excel
**æ–‡ä»¶å¤§å°é™åˆ¶**: 10MB
**æ–‡ä»¶å**: éœ€è¦å¡«å†™ï¼Œå¯é‡å¤æ—¶æç¤ºç”¨æˆ·ä¿®æ”¹

### 4.4 å®¡æ‰¹æµç¨‹

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| æäº¤å®¡æ‰¹ | ä¸Šä¼ æ–‡ä»¶åæäº¤ |
| å®¡æ‰¹æ“ä½œ | é€šè¿‡ï¼ˆé€‰å¡«æ„è§ï¼‰/ é©³å›ï¼ˆå¿…å¡«æ„è§ï¼‰ |
| å®¡æ‰¹å†å² | èƒ½æŸ¥çœ‹è‡ªå·±å®¡æ‰¹è¿‡çš„æ–‡ä»¶ |
| æ„è§å¯è§ | ä¾æ¬¡å®¡æ‰¹æ—¶èƒ½çœ‹åˆ°å‰é¢äººçš„æ„è§ |
| é©³å›å¤„ç† | é©³å›åçŠ¶æ€å˜"è‰ç¨¿"ï¼Œä¿®æ”¹åé‡æ–°æäº¤ |

**å®¡æ‰¹äººç¡®å®š**: ä»ç”¨æˆ·çš„ä¸Šçº§ä¸­é€‰æ‹©ï¼ˆç”¨æˆ·å¿…é¡»æœ‰ä¸Šçº§ï¼‰
**ä¼šç­¾**: æ”¯æŒå¤šäººåŒæ—¶å®¡æ‰¹ï¼ˆéœ€å…¨éƒ¨é€šè¿‡ï¼‰
**ä¾æ¬¡å®¡æ‰¹**: æ”¯æŒä¸€äººå®¡æ‰¹åä¸‹ä¸€äººå®¡æ‰¹
**å…œåº•**: Adminå¯ä»¥å®¡æ‰¹ä»»ä½•æ–‡ä»¶

### 4.5 å››çº§æ¨¡æ¿ç®¡ç†

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| æ¨¡æ¿åˆ›å»º | Excelä¸Šä¼ è§£æ / æ‰‹åŠ¨åˆ›å»º |
| æ¨¡æ¿å­—æ®µ | æ–‡æœ¬ã€é•¿æ–‡æœ¬ã€æ•°å€¼ã€æ—¥æœŸã€ä¸‹æ‹‰ã€æ˜¯/å¦ |
| å­—æ®µæ’åº | æ”¯æŒæ‹–æ‹½æ’åº |
| å­—æ®µé»˜è®¤å€¼ | æ”¯æŒè®¾ç½®é»˜è®¤å€¼ |
| æ¨¡æ¿å¤åˆ¶ | æ”¯æŒå¤åˆ¶æ¨¡æ¿ |
| æ¨¡æ¿åˆ—è¡¨ | æ˜¾ç¤ºç¼–å·ã€åç§°ã€ç‰ˆæœ¬ã€åˆ›å»ºäººã€åˆ›å»ºæ—¶é—´ |
| æ¨¡æ¿ç­›é€‰ | æ”¯æŒç­›é€‰ |
| æ¨¡æ¿åœç”¨ | åœç”¨åå·²åˆ†å‘ä»»åŠ¡ä¸å—å½±å“ |
| æ¨¡æ¿åˆ é™¤ | æ”¯æŒåˆ é™¤ |

### 4.6 ä»»åŠ¡åˆ†å‘

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| ä»»åŠ¡åˆ†å‘ | å‘ç»™éƒ¨é—¨ï¼Œéƒ¨é—¨å†…äººäººéƒ½èƒ½çœ‹åˆ° |
| ä»»åŠ¡åˆ—è¡¨ | æ˜¾ç¤ºæ¨¡æ¿åç§°ã€æ‰§è¡Œäººã€æˆªæ­¢æ—¶é—´ã€çŠ¶æ€ |
| ä»»åŠ¡ç­›é€‰ | Tabsåˆ‡æ¢ï¼ˆå…¨éƒ¨/å¾…å®Œæˆ/å·²å®Œæˆï¼‰ |
| ä»»åŠ¡å¡«å†™ | éƒ¨é—¨å†…ä»»æ„ä¸€äººå¡«å†™ |
| ä»»åŠ¡æäº¤ | ç¬¬ä¸€äººæäº¤åé”å®šï¼Œä¸èƒ½ä¿®æ”¹ |
| ä»»åŠ¡å–æ¶ˆ | å‘èµ·äººå¯ä»¥å–æ¶ˆä»»åŠ¡ |
| ä»»åŠ¡è½¬å‘ | ä¸æ”¯æŒ |
| é€¾æœŸæ ‡è®° | çº¢è‰²æ ‡è®° |

**æˆªæ­¢æ—¥æœŸ**: å¿…å¡«ï¼Œè¿‡æœŸç«™å†…æ¶ˆæ¯æé†’
**æ‰§è¡Œè§„åˆ™**: éƒ¨é—¨å†…ä»»æ„ä¸€äººéƒ½å¯ä»¥å¡«å†™ï¼Œç¬¬ä¸€äººæäº¤åé”å®š

### 4.7 ç«™å†…æ¶ˆæ¯

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| æ¶ˆæ¯ç±»å‹ | ä»»åŠ¡é€šçŸ¥ã€å®¡æ‰¹é€šçŸ¥ã€é€¾æœŸæé†’ |
| å·²è¯»çŠ¶æ€ | æ˜¾ç¤ºå·²è¯»/æœªè¯» |
| æ¶ˆæ¯ä¿ç•™ | 30å¤©è‡ªåŠ¨æ¸…ç† |

---

## äº”ã€ä¸šåŠ¡è§„åˆ™

[â¬†ï¸ è¿”å›ç›®å½•](#-å®Œæ•´ç›®å½•)

| è§„åˆ™ç¼–å· | è§„åˆ™æè¿° |
|---------|----------|
| BR-001 | ç¼–å·è§„åˆ™é…ç½®åï¼Œæ–°æ–‡ä»¶è‡ªåŠ¨æŒ‰è§„åˆ™ç”Ÿæˆæ–‡ä»¶ç¼–å· |
| BR-002 | ä¸€çº§/äºŒçº§/ä¸‰çº§æ–‡ä»¶åˆ›å»ºåå¿…é¡»æäº¤å®¡æ‰¹ï¼Œä¸å®¡æ‰¹ä¸å¯å‘å¸ƒ |
| BR-003 | å››çº§æ–‡ä»¶ï¼ˆæ¨¡æ¿ï¼‰åˆ›å»ºåç›´æ¥å‘å¸ƒï¼Œæ— éœ€å®¡æ‰¹ |
| BR-004 | å››çº§æ–‡ä»¶ï¼ˆè®°å½•ï¼‰å¡«å†™åæäº¤å®¡æ‰¹ï¼Œå®¡æ‰¹é€šè¿‡åå½’æ¡£ |
| BR-005 | æ¨¡æ¿åœç”¨åï¼Œä¸å¯å†æ–°å»ºæ•°æ®ï¼Œå†å²æ•°æ®å¯æŸ¥è¯¢ |
| BR-006 | æ–‡ä»¶æäº¤åä¸å…è®¸ä¿®æ”¹ï¼Œåªèƒ½æŸ¥çœ‹æˆ–æ’¤å› |
| BR-007 | æ–‡ä»¶åç§°åŒçº§åˆ«å†…ä¸å¯é‡å¤ |
| BR-008 | ç¼–å·åˆ é™¤åï¼Œç³»ç»Ÿè®°å½•å¾…è¡¥é½ç¼–å·ï¼Œä¸‹æ¬¡æ–°å»ºæ—¶ä¼˜å…ˆä½¿ç”¨ |
| BR-009 | ä»»åŠ¡å¿…é¡»æŒ‡å®šæ‰§è¡Œäººï¼Œå¦åˆ™æ— æ³•åˆ†å‘ |
| BR-010 | å½’æ¡£åçš„æ•°æ®ä¸å¯ä¿®æ”¹ï¼Œåªèƒ½æŸ¥çœ‹ |
| BR-011 | ä¸åŒçº§åˆ«çš„æ–‡ä»¶ä½¿ç”¨ä¸åŒçš„ç¼–å·åºåˆ— |
| BR-012 | å®¡æ‰¹é©³å›æ—¶å¿…é¡»å¡«å†™é©³å›åŸå›  |
| BR-013 | æ–‡ä»¶ä¿®æ”¹åè‡ªåŠ¨+ç‰ˆæœ¬å·ï¼ˆ1.0â†’1.1â†’1.2ï¼‰ |
| BR-014 | ä»»åŠ¡ç¬¬ä¸€äººæäº¤åï¼Œå…¶ä»–äººä¸èƒ½å†æäº¤ï¼Œåªèƒ½æŸ¥çœ‹ |
| BR-014a | ä»»åŠ¡å‘ç»™éƒ¨é—¨ï¼Œéƒ¨é—¨å†…ä»»æ„ä¸€äººéƒ½å¯å¡«å†™ |
| BR-015 | ç”¨æˆ·åå”¯ä¸€ï¼Œè‹±æ–‡+æ•°å­—ï¼Œæœ€å°3ä½ |
| BR-016 | å¯†ç æœ€å°8ä½ï¼Œæ— éœ€å¤æ‚åº¦å’Œç‰¹æ®Šå­—ç¬¦ |
| **BR-017 (P0-3 ä¿®å¤)** | **è´¨é‡éƒ¨å’Œç®¡ç†å±‚æ‹¥æœ‰ viewAllRecords æƒé™ï¼Œå¯è·¨éƒ¨é—¨æŸ¥çœ‹æ‰€æœ‰è®°å½•** |
| **BR-018 (P0-3 ä¿®å¤)** | **è´¨é‡éƒ¨å’Œç®¡ç†å±‚æ‹¥æœ‰ MODIFY_APPROVED_RECORD æƒé™ï¼Œå¯ä¿®æ”¹å·²å®¡æ‰¹è®°å½•** |
| **BR-019 (P0-3 ä¿®å¤)** | **æ™®é€šå‘˜å·¥åªèƒ½æŸ¥çœ‹æœ¬éƒ¨é—¨åˆ›å»ºçš„è®°å½•ï¼Œä¸å¯è·¨éƒ¨é—¨æŸ¥çœ‹** |

---

## å…­ã€å·¥ç¨‹åŒ–çº¦æŸ

[â¬†ï¸ è¿”å›ç›®å½•](#-å®Œæ•´ç›®å½•)

> **ç›®çš„**ï¼šé˜²æ­¢AIä¹±å‘æŒ¥ï¼Œç¡®ä¿æ¨¡å—ç‹¬ç«‹ã€å¯ç»´æŠ¤
> **é€‚ç”¨èŒƒå›´**ï¼šæ‰€æœ‰å¼€å‘è€…/AI Agent

### 6.1 æ¨¡å—åŒ–çº¦æŸ

| çº¦æŸ | è¯´æ˜ | è¿è§„å¤„ç† |
|------|------|----------|
| **æ¨¡å—ç‹¬ç«‹** | æ–°å¢æ¨¡å—ä¸ä¿®æ”¹ç°æœ‰æ¨¡å—ä»£ç  | é‡æ„åˆ°ç‹¬ç«‹æ¨¡å— |
| **APIç¨³å®š** | ç°æœ‰APIç«¯ç‚¹ä¸å˜ | ç¦æ­¢ä¿®æ”¹å·²æœ‰API |
| **æ•°æ®åº“éš”ç¦»** | æ–°åŠŸèƒ½æ–°å»ºè¡¨ï¼Œä¸æ”¹ç°æœ‰è¡¨ç»“æ„ | ç¦æ­¢ä¿®æ”¹ç°æœ‰è¡¨ |
| **ç»„ä»¶å¤ç”¨** | ç›¸åŒUIå¿…é¡»æå–åˆ°components/ | ç¦æ­¢é‡å¤å®ç° |

### 6.2 ä»£ç è§„èŒƒçº¦æŸ

| çº¦æŸ | è¦æ±‚ | æ¥æº |
|------|------|------|
| å‡½æ•°é•¿åº¦ | < 50è¡Œ | Good Taste |
| ç¼©è¿›å±‚æ•° | < 3å±‚ | Good Taste |
| å‘åå…¼å®¹ | ä¸ç ´åç°æœ‰åŠŸèƒ½ | Never break userspace |
| å¼‚å¸¸å¤„ç† | æ‰€æœ‰APIå¿…é¡»æœ‰try-catch | å®‰å…¨è§„èŒƒ |

### 6.3 æ–°å¢æ¨¡å—æ­¥éª¤

> ä»¥ä¸‹æ­¥éª¤ä¸ºAI/å¼€å‘è€…å¿…é¡»éµå®ˆ

```
1. å‰ç«¯ï¼šåœ¨ views/ æ–°å»ºæ¨¡å—ç›®å½•
2. å‰ç«¯ï¼šåœ¨ api/ æ–°å»ºæ¨¡å—APIæ–‡ä»¶
3. åç«¯ï¼šåœ¨ modules/ æ–°å»ºæ¨¡å—ç›®å½•
4. åç«¯ï¼šåœ¨ prisma/schema.prisma æ–°å¢æ¨¡å‹ï¼ˆç¦æ­¢ä¿®æ”¹ç°æœ‰æ¨¡å‹ï¼‰
5. è·¯ç”±ï¼šåœ¨ router/index.js æ·»åŠ è·¯ç”±
6. èœå•ï¼šæ ¹æ®è§’è‰²åŠ¨æ€æ˜¾ç¤ºï¼ˆé…ç½®æ–‡ä»¶æ§åˆ¶ï¼‰
```

### 6.4 ç¦æ­¢è¡Œä¸ºæ¸…å•

- âŒ å¼•å…¥æœªåœ¨æŠ€æœ¯æ ˆæ¸…å•ä¸­çš„åº“
- âŒ æ›´æ¢æ¡†æ¶ï¼ˆVue 3 â†’ Reactï¼‰
- âŒ ä¿®æ”¹é¡¹ç›®ç›®å½•ç»“æ„
- âŒ ç¡¬ç¼–ç å¯†ç /å¯†é’¥
- âŒ ä½¿ç”¨è£¸SQLï¼ˆå¿…é¡»ç”¨Prismaï¼‰
- âŒ ä¿®æ”¹ç°æœ‰APIç«¯ç‚¹
- âŒ æ·»åŠ MVPèŒƒå›´å¤–åŠŸèƒ½

---

## ä¸ƒã€æ•°æ®æ¨¡å‹

[â¬†ï¸ è¿”å›ç›®å½•](#-å®Œæ•´ç›®å½•)

### 6.1 æ ¸å¿ƒè¡¨

```sql
-- ç”¨æˆ·è¡¨
users (
  id              SnowflakeID   PRIMARY KEY,
  username        VARCHAR(50)   UNIQUE NOT NULL,    -- ç”¨æˆ·åï¼ˆè‹±æ–‡+æ•°å­—ï¼‰
  password        VARCHAR(255)  NOT NULL,           -- bcryptåŠ å¯†
  name            VARCHAR(100)  NOT NULL,           -- å§“å
  department_id   SnowflakeID   REFERENCES departments(id),
  role            VARCHAR(20)   NOT NULL DEFAULT 'user',  -- user/leader/admin
  superior_id     SnowflakeID   REFERENCES users(id),     -- ä¸Šçº§ID
  status          VARCHAR(10)   NOT NULL DEFAULT 'active', -- active/inactive
  login_attempts  INT           DEFAULT 0,               -- ç™»å½•å¤±è´¥æ¬¡æ•°
  locked_until    TIMESTAMP,                            -- é”å®šæˆªæ­¢æ—¶é—´
  created_at      TIMESTAMP   DEFAULT NOW(),
  updated_at      TIMESTAMP   DEFAULT NOW(),
  deleted_at      TIMESTAMP                              -- è½¯åˆ é™¤
);

-- P0-3 ä¿®å¤ï¼šæƒé™è¡¨ï¼ˆç»†ç²’åº¦æƒé™æ§åˆ¶ï¼‰
permissions (
  id          SnowflakeID   PRIMARY KEY,
  code        VARCHAR(50)   UNIQUE NOT NULL,     -- æƒé™ä»£ç ï¼ˆå¦‚ viewAllRecordsï¼‰
  name        VARCHAR(100)  NOT NULL,            -- æƒé™åç§°
  description VARCHAR(500),                       -- æƒé™è¯´æ˜
  category    VARCHAR(50)   NOT NULL,            -- æƒé™åˆ†ç±»ï¼ˆdocument/record/approval/systemï¼‰
  created_at  TIMESTAMP   DEFAULT NOW(),
  updated_at  TIMESTAMP   DEFAULT NOW()
);

-- P0-3 ä¿®å¤ï¼šç”¨æˆ·æƒé™å…³è”è¡¨
user_permissions (
  id            SnowflakeID   PRIMARY KEY,
  user_id       SnowflakeID   REFERENCES users(id) ON DELETE CASCADE,
  permission_id SnowflakeID   REFERENCES permissions(id) ON DELETE CASCADE,
  granted_by    SnowflakeID   REFERENCES users(id),      -- æˆæƒäºº
  granted_at    TIMESTAMP   DEFAULT NOW(),

  UNIQUE(user_id, permission_id)
);

-- éƒ¨é—¨è¡¨
departments (
  id          SnowflakeID   PRIMARY KEY,
  code        VARCHAR(20)   UNIQUE NOT NULL,    -- éƒ¨é—¨ä»£ç 
  name        VARCHAR(100)  NOT NULL,           -- éƒ¨é—¨åç§°
  parent_id   SnowflakeID   REFERENCES departments(id),  -- ä¸Šçº§éƒ¨é—¨
  manager_id  VARCHAR(32)   REFERENCES users(id),        -- éƒ¨é—¨è´Ÿè´£äººï¼ˆå¯ä¸ºç©ºï¼‰
  status      VARCHAR(10)   NOT NULL DEFAULT 'active',   -- active/inactive
  created_at  TIMESTAMP   DEFAULT NOW(),
  updated_at  TIMESTAMP   DEFAULT NOW(),
  deleted_at  TIMESTAMP                              -- è½¯åˆ é™¤
);

-- ç¼–å·è§„åˆ™è¡¨
number_rules (
  id              SnowflakeID   PRIMARY KEY,
  level           INT           NOT NULL,        -- 1/2/3/4çº§
  department_id   SnowflakeID   REFERENCES departments(id),
  sequence        INT           NOT NULL DEFAULT 0,  -- å½“å‰åºå·
  created_at      TIMESTAMP   DEFAULT NOW(),
  updated_at      TIMESTAMP   DEFAULT NOW()
);

-- æ–‡æ¡£æ–‡ä»¶è¡¨ï¼ˆä¸€/äºŒ/ä¸‰çº§ï¼‰
documents (
  id          SnowflakeID   PRIMARY KEY,
  level       INT           NOT NULL,            -- 1/2/3çº§
  number      VARCHAR(50)   UNIQUE NOT NULL,     -- æ–‡ä»¶ç¼–å·
  title       VARCHAR(200)  NOT NULL,            -- æ–‡ä»¶æ ‡é¢˜
  file_path   VARCHAR(500)  NOT NULL,            -- MinIOè·¯å¾„
  file_name   VARCHAR(200)  NOT NULL,            -- åŸå§‹æ–‡ä»¶å
  file_size   BIGINT        NOT NULL,            -- æ–‡ä»¶å¤§å°
  file_type   VARCHAR(50)   NOT NULL,            -- æ–‡ä»¶ç±»å‹
  version     DECIMAL(3,1)  NOT NULL DEFAULT 1.0, -- ç‰ˆæœ¬å·
  status      VARCHAR(20)   NOT NULL,            -- draft/under_review/approved/current/archived/obsolete
  creator_id  SnowflakeID   REFERENCES users(id),
  approver_id SnowflakeID   REFERENCES users(id),    -- å®¡æ‰¹äºº
  approved_at TIMESTAMP,                              -- å®¡æ‰¹æ—¶é—´

  -- P0-1 ä¿®å¤ï¼šæ–‡æ¡£å½’æ¡£/ä½œåºŸæµç¨‹
  archive_reason    VARCHAR(500),                     -- å½’æ¡£/ä½œåºŸåŸå› 
  archived_at       TIMESTAMP,                        -- å½’æ¡£æ—¶é—´
  archived_by       SnowflakeID   REFERENCES users(id), -- å½’æ¡£äºº
  obsolete_reason   VARCHAR(500),                     -- ä½œåºŸåŸå› 
  obsoleted_at      TIMESTAMP,                        -- ä½œåºŸæ—¶é—´
  obsoleted_by      SnowflakeID   REFERENCES users(id), -- ä½œåºŸäºº

  created_at  TIMESTAMP   DEFAULT NOW(),
  updated_at  TIMESTAMP   DEFAULT NOW(),
  deleted_at  TIMESTAMP                              -- è½¯åˆ é™¤
);

-- æ–‡æ¡£ç‰ˆæœ¬å†å²è¡¨
document_versions (
  id          SnowflakeID   PRIMARY KEY,
  document_id SnowflakeID   REFERENCES documents(id),
  version     DECIMAL(3,1)  NOT NULL,
  file_path   VARCHAR(500)  NOT NULL,
  file_name   VARCHAR(200)  NOT NULL,
  file_size   BIGINT        NOT NULL,
  creator_id  SnowflakeID   REFERENCES users(id),
  created_at  TIMESTAMP   DEFAULT NOW()
);

-- æ¨¡æ¿è¡¨ï¼ˆå››çº§ï¼‰
templates (
  id          SnowflakeID   PRIMARY KEY,
  level       INT           NOT NULL DEFAULT 4,
  number      VARCHAR(50)   UNIQUE NOT NULL,
  title       VARCHAR(200)  NOT NULL,
  fields_json JSONB         NOT NULL,            -- å­—æ®µé…ç½®
  version     DECIMAL(3,1)  NOT NULL DEFAULT 1.0,
  status      VARCHAR(20)   NOT NULL DEFAULT 'active', -- active/inactive
  creator_id  SnowflakeID   REFERENCES users(id),
  created_at  TIMESTAMP   DEFAULT NOW(),
  updated_at  TIMESTAMP   DEFAULT NOW(),
  deleted_at  TIMESTAMP                              -- è½¯åˆ é™¤
);

-- ä»»åŠ¡è¡¨
tasks (
  id          SnowflakeID   PRIMARY KEY,
  template_id SnowflakeID   REFERENCES templates(id),
  department_id SnowflakeID REFERENCES departments(id), -- æ‰§è¡Œéƒ¨é—¨
  deadline    TIMESTAMP   NOT NULL,            -- æˆªæ­¢æ—¥æœŸ
  status      VARCHAR(20)  NOT NULL DEFAULT 'pending', -- pending/completed/cancelled
  creator_id  SnowflakeID   REFERENCES users(id),       -- åˆ†å‘äºº
  created_at  TIMESTAMP   DEFAULT NOW(),
  updated_at  TIMESTAMP   DEFAULT NOW(),
  deleted_at  TIMESTAMP                              -- è½¯åˆ é™¤
);

-- ä»»åŠ¡è®°å½•è¡¨ï¼ˆå››çº§å¡«å†™ï¼‰
task_records (
  id          SnowflakeID   PRIMARY KEY,
  task_id     SnowflakeID   REFERENCES tasks(id),
  template_id SnowflakeID   REFERENCES templates(id),
  data_json   JSONB         NOT NULL,            -- å¡«å†™æ•°æ®
  status      VARCHAR(20)   NOT NULL DEFAULT 'pending', -- pending/submitted/approved/rejected
  submitter_id SnowflakeID  REFERENCES users(id),    -- æäº¤äººï¼ˆç¬¬ä¸€äººæäº¤åé”å®šï¼‰
  submitted_at TIMESTAMP,
  approver_id SnowflakeID   REFERENCES users(id),
  approved_at TIMESTAMP,
  created_at  TIMESTAMP   DEFAULT NOW(),
  updated_at  TIMESTAMP   DEFAULT NOW(),
  deleted_at  TIMESTAMP                              -- è½¯åˆ é™¤
);

-- è¯´æ˜ï¼šæ¯ä¸ªä»»åŠ¡åªèƒ½æœ‰ä¸€æ¡æäº¤åçš„è®°å½•ï¼ˆç¬¬ä¸€äººæäº¤åé”å®šï¼‰

-- å®¡æ‰¹è®°å½•è¡¨
approvals (
  id          SnowflakeID   PRIMARY KEY,
  document_id SnowflakeID   REFERENCES documents(id),
  record_id   SnowflakeID   REFERENCES task_records(id),
  approver_id SnowflakeID   REFERENCES users(id),
  status      VARCHAR(20)   NOT NULL,            -- approved/rejected
  comment     TEXT,
  created_at  TIMESTAMP   DEFAULT NOW()
);

-- å®¡æ‰¹é“¾æ‰©å±•å­—æ®µï¼ˆv2.0 åæ·»åŠ ï¼Œå®ç°å¤šçº§å®¡æ‰¹ä¸ä¼šç­¾ï¼‰
-- level            INT              -- å½“å‰å®¡æ‰¹å±‚çº§ï¼ˆå¤šçº§å®¡æ‰¹æ—¶ä½¿ç”¨ï¼‰
-- approval_chain_id VARCHAR(32)     -- æ‰€å±å®¡æ‰¹é“¾ID
-- previous_level   INT              -- ä¸Šä¸€å±‚çº§
-- next_level       INT              -- ä¸‹ä¸€å±‚çº§
-- rejection_reason TEXT             -- æ‹’ç»åŸå› 
-- approved_at      TIMESTAMPTZ      -- å®¡æ‰¹æ—¶é—´
-- approval_type    VARCHAR(20)      -- å®¡æ‰¹ç±»å‹ï¼šsequentialï¼ˆä¾æ¬¡ï¼‰/ countersignï¼ˆä¼šç­¾ï¼‰
-- sequence         INT              -- ä¼šç­¾åºå·
-- group_id         VARCHAR(32)      -- ä¼šç­¾ç»„ID

-- å®¡æ‰¹å§”æ‰˜æ—¥å¿—è¡¨
CREATE TABLE delegation_logs (
  id              VARCHAR(32)   PRIMARY KEY,
  delegator_id    VARCHAR(32)   NOT NULL REFERENCES users(id),
  delegate_id     VARCHAR(32)   NOT NULL REFERENCES users(id),
  start_date      DATE          NOT NULL,
  end_date        DATE          NOT NULL,
  reason          TEXT,
  status          VARCHAR(20)   NOT NULL DEFAULT 'active',
  created_at      TIMESTAMPTZ   NOT NULL DEFAULT NOW()
);

-- æ“ä½œæ—¥å¿—è¡¨
operation_logs (
  id          SnowflakeID   PRIMARY KEY,
  user_id     SnowflakeID   REFERENCES users(id),
  action      VARCHAR(50)   NOT NULL,            -- login/upload/approve/edit/delete
  module      VARCHAR(50)   NOT NULL,            -- auth/document/template/task
  object_id   SnowflakeID,
  object_type VARCHAR(50),
  details     JSONB,
  ip          VARCHAR(50),
  created_at  TIMESTAMP   DEFAULT NOW()
);

-- ç«™å†…æ¶ˆæ¯è¡¨
notifications (
  id          SnowflakeID   PRIMARY KEY,
  user_id     SnowflakeID   REFERENCES users(id),
  type        VARCHAR(50)   NOT NULL,            -- task/approval/reminder
  title       VARCHAR(200)  NOT NULL,
  content     TEXT,
  is_read     BOOLEAN       DEFAULT FALSE,
  read_at     TIMESTAMP,
  created_at  TIMESTAMP   DEFAULT NOW()
);
```

### 6.2 æ‰©å±•å­—æ®µé¢„ç•™ï¼ˆåç»­åŠ ï¼‰

| å­—æ®µ | è¡¨ | ç”¨é€” |
|------|------|------|
| email | users | åç»­é‚®ä»¶é€šçŸ¥ |
| phone | users | åç»­çŸ­ä¿¡é€šçŸ¥ |
| workflow_config | documents | åç»­å¤šçº§å®¡æ‰¹é…ç½® |
| tags | documents/templates | åç»­æ ‡ç­¾æœç´¢ |
| description | departments | éƒ¨é—¨æè¿° |

---

## å…«ã€APIè®¾è®¡

[â¬†ï¸ è¿”å›ç›®å½•](#-å®Œæ•´ç›®å½•)

### 8.1 APIè§„èŒƒ

| é¡¹ç›® | å€¼ |
|------|------|
| å‰ç¼€ | /api/v1 |
| è®¤è¯ | Header: `Authorization: Bearer <token>` |
| åˆ†é¡µ | `?page=1&limit=20` |
| æ—¥æœŸæ ¼å¼ | ISO 8601 (YYYY-MM-DDTHH:mm:ssZ) |
| é”™è¯¯æ ¼å¼ | `{ code: number, message: string, details: any }` |
| æ–‡ä»¶ä¸Šä¼  | multipart/form-data |
| è¶…æ—¶æ—¶é—´ | 30ç§’ |

### 7.2 æ ¸å¿ƒAPI

| æ¨¡å— | ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|------|
| **è®¤è¯** | | | |
| | /api/v1/auth/login | POST | ç™»å½• |
| | /api/v1/auth/me | GET | è·å–å½“å‰ç”¨æˆ· |
| | /api/v1/auth/password | PUT | ä¿®æ”¹å¯†ç  |
| | /api/v1/auth/logout | POST | ç™»å‡º |
| **ç”¨æˆ·** | | | |
| | /api/v1/users | GET | ç”¨æˆ·åˆ—è¡¨ |
| | /api/v1/users | POST | åˆ›å»ºç”¨æˆ· |
| | /api/v1/users/:id | GET | ç”¨æˆ·è¯¦æƒ… |
| | /api/v1/users/:id | PUT | æ›´æ–°ç”¨æˆ· |
| | /api/v1/users/:id | DELETE | åˆ é™¤ç”¨æˆ· |
| **éƒ¨é—¨** | | | |
| | /api/v1/departments | GET | éƒ¨é—¨åˆ—è¡¨ |
| | /api/v1/departments | POST | åˆ›å»ºéƒ¨é—¨ |
| | /api/v1/departments/:id | PUT | æ›´æ–°éƒ¨é—¨ |
| | /api/v1/departments/:id | DELETE | åˆ é™¤éƒ¨é—¨ |
| **æ–‡æ¡£** | | | |
| | /api/v1/documents/level/:level | GET | æ–‡æ¡£åˆ—è¡¨ |
| | /api/v1/documents | POST | ä¸Šä¼ æ–‡æ¡£ |
| | /api/v1/documents/:id | GET | æ–‡æ¡£è¯¦æƒ… |
| | /api/v1/documents/:id | PUT | æ›´æ–°æ–‡æ¡£ |
| | /api/v1/documents/:id | DELETE | åˆ é™¤æ–‡æ¡£ |
| | /api/v1/documents/:id/download | GET | ä¸‹è½½æ–‡æ¡£ |
| | /api/v1/documents/:id/versions | GET | ç‰ˆæœ¬å†å² |
| **å®¡æ‰¹** | | | |
| | /api/v1/approvals/pending | GET | å¾…å®¡æ‰¹åˆ—è¡¨ |
| | /api/v1/approvals/history | GET | å®¡æ‰¹å†å² |
| | /api/v1/approvals | POST | æäº¤å®¡æ‰¹ |
| | /api/v1/approvals/:id | PUT | å®¡æ‰¹æ“ä½œ |
| **æ¨¡æ¿** | | | |
| | /api/v1/templates | GET | æ¨¡æ¿åˆ—è¡¨ |
| | /api/v1/templates | POST | åˆ›å»ºæ¨¡æ¿ |
| | /api/v1/templates/:id | GET | æ¨¡æ¿è¯¦æƒ… |
| | /api/v1/templates/:id | PUT | æ›´æ–°æ¨¡æ¿ |
| | /api/v1/templates/:id | DELETE | åˆ é™¤æ¨¡æ¿ |
| | /api/v1/templates/:id/copy | POST | å¤åˆ¶æ¨¡æ¿ |
| | /api/v1/templates/parse-excel | POST | è§£æExcel |
| **ä»»åŠ¡** | | | |
| | /api/v1/tasks | GET | ä»»åŠ¡åˆ—è¡¨ |
| | /api/v1/tasks | POST | åˆ†å‘ä»»åŠ¡ |
| | /api/v1/tasks/:id | GET | ä»»åŠ¡è¯¦æƒ… |
| | /api/v1/tasks/:id | DELETE | å–æ¶ˆä»»åŠ¡ |
| | /api/v1/tasks/:id/submit | POST | æäº¤ä»»åŠ¡ |
| **è®°å½•** | | | |
| | /api/v1/records | GET | è®°å½•åˆ—è¡¨ |
| | /api/v1/records/:id | GET | è®°å½•è¯¦æƒ… |
| **æ¶ˆæ¯** | | | |
| | /api/v1/notifications | GET | æ¶ˆæ¯åˆ—è¡¨ |
| | /api/v1/notifications/:id/read | PUT | æ ‡è®°å·²è¯» |
| | /api/v1/notifications/read-all | PUT | å…¨éƒ¨å·²è¯» |
| **æ—¥å¿—** | | | |
| | /api/v1/logs | GET | æ“ä½œæ—¥å¿—ï¼ˆç®¡ç†å‘˜ï¼‰ |

---

## ä¹ã€å‰ç«¯è®¾è®¡

[â¬†ï¸ è¿”å›ç›®å½•](#-å®Œæ•´ç›®å½•)

### 10.1 é¡µé¢ç»“æ„

**ä¾§è¾¹æ å±‚çº§**: äºŒçº§ï¼ˆæŒ‰åŠŸèƒ½æ¨¡å—åˆ†ç±»ï¼‰

```
ä¾§è¾¹æ :
â”œâ”€â”€ ä¸€çº§æ–‡ä»¶ç®¡ç†
â”‚   â”œâ”€â”€ æ–‡ä»¶åˆ—è¡¨
â”‚   â””â”€â”€ ä¸Šä¼ æ–‡ä»¶
â”œâ”€â”€ äºŒçº§æ–‡ä»¶ç®¡ç†
â”‚   â”œâ”€â”€ æ–‡ä»¶åˆ—è¡¨
â”‚   â””â”€â”€ ä¸Šä¼ æ–‡ä»¶
â”œâ”€â”€ ä¸‰çº§æ–‡ä»¶ç®¡ç†
â”‚   â”œâ”€â”€ æ–‡ä»¶åˆ—è¡¨
â”‚   â””â”€â”€ ä¸Šä¼ æ–‡ä»¶
â”œâ”€â”€ å››çº§æ¨¡æ¿
â”‚   â”œâ”€â”€ æ¨¡æ¿åˆ—è¡¨
â”‚   â””â”€â”€ åˆ›å»ºæ¨¡æ¿
â”œâ”€â”€ ä»»åŠ¡ç®¡ç†
â”‚   â”œâ”€â”€ æˆ‘çš„ä»»åŠ¡
â”‚   â””â”€â”€ åˆ†å‘ä»»åŠ¡ï¼ˆéƒ¨é—¨è´Ÿè´£äººï¼‰
â”œâ”€â”€ å®¡æ‰¹ä¸­å¿ƒ
â”œâ”€â”€ ç”¨æˆ·ç®¡ç†ï¼ˆAdminï¼‰
â””â”€â”€ éƒ¨é—¨ç®¡ç†ï¼ˆAdminï¼‰
```

### 8.2 äº¤äº’è§„èŒƒ

| é¡¹ç›® | å€¼ |
|------|------|
| æ¯é¡µæ¡æ•° | 20æ¡ï¼ˆå¯åˆ‡æ¢10/20/50ï¼‰ |
| åˆ—è¡¨åŠ è½½ | åˆ†é¡µ |
| è¡¨å•éªŒè¯ | çº¢è‰²æ–‡å­—åœ¨å­—æ®µä¸‹æ–¹ |
| å®¡æ‰¹æ„è§ | é©³å›æ—¶å¿…å¡«ï¼Œé€šè¿‡æ—¶é€‰å¡« |
| æ–‡ä»¶ä¸Šä¼  | æ‹–æ‹½ä¸Šä¼  + æ‰¹é‡ä¸Šä¼  + è¿›åº¦æ¡ |
| æ–‡ä»¶åæ˜¾ç¤º | æ˜¾ç¤ºæ–‡ä»¶å |
| æ‰¹é‡æ“ä½œ | æ‰¹é‡åˆ é™¤ |
| ä»»åŠ¡ç­›é€‰ | Tabsåˆ‡æ¢ |

### 8.3 ç»„ä»¶é¢„ç•™æ‰©å±•

| ç»„ä»¶ | ç”¨é€” | åç»­æ‰©å±• |
|------|------|----------|
| UserAvatar | ç”¨æˆ·å¤´åƒ | åç»­æ”¯æŒä¸Šä¼  |
| VersionCompare | ç‰ˆæœ¬å¯¹æ¯” | åç»­åŠ  |
| DataExport | æ•°æ®å¯¼å‡º | åç»­åŠ Excelå¯¼å‡º |
| WorkflowDesigner | å·¥ä½œæµè®¾è®¡ | åç»­åŠ å¯è§†åŒ–è®¾è®¡ |

### 8.4 å“åº”å¼è®¾è®¡

> **é€‚ç”¨èŒƒå›´**ï¼šPhase 1-6 æ‰€æœ‰é¡µé¢
> **å“åº”å¼ç›®æ ‡**ï¼šæ‰‹æœºã€å¹³æ¿ã€ç”µè„‘å‡å¯æ­£å¸¸ä½¿ç”¨æ ¸å¿ƒåŠŸèƒ½

#### 8.4.1 æ”¯æŒè®¾å¤‡

| è®¾å¤‡ | å®½åº¦èŒƒå›´ | æ”¯æŒçº§åˆ« |
|------|----------|----------|
| æ‰‹æœº | 375px - 428px | å®Œå…¨æ”¯æŒ |
| iPad | 768px - 1024px | å®Œå…¨æ”¯æŒ |
| æ¡Œé¢ | â‰¥1200px | å®Œå…¨æ”¯æŒï¼ˆä¸»é€‚é…ï¼‰ |

#### 8.4.2 æ–­ç‚¹å®šä¹‰

```css
/* æ¡Œé¢ â‰¥1200px */
@media (min-width: 1200px) { /* æ¡Œé¢å¸ƒå±€ */ }

/* iPad 768px - 1199px */
@media (min-width: 768px) and (max-width: 1199px) { /* iPadå¸ƒå±€ */ }

/* æ‰‹æœº <768px */
@media (max-width: 767px) { /* æ‰‹æœºå¸ƒå±€ */ }
```

#### 8.4.3 å„ç«¯é€‚é…è§„åˆ™

| åŠŸèƒ½ | æ‰‹æœº | iPad | æ¡Œé¢ |
|------|------|------|------|
| ä¾§è¾¹æ  | æ±‰å ¡èœå•ï¼ˆæŠ˜å ï¼‰ | å¯æŠ˜å  | å›ºå®šæ˜¾ç¤º |
| æ–‡æ¡£åˆ—è¡¨ | å¡ç‰‡å¼ | è¡¨æ ¼+å¡ç‰‡ | è¡¨æ ¼ |
| ä»»åŠ¡å¡«å†™ | å…¨å±è¡¨å• | åˆ†æ å¸ƒå±€ | åˆ†æ å¸ƒå±€ |
| å®¡æ‰¹æ“ä½œ | å…¨å±å¼¹çª— | å¼¹çª— | å¼¹çª— |
| æ–‡ä»¶ä¸Šä¼  | æ‹ç…§/é€‰æ‹©æ–‡ä»¶ | æ‹–æ‹½+é€‰æ‹© | æ‹–æ‹½+æ‰¹é‡ |
| æŒ‰é’®å¤§å° | â‰¥44pxï¼ˆæ‰‹æŒ‡æ“ä½œï¼‰ | â‰¥40px | â‰¥32px |

#### 8.4.4 ç¦æ­¢è¡Œä¸º

- âŒ ç¦æ­¢ä½¿ç”¨fixedå®šä½å¯¼è‡´æ‰‹æœºç«¯åº•éƒ¨è¢«é®æŒ¡
- âŒ ç¦æ­¢è¡¨æ ¼è¶…è¿‡å±å¹•å®½åº¦å‡ºç°æ¨ªå‘æ»šåŠ¨
- âŒ ç¦æ­¢å¼¹çª—è¶…è¿‡100%é«˜åº¦
- âŒ ç¦æ­¢ä½¿ç”¨hoveräº¤äº’ï¼ˆæ‰‹æœºæ— hoverï¼‰

---

## åã€MVP Phase 1-6 æ ¸å¿ƒè®¾è®¡å†³ç­–

[â¬†ï¸ è¿”å›ç›®å½•](#-å®Œæ•´ç›®å½•)

> **è¯´æ˜**: MVP Phase 1-6 å·²å®Œæˆ 98.1%ï¼Œä»¥ä¸‹ä¸ºå…³é”®è®¾è®¡å†³ç­–ç²¾ç®€ç‰ˆ

### 10.1 ç»„ç»‡æ¶æ„

- **éƒ¨é—¨å±‚çº§**: 2çº§ï¼ˆå…¬å¸â†’éƒ¨é—¨ï¼‰
- **ç”¨æˆ·è§’è‰²**: æ™®é€šç”¨æˆ·ã€éƒ¨é—¨è´Ÿè´£äººã€ç®¡ç†å‘˜
- **å®¡æ‰¹äººè§„åˆ™**: ä»ä¸Šçº§é€‰æ‹©
- **ä¸æ”¯æŒ**: ä¸€äººå¤šéƒ¨é—¨ã€ä¸€äººå¤šä¸Šçº§

### 10.2 æ–‡æ¡£ç®¡ç†

- **æ”¯æŒæ ¼å¼**: PDFã€Wordã€Excelï¼ˆå•æ–‡ä»¶æœ€å¤§ 10MBï¼‰
- **æ–‡æ¡£ç¼–å·**: è‡ªåŠ¨ç”Ÿæˆï¼Œä¸å¯ä¿®æ”¹
- **ç‰ˆæœ¬æ§åˆ¶**: æ—§ç‰ˆæœ¬å¯æŸ¥çœ‹ä¸å¯ä¸‹è½½ï¼Œæ— ç‰ˆæœ¬å¯¹æ¯”
- **å®¡æ‰¹æµç¨‹**: æ— æ—¶é™ï¼Œç«™å†…æ¶ˆæ¯æé†’ï¼Œé©³å›åå›åˆ°è‰ç¨¿
- **æƒé™æ§åˆ¶**: æœ‰æƒé™æ‰èƒ½ä¸‹è½½ï¼Œå·²å‘å¸ƒæ–‡ä»¶ä¸å¯åˆ é™¤
- **æ–‡ä»¶æ“ä½œ**: æ”¯æŒæ‹–æ‹½ä¸Šä¼ ã€æ‰¹é‡ä¸Šä¼ 

### 10.3 å››çº§æ¨¡æ¿ä¸ä»»åŠ¡

- **æ¨¡æ¿åŠŸèƒ½**: æ”¯æŒå¤åˆ¶ã€å­—æ®µæ‹–æ‹½æ’åºã€å­—æ®µé»˜è®¤å€¼
- **ä»»åŠ¡åˆ†å‘**: Tabåˆ‡æ¢ç­›é€‰ã€æ”¯æŒå–æ¶ˆã€é€¾æœŸçº¢è‰²æ ‡è®°
- **æ•°æ®å¯¼å‡º**: æ”¯æŒå¯¼å‡ºä¸º Excel
- **Excelè§£æ**: æ‰‹åŠ¨æ˜ å°„å­—æ®µ

### 10.4 ç³»ç»Ÿé…ç½®

- **æ•°æ®åº“**: PostgreSQLï¼ˆDockerï¼‰+ é›ªèŠ±IDä¸»é”® + è½¯åˆ é™¤ï¼ˆdeleted_atï¼‰
- **æ–‡ä»¶å­˜å‚¨**: MinIOï¼ˆæŒ‰éƒ¨é—¨åˆ†æ¡¶ï¼‰
- **èº«ä»½éªŒè¯**: bcrypt å¯†ç åŠ å¯† + JWT Tokenï¼ˆHeaderï¼‰
- **åˆ†é¡µ**: page + limitï¼ˆæ¯é¡µ20æ¡ï¼‰
- **æ—¥æœŸæ ¼å¼**: YYYY-MM-DD
- **å›æ”¶ç«™**: ä¿ç•™7å¤©

### 10.5 ç”¨æˆ·ä¸å®‰å…¨

- **ç”¨æˆ·å**: è‹±æ–‡+æ•°å­—ï¼Œæœ€å°3ä½ï¼Œå¿…é¡»å”¯ä¸€
- **å¯†ç **: æœ€å°8ä½ï¼Œæ— å¤æ‚åº¦è¦æ±‚
- **ç™»å½•ä¿æŠ¤**: 5æ¬¡å¤±è´¥é”å®šè´¦å·
- **ä¸æ”¯æŒ**: éªŒè¯ç ã€ç”¨æˆ·å¤´åƒã€æ‰¹é‡å¯¼å…¥ç”¨æˆ·

### 10.6 æ¶ˆæ¯é€šçŸ¥

- **é€šçŸ¥æ–¹å¼**: ç«™å†…æ¶ˆæ¯ï¼ˆæ— é‚®ä»¶/çŸ­ä¿¡ï¼‰
- **æ¶ˆæ¯ä¿ç•™**: 30å¤©
- **åŠŸèƒ½**: æ”¯æŒå·²è¯»/æœªè¯»ã€æœç´¢ï¼ˆåç§°å’Œç¼–å·ï¼‰

---



## åä¸€ã€é¡¹ç›®é‡Œç¨‹ç¢‘

[â¬†ï¸ è¿”å›ç›®å½•](#-å®Œæ•´ç›®å½•)

> **é‡è¦è¯´æ˜**ï¼š
> - **MVPèŒƒå›´**ï¼šPhase 1-6ï¼ˆå½“å‰å¼€å‘ï¼Œå®Œæˆåå¼€ç®±å³ç”¨ï¼‰
> - **æ‰©å±•èŒƒå›´**ï¼šPhase 7-14ï¼ˆåç»­æ‰©å±•ï¼Œä¸åœ¨å½“å‰è®¡åˆ’å†…ï¼‰

### Phase 1-6: MVPç‰ˆæœ¬ï¼ˆå½“å‰å¼€å‘ï¼‰

| Phase | æ¨¡å— | Issueæ•° | çŠ¶æ€ |
|-------|------|---------|------|
| Phase 1 | åŸºç¡€é…ç½® | 8ä¸ª | å¾…å¼€å‘ |
| Phase 2 | ä¸€çº§æ–‡ä»¶ | 10ä¸ª | å¾…å¼€å‘ |
| Phase 3 | äºŒä¸‰çº§æ–‡ä»¶ | 6ä¸ª | å¾…å¼€å‘ |
| Phase 4 | å››çº§æ¨¡æ¿ | 12ä¸ª | å¾…å¼€å‘ |
| Phase 5 | ä»»åŠ¡åˆ†å‘ | 10ä¸ª | å¾…å¼€å‘ |
| Phase 6 | æ¶ˆæ¯ä¸ä¼˜åŒ– | 6ä¸ª | å¾…å¼€å‘ |
| **åˆè®¡** | | **52ä¸ª** | |

### Phase 7-14: å®Œæ•´ç‰ˆæ‰©å±•ï¼ˆåç»­è§„åˆ’ï¼‰

> ä»¥ä¸‹åŠŸèƒ½ä¸åœ¨å½“å‰å¼€å‘èŒƒå›´å†…ï¼Œä»…ä½œä¸ºé¢„ç•™æ‰©å±•ç©ºé—´

| Phase | æ¨¡å— | è¯´æ˜ |
|-------|------|------|
| Phase 7-8 | åç¦»æ£€æµ‹ | é…æ–¹å…¬å·®å®šä¹‰ä¸è‡ªåŠ¨åç¦»æ£€æµ‹ |
| Phase 9 | æ•°æ®å¯¼å‡º | Excelæ‰¹é‡å¯¼å‡º |
| Phase 11 | æ–‡ä»¶é¢„è§ˆ | åœ¨çº¿é¢„è§ˆPDF/Word/Excel |
| Phase 12 | ç»Ÿè®¡åˆ†æ | æŠ¥è¡¨å’Œå›¾è¡¨å±•ç¤º |
| Phase 13 | å¤šè¯­è¨€ | ä¸­è‹±æ–‡åˆ‡æ¢ |
| Phase 14 | é‚®ä»¶é€šçŸ¥ | SMTPé‚®ä»¶é€šçŸ¥ï¼ˆç•™æ¥å£ï¼‰ |
| v2.0.0 | å·¥ä½œæµ+æ™ºèƒ½æ–‡æ¡£ | å·¥ä½œæµå¼•æ“ä¸æ–‡æ¡£å†…å®¹å¼•ç”¨ |

---

## åäºŒã€å¾…è¡¥å……ç»†èŠ‚

[â¬†ï¸ è¿”å›ç›®å½•](#-å®Œæ•´ç›®å½•)

> ä»¥ä¸‹æ˜¯å¾…è®¨è®ºæˆ–å¾…ç¡®è®¤çš„ç»†èŠ‚ï¼Œåœ¨åç»­ä¼šè®®ä¸­è¡¥å……

| åºå· | åˆ†ç±» | é—®é¢˜ | çŠ¶æ€ |
|------|------|------|------|
| 1 | | | å¾…è®¨è®º |
| 2 | | | å¾…è®¨è®º |
| 3 | | | å¾…è®¨è®º |

---

## åä¸‰ã€Phase 7-12 æ‰©å±•åŠŸèƒ½è§„åˆ’

[â¬†ï¸ è¿”å›ç›®å½•](#-å®Œæ•´ç›®å½•)

> **é‡è¦è¯´æ˜**ï¼š
> - MVP Phase 1-6 å·²å®Œæˆ 98.1%ï¼ˆ51/52ä¸ªIssueï¼‰
> - æœ¬ç« èŠ‚è¯¦ç»†æè¿° Phase 7-12 çš„ä¸šåŠ¡éœ€æ±‚å’ŒåŠŸèƒ½è§„æ ¼
> - åŸºäºç”¨æˆ·ç¡®è®¤çš„éœ€æ±‚ï¼š**åç¦»æ£€æµ‹ã€æ•°æ®å¯¼å‡ºã€æ–‡ä»¶é¢„è§ˆã€åç¦»ç»Ÿè®¡**
> - **æ¶æ„å˜æ›´**: é‡‡ç”¨ v2.0.0 æ–°æ¶æ„ï¼Œä¼˜å…ˆå®æ–½å·¥ä½œæµå¼•æ“å’Œæ™ºèƒ½æ–‡æ¡£å¼•æ“
> - **å·²ç§»é™¤**: Phase 10 (2çº§å®¡æ‰¹æµç¨‹) - å®Œå…¨ç”± v2.0.0 ç®€åŒ–å·¥ä½œæµå¼•æ“æ›¿ä»£
> - **ä¸åŒ…å«**ï¼šå¤šè¯­è¨€ï¼ˆPhase 13ï¼‰ã€é‚®ä»¶é€šçŸ¥ï¼ˆPhase 14ï¼‰

### 13.0 Phase 7-12 åŠŸèƒ½æ€»è§ˆ

| Phase | åŠŸèƒ½ | æ ¸å¿ƒä¸šåŠ¡ä»·å€¼ | ä¾èµ–å…³ç³» | å®æ–½ä¼˜å…ˆçº§ |
|-------|------|-------------|----------|-----------|
| **Phase 7-8** | é…æ–¹åç¦»æ£€æµ‹ä¸ç‰ˆæœ¬ç®¡ç† | é…æ–¹å…¬å·®å®šä¹‰ â†’ è‡ªåŠ¨åç¦»æ£€æµ‹ â†’ å¼ºåˆ¶è¯´æ˜åŸå›  â†’ ç”ŸæˆæŠ¥å‘Š â†’ è§¦å‘å·¥ä½œæµå®¡æ‰¹ | ä¾èµ– v2.0.0 å·¥ä½œæµå¼•æ“ | P0ï¼ˆæœ€é«˜ï¼‰ |
| **Phase 9** | æ•°æ®å¯¼å‡º | Excel æ‰¹é‡å¯¼å‡ºæ–‡æ¡£ã€ä»»åŠ¡è®°å½•ã€åç¦»æŠ¥å‘Š | æ— ä¾èµ– | P1 |
| **Phase 11** | æ–‡ä»¶é¢„è§ˆ | PDF/Word/Excel å…¨æ ¼å¼åŸç”Ÿé¢„è§ˆ | æ— ä¾èµ– | P2 |
| **Phase 12** | åç¦»ç»Ÿè®¡åˆ†æ | åç¦»æ¬¡æ•°ã€ç±»å‹åˆ†å¸ƒã€è¶‹åŠ¿ç»Ÿè®¡ | ä¾èµ– Phase 7-8 | P1 |

**å®æ–½é¡ºåºå»ºè®®**ï¼ˆåŸºäº v2.0.0 æ–°æ¶æ„ï¼‰ï¼š
```
v2.0.0ï¼ˆå·¥ä½œæµå¼•æ“ + æ™ºèƒ½æ–‡æ¡£å¼•æ“ï¼Œ11å‘¨ï¼‰
  â†“
Phase 7-8ï¼ˆåç¦»æ£€æµ‹ï¼Œä¾èµ–å·¥ä½œæµå¼•æ“ï¼‰
  â†“
Phase 12ï¼ˆç»Ÿè®¡åˆ†æï¼‰â†’ Phase 9ï¼ˆæ•°æ®å¯¼å‡ºï¼‰â†’ Phase 11ï¼ˆæ–‡ä»¶é¢„è§ˆï¼‰
```

> **æ¶æ„è¯´æ˜**: Phase 7-8 çš„åç¦»æ£€æµ‹éœ€è¦2çº§å®¡æ‰¹æµç¨‹ï¼Œä¸å†å•ç‹¬å®ç° Phase 10ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨ v2.0.0 å·¥ä½œæµå¼•æ“é…ç½®åç¦»ä¸“ç”¨å®¡æ‰¹æµç¨‹ã€‚

---

### 13.1 Phase 7-8ï¼šé…æ–¹åç¦»æ£€æµ‹ä¸ç‰ˆæœ¬ç®¡ç†

#### 13.1.1 ä¸šåŠ¡èƒŒæ™¯

**æ ¸å¿ƒé—®é¢˜**ï¼š
1. ç”Ÿäº§è¿‡ç¨‹ä¸­ï¼Œå‘˜å·¥å¡«å†™ç”Ÿäº§è®°å½•æ—¶ï¼Œå®é™…å€¼å¯èƒ½åç¦»é…æ–¹æ ‡å‡†å€¼
2. å½“å‰ç³»ç»Ÿæ— æ³•è‡ªåŠ¨æ£€æµ‹åç¦»ï¼Œä¾èµ–äººå·¥å®¡æ ¸ï¼Œæ•ˆç‡ä½ä¸”æ˜“æ¼æ£€
3. åç¦»åŸå› æ— æ³•è¿½æº¯ï¼Œè´¨é‡é—®é¢˜éš¾ä»¥åˆ†æ

**ä¸šåŠ¡ç›®æ ‡**ï¼š
- åœ¨æ¨¡æ¿ï¼ˆé…æ–¹ï¼‰ä¸­å®šä¹‰å…¬å·®èŒƒå›´ï¼Œå‘˜å·¥å¡«å†™æ—¶è‡ªåŠ¨æ£€æµ‹åç¦»
- åç¦»æ—¶å¼ºåˆ¶å¡«å†™åŸå› ï¼Œç”Ÿæˆåç¦»æŠ¥å‘Šï¼Œè§¦å‘é¢å¤–å®¡æ‰¹æµç¨‹
- æ”¯æŒåç¦»æ•°æ®ç»Ÿè®¡åˆ†æï¼Œä¸ºè´¨é‡æ”¹è¿›æä¾›æ•°æ®æ”¯æŒ

#### 13.1.2 ç”¨æˆ·æ•…äº‹

**æ•…äº‹1ï¼šé…æ–¹ç®¡ç†å‘˜å®šä¹‰å…¬å·®**
```
ä½œä¸ºï¼šé…æ–¹ç®¡ç†å‘˜ï¼ˆç ”å‘éƒ¨ï¼‰
æˆ‘æƒ³è¦ï¼šåœ¨å·¥è‰ºé…æ–¹ä¸­å®šä¹‰æ¯ä¸ªå­—æ®µçš„å…¬å·®èŒƒå›´
ä»¥ä¾¿ï¼šç³»ç»Ÿèƒ½è‡ªåŠ¨æ£€æµ‹ç”Ÿäº§è®°å½•çš„åç¦»æƒ…å†µ

éªŒæ”¶æ ‡å‡†ï¼š
- èƒ½ä¸ºæ•°å€¼å‹å­—æ®µè®¾ç½®å…¬å·®ï¼ˆèŒƒå›´å…¬å·®ï¼šÂ±5gã€ç™¾åˆ†æ¯”å…¬å·®ï¼šÂ±5%ï¼‰
- å…¬å·®é…ç½®ä¿å­˜åœ¨æ¨¡æ¿ä¸­ï¼Œä¸å½±å“å·²æœ‰å­—æ®µ
- å…¬å·®é…ç½®å¯ä¿®æ”¹ï¼Œä½†ä¸å½±å“å†å²è®°å½•çš„åç¦»åˆ¤æ–­ï¼ˆç‰ˆæœ¬é”å®šï¼‰
```

**æ•…äº‹2ï¼šç”Ÿäº§å‘˜å·¥å¡«å†™è®°å½•æ—¶åç¦»æ£€æµ‹**
```
ä½œä¸ºï¼šç”Ÿäº§å‘˜å·¥
æˆ‘æƒ³è¦ï¼šå¡«å†™ç”Ÿäº§è®°å½•æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹æˆ‘å¡«çš„å€¼æ˜¯å¦åç¦»é…æ–¹
ä»¥ä¾¿ï¼šåŠæ—¶å‘ç°å¼‚å¸¸æƒ…å†µå¹¶è®°å½•åŸå› 

éªŒæ”¶æ ‡å‡†ï¼š
- è¾“å…¥æ•°å€¼åï¼Œç³»ç»Ÿå®æ—¶æ˜¾ç¤ºæ˜¯å¦åœ¨å…¬å·®èŒƒå›´å†…ï¼ˆâœ…æ­£å¸¸ / âŒåç¦»ï¼‰
- åç¦»æ—¶å¼¹çª—å¼ºåˆ¶å¡«å†™åç¦»åŸå› ï¼ˆä¸å¡«æ— æ³•æäº¤ï¼‰
- åç¦»åŸå› ä¿å­˜åœ¨åç¦»æŠ¥å‘Šä¸­ï¼Œæ–¹ä¾¿åç»­å®¡æ‰¹å’Œè¿½æº¯
```

**æ•…äº‹3ï¼šè´¨é‡ä¸»ç®¡å®¡æ‰¹åç¦»æŠ¥å‘Š**
```
ä½œä¸ºï¼šè´¨é‡ä¸»ç®¡
æˆ‘æƒ³è¦ï¼šæŸ¥çœ‹åŒ…å«åç¦»çš„ç”Ÿäº§è®°å½•ï¼Œå¹¶å®¡æ‰¹åç¦»æ˜¯å¦å¯æ¥å—
ä»¥ä¾¿ï¼šç¡®ä¿è´¨é‡å¯æ§ï¼Œä¸åˆæ ¼çš„åç¦»ä¸èƒ½å½’æ¡£

éªŒæ”¶æ ‡å‡†ï¼š
- åç¦»è®°å½•æäº¤åï¼Œè§¦å‘é¢å¤–çš„å®¡æ‰¹æµç¨‹ï¼ˆæ­£å¸¸è®°å½•â†’ä¸»ç®¡å®¡æ‰¹ï¼›åç¦»è®°å½•â†’ä¸»ç®¡+è´¨é‡ä¸»ç®¡ï¼‰
- å®¡æ‰¹æ—¶èƒ½çœ‹åˆ°åç¦»å­—æ®µã€æœŸæœ›å€¼ã€å®é™…å€¼ã€åç¦»é‡ã€åç¦»åŸå› 
- å®¡æ‰¹æ‹’ç»åï¼Œè®°å½•å›åˆ°è‰ç¨¿çŠ¶æ€ï¼Œå‘˜å·¥å¯ä¿®æ”¹åé‡æ–°æäº¤
```

**æ•…äº‹4ï¼šç‰ˆæœ¬é”å®šï¼ˆé˜²æ­¢å†å²æ•°æ®æ··ä¹±ï¼‰**
```
ä½œä¸ºï¼šé…æ–¹ç®¡ç†å‘˜
æˆ‘æƒ³è¦ï¼šé…æ–¹æ›´æ–°åï¼Œå·²å¡«å†™çš„ç”Ÿäº§è®°å½•ä¸å—å½±å“
ä»¥ä¾¿ï¼šå†å²æ•°æ®å‡†ç¡®åæ˜ å½“æ—¶çš„é…æ–¹è¦æ±‚ï¼Œä¸ä¼šå› é…æ–¹å˜æ›´è€Œæ”¹å˜åç¦»åˆ¤æ–­

éªŒæ”¶æ ‡å‡†ï¼š
- å‘˜å·¥æäº¤è®°å½•æ—¶ï¼Œç³»ç»Ÿé”å®šé…æ–¹ç‰ˆæœ¬å·
- é…æ–¹ä» v1.0 æ›´æ–°åˆ° v1.1 åï¼Œå·²æäº¤çš„è®°å½•ä»æŒ‰ v1.0 åˆ¤æ–­åç¦»
- æœªæäº¤çš„è®°å½•è‡ªåŠ¨ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ v1.1
```

#### 13.1.3 åŠŸèƒ½éœ€æ±‚

##### 13.1.3.1 é…æ–¹å…¬å·®å®šä¹‰

**è¾“å…¥**ï¼š
- å­—æ®µåç§°ï¼ˆå¦‚ï¼štemperatureï¼‰
- å­—æ®µç±»å‹ï¼ˆå¿…é¡»ä¸º numberï¼‰
- å…¬å·®ç±»å‹ï¼ˆèŒƒå›´å…¬å·® / ç™¾åˆ†æ¯”å…¬å·®ï¼‰
- å…¬å·®å‚æ•°ï¼š
  - èŒƒå›´å…¬å·®ï¼šæœ€å°å€¼ã€æœ€å¤§å€¼ï¼ˆå¦‚ï¼š175Â°C ~ 185Â°Cï¼‰
  - ç™¾åˆ†æ¯”å…¬å·®ï¼šç™¾åˆ†æ¯”ï¼ˆå¦‚ï¼šÂ±5%ï¼‰

**è¾“å‡º**ï¼š
- æ¨¡æ¿ fieldsJson ä¸­å¢åŠ  tolerance é…ç½®
- å‰ç«¯è¡¨å•æ˜¾ç¤ºå…¬å·®æç¤ºï¼ˆå¦‚ï¼šæ¸©åº¦ï¼š___Â°Cï¼ˆæ ‡å‡†ï¼š180Â±5Â°Cï¼‰ï¼‰

**ä¸šåŠ¡è§„åˆ™**ï¼š
- ä»…æ•°å€¼å‹å­—æ®µæ”¯æŒå…¬å·®é…ç½®
- å…¬å·®é…ç½®ä¸ºå¯é€‰é¡¹ï¼Œä¸é…ç½®åˆ™ä¸æ£€æµ‹åç¦»
- å…¬å·®é…ç½®ä¿®æ”¹åï¼Œç‰ˆæœ¬å·+0.1ï¼Œå†å²è®°å½•ä¸å—å½±å“

##### 13.1.3.2 è‡ªåŠ¨åç¦»æ£€æµ‹

**è§¦å‘æ—¶æœº**ï¼š
- å‘˜å·¥å¡«å†™è¡¨å•æ—¶ï¼ˆå®æ—¶æ£€æµ‹ï¼Œå‰ç«¯æ˜¾ç¤ºï¼‰
- å‘˜å·¥æäº¤è¡¨å•æ—¶ï¼ˆåç«¯éªŒè¯ï¼Œç”Ÿæˆåç¦»æŠ¥å‘Šï¼‰

**æ£€æµ‹é€»è¾‘**ï¼š
```
IF å­—æ®µæœ‰å…¬å·®é…ç½® THEN
  IF èŒƒå›´å…¬å·® THEN
    åç¦» = (å®é™…å€¼ < æœ€å°å€¼) OR (å®é™…å€¼ > æœ€å¤§å€¼)
    åç¦»é‡ = MIN(|å®é™…å€¼ - æœ€å°å€¼|, |å®é™…å€¼ - æœ€å¤§å€¼|)
  ELSE IF ç™¾åˆ†æ¯”å…¬å·® THEN
    æœŸæœ›å€¼ = (æœ€å°å€¼ + æœ€å¤§å€¼) / 2
    åç¦»ç‡ = (å®é™…å€¼ - æœŸæœ›å€¼) / æœŸæœ›å€¼ * 100%
    åç¦» = |åç¦»ç‡| > ç™¾åˆ†æ¯”é˜ˆå€¼
  END IF
END IF
```

**è¾“å‡º**ï¼š
- å‰ç«¯ï¼šåç¦»å­—æ®µæ ‡çº¢ï¼Œæ˜¾ç¤ºåç¦»æç¤º
- åç«¯ï¼šè¿”å›åç¦»å­—æ®µåˆ—è¡¨ï¼ˆå­—æ®µåã€æœŸæœ›å€¼ã€å®é™…å€¼ã€åç¦»é‡ï¼‰

**ä¸šåŠ¡è§„åˆ™**ï¼š
- åç¦»æ£€æµ‹ç»“æœå®æ—¶æ˜¾ç¤ºï¼Œä¸é˜»å¡å¡«å†™
- æäº¤æ—¶è‹¥æœ‰åç¦»ï¼Œå¼ºåˆ¶å¼¹çª—å¡«å†™åŸå› ï¼ˆæ¯ä¸ªåç¦»å­—æ®µä¸€ä¸ªåŸå› ï¼‰
- åç¦»åŸå› æœ€å°‘10ä¸ªå­—ç¬¦ï¼Œæœ€å¤š500ä¸ªå­—ç¬¦

##### 13.1.3.3 åç¦»æŠ¥å‘Šç”Ÿæˆ

**è§¦å‘æ—¶æœº**ï¼šå‘˜å·¥æäº¤åŒ…å«åç¦»çš„ä»»åŠ¡è®°å½•æ—¶

**æŠ¥å‘Šå†…å®¹**ï¼š
| å­—æ®µ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| recordId | ä»»åŠ¡è®°å½•ID | xxx-xxx |
| templateId | é…æ–¹æ¨¡æ¿ID | 3-RD-001 |
| fieldName | åç¦»å­—æ®µåç§° | temperature |
| expectedValue | æœŸæœ›å€¼ï¼ˆé…æ–¹å€¼ï¼‰ | 180Â°C |
| actualValue | å®é™…å€¼ï¼ˆå¡«å†™å€¼ï¼‰ | 190Â°C |
| toleranceMin | å…¬å·®æœ€å°å€¼ | 175Â°C |
| toleranceMax | å…¬å·®æœ€å¤§å€¼ | 185Â°C |
| deviationAmount | åç¦»é‡ï¼ˆç»å¯¹å€¼ï¼‰ | 5Â°C |
| deviationRate | åç¦»ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰ | 5.6% |
| reason | åç¦»åŸå› ï¼ˆå‘˜å·¥å¡«å†™ï¼‰ | ç”Ÿäº§çº¿æ¸©åº¦æ§åˆ¶å™¨æ•…éšœï¼Œå·²æŠ¥ä¿® |
| status | æŠ¥å‘ŠçŠ¶æ€ | pendingï¼ˆå¾…å®¡æ‰¹ï¼‰|
| reportedBy | æŠ¥å‘Šäºº | å¼ ä¸‰ |
| reportedAt | æŠ¥å‘Šæ—¶é—´ | 2026-02-05 14:30:00 |

**è¾“å‡º**ï¼š
- ç”Ÿæˆåç¦»æŠ¥å‘Šè®°å½•ï¼ˆå­˜å…¥ DeviationReport è¡¨ï¼‰
- ä»»åŠ¡è®°å½•æ ‡è®°ä¸º"åŒ…å«åç¦»"ï¼ˆhasDeviation = true, deviationCount = Nï¼‰
- è§¦å‘ v2.0.0 å·¥ä½œæµå¼•æ“çš„"åç¦»å®¡æ‰¹æµç¨‹"ï¼ˆ2çº§å®¡æ‰¹ï¼šä¸»ç®¡â†’è´¨é‡ç»ç†ï¼‰

**ä¸šåŠ¡è§„åˆ™**ï¼š
- ä¸€ä¸ªä»»åŠ¡è®°å½•å¯ä»¥åŒ…å«å¤šä¸ªåç¦»å­—æ®µï¼Œæ¯ä¸ªå­—æ®µç”Ÿæˆä¸€æ¡åç¦»æŠ¥å‘Š
- åç¦»æŠ¥å‘ŠçŠ¶æ€ï¼špendingï¼ˆå¾…å®¡æ‰¹ï¼‰â†’ approvedï¼ˆé€šè¿‡ï¼‰/ rejectedï¼ˆæ‹’ç»ï¼‰
- åç¦»æŠ¥å‘Šä¸å¯ä¿®æ”¹ï¼Œåªèƒ½æŸ¥çœ‹å’Œå®¡æ‰¹

##### 13.1.3.4 ç‰ˆæœ¬é”å®šæœºåˆ¶

**ç›®æ ‡**ï¼šé…æ–¹æ›´æ–°åï¼Œå·²æäº¤çš„è®°å½•ä¸å—å½±å“ï¼Œä¿è¯å†å²æ•°æ®å‡†ç¡®æ€§

**å®ç°æ–¹å¼**ï¼š
- ä»»åŠ¡è®°å½•è¡¨æ–°å¢å­—æ®µï¼š
  - `relatedTemplateId`ï¼ˆå…³è”çš„é…æ–¹æ¨¡æ¿IDï¼‰
  - `relatedTemplateVersion`ï¼ˆé”å®šçš„é…æ–¹ç‰ˆæœ¬å·ï¼‰
- å‘˜å·¥æäº¤è®°å½•æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨è®°å½•å½“å‰é…æ–¹ç‰ˆæœ¬å·
- åç¦»æ£€æµ‹å’Œç»Ÿè®¡æ—¶ï¼Œä½¿ç”¨é”å®šçš„ç‰ˆæœ¬å·å¯¹åº”çš„å…¬å·®é…ç½®

**ä¸šåŠ¡è§„åˆ™**ï¼š
- æäº¤åçš„è®°å½•ï¼Œç‰ˆæœ¬å·æ°¸ä¹…é”å®šï¼Œä¸å¯ä¿®æ”¹
- æœªæäº¤çš„è®°å½•ï¼ˆè‰ç¨¿çŠ¶æ€ï¼‰ï¼Œæ¯æ¬¡æ‰“å¼€æ—¶ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬
- é…æ–¹ç‰ˆæœ¬å·æ ¼å¼ï¼š1.0, 1.1, 1.2...ï¼ˆä¿®æ”¹å­—æ®µé…ç½®æ—¶è‡ªåŠ¨é€’å¢ï¼‰

#### 13.1.4 ä¸šåŠ¡è§„åˆ™ï¼ˆæ–°å¢ï¼‰

| è§„åˆ™ç¼–å· | è§„åˆ™æè¿° |
|---------|----------|
| BR-017 | æ•°å€¼å‹å­—æ®µå¯é…ç½®å…¬å·®ï¼ˆèŒƒå›´å…¬å·® or ç™¾åˆ†æ¯”å…¬å·®ï¼‰ï¼Œéæ•°å€¼å‹å­—æ®µä¸æ”¯æŒ |
| BR-018 | åç¦»æ£€æµ‹åœ¨å‰ç«¯å®æ—¶æ˜¾ç¤ºï¼Œåç«¯æäº¤æ—¶å¼ºåˆ¶éªŒè¯ |
| BR-019 | åç¦»æ—¶å¿…é¡»å¡«å†™åç¦»åŸå› ï¼ˆæœ€å°‘10å­—ï¼Œæœ€å¤š500å­—ï¼‰ |
| BR-020 | åç¦»æŠ¥å‘Šè‡ªåŠ¨ç”Ÿæˆï¼Œä¸å¯æ‰‹åŠ¨ä¿®æ”¹ï¼Œåªèƒ½å®¡æ‰¹é€šè¿‡/æ‹’ç» |
| BR-021 | åŒ…å«åç¦»çš„è®°å½•è§¦å‘é¢å¤–å®¡æ‰¹æµç¨‹ï¼ˆæ­£å¸¸ï¼š1çº§å®¡æ‰¹ï¼›åç¦»ï¼š2çº§å®¡æ‰¹ï¼‰ |
| BR-022 | ä»»åŠ¡è®°å½•æäº¤æ—¶é”å®šé…æ–¹ç‰ˆæœ¬å·ï¼Œåç»­é…æ–¹æ›´æ–°ä¸å½±å“å·²æäº¤è®°å½• |
| BR-023 | é…æ–¹å…¬å·®é…ç½®ä¿®æ”¹åï¼Œç‰ˆæœ¬å·è‡ªåŠ¨+0.1ï¼Œå†å²è®°å½•æŒ‰æ—§ç‰ˆæœ¬åˆ¤æ–­åç¦» |
| BR-024 | åç¦»æŠ¥å‘ŠçŠ¶æ€ï¼špendingï¼ˆå¾…å®¡æ‰¹ï¼‰â†’ approvedï¼ˆå½’æ¡£ï¼‰/ rejectedï¼ˆé©³å›åˆ°åˆ›å»ºäººï¼‰ |

#### 13.1.5 æ•°æ®å®ä½“

##### Template.fieldsJson æ‰©å±•ï¼ˆå‘åå…¼å®¹ï¼‰

```typescript
// ç°æœ‰å­—æ®µç»“æ„ï¼ˆMVP Phase 1-6ï¼Œä¿æŒä¸å˜ï¼‰
interface TemplateField {
  name: string          // å­—æ®µåç§°
  label: string         // å­—æ®µæ ‡ç­¾
  type: 'text' | 'textarea' | 'number' | 'date' | 'select' | 'boolean'
  required: boolean
  defaultValue?: string | number | boolean
  options?: { label: string; value: string | number }[]  // ä¸‹æ‹‰é€‰é¡¹
  sort: number          // æ’åº
}

// æ–°å¢å­—æ®µï¼ˆPhase 7+ï¼‰
interface TemplateFieldV2 extends TemplateField {
  tolerance?: {                    // å…¬å·®é…ç½®ï¼ˆä»… number ç±»å‹æœ‰æ•ˆï¼‰
    type: 'range' | 'percentage'   // èŒƒå›´å…¬å·® vs ç™¾åˆ†æ¯”å…¬å·®
    min?: number                   // æœ€å°å€¼ï¼ˆå¦‚ï¼š95ï¼‰
    max?: number                   // æœ€å¤§å€¼ï¼ˆå¦‚ï¼š105ï¼‰
    percentage?: number            // ç™¾åˆ†æ¯”ï¼ˆå¦‚ï¼š5ï¼Œè¡¨ç¤ºÂ±5%ï¼‰
    unit?: string                  // å•ä½ï¼ˆå¦‚ï¼šÂ°C, g, minï¼‰
  }
  relatedTemplateId?: string       // å…³è”çš„ä¸Šæ¸¸é…æ–¹IDï¼ˆç”¨äºè‡ªåŠ¨å¸¦å…¥ï¼‰
}
```

**ç¤ºä¾‹**ï¼š
```json
{
  "name": "temperature",
  "label": "æ¸©åº¦",
  "type": "number",
  "required": true,
  "defaultValue": 180,
  "tolerance": {
    "type": "range",
    "min": 175,
    "max": 185,
    "unit": "Â°C"
  }
}
```

##### DeviationReportï¼ˆæ–°å¢è¡¨ï¼‰

**ä¸šåŠ¡æ¦‚å¿µ**ï¼šåç¦»æŠ¥å‘Šï¼Œè®°å½•ç”Ÿäº§è®°å½•ä¸­åç¦»é…æ–¹æ ‡å‡†çš„å­—æ®µè¯¦æƒ…

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | SnowflakeID | ä¸»é”® |
| recordId | SnowflakeID | å…³è”çš„ä»»åŠ¡è®°å½•ID |
| templateId | SnowflakeID | å…³è”çš„é…æ–¹æ¨¡æ¿ID |
| fieldName | String | åç¦»å­—æ®µåç§° |
| expectedValue | String | æœŸæœ›å€¼ï¼ˆé…æ–¹æ ‡å‡†å€¼ï¼‰ |
| actualValue | String | å®é™…å€¼ï¼ˆå‘˜å·¥å¡«å†™å€¼ï¼‰ |
| toleranceMin | Float | å…¬å·®æœ€å°å€¼ |
| toleranceMax | Float | å…¬å·®æœ€å¤§å€¼ |
| deviationAmount | Float | åç¦»é‡ï¼ˆç»å¯¹å€¼ï¼‰ |
| deviationRate | Float | åç¦»ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰ |
| reason | String | åç¦»åŸå› ï¼ˆå‘˜å·¥å¡«å†™ï¼Œ10-500å­—ç¬¦ï¼‰ |
| status | String | æŠ¥å‘ŠçŠ¶æ€ï¼ˆpending/approved/rejectedï¼‰ |
| reportedBy | SnowflakeID | æŠ¥å‘Šäººï¼ˆå‘˜å·¥IDï¼‰ |
| reportedAt | DateTime | æŠ¥å‘Šæ—¶é—´ |
| approvedBy | SnowflakeID | å®¡æ‰¹äººID |
| approvedAt | DateTime | å®¡æ‰¹æ—¶é—´ |
| createdAt | DateTime | åˆ›å»ºæ—¶é—´ |
| updatedAt | DateTime | æ›´æ–°æ—¶é—´ |
| deletedAt | DateTime | è½¯åˆ é™¤ |

##### TaskRecord æ‰©å±•

**æ–°å¢å­—æ®µ**ï¼š
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| relatedTemplateId | SnowflakeID | å…³è”çš„é…æ–¹æ¨¡æ¿IDï¼ˆç”¨äºç‰ˆæœ¬é”å®šï¼‰ |
| relatedTemplateVersion | Float | é”å®šçš„é…æ–¹ç‰ˆæœ¬å·ï¼ˆå¦‚ï¼š1.0, 1.1ï¼‰ |
| hasDeviation | Boolean | æ˜¯å¦åŒ…å«åç¦»ï¼ˆtrue/falseï¼‰ |
| deviationCount | Int | åç¦»å­—æ®µæ•°é‡ |

#### 13.1.6 ä¸šåŠ¡æµç¨‹

##### æµç¨‹å›¾ï¼šé…æ–¹åç¦»æ£€æµ‹ä¸å®¡æ‰¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   é…æ–¹åç¦»æ£€æµ‹ä¸å®¡æ‰¹æµç¨‹                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: é…æ–¹ç®¡ç†å‘˜åˆ›å»º/æ›´æ–°é…æ–¹
    â†“
   é…æ–¹æ¨¡æ¿ï¼ˆä¸‰çº§æ–‡ä»¶ï¼‰
   - åŸæ–™A: 100g Â±5g
   - æ¸©åº¦: 180Â°C Â±5Â°C
   - æ—¶é—´: 30min Â±2min
   ç‰ˆæœ¬å·ï¼šv1.0

Step 2: ç”Ÿäº§å‘˜å·¥å¡«å†™ç”Ÿäº§è®°å½•
    â†“
   å‘˜å·¥è¾“å…¥ï¼š
   - åŸæ–™A = 103g  â†’  âœ… æ­£å¸¸ï¼ˆ100-105èŒƒå›´å†…ï¼‰
   - æ¸©åº¦ = 190Â°C  â†’  âŒ åç¦»ï¼ˆ175-185èŒƒå›´å¤–ï¼‰
   - æ—¶é—´ = 28min  â†’  âœ… æ­£å¸¸ï¼ˆ28-32èŒƒå›´å†…ï¼‰
    â†“
   å‰ç«¯å®æ—¶æ˜¾ç¤ºï¼š
   - æ¸©åº¦å­—æ®µæ ‡çº¢
   - æç¤ºï¼šåç¦»é…æ–¹æ ‡å‡†å€¼5Â°C

Step 3: æäº¤æ—¶å¼ºåˆ¶å¡«å†™åç¦»åŸå› 
    â†“
   å¼¹çª—ï¼šè¯·å¡«å†™"æ¸©åº¦"å­—æ®µåç¦»åŸå› 
   å‘˜å·¥è¾“å…¥ï¼šç”Ÿäº§çº¿æ¸©åº¦æ§åˆ¶å™¨æ•…éšœï¼Œå·²æŠ¥ä¿®
    â†“
   ç³»ç»Ÿç”Ÿæˆåç¦»æŠ¥å‘Šï¼š
   - å­—æ®µï¼štemperature
   - æœŸæœ›å€¼ï¼š180Â°C
   - å®é™…å€¼ï¼š190Â°C
   - åç¦»é‡ï¼š5Â°C
   - åŸå› ï¼šç”Ÿäº§çº¿æ¸©åº¦æ§åˆ¶å™¨æ•…éšœï¼Œå·²æŠ¥ä¿®

Step 4: è§¦å‘å·¥ä½œæµå¼•æ“çš„åç¦»å®¡æ‰¹æµç¨‹ï¼ˆv2.0.0ï¼‰
    â†“
   1çº§å®¡æ‰¹ï¼ˆç”Ÿäº§ä¸»ç®¡ï¼‰ï¼š
   - æŸ¥çœ‹ç”Ÿäº§è®°å½• + åç¦»æŠ¥å‘Š
   - é€šè¿‡/æ‹’ç»
    â†“ï¼ˆé€šè¿‡åï¼‰
   2çº§å®¡æ‰¹ï¼ˆè´¨é‡ä¸»ç®¡ï¼‰ï¼š
   - æŸ¥çœ‹åç¦»æŠ¥å‘Šï¼Œåˆ¤æ–­æ˜¯å¦å¯æ¥å—
   - é€šè¿‡ï¼ˆå½’æ¡£ï¼‰/ æ‹’ç»ï¼ˆå›åˆ°å‘˜å·¥ï¼Œä¿®æ”¹åé‡æ–°æäº¤ï¼‰

Step 5: å½’æ¡£æˆ–é©³å›
    â†“
   é€šè¿‡ï¼šè®°å½•å½’æ¡£ï¼Œåç¦»æŠ¥å‘ŠçŠ¶æ€ = approved
   æ‹’ç»ï¼šè®°å½•å›åˆ°è‰ç¨¿ï¼Œåç¦»æŠ¥å‘ŠçŠ¶æ€ = rejected
```

#### 13.1.7 æˆåŠŸæŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æ•°æ®æ¥æº |
|------|--------|----------|
| åç¦»æ£€å‡ºç‡ | â‰¥95% | å®é™…åç¦»æ•° / äººå·¥å®¡æ ¸å‘ç°çš„åç¦»æ•° |
| åç¦»æŠ¥å‘Šå®Œæˆç‡ | 100% | åç¦»è®°å½•ä¸­å¡«å†™åŸå› çš„æ¯”ä¾‹ |
| åç¦»å®¡æ‰¹åŠæ—¶ç‡ | â‰¥90% åœ¨24å°æ—¶å†…å®Œæˆå®¡æ‰¹ | å®¡æ‰¹å®Œæˆæ—¶é—´ - æäº¤æ—¶é—´ |
| ç‰ˆæœ¬é”å®šå‡†ç¡®ç‡ | 100% | å†å²è®°å½•çš„é…æ–¹ç‰ˆæœ¬ä¸å—æ›´æ–°å½±å“ |
| ç”¨æˆ·æ»¡æ„åº¦ | â‰¥4.0/5.0 | ç”Ÿäº§å‘˜å·¥å’Œè´¨é‡ä¸»ç®¡çš„åé¦ˆè¯„åˆ† |

#### 13.1.8 éªŒæ”¶æ ‡å‡†

**Phase 7-8 åŠŸèƒ½éªŒæ”¶æ¸…å•**ï¼š

- [ ] é…æ–¹ç®¡ç†å‘˜èƒ½åœ¨æ¨¡æ¿ä¸­ä¸ºæ•°å€¼å‹å­—æ®µé…ç½®å…¬å·®ï¼ˆèŒƒå›´å…¬å·® + ç™¾åˆ†æ¯”å…¬å·®ï¼‰
- [ ] å…¬å·®é…ç½®ä¿®æ”¹åï¼Œæ¨¡æ¿ç‰ˆæœ¬å·è‡ªåŠ¨é€’å¢ï¼ˆ1.0 â†’ 1.1ï¼‰
- [ ] å‘˜å·¥å¡«å†™è¡¨å•æ—¶ï¼Œåç¦»å­—æ®µå®æ—¶æ ‡çº¢æ˜¾ç¤º
- [ ] æäº¤æ—¶è‹¥æœ‰åç¦»ï¼Œå¼ºåˆ¶å¼¹çª—å¡«å†™åŸå› ï¼ˆä¸å¡«æ— æ³•æäº¤ï¼‰
- [ ] åç¦»åŸå› é™åˆ¶10-500å­—ç¬¦ï¼Œå°‘äº10å­—ç¬¦æç¤ºé”™è¯¯
- [ ] æäº¤åè‡ªåŠ¨ç”Ÿæˆåç¦»æŠ¥å‘Šï¼ŒåŒ…å«å­—æ®µåã€æœŸæœ›å€¼ã€å®é™…å€¼ã€åç¦»é‡ã€åŸå› 
- [ ] ä»»åŠ¡è®°å½•æäº¤æ—¶é”å®šé…æ–¹ç‰ˆæœ¬å·ï¼Œåç»­é…æ–¹æ›´æ–°ä¸å½±å“å·²æäº¤è®°å½•
- [ ] æœªæäº¤çš„è‰ç¨¿è®°å½•ï¼Œæ¯æ¬¡æ‰“å¼€æ—¶è‡ªåŠ¨ä½¿ç”¨æœ€æ–°é…æ–¹ç‰ˆæœ¬
- [ ] åŒ…å«åç¦»çš„è®°å½•è§¦å‘å·¥ä½œæµå¼•æ“çš„åç¦»å®¡æ‰¹æµç¨‹ï¼ˆ2çº§å®¡æ‰¹ï¼šä¸»ç®¡â†’è´¨é‡ç»ç†ï¼Œä¾èµ– v2.0.0ï¼‰
- [ ] åç¦»æŠ¥å‘Šå®¡æ‰¹é€šè¿‡åï¼ŒçŠ¶æ€å˜ä¸º approvedï¼Œè®°å½•å½’æ¡£
- [ ] åç¦»æŠ¥å‘Šå®¡æ‰¹æ‹’ç»åï¼ŒçŠ¶æ€å˜ä¸º rejectedï¼Œè®°å½•å›åˆ°è‰ç¨¿çŠ¶æ€
- [ ] åç¦»æŠ¥å‘Šä¸å¯æ‰‹åŠ¨ä¿®æ”¹ï¼Œåªèƒ½æŸ¥çœ‹å’Œå®¡æ‰¹

---

### 13.2 Phase 9ï¼šæ•°æ®å¯¼å‡º

#### 13.2.1 ä¸šåŠ¡èƒŒæ™¯

**æ ¸å¿ƒé—®é¢˜**ï¼š
1. ç®¡ç†å±‚éœ€è¦å®šæœŸæ±‡æŠ¥ç”Ÿäº§æ•°æ®ã€åç¦»æƒ…å†µã€å®¡æ‰¹æ•ˆç‡ç­‰æŒ‡æ ‡
2. å½“å‰ç³»ç»Ÿåªèƒ½åœ¨é¡µé¢æŸ¥çœ‹ï¼Œæ— æ³•å¯¼å‡ºExcelè¿›è¡ŒäºŒæ¬¡åˆ†æ
3. æ•°æ®åˆ†æå¸ˆéœ€è¦æ‰¹é‡å¯¼å‡ºæ•°æ®è¿›è¡Œç»Ÿè®¡åˆ†æ

**ä¸šåŠ¡ç›®æ ‡**ï¼š
- æ”¯æŒæ‰¹é‡å¯¼å‡ºæ–‡æ¡£åˆ—è¡¨ã€ä»»åŠ¡è®°å½•ã€åç¦»æŠ¥å‘Šä¸º Excel æ ¼å¼
- å¯¼å‡ºæ–‡ä»¶åŒ…å«å¿…è¦çš„å­—æ®µå’Œè¿‡æ»¤æ¡ä»¶ï¼Œæ–¹ä¾¿äºŒæ¬¡åˆ†æ
- å¯¼å‡ºè¿‡ç¨‹ä¸é˜»å¡ç”¨æˆ·æ“ä½œï¼Œå¤§æ‰¹é‡å¯¼å‡ºæ—¶å¼‚æ­¥ç”Ÿæˆ

#### 13.2.2 ç”¨æˆ·æ•…äº‹

**æ•…äº‹1ï¼šéƒ¨é—¨ä¸»ç®¡å¯¼å‡ºæ–‡æ¡£åˆ—è¡¨**
```
ä½œä¸ºï¼šéƒ¨é—¨ä¸»ç®¡
æˆ‘æƒ³è¦ï¼šå¯¼å‡ºæœ¬éƒ¨é—¨çš„æ‰€æœ‰ä¸€çº§/äºŒçº§/ä¸‰çº§æ–‡ä»¶åˆ—è¡¨ï¼ˆExcelï¼‰
ä»¥ä¾¿ï¼šè¿›è¡Œæ–‡æ¡£ç›˜ç‚¹å’Œåˆè§„æ€§æ£€æŸ¥

éªŒæ”¶æ ‡å‡†ï¼š
- èƒ½æŒ‰æ–‡æ¡£çº§åˆ«ï¼ˆ1/2/3ï¼‰ã€éƒ¨é—¨ã€çŠ¶æ€ã€æ—¶é—´èŒƒå›´ç­›é€‰å¯¼å‡º
- å¯¼å‡ºå­—æ®µï¼šç¼–å·ã€åç§°ã€ç‰ˆæœ¬ã€çŠ¶æ€ã€åˆ›å»ºäººã€åˆ›å»ºæ—¶é—´ã€å®¡æ‰¹äººã€å®¡æ‰¹æ—¶é—´
- å¯¼å‡ºæ–‡ä»¶åæ ¼å¼ï¼šæ–‡æ¡£åˆ—è¡¨_éƒ¨é—¨åç§°_20260205.xlsx
- å¯¼å‡ºåè‡ªåŠ¨ä¸‹è½½æˆ–æä¾›ä¸‹è½½é“¾æ¥
```

**æ•…äº‹2ï¼šè´¨é‡ä¸»ç®¡å¯¼å‡ºåç¦»æŠ¥å‘Š**
```
ä½œä¸ºï¼šè´¨é‡ä¸»ç®¡
æˆ‘æƒ³è¦ï¼šå¯¼å‡ºæŸä¸ªæ—¶é—´æ®µå†…çš„æ‰€æœ‰åç¦»æŠ¥å‘Šï¼ˆExcelï¼‰
ä»¥ä¾¿ï¼šåˆ†æåç¦»è¶‹åŠ¿ï¼Œåˆ¶å®šæ”¹è¿›æªæ–½

éªŒæ”¶æ ‡å‡†ï¼š
- èƒ½æŒ‰æ¨¡æ¿ã€éƒ¨é—¨ã€æ—¶é—´èŒƒå›´ç­›é€‰å¯¼å‡º
- å¯¼å‡ºå­—æ®µï¼šè®°å½•IDã€é…æ–¹åç§°ã€å­—æ®µåç§°ã€æœŸæœ›å€¼ã€å®é™…å€¼ã€åç¦»é‡ã€åç¦»ç‡ã€åŸå› ã€å®¡æ‰¹çŠ¶æ€
- æ¯ä¸ªåç¦»æŠ¥å‘Šå•ç‹¬ä¸€è¡Œï¼Œä¾¿äºç»Ÿè®¡åˆ†æ
- æ”¯æŒå¯¼å‡ºè¶…è¿‡1000æ¡æ•°æ®ï¼ˆå¼‚æ­¥å¯¼å‡ºï¼‰
```

**æ•…äº‹3ï¼šæ•°æ®åˆ†æå¸ˆå¯¼å‡ºä»»åŠ¡è®°å½•**
```
ä½œä¸ºï¼šæ•°æ®åˆ†æå¸ˆ
æˆ‘æƒ³è¦ï¼šå¯¼å‡ºæŸä¸ªæ¨¡æ¿çš„æ‰€æœ‰ä»»åŠ¡å¡«å†™è®°å½•ï¼ˆExcelï¼‰
ä»¥ä¾¿ï¼šåˆ†æç”Ÿäº§æ•°æ®ï¼Œå‘ç°è§„å¾‹å’Œå¼‚å¸¸

éªŒæ”¶æ ‡å‡†ï¼š
- å¯¼å‡ºè¡¨å¤´åŒ…å«å›ºå®šåˆ—ï¼ˆä»»åŠ¡IDã€æäº¤äººã€æäº¤æ—¶é—´ã€çŠ¶æ€ï¼‰+ åŠ¨æ€åˆ—ï¼ˆæ¨¡æ¿å­—æ®µï¼‰
- åŠ¨æ€åˆ—æ ¹æ®æ¨¡æ¿å­—æ®µåŠ¨æ€ç”Ÿæˆï¼ˆå¦‚ï¼šåŸæ–™Aã€æ¸©åº¦ã€æ—¶é—´...ï¼‰
- æ”¯æŒå¯¼å‡ºå¤šä¸ªéƒ¨é—¨çš„æ•°æ®
- å¯¼å‡ºåæ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 50MBï¼ˆè¶…è¿‡åˆ™åˆ†æ‰¹å¯¼å‡ºï¼‰
```

#### 13.2.3 åŠŸèƒ½éœ€æ±‚

##### 13.2.3.1 æ–‡æ¡£åˆ—è¡¨å¯¼å‡º

**è¾“å…¥å‚æ•°**ï¼š
- levelï¼šæ–‡æ¡£çº§åˆ«ï¼ˆ1/2/3ï¼‰
- departmentIdï¼šéƒ¨é—¨IDï¼ˆå¯é€‰ï¼‰
- statusï¼šæ–‡æ¡£çŠ¶æ€ï¼ˆå¯é€‰ï¼šdraft/pending/approved/rejected/inactiveï¼‰
- startDateï¼šå¼€å§‹æ—¥æœŸï¼ˆå¯é€‰ï¼‰
- endDateï¼šç»“æŸæ—¥æœŸï¼ˆå¯é€‰ï¼‰

**è¾“å‡º**ï¼š
- Excel æ–‡ä»¶ï¼ˆ.xlsxæ ¼å¼ï¼‰
- æ–‡ä»¶åï¼šæ–‡æ¡£åˆ—è¡¨_{level}çº§_{éƒ¨é—¨åç§°}_{æ—¥æœŸ}.xlsx

**å¯¼å‡ºå­—æ®µ**ï¼š
| å­—æ®µå | æ•°æ®æ¥æº |
|-------|---------|
| æ–‡æ¡£ç¼–å· | Document.number |
| æ–‡æ¡£æ ‡é¢˜ | Document.title |
| ç‰ˆæœ¬å· | Document.version |
| çŠ¶æ€ | Document.status |
| åˆ›å»ºäºº | User.name |
| åˆ›å»ºæ—¶é—´ | Document.createdAt |
| å®¡æ‰¹äºº | User.name |
| å®¡æ‰¹æ—¶é—´ | Document.approvedAt |

**ä¸šåŠ¡è§„åˆ™**ï¼š
- ä»…å¯¼å‡ºå½“å‰ç”¨æˆ·æœ‰æƒé™æŸ¥çœ‹çš„æ–‡æ¡£
- è½¯åˆ é™¤çš„æ–‡æ¡£ä¸å¯¼å‡º
- å¯¼å‡ºæ•°é‡ â‰¤1000æ¡ï¼šåŒæ­¥å¯¼å‡ºï¼Œç›´æ¥è¿”å›æ–‡ä»¶
- å¯¼å‡ºæ•°é‡ >1000æ¡ï¼šå¼‚æ­¥å¯¼å‡ºï¼Œè¿”å›ä»»åŠ¡IDï¼Œç”¨æˆ·è½®è¯¢ä¸‹è½½

##### 13.2.3.2 ä»»åŠ¡è®°å½•å¯¼å‡º

**è¾“å…¥å‚æ•°**ï¼š
- templateIdï¼šæ¨¡æ¿IDï¼ˆå¿…å¡«ï¼‰
- departmentIdï¼šéƒ¨é—¨IDï¼ˆå¯é€‰ï¼‰
- startDateï¼šå¼€å§‹æ—¥æœŸï¼ˆå¿…å¡«ï¼‰
- endDateï¼šç»“æŸæ—¥æœŸï¼ˆå¿…å¡«ï¼‰

**è¾“å‡º**ï¼š
- Excel æ–‡ä»¶ï¼ˆ.xlsxæ ¼å¼ï¼‰
- æ–‡ä»¶åï¼šä»»åŠ¡è®°å½•_{æ¨¡æ¿åç§°}_{æ—¥æœŸ}.xlsx

**å¯¼å‡ºå­—æ®µ**ï¼ˆåŠ¨æ€åˆ—ï¼‰ï¼š
| å›ºå®šåˆ— | è¯´æ˜ |
|--------|------|
| ä»»åŠ¡ID | Task.id |
| æ¨¡æ¿åç§° | Template.title |
| æäº¤äºº | User.name |
| æäº¤æ—¶é—´ | TaskRecord.submittedAt |
| å®¡æ‰¹çŠ¶æ€ | TaskRecord.status |
| æ˜¯å¦åç¦» | TaskRecord.hasDeviation |

| åŠ¨æ€åˆ— | è¯´æ˜ |
|--------|------|
| {å­—æ®µæ ‡ç­¾} | TaskRecord.dataJson[å­—æ®µåç§°] |

**ç¤ºä¾‹**ï¼š
```
| ä»»åŠ¡ID | æ¨¡æ¿åç§° | æäº¤äºº | æäº¤æ—¶é—´ | å®¡æ‰¹çŠ¶æ€ | æ˜¯å¦åç¦» | åŸæ–™A(g) | æ¸©åº¦(Â°C) | æ—¶é—´(min) |
|--------|---------|--------|----------|----------|---------|---------|---------|----------|
| xxx-1  | ç”Ÿäº§è®°å½•  | å¼ ä¸‰   | 2026-02-05 | approved | æ˜¯      | 103     | 190     | 28       |
| xxx-2  | ç”Ÿäº§è®°å½•  | æå››   | 2026-02-06 | approved | å¦      | 100     | 180     | 30       |
```

**ä¸šåŠ¡è§„åˆ™**ï¼š
- åŠ¨æ€åˆ—æ ¹æ®æ¨¡æ¿ fieldsJson åŠ¨æ€ç”Ÿæˆ
- æ•°å€¼å‹å­—æ®µæ˜¾ç¤ºæ•°å€¼ï¼Œæ—¥æœŸå‹å­—æ®µæ ¼å¼åŒ–ä¸º YYYY-MM-DD
- ä¸‹æ‹‰å‹å­—æ®µæ˜¾ç¤ºé€‰é¡¹æ ‡ç­¾ï¼ˆlabelï¼‰ï¼Œä¸æ˜¯å€¼ï¼ˆvalueï¼‰
- ä»…å¯¼å‡ºå·²æäº¤çš„è®°å½•ï¼ˆstatus = submitted/approved/rejectedï¼‰

##### 13.2.3.3 åç¦»æŠ¥å‘Šå¯¼å‡º

**è¾“å…¥å‚æ•°**ï¼š
- templateIdï¼šæ¨¡æ¿IDï¼ˆå¯é€‰ï¼‰
- departmentIdï¼šéƒ¨é—¨IDï¼ˆå¯é€‰ï¼‰
- startDateï¼šå¼€å§‹æ—¥æœŸï¼ˆå¿…å¡«ï¼‰
- endDateï¼šç»“æŸæ—¥æœŸï¼ˆå¿…å¡«ï¼‰

**è¾“å‡º**ï¼š
- Excel æ–‡ä»¶ï¼ˆ.xlsxæ ¼å¼ï¼‰
- æ–‡ä»¶åï¼šåç¦»æŠ¥å‘Š_{æ—¶é—´æ®µ}.xlsx

**å¯¼å‡ºå­—æ®µ**ï¼š
| å­—æ®µå | æ•°æ®æ¥æº |
|--------|---------|
| è®°å½•ID | TaskRecord.id |
| é…æ–¹æ¨¡æ¿ | Template.title |
| é…æ–¹ç‰ˆæœ¬ | TaskRecord.relatedTemplateVersion |
| å­—æ®µåç§° | DeviationReport.fieldName |
| æœŸæœ›å€¼ | DeviationReport.expectedValue |
| å®é™…å€¼ | DeviationReport.actualValue |
| å…¬å·®æœ€å°å€¼ | DeviationReport.toleranceMin |
| å…¬å·®æœ€å¤§å€¼ | DeviationReport.toleranceMax |
| åç¦»é‡ | DeviationReport.deviationAmount |
| åç¦»ç‡(%) | DeviationReport.deviationRate |
| åç¦»åŸå›  | DeviationReport.reason |
| æŠ¥å‘Šäºº | User.name |
| æŠ¥å‘Šæ—¶é—´ | DeviationReport.reportedAt |
| å®¡æ‰¹çŠ¶æ€ | DeviationReport.status |
| å®¡æ‰¹äºº | User.name |
| å®¡æ‰¹æ—¶é—´ | DeviationReport.approvedAt |

**ä¸šåŠ¡è§„åˆ™**ï¼š
- ä¸€ä¸ªä»»åŠ¡è®°å½•æœ‰å¤šä¸ªåç¦»å­—æ®µæ—¶ï¼Œæ¯ä¸ªå­—æ®µå•ç‹¬ä¸€è¡Œ
- ä»…å¯¼å‡ºå·²ç”Ÿæˆåç¦»æŠ¥å‘Šçš„è®°å½•ï¼ˆhasDeviation = trueï¼‰
- æŒ‰æŠ¥å‘Šæ—¶é—´å€’åºæ’åº

#### 13.2.4 ä¸šåŠ¡è§„åˆ™ï¼ˆæ–°å¢ï¼‰

| è§„åˆ™ç¼–å· | è§„åˆ™æè¿° |
|---------|----------|
| BR-025 | å¯¼å‡ºåŠŸèƒ½ä»…é™æœ‰æƒé™çš„ç”¨æˆ·ä½¿ç”¨ï¼ˆAdminå¯å¯¼å‡ºå…¨éƒ¨ï¼ŒLeaderå¯å¯¼å‡ºæœ¬éƒ¨é—¨ï¼‰ |
| BR-026 | å¯¼å‡ºæ•°é‡ â‰¤1000æ¡ï¼šåŒæ­¥å¯¼å‡ºï¼›>1000æ¡ï¼šå¼‚æ­¥å¯¼å‡ºï¼Œç”Ÿæˆä¸‹è½½é“¾æ¥ |
| BR-027 | å¼‚æ­¥å¯¼å‡ºæ–‡ä»¶ä¿ç•™7å¤©ï¼Œè¶…æœŸè‡ªåŠ¨åˆ é™¤ |
| BR-028 | å¯¼å‡ºæ–‡ä»¶åæ ¼å¼ï¼š{ç±»å‹}_{ç­›é€‰æ¡ä»¶}_{æ—¥æœŸæ—¶é—´}.xlsx |
| BR-029 | åŠ¨æ€åˆ—å¯¼å‡ºæ—¶ï¼Œå­—æ®µé¡ºåºä¸æ¨¡æ¿å­—æ®µæ’åºä¸€è‡´ |
| BR-030 | å¯¼å‡ºæ–‡ä»¶å¤§å°é™åˆ¶ï¼šå•ä¸ªæ–‡ä»¶æœ€å¤§ 50MB |

#### 13.2.5 å¯¼å‡ºæ ¼å¼å®šä¹‰

**Excel æ ·å¼è§„èŒƒ**ï¼š
- è¡¨å¤´è¡Œï¼šç²—ä½“ + èƒŒæ™¯è‰²ï¼ˆæµ…è“è‰²ï¼‰+ å†»ç»“é¦–è¡Œ
- æ•°æ®è¡Œï¼šå¶æ•°è¡Œæµ…ç°è‰²èƒŒæ™¯ï¼ˆæ¡çº¹æ ·å¼ï¼‰
- åˆ—å®½ï¼šè‡ªåŠ¨è°ƒæ•´ï¼ˆæ ¹æ®å†…å®¹é•¿åº¦ï¼‰
- æ—¥æœŸæ ¼å¼ï¼šYYYY-MM-DD HH:mm:ss
- æ•°å€¼æ ¼å¼ï¼šä¿ç•™2ä½å°æ•°

**æ–‡ä»¶å‘½åè§„èŒƒ**ï¼š
```
æ–‡æ¡£åˆ—è¡¨_{level}çº§_{éƒ¨é—¨åç§°}_{YYYYMMDD}.xlsx
ä»»åŠ¡è®°å½•_{æ¨¡æ¿åç§°}_{YYYYMMDD}.xlsx
åç¦»æŠ¥å‘Š_{YYYYMMDD_HHMMSS}.xlsx
```

#### 13.2.6 æƒé™æ§åˆ¶

| è§’è‰² | æƒé™èŒƒå›´ |
|------|---------|
| Admin | å¯å¯¼å‡ºæ‰€æœ‰éƒ¨é—¨çš„æ•°æ® |
| Leader | å¯å¯¼å‡ºæœ¬éƒ¨é—¨çš„æ•°æ® |
| User | å¯å¯¼å‡ºè‡ªå·±åˆ›å»º/æäº¤çš„æ•°æ® |

**æƒé™éªŒè¯é€»è¾‘**ï¼š
```
IF role = 'admin' THEN
  å…è®¸å¯¼å‡ºæ‰€æœ‰æ•°æ®
ELSE IF role = 'leader' THEN
  è¿‡æ»¤æ¡ä»¶ï¼šdepartmentId = ç”¨æˆ·æ‰€åœ¨éƒ¨é—¨ID
ELSE IF role = 'user' THEN
  è¿‡æ»¤æ¡ä»¶ï¼šcreatorId = å½“å‰ç”¨æˆ·ID æˆ– submitterId = å½“å‰ç”¨æˆ·ID
END IF
```

#### 13.2.7 éªŒæ”¶æ ‡å‡†

**Phase 9 åŠŸèƒ½éªŒæ”¶æ¸…å•**ï¼š

- [ ] éƒ¨é—¨ä¸»ç®¡èƒ½æŒ‰çº§åˆ«ã€éƒ¨é—¨ã€çŠ¶æ€ã€æ—¶é—´èŒƒå›´å¯¼å‡ºæ–‡æ¡£åˆ—è¡¨
- [ ] å¯¼å‡ºçš„æ–‡æ¡£åˆ—è¡¨åŒ…å«ç¼–å·ã€åç§°ã€ç‰ˆæœ¬ã€çŠ¶æ€ã€åˆ›å»ºäººã€å®¡æ‰¹äººã€æ—¶é—´ç­‰å­—æ®µ
- [ ] è´¨é‡ä¸»ç®¡èƒ½æŒ‰æ¨¡æ¿ã€éƒ¨é—¨ã€æ—¶é—´èŒƒå›´å¯¼å‡ºåç¦»æŠ¥å‘Š
- [ ] åç¦»æŠ¥å‘Šå¯¼å‡ºåŒ…å«å­—æ®µåç§°ã€æœŸæœ›å€¼ã€å®é™…å€¼ã€åç¦»é‡ã€åç¦»ç‡ã€åŸå› ç­‰å­—æ®µ
- [ ] æ•°æ®åˆ†æå¸ˆèƒ½å¯¼å‡ºä»»åŠ¡è®°å½•ï¼Œè¡¨å¤´åŒ…å«å›ºå®šåˆ—+åŠ¨æ€åˆ—ï¼ˆæ¨¡æ¿å­—æ®µï¼‰
- [ ] åŠ¨æ€åˆ—æ ¹æ®æ¨¡æ¿å­—æ®µè‡ªåŠ¨ç”Ÿæˆï¼Œé¡ºåºä¸æ¨¡æ¿ä¸€è‡´
- [ ] å¯¼å‡ºæ•°é‡ â‰¤1000æ¡æ—¶ï¼ŒåŒæ­¥è¿”å›æ–‡ä»¶ï¼Œç›´æ¥ä¸‹è½½
- [ ] å¯¼å‡ºæ•°é‡ >1000æ¡æ—¶ï¼Œå¼‚æ­¥ç”Ÿæˆæ–‡ä»¶ï¼Œè¿”å›ä»»åŠ¡IDï¼Œæä¾›ä¸‹è½½é“¾æ¥
- [ ] å¼‚æ­¥å¯¼å‡ºæ–‡ä»¶ä¿ç•™7å¤©ï¼Œè¶…æœŸè‡ªåŠ¨åˆ é™¤
- [ ] å¯¼å‡ºæƒé™æ§åˆ¶ï¼šAdminå¯å¯¼å‡ºå…¨éƒ¨ï¼ŒLeaderå¯å¯¼å‡ºæœ¬éƒ¨é—¨ï¼ŒUserå¯å¯¼å‡ºè‡ªå·±çš„
- [ ] å¯¼å‡ºæ–‡ä»¶å‘½åè§„èŒƒï¼Œæ˜“äºè¯†åˆ«
- [ ] Excel æ ·å¼è§„èŒƒï¼šè¡¨å¤´ç²—ä½“+èƒŒæ™¯è‰²ï¼Œæ•°æ®è¡Œæ¡çº¹æ ·å¼ï¼Œåˆ—å®½è‡ªåŠ¨è°ƒæ•´

---


### 13.4 Phase 11ï¼šæ–‡ä»¶é¢„è§ˆ

#### 13.4.1 ä¸šåŠ¡èƒŒæ™¯

**æ ¸å¿ƒé—®é¢˜**ï¼š
1. å››çº§æ–‡æ¡£ä½“ç³»ä¸­ï¼ŒLevel 1-3 ä¸ºä¸Šä¼ çš„æ–‡ä»¶ï¼ˆPDF/Word/Excelï¼‰ï¼Œç”¨æˆ·éœ€è¦ä¸‹è½½åæ‰èƒ½æŸ¥çœ‹å†…å®¹
2. ä¸‹è½½æŸ¥çœ‹æ•ˆç‡ä½ï¼Œå°¤å…¶åœ¨ç§»åŠ¨ç«¯æˆ–ç½‘ç»œä¸ä½³çš„æƒ…å†µä¸‹ä½“éªŒå·®
3. æ— æ³•å¿«é€Ÿç¡®è®¤æ–‡ä»¶å†…å®¹æ˜¯å¦æ­£ç¡®ï¼Œå¯¼è‡´é‡å¤ä¸‹è½½

**ä¸šåŠ¡ç›®æ ‡**ï¼š
- æ”¯æŒ PDF/Word/Excel å…¨æ ¼å¼åœ¨çº¿é¢„è§ˆï¼Œæ— éœ€ä¸‹è½½
- é¢„è§ˆæ€§èƒ½ä¼˜åŒ–ï¼Œé¦–å±åŠ è½½æ—¶é—´ < 5ç§’
- æ”¯æŒé¢„è§ˆç¼“å­˜ï¼Œç›¸åŒæ–‡ä»¶äºŒæ¬¡è®¿é—®æ›´å¿«
- ç§»åŠ¨ç«¯è‡ªé€‚åº”ï¼Œæ”¯æŒç¼©æ”¾ã€ç¿»é¡µç­‰åŸºç¡€æ“ä½œ

#### 13.4.2 ç”¨æˆ·æ•…äº‹

**æ•…äº‹1ï¼šå¿«é€Ÿé¢„è§ˆæ–‡æ¡£**
```
ä½œä¸ºï¼šè´¨é‡ä¸»ç®¡
æˆ‘æƒ³è¦ï¼šåœ¨æ–‡æ¡£åˆ—è¡¨ä¸­ç‚¹å‡»æ–‡ä»¶åï¼Œç›´æ¥åœ¨æµè§ˆå™¨ä¸­é¢„è§ˆæ–‡ä»¶å†…å®¹
ä»¥ä¾¿ï¼šå¿«é€Ÿç¡®è®¤æ–‡ä»¶å†…å®¹ï¼Œæ— éœ€ä¸‹è½½åˆ°æœ¬åœ°

éªŒæ”¶æ ‡å‡†ï¼š
- ç‚¹å‡»æ–‡ä»¶åï¼Œå¼¹å‡ºé¢„è§ˆçª—å£ï¼Œæ˜¾ç¤ºæ–‡ä»¶å†…å®¹
- æ”¯æŒ PDFã€Wordï¼ˆ.doc/.docxï¼‰ã€Excelï¼ˆ.xls/.xlsxï¼‰ä¸‰ç§æ ¼å¼
- é¢„è§ˆçª—å£æ”¯æŒå…³é—­ã€ä¸‹è½½ã€æ‰“å°æ“ä½œ
- é¢„è§ˆå¤±è´¥æ—¶ï¼Œæç¤ºç”¨æˆ·å¹¶æä¾›ä¸‹è½½é“¾æ¥
```

**æ•…äº‹2ï¼šExcel è¡¨æ ¼é¢„è§ˆ**
```
ä½œä¸ºï¼šç”Ÿäº§å‘˜å·¥
æˆ‘æƒ³è¦ï¼šé¢„è§ˆ Excel æ–‡ä»¶æ—¶ï¼Œèƒ½çœ‹åˆ°å®Œæ•´çš„è¡¨æ ¼ç»“æ„å’Œæ•°æ®
ä»¥ä¾¿ï¼šç¡®è®¤é…æ–™è¡¨æˆ–é…æ–¹è¡¨çš„å†…å®¹å‡†ç¡®æ€§

éªŒæ”¶æ ‡å‡†ï¼š
- Excel é¢„è§ˆä¿ç•™åŸå§‹æ ·å¼ï¼ˆå­—ä½“ã€é¢œè‰²ã€è¾¹æ¡†ï¼‰
- æ”¯æŒå¤š Sheet åˆ‡æ¢ï¼ˆå¦‚æœæ–‡ä»¶æœ‰å¤šä¸ªå·¥ä½œè¡¨ï¼‰
- æ”¯æŒåˆ—å®½è‡ªé€‚åº”ï¼Œè¡¨æ ¼å†…å®¹ä¸æˆªæ–­
- é¢„è§ˆçª—å£æ”¯æŒç¼©æ”¾ï¼ˆæ”¾å¤§/ç¼©å°ï¼‰
```

**æ•…äº‹3ï¼šWord æ–‡æ¡£é¢„è§ˆ**
```
ä½œä¸ºï¼šç ”å‘å·¥ç¨‹å¸ˆ
æˆ‘æƒ³è¦ï¼šé¢„è§ˆ Word æ–‡æ¡£æ—¶ï¼Œèƒ½çœ‹åˆ°å®Œæ•´çš„æ ¼å¼å’Œå›¾ç‰‡
ä»¥ä¾¿ï¼šç¡®è®¤å·¥è‰ºæ–‡ä»¶çš„æ’ç‰ˆå’Œå†…å®¹æ— è¯¯

éªŒæ”¶æ ‡å‡†ï¼š
- Word é¢„è§ˆä¿ç•™åŸå§‹æ ¼å¼ï¼ˆæ ‡é¢˜ã€æ®µè½ã€åˆ—è¡¨ï¼‰
- å›¾ç‰‡å’Œè¡¨æ ¼æ­£å¸¸æ˜¾ç¤º
- æ”¯æŒæ»šåŠ¨ç¿»é¡µ
- é¢„è§ˆçª—å£æ”¯æŒå…¨å±æ¨¡å¼
```

**æ•…äº‹4ï¼šPDF æ–‡æ¡£é¢„è§ˆ**
```
ä½œä¸ºï¼šè´¨é‡å®¡è®¡å‘˜
æˆ‘æƒ³è¦ï¼šé¢„è§ˆ PDF æ–‡ä»¶æ—¶ï¼Œèƒ½é€é¡µæŸ¥çœ‹å¹¶å¿«é€Ÿè·³è½¬åˆ°æŒ‡å®šé¡µ
ä»¥ä¾¿ï¼šå®¡æŸ¥æ–‡æ¡£å†…å®¹ï¼Œå®šä½å…³é”®ä¿¡æ¯

éªŒæ”¶æ ‡å‡†ï¼š
- PDF é¢„è§ˆæ˜¾ç¤ºé¡µç ï¼Œæ”¯æŒè¾“å…¥é¡µç è·³è½¬
- æ”¯æŒä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µæŒ‰é’®
- æ”¯æŒç¼©æ”¾ï¼ˆé€‚åº”å®½åº¦ã€é€‚åº”é«˜åº¦ã€è‡ªå®šä¹‰æ¯”ä¾‹ï¼‰
- é¢„è§ˆæ¸…æ™°åº¦é«˜ï¼Œæ–‡å­—å¯æ­£å¸¸é˜…è¯»
```

**æ•…äº‹5ï¼šé¢„è§ˆæ€§èƒ½ä¼˜åŒ–**
```
ä½œä¸ºï¼šç³»ç»Ÿç”¨æˆ·
æˆ‘æƒ³è¦ï¼šé¢„è§ˆæ–‡ä»¶æ—¶åŠ è½½é€Ÿåº¦å¿«ï¼Œä¸å¡é¡¿
ä»¥ä¾¿ï¼šæé«˜å·¥ä½œæ•ˆç‡ï¼Œå‡å°‘ç­‰å¾…æ—¶é—´

éªŒæ”¶æ ‡å‡†ï¼š
- é¦–æ¬¡é¢„è§ˆæ–‡ä»¶ï¼ŒåŠ è½½æ—¶é—´ < 5ç§’ï¼ˆ10MB ä»¥å†…æ–‡ä»¶ï¼‰
- äºŒæ¬¡é¢„è§ˆç›¸åŒæ–‡ä»¶ï¼ŒåŠ è½½æ—¶é—´ < 1ç§’ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
- é¢„è§ˆåŠ è½½æ—¶ï¼Œæ˜¾ç¤ºè¿›åº¦æ¡æˆ–åŠ è½½åŠ¨ç”»
- è¶…å¤§æ–‡ä»¶ï¼ˆ>10MBï¼‰æç¤ºç”¨æˆ·æ–‡ä»¶è¾ƒå¤§ï¼Œå»ºè®®ä¸‹è½½æŸ¥çœ‹
```

#### 13.4.3 åŠŸèƒ½éœ€æ±‚

##### 13.4.3.1 PDF é¢„è§ˆ

**æŠ€æœ¯æ–¹æ¡ˆ**ï¼š
- å‰ç«¯ä½¿ç”¨ PDF.js ç›´æ¥æ¸²æŸ“ PDF æ–‡ä»¶
- åç«¯æä¾›æ–‡ä»¶æµæ¥å£ï¼Œæ”¯æŒåˆ†æ®µåŠ è½½ï¼ˆHTTP Range è¯·æ±‚ï¼‰

**åŠŸèƒ½åˆ—è¡¨**ï¼š
- âœ… é€é¡µæ¸²æŸ“ï¼Œæ”¯æŒç¿»é¡µï¼ˆä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µ/è·³è½¬é¡µï¼‰
- âœ… ç¼©æ”¾æ§åˆ¶ï¼ˆæ”¾å¤§/ç¼©å°/é€‚åº”å®½åº¦/é€‚åº”é«˜åº¦ï¼‰
- âœ… å…¨å±æ¨¡å¼
- âœ… ä¸‹è½½åŸæ–‡ä»¶
- âœ… æ‰“å°ï¼ˆè°ƒç”¨æµè§ˆå™¨æ‰“å°åŠŸèƒ½ï¼‰

**ä¸šåŠ¡è§„åˆ™**ï¼š
- PDF æ–‡ä»¶ â‰¤10MB ç›´æ¥é¢„è§ˆ
- PDF æ–‡ä»¶ >10MB æç¤º"æ–‡ä»¶è¾ƒå¤§ï¼Œå»ºè®®ä¸‹è½½æŸ¥çœ‹"ï¼Œä½†ä»å¯å¼ºåˆ¶é¢„è§ˆ

##### 13.4.3.2 Word é¢„è§ˆ

**æŠ€æœ¯æ–¹æ¡ˆ**ï¼š
- åç«¯ä½¿ç”¨ LibreOffice è½¬æ¢ Word â†’ HTML
- å‰ç«¯æ¸²æŸ“ HTML å†…å®¹ï¼Œä¿ç•™æ ¼å¼å’Œå›¾ç‰‡

**åŠŸèƒ½åˆ—è¡¨**ï¼š
- âœ… ä¿ç•™åŸå§‹æ ¼å¼ï¼ˆæ ‡é¢˜ã€æ®µè½ã€åˆ—è¡¨ã€è¡¨æ ¼ï¼‰
- âœ… å›¾ç‰‡æ­£å¸¸æ˜¾ç¤ºï¼ˆåµŒå…¥å›¾ç‰‡è½¬ä¸º Base64 æˆ– MinIO URLï¼‰
- âœ… æ”¯æŒæ»šåŠ¨æµè§ˆ
- âœ… å…¨å±æ¨¡å¼
- âœ… ä¸‹è½½åŸæ–‡ä»¶

**ä¸šåŠ¡è§„åˆ™**ï¼š
- Word æ–‡ä»¶è½¬æ¢åç¼“å­˜ HTMLï¼Œæœ‰æ•ˆæœŸ 7 å¤©
- è½¬æ¢å¤±è´¥ï¼ˆå¦‚æ–‡ä»¶æŸåï¼‰æ—¶ï¼Œæç¤ºç”¨æˆ·å¹¶æä¾›ä¸‹è½½é“¾æ¥
- è½¬æ¢è¶…æ—¶æ—¶é—´ï¼š30 ç§’

##### 13.4.3.3 Excel é¢„è§ˆ

**æŠ€æœ¯æ–¹æ¡ˆ**ï¼š
- åç«¯ä½¿ç”¨ LibreOffice è½¬æ¢ Excel â†’ HTML
- å‰ç«¯æ¸²æŸ“ HTML è¡¨æ ¼ï¼Œæ”¯æŒå¤š Sheet åˆ‡æ¢

**åŠŸèƒ½åˆ—è¡¨**ï¼š
- âœ… ä¿ç•™åŸå§‹æ ·å¼ï¼ˆå­—ä½“ã€é¢œè‰²ã€è¾¹æ¡†ã€å¯¹é½æ–¹å¼ï¼‰
- âœ… å¤š Sheet åˆ‡æ¢ï¼ˆTab æ ‡ç­¾é¡µï¼‰
- âœ… åˆ—å®½è‡ªé€‚åº”
- âœ… æ”¯æŒç¼©æ”¾ï¼ˆæ”¾å¤§/ç¼©å°ï¼‰
- âœ… ä¸‹è½½åŸæ–‡ä»¶

**ä¸šåŠ¡è§„åˆ™**ï¼š
- Excel æ–‡ä»¶è½¬æ¢åç¼“å­˜ HTMLï¼Œæœ‰æ•ˆæœŸ 7 å¤©
- å• Sheet è¡Œæ•° >1000 æ—¶ï¼Œåˆ†é¡µæ˜¾ç¤ºï¼ˆæ¯é¡µ 100 è¡Œï¼‰
- è½¬æ¢å¤±è´¥æ—¶ï¼Œæç¤ºç”¨æˆ·å¹¶æä¾›ä¸‹è½½é“¾æ¥

##### 13.4.3.4 é¢„è§ˆç¼“å­˜æœºåˆ¶

**ç›®æ ‡**ï¼šå‡å°‘é‡å¤è½¬æ¢ï¼Œæé«˜äºŒæ¬¡è®¿é—®é€Ÿåº¦

**ç¼“å­˜ç­–ç•¥**ï¼š
| æ–‡ä»¶ç±»å‹ | ç¼“å­˜å†…å®¹ | ç¼“å­˜æ—¶é•¿ | ç¼“å­˜å­˜å‚¨ |
|---------|---------|---------|---------|
| PDF | æ— éœ€ç¼“å­˜ï¼ˆç›´æ¥æ¸²æŸ“ï¼‰ | - | - |
| Word | è½¬æ¢åçš„ HTML | 7å¤© | MinIOï¼ˆ/preview-cacheï¼‰ |
| Excel | è½¬æ¢åçš„ HTML | 7å¤© | MinIOï¼ˆ/preview-cacheï¼‰ |

**ç¼“å­˜å¤±æ•ˆæ¡ä»¶**ï¼š
- æ–‡ä»¶è¢«æ›´æ–°ï¼ˆVersion è¡¨æ–°å¢ç‰ˆæœ¬è®°å½•ï¼‰
- ç¼“å­˜è¶…è¿‡ 7 å¤©ï¼ˆå®šæ—¶ä»»åŠ¡æ¸…ç†ï¼‰

**ç¼“å­˜é”®ç”Ÿæˆ**ï¼š
```
cacheKey = `preview_${fileId}_${versionId}_${fileHash}`
```

#### 13.4.4 ä¸šåŠ¡è§„åˆ™ï¼ˆæ–°å¢ï¼‰

| è§„åˆ™ç¼–å· | è§„åˆ™æè¿° |
|---------|----------|
| BR-041 | æ”¯æŒ PDFã€Wordï¼ˆ.doc/.docxï¼‰ã€Excelï¼ˆ.xls/.xlsxï¼‰ä¸‰ç§æ ¼å¼åœ¨çº¿é¢„è§ˆ |
| BR-042 | PDF æ–‡ä»¶ç›´æ¥æ¸²æŸ“ï¼ŒWord/Excel æ–‡ä»¶éœ€åç«¯è½¬æ¢ä¸º HTML åé¢„è§ˆ |
| BR-043 | é¢„è§ˆæ–‡ä»¶å¤§å°é™åˆ¶ï¼šâ‰¤10MB ç›´æ¥é¢„è§ˆï¼Œ>10MB æç¤ºå»ºè®®ä¸‹è½½ï¼ˆå¯å¼ºåˆ¶é¢„è§ˆï¼‰ |
| BR-044 | Word/Excel è½¬æ¢åçš„ HTML ç¼“å­˜ 7 å¤©ï¼Œæ–‡ä»¶æ›´æ–°åç¼“å­˜å¤±æ•ˆ |
| BR-045 | é¢„è§ˆåŠ è½½è¶…æ—¶æ—¶é—´ï¼šè½¬æ¢ 30 ç§’ï¼Œæ¸²æŸ“ 10 ç§’ï¼Œè¶…æ—¶æç¤ºå¹¶æä¾›ä¸‹è½½é“¾æ¥ |
| BR-046 | é¢„è§ˆæƒé™ï¼šæ‹¥æœ‰æ–‡æ¡£æŸ¥çœ‹æƒé™çš„ç”¨æˆ·æ‰èƒ½é¢„è§ˆæ–‡ä»¶ |
| BR-047 | Excel å¤š Sheet æ–‡ä»¶æ”¯æŒ Sheet åˆ‡æ¢ï¼Œå• Sheet è¡Œæ•° >1000 æ—¶åˆ†é¡µæ˜¾ç¤º |
| BR-048 | é¢„è§ˆçª—å£æ”¯æŒå…¨å±ã€ç¼©æ”¾ã€ä¸‹è½½ã€æ‰“å°ï¼ˆPDFï¼‰ç­‰æ“ä½œ |
| BR-049 | é¢„è§ˆå¤±è´¥æ—¶ï¼Œæ˜¾ç¤ºå‹å¥½é”™è¯¯æç¤ºï¼Œå¹¶æä¾›ä¸‹è½½åŸæ–‡ä»¶çš„å¤‡ç”¨æ–¹æ¡ˆ |
| BR-050 | é¢„è§ˆç¼“å­˜å­˜å‚¨åœ¨ MinIOï¼ˆ/preview-cache ç›®å½•ï¼‰ï¼Œå®šæ—¶ä»»åŠ¡æ¯æ—¥æ¸…ç†è¿‡æœŸç¼“å­˜ |

#### 13.4.5 æ•°æ®å®ä½“

##### FilePreview è¡¨ï¼ˆæ–°å¢ï¼‰

**ç”¨é€”**ï¼šè®°å½•æ–‡ä»¶é¢„è§ˆç¼“å­˜ä¿¡æ¯ï¼Œä¾¿äºç®¡ç†å’Œæ¸…ç†

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| id | SnowflakeID | ä¸»é”® |
| fileId | SnowflakeID | æ–‡ä»¶IDï¼ˆå…³è” Document æˆ– TaskRecordï¼‰ |
| versionId | SnowflakeID | æ–‡ä»¶ç‰ˆæœ¬IDï¼ˆå…³è” DocumentVersionï¼‰ |
| fileType | String | æ–‡ä»¶ç±»å‹ï¼ˆpdf/word/excelï¼‰ |
| originalFileUrl | String | åŸæ–‡ä»¶ MinIO è·¯å¾„ |
| previewCacheUrl | String | é¢„è§ˆç¼“å­˜æ–‡ä»¶ MinIO è·¯å¾„ï¼ˆHTMLï¼‰ |
| fileHash | String | æ–‡ä»¶å“ˆå¸Œå€¼ï¼ˆMD5ï¼Œç”¨äºç¼“å­˜å¤±æ•ˆåˆ¤æ–­ï¼‰ |
| conversionStatus | String | è½¬æ¢çŠ¶æ€ï¼ˆpending/success/failedï¼‰ |
| conversionError | String | è½¬æ¢å¤±è´¥åŸå› ï¼ˆå¦‚æœ‰ï¼‰ |
| expiresAt | DateTime | ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆåˆ›å»ºæ—¶é—´ + 7 å¤©ï¼‰ |
| createdAt | DateTime | åˆ›å»ºæ—¶é—´ |

**ç´¢å¼•**ï¼š
- `idx_file_version`ï¼š(fileId, versionId) - æŸ¥è¯¢ç¼“å­˜æ—¶ä½¿ç”¨
- `idx_expires_at`ï¼šexpiresAt - å®šæ—¶æ¸…ç†è¿‡æœŸç¼“å­˜

#### 13.4.6 æŠ€æœ¯é€‰å‹

| æ–‡ä»¶ç±»å‹ | æŠ€æœ¯æ–¹æ¡ˆ | è¯´æ˜ |
|---------|---------|------|
| PDF | PDF.jsï¼ˆå‰ç«¯ï¼‰ | Mozilla å¼€æºåº“ï¼Œæ”¯æŒ Canvas/SVG æ¸²æŸ“ï¼Œå…¼å®¹æ€§å¥½ |
| Word/Excel | LibreOfficeï¼ˆåç«¯ï¼‰ | å¼€æºåŠå…¬å¥—ä»¶ï¼Œæ”¯æŒ .doc/.docx/.xls/.xlsx è½¬ HTML |
| é¢„è§ˆç¼“å­˜ | MinIO | å¯¹è±¡å­˜å‚¨ï¼Œæ”¯æŒåˆ†å¸ƒå¼ï¼Œæˆæœ¬ä½ |

**LibreOffice éƒ¨ç½²**ï¼š
- Docker å®¹å™¨éƒ¨ç½²ï¼ˆlibreoffice-online æˆ– unoconvï¼‰
- æä¾› HTTP API æ¥å£ï¼Œæ¥æ”¶æ–‡ä»¶è·¯å¾„ï¼Œè¿”å› HTML
- è½¬æ¢å‘½ä»¤ç¤ºä¾‹ï¼š
  ```bash
  libreoffice --headless --convert-to html --outdir /tmp input.docx
  ```

#### 13.4.7 æ€§èƒ½è¦æ±‚

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|--------|------|
| PDF é¦–æ¬¡åŠ è½½ | < 3ç§’ | 10MB ä»¥å†…æ–‡ä»¶ |
| Word/Excel é¦–æ¬¡è½¬æ¢ | < 5ç§’ | 10MB ä»¥å†…æ–‡ä»¶ |
| ç¼“å­˜å‘½ä¸­åŠ è½½ | < 1ç§’ | ä½¿ç”¨ç¼“å­˜çš„ HTML |
| è½¬æ¢å¹¶å‘æ•° | â‰¥5 | åŒæ—¶æ”¯æŒ 5 ä¸ªæ–‡ä»¶è½¬æ¢è¯·æ±‚ |
| é¢„è§ˆç¼“å­˜å­˜å‚¨ | 100GB | é¢„ä¼°å¯ç¼“å­˜ 10,000+ æ–‡ä»¶ |

#### 13.4.8 éªŒæ”¶æ ‡å‡†

**åŠŸèƒ½éªŒæ”¶**ï¼š
- [ ] PDF æ–‡ä»¶ç‚¹å‡»é¢„è§ˆï¼Œä½¿ç”¨ PDF.js æ¸²æŸ“ï¼Œæ”¯æŒç¿»é¡µã€ç¼©æ”¾ã€å…¨å±
- [ ] Word æ–‡ä»¶ç‚¹å‡»é¢„è§ˆï¼Œåç«¯è½¬æ¢ä¸º HTMLï¼Œä¿ç•™æ ¼å¼å’Œå›¾ç‰‡
- [ ] Excel æ–‡ä»¶ç‚¹å‡»é¢„è§ˆï¼Œåç«¯è½¬æ¢ä¸º HTMLï¼Œæ”¯æŒå¤š Sheet åˆ‡æ¢
- [ ] é¢„è§ˆçª—å£æ”¯æŒä¸‹è½½åŸæ–‡ä»¶ã€å…¨å±æ¨¡å¼ã€ç¼©æ”¾æ“ä½œ
- [ ] æ–‡ä»¶ â‰¤10MB ç›´æ¥é¢„è§ˆï¼Œ>10MB æç¤ºå»ºè®®ä¸‹è½½ï¼ˆå¯å¼ºåˆ¶é¢„è§ˆï¼‰
- [ ] Word/Excel é¢„è§ˆç¼“å­˜ 7 å¤©ï¼ŒäºŒæ¬¡è®¿é—®åŠ è½½ < 1ç§’
- [ ] é¢„è§ˆå¤±è´¥æ—¶ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤ºå¹¶æä¾›ä¸‹è½½é“¾æ¥
- [ ] é¢„è§ˆæƒé™æ ¡éªŒï¼šåªæœ‰æ‹¥æœ‰æ–‡æ¡£æŸ¥çœ‹æƒé™çš„ç”¨æˆ·æ‰èƒ½é¢„è§ˆ
- [ ] Excel å¤š Sheet æ–‡ä»¶æ”¯æŒ Sheet åˆ‡æ¢ï¼Œå• Sheet è¡Œæ•° >1000 æ—¶åˆ†é¡µæ˜¾ç¤º
- [ ] é¢„è§ˆåŠ è½½æ—¶ï¼Œæ˜¾ç¤ºè¿›åº¦æ¡æˆ–åŠ è½½åŠ¨ç”»

**æ€§èƒ½éªŒæ”¶**ï¼š
- [ ] PDF é¢„è§ˆé¦–æ¬¡åŠ è½½æ—¶é—´ < 3ç§’ï¼ˆ10MB ä»¥å†…ï¼‰
- [ ] Word/Excel é¢„è§ˆé¦–æ¬¡è½¬æ¢æ—¶é—´ < 5ç§’ï¼ˆ10MB ä»¥å†…ï¼‰
- [ ] é¢„è§ˆç¼“å­˜å‘½ä¸­æ—¶ï¼ŒåŠ è½½æ—¶é—´ < 1ç§’
- [ ] LibreOffice è½¬æ¢å¹¶å‘æ•° â‰¥5

**å®‰å…¨éªŒæ”¶**ï¼š
- [ ] é¢„è§ˆæ–‡ä»¶å‰æ ¡éªŒç”¨æˆ·æƒé™ï¼Œæ— æƒé™è¿”å› 403
- [ ] é¢„è§ˆç¼“å­˜æ–‡ä»¶å­˜å‚¨åœ¨ MinIOï¼Œä½¿ç”¨ç­¾å URL è®¿é—®
- [ ] è½¬æ¢å¤±è´¥æ—¶ï¼Œä¸æš´éœ²æœåŠ¡å™¨è·¯å¾„æˆ–æ•æ„Ÿä¿¡æ¯

---

### 13.5 Phase 12ï¼šåç¦»ç»Ÿè®¡åˆ†æ

#### 13.5.1 ä¸šåŠ¡èƒŒæ™¯

**æ ¸å¿ƒé—®é¢˜**ï¼š
1. Phase 7-8 å®ç°åç¦»æ£€æµ‹å’ŒæŠ¥å‘Šç”Ÿæˆï¼Œä½†ç¼ºå°‘ç»Ÿè®¡åˆ†æèƒ½åŠ›
2. è´¨é‡ç®¡ç†éœ€è¦äº†è§£åç¦»å‘ç”Ÿé¢‘ç‡ã€ç±»å‹åˆ†å¸ƒã€è¶‹åŠ¿å˜åŒ–ï¼ŒæŒ‡å¯¼æ”¹è¿›
3. æ•°æ®åˆ†æ•£åœ¨å„ä¸ªåç¦»æŠ¥å‘Šä¸­ï¼Œæ— æ³•å¿«é€Ÿè·å–å…¨å±€è§†å›¾

**ä¸šåŠ¡ç›®æ ‡**ï¼š
- æä¾›åç¦»ç»Ÿè®¡åˆ†æåŠŸèƒ½ï¼Œæ”¯æŒæŒ‰æ—¶é—´ã€éƒ¨é—¨ã€æ¨¡æ¿ã€å­—æ®µç­‰ç»´åº¦åˆ†æ
- å¯è§†åŒ–å±•ç¤ºåç¦»è¶‹åŠ¿ã€ç±»å‹åˆ†å¸ƒã€é«˜é¢‘åç¦»å­—æ®µ
- ä¸ºè´¨é‡æ”¹è¿›æä¾›æ•°æ®æ”¯æŒï¼Œè¯†åˆ«è–„å¼±ç¯èŠ‚

#### 13.5.2 ç”¨æˆ·æ•…äº‹

**æ•…äº‹1ï¼šåç¦»æ¬¡æ•°ç»Ÿè®¡**
```
ä½œä¸ºï¼šè´¨é‡ç»ç†
æˆ‘æƒ³è¦ï¼šæŸ¥çœ‹æŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„åç¦»æ¬¡æ•°ç»Ÿè®¡
ä»¥ä¾¿ï¼šäº†è§£æ•´ä½“åç¦»æƒ…å†µï¼Œè¯„ä¼°è´¨é‡æ§åˆ¶æ•ˆæœ

éªŒæ”¶æ ‡å‡†ï¼š
- é€‰æ‹©æ—¶é—´èŒƒå›´ï¼ˆæœ¬å‘¨/æœ¬æœˆ/æœ¬å­£åº¦/è‡ªå®šä¹‰ï¼‰ï¼Œæ˜¾ç¤ºåç¦»æ€»æ¬¡æ•°
- æ˜¾ç¤ºåç¦»ç‡ï¼ˆåç¦»è®°å½•æ•° / æ€»è®°å½•æ•°ï¼‰
- å¯¹æ¯”ä¸ŠæœŸæ•°æ®ï¼Œæ˜¾ç¤ºå¢é•¿ç‡ï¼ˆâ†‘10% / â†“5%ï¼‰
- æ”¯æŒæŒ‰éƒ¨é—¨ç­›é€‰ï¼ˆä»…çœ‹æœ¬éƒ¨é—¨çš„åç¦»ï¼‰
```

**æ•…äº‹2ï¼šåç¦»ç±»å‹åˆ†å¸ƒ**
```
ä½œä¸ºï¼šè´¨é‡ä¸»ç®¡
æˆ‘æƒ³è¦ï¼šæŸ¥çœ‹åç¦»å­—æ®µçš„åˆ†å¸ƒæƒ…å†µï¼Œäº†è§£å“ªäº›å­—æ®µå®¹æ˜“åç¦»
ä»¥ä¾¿ï¼šé’ˆå¯¹æ€§åœ°åŠ å¼ºåŸ¹è®­æˆ–è°ƒæ•´å·¥è‰ºå‚æ•°

éªŒæ”¶æ ‡å‡†ï¼š
- é¥¼å›¾æ˜¾ç¤ºåç¦»å­—æ®µåˆ†å¸ƒï¼ˆå¦‚ï¼šæ¸©åº¦ 40%ã€å‹åŠ› 30%ã€æ—¶é—´ 20%ã€å…¶ä»– 10%ï¼‰
- åˆ—è¡¨æ˜¾ç¤ºåç¦»å­—æ®µæ’åï¼ˆå­—æ®µåã€åç¦»æ¬¡æ•°ã€å æ¯”ï¼‰
- ç‚¹å‡»å­—æ®µåï¼ŒæŸ¥çœ‹è¯¥å­—æ®µçš„åç¦»è¯¦æƒ…åˆ—è¡¨
```

**æ•…äº‹3ï¼šåç¦»è¶‹åŠ¿åˆ†æ**
```
ä½œä¸ºï¼šè´¨é‡å®¡è®¡å‘˜
æˆ‘æƒ³è¦ï¼šæŸ¥çœ‹åç¦»è¶‹åŠ¿å˜åŒ–ï¼Œäº†è§£è´¨é‡æ§åˆ¶æ˜¯å¦æœ‰æ”¹å–„
ä»¥ä¾¿ï¼šè¯„ä¼°è´¨é‡æ”¹è¿›æªæ–½çš„æœ‰æ•ˆæ€§

éªŒæ”¶æ ‡å‡†ï¼š
- æŠ˜çº¿å›¾æ˜¾ç¤ºåç¦»è¶‹åŠ¿ï¼ˆæ¨ªè½´ï¼šæ—¥æœŸï¼Œçºµè½´ï¼šåç¦»æ¬¡æ•°ï¼‰
- æ”¯æŒæŒ‰æ—¥/å‘¨/æœˆèšåˆæ•°æ®
- æ”¯æŒå¤šå­—æ®µå¯¹æ¯”ï¼ˆåŒæ—¶æ˜¾ç¤ºæ¸©åº¦åç¦»å’Œå‹åŠ›åç¦»çš„è¶‹åŠ¿ï¼‰
- å¼‚å¸¸å³°å€¼æ ‡æ³¨ï¼ˆåç¦»æ¬¡æ•°çªå¢çš„æ—¥æœŸï¼‰
```

**æ•…äº‹4ï¼šéƒ¨é—¨åç¦»å¯¹æ¯”**
```
ä½œä¸ºï¼šæ€»ç»ç†
æˆ‘æƒ³è¦ï¼šå¯¹æ¯”å„éƒ¨é—¨çš„åç¦»æƒ…å†µï¼Œäº†è§£å“ªä¸ªéƒ¨é—¨è´¨é‡æ§åˆ¶è¾ƒå¥½
ä»¥ä¾¿ï¼šè¡¨å½°ä¼˜ç§€éƒ¨é—¨ï¼Œç£ä¿ƒæ”¹è¿›ä¸è¶³éƒ¨é—¨

éªŒæ”¶æ ‡å‡†ï¼š
- æŸ±çŠ¶å›¾æ˜¾ç¤ºå„éƒ¨é—¨åç¦»æ¬¡æ•°å¯¹æ¯”
- æ˜¾ç¤ºéƒ¨é—¨åç¦»ç‡æ’åï¼ˆåç¦»ç‡ = åç¦»è®°å½•æ•° / æ€»è®°å½•æ•°ï¼‰
- æ”¯æŒæŒ‰æ—¶é—´èŒƒå›´ç­›é€‰ï¼ˆæœ¬æœˆ/æœ¬å­£åº¦/æœ¬å¹´åº¦ï¼‰
```

**æ•…äº‹5ï¼šé«˜é¢‘åç¦»æŠ¥å‘Šå¯¼å‡º**
```
ä½œä¸ºï¼šè´¨é‡åˆ†æå¸ˆ
æˆ‘æƒ³è¦ï¼šå¯¼å‡ºåç¦»ç»Ÿè®¡æŠ¥å‘Šï¼ˆExcelï¼‰ï¼Œç”¨äºæœˆåº¦è´¨é‡ä¼šè®®
ä»¥ä¾¿ï¼šå‘ç®¡ç†å±‚æ±‡æŠ¥è´¨é‡æ•°æ®ï¼Œæ”¯æŒå†³ç­–

éªŒæ”¶æ ‡å‡†ï¼š
- æ”¯æŒå¯¼å‡ºåç¦»ç»Ÿè®¡æ•°æ®ï¼ˆæ—¶é—´èŒƒå›´ã€éƒ¨é—¨ã€å­—æ®µåˆ†å¸ƒã€è¶‹åŠ¿æ•°æ®ï¼‰
- Excel åŒ…å«å¤šä¸ª Sheetï¼ˆæ€»è§ˆã€å­—æ®µåˆ†å¸ƒã€éƒ¨é—¨å¯¹æ¯”ã€è¶‹åŠ¿æ•°æ®ï¼‰
- å¯¼å‡ºæ–‡ä»¶å‘½åè§„èŒƒï¼šåç¦»ç»Ÿè®¡æŠ¥å‘Š_2026å¹´2æœˆ_è´¨é‡éƒ¨.xlsx
```

#### 13.5.3 åŠŸèƒ½éœ€æ±‚

##### 13.5.3.1 åç¦»æ¬¡æ•°ç»Ÿè®¡

**è¾“å…¥**ï¼š
- æ—¶é—´èŒƒå›´ï¼ˆå¼€å§‹æ—¥æœŸã€ç»“æŸæ—¥æœŸï¼‰
- éƒ¨é—¨ç­›é€‰ï¼ˆå¯é€‰ï¼Œé»˜è®¤å…¨éƒ¨ï¼‰
- æ¨¡æ¿ç­›é€‰ï¼ˆå¯é€‰ï¼Œé»˜è®¤å…¨éƒ¨ï¼‰

**è¾“å‡º**ï¼š
| æŒ‡æ ‡ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| åç¦»æ€»æ¬¡æ•° | åç¦»æŠ¥å‘Šæ•°é‡ | 125 æ¬¡ |
| åç¦»è®°å½•æ•° | åŒ…å«åç¦»çš„ä»»åŠ¡è®°å½•æ•° | 85 æ¡ï¼ˆä¸€æ¡è®°å½•å¯èƒ½æœ‰å¤šä¸ªåç¦»ï¼‰ |
| æ€»è®°å½•æ•° | æ‰€æœ‰ä»»åŠ¡è®°å½•æ•° | 1,000 æ¡ |
| åç¦»ç‡ | åç¦»è®°å½•æ•° / æ€»è®°å½•æ•° | 8.5% |
| ç¯æ¯”å¢é•¿ | å¯¹æ¯”ä¸ŠæœŸåç¦»ç‡å˜åŒ– | â†‘2.3%ï¼ˆä¸ŠæœŸ 6.2%ï¼‰ |

**ä¸šåŠ¡è§„åˆ™**ï¼š
- ç»Ÿè®¡æ—¶é—´èŒƒå›´ï¼šæ”¯æŒé¢„è®¾ï¼ˆæœ¬å‘¨/æœ¬æœˆ/æœ¬å­£åº¦ï¼‰å’Œè‡ªå®šä¹‰
- åç¦»ç‡è®¡ç®—å…¬å¼ï¼š`åç¦»ç‡ = (åŒ…å«åç¦»çš„è®°å½•æ•° / æ€»è®°å½•æ•°) * 100%`
- ç¯æ¯”å¢é•¿è®¡ç®—ï¼š`å¢é•¿ç‡ = (æœ¬æœŸåç¦»ç‡ - ä¸ŠæœŸåç¦»ç‡) / ä¸ŠæœŸåç¦»ç‡ * 100%`

##### 13.5.3.2 åç¦»ç±»å‹åˆ†å¸ƒ

**è¾“å…¥**ï¼š
- æ—¶é—´èŒƒå›´
- éƒ¨é—¨ç­›é€‰ï¼ˆå¯é€‰ï¼‰

**è¾“å‡º**ï¼š
| åç¦»å­—æ®µ | åç¦»æ¬¡æ•° | å æ¯” | å¹³å‡åç¦»é‡ |
|---------|---------|------|----------|
| æ¸©åº¦ï¼ˆtemperatureï¼‰ | 50 | 40% | 8.5Â°C |
| å‹åŠ›ï¼ˆpressureï¼‰ | 38 | 30.4% | 0.3MPa |
| æ—¶é—´ï¼ˆdurationï¼‰ | 25 | 20% | 15min |
| æ¹¿åº¦ï¼ˆhumidityï¼‰ | 12 | 9.6% | 5% |

**å¯è§†åŒ–**ï¼š
- é¥¼å›¾ï¼šæ˜¾ç¤ºå„å­—æ®µåç¦»å æ¯”
- æŸ±çŠ¶å›¾ï¼šæ˜¾ç¤ºå„å­—æ®µåç¦»æ¬¡æ•°æ’å

**ä¸šåŠ¡è§„åˆ™**ï¼š
- æŒ‰åç¦»æ¬¡æ•°é™åºæ’åˆ—
- å æ¯”è®¡ç®—å…¬å¼ï¼š`å æ¯” = (è¯¥å­—æ®µåç¦»æ¬¡æ•° / æ€»åç¦»æ¬¡æ•°) * 100%`
- å¹³å‡åç¦»é‡ï¼šè¯¥å­—æ®µæ‰€æœ‰åç¦»çš„åç¦»é‡å¹³å‡å€¼

##### 13.5.3.3 åç¦»è¶‹åŠ¿åˆ†æ

**è¾“å…¥**ï¼š
- æ—¶é—´èŒƒå›´
- èšåˆç»´åº¦ï¼ˆæ—¥/å‘¨/æœˆï¼‰
- å­—æ®µç­›é€‰ï¼ˆå¯é€‰ï¼Œé»˜è®¤å…¨éƒ¨åç¦»ï¼‰

**è¾“å‡º**ï¼š
| æ—¶é—´ç‚¹ | åç¦»æ¬¡æ•° | åç¦»ç‡ |
|-------|---------|--------|
| 2026-02-01 | 5 | 5% |
| 2026-02-02 | 8 | 8% |
| 2026-02-03 | 3 | 3% |
| ... | ... | ... |

**å¯è§†åŒ–**ï¼š
- æŠ˜çº¿å›¾ï¼šæ¨ªè½´æ—¶é—´ï¼Œçºµè½´åç¦»æ¬¡æ•°/åç¦»ç‡
- æ”¯æŒå¤šå­—æ®µå¯¹æ¯”ï¼ˆå¤šæ¡æŠ˜çº¿ï¼‰
- å¼‚å¸¸å³°å€¼æ ‡æ³¨ï¼ˆåç¦»æ¬¡æ•° > å¹³å‡å€¼ + 2*æ ‡å‡†å·®ï¼‰

**ä¸šåŠ¡è§„åˆ™**ï¼š
- æ—¥èšåˆï¼šæŒ‰æäº¤æ—¥æœŸï¼ˆTaskRecord.createdAtï¼‰åˆ†ç»„
- å‘¨èšåˆï¼šæŒ‰å‘¨ï¼ˆISO Weekï¼‰åˆ†ç»„
- æœˆèšåˆï¼šæŒ‰æœˆï¼ˆYYYY-MMï¼‰åˆ†ç»„
- è¶‹åŠ¿çº¿å¹³æ»‘ï¼šæ”¯æŒç§»åŠ¨å¹³å‡ï¼ˆ7æ—¥/30æ—¥ï¼‰

##### 13.5.3.4 éƒ¨é—¨åç¦»å¯¹æ¯”

**è¾“å…¥**ï¼š
- æ—¶é—´èŒƒå›´

**è¾“å‡º**ï¼š
| éƒ¨é—¨ | æ€»è®°å½•æ•° | åç¦»è®°å½•æ•° | åç¦»ç‡ | æ’å |
|------|---------|----------|--------|------|
| ç”Ÿäº§ä¸€éƒ¨ | 500 | 25 | 5% | 1ï¼ˆæœ€ä¼˜ï¼‰ |
| ç”Ÿäº§äºŒéƒ¨ | 450 | 36 | 8% | 2 |
| è´¨æ£€éƒ¨ | 300 | 30 | 10% | 3 |

**å¯è§†åŒ–**ï¼š
- æŸ±çŠ¶å›¾ï¼šæ¨ªè½´éƒ¨é—¨ï¼Œçºµè½´åç¦»ç‡
- é¢œè‰²æ ‡è¯†ï¼šåç¦»ç‡ <5% ç»¿è‰²ï¼Œ5%-10% é»„è‰²ï¼Œ>10% çº¢è‰²

**ä¸šåŠ¡è§„åˆ™**ï¼š
- æŒ‰åç¦»ç‡å‡åºæ’åˆ—ï¼ˆåç¦»ç‡ä½çš„æ’åé å‰ï¼‰
- åªç»Ÿè®¡æœ‰è®°å½•çš„éƒ¨é—¨ï¼ˆæ€»è®°å½•æ•° >0ï¼‰

#### 13.5.4 ä¸šåŠ¡è§„åˆ™ï¼ˆæ–°å¢ï¼‰

| è§„åˆ™ç¼–å· | è§„åˆ™æè¿° |
|---------|----------|
| BR-051 | åç¦»ç‡ = (åŒ…å«åç¦»çš„è®°å½•æ•° / æ€»è®°å½•æ•°) * 100%ï¼Œä¿ç•™ 2 ä½å°æ•° |
| BR-052 | ç»Ÿè®¡æ—¶é—´èŒƒå›´æ”¯æŒé¢„è®¾ï¼ˆæœ¬å‘¨/æœ¬æœˆ/æœ¬å­£åº¦ï¼‰å’Œè‡ªå®šä¹‰ï¼ˆå¼€å§‹æ—¥æœŸ-ç»“æŸæ—¥æœŸï¼‰ |
| BR-053 | åç¦»è¶‹åŠ¿æ”¯æŒæŒ‰æ—¥/å‘¨/æœˆèšåˆï¼Œå‘¨èšåˆæŒ‰ ISO Weekï¼ŒæœˆèšåˆæŒ‰ YYYY-MM |
| BR-054 | åç¦»å­—æ®µåˆ†å¸ƒæŒ‰åç¦»æ¬¡æ•°é™åºæ’åˆ—ï¼Œæ˜¾ç¤ºå æ¯”ï¼ˆä¿ç•™ 1 ä½å°æ•°ï¼‰ |
| BR-055 | éƒ¨é—¨åç¦»å¯¹æ¯”æŒ‰åç¦»ç‡å‡åºæ’åˆ—ï¼Œåç¦»ç‡ä½çš„éƒ¨é—¨æ’åé å‰ |
| BR-056 | åç¦»ç»Ÿè®¡æƒé™ï¼šAdmin å¯æŸ¥çœ‹å…¨éƒ¨éƒ¨é—¨ï¼ŒLeader å¯æŸ¥çœ‹æœ¬éƒ¨é—¨ï¼ŒUser ä¸å¯è®¿é—®ç»Ÿè®¡é¡µé¢ |
| BR-057 | å¼‚å¸¸å³°å€¼æ ‡æ³¨ï¼šåç¦»æ¬¡æ•° > å¹³å‡å€¼ + 2*æ ‡å‡†å·® çš„æ—¥æœŸæ ‡è®°ä¸ºå¼‚å¸¸ |
| BR-058 | åç¦»ç»Ÿè®¡æ•°æ®å¯å¯¼å‡º Excelï¼ŒåŒ…å«å¤šä¸ª Sheetï¼ˆæ€»è§ˆã€å­—æ®µåˆ†å¸ƒã€éƒ¨é—¨å¯¹æ¯”ã€è¶‹åŠ¿æ•°æ®ï¼‰ |
| BR-059 | ç»Ÿè®¡è®¡ç®—åŸºäº DeviationReport è¡¨ï¼Œä¸ç›´æ¥æŸ¥è¯¢ TaskRecordï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰ |
| BR-060 | åç¦»ç»Ÿè®¡æ”¯æŒå®æ—¶åˆ·æ–°ï¼ˆç‚¹å‡»åˆ·æ–°æŒ‰é’®ï¼Œé‡æ–°è®¡ç®—æœ€æ–°æ•°æ®ï¼‰ |

#### 13.5.5 æ•°æ®å®ä½“

##### DeviationStatistics è¡¨ï¼ˆæ–°å¢ï¼Œå¯é€‰ï¼‰

**ç”¨é€”**ï¼šé¢„èšåˆåç¦»ç»Ÿè®¡æ•°æ®ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½ï¼ˆé€‚ç”¨äºæ•°æ®é‡å¤§çš„åœºæ™¯ï¼‰

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| id | SnowflakeID | ä¸»é”® |
| statDate | Date | ç»Ÿè®¡æ—¥æœŸï¼ˆæŒ‰æ—¥èšåˆï¼‰ |
| departmentId | SnowflakeID | éƒ¨é—¨IDï¼ˆnull è¡¨ç¤ºå…¨å±€ç»Ÿè®¡ï¼‰ |
| templateId | SnowflakeID | æ¨¡æ¿IDï¼ˆnull è¡¨ç¤ºå…¨æ¨¡æ¿ç»Ÿè®¡ï¼‰ |
| fieldName | String | åç¦»å­—æ®µåï¼ˆnull è¡¨ç¤ºå…¨å­—æ®µç»Ÿè®¡ï¼‰ |
| totalRecords | Integer | æ€»è®°å½•æ•° |
| deviationRecords | Integer | åç¦»è®°å½•æ•° |
| deviationCount | Integer | åç¦»æ¬¡æ•°ï¼ˆä¸€æ¡è®°å½•å¯èƒ½æœ‰å¤šä¸ªåç¦»ï¼‰ |
| deviationRate | Float | åç¦»ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰ |
| avgDeviationAmount | Float | å¹³å‡åç¦»é‡ |
| createdAt | DateTime | åˆ›å»ºæ—¶é—´ |

**ç´¢å¼•**ï¼š
- `idx_stat_date_dept`ï¼š(statDate, departmentId) - æŸ¥è¯¢éƒ¨é—¨ç»Ÿè®¡
- `idx_stat_date_field`ï¼š(statDate, fieldName) - æŸ¥è¯¢å­—æ®µç»Ÿè®¡

**è¯´æ˜**ï¼š
- æ­¤è¡¨ä¸ºå¯é€‰ä¼˜åŒ–æ–¹æ¡ˆï¼Œé€‚ç”¨äºæ•°æ®é‡ >10ä¸‡æ¡è®°å½•çš„åœºæ™¯
- é€šè¿‡å®šæ—¶ä»»åŠ¡ï¼ˆæ¯æ—¥å‡Œæ™¨ï¼‰é¢„è®¡ç®—ç»Ÿè®¡æ•°æ®ï¼Œå‡å°‘å®æ—¶æŸ¥è¯¢å‹åŠ›
- å¦‚æœæ•°æ®é‡ä¸å¤§ï¼Œå¯ç›´æ¥ä» DeviationReport è¡¨å®æ—¶è®¡ç®—

#### 13.5.6 å¯è§†åŒ–éœ€æ±‚

| å›¾è¡¨ç±»å‹ | ç”¨é€” | æ•°æ®æº |
|---------|------|--------|
| æ•°å­—å¡ç‰‡ | æ˜¾ç¤ºåç¦»æ€»æ¬¡æ•°ã€åç¦»ç‡ã€ç¯æ¯”å¢é•¿ | åç¦»æ¬¡æ•°ç»Ÿè®¡ |
| é¥¼å›¾ | æ˜¾ç¤ºåç¦»å­—æ®µåˆ†å¸ƒå æ¯” | åç¦»ç±»å‹åˆ†å¸ƒ |
| æŸ±çŠ¶å›¾ | æ˜¾ç¤ºåç¦»å­—æ®µæ¬¡æ•°æ’åã€éƒ¨é—¨åç¦»å¯¹æ¯” | åç¦»ç±»å‹åˆ†å¸ƒã€éƒ¨é—¨å¯¹æ¯” |
| æŠ˜çº¿å›¾ | æ˜¾ç¤ºåç¦»è¶‹åŠ¿ï¼ˆæ—¥/å‘¨/æœˆï¼‰ | åç¦»è¶‹åŠ¿åˆ†æ |

**å‰ç«¯å›¾è¡¨åº“**ï¼š
- æ¨èä½¿ç”¨ ECharts 5.xï¼ˆApache å¼€æºï¼ŒåŠŸèƒ½å¼ºå¤§ï¼‰
- æˆ– Element Plus è‡ªå¸¦å›¾è¡¨ç»„ä»¶ï¼ˆç®€å•åœºæ™¯ï¼‰

#### 13.5.7 æˆåŠŸæŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|--------|------|
| ç»Ÿè®¡æŸ¥è¯¢å“åº”æ—¶é—´ | < 2ç§’ | 1ä¸‡æ¡è®°å½•ä»¥å†… |
| å›¾è¡¨æ¸²æŸ“æ—¶é—´ | < 1ç§’ | åŠ è½½å¹¶æ¸²æŸ“å›¾è¡¨ |
| ç»Ÿè®¡æ•°æ®å‡†ç¡®ç‡ | 100% | ä¸æºæ•°æ®ï¼ˆDeviationReportï¼‰ä¸€è‡´ |
| ç»Ÿè®¡ç»´åº¦è¦†ç›–ç‡ | 100% | æ”¯æŒæ—¶é—´ã€éƒ¨é—¨ã€æ¨¡æ¿ã€å­—æ®µå››ä¸ªç»´åº¦ |

#### 13.5.8 éªŒæ”¶æ ‡å‡†

**åŠŸèƒ½éªŒæ”¶**ï¼š
- [ ] æ”¯æŒé€‰æ‹©æ—¶é—´èŒƒå›´ï¼ˆæœ¬å‘¨/æœ¬æœˆ/æœ¬å­£åº¦/è‡ªå®šä¹‰ï¼‰ï¼Œæ˜¾ç¤ºåç¦»æ€»æ¬¡æ•°å’Œåç¦»ç‡
- [ ] æ˜¾ç¤ºç¯æ¯”å¢é•¿ç‡ï¼ˆå¯¹æ¯”ä¸ŠæœŸï¼‰ï¼Œâ†‘è¡¨ç¤ºå¢é•¿ï¼Œâ†“è¡¨ç¤ºä¸‹é™
- [ ] é¥¼å›¾æ˜¾ç¤ºåç¦»å­—æ®µåˆ†å¸ƒï¼ˆå­—æ®µåã€å æ¯”ï¼‰ï¼ŒæŸ±çŠ¶å›¾æ˜¾ç¤ºå­—æ®µæ¬¡æ•°æ’å
- [ ] æŠ˜çº¿å›¾æ˜¾ç¤ºåç¦»è¶‹åŠ¿ï¼ˆæ—¥/å‘¨/æœˆèšåˆï¼‰ï¼Œæ”¯æŒå¤šå­—æ®µå¯¹æ¯”
- [ ] æŸ±çŠ¶å›¾æ˜¾ç¤ºéƒ¨é—¨åç¦»å¯¹æ¯”ï¼ˆéƒ¨é—¨åã€åç¦»ç‡ï¼‰ï¼ŒæŒ‰åç¦»ç‡æ’åº
- [ ] æ”¯æŒæŒ‰éƒ¨é—¨ç­›é€‰ç»Ÿè®¡æ•°æ®ï¼ˆLeader åªèƒ½çœ‹æœ¬éƒ¨é—¨ï¼ŒAdmin å¯çœ‹å…¨éƒ¨ï¼‰
- [ ] ç‚¹å‡»åç¦»å­—æ®µï¼Œè·³è½¬åˆ°è¯¥å­—æ®µçš„åç¦»è¯¦æƒ…åˆ—è¡¨
- [ ] æ”¯æŒå¯¼å‡ºåç¦»ç»Ÿè®¡æŠ¥å‘Šï¼ˆExcelï¼‰ï¼ŒåŒ…å«å¤šä¸ª Sheet
- [ ] ç»Ÿè®¡é¡µé¢æ”¯æŒå®æ—¶åˆ·æ–°æŒ‰é’®ï¼Œé‡æ–°è®¡ç®—æœ€æ–°æ•°æ®
- [ ] ç»Ÿè®¡æƒé™æ ¡éªŒï¼šUser è§’è‰²æ— æ³•è®¿é—®ç»Ÿè®¡é¡µé¢ï¼Œæç¤ºæƒé™ä¸è¶³

**æ€§èƒ½éªŒæ”¶**ï¼š
- [ ] ç»Ÿè®¡æŸ¥è¯¢å“åº”æ—¶é—´ < 2ç§’ï¼ˆ1ä¸‡æ¡è®°å½•ä»¥å†…ï¼‰
- [ ] å›¾è¡¨æ¸²æŸ“æ—¶é—´ < 1ç§’
- [ ] å¤§æ•°æ®é‡åœºæ™¯ï¼ˆ>10ä¸‡æ¡è®°å½•ï¼‰ä½¿ç”¨é¢„èšåˆè¡¨ä¼˜åŒ–ï¼ŒæŸ¥è¯¢æ—¶é—´ < 3ç§’

**å‡†ç¡®æ€§éªŒæ”¶**ï¼š
- [ ] åç¦»ç‡è®¡ç®—å‡†ç¡®ï¼ˆæ‰‹åŠ¨æŠ½æŸ¥ 10 æ¡è®°å½•å¯¹æ¯”ï¼‰
- [ ] ç¯æ¯”å¢é•¿ç‡è®¡ç®—å‡†ç¡®ï¼ˆå¯¹æ¯”ä¸ŠæœŸæ•°æ®ï¼‰
- [ ] åç¦»å­—æ®µå æ¯”æ€»å’Œ = 100%
- [ ] éƒ¨é—¨åç¦»å¯¹æ¯”æ•°æ®ä¸æºæ•°æ®ä¸€è‡´

---

### 13.6 æ•°æ®æ¨¡å‹æ±‡æ€»ï¼ˆPhase 7-12ï¼‰

#### 13.6.1 æ–°å¢æ•°æ®è¡¨

| è¡¨å | ç”¨é€” | ä¾èµ–é˜¶æ®µ |
|------|------|---------|
| DeviationReport | åç¦»æŠ¥å‘Šæ˜ç»†ï¼ˆå­—æ®µã€æœŸæœ›å€¼ã€å®é™…å€¼ã€åç¦»é‡ã€åŸå› ï¼‰ | Phase 7-8 |
| FilePreview | æ–‡ä»¶é¢„è§ˆç¼“å­˜ä¿¡æ¯ï¼ˆè½¬æ¢çŠ¶æ€ã€ç¼“å­˜è·¯å¾„ã€è¿‡æœŸæ—¶é—´ï¼‰ | Phase 11 |
| DeviationStatistics | åç¦»ç»Ÿè®¡é¢„èšåˆæ•°æ®ï¼ˆå¯é€‰ï¼Œæ€§èƒ½ä¼˜åŒ–ï¼‰ | Phase 12 |

#### 13.6.2 æ‰©å±•ç°æœ‰è¡¨

##### Template è¡¨æ‰©å±•

**æ–°å¢å­—æ®µ**ï¼š
| å­—æ®µå | ç±»å‹ | è¯´æ˜ | å¯ç”¨é˜¶æ®µ |
|--------|------|------|---------|
| version | String | æ¨¡æ¿ç‰ˆæœ¬å·ï¼ˆ1.0, 1.1, ...ï¼‰ | Phase 7-8 |

**fieldsJson ç»“æ„æ‰©å±•**ï¼š
```typescript
interface TemplateFieldV2 extends TemplateField {
  tolerance?: {
    type: 'range' | 'percentage'  // èŒƒå›´å…¬å·® or ç™¾åˆ†æ¯”å…¬å·®
    min?: number                  // èŒƒå›´å…¬å·®æœ€å°å€¼
    max?: number                  // èŒƒå›´å…¬å·®æœ€å¤§å€¼
    percentage?: number           // ç™¾åˆ†æ¯”å…¬å·®ï¼ˆå¦‚ 5 è¡¨ç¤º Â±5%ï¼‰
    unit?: string                 // å•ä½ï¼ˆå¦‚ Â°Cã€gã€MPaï¼‰
  }
}
```

##### TaskRecord è¡¨æ‰©å±•

**æ–°å¢å­—æ®µ**ï¼š
| å­—æ®µå | ç±»å‹ | è¯´æ˜ | å¯ç”¨é˜¶æ®µ |
|--------|------|------|---------|
| hasDeviation | Boolean | æ˜¯å¦åŒ…å«åç¦» | Phase 7-8 |
| deviationCount | Integer | åç¦»å­—æ®µæ•°é‡ | Phase 7-8 |
| relatedTemplateId | SnowflakeID | å…³è”çš„é…æ–¹æ¨¡æ¿ID | Phase 7-8 |
| relatedTemplateVersion | String | é”å®šçš„é…æ–¹ç‰ˆæœ¬å· | Phase 7-8 |

> **è¯´æ˜**: å®¡æ‰¹ç›¸å…³å­—æ®µç”± v2.0.0 å·¥ä½œæµå¼•æ“ç»Ÿä¸€ç®¡ç†ï¼Œä¸å†åœ¨ TaskRecord è¡¨ä¸­æ‰©å±•ã€‚

##### Approval è¡¨ï¼ˆv2.0.0 å·¥ä½œæµå¼•æ“ç®¡ç†ï¼‰

**è¯´æ˜**: åŸ Phase 10 è®¡åˆ’æ‰©å±•çš„å®¡æ‰¹å­—æ®µå·²ç”± v2.0.0 å·¥ä½œæµå¼•æ“çš„ `WorkflowInstance` å’Œ `WorkflowTask` è¡¨æ›¿ä»£ï¼Œè¯¦è§ç¬¬åå››ç« ã€‚

#### 13.6.3 å®Œæ•´ç‰ˆæ•°æ®æ¨¡å‹ ER å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Template   â”‚        â”‚  TaskRecord  â”‚        â”‚  Approval   â”‚
â”‚  (é…æ–¹)      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”‚  (ä»»åŠ¡è®°å½•)   â”‚â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  (å®¡æ‰¹)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                          â”‚
       â”‚ version                  â”‚ hasDeviation
       â”‚ fieldsJson.tolerance     â”‚ relatedTemplateVersion
       â”‚                          â”‚
       â”‚                          â–¼
       â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ DeviationReport  â”‚
                        â”‚ (åç¦»æŠ¥å‘Š)         â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ DeviationStatisticsâ”‚
                        â”‚ (åç¦»ç»Ÿè®¡)          â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Document   â”‚        â”‚  FilePreview â”‚
â”‚  (æ–‡æ¡£)      â”‚â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  (é¢„è§ˆç¼“å­˜)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 13.7 å®Œæ•´ç‰ˆä¸šåŠ¡è§„åˆ™æ±‡æ€»ï¼ˆBR-017 ~ BR-060ï¼‰

#### Phase 7-8ï¼šé…æ–¹åç¦»æ£€æµ‹ä¸ç‰ˆæœ¬ç®¡ç†

| è§„åˆ™ç¼–å· | è§„åˆ™æè¿° |
|---------|----------|
| BR-017 | æ•°å€¼å‹å­—æ®µå¯é…ç½®å…¬å·®ï¼ˆèŒƒå›´å…¬å·® or ç™¾åˆ†æ¯”å…¬å·®ï¼‰ï¼Œéæ•°å€¼å‹å­—æ®µä¸æ”¯æŒ |
| BR-018 | åç¦»æ£€æµ‹åœ¨å‰ç«¯å®æ—¶æ˜¾ç¤ºï¼Œåç«¯æäº¤æ—¶å¼ºåˆ¶éªŒè¯ |
| BR-019 | åç¦»æ—¶å¿…é¡»å¡«å†™åç¦»åŸå› ï¼ˆæœ€å°‘10å­—ï¼Œæœ€å¤š500å­—ï¼‰ |
| BR-020 | åç¦»æŠ¥å‘Šè‡ªåŠ¨ç”Ÿæˆï¼Œä¸å¯æ‰‹åŠ¨ä¿®æ”¹ï¼Œåªèƒ½å®¡æ‰¹é€šè¿‡/æ‹’ç» |
| BR-021 | åŒ…å«åç¦»çš„è®°å½•è§¦å‘é¢å¤–å®¡æ‰¹æµç¨‹ï¼ˆæ­£å¸¸ï¼š1çº§å®¡æ‰¹ï¼›åç¦»ï¼š2çº§å®¡æ‰¹ï¼‰ |
| BR-022 | ä»»åŠ¡è®°å½•æäº¤æ—¶é”å®šé…æ–¹ç‰ˆæœ¬å·ï¼Œåç»­é…æ–¹æ›´æ–°ä¸å½±å“å·²æäº¤è®°å½• |
| BR-023 | é…æ–¹å…¬å·®é…ç½®ä¿®æ”¹åï¼Œç‰ˆæœ¬å·è‡ªåŠ¨+0.1ï¼Œå†å²è®°å½•æŒ‰æ—§ç‰ˆæœ¬åˆ¤æ–­åç¦» |
| BR-024 | åç¦»æŠ¥å‘ŠçŠ¶æ€ï¼špendingï¼ˆå¾…å®¡æ‰¹ï¼‰â†’ approvedï¼ˆå½’æ¡£ï¼‰/ rejectedï¼ˆé©³å›åˆ°åˆ›å»ºäººï¼‰ |

#### Phase 9ï¼šæ•°æ®å¯¼å‡º

| è§„åˆ™ç¼–å· | è§„åˆ™æè¿° |
|---------|----------|
| BR-025 | æ”¯æŒå¯¼å‡ºæ–‡æ¡£åˆ—è¡¨ï¼ˆExcelï¼‰ã€ä»»åŠ¡è®°å½•ï¼ˆExcelï¼‰ã€åç¦»æŠ¥å‘Šï¼ˆExcelï¼‰ |
| BR-026 | ä»»åŠ¡è®°å½•å¯¼å‡ºè¡¨å¤´ = å›ºå®šåˆ—ï¼ˆIDã€æ ‡é¢˜ã€çŠ¶æ€ã€åˆ›å»ºäººã€åˆ›å»ºæ—¶é—´ï¼‰+ åŠ¨æ€åˆ—ï¼ˆæ¨¡æ¿å­—æ®µï¼‰ |
| BR-027 | åŠ¨æ€åˆ—æ ¹æ® Template.fieldsJson è‡ªåŠ¨ç”Ÿæˆï¼Œå­—æ®µé¡ºåºä¸æ¨¡æ¿ä¸€è‡´ |
| BR-028 | å¯¼å‡ºæƒé™ï¼šAdmin å¯å¯¼å‡ºå…¨éƒ¨ï¼ŒLeader å¯å¯¼å‡ºæœ¬éƒ¨é—¨ï¼ŒUser å¯å¯¼å‡ºè‡ªå·±çš„ |
| BR-029 | å¯¼å‡ºæ•°é‡ â‰¤1000æ¡åŒæ­¥è¿”å›ï¼Œ>1000æ¡å¼‚æ­¥ç”Ÿæˆï¼ˆè¿”å›ä»»åŠ¡IDï¼Œæä¾›ä¸‹è½½é“¾æ¥ï¼‰ |
| BR-030 | å¼‚æ­¥å¯¼å‡ºæ–‡ä»¶ä¿ç•™7å¤©ï¼Œè¶…æœŸè‡ªåŠ¨åˆ é™¤ |

> **è¯´æ˜**: Phase 10 (2çº§å®¡æ‰¹æµç¨‹) ç›¸å…³ä¸šåŠ¡è§„åˆ™å·²ç§»è‡³ç¬¬åå››ç«  v2.0.0 å·¥ä½œæµå¼•æ“éƒ¨åˆ†ï¼ˆBR-071 è‡³ BR-090ï¼‰ã€‚

#### Phase 11ï¼šæ–‡ä»¶é¢„è§ˆ

| è§„åˆ™ç¼–å· | è§„åˆ™æè¿° |
|---------|----------|
| BR-041 | æ”¯æŒ PDFã€Wordï¼ˆ.doc/.docxï¼‰ã€Excelï¼ˆ.xls/.xlsxï¼‰ä¸‰ç§æ ¼å¼åœ¨çº¿é¢„è§ˆ |
| BR-042 | PDF æ–‡ä»¶ç›´æ¥æ¸²æŸ“ï¼ŒWord/Excel æ–‡ä»¶éœ€åç«¯è½¬æ¢ä¸º HTML åé¢„è§ˆ |
| BR-043 | é¢„è§ˆæ–‡ä»¶å¤§å°é™åˆ¶ï¼šâ‰¤10MB ç›´æ¥é¢„è§ˆï¼Œ>10MB æç¤ºå»ºè®®ä¸‹è½½ï¼ˆå¯å¼ºåˆ¶é¢„è§ˆï¼‰ |
| BR-044 | Word/Excel è½¬æ¢åçš„ HTML ç¼“å­˜ 7 å¤©ï¼Œæ–‡ä»¶æ›´æ–°åç¼“å­˜å¤±æ•ˆ |
| BR-045 | é¢„è§ˆåŠ è½½è¶…æ—¶æ—¶é—´ï¼šè½¬æ¢ 30 ç§’ï¼Œæ¸²æŸ“ 10 ç§’ï¼Œè¶…æ—¶æç¤ºå¹¶æä¾›ä¸‹è½½é“¾æ¥ |
| BR-046 | é¢„è§ˆæƒé™ï¼šæ‹¥æœ‰æ–‡æ¡£æŸ¥çœ‹æƒé™çš„ç”¨æˆ·æ‰èƒ½é¢„è§ˆæ–‡ä»¶ |
| BR-047 | Excel å¤š Sheet æ–‡ä»¶æ”¯æŒ Sheet åˆ‡æ¢ï¼Œå• Sheet è¡Œæ•° >1000 æ—¶åˆ†é¡µæ˜¾ç¤º |
| BR-048 | é¢„è§ˆçª—å£æ”¯æŒå…¨å±ã€ç¼©æ”¾ã€ä¸‹è½½ã€æ‰“å°ï¼ˆPDFï¼‰ç­‰æ“ä½œ |
| BR-049 | é¢„è§ˆå¤±è´¥æ—¶ï¼Œæ˜¾ç¤ºå‹å¥½é”™è¯¯æç¤ºï¼Œå¹¶æä¾›ä¸‹è½½åŸæ–‡ä»¶çš„å¤‡ç”¨æ–¹æ¡ˆ |
| BR-050 | é¢„è§ˆç¼“å­˜å­˜å‚¨åœ¨ MinIOï¼ˆ/preview-cache ç›®å½•ï¼‰ï¼Œå®šæ—¶ä»»åŠ¡æ¯æ—¥æ¸…ç†è¿‡æœŸç¼“å­˜ |

#### Phase 12ï¼šåç¦»ç»Ÿè®¡åˆ†æ

| è§„åˆ™ç¼–å· | è§„åˆ™æè¿° |
|---------|----------|
| BR-051 | åç¦»ç‡ = (åŒ…å«åç¦»çš„è®°å½•æ•° / æ€»è®°å½•æ•°) * 100%ï¼Œä¿ç•™ 2 ä½å°æ•° |
| BR-052 | ç»Ÿè®¡æ—¶é—´èŒƒå›´æ”¯æŒé¢„è®¾ï¼ˆæœ¬å‘¨/æœ¬æœˆ/æœ¬å­£åº¦ï¼‰å’Œè‡ªå®šä¹‰ï¼ˆå¼€å§‹æ—¥æœŸ-ç»“æŸæ—¥æœŸï¼‰ |
| BR-053 | åç¦»è¶‹åŠ¿æ”¯æŒæŒ‰æ—¥/å‘¨/æœˆèšåˆï¼Œå‘¨èšåˆæŒ‰ ISO Weekï¼ŒæœˆèšåˆæŒ‰ YYYY-MM |
| BR-054 | åç¦»å­—æ®µåˆ†å¸ƒæŒ‰åç¦»æ¬¡æ•°é™åºæ’åˆ—ï¼Œæ˜¾ç¤ºå æ¯”ï¼ˆä¿ç•™ 1 ä½å°æ•°ï¼‰ |
| BR-055 | éƒ¨é—¨åç¦»å¯¹æ¯”æŒ‰åç¦»ç‡å‡åºæ’åˆ—ï¼Œåç¦»ç‡ä½çš„éƒ¨é—¨æ’åé å‰ |
| BR-056 | åç¦»ç»Ÿè®¡æƒé™ï¼šAdmin å¯æŸ¥çœ‹å…¨éƒ¨éƒ¨é—¨ï¼ŒLeader å¯æŸ¥çœ‹æœ¬éƒ¨é—¨ï¼ŒUser ä¸å¯è®¿é—®ç»Ÿè®¡é¡µé¢ |
| BR-057 | å¼‚å¸¸å³°å€¼æ ‡æ³¨ï¼šåç¦»æ¬¡æ•° > å¹³å‡å€¼ + 2*æ ‡å‡†å·® çš„æ—¥æœŸæ ‡è®°ä¸ºå¼‚å¸¸ |
| BR-058 | åç¦»ç»Ÿè®¡æ•°æ®å¯å¯¼å‡º Excelï¼ŒåŒ…å«å¤šä¸ª Sheetï¼ˆæ€»è§ˆã€å­—æ®µåˆ†å¸ƒã€éƒ¨é—¨å¯¹æ¯”ã€è¶‹åŠ¿æ•°æ®ï¼‰ |
| BR-059 | ç»Ÿè®¡è®¡ç®—åŸºäº DeviationReport è¡¨ï¼Œä¸ç›´æ¥æŸ¥è¯¢ TaskRecordï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰ |
| BR-060 | åç¦»ç»Ÿè®¡æ”¯æŒå®æ—¶åˆ·æ–°ï¼ˆç‚¹å‡»åˆ·æ–°æŒ‰é’®ï¼Œé‡æ–°è®¡ç®—æœ€æ–°æ•°æ®ï¼‰ |

---

### 13.8 å®Œæ•´ç‰ˆå¼€å‘é¡ºåºä¸ä¾èµ–ï¼ˆåŸºäº v2.0.0 æ¶æ„ï¼‰

#### 13.8.1 æ¨èå¼€å‘é¡ºåº

```
v2.0.0ï¼ˆå·¥ä½œæµå¼•æ“ + æ™ºèƒ½æ–‡æ¡£å¼•æ“ï¼Œ11å‘¨ï¼‰
    â†“
Phase 7-8ï¼ˆåç¦»æ£€æµ‹ï¼Œä¾èµ–å·¥ä½œæµå¼•æ“ï¼‰
    â†“
Phase 12ï¼ˆåç¦»ç»Ÿè®¡ï¼‰â”€â”€â”€â”€â”€â”
    â†“                    â”‚
Phase 9ï¼ˆæ•°æ®å¯¼å‡ºï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â†“                    â”‚
Phase 11ï¼ˆæ–‡ä»¶é¢„è§ˆï¼‰      â”‚ï¼ˆç‹¬ç«‹åŠŸèƒ½ï¼Œå¯å¹¶è¡Œï¼‰
```

**è¯´æ˜**ï¼š
1. **v2.0.0 ä¼˜å…ˆ**ï¼šå·¥ä½œæµå¼•æ“å’Œæ™ºèƒ½æ–‡æ¡£å¼•æ“æ˜¯ Phase 7-8 çš„å‰ç½®ä¾èµ–
2. **Phase 7-8 æ¬¡ä¹‹**ï¼šåç¦»æ£€æµ‹ä¾èµ–å·¥ä½œæµå¼•æ“çš„2çº§å®¡æ‰¹èƒ½åŠ›
3. **Phase 12 ç¬¬ä¸‰**ï¼šç»Ÿè®¡åˆ†æä¾èµ–åç¦»æ•°æ®ç§¯ç´¯
4. **Phase 9 ç¬¬å››**ï¼šå¯¼å‡ºåŠŸèƒ½éœ€è¦å®Œæ•´çš„æ•°æ®ç»“æ„
5. **Phase 11 æœ€å**ï¼šæ–‡ä»¶é¢„è§ˆæ˜¯ç‹¬ç«‹åŠŸèƒ½ï¼Œå¯å¹¶è¡Œå¼€å‘

#### 13.8.2 ä¾èµ–å…³ç³»çŸ©é˜µ

| Phase | ä¾èµ– Phase | ä¾èµ–åŸå›  |
|-------|-----------|---------|
| Phase 7-8 | v2.0.0 å·¥ä½œæµå¼•æ“ | åç¦»è®°å½•è§¦å‘2çº§å®¡æ‰¹æµç¨‹ï¼Œä½¿ç”¨å·¥ä½œæµå¼•æ“é…ç½® |
| Phase 9 | Phase 7-8, Phase 12 | å¯¼å‡ºåç¦»æŠ¥å‘Šå’Œç»Ÿè®¡æ•°æ® |
| Phase 11 | - | ç‹¬ç«‹åŠŸèƒ½ï¼Œæ— ä¾èµ– |
| Phase 12 | Phase 7-8 | ç»Ÿè®¡åç¦»æ•°æ® |

#### 13.8.3 æ•°æ®è¡¨åˆ›å»ºé¡ºåº

```
1. v2.0.0 å·¥ä½œæµå¼•æ“è¡¨ï¼ˆWorkflowTemplate, WorkflowInstance, WorkflowTask, DocumentReferenceï¼‰
   â†“
2. Template è¡¨æ‰©å±• + TaskRecord è¡¨æ‰©å±•ï¼ˆPhase 7-8ï¼‰
   â†“
3. DeviationReport è¡¨ï¼ˆPhase 7-8ï¼‰
   â†“
4. DeviationStatistics è¡¨ï¼ˆPhase 12ï¼Œå¯é€‰ï¼Œå¯ç”¨è§†å›¾æ›¿ä»£ï¼‰
   â†“
5. FilePreview è¡¨ï¼ˆPhase 11ï¼‰
```

---

### 13.9 å®Œæ•´ç‰ˆå·¥ä½œé‡ä¼°ç®—ï¼ˆåŒ…å« v2.0.0ï¼‰

#### 13.9.1 æ€»ä½“å¼€å‘å·¥ä½œé‡

| é˜¶æ®µ | åç«¯å¼€å‘ | å‰ç«¯å¼€å‘ | æµ‹è¯• | æ€»è®¡ |
|------|---------|---------|------|------|
| **v2.0.0ï¼ˆå·¥ä½œæµ+æ–‡æ¡£å¼•æ“ï¼‰** | 25 å¤© | 30 å¤© | 10 å¤© | **65 å¤©** |
| Phase 7-8ï¼ˆåç¦»æ£€æµ‹ï¼‰ | 8 å¤© | 10 å¤© | 4 å¤© | 22 å¤© |
| Phase 9ï¼ˆæ•°æ®å¯¼å‡ºï¼‰ | 5 å¤© | 3 å¤© | 2 å¤© | 10 å¤© |
| Phase 11ï¼ˆæ–‡ä»¶é¢„è§ˆï¼‰ | 7 å¤© | 5 å¤© | 3 å¤© | 15 å¤© |
| Phase 12ï¼ˆåç¦»ç»Ÿè®¡ï¼‰ | 6 å¤© | 8 å¤© | 3 å¤© | 17 å¤© |
| **æ€»è®¡** | **51 å¤©** | **56 å¤©** | **22 å¤©** | **129 å¤©** |

**è¯´æ˜**ï¼š
- æŒ‰ 1 ä¸ªåç«¯å·¥ç¨‹å¸ˆ + 1 ä¸ªå‰ç«¯å·¥ç¨‹å¸ˆ + 1 ä¸ªæµ‹è¯•å·¥ç¨‹å¸ˆè®¡ç®—
- å®é™…å·¥æœŸçº¦ **4-5 ä¸ªæœˆ**ï¼ˆè€ƒè™‘å¹¶è¡Œå¼€å‘å’Œç¼“å†²æ—¶é—´ï¼‰
- v2.0.0 å·¥ä½œé‡å‚è§ç¬¬åå››ç«  14.8 èŠ‚

#### 13.9.2 è¯¦ç»†å·¥ä½œé‡åˆ†è§£

##### Phase 7-8ï¼šåç¦»æ£€æµ‹ä¸ç‰ˆæœ¬ç®¡ç†ï¼ˆ22 å¤©ï¼‰

**åç«¯ï¼ˆ8 å¤©ï¼‰**ï¼š
- æ•°æ®åº“æ‰©å±•ï¼ˆTemplate/TaskRecord/DeviationReportï¼‰ï¼š1 å¤©
- åç¦»æ£€æµ‹é€»è¾‘ï¼ˆèŒƒå›´å…¬å·®+ç™¾åˆ†æ¯”å…¬å·®ï¼‰ï¼š2 å¤©
- ç‰ˆæœ¬é”å®šæœºåˆ¶ï¼š1 å¤©
- åç¦»æŠ¥å‘Šç”Ÿæˆï¼š2 å¤©
- API æ¥å£å¼€å‘ï¼š2 å¤©

**å‰ç«¯ï¼ˆ10 å¤©ï¼‰**ï¼š
- é…æ–¹å…¬å·®é…ç½® UIï¼š3 å¤©
- å®æ—¶åç¦»æ£€æµ‹ï¼ˆè¡¨å•éªŒè¯+æ ‡çº¢æç¤ºï¼‰ï¼š3 å¤©
- åç¦»åŸå› å¼¹çª—ï¼ˆå¼ºåˆ¶å¡«å†™ï¼‰ï¼š2 å¤©
- åç¦»æŠ¥å‘Šå±•ç¤ºï¼š2 å¤©

**æµ‹è¯•ï¼ˆ4 å¤©ï¼‰**ï¼š
- å•å…ƒæµ‹è¯•ï¼ˆåç¦»æ£€æµ‹é€»è¾‘ï¼‰ï¼š2 å¤©
- é›†æˆæµ‹è¯•ï¼ˆç«¯åˆ°ç«¯æµç¨‹ï¼‰ï¼š2 å¤©

##### Phase 9ï¼šæ•°æ®å¯¼å‡ºï¼ˆ10 å¤©ï¼‰

**åç«¯ï¼ˆ5 å¤©ï¼‰**ï¼š
- Excel ç”Ÿæˆåº“é›†æˆï¼ˆxlsxï¼‰ï¼š1 å¤©
- æ–‡æ¡£åˆ—è¡¨å¯¼å‡ºï¼š1 å¤©
- ä»»åŠ¡è®°å½•å¯¼å‡ºï¼ˆåŠ¨æ€åˆ—ç”Ÿæˆï¼‰ï¼š2 å¤©
- åç¦»æŠ¥å‘Šå¯¼å‡ºï¼š1 å¤©

**å‰ç«¯ï¼ˆ3 å¤©ï¼‰**ï¼š
- å¯¼å‡ºæŒ‰é’® UIï¼š1 å¤©
- å¼‚æ­¥å¯¼å‡ºä»»åŠ¡çŠ¶æ€æŸ¥è¯¢ï¼š1 å¤©
- ä¸‹è½½é“¾æ¥å¤„ç†ï¼š1 å¤©

**æµ‹è¯•ï¼ˆ2 å¤©ï¼‰**ï¼š
- å¯¼å‡ºæ•°æ®å‡†ç¡®æ€§æµ‹è¯•ï¼š1 å¤©
- å¯¼å‡ºæ€§èƒ½æµ‹è¯•ï¼ˆå¤§æ•°æ®é‡ï¼‰ï¼š1 å¤©

##### Phase 11ï¼šæ–‡ä»¶é¢„è§ˆï¼ˆ15 å¤©ï¼‰

**åç«¯ï¼ˆ7 å¤©ï¼‰**ï¼š
- LibreOffice éƒ¨ç½²é…ç½®ï¼š2 å¤©
- Word/Excel è½¬ HTML æ¥å£ï¼š2 å¤©
- é¢„è§ˆç¼“å­˜æœºåˆ¶ï¼š2 å¤©
- API æ¥å£å¼€å‘ï¼š1 å¤©

**å‰ç«¯ï¼ˆ5 å¤©ï¼‰**ï¼š
- PDF.js é›†æˆï¼š2 å¤©
- Word/Excel HTML æ¸²æŸ“ï¼š2 å¤©
- é¢„è§ˆçª—å£ UIï¼ˆç¼©æ”¾/ç¿»é¡µï¼‰ï¼š1 å¤©

**æµ‹è¯•ï¼ˆ3 å¤©ï¼‰**ï¼š
- ä¸‰ç§æ ¼å¼é¢„è§ˆæµ‹è¯•ï¼š2 å¤©
- é¢„è§ˆæ€§èƒ½æµ‹è¯•ï¼š1 å¤©

##### Phase 12ï¼šåç¦»ç»Ÿè®¡åˆ†æï¼ˆ17 å¤©ï¼‰

**åç«¯ï¼ˆ6 å¤©ï¼‰**ï¼š
- åç¦»ç»Ÿè®¡é€»è¾‘ï¼š2 å¤©
- ç»Ÿè®¡ API æ¥å£ï¼š2 å¤©
- é¢„èšåˆè¡¨ï¼ˆå¯é€‰ï¼‰ï¼š2 å¤©

**å‰ç«¯ï¼ˆ8 å¤©ï¼‰**ï¼š
- ECharts é›†æˆï¼š1 å¤©
- åç¦»æ¬¡æ•°ç»Ÿè®¡ UIï¼š2 å¤©
- åç¦»è¶‹åŠ¿å›¾è¡¨ï¼š2 å¤©
- éƒ¨é—¨å¯¹æ¯”å›¾è¡¨ï¼š2 å¤©
- å¯¼å‡ºç»Ÿè®¡æŠ¥å‘Šï¼š1 å¤©

**æµ‹è¯•ï¼ˆ3 å¤©ï¼‰**ï¼š
- ç»Ÿè®¡æ•°æ®å‡†ç¡®æ€§æµ‹è¯•ï¼š2 å¤©
- ç»Ÿè®¡æ€§èƒ½æµ‹è¯•ï¼š1 å¤©

---

### 13.10 æŠ€æœ¯é£é™©ä¸è§£å†³æ–¹æ¡ˆ

#### 13.10.1 Phase 7-8 é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | è§£å†³æ–¹æ¡ˆ |
|------|------|------|---------|
| åç¦»æ£€æµ‹é€»è¾‘å¤æ‚ï¼Œè¾¹ç•Œæ¡ä»¶å¤š | é«˜ | ä¸­ | ç¼–å†™è¯¦ç»†çš„å•å…ƒæµ‹è¯•ï¼Œè¦†ç›–å„ç§å…¬å·®é…ç½®åœºæ™¯ |
| ç‰ˆæœ¬é”å®šæœºåˆ¶å®ç°ä¸å½“ï¼Œå¯¼è‡´å†å²æ•°æ®æ··ä¹± | é«˜ | ä½ | æäº¤æ—¶å¼ºåˆ¶è®°å½•ç‰ˆæœ¬å·ï¼Œä»£ç å®¡æŸ¥ç¡®ä¿é€»è¾‘æ­£ç¡® |
| åç¦»æŠ¥å‘Šæ•°æ®é‡å¤§ï¼ŒæŸ¥è¯¢æ€§èƒ½å·® | ä¸­ | ä¸­ | å»ºç«‹ç´¢å¼•ï¼ˆrecordId, templateId, createdAtï¼‰ï¼Œè€ƒè™‘åˆ†è¡¨æˆ–å½’æ¡£ |

#### 13.10.2 Phase 9 é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | è§£å†³æ–¹æ¡ˆ |
|------|------|------|---------|
| åŠ¨æ€åˆ—å¯¼å‡ºé€»è¾‘å¤æ‚ï¼Œå­—æ®µæ˜ å°„é”™è¯¯ | é«˜ | ä¸­ | ç¼–å†™æµ‹è¯•ç”¨ä¾‹ï¼Œå¯¹æ¯”å¯¼å‡ºæ•°æ®ä¸æºæ•°æ®ä¸€è‡´æ€§ |
| å¤§æ•°æ®é‡å¯¼å‡ºè¶…æ—¶ï¼ˆ>10000æ¡ï¼‰ | ä¸­ | é«˜ | ä½¿ç”¨å¼‚æ­¥å¯¼å‡º + åˆ†é¡µæŸ¥è¯¢ + æµå¼å†™å…¥ Excel |
| å¯¼å‡ºæ–‡ä»¶æ ¼å¼ä¸å…¼å®¹ï¼ˆExcel ç‰ˆæœ¬ï¼‰ | ä½ | ä½ | ä½¿ç”¨æ ‡å‡† xlsx æ ¼å¼ï¼ˆxlsx åº“é»˜è®¤æ”¯æŒï¼‰ |

> **è¯´æ˜**: Phase 10 ç›¸å…³é£é™©å·²ç§»è‡³ç¬¬åå››ç«  v2.0.0 å·¥ä½œæµå¼•æ“éƒ¨åˆ†ã€‚

#### 13.10.3 Phase 11 é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | è§£å†³æ–¹æ¡ˆ |
|------|------|------|---------|
| LibreOffice è½¬æ¢æ€§èƒ½å·®ï¼Œé¦–æ¬¡é¢„è§ˆæ…¢ | é«˜ | é«˜ | ä½¿ç”¨ç¼“å­˜æœºåˆ¶ï¼ŒäºŒæ¬¡è®¿é—®åŠ è½½ç¼“å­˜ï¼›è½¬æ¢è¶…æ—¶æç¤ºç”¨æˆ·ä¸‹è½½ |
| Word/Excel è½¬ HTML æ ¼å¼ä¸¢å¤± | ä¸­ | ä¸­ | æµ‹è¯•å¸¸è§æ–‡ä»¶æ ¼å¼ï¼Œå‘ç°é—®é¢˜è°ƒæ•´è½¬æ¢å‚æ•°ï¼›å¤æ‚æ ¼å¼æç¤ºä¸‹è½½æŸ¥çœ‹ |
| é¢„è§ˆç¼“å­˜å ç”¨å­˜å‚¨ç©ºé—´å¤§ | ä¸­ | ä¸­ | è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆ7å¤©ï¼‰ï¼Œå®šæ—¶ä»»åŠ¡æ¸…ç†è¿‡æœŸç¼“å­˜ |
| LibreOffice è½¬æ¢å¤±è´¥ï¼ˆæ–‡ä»¶æŸåï¼‰ | ä½ | ä½ | è½¬æ¢å¤±è´¥æ—¶æç¤ºç”¨æˆ·å¹¶æä¾›ä¸‹è½½é“¾æ¥ï¼Œä¸é˜»å¡ä¸šåŠ¡æµç¨‹ |

#### 13.10.5 Phase 12 é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | è§£å†³æ–¹æ¡ˆ |
|------|------|------|---------|
| ç»Ÿè®¡æŸ¥è¯¢æ€§èƒ½å·®ï¼ˆæ•°æ®é‡å¤§ï¼‰ | é«˜ | é«˜ | ä½¿ç”¨é¢„èšåˆè¡¨ï¼ˆDeviationStatisticsï¼‰ï¼Œå®šæ—¶ä»»åŠ¡æ¯æ—¥é¢„è®¡ç®— |
| åç¦»ç‡è®¡ç®—ä¸å‡†ç¡® | é«˜ | ä½ | ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œæ‰‹åŠ¨æŠ½æŸ¥éªŒè¯è®¡ç®—å…¬å¼æ­£ç¡®æ€§ |
| å›¾è¡¨æ¸²æŸ“æ…¢ï¼ˆå¤§æ•°æ®é‡ï¼‰ | ä¸­ | ä¸­ | é™åˆ¶å›¾è¡¨æ•°æ®ç‚¹æ•°é‡ï¼ˆæœ€å¤š 365 å¤©ï¼‰ï¼Œæ”¯æŒæ•°æ®é‡‡æ · |
| ç»Ÿè®¡ç»´åº¦ç»„åˆçˆ†ç‚¸ï¼ˆéƒ¨é—¨Ã—æ¨¡æ¿Ã—å­—æ®µï¼‰ | ä¸­ | ä½ | é™åˆ¶ç»Ÿè®¡ç»´åº¦æ•°é‡ï¼Œæä¾›é¢„è®¾ç»Ÿè®¡æŠ¥è¡¨ |

#### 13.10.6 é€šç”¨æŠ€æœ¯é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | è§£å†³æ–¹æ¡ˆ |
|------|------|------|---------|
| æ•°æ®åº“è¿ç§»å¤±è´¥ï¼ˆæ‰©å±•å­—æ®µï¼‰ | é«˜ | ä½ | å¤‡ä»½æ•°æ®åº“ï¼Œç°åº¦å‘å¸ƒï¼Œå›æ»šæ–¹æ¡ˆ |
| å‘åå…¼å®¹æ€§é—®é¢˜ï¼ˆå½±å“ MVPï¼‰ | é«˜ | ä½ | æ‰©å±•å­—æ®µä¸ºå¯é€‰é¡¹ï¼ˆnullableï¼‰ï¼Œä¸ä¿®æ”¹ç°æœ‰é€»è¾‘ |
| ç¬¬ä¸‰æ–¹åº“ç‰ˆæœ¬å†²çªï¼ˆxlsx/LibreOfficeï¼‰ | ä¸­ | ä½ | é”å®šä¾èµ–ç‰ˆæœ¬ï¼Œæµ‹è¯•ç¯å¢ƒéªŒè¯åå†éƒ¨ç½² |
| æ€§èƒ½é€€åŒ–ï¼ˆå®Œæ•´ç‰ˆåŠŸèƒ½å¢åŠ ï¼‰ | ä¸­ | ä¸­ | æ€§èƒ½æµ‹è¯•ï¼Œå…³é”®è·¯å¾„ä¼˜åŒ–ï¼ˆç´¢å¼•ã€ç¼“å­˜ã€åˆ†é¡µï¼‰ |

---

### 14.2 é¢„ç•™æ‰©å±•å­—æ®µ

ä»¥ä¸‹å­—æ®µå·²åœ¨æ•°æ®æ¨¡å‹ä¸­é¢„ç•™ï¼Œåç»­ç›´æ¥å¯ç”¨ï¼š

| å­—æ®µ | è¡¨ | ç”¨é€” | å¯ç”¨æ¡ä»¶ |
|------|------|------|----------|
| email | users | é‚®ä»¶åœ°å€ | å¯ç”¨é‚®ä»¶é€šçŸ¥åŠŸèƒ½ |
| phone | users | æ‰‹æœºå·ç  | å¯ç”¨çŸ­ä¿¡/å¾®ä¿¡é€šçŸ¥ |
| workflow_config | documents | å®¡æ‰¹æµç¨‹é…ç½® | å¯ç”¨è‡ªå®šä¹‰å®¡æ‰¹æµç¨‹ |
| tags | documents | æ ‡ç­¾åˆ—è¡¨ | å¯ç”¨æ ‡ç­¾æœç´¢åŠŸèƒ½ |
| tags | templates | æ ‡ç­¾åˆ—è¡¨ | å¯ç”¨æ ‡ç­¾ç­›é€‰åŠŸèƒ½ |
| description | departments | éƒ¨é—¨æè¿° | éƒ¨é—¨ä¿¡æ¯å®Œå–„æ—¶ |

### 14.3 å®Œæ•´ç‰ˆæ•°æ®æ¨¡å‹æ‰©å±•

```sql
-- å®¡æ‰¹æµç¨‹é…ç½®è¡¨ï¼ˆå®Œæ•´ç‰ˆï¼‰
approval_workflows (
  id              SnowflakeID   PRIMARY KEY,
  name            VARCHAR(100)  NOT NULL,           -- æµç¨‹åç§°
  levels          JSONB         NOT NULL,            -- å®¡æ‰¹çº§åˆ«é…ç½®
  condition       JSONB,                            -- è§¦å‘æ¡ä»¶
  timeout_hours   INT,                              -- è¶…æ—¶æ—¶é—´
  status          VARCHAR(10)  NOT NULL DEFAULT 'active',
  created_at      TIMESTAMP   DEFAULT NOW(),
  updated_at      TIMESTAMP   DEFAULT NOW()
);

-- æ ‡ç­¾è¡¨
tags (
  id          SnowflakeID   PRIMARY KEY,
  name        VARCHAR(50)   NOT NULL,               -- æ ‡ç­¾åç§°
  color       VARCHAR(20),                          -- æ ‡ç­¾é¢œè‰²
  type        VARCHAR(20)   NOT NULL,               -- document/template
  created_at  TIMESTAMP   DEFAULT NOW()
);

-- æ–‡ä»¶æ ‡ç­¾å…³è”è¡¨
document_tags (
  id          SnowflakeID   PRIMARY KEY,
  document_id SnowflakeID   REFERENCES documents(id),
  tag_id      SnowflakeID   REFERENCES tags(id),
  created_at  TIMESTAMP   DEFAULT NOW()
);

-- é‚®ä»¶é…ç½®è¡¨
email_config (
  id          SnowflakeID   PRIMARY KEY,
  host        VARCHAR(100)  NOT NULL,               -- SMTPæœåŠ¡å™¨
  port        INT           NOT NULL,               -- ç«¯å£
  username    VARCHAR(100)  NOT NULL,               -- å‘ä»¶è´¦å·
  password    VARCHAR(255)  NOT NULL,               -- å‘ä»¶å¯†ç 
  from_name   VARCHAR(100),                         -- å‘ä»¶äººåç§°
  status      VARCHAR(10)   NOT NULL DEFAULT 'active',
  created_at  TIMESTAMP   DEFAULT NOW(),
  updated_at  TIMESTAMP   DEFAULT NOW()
);

-- ç³»ç»Ÿé…ç½®è¡¨
system_config (
  id          SnowflakeID   PRIMARY KEY,
  key         VARCHAR(50)   UNIQUE NOT NULL,        -- é…ç½®é”®
  value       TEXT,                                 -- é…ç½®å€¼
  description VARCHAR(200),                         -- è¯´æ˜
  updated_at  TIMESTAMP   DEFAULT NOW()
);
```

### 14.4 å®Œæ•´ç‰ˆAPIæ‰©å±•

| æ¨¡å— | ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|------|
| **å·¥ä½œæµ** | | | |
| | /api/v1/workflows | GET | æµç¨‹åˆ—è¡¨ |
| | /api/v1/workflows | POST | åˆ›å»ºæµç¨‹ |
| | /api/v1/workflows/:id | PUT | æ›´æ–°æµç¨‹ |
| | /api/v1/workflows/:id | DELETE | åˆ é™¤æµç¨‹ |
| **æ ‡ç­¾** | | | |
| | /api/v1/tags | GET | æ ‡ç­¾åˆ—è¡¨ |
| | /api/v1/tags | POST | åˆ›å»ºæ ‡ç­¾ |
| | /api/v1/tags/:id | DELETE | åˆ é™¤æ ‡ç­¾ |
| | /api/v1/tags/:id/documents | GET | æ ‡ç­¾ä¸‹çš„æ–‡æ¡£ |
| **ç»Ÿè®¡** | | | |
| | /api/v1/stats/documents | GET | æ–‡æ¡£ç»Ÿè®¡ |
| | /api/v1/stats/approvals | GET | å®¡æ‰¹ç»Ÿè®¡ |
| | /api/v1/stats/tasks | GET | ä»»åŠ¡ç»Ÿè®¡ |
| **ç³»ç»Ÿ** | | | |
| | /api/v1/config | GET | ç³»ç»Ÿé…ç½® |
| | /api/v1/config | PUT | æ›´æ–°é…ç½® |
| | /api/v1/email/test | POST | å‘é€æµ‹è¯•é‚®ä»¶ |

### 14.5 å®Œæ•´ç‰ˆå‰ç«¯é¡µé¢

åœ¨ MVP ä¾§è¾¹æ åŸºç¡€ä¸Šï¼Œå®Œæ•´ç‰ˆå¢åŠ ï¼š

```
ä¾§è¾¹æ æ‰©å±•:
â”œâ”€â”€ ç³»ç»Ÿç®¡ç†ï¼ˆAdminï¼‰
â”‚   â”œâ”€â”€ å·¥ä½œæµé…ç½® â† æ–°å¢
â”‚   â”œâ”€â”€ æ ‡ç­¾ç®¡ç† â† æ–°å¢
â”‚   â”œâ”€â”€ é‚®ä»¶é…ç½® â† æ–°å¢
â”‚   â””â”€â”€ ç³»ç»Ÿå‚æ•° â† æ–°å¢
â”œâ”€â”€ ç»Ÿè®¡åˆ†æ â† æ–°å¢
â”‚   â”œâ”€â”€ æ–‡æ¡£ç»Ÿè®¡
â”‚   â”œâ”€â”€ å®¡æ‰¹ç»Ÿè®¡
â”‚   â””â”€â”€ ä»»åŠ¡ç»Ÿè®¡
â””â”€â”€ æˆ‘çš„
    â”œâ”€â”€ æˆ‘çš„å½’æ¡£ â† æ–°å¢
    â””â”€â”€ ä¸ªäººè®¾ç½® â† æ–°å¢ï¼ˆè¯­è¨€åˆ‡æ¢ã€é‚®ç®±ç»‘å®šï¼‰
```

### 14.6 å®Œæ•´ç‰ˆç»„ä»¶æ‰©å±•

| ç»„ä»¶ | ç”¨é€” | è¯´æ˜ |
|------|------|------|
| WorkflowDesigner | å·¥ä½œæµè®¾è®¡å™¨ | å¯è§†åŒ–æ‹–æ‹½é…ç½®å®¡æ‰¹æµç¨‹ |
| VersionCompare | ç‰ˆæœ¬å¯¹æ¯” | æ–‡æ¡£ç‰ˆæœ¬å·®å¼‚å¯¹æ¯” |
| TagManager | æ ‡ç­¾ç®¡ç† | æ‰¹é‡æ‰“æ ‡ç­¾ã€æ ‡ç­¾ç­›é€‰ |
| DataExport | æ•°æ®å¯¼å‡º | æ‰¹é‡å¯¼å‡ºExcel |
| EmailSettings | é‚®ä»¶è®¾ç½® | SMTPé…ç½®ã€æµ‹è¯•å‘é€ |
| StatsDashboard | ç»Ÿè®¡é¢æ¿ | å›¾è¡¨å±•ç¤ºç»Ÿè®¡æ•°æ® |
| LanguageSwitch | è¯­è¨€åˆ‡æ¢ | ä¸­è‹±æ–‡åˆ‡æ¢ |
| FilePreview | æ–‡ä»¶é¢„è§ˆ | åœ¨çº¿é¢„è§ˆPDF/Word/Excel |

### 14.7 å®Œæ•´ç‰ˆå¼€å‘é¡ºåºï¼ˆPhase 7+ï¼‰

| Phase | æ¨¡å— | è¯´æ˜ |
|-------|------|------|
| Phase 7-8 | åç¦»æ£€æµ‹ï¼ˆä¾èµ– v2.0.0ï¼‰ | é…æ–¹å…¬å·®å®šä¹‰ã€è‡ªåŠ¨åç¦»æ£€æµ‹ã€2çº§å®¡æ‰¹æµç¨‹ï¼ˆå·¥ä½œæµå¼•æ“å®ç°ï¼‰ |
| Phase 9 | æ•°æ®å¯¼å‡º | Excelæ‰¹é‡å¯¼å‡º |
| Phase 11 | æ–‡ä»¶é¢„è§ˆ | åœ¨çº¿é¢„è§ˆåŠŸèƒ½ |
| Phase 12 | ç»Ÿè®¡åˆ†æ | æŠ¥è¡¨å’Œå›¾è¡¨å±•ç¤º |
| Phase 13 | å¤šè¯­è¨€ | ä¸­è‹±æ–‡åˆ‡æ¢æ¡†æ¶ |
| Phase 14 | é‚®ä»¶é€šçŸ¥ | ç•™æ¥å£ï¼Œä¸å®ç° |
| v2.0.0 | å·¥ä½œæµ+æ™ºèƒ½æ–‡æ¡£ | å·¥ä½œæµå¼•æ“ï¼ˆæ›¿ä»£ Phase 10ï¼‰+ æ™ºèƒ½æ–‡æ¡£å¼•æ“ |

### 14.8 æ•°æ®è”åŠ¨ä¸ç‰ˆæœ¬è”åŠ¨è¯´æ˜

#### æ•°æ®è”åŠ¨ï¼ˆè‡ªåŠ¨å¸¦å…¥ï¼‰
**è§¦å‘æ—¶æœº**ï¼šåˆ›å»ºä¸‹æ¸¸æŠ¥è¡¨æ—¶
**ä¸šåŠ¡åœºæ™¯**ï¼šé…æ–™è¡¨åˆ›å»ºæ—¶ï¼Œè‡ªåŠ¨å¸¦å…¥å·¥è‰ºé…æ–¹çš„åŸæ–™å’Œæ¯”ä¾‹

```
æ­¥éª¤ï¼š
1. æ‰“å¼€"é…æ–™è¡¨"æ¨¡æ¿åˆ›å»ºæ–°è®°å½•
2. é€‰æ‹©å…³è”çš„"å·¥è‰ºé…æ–¹"ï¼ˆæ¯”å¦‚ï¼šé…æ–¹Aï¼‰
3. ç³»ç»Ÿè‡ªåŠ¨æŠŠé…æ–¹Açš„åŸæ–™å’Œæ¯”ä¾‹å¸¦å…¥é…æ–™è¡¨
4. ä¿å­˜ â†’ å®Œæˆ
```

#### ç‰ˆæœ¬è”åŠ¨ï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰
**è§¦å‘æ—¶æœº**ï¼šä¸Šæ¸¸é…æ–¹å˜æ›´æ—¶
**ä¸šåŠ¡åœºæ™¯**ï¼šé…æ–¹ä»v1.0æ›´æ–°åˆ°v1.1ï¼Œæ‰€æœ‰å…³è”çš„ç”Ÿäº§è®°å½•è‡ªåŠ¨æ›´æ–°

```
æ­¥éª¤ï¼š
1. é…æ–¹Aç‰ˆæœ¬ä»1.0æ›´æ–°åˆ°1.1ï¼ˆåŸæ–™æ¯”ä¾‹å˜äº†ï¼‰
2. ç³»ç»Ÿæ£€æµ‹åˆ°å˜æ›´
3. è‡ªåŠ¨æ‰¾åˆ°æ‰€æœ‰å…³è”çš„ç”Ÿäº§è®°å½•
4. æŠŠè¿™äº›è®°å½•ä¸­çš„é…æ–¹æ•°æ®æ›´æ–°åˆ°1.1ç‰ˆæœ¬
```

#### ä¸šåŠ¡å…³ç³»å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    åˆ›å»ºæ—¶å¸¦å…¥     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å·¥è‰ºé…æ–¹    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚  ç”Ÿäº§æŠ¥è¡¨   â”‚
â”‚  (é…æ–¹A v1.0)â”‚                  â”‚  (å¸¦é…æ–¹A)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ é…æ–¹æ›´æ–° v1.0 â†’ v1.1
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    è‡ªåŠ¨æ›´æ–°       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å·¥è‰ºé…æ–¹    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚  ç”Ÿäº§æŠ¥è¡¨   â”‚
â”‚  (é…æ–¹A v1.1)â”‚                  â”‚  (åŒæ­¥æ›´æ–°) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 14.9 å®Œæ•´ç‰ˆæ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹**: å®Œæ•´ç‰ˆæ”¹åŠ¨ä¸èƒ½å½±å“ MVP å·²æœ‰åŠŸèƒ½
2. **æ•°æ®è¿ç§»**: æ–°å¢è¡¨éœ€è¦å¤„ç†å­˜é‡æ•°æ®
3. **å¹³æ»‘å‡çº§**: æ”¯æŒé…ç½®å¼€å…³æ§åˆ¶åŠŸèƒ½å¯ç”¨/ç¦ç”¨
4. **æ€§èƒ½è€ƒè™‘**: å¤§æ•°æ®é‡æ—¶éœ€è¦åˆ†è¡¨æˆ–å½’æ¡£ç­–ç•¥
5. **å®‰å…¨å¢å¼º**: å®Œæ•´ç‰ˆéœ€è¦æ›´ä¸¥æ ¼çš„æƒé™æ ¡éªŒå’Œå®¡è®¡æ—¥å¿—

---

## åå››ã€æ™ºèƒ½æ–‡æ¡£å¼•æ“ä¸å·¥ä½œæµç³»ç»Ÿï¼ˆv2.0.0 - PRD-01æ•´åˆï¼‰

[â¬†ï¸ è¿”å›ç›®å½•](#-å®Œæ•´ç›®å½•) | [â¬†ï¸ è¿”å›å¿«é€Ÿå¯¼èˆª](#-å¿«é€Ÿå¯¼èˆª)

> **é‡è¦è¯´æ˜**ï¼š
> - æœ¬ç« èŠ‚åŸºäº BRCGS ä½“ç³»è®¤è¯ SaaS ç³»ç»Ÿ PRD-01ã€Šæ–‡æ¡£å®¡æ ¸ç­¾å­—ç³»ç»Ÿã€‹çš„éœ€æ±‚æ•´åˆ
> - æ ¸å¿ƒç›®æ ‡ï¼š**æ·±åº¦ä¼˜åŒ–**ç°æœ‰æ–‡æ¡£ç®¡ç†ç³»ç»Ÿï¼Œå®ç°ä½“ç³»æ–‡ä»¶å†…å®¹å¼•ç”¨å’Œå·¥ä½œæµçµæ´»é…ç½®
> - å®æ–½åŸåˆ™ï¼šåŸºäºç°æœ‰é¡¹ç›®æ·±åº¦ä¼˜åŒ–ï¼Œè€Œéç®€å•åŠŸèƒ½å åŠ 
> - è®¾è®¡æ—¥æœŸï¼š2026-02-12

### 14.0 v2.0.0 åŠŸèƒ½æ€»è§ˆ

| æ¨¡å— | æ ¸å¿ƒåŠŸèƒ½ | ä¸šåŠ¡ä»·å€¼ | ä¼˜å…ˆçº§ |
|------|---------|---------|-------|
| **æ™ºèƒ½æ–‡æ¡£å¼•æ“** | ä¸‰çº§æ–‡ä»¶å†…å®¹å¼•ç”¨ã€è‡ªåŠ¨åŒæ­¥ã€Blockæœºåˆ¶ | æ¶ˆé™¤é‡å¤å†…å®¹ç»´æŠ¤ã€ç¡®ä¿å†…å®¹ä¸€è‡´æ€§ | P0 |
| **ç®€åŒ–å·¥ä½œæµå¼•æ“** | éƒ¨é—¨çº§æµç¨‹é…ç½®ã€å¹¶è¡Œä¼šç­¾ã€æµç¨‹å¯è§†åŒ– | æ›¿ä»£ç¡¬ç¼–ç å®¡æ‰¹ã€æå‡æµç¨‹çµæ´»æ€§ | P0 |
| **æ–‡æ¡£å†…å®¹æ ‡å‡†åŒ–** | Tiptapå¯Œæ–‡æœ¬ç¼–è¾‘å™¨ã€ç»Ÿä¸€JSONæ ¼å¼ | æå‡ç”¨æˆ·ä½“éªŒã€æ”¯æŒå¼•ç”¨åŠŸèƒ½ | P0 |
| **æ–‡æ¡£æå–è¾…åŠ©** | Word/PDFå†…å®¹æå–ã€æ™ºèƒ½åˆ†æ®µ | åŠ é€Ÿæ–‡æ¡£ç”µå­åŒ–ã€å†…å®¹æ ‡å‡†åŒ– | P1 |
| **å¼•ç”¨å…³ç³»å¯è§†åŒ–** | Vue Flowä¾èµ–å›¾ã€å½±å“èŒƒå›´åˆ†æ | æ¸…æ™°å±•ç¤ºæ–‡æ¡£å…³è”å…³ç³» | P1 |

**å®æ–½é¡ºåºå»ºè®®**ï¼š
```
Phase 1: æ•°æ®åº“è®¾è®¡ä¸æ‰©å±•ï¼ˆ1å‘¨ï¼‰
  â†“
Phase 2: ç®€åŒ–å·¥ä½œæµå¼•æ“ï¼ˆ4å‘¨ï¼‰
  â†“
Phase 3: æ™ºèƒ½æ–‡æ¡£å¼•æ“ï¼ˆ4å‘¨ï¼‰
  â†“
Phase 4: ç³»ç»Ÿé›†æˆä¸æµ‹è¯•ï¼ˆ2å‘¨ï¼‰

æ€»è®¡ï¼š11å‘¨ï¼ˆçº¦3ä¸ªæœˆï¼‰
```

---

### 14.1 ä¸šåŠ¡èƒŒæ™¯ä¸æ ¸å¿ƒé—®é¢˜

#### 14.1.1 ç°æœ‰ç³»ç»Ÿçš„å±€é™æ€§

**é—®é¢˜1ï¼šæ–‡æ¡£å†…å®¹é‡å¤ç»´æŠ¤**
```
åœºæ™¯ï¼šé£Ÿå“ä¼ä¸šä½“ç³»æ–‡ä»¶ä¸­å¤§é‡å†…å®¹é‡å¤å‡ºç°

ã€Šç”Ÿäº§å·¥è‰ºè§„ç¨‹ã€‹ï¼ˆä¸‰çº§æ–‡ä»¶ï¼‰åŒ…å«ï¼š
  - å·¥è‰ºæµç¨‹
  - æ ‡å‡†é…æ–¹
  - é…æ–™è¡¨

ã€ŠHACCPè®¡åˆ’ã€‹ï¼ˆä¸‰çº§æ–‡ä»¶ï¼‰éœ€è¦å¼•ç”¨ï¼š
  - ã€Šç”Ÿäº§å·¥è‰ºè§„ç¨‹ã€‹çš„å·¥è‰ºæµç¨‹
  - ã€Šç”Ÿäº§å·¥è‰ºè§„ç¨‹ã€‹çš„æ ‡å‡†é…æ–¹

ã€Šä½œä¸šæŒ‡å¯¼ä¹¦ã€‹ï¼ˆä¸‰çº§æ–‡ä»¶ï¼‰éœ€è¦å¼•ç”¨ï¼š
  - ã€Šç”Ÿäº§å·¥è‰ºè§„ç¨‹ã€‹çš„éƒ¨åˆ†å·¥è‰ºæ­¥éª¤

å½“å‰ç—›ç‚¹ï¼š
âŒ éœ€è¦æ‰‹åŠ¨å¤åˆ¶ç²˜è´´å†…å®¹åˆ°å¤šä¸ªæ–‡æ¡£
âŒ æºæ–‡æ¡£ä¿®æ”¹åï¼Œæ‰€æœ‰å¼•ç”¨æ–‡æ¡£éœ€è¦æ‰‹åŠ¨åŒæ­¥
âŒ å®¹æ˜“å‡ºç°å†…å®¹ä¸ä¸€è‡´ã€ç‰ˆæœ¬æ··ä¹±
```

**é—®é¢˜2ï¼šå®¡æ‰¹æµç¨‹ç¡¬ç¼–ç **
```
å½“å‰ç³»ç»Ÿï¼š
- æ–‡æ¡£å®¡æ‰¹ï¼šåˆ›å»ºäºº â†’ ä¸Šçº§ï¼ˆç¡¬ç¼–ç ï¼‰
- åç¦»è®°å½•ï¼šå‘˜å·¥ â†’ ä¸»ç®¡ â†’ ç»ç†ï¼ˆç¡¬ç¼–ç ï¼‰

å±€é™æ€§ï¼š
âŒ æ— æ³•è‡ªå®šä¹‰å®¡æ‰¹æµç¨‹
âŒ ä¸æ”¯æŒå¹¶è¡Œä¼šç­¾ï¼ˆå¤šéƒ¨é—¨åŒæ—¶å®¡æ‰¹ï¼‰
âŒ ä¸æ”¯æŒéƒ¨é—¨çº§æµç¨‹é…ç½®
```

**é—®é¢˜3ï¼šæ–‡æ¡£æ ¼å¼ä¸ç»Ÿä¸€**
```
å½“å‰ç³»ç»Ÿï¼š
- Document.content å­—æ®µç±»å‹ï¼šTextï¼ˆçº¯æ–‡æœ¬æˆ–HTMLï¼‰
- æ— ç»Ÿä¸€çš„å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
- æ— æ³•æ”¯æŒå¤æ‚çš„å†…å®¹å¼•ç”¨

éœ€æ±‚ï¼š
âœ… ç»Ÿä¸€çš„å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ï¼ˆç±»ä¼¼Notionï¼‰
âœ… ç»“æ„åŒ–çš„å†…å®¹å­˜å‚¨ï¼ˆJSONæ ¼å¼ï¼‰
âœ… æ”¯æŒå¼•ç”¨Blockï¼ˆå¯è§†åŒ–æ ‡è¯†ã€åªè¯»ã€æº¯æºï¼‰
```

#### 14.1.2 æ ¸å¿ƒä¸šåŠ¡ä»·å€¼

**ä»·å€¼1ï¼šå†…å®¹ä¸€è‡´æ€§ä¿éšœ**
- æºæ–‡æ¡£ä¿®æ”¹åï¼Œæ‰€æœ‰å¼•ç”¨è‡ªåŠ¨åŒæ­¥
- é¿å…å› æ‰‹åŠ¨å¤åˆ¶ç²˜è´´å¯¼è‡´çš„å†…å®¹ä¸ä¸€è‡´
- å‡å°‘é‡å¤ç»´æŠ¤å·¥ä½œé‡ï¼Œæå‡æ•ˆç‡

**ä»·å€¼2ï¼šå®¡æ‰¹æµç¨‹çµæ´»åŒ–**
- éƒ¨é—¨Leaderå¯è‡ªå®šä¹‰æœ¬éƒ¨é—¨çš„å®¡æ‰¹æµç¨‹
- æ”¯æŒå¤æ‚å®¡æ‰¹åœºæ™¯ï¼ˆå¹¶è¡Œä¼šç­¾ã€æ¡ä»¶åˆ†æ”¯ï¼‰
- æµç¨‹å¯è§†åŒ–å±•ç¤ºï¼Œè¿›åº¦ä¸€ç›®äº†ç„¶

**ä»·å€¼3ï¼šç”¨æˆ·ä½“éªŒæå‡**
- Notionçº§åˆ«çš„ç¼–è¾‘ä½“éªŒ
- å¼•ç”¨Blockæ¸…æ™°æ ‡è¯†ï¼Œæº¯æºæ¸…æ¥š
- æ–‡æ¡£å†…å®¹æ ‡å‡†åŒ–ï¼Œä¾¿äºç®¡ç†

---

### 14.2 æ ¸å¿ƒåŠŸèƒ½è¯¦ç»†è®¾è®¡

#### 14.2.1 æ™ºèƒ½æ–‡æ¡£å¼•æ“

##### åŠŸèƒ½èŒƒå›´

**æ”¯æŒçš„å¼•ç”¨ç±»å‹**ï¼š
- âœ… ä¸‰çº§æ–‡ä»¶ â† å¼•ç”¨ â† ä¸‰çº§æ–‡ä»¶
- âŒ ä¸‰çº§æ–‡ä»¶ â† å¼•ç”¨ â† å››çº§è®°å½•ï¼ˆä¸æ”¯æŒï¼Œå››çº§è®°å½•ä¸ºç”Ÿäº§æ•°æ®è¡¨æ ¼ï¼‰

**å¼•ç”¨ç²’åº¦**ï¼š
- ç« èŠ‚çº§åˆ«å¼•ç”¨ï¼ˆå¦‚ï¼šå¼•ç”¨"ç¬¬3ç«  ç”Ÿäº§å·¥è‰ºæµç¨‹"ï¼‰
- æ”¯æŒå¯Œæ–‡æœ¬å†…å®¹ï¼ˆæ®µè½ã€åˆ—è¡¨ã€è¡¨æ ¼ç­‰ï¼‰

**å¼•ç”¨ç‰¹æ€§**ï¼š
- **åªè¯»**ï¼šç›®æ ‡æ–‡æ¡£æ— æ³•ä¿®æ”¹å¼•ç”¨Blockå†…å®¹
- **å¯åˆ é™¤**ï¼šç”¨æˆ·å¯åˆ é™¤æ•´ä¸ªå¼•ç”¨Block
- **è‡ªåŠ¨åŒæ­¥**ï¼šæºæ–‡æ¡£å®¡æ‰¹é€šè¿‡åï¼Œå¼‚æ­¥åŒæ­¥åˆ°æ‰€æœ‰å¼•ç”¨æ–‡æ¡£
- **æ‰‹åŠ¨åˆ·æ–°**ï¼šç”¨æˆ·å¯æ‰‹åŠ¨è§¦å‘å¼•ç”¨å†…å®¹åˆ·æ–°

##### å…¸å‹åœºæ™¯

**åœºæ™¯1ï¼šHACCPè®¡åˆ’å¼•ç”¨ç”Ÿäº§å·¥è‰ºè§„ç¨‹**

```
æºæ–‡æ¡£ï¼šã€Šå·§å…‹åŠ›é¥¼å¹²ç”Ÿäº§å·¥è‰ºè§„ç¨‹ã€‹ï¼ˆä¸‰çº§æ–‡ä»¶ï¼‰
â”œâ”€â”€ ç¬¬1ç«  èŒƒå›´
â”œâ”€â”€ ç¬¬2ç«  èŒè´£
â”œâ”€â”€ ç¬¬3ç«  ç”Ÿäº§å·¥è‰ºæµç¨‹
â”‚   â”œâ”€â”€ 3.1 å·¥è‰ºæµç¨‹å›¾
â”‚   â”‚   1. åŸæ–™éªŒæ”¶
â”‚   â”‚   2. é…æ–™æ··åˆ
â”‚   â”‚   3. æˆå‹
â”‚   â”‚   4. çƒ˜çƒ¤ï¼ˆCCP1ï¼‰
â”‚   â”‚   5. å†·å´
â”‚   â”‚   6. åŒ…è£…ï¼ˆCCP2ï¼‰
â”‚   â”œâ”€â”€ 3.2 æ ‡å‡†é…æ–¹ï¼ˆè¡¨æ ¼ï¼‰
â”‚   â””â”€â”€ 3.3 å…³é”®æ§åˆ¶ç‚¹
â””â”€â”€ ç¬¬4ç«  è´¨é‡æ ‡å‡†

ç›®æ ‡æ–‡æ¡£ï¼šã€Šå·§å…‹åŠ›é¥¼å¹²HACCPè®¡åˆ’ã€‹ï¼ˆä¸‰çº§æ–‡ä»¶ï¼‰
â”œâ”€â”€ ç¬¬1éƒ¨åˆ†ï¼šç”Ÿäº§å·¥è‰ºæµç¨‹
â”‚   â””â”€â”€ [å¼•ç”¨Block: ã€Šç”Ÿäº§å·¥è‰ºè§„ç¨‹ã€‹> 3.1 å·¥è‰ºæµç¨‹å›¾]  â† è‡ªåŠ¨åŒæ­¥
â”œâ”€â”€ ç¬¬2éƒ¨åˆ†ï¼šå…³é”®æ§åˆ¶ç‚¹ï¼ˆCCPï¼‰
â”‚   â””â”€â”€ æ ¹æ®å·¥è‰ºæµç¨‹ï¼Œè¯†åˆ«CCP1ï¼ˆçƒ˜çƒ¤ï¼‰ã€CCP2ï¼ˆåŒ…è£…ï¼‰
â””â”€â”€ ç¬¬3éƒ¨åˆ†ï¼šç›‘æ§æªæ–½
```

**ç”¨æˆ·æ“ä½œæµç¨‹**ï¼š

1. **åˆ›å»ºå¼•ç”¨**ï¼š
   - ç”¨æˆ·åœ¨ã€ŠHACCPè®¡åˆ’ã€‹ä¸­ï¼Œå…‰æ ‡å®šä½åˆ°"ç¬¬1éƒ¨åˆ†"ä¸‹æ–¹
   - ç‚¹å‡»å·¥å…·æ "æ’å…¥å¼•ç”¨"æŒ‰é’®
   - é€‰æ‹©æºæ–‡æ¡£ï¼šã€Šå·§å…‹åŠ›é¥¼å¹²ç”Ÿäº§å·¥è‰ºè§„ç¨‹ã€‹
   - é€‰æ‹©ç« èŠ‚ï¼š3.1 å·¥è‰ºæµç¨‹å›¾
   - ç¡®è®¤æ’å…¥ â†’ ç³»ç»Ÿåˆ›å»ºå¼•ç”¨Block

2. **æŸ¥çœ‹å¼•ç”¨**ï¼š
   ```html
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ğŸ”— å¼•ç”¨è‡ªï¼šã€Šå·§å…‹åŠ›é¥¼å¹²ç”Ÿäº§å·¥è‰ºè§„ç¨‹ã€‹ > 3.1 å·¥è‰ºæµç¨‹å›¾  â”‚
   â”‚ [åªè¯»] [æŸ¥çœ‹æº] [åˆ·æ–°] [åˆ é™¤]                           â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ 3.1 å·¥è‰ºæµç¨‹å›¾                                          â”‚
   â”‚ 1. åŸæ–™éªŒæ”¶                                            â”‚
   â”‚ 2. é…æ–™æ··åˆ                                            â”‚
   â”‚ 3. æˆå‹                                                â”‚
   â”‚ 4. çƒ˜çƒ¤ï¼ˆCCP1ï¼‰                                        â”‚
   â”‚ 5. å†·å´                                                â”‚
   â”‚ 6. åŒ…è£…ï¼ˆCCP2ï¼‰                                        â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ æœ€ååŒæ­¥ï¼š2026-02-12 14:30                             â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ```

3. **æºæ–‡æ¡£ä¿®æ”¹åè‡ªåŠ¨åŒæ­¥**ï¼š
   - ç ”å‘éƒ¨ä¿®æ”¹ã€Šç”Ÿäº§å·¥è‰ºè§„ç¨‹ã€‹ï¼Œå¢åŠ å·¥è‰ºæ­¥éª¤"7. é‡‘å±æ£€æµ‹"
   - æäº¤å®¡æ‰¹ â†’ å®¡æ‰¹é€šè¿‡
   - ç³»ç»Ÿè§¦å‘å¼‚æ­¥åŒæ­¥é˜Ÿåˆ—
   - æ‰€æœ‰å¼•ç”¨æ­¤ç« èŠ‚çš„æ–‡æ¡£è‡ªåŠ¨æ›´æ–°
   - é€šçŸ¥ç›®æ ‡æ–‡æ¡£è´Ÿè´£äººï¼š"å¼•ç”¨å†…å®¹å·²æ›´æ–°"

4. **æ‰‹åŠ¨åˆ·æ–°å¼•ç”¨**ï¼š
   - ç”¨æˆ·æ‰“å¼€ã€ŠHACCPè®¡åˆ’ã€‹
   - çœ‹åˆ°å¼•ç”¨Blockåº•éƒ¨æç¤ºï¼š"æºæ–‡æ¡£å·²æ›´æ–°"
   - ç‚¹å‡»"åˆ·æ–°"æŒ‰é’® â†’ ç«‹å³åŒæ­¥æœ€æ–°å†…å®¹

##### æŠ€æœ¯å®ç°æ–¹æ¡ˆ

**1. æ–‡æ¡£å†…å®¹æ ¼å¼ï¼šTiptap JSON**

```typescript
// Document.content å­—æ®µç±»å‹æ”¹ä¸º Json
model Document {
  content Json  // Tiptap JSONæ ¼å¼
}

// Tiptap JSON ç»“æ„ç¤ºä¾‹
{
  "type": "doc",
  "content": [
    {
      "type": "heading",
      "attrs": { "level": 2, "id": "section-3-1" },
      "content": [{ "type": "text", "text": "3.1 å·¥è‰ºæµç¨‹å›¾" }]
    },
    {
      "type": "orderedList",
      "content": [
        {
          "type": "listItem",
          "content": [
            {
              "type": "paragraph",
              "content": [{ "type": "text", "text": "åŸæ–™éªŒæ”¶" }]
            }
          ]
        },
        // ... å…¶ä»–æ­¥éª¤
      ]
    }
  ]
}
```

**2. å¼•ç”¨Blockè‡ªå®šä¹‰æ‰©å±•**

```typescript
// è‡ªå®šä¹‰Tiptapæ‰©å±•ï¼šReferenceBlock
{
  "type": "referenceBlock",
  "attrs": {
    "sourceDocId": "doc-001",
    "sourceDocTitle": "å·§å…‹åŠ›é¥¼å¹²ç”Ÿäº§å·¥è‰ºè§„ç¨‹",
    "sectionId": "section-3-1",
    "referenceId": "ref-abc-123",  // DocumentReferenceè¡¨çš„ID
    "editable": false,
    "lastSyncedAt": "2026-02-12T14:30:00Z"
  },
  "content": [
    // è‡ªåŠ¨åŒæ­¥çš„å†…å®¹ï¼ˆä»æºæ–‡æ¡£å¤åˆ¶ï¼‰
    {
      "type": "heading",
      "attrs": { "level": 3 },
      "content": [{ "type": "text", "text": "3.1 å·¥è‰ºæµç¨‹å›¾" }]
    },
    {
      "type": "orderedList",
      "content": [...]
    }
  ]
}
```

**3. ç« èŠ‚IDè‡ªåŠ¨ç”Ÿæˆ**

```typescript
// è‡ªå®šä¹‰Headingæ‰©å±•ï¼Œè‡ªåŠ¨ç”Ÿæˆç« èŠ‚ID
import Heading from '@tiptap/extension-heading';

export const HeadingWithId = Heading.extend({
  addAttributes() {
    return {
      ...this.parent?.(),
      id: {
        default: null,
        parseHTML: element => element.getAttribute('id'),
        renderHTML: attributes => {
          if (!attributes.id) {
            // åŸºäºæ ‡é¢˜æ–‡æœ¬è‡ªåŠ¨ç”ŸæˆID
            const text = extractText(attributes.content);
            attributes.id = `section-${slugify(text)}`;
          }
          return { id: attributes.id };
        }
      }
    };
  }
});

// ç”Ÿæˆæ•ˆæœ
<h2 id="section-3-1">3.1 å·¥è‰ºæµç¨‹å›¾</h2>
```

**4. å¼‚æ­¥åŒæ­¥é˜Ÿåˆ—**

```typescript
// ä½¿ç”¨BullMQå¤„ç†å¼•ç”¨åŒæ­¥
import { Queue, Worker } from 'bullmq';

// ç›‘å¬DocumentçŠ¶æ€å˜æ›´
@OnEvent('document.approved')
async handleDocumentApproved(payload: { documentId: string }) {
  const { documentId } = payload;

  // æŸ¥æ‰¾æ‰€æœ‰å¼•ç”¨æ­¤æ–‡æ¡£çš„å…³ç³»
  const references = await this.prisma.documentReference.findMany({
    where: { sourceDocId: documentId }
  });

  // æ‰¹é‡åŠ å…¥åŒæ­¥é˜Ÿåˆ—
  for (const ref of references) {
    await this.syncQueue.add('sync-reference', {
      referenceId: ref.id,
      sourceDocId: documentId,
      sectionId: ref.sectionId
    });
  }
}

// åŒæ­¥é˜Ÿåˆ—å¤„ç†å™¨
@Process('sync-reference')
async syncReference(job: Job) {
  const { referenceId, sourceDocId, sectionId } = job.data;

  // 1. æå–æºæ–‡æ¡£ç« èŠ‚å†…å®¹
  const sourceDoc = await this.findDocument(sourceDocId);
  const sectionContent = this.extractSection(sourceDoc.content, sectionId);

  // 2. æ›´æ–°ç›®æ ‡æ–‡æ¡£çš„å¼•ç”¨Block
  const reference = await this.findReference(referenceId);
  const targetDoc = await this.findDocument(reference.targetDocId);
  const updatedContent = this.replaceReferenceBlock(
    targetDoc.content,
    referenceId,
    sectionContent
  );

  // 3. ä¿å­˜ç›®æ ‡æ–‡æ¡£
  await this.prisma.document.update({
    where: { id: reference.targetDocId },
    data: { content: updatedContent }
  });

  // 4. é€šçŸ¥ç›®æ ‡æ–‡æ¡£è´Ÿè´£äºº
  await this.notificationService.notify({
    userId: targetDoc.creatorId,
    type: 'reference_updated',
    content: `æ–‡æ¡£ã€Š${targetDoc.title}ã€‹çš„å¼•ç”¨å†…å®¹å·²æ›´æ–°`
  });
}
```

##### æ•°æ®æ¨¡å‹

```prisma
// æ‰©å±•Documentè¡¨
model Document {
  id              String   @id @default(cuid())
  title           String
  level           String   // level1/level2/level3
  content         Json     // âœ… æ”¹ä¸ºJsonç±»å‹ï¼ˆTiptap JSONï¼‰
  status          String   // draft/pending/approved

  // æ–°å¢ï¼šå¼•ç”¨å…³ç³»
  sourceReferences   DocumentReference[] @relation("SourceDoc")
  targetReferences   DocumentReference[] @relation("TargetDoc")

  @@index([level, status])
}

// æ–°å¢ï¼šæ–‡æ¡£å¼•ç”¨å…³ç³»è¡¨
model DocumentReference {
  id             String   @id @default(cuid())
  sourceDocId    String   // æºæ–‡æ¡£ID
  targetDocId    String   // ç›®æ ‡æ–‡æ¡£ID
  sectionId      String   // å¼•ç”¨ç« èŠ‚IDï¼ˆå¦‚ï¼šsection-3-1ï¼‰
  lastSyncedAt   DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  sourceDoc      Document @relation("SourceDoc", fields: [sourceDocId], references: [id], onDelete: Cascade)
  targetDoc      Document @relation("TargetDoc", fields: [targetDocId], references: [id], onDelete: Cascade)

  @@index([sourceDocId])
  @@index([targetDocId])
  @@unique([sourceDocId, targetDocId, sectionId])
}
```

##### å‰ç«¯ç»„ä»¶è®¾è®¡

**1. Tiptapç¼–è¾‘å™¨é›†æˆ**

```vue
<!-- DocumentEditor.vue -->
<template>
  <div class="document-editor">
    <el-card>
      <!-- å·¥å…·æ  -->
      <div class="editor-toolbar">
        <el-button @click="editor.chain().focus().toggleBold().run()">
          <el-icon><Bold /></el-icon> ç²—ä½“
        </el-button>
        <el-button @click="editor.chain().focus().toggleHeading({ level: 2 }).run()">
          <el-icon><Heading /></el-icon> æ ‡é¢˜
        </el-button>
        <el-divider direction="vertical" />
        <el-button @click="showInsertReferenceDialog">
          <el-icon><Link /></el-icon> æ’å…¥å¼•ç”¨
        </el-button>
      </div>

      <!-- ç¼–è¾‘å™¨ -->
      <editor-content :editor="editor" class="editor-content" />
    </el-card>

    <!-- æ’å…¥å¼•ç”¨å¯¹è¯æ¡† -->
    <InsertReferenceDialog
      v-model="insertDialogVisible"
      @confirm="insertReference"
    />
  </div>
</template>

<script setup lang="ts">
import { useEditor, EditorContent } from '@tiptap/vue-3';
import StarterKit from '@tiptap/starter-kit';
import { HeadingWithId } from '@/extensions/heading-with-id';
import { ReferenceBlock } from '@/extensions/reference-block';

const editor = useEditor({
  extensions: [
    StarterKit,
    HeadingWithId,
    ReferenceBlock
  ],
  content: props.initialContent,
  onUpdate: ({ editor }) => {
    emit('update:content', editor.getJSON());
  }
});

const insertReference = (referenceData) => {
  editor.value.commands.insertReferenceBlock({
    sourceDocId: referenceData.sourceDocId,
    sourceDocTitle: referenceData.sourceDocTitle,
    sectionId: referenceData.sectionId,
    referenceId: referenceData.referenceId
  });
};
</script>
```

**2. å¼•ç”¨Blockç»„ä»¶**

```vue
<!-- ReferenceBlockComponent.vue -->
<template>
  <node-view-wrapper class="reference-block">
    <!-- å¼•ç”¨å¤´éƒ¨ -->
    <div class="reference-header">
      <el-icon><Link /></el-icon>
      <span class="source-info">
        å¼•ç”¨è‡ªï¼šã€Š{{ node.attrs.sourceDocTitle }}ã€‹ > {{ sectionTitle }}
      </span>
      <div class="actions">
        <el-tag size="small" type="info">åªè¯»</el-tag>
        <el-button size="small" text @click="viewSource">æŸ¥çœ‹æº</el-button>
        <el-button size="small" text @click="refresh">åˆ·æ–°</el-button>
        <el-button size="small" text type="danger" @click="deleteNode">åˆ é™¤</el-button>
      </div>
    </div>

    <!-- å¼•ç”¨å†…å®¹ï¼ˆåªè¯»ï¼‰ -->
    <div class="reference-content" contenteditable="false">
      <node-view-content />
    </div>

    <!-- å¼•ç”¨è„šæ³¨ -->
    <div class="reference-footer">
      <span class="sync-time">æœ€ååŒæ­¥ï¼š{{ formatDate(node.attrs.lastSyncedAt) }}</span>
      <el-tag v-if="needsUpdate" type="warning" size="small">
        <el-icon><Warning /></el-icon>
        æºæ–‡æ¡£å·²æ›´æ–°ï¼Œç‚¹å‡»"åˆ·æ–°"è·å–æœ€æ–°å†…å®¹
      </el-tag>
    </div>
  </node-view-wrapper>
</template>

<script setup lang="ts">
import { NodeViewWrapper, NodeViewContent } from '@tiptap/vue-3';

const viewSource = () => {
  window.open(`/documents/${props.node.attrs.sourceDocId}`, '_blank');
};

const refresh = async () => {
  await api.post(`/document-references/${props.node.attrs.referenceId}/sync`);
  ElMessage.success('å¼•ç”¨å†…å®¹å·²åˆ·æ–°');
  location.reload();
};
</script>

<style scoped>
.reference-block {
  border: 2px dashed #409eff;
  border-radius: 8px;
  padding: 16px;
  margin: 16px 0;
  background: linear-gradient(135deg, #f0f9ff 0%, #e6f7ff 100%);
}

.reference-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid #d9ecff;
}

.reference-content {
  background: white;
  padding: 16px;
  border-radius: 4px;
  pointer-events: none;  /* ç¦æ­¢ç¼–è¾‘ */
  user-select: none;
  opacity: 0.95;
}

.reference-footer {
  margin-top: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 12px;
  color: #909399;
}
</style>
```

**3. æ’å…¥å¼•ç”¨å¯¹è¯æ¡†**

```vue
<!-- InsertReferenceDialog.vue -->
<template>
  <el-dialog title="æ’å…¥å¼•ç”¨" v-model="visible" width="700px">
    <el-form :model="form" label-width="100px">
      <!-- æ­¥éª¤1ï¼šé€‰æ‹©æºæ–‡æ¡£ -->
      <el-form-item label="é€‰æ‹©æºæ–‡æ¡£">
        <el-select
          v-model="form.sourceDocId"
          filterable
          remote
          :remote-method="searchDocuments"
          placeholder="æœç´¢ä¸‰çº§æ–‡ä»¶"
          @change="loadSections"
        >
          <el-option
            v-for="doc in availableDocs"
            :key="doc.id"
            :label="doc.title"
            :value="doc.id"
          >
            <span>{{ doc.title }}</span>
            <el-tag size="small">{{ doc.level }}</el-tag>
          </el-option>
        </el-select>
      </el-form-item>

      <!-- æ­¥éª¤2ï¼šé€‰æ‹©å¼•ç”¨ç« èŠ‚ -->
      <el-form-item label="é€‰æ‹©ç« èŠ‚">
        <el-tree
          :data="sectionTree"
          node-key="id"
          @node-click="handleSectionClick"
          highlight-current
        >
          <template #default="{ node, data }">
            <span>{{ data.title }}</span>
            <el-tag v-if="data.type === 'table'" size="small">è¡¨æ ¼</el-tag>
            <el-tag v-if="data.type === 'list'" size="small">åˆ—è¡¨</el-tag>
          </template>
        </el-tree>
      </el-form-item>

      <!-- æ­¥éª¤3ï¼šé¢„è§ˆå†…å®¹ -->
      <el-form-item label="å†…å®¹é¢„è§ˆ">
        <div class="preview-box">
          <editor-content :editor="previewEditor" />
        </div>
      </el-form-item>
    </el-form>

    <template #footer>
      <el-button @click="visible = false">å–æ¶ˆ</el-button>
      <el-button type="primary" :disabled="!form.sectionId" @click="confirm">
        æ’å…¥å¼•ç”¨
      </el-button>
    </template>
  </el-dialog>
</template>

<script setup lang="ts">
const searchDocuments = async (query: string) => {
  const res = await api.get('/documents', {
    params: { level: 'level3', search: query }
  });
  availableDocs.value = res.data;
};

const loadSections = async (docId: string) => {
  const res = await api.get(`/documents/${docId}/sections`);
  sectionTree.value = res.data;
};

const handleSectionClick = async (section: any) => {
  form.value.sectionId = section.id;
  // åŠ è½½é¢„è§ˆå†…å®¹
  const res = await api.get(`/documents/${form.value.sourceDocId}/sections/${section.id}/preview`);
  previewEditor.value.commands.setContent(res.data);
};

const confirm = async () => {
  // åˆ›å»ºå¼•ç”¨å…³ç³»
  const res = await api.post('/document-references', {
    sourceDocId: form.value.sourceDocId,
    targetDocId: currentDocumentId.value,
    sectionId: form.value.sectionId
  });

  emit('confirm', {
    sourceDocId: form.value.sourceDocId,
    sourceDocTitle: availableDocs.value.find(d => d.id === form.value.sourceDocId)?.title,
    sectionId: form.value.sectionId,
    referenceId: res.data.id
  });

  visible.value = false;
};
</script>
```

##### APIè®¾è®¡

```typescript
// å¼•ç”¨ç®¡ç†API
POST   /document-references              // åˆ›å»ºå¼•ç”¨å…³ç³»
GET    /document-references              // æŸ¥è¯¢å¼•ç”¨å…³ç³»
DELETE /document-references/:id          // åˆ é™¤å¼•ç”¨å…³ç³»
POST   /document-references/:id/sync     // æ‰‹åŠ¨åŒæ­¥å¼•ç”¨å†…å®¹

// æ–‡æ¡£ç« èŠ‚API
GET    /documents/:id/sections           // è·å–æ–‡æ¡£ç« èŠ‚æ ‘
GET    /documents/:id/sections/:sectionId/preview  // é¢„è§ˆç« èŠ‚å†…å®¹

// å¼•ç”¨åˆ†æAPI
GET    /documents/:id/reference-impact   // åˆ†æå¼•ç”¨å½±å“èŒƒå›´ï¼ˆå“ªäº›æ–‡æ¡£å¼•ç”¨äº†æˆ‘ï¼‰
GET    /documents/:id/reference-graph    // è·å–å¼•ç”¨å…³ç³»å›¾æ•°æ®
```

---

#### 14.2.2 ç®€åŒ–å·¥ä½œæµå¼•æ“

##### åŠŸèƒ½èŒƒå›´

**æ”¯æŒçš„æµç¨‹ç±»å‹**ï¼š
- âœ… é¡ºåºå®¡æ‰¹ï¼ˆæ­¥éª¤1 â†’ æ­¥éª¤2 â†’ æ­¥éª¤3ï¼‰
- âœ… å¹¶è¡Œä¼šç­¾ï¼ˆå¤šäººåŒæ—¶å®¡æ‰¹ï¼Œå…¨éƒ¨é€šè¿‡æ‰è¿›å…¥ä¸‹ä¸€æ­¥ï¼‰
- âŒ æ¡ä»¶åˆ†æ”¯ï¼ˆPhase 1ä¸æ”¯æŒï¼Œå»¶ååˆ°Phase 2ï¼‰
- âŒ å­æµç¨‹ï¼ˆPhase 1ä¸æ”¯æŒï¼‰

**æµç¨‹é…ç½®æ–¹å¼**ï¼š
- JSONé…ç½®ï¼ˆæ— å¯è§†åŒ–è®¾è®¡å™¨ï¼Œé™ä½å¤æ‚åº¦ï¼‰
- éƒ¨é—¨Leaderå¯åˆ›å»ºæœ¬éƒ¨é—¨çš„æµç¨‹æ¨¡æ¿
- æµç¨‹æ¨¡æ¿æ”¯æŒç‰ˆæœ¬ç®¡ç†ï¼ˆå·²è¿›è¡Œä¸­çš„æµç¨‹ä¸å—å½±å“ï¼‰

**å®¡æ‰¹æ“ä½œ**ï¼š
- åŒæ„ï¼ˆå¯é€‰å¡«å†™å®¡æ‰¹æ„è§ï¼‰
- é©³å›åˆ°èµ·è‰èŠ‚ç‚¹ï¼ˆå¿…å¡«é©³å›åŸå› ï¼Œâ‰¥5å­—ï¼‰
- åˆ é™¤æ•´ä¸ªæµç¨‹ï¼ˆä»…Adminï¼‰

**æµç¨‹å±•ç¤º**ï¼š
- Vue Flowæµç¨‹å›¾ï¼ˆå®æ—¶å±•ç¤ºè¿›åº¦ï¼‰
- é«˜äº®å½“å‰èŠ‚ç‚¹
- æ˜¾ç¤ºå·²å®ŒæˆèŠ‚ç‚¹çš„å®¡æ‰¹äººå’Œæ„è§

**å…³é”®ç®€åŒ–**ï¼š
- âŒ ç§»é™¤è¶…æ—¶å‚¬åŠåŠŸèƒ½ï¼ˆç”¨æˆ·æ˜ç¡®ä¸éœ€è¦ï¼‰
- âŒ ç§»é™¤è½¬äº¤/åŠ ç­¾åŠŸèƒ½ï¼ˆé™ä½å¤æ‚åº¦ï¼‰
- âœ… ä¿ç•™æ ¸å¿ƒèƒ½åŠ›ï¼šé¡ºåº+å¹¶è¡Œï¼Œæ»¡è¶³80%åœºæ™¯

##### å…¸å‹åœºæ™¯

**åœºæ™¯1ï¼šä¾›åº”å•†è¯„ä¼°æµç¨‹**

```json
{
  "templateId": "supplier-approval",
  "templateName": "ä¾›åº”å•†è¯„ä¼°æµç¨‹",
  "departmentId": "dept-purchase",  // é‡‡è´­éƒ¨
  "steps": [
    {
      "order": 1,
      "name": "é‡‡è´­ä¸“å‘˜æäº¤",
      "type": "approval",
      "approvers": ["user-001"]  // ç›´æ¥æŒ‡å®šå®¡æ‰¹äººID
    },
    {
      "order": 2,
      "name": "è´¨é‡éƒ¨+è´¢åŠ¡éƒ¨ä¼šç­¾",
      "type": "parallel",
      "approvers": ["user-002", "user-003"],
      "parallelMode": "all"  // å…¨éƒ¨é€šè¿‡æ‰èƒ½è¿›å…¥ä¸‹ä¸€æ­¥
    },
    {
      "order": 3,
      "name": "æ€»ç»ç†å®¡æ‰¹",
      "type": "approval",
      "approvers": ["user-004"]
    }
  ]
}
```

**æµç¨‹æ‰§è¡Œ**ï¼š
```
æ­¥éª¤1ï¼šé‡‡è´­ä¸“å‘˜æäº¤ â†’ user-001å®¡æ‰¹é€šè¿‡
  â†“
æ­¥éª¤2ï¼šå¹¶è¡Œä¼šç­¾
  â”œâ”€â”€ user-002ï¼ˆè´¨é‡éƒ¨ï¼‰ï¼šå®¡æ‰¹é€šè¿‡ âœ…
  â””â”€â”€ user-003ï¼ˆè´¢åŠ¡éƒ¨ï¼‰ï¼šå®¡æ‰¹é€šè¿‡ âœ…
  â†’ å…¨éƒ¨é€šè¿‡ï¼Œè¿›å…¥æ­¥éª¤3
  â†“
æ­¥éª¤3ï¼šuser-004ï¼ˆæ€»ç»ç†ï¼‰å®¡æ‰¹é€šè¿‡
  â†“
æµç¨‹å®Œæˆï¼Œæ–‡æ¡£çŠ¶æ€ = approved
```

**é©³å›åœºæ™¯**ï¼š
```
æ­¥éª¤2ï¼šå¹¶è¡Œä¼šç­¾
  â”œâ”€â”€ user-002ï¼ˆè´¨é‡éƒ¨ï¼‰ï¼šå®¡æ‰¹é€šè¿‡ âœ…
  â””â”€â”€ user-003ï¼ˆè´¢åŠ¡éƒ¨ï¼‰ï¼šé©³å› âŒï¼ˆåŸå› ï¼šä¾›åº”å•†èµ„è´¨ä¸å…¨ï¼‰
  â†’ ä»»ä¸€é©³å›ï¼Œæµç¨‹ç«‹å³ç»ˆæ­¢
  â†“
æµç¨‹çŠ¶æ€ = rejectedï¼Œå›åˆ°æ­¥éª¤1ï¼ˆé‡æ–°æäº¤ï¼‰
```

##### æŠ€æœ¯å®ç°æ–¹æ¡ˆ

**1. æ•°æ®æ¨¡å‹**

```prisma
// å·¥ä½œæµæ¨¡æ¿
model WorkflowTemplate {
  id            String   @id @default(cuid())
  code          String   @unique  // æ¨¡æ¿ä»£ç ï¼ˆå¦‚ï¼šsupplier-approvalï¼‰
  name          String
  departmentId  String   // æ‰€å±éƒ¨é—¨ï¼ˆéƒ¨é—¨Leaderå¯åˆ›å»ºï¼‰
  steps         Json     // æ­¥éª¤é…ç½®ï¼ˆJSONæ ¼å¼ï¼‰
  version       Int      @default(1)
  status        String   @default("active")  // active/inactive
  createdById   String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  department    Department @relation(fields: [departmentId], references: [id])
  createdBy     User       @relation(fields: [createdById], references: [id])
  instances     WorkflowInstance[]

  @@index([departmentId, status])
  @@index([code])
}

// å·¥ä½œæµå®ä¾‹
model WorkflowInstance {
  id           String   @id @default(cuid())
  templateId   String
  template     WorkflowTemplate @relation(fields: [templateId], references: [id])
  documentId   String?
  document     Document? @relation(fields: [documentId], references: [id])
  currentStep  Int      @default(1)
  status       String   @default("running")  // running/completed/rejected
  initiatorId  String
  initiator    User     @relation(fields: [initiatorId], references: [id])
  startedAt    DateTime @default(now())
  completedAt  DateTime?

  tasks        WorkflowTask[]

  @@index([documentId])
  @@index([initiatorId, status])
  @@index([status, currentStep])
}

// å·¥ä½œæµä»»åŠ¡
model WorkflowTask {
  id          String   @id @default(cuid())
  instanceId  String
  instance    WorkflowInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  stepOrder   Int
  stepName    String
  assigneeId  String
  assignee    User     @relation(fields: [assigneeId], references: [id])
  status      String   @default("pending")  // pending/completed/rejected
  action      String?  // approved/rejected
  comment     String?  // å®¡æ‰¹æ„è§
  completedAt DateTime?
  createdAt   DateTime @default(now())

  // P0-4 ä¿®å¤ï¼šå®¡æ‰¹è¶…æ—¶æœºåˆ¶
  timeoutHours      Int      @default(24)  // è¶…æ—¶å°æ—¶æ•°ï¼ˆé»˜è®¤24å°æ—¶ï¼‰
  escalationUserId  String?               // è¶…æ—¶å‡çº§åˆ°çš„ç”¨æˆ·IDï¼ˆå¦‚ï¼šä¸Šçº§é¢†å¯¼ï¼‰
  escalationUser    User?    @relation("EscalationUser", fields: [escalationUserId], references: [id])
  isOverdue         Boolean  @default(false)  // æ˜¯å¦è¶…æ—¶ï¼ˆå®šæ—¶ä»»åŠ¡æ›´æ–°ï¼‰
  overdueNotifiedAt DateTime?                 // è¶…æ—¶é€šçŸ¥æ—¶é—´

  @@index([assigneeId, status])
  @@index([instanceId, stepOrder])
  @@index([isOverdue, status])  // P0-4 ç´¢å¼•ï¼šç”¨äºå®šæ—¶ä»»åŠ¡æŸ¥è¯¢è¶…æ—¶ä»»åŠ¡
}
```

**2. æ ¸å¿ƒServiceå®ç°**

```typescript
// server/src/modules/workflow/workflow.service.ts

@Injectable()
export class WorkflowService {
  // åˆ›å»ºæµç¨‹å®ä¾‹
  async createInstance(
    templateCode: string,
    documentId: string,
    initiatorId: string
  ): Promise<WorkflowInstance> {
    const template = await this.prisma.workflowTemplate.findUnique({
      where: { code: templateCode, status: 'active' }
    });

    if (!template) {
      throw new Error(`å·¥ä½œæµæ¨¡æ¿ ${templateCode} ä¸å­˜åœ¨`);
    }

    // åˆ›å»ºå®ä¾‹
    const instance = await this.prisma.workflowInstance.create({
      data: {
        templateId: template.id,
        documentId,
        initiatorId,
        currentStep: 1
      }
    });

    // åˆ›å»ºç¬¬1æ­¥ä»»åŠ¡
    const steps = template.steps as WorkflowStep[];
    await this.createTasksForStep(instance.id, steps[0]);

    // é€šçŸ¥å®¡æ‰¹äºº
    await this.notifyApprovers(instance.id, steps[0]);

    return instance;
  }

  // åˆ›å»ºä»»åŠ¡ï¼ˆæ”¯æŒå¹¶è¡Œï¼‰
  private async createTasksForStep(
    instanceId: string,
    step: WorkflowStep
  ): Promise<void> {
    if (step.type === 'approval') {
      // å•äººå®¡æ‰¹
      await this.prisma.workflowTask.create({
        data: {
          instanceId,
          stepOrder: step.order,
          stepName: step.name,
          assigneeId: step.approvers[0]
        }
      });
    } else if (step.type === 'parallel') {
      // å¹¶è¡Œä¼šç­¾ï¼ˆåˆ›å»ºå¤šä¸ªä»»åŠ¡ï¼‰
      await this.prisma.workflowTask.createMany({
        data: step.approvers.map(approverId => ({
          instanceId,
          stepOrder: step.order,
          stepName: step.name,
          assigneeId: approverId
        }))
      });
    }
  }

  // å®Œæˆä»»åŠ¡
  async completeTask(
    taskId: string,
    userId: string,
    action: 'approved' | 'rejected',
    comment?: string
  ): Promise<void> {
    // 1. æ ¡éªŒæƒé™
    const task = await this.prisma.workflowTask.findUnique({
      where: { id: taskId },
      include: { instance: { include: { template: true } } }
    });

    if (task.assigneeId !== userId) {
      throw new Error('æ— æƒå®¡æ‰¹æ­¤ä»»åŠ¡');
    }

    if (task.status !== 'pending') {
      throw new Error('ä»»åŠ¡å·²å¤„ç†');
    }

    // 2. é©³å›æ—¶æ ¡éªŒåŸå› 
    if (action === 'rejected' && (!comment || comment.length < 5)) {
      throw new Error('é©³å›åŸå› è‡³å°‘5ä¸ªå­—');
    }

    // 3. æ›´æ–°ä»»åŠ¡çŠ¶æ€
    await this.prisma.workflowTask.update({
      where: { id: taskId },
      data: {
        status: 'completed',
        action,
        comment,
        completedAt: new Date()
      }
    });

    // 4. æ£€æŸ¥å½“å‰æ­¥éª¤æ˜¯å¦å…¨éƒ¨å®Œæˆ
    const instance = task.instance;
    const currentStepTasks = await this.prisma.workflowTask.findMany({
      where: {
        instanceId: instance.id,
        stepOrder: task.stepOrder
      }
    });

    const allCompleted = currentStepTasks.every(t => t.status === 'completed');

    if (!allCompleted) {
      // è¿˜æœ‰å…¶ä»–äººæœªå®¡æ‰¹ï¼Œç­‰å¾…
      return;
    }

    // 5. æ£€æŸ¥æ˜¯å¦å…¨éƒ¨é€šè¿‡
    const allApproved = currentStepTasks.every(t => t.action === 'approved');

    if (!allApproved) {
      // ä»»ä¸€é©³å›ï¼Œæµç¨‹ç»ˆæ­¢
      await this.prisma.workflowInstance.update({
        where: { id: instance.id },
        data: {
          status: 'rejected',
          completedAt: new Date()
        }
      });

      // é€šçŸ¥å‘èµ·äºº
      await this.notifyInitiator(instance.id, 'rejected');
      return;
    }

    // 6. å…¨éƒ¨é€šè¿‡ï¼Œè¿›å…¥ä¸‹ä¸€æ­¥
    await this.moveToNextStep(instance.id);
  }

  // è¿›å…¥ä¸‹ä¸€æ­¥
  private async moveToNextStep(instanceId: string): Promise<void> {
    const instance = await this.prisma.workflowInstance.findUnique({
      where: { id: instanceId },
      include: { template: true }
    });

    const steps = instance.template.steps as WorkflowStep[];
    const nextStep = steps.find(s => s.order === instance.currentStep + 1);

    if (!nextStep) {
      // æ²¡æœ‰ä¸‹ä¸€æ­¥ï¼Œæµç¨‹å®Œæˆ
      await this.prisma.workflowInstance.update({
        where: { id: instanceId },
        data: {
          status: 'completed',
          completedAt: new Date()
        }
      });

      // æ›´æ–°æ–‡æ¡£çŠ¶æ€
      if (instance.documentId) {
        await this.prisma.document.update({
          where: { id: instance.documentId },
          data: { status: 'approved' }
        });
      }

      // é€šçŸ¥å‘èµ·äºº
      await this.notifyInitiator(instanceId, 'approved');
      return;
    }

    // æ›´æ–°å½“å‰æ­¥éª¤
    await this.prisma.workflowInstance.update({
      where: { id: instanceId },
      data: { currentStep: nextStep.order }
    });

    // åˆ›å»ºä¸‹ä¸€æ­¥ä»»åŠ¡
    await this.createTasksForStep(instanceId, nextStep);

    // é€šçŸ¥ä¸‹ä¸€æ­¥å®¡æ‰¹äºº
    await this.notifyApprovers(instanceId, nextStep);
  }
}

// ç±»å‹å®šä¹‰
interface WorkflowStep {
  order: number;
  name: string;
  type: 'approval' | 'parallel';
  approvers: string[];
  parallelMode?: 'all' | 'any';
}
```

**3. å‰ç«¯æµç¨‹å›¾å±•ç¤º**

```vue
<!-- WorkflowProgress.vue -->
<template>
  <el-card>
    <template #header>
      <span>æµç¨‹è¿›åº¦</span>
      <el-tag :type="statusType">{{ statusText }}</el-tag>
    </template>

    <!-- Vue Flowæµç¨‹å›¾ -->
    <VueFlow
      :nodes="nodes"
      :edges="edges"
      :default-zoom="1"
      :fit-view-on-init="true"
    >
      <!-- è‡ªå®šä¹‰èŠ‚ç‚¹ -->
      <template #node-step="{ data }">
        <div
          :class="[
            'workflow-node',
            data.isCurrent ? 'current' : '',
            data.status === 'completed' ? 'completed' : '',
            data.status === 'rejected' ? 'rejected' : ''
          ]"
        >
          <div class="node-header">
            <span class="step-order">{{ data.order }}</span>
            <span class="step-name">{{ data.name }}</span>
          </div>
          <div class="node-body">
            <div v-for="task in data.tasks" :key="task.id" class="task-item">
              <el-avatar :size="24" :src="task.assignee.avatar" />
              <span>{{ task.assignee.name }}</span>
              <el-tag
                v-if="task.status === 'completed'"
                :type="task.action === 'approved' ? 'success' : 'danger'"
                size="small"
              >
                {{ task.action === 'approved' ? 'é€šè¿‡' : 'é©³å›' }}
              </el-tag>
              <el-tag v-else type="info" size="small">å¾…å®¡æ‰¹</el-tag>
            </div>
          </div>
        </div>
      </template>

      <Controls />
      <Background />
    </VueFlow>
  </el-card>
</template>

<script setup lang="ts">
import { VueFlow } from '@vue-flow/core';

const nodes = computed(() => {
  return workflow.value.steps.map((step, index) => ({
    id: `step-${step.order}`,
    type: 'step',
    position: { x: index * 250, y: 100 },
    data: {
      order: step.order,
      name: step.name,
      isCurrent: step.order === workflow.value.currentStep,
      status: getStepStatus(step.order),
      tasks: getStepTasks(step.order)
    }
  }));
});

const edges = computed(() => {
  return workflow.value.steps.slice(0, -1).map((step, index) => ({
    id: `edge-${step.order}`,
    source: `step-${step.order}`,
    target: `step-${step.order + 1}`,
    type: 'smoothstep',
    animated: step.order === workflow.value.currentStep
  }));
});
</script>

<style scoped>
.workflow-node {
  padding: 16px;
  border-radius: 8px;
  background: white;
  border: 2px solid #dcdfe6;
  min-width: 200px;
}

.workflow-node.current {
  border-color: #409eff;
  box-shadow: 0 0 10px rgba(64, 158, 255, 0.3);
}

.workflow-node.completed {
  border-color: #67c23a;
  background: #f0f9ff;
}

.workflow-node.rejected {
  border-color: #f56c6c;
  background: #fef0f0;
}

.node-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid #ebeef5;
}

.step-order {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: #409eff;
  color: white;
  font-size: 12px;
  font-weight: bold;
}

.task-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px;
  background: #f5f7fa;
  border-radius: 4px;
  margin-bottom: 4px;
}
</style>
```

##### APIè®¾è®¡

```typescript
// å·¥ä½œæµæ¨¡æ¿API
POST   /workflow-templates              // åˆ›å»ºæµç¨‹æ¨¡æ¿ï¼ˆéƒ¨é—¨Leaderï¼‰
GET    /workflow-templates              // æŸ¥è¯¢æµç¨‹æ¨¡æ¿ï¼ˆæŒ‰éƒ¨é—¨è¿‡æ»¤ï¼‰
PUT    /workflow-templates/:id          // æ›´æ–°æµç¨‹æ¨¡æ¿
DELETE /workflow-templates/:id          // åˆ é™¤æµç¨‹æ¨¡æ¿

// å·¥ä½œæµå®ä¾‹API
POST   /workflow-instances              // åˆ›å»ºæµç¨‹å®ä¾‹
GET    /workflow-instances/:id          // æŸ¥è¯¢æµç¨‹å®ä¾‹è¯¦æƒ…
GET    /workflow-instances/:id/graph    // è·å–æµç¨‹å›¾æ•°æ®

// å·¥ä½œæµä»»åŠ¡API
GET    /workflow-tasks/my-tasks         // æˆ‘çš„å¾…åŠä»»åŠ¡
POST   /workflow-tasks/:id/approve      // å®¡æ‰¹ä»»åŠ¡ï¼ˆåŒæ„/é©³å›ï¼‰
GET    /workflow-tasks/:id/history      // æŸ¥è¯¢å®¡æ‰¹å†å²
```

---

#### 14.2.3 æ–‡æ¡£å†…å®¹æ ‡å‡†åŒ–

##### åŠŸèƒ½èŒƒå›´

**æ ¸å¿ƒç›®æ ‡**ï¼š
- ç»Ÿä¸€æ–‡æ¡£å†…å®¹æ ¼å¼ä¸ºTiptap JSON
- æä¾›Word/PDFå†…å®¹æå–è¾…åŠ©å·¥å…·
- æ”¯æŒå¯Œæ–‡æœ¬ç¼–è¾‘ï¼ˆæ ‡é¢˜ã€æ®µè½ã€åˆ—è¡¨ã€è¡¨æ ¼ï¼‰
- è‡ªåŠ¨ç”Ÿæˆç« èŠ‚IDï¼Œæ”¯æŒå¼•ç”¨å®šä½

**æ–‡æ¡£ä¸Šä¼ æµç¨‹**ï¼š
```
æ­¥éª¤1ï¼šç”¨æˆ·ä¸Šä¼ Word/PDFæ–‡ä»¶ï¼ˆä½œä¸ºå‚è€ƒï¼‰
  â†“
æ­¥éª¤2ï¼šç³»ç»Ÿæå–æ–‡æœ¬å†…å®¹ï¼ˆMammoth.js/PDF.jsï¼‰
  â†“
æ­¥éª¤3ï¼šç³»ç»Ÿæ™ºèƒ½åˆ†æ®µï¼ˆè¯†åˆ«æ ‡é¢˜ã€æ®µè½ã€åˆ—è¡¨ï¼‰
  â†“
æ­¥éª¤4ï¼šè½¬æ¢ä¸ºTiptap JSONæ ¼å¼
  â†“
æ­¥éª¤5ï¼šç”¨æˆ·åœ¨ç¼–è¾‘å™¨ä¸­æŸ¥çœ‹å¹¶è°ƒæ•´å†…å®¹
  â†“
æ­¥éª¤6ï¼šç”¨æˆ·æ’å…¥å¼•ç”¨Blockã€è°ƒæ•´æ ¼å¼
  â†“
æ­¥éª¤7ï¼šä¿å­˜ä¸ºæ ‡å‡†åŒ–æ–‡æ¡£
```

**å…³é”®ç‚¹**ï¼š
- ä¸Šä¼ çš„Word/PDF**ä»…ä½œä¸ºå‚è€ƒ**ï¼Œä¸ç›´æ¥å­˜å‚¨
- æœ€ç»ˆæ‰€æœ‰æ–‡æ¡£éƒ½æ˜¯Tiptap JSONæ ¼å¼
- ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨è°ƒæ•´æå–çš„å†…å®¹

##### æŠ€æœ¯å®ç°æ–¹æ¡ˆ

**1. åç«¯æ–‡ä»¶æå–æœåŠ¡**

```typescript
// server/src/modules/document/document-extract.service.ts

import mammoth from 'mammoth';  // Wordæå–
import pdf from 'pdf-parse';    // PDFæå–
import { generateJSON } from '@tiptap/core';

@Injectable()
export class DocumentExtractService {
  // æå–Wordå†…å®¹
  async extractWordContent(filePath: string): Promise<TiptapJSON> {
    const result = await mammoth.convertToHtml({ path: filePath });
    const html = result.value;

    // HTMLè½¬Tiptap JSON
    return this.htmlToTiptapJson(html);
  }

  // æå–PDFå†…å®¹
  async extractPdfContent(filePath: string): Promise<TiptapJSON> {
    const dataBuffer = fs.readFileSync(filePath);
    const data = await pdf(dataBuffer);
    const text = data.text;

    // çº¯æ–‡æœ¬è½¬Tiptap JSONï¼ˆæ™ºèƒ½åˆ†æ®µï¼‰
    return this.textToTiptapJson(text);
  }

  // çº¯æ–‡æœ¬è½¬Tiptap JSONï¼ˆæ™ºèƒ½åˆ†æ®µï¼‰
  private textToTiptapJson(text: string): TiptapJSON {
    const lines = text.split('\n');
    const content = [];

    for (const line of lines) {
      if (!line.trim()) continue;

      // å¯å‘å¼åˆ¤æ–­ï¼šæ˜¯å¦æ˜¯æ ‡é¢˜
      if (this.isHeading(line)) {
        content.push({
          type: 'heading',
          attrs: { level: this.detectHeadingLevel(line) },
          content: [{ type: 'text', text: line.trim() }]
        });
      } else {
        content.push({
          type: 'paragraph',
          content: [{ type: 'text', text: line.trim() }]
        });
      }
    }

    return { type: 'doc', content };
  }

  // åˆ¤æ–­æ˜¯å¦æ˜¯æ ‡é¢˜ï¼ˆå¯å‘å¼ï¼‰
  private isHeading(line: string): boolean {
    // è§„åˆ™1ï¼šä»¥æ•°å­—å¼€å¤´ï¼ˆå¦‚ï¼š1. ã€1.1 ï¼‰
    if (/^\d+\./.test(line.trim())) return true;

    // è§„åˆ™2ï¼šä»¥ä¸­æ–‡æ•°å­—å¼€å¤´ï¼ˆå¦‚ï¼šä¸€ã€äºŒã€ï¼‰
    if (/^[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+[ã€.]/.test(line.trim())) return true;

    // è§„åˆ™3ï¼šä»¥"ç¬¬Xç« "å¼€å¤´
    if (/^ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+ç« /.test(line.trim())) return true;

    return false;
  }

  // æ£€æµ‹æ ‡é¢˜çº§åˆ«
  private detectHeadingLevel(line: string): number {
    if (/^ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+ç« /.test(line)) return 1;  // h1
    if (/^\d+\./.test(line)) {
      const depth = line.match(/\d+/g)?.length || 1;
      return Math.min(depth + 1, 6);  // h2~h6
    }
    return 2;  // é»˜è®¤h2
  }
}
```

**2. å‰ç«¯ä¸Šä¼ ç»„ä»¶**

```vue
<!-- DocumentUploadExtract.vue -->
<template>
  <el-card>
    <template #header>
      <span>åˆ›å»ºä¸‰çº§æ–‡ä»¶</span>
    </template>

    <!-- åˆ›å»ºæ–¹å¼é€‰æ‹© -->
    <el-radio-group v-model="createMode" class="mb-4">
      <el-radio label="manual">ä»å¤´ç¼–è¾‘</el-radio>
      <el-radio label="import">å¯¼å…¥å‚è€ƒæ–‡ä»¶</el-radio>
    </el-radio-group>

    <!-- æ–¹å¼1ï¼šä»å¤´ç¼–è¾‘ -->
    <div v-if="createMode === 'manual'">
      <TiptapEditor v-model="documentContent" />
    </div>

    <!-- æ–¹å¼2ï¼šå¯¼å…¥å‚è€ƒæ–‡ä»¶ -->
    <div v-else>
      <el-upload
        :auto-upload="false"
        :on-change="handleFileChange"
        accept=".docx,.pdf"
        :limit="1"
        drag
      >
        <el-icon class="el-icon--upload"><UploadFilled /></el-icon>
        <div class="el-upload__text">
          æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œ æˆ– <em>ç‚¹å‡»ä¸Šä¼ </em>
        </div>
        <template #tip>
          <div class="el-upload__tip">
            ä»…æ”¯æŒ.docxå’Œ.pdfæ ¼å¼ï¼Œç³»ç»Ÿå°†æå–å†…å®¹ä¾›æ‚¨å‚è€ƒå’Œç¼–è¾‘
          </div>
        </template>
      </el-upload>

      <!-- æå–è¿›åº¦ -->
      <div v-if="extracting" class="mt-4">
        <el-progress :percentage="extractProgress" status="success" />
        <p class="text-center text-sm text-gray-500 mt-2">
          æ­£åœ¨æå–æ–‡æ¡£å†…å®¹...
        </p>
      </div>

      <!-- æå–ç»“æœ -->
      <el-card v-if="extractedContent" class="mt-4">
        <template #header>
          <span>æå–çš„å†…å®¹ï¼ˆå¯ç¼–è¾‘è°ƒæ•´ï¼‰</span>
          <el-button size="small" @click="resetContent">é‡æ–°ä¸Šä¼ </el-button>
        </template>

        <TiptapEditor
          v-model="documentContent"
          :initial-content="extractedContent"
        />
      </el-card>
    </div>

    <template #footer>
      <el-button @click="saveDraft">ä¿å­˜è‰ç¨¿</el-button>
      <el-button type="primary" @click="submitForApproval">
        æäº¤å®¡æ‰¹
      </el-button>
    </template>
  </el-card>
</template>

<script setup lang="ts">
const handleFileChange = async (file: UploadFile) => {
  extracting.value = true;
  extractProgress.value = 0;

  // ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨
  const formData = new FormData();
  formData.append('file', file.raw);

  try {
    extractProgress.value = 30;

    // è°ƒç”¨æå–API
    const res = await api.post('/documents/extract', formData, {
      headers: { 'Content-Type': 'multipart/form-data' }
    });

    extractProgress.value = 100;
    extractedContent.value = res.data.content;
    documentContent.value = res.data.content;

    ElMessage.success('æ–‡æ¡£å†…å®¹æå–æˆåŠŸï¼Œæ‚¨å¯ä»¥åœ¨ç¼–è¾‘å™¨ä¸­è°ƒæ•´å†…å®¹');
  } catch (error) {
    ElMessage.error('æ–‡æ¡£å†…å®¹æå–å¤±è´¥ï¼Œè¯·é‡æ–°ä¸Šä¼ ');
  } finally {
    extracting.value = false;
  }
};
</script>
```

##### APIè®¾è®¡

```typescript
POST   /documents/extract               // æå–Word/PDFå†…å®¹
```

---

### 14.3 ä¸šåŠ¡è§„åˆ™ï¼ˆBR-071 ~ BR-090ï¼‰

| è§„åˆ™ç¼–å· | è§„åˆ™æè¿° | è§„åˆ™ç±»å‹ |
|---------|----------|---------|
| **BR-071** | ä»…æ”¯æŒä¸‰çº§æ–‡ä»¶å¼•ç”¨ä¸‰çº§æ–‡ä»¶ | çº¦æŸ |
| **BR-072** | å¼•ç”¨Blockä¸å¯ç¼–è¾‘ï¼Œä½†å¯åˆ é™¤ | çº¦æŸ |
| **BR-073** | æºæ–‡æ¡£å®¡æ‰¹é€šè¿‡åï¼Œè§¦å‘å¼‚æ­¥åŒæ­¥é˜Ÿåˆ— | ä¸šåŠ¡é€»è¾‘ |
| **BR-074** | å¼•ç”¨åŒæ­¥å¤±è´¥æ—¶ï¼Œæ ‡è®°ä¸º"å¤±æ•ˆ"å¹¶é€šçŸ¥ç®¡ç†å‘˜ | ä¸šåŠ¡é€»è¾‘ |
| **BR-075** | è·¨éƒ¨é—¨å¼•ç”¨éœ€è¦æºæ–‡æ¡£æŸ¥çœ‹æƒé™ | æƒé™æ§åˆ¶ |
| **BR-076** | éƒ¨é—¨Leaderå¯åˆ›å»ºæœ¬éƒ¨é—¨å·¥ä½œæµæ¨¡æ¿ | æƒé™æ§åˆ¶ |
| **BR-077** | å·¥ä½œæµæ¨¡æ¿ä¿®æ”¹åï¼Œå·²è¿›è¡Œä¸­çš„æµç¨‹ä¸å—å½±å“ | ä¸šåŠ¡é€»è¾‘ |
| **BR-078** | å¹¶è¡Œä¼šç­¾ï¼šä»»ä¸€å®¡æ‰¹äººé©³å›ï¼Œæµç¨‹ç«‹å³ç»ˆæ­¢ | ä¸šåŠ¡é€»è¾‘ |
| **BR-079** | é©³å›åŸå› å¿…å¡«ï¼Œä¸”è‡³å°‘5ä¸ªå­— | çº¦æŸ |
| **BR-080** | åŒæ„æ—¶å®¡æ‰¹æ„è§å¯é€‰ | çº¦æŸ |
| **BR-081** | å®¡æ‰¹äººç¦»èŒ/è°ƒå²—ï¼Œä»»åŠ¡è‡ªåŠ¨è½¬ç»™ä¸Šçº§ | ä¸šåŠ¡é€»è¾‘ |
| **BR-082** | å®¡æ‰¹äººæ— ä¸Šçº§æ—¶ï¼Œä»»åŠ¡è½¬ç»™Admin | ä¸šåŠ¡é€»è¾‘ |
| **BR-083** | Document.content å­—æ®µå¿…é¡»ä¸ºTiptap JSONæ ¼å¼ | çº¦æŸ |
| **BR-084** | ç« èŠ‚IDè‡ªåŠ¨ç”Ÿæˆï¼Œæ ¼å¼ï¼šsection-{slugified-title} | ä¸šåŠ¡é€»è¾‘ |
| **BR-085** | ä¸Šä¼ çš„Word/PDFä»…ä½œä¸ºå‚è€ƒï¼Œä¸ç›´æ¥å­˜å‚¨ | ä¸šåŠ¡é€»è¾‘ |
| **BR-086** | å¼•ç”¨å…³ç³»åˆ›å»ºæ—¶ï¼Œéœ€æ ¡éªŒæºæ–‡æ¡£å’Œç›®æ ‡æ–‡æ¡£æ˜¯å¦å­˜åœ¨ | çº¦æŸ |
| **BR-087** | å¼•ç”¨å…³ç³»åˆ›å»ºæ—¶ï¼Œéœ€æ ¡éªŒç« èŠ‚IDæ˜¯å¦å­˜åœ¨ | çº¦æŸ |
| **BR-088** | åŒä¸€æºæ–‡æ¡£+ç›®æ ‡æ–‡æ¡£+ç« èŠ‚IDç»„åˆå”¯ä¸€ | çº¦æŸ |
| **BR-089** | åˆ é™¤æ–‡æ¡£æ—¶ï¼Œçº§è”åˆ é™¤ç›¸å…³å¼•ç”¨å…³ç³» | ä¸šåŠ¡é€»è¾‘ |
| **BR-090** | å·¥ä½œæµå®ä¾‹åˆ é™¤æ—¶ï¼Œçº§è”åˆ é™¤ç›¸å…³ä»»åŠ¡ | ä¸šåŠ¡é€»è¾‘ |
| **BR-091 (P0-4 ä¿®å¤)** | å®¡æ‰¹ä»»åŠ¡è¶…è¿‡24å°æ—¶æœªå¤„ç†ï¼Œæ ‡è®°ä¸ºè¶…æ—¶ï¼ˆisOverdue=trueï¼‰ | ä¸šåŠ¡é€»è¾‘ |
| **BR-092 (P0-4 ä¿®å¤)** | è¶…æ—¶ä»»åŠ¡è‡ªåŠ¨å‡çº§åˆ°ä¸Šçº§é¢†å¯¼ï¼ˆescalationUserIdï¼‰ | ä¸šåŠ¡é€»è¾‘ |
| **BR-093 (P0-4 ä¿®å¤)** | è¶…æ—¶åå‘é€é€šçŸ¥ç»™å®¡æ‰¹äººå’Œå‡çº§é¢†å¯¼ | ä¸šåŠ¡é€»è¾‘ |
| **BR-094 (P0-4 ä¿®å¤)** | å®šæ—¶ä»»åŠ¡æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡è¶…æ—¶ä»»åŠ¡ | ä¸šåŠ¡é€»è¾‘ |

---

### 14.4 æ•°æ®æ¨¡å‹æ±‡æ€»

#### æ–°å¢è¡¨

```prisma
// 1. æ–‡æ¡£å¼•ç”¨å…³ç³»è¡¨
model DocumentReference {
  id             String   @id @default(cuid())
  sourceDocId    String
  targetDocId    String
  sectionId      String
  lastSyncedAt   DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  sourceDoc      Document @relation("SourceDoc", fields: [sourceDocId], references: [id], onDelete: Cascade)
  targetDoc      Document @relation("TargetDoc", fields: [targetDocId], references: [id], onDelete: Cascade)

  @@index([sourceDocId])
  @@index([targetDocId])
  @@unique([sourceDocId, targetDocId, sectionId])
}

// 2. å·¥ä½œæµæ¨¡æ¿è¡¨
model WorkflowTemplate {
  id            String   @id @default(cuid())
  code          String   @unique
  name          String
  departmentId  String
  steps         Json
  version       Int      @default(1)
  status        String   @default("active")
  createdById   String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  department    Department @relation(fields: [departmentId], references: [id])
  createdBy     User       @relation(fields: [createdById], references: [id])
  instances     WorkflowInstance[]

  @@index([departmentId, status])
  @@index([code])
}

// 3. å·¥ä½œæµå®ä¾‹è¡¨
model WorkflowInstance {
  id           String   @id @default(cuid())
  templateId   String
  template     WorkflowTemplate @relation(fields: [templateId], references: [id])
  documentId   String?
  document     Document? @relation(fields: [documentId], references: [id])
  currentStep  Int      @default(1)
  status       String   @default("running")
  initiatorId  String
  initiator    User     @relation(fields: [initiatorId], references: [id])
  startedAt    DateTime @default(now())
  completedAt  DateTime?

  tasks        WorkflowTask[]

  @@index([documentId])
  @@index([initiatorId, status])
  @@index([status, currentStep])
}

// 4. å·¥ä½œæµä»»åŠ¡è¡¨
// 4. å·¥ä½œæµä»»åŠ¡è¡¨
model WorkflowTask {
  id          String   @id @default(cuid())
  instanceId  String
  instance    WorkflowInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  stepOrder   Int
  stepName    String
  assigneeId  String
  assignee    User     @relation(fields: [assigneeId], references: [id])
  status      String   @default("pending")
  action      String?
  comment     String?
  completedAt DateTime?
  createdAt   DateTime @default(now())

  // P0-4 ä¿®å¤ï¼šå®¡æ‰¹è¶…æ—¶æœºåˆ¶
  timeoutHours      Int      @default(24)  // è¶…æ—¶å°æ—¶æ•°ï¼ˆé»˜è®¤24å°æ—¶ï¼‰
  escalationUserId  String?               // è¶…æ—¶å‡çº§åˆ°çš„ç”¨æˆ·IDï¼ˆå¦‚ï¼šä¸Šçº§é¢†å¯¼ï¼‰
  escalationUser    User?    @relation("EscalationUser", fields: [escalationUserId], references: [id])
  isOverdue         Boolean  @default(false)  // æ˜¯å¦è¶…æ—¶ï¼ˆå®šæ—¶ä»»åŠ¡æ›´æ–°ï¼‰
  overdueNotifiedAt DateTime?                 // è¶…æ—¶é€šçŸ¥æ—¶é—´

  @@index([assigneeId, status])
  @@index([instanceId, stepOrder])
  @@index([isOverdue, status])  // P0-4 ç´¢å¼•ï¼šç”¨äºå®šæ—¶ä»»åŠ¡æŸ¥è¯¢è¶…æ—¶ä»»åŠ¡
}
```

#### æ‰©å±•è¡¨

```prisma
// æ‰©å±•Documentè¡¨
model Document {
  id      String @id @default(cuid())
  title   String
  level   String
  content Json    // âœ… æ”¹ä¸ºJsonç±»å‹ï¼ˆTiptap JSONæ ¼å¼ï¼‰
  status  String

  // æ–°å¢ï¼šå¼•ç”¨å…³ç³»
  sourceReferences   DocumentReference[] @relation("SourceDoc")
  targetReferences   DocumentReference[] @relation("TargetDoc")

  // æ–°å¢ï¼šå·¥ä½œæµå…³è”
  workflowInstance   WorkflowInstance?

  @@index([level, status])
}

// æ‰©å±•Departmentè¡¨
model Department {
  id              String @id @default(cuid())
  name            String

  // æ–°å¢ï¼šå·¥ä½œæµæ¨¡æ¿
  workflowTemplates WorkflowTemplate[]
}

// æ‰©å±•Userè¡¨
model User {
  id                String @id @default(cuid())
  username          String

  // æ–°å¢ï¼šå·¥ä½œæµç›¸å…³
  createdTemplates  WorkflowTemplate[]  @relation("CreatedTemplates")
  initiatedWorkflows WorkflowInstance[]  @relation("InitiatedWorkflows")
  assignedTasks     WorkflowTask[]
}
```

---

### 14.5 å¼€å‘é¡ºåºä¸å·¥ä½œé‡ä¼°ç®—

#### Phase 1ï¼šæ•°æ®åº“è®¾è®¡ä¸æ‰©å±•ï¼ˆ1å‘¨ï¼‰

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] Prisma Schemaè®¾è®¡ï¼ˆ4å¼ æ–°è¡¨ï¼‰
- [ ] è¿ç§»è„šæœ¬ç¼–å†™
- [ ] æœ¬åœ°ç¯å¢ƒæµ‹è¯•

**å·¥ä½œé‡**ï¼š5äººå¤©

---

#### Phase 2ï¼šç®€åŒ–å·¥ä½œæµå¼•æ“ï¼ˆ4å‘¨ï¼‰

**Week 1-2ï¼šåç«¯å¼€å‘**
- [ ] WorkflowServiceæ ¸å¿ƒé€»è¾‘ï¼ˆ2å¤©ï¼‰
- [ ] WorkflowTemplateServiceï¼ˆ1å¤©ï¼‰
- [ ] WorkflowTaskServiceï¼ˆ1å¤©ï¼‰
- [ ] å®¡æ‰¹äººå˜æ›´ç›‘å¬ï¼ˆ0.5å¤©ï¼‰
- [ ] APIæ¥å£å¼€å‘ï¼ˆ1.5å¤©ï¼‰
- [ ] å•å…ƒæµ‹è¯•ï¼ˆ1å¤©ï¼‰
- [ ] é›†æˆæµ‹è¯•ï¼ˆ1å¤©ï¼‰

**Week 3-4ï¼šå‰ç«¯å¼€å‘**
- [ ] å·¥ä½œæµæ¨¡æ¿é…ç½®é¡µï¼ˆ2å¤©ï¼‰
- [ ] å·¥ä½œæµå®ä¾‹è¯¦æƒ…é¡µï¼ˆ2å¤©ï¼‰
- [ ] Vue Flowæµç¨‹å›¾å±•ç¤ºï¼ˆ2å¤©ï¼‰
- [ ] æˆ‘çš„å¾…åŠä»»åŠ¡é¡µï¼ˆ1.5å¤©ï¼‰
- [ ] å®¡æ‰¹æ“ä½œå¯¹è¯æ¡†ï¼ˆ1.5å¤©ï¼‰
- [ ] E2Eæµ‹è¯•ï¼ˆ1å¤©ï¼‰

**å·¥ä½œé‡**ï¼š40äººå¤©

---

#### Phase 3ï¼šæ™ºèƒ½æ–‡æ¡£å¼•æ“ï¼ˆ4å‘¨ï¼‰

**Week 1-2ï¼šåç«¯å¼€å‘**
- [ ] DocumentReferenceServiceï¼ˆ2å¤©ï¼‰
- [ ] DocumentExtractServiceï¼ˆ2å¤©ï¼‰
- [ ] ç« èŠ‚è§£ææœåŠ¡ï¼ˆ1.5å¤©ï¼‰
- [ ] BullMQå¼‚æ­¥åŒæ­¥é˜Ÿåˆ—ï¼ˆ1.5å¤©ï¼‰
- [ ] APIæ¥å£å¼€å‘ï¼ˆ1å¤©ï¼‰
- [ ] å•å…ƒæµ‹è¯•ï¼ˆ1å¤©ï¼‰
- [ ] é›†æˆæµ‹è¯•ï¼ˆ1å¤©ï¼‰

**Week 3-4ï¼šå‰ç«¯å¼€å‘**
- [ ] Tiptapç¼–è¾‘å™¨é›†æˆï¼ˆ2å¤©ï¼‰
- [ ] HeadingWithIdæ‰©å±•ï¼ˆ0.5å¤©ï¼‰
- [ ] ReferenceBlockæ‰©å±•ï¼ˆ2å¤©ï¼‰
- [ ] InsertReferenceDialogç»„ä»¶ï¼ˆ2å¤©ï¼‰
- [ ] æ–‡æ¡£ä¸Šä¼ æå–ç»„ä»¶ï¼ˆ1.5å¤©ï¼‰
- [ ] Vue Flowå¼•ç”¨å…³ç³»å›¾ï¼ˆ2å¤©ï¼‰
- [ ] E2Eæµ‹è¯•ï¼ˆ1å¤©ï¼‰

**å·¥ä½œé‡**ï¼š44äººå¤©

---

#### Phase 4ï¼šç³»ç»Ÿé›†æˆä¸æµ‹è¯•ï¼ˆ2å‘¨ï¼‰

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] åºŸå¼ƒç°æœ‰Approvalç¡¬ç¼–ç é€»è¾‘ï¼ˆ2å¤©ï¼‰
- [ ] åˆ›å»ºå¯¹åº”å·¥ä½œæµæ¨¡æ¿ï¼ˆ1å¤©ï¼‰
- [ ] å†å²æ–‡æ¡£å†…å®¹æ ¼å¼æ£€æŸ¥ï¼ˆ1å¤©ï¼‰
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆ3å¤©ï¼‰
- [ ] æ€§èƒ½ä¼˜åŒ–ï¼ˆ2å¤©ï¼‰
- [ ] æ–‡æ¡£æ›´æ–°ï¼ˆ1å¤©ï¼‰

**å·¥ä½œé‡**ï¼š10äººå¤©

---

#### æ€»è®¡

**æ€»å·¥æœŸ**ï¼š11å‘¨ï¼ˆçº¦3ä¸ªæœˆï¼‰
**æ€»å·¥ä½œé‡**ï¼š99äººå¤©
**å›¢é˜Ÿé…ç½®**ï¼š
- åç«¯å¼€å‘ï¼š1äººï¼ˆå…¨èŒï¼‰
- å‰ç«¯å¼€å‘ï¼š1äººï¼ˆå…¨èŒï¼‰
- æµ‹è¯•å·¥ç¨‹å¸ˆï¼š0.5äººï¼ˆå…¼èŒï¼‰

---

### 14.6 æŠ€æœ¯é£é™©ä¸ç¼“è§£æªæ–½

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| Tiptapå­¦ä¹ æ›²çº¿é™¡å³­ | ä¸­ | é«˜ | æå‰é˜…è¯»å®˜æ–¹æ–‡æ¡£ï¼Œå‚è€ƒå¼€æºæ¡ˆä¾‹ |
| å¼•ç”¨åŒæ­¥æ€§èƒ½é—®é¢˜ | ä¸­ | ä¸­ | ä½¿ç”¨BullMQå¼‚æ­¥é˜Ÿåˆ—ï¼ŒRedisç¼“å­˜ |
| ç« èŠ‚è§£æå‡†ç¡®åº¦ä¸è¶³ | ä¸­ | ä¸­ | å¯å‘å¼è§„åˆ™ä¼˜åŒ–ï¼Œå…è®¸æ‰‹åŠ¨è°ƒæ•´ |
| å·¥ä½œæµé…ç½®é”™è¯¯ | ä¸­ | é«˜ | JSON Schemaæ ¡éªŒï¼Œæä¾›é…ç½®ç¤ºä¾‹ |
| å¹¶å‘å¼•ç”¨å†²çª | ä½ | ä¸­ | æ•°æ®åº“å”¯ä¸€çº¦æŸï¼Œä¹è§‚é” |
| å†å²æ•°æ®è¿ç§»å¤æ‚ | ä½ | ä¸­ | ä¿æŒå†å²æ•°æ®ç‹¬ç«‹ï¼Œä»…æ–°æ•°æ®ç”¨æ–°æ ¼å¼ |

---

### 14.7 æˆåŠŸæ ‡å‡†

**æ™ºèƒ½æ–‡æ¡£å¼•æ“**ï¼š
- âœ… å¯åˆ›å»ºä¸‰çº§æ–‡ä»¶é—´çš„å¼•ç”¨å…³ç³»
- âœ… æºæ–‡æ¡£ä¿®æ”¹åï¼Œå¼•ç”¨è‡ªåŠ¨åŒæ­¥
- âœ… å¼•ç”¨Blockæ¸…æ™°æ ‡è¯†ï¼Œåªè¯»ï¼Œå¯åˆ é™¤
- âœ… æ”¯æŒæ‰‹åŠ¨åˆ·æ–°å¼•ç”¨
- âœ… å¼•ç”¨å…³ç³»å›¾å¯è§†åŒ–å±•ç¤º

**ç®€åŒ–å·¥ä½œæµå¼•æ“**ï¼š
- âœ… éƒ¨é—¨Leaderå¯åˆ›å»ºæœ¬éƒ¨é—¨å·¥ä½œæµæ¨¡æ¿
- âœ… æ”¯æŒé¡ºåºå®¡æ‰¹å’Œå¹¶è¡Œä¼šç­¾
- âœ… æµç¨‹è¿›åº¦ä»¥Vue Flowæµç¨‹å›¾å±•ç¤º
- âœ… é©³å›åå¯é‡æ–°æäº¤
- âœ… å®¡æ‰¹äººå˜æ›´æ—¶ä»»åŠ¡è‡ªåŠ¨è½¬äº¤

**æ–‡æ¡£å†…å®¹æ ‡å‡†åŒ–**ï¼š
- âœ… æ‰€æœ‰æ–°æ–‡æ¡£ä½¿ç”¨Tiptap JSONæ ¼å¼
- âœ… æ”¯æŒWord/PDFå†…å®¹æå–
- âœ… ç« èŠ‚IDè‡ªåŠ¨ç”Ÿæˆ
- âœ… å¯Œæ–‡æœ¬ç¼–è¾‘ä½“éªŒè‰¯å¥½

---

### 14.8 åç»­æ‰©å±•æ–¹å‘ï¼ˆv2.1+ï¼‰

**v2.1.0ï¼šå·¥ä½œæµé«˜çº§åŠŸèƒ½**
- æ¡ä»¶åˆ†æ”¯ï¼ˆæ ¹æ®å­—æ®µå€¼é€‰æ‹©è·¯å¾„ï¼‰
- å­å·¥ä½œæµåµŒå¥—
- å¯è§†åŒ–æµç¨‹è®¾è®¡å™¨ï¼ˆæ‹–æ‹½å¼ï¼‰

**v2.2.0ï¼šæ™ºèƒ½æ–‡æ¡£é«˜çº§åŠŸèƒ½**
- å¼•ç”¨ç‰ˆæœ¬å¯¹æ¯”ï¼ˆæŸ¥çœ‹å¼•ç”¨å†…å®¹çš„å†å²å˜æ›´ï¼‰
- å¼•ç”¨å½±å“åˆ†æï¼ˆé¢„æµ‹å˜æ›´å½±å“èŒƒå›´ï¼‰
- æ‰¹é‡å¼•ç”¨æ›´æ–°ï¼ˆä¸€æ¬¡æ€§æ›´æ–°å¤šä¸ªå¼•ç”¨ï¼‰

**v2.3.0ï¼šAIå¢å¼º**
- AIæ–‡æ¡£åˆè§„é¢„æ£€ï¼ˆBRCGSæ¡æ¬¾è¦†ç›–æ£€æŸ¥ï¼‰
- AIå®¡æ‰¹æ„è§æ¨èï¼ˆåŸºäºå†å²æ•°æ®ï¼‰
- AIå†…å®¹æå–ä¼˜åŒ–ï¼ˆæå‡ç« èŠ‚è¯†åˆ«å‡†ç¡®åº¦ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**: 4.0
**æœ€åæ›´æ–°**: 2026-02-12

---

## åäº”ã€åŸ¹è®­ç®¡ç†ç³»ç»Ÿï¼ˆç‹¬ç«‹æ¨¡å— - PRD-03 æ•´åˆï¼‰â­â­ Phase C ä½“ç³»ç®¡ç†

[â¬†ï¸ è¿”å›ç›®å½•](#-å®Œæ•´ç›®å½•) | [â¬†ï¸ è¿”å›å¿«é€Ÿå¯¼èˆª](#-å¿«é€Ÿå¯¼èˆª)

> **å»ºè®®ä¸Šçº¿é¡ºåº**: Chapter 20ï¼ˆåœ¨åŠ¨æ€è¡¨å•å¼•æ“ã€æ‰¹æ¬¡è¿½æº¯ã€ç§»åŠ¨ç«¯æ¶æ„å®Œæˆåï¼‰
> **ä¼˜å…ˆçº§**: ä¸­ç­‰ï¼ˆä½“ç³»ç®¡ç†åŠŸèƒ½ï¼‰
> **ä¾èµ–**: Chapter 15ï¼ˆåŠ¨æ€è¡¨å•å¼•æ“ï¼‰ã€Chapter 17ï¼ˆç§»åŠ¨ç«¯åº”ç”¨ï¼‰

> **è®¾è®¡ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2026-02-12
> **çŠ¶æ€**: å¾…å¼€å‘
> **å…³è” PRD**: PRD-03-åŸ¹è®­ç³»ç»Ÿ.md

---

### 15.1 ç³»ç»Ÿå®šä½

#### 15.1.1 æ¨¡å—ç‰¹æ€§

**åŸ¹è®­ç³»ç»Ÿ = ç‹¬ç«‹ä¸šåŠ¡æ¨¡å—(éæ–‡æ¡£ä½“ç³»)**

```
æ–‡æ¡£ç®¡ç†ç³»ç»Ÿ(æ ¸å¿ƒ)
â”œâ”€â”€ ä¸€çº§æ–‡ä»¶(è´¨é‡æ‰‹å†Œ)
â”œâ”€â”€ äºŒçº§æ–‡ä»¶(SOP)
â”œâ”€â”€ ä¸‰çº§æ–‡ä»¶(WI)
â””â”€â”€ å››çº§æ–‡ä»¶(è®°å½•)

åŸ¹è®­ç®¡ç†ç³»ç»Ÿ(ç‹¬ç«‹æ¨¡å—) â† ä¸å±äºæ–‡æ¡£ä½“ç³»
â”œâ”€â”€ å¹´åº¦åŸ¹è®­è®¡åˆ’
â”œâ”€â”€ åŸ¹è®­é¡¹ç›®ç®¡ç†
â”œâ”€â”€ åœ¨çº¿è€ƒè¯•ç³»ç»Ÿ
â”œâ”€â”€ å­¦ä¹ è®°å½•è·Ÿè¸ª
â”œâ”€â”€ åŸ¹è®­æ¡£æ¡ˆå½’æ¡£
â””â”€â”€ ç»Ÿä¸€å¾…åŠä»»åŠ¡(TodoTask) â† æ–°å¢,è·¨æ¨¡å—å¤ç”¨
    â†“ å¼•ç”¨å…³è”
    äºŒçº§/ä¸‰çº§/å››çº§æ–‡ä»¶(ä½œä¸ºåŸ¹è®­èµ„æ–™)
```

**æ ¸å¿ƒä¼˜åŠ¿**:
- âœ… **æ¶æ„æ¸…æ™°**: åŸ¹è®­ä¸šåŠ¡ç‹¬ç«‹,ä¸æ±¡æŸ“æ–‡æ¡£ä½“ç³»
- âœ… **çµæ´»å¤ç”¨**: åŸ¹è®­èµ„æ–™å¼•ç”¨ä»»æ„çº§åˆ«æ–‡æ¡£(äºŒçº§/ä¸‰çº§/å››çº§)
- âœ… **ç»Ÿä¸€å¾…åŠ**: TodoTask æ”¯æŒåŸ¹è®­ã€å®¡æ‰¹ã€è®¾å¤‡ç»´æŠ¤ç­‰å¤šç§å¾…åŠç±»å‹
- âœ… **å¯é€‰å½’æ¡£**: åŸ¹è®­æ¡£æ¡ˆå¯é€‰æ‹©æ€§å½’æ¡£åˆ°æ–‡æ¡£ç³»ç»Ÿ
- âœ… **æ¨¡å—å¼€å…³**: å¯ä½œä¸ºå¯é€‰æ¨¡å—å¯ç”¨/ç¦ç”¨

---

### 15.2 ä¸šåŠ¡æµç¨‹

#### 15.2.1 å®Œæ•´ä¸šåŠ¡æµç¨‹

```
ã€å¹´åº¦åŸ¹è®­è®¡åˆ’ç®¡ç†ã€‘
Step 1: åˆ›å»ºå¹´åº¦åŸ¹è®­è®¡åˆ’
  â”œâ”€â”€ è¾“å…¥: å¹´åº¦ã€æ ‡é¢˜
  â”œâ”€â”€ é…ç½®åŸ¹è®­é¡¹ç›®åˆ—è¡¨
  â”‚   â”œâ”€â”€ é¡¹ç›®æ ‡é¢˜(å¦‚ "GMP åŸºç¡€åŸ¹è®­")
  â”‚   â”œâ”€â”€ éƒ¨é—¨(å¯é€‰, null = å…¨å‘˜åŸ¹è®­)
  â”‚   â”œâ”€â”€ å­£åº¦(å¯é€‰, null = ä¸´æ—¶åŸ¹è®­)
  â”‚   â”œâ”€â”€ åŸ¹è®­è®²å¸ˆ(é»˜è®¤éƒ¨é—¨ä¸»ç®¡)
  â”‚   â”œâ”€â”€ è®¡åˆ’æ—¥æœŸ
  â”‚   â”œâ”€â”€ è¢«åŸ¹è®­äººå‘˜(å¤šé€‰)
  â”‚   â”œâ”€â”€ åŸ¹è®­èµ„æ–™(å¼•ç”¨å·²æœ‰æ–‡æ¡£)
  â”‚   â””â”€â”€ è€ƒè¯•é…ç½®(åŠæ ¼åˆ†ã€è€ƒè¯•æ¬¡æ•°)
  â””â”€â”€ æäº¤å®¡æ‰¹

Step 2: åŸ¹è®­è®¡åˆ’å®¡æ‰¹(v2.0.0 å·¥ä½œæµå¼•æ“)
  â”œâ”€â”€ å‘èµ·å®¡æ‰¹æµç¨‹(WorkflowInstance)
  â”œâ”€â”€ å®¡æ‰¹äººå®¡æ‰¹(WorkflowTask)
  â””â”€â”€ å®¡æ‰¹é€šè¿‡ / é©³å›

Step 3: å®¡æ‰¹é€šè¿‡å,è‡ªåŠ¨ç”Ÿæˆå¾…åŠä»»åŠ¡(TodoTask)
  â”œâ”€â”€ åŸ¹è®­è´Ÿè´£äººå¾…åŠ:
  â”‚   â”œâ”€â”€ ç±»å‹: training_organize
  â”‚   â”œâ”€â”€ æ ‡é¢˜: "ç»„ç»‡'GMP åŸºç¡€åŸ¹è®­'(2024-Q1)"
  â”‚   â”œâ”€â”€ å…³è”: TrainingProject.id
  â”‚   â””â”€â”€ æˆªæ­¢æ—¥æœŸ: åŸ¹è®­è®¡åˆ’æ—¥æœŸ
  â”‚
  â””â”€â”€ è¢«åŸ¹è®­å‘˜å·¥å¾…åŠ:
      â”œâ”€â”€ ç±»å‹: training_attend
      â”œâ”€â”€ æ ‡é¢˜: "å‚åŠ 'GMP åŸºç¡€åŸ¹è®­'å¹¶å®Œæˆè€ƒè¯•"
      â”œâ”€â”€ å…³è”: TrainingProject.id
      â””â”€â”€ æˆªæ­¢æ—¥æœŸ: åŸ¹è®­è®¡åˆ’æ—¥æœŸ

ã€åŸ¹è®­æ‰§è¡Œã€‘
Step 4: å‘˜å·¥æŸ¥çœ‹å¾…åŠä»»åŠ¡
  â”œâ”€â”€ è¿›å…¥"æˆ‘çš„å¾…åŠ"é¡µé¢
  â”œâ”€â”€ æŸ¥çœ‹å¾…åŠç±»å‹: åŸ¹è®­ã€å®¡æ‰¹ã€è®¾å¤‡ç»´æŠ¤ç­‰
  â””â”€â”€ ç‚¹å‡»åŸ¹è®­å¾…åŠ â†’ è·³è½¬åˆ°åŸ¹è®­é¡¹ç›®è¯¦æƒ…

Step 5: å‘˜å·¥å­¦ä¹ åŸ¹è®­èµ„æ–™
  â”œâ”€â”€ æŸ¥çœ‹åŸ¹è®­é¡¹ç›®ä¿¡æ¯
  â”œâ”€â”€ ä¸‹è½½/é¢„è§ˆåŸ¹è®­èµ„æ–™(å¼•ç”¨çš„æ–‡æ¡£)
  â””â”€â”€ è‡ªä¸»å­¦ä¹ 

Step 6: å‘˜å·¥å‚åŠ åœ¨çº¿è€ƒè¯•
  â”œâ”€â”€ ç‚¹å‡»"å¼€å§‹è€ƒè¯•"
  â”œâ”€â”€ æ˜¾ç¤ºé¢˜ç›®(é€‰æ‹©é¢˜ + åˆ¤æ–­é¢˜)
  â”œâ”€â”€ æäº¤ç­”æ¡ˆ
  â”œâ”€â”€ ç³»ç»Ÿè‡ªåŠ¨è¯„åˆ†
  â””â”€â”€ æ˜¾ç¤ºè€ƒè¯•ç»“æœ
      â”œâ”€â”€ é€šè¿‡(â‰¥ åŠæ ¼åˆ†) â†’ å®ŒæˆåŸ¹è®­ â†’ å¾…åŠä»»åŠ¡æ ‡è®°ä¸º completed
      â””â”€â”€ ä¸é€šè¿‡(< åŠæ ¼åˆ†) â†’ æ˜¾ç¤ºå‰©ä½™è€ƒè¯•æ¬¡æ•° â†’ å¯é‡æ–°è€ƒè¯•

Step 7: åŸ¹è®­é¡¹ç›®å®Œæˆ(æ‰€æœ‰å­¦å‘˜è€ƒè¯•å®Œæ¯•)
  â”œâ”€â”€ ç³»ç»Ÿåˆ¤æ–­: æ‰€æœ‰ LearningRecord.passed = true
  â”œâ”€â”€ è‡ªåŠ¨ç”ŸæˆåŸ¹è®­æ¡£æ¡ˆ PDF
  â”‚   â”œâ”€â”€ åŸ¹è®­è®¡åˆ’ä¿¡æ¯
  â”‚   â”œâ”€â”€ å‚è®­äººå‘˜åå•
  â”‚   â”œâ”€â”€ è€ƒè¯•æˆç»©æ±‡æ€»
  â”‚   â””â”€â”€ åŸ¹è®­èµ„æ–™æ¸…å•
  â”œâ”€â”€ ä¸Šä¼  PDF åˆ° MinIO
  â””â”€â”€ è‡ªåŠ¨å½’æ¡£åˆ°æ–‡æ¡£ç³»ç»Ÿ(åˆ›å»ºå››çº§æ–‡ä»¶)
      â”œâ”€â”€ æ–‡æ¡£ç¼–å·: REC-TRAIN-{YYYY}-{åºå·}(è‡ªåŠ¨ç”Ÿæˆ)
      â”œâ”€â”€ æ–‡æ¡£æ ‡é¢˜: {åŸ¹è®­æ ‡é¢˜}-{æ—¥æœŸ}
      â”œâ”€â”€ æ–‡æ¡£ç±»å‹: åŸ¹è®­è®°å½•(å›ºå®š)
      â”œâ”€â”€ å½’å±éƒ¨é—¨: ç»§æ‰¿åŸ¹è®­é¡¹ç›®çš„ department
      â””â”€â”€ æ–‡ä»¶ URL: MinIO è·¯å¾„

ã€åŸ¹è®­è®¡åˆ’è°ƒæ•´ã€‘
Step 8: ä¿®æ”¹åŸ¹è®­è®¡åˆ’(å¢åˆ é¡¹ç›®)
  â”œâ”€â”€ æ–°å¢é¡¹ç›® / åˆ é™¤é¡¹ç›® / ä¿®æ”¹é¡¹ç›®
  â”œâ”€â”€ è®¡åˆ’çŠ¶æ€ â†’ pending_approval(é‡æ–°å®¡æ‰¹)
  â”œâ”€â”€ æäº¤å®¡æ‰¹
  â””â”€â”€ å®¡æ‰¹é€šè¿‡å
      â”œâ”€â”€ åˆ é™¤æ—§çš„å¾…åŠä»»åŠ¡(æ‰€æœ‰å…³è”çš„ TodoTask)
      â””â”€â”€ é‡æ–°ç”Ÿæˆå¾…åŠä»»åŠ¡(æ ¹æ®æ–°çš„é¡¹ç›®åˆ—è¡¨)

Step 9: ä¿®æ”¹å­¦å‘˜åå•(ä¸éœ€è¦å®¡æ‰¹)
  â”œâ”€â”€ æ–°å¢å­¦å‘˜ â†’ è‡ªåŠ¨ç”Ÿæˆå¾…åŠä»»åŠ¡
  â”œâ”€â”€ åˆ é™¤å­¦å‘˜ â†’ è‡ªåŠ¨åˆ é™¤å¾…åŠä»»åŠ¡
  â””â”€â”€ æ— éœ€é‡æ–°å®¡æ‰¹
```


---

### 15.3 æ•°æ®æ¨¡å‹

#### 15.3.1 ç»Ÿä¸€å¾…åŠä»»åŠ¡è¡¨(TodoTask)

**è®¾è®¡è¯´æ˜**:
- ç»Ÿä¸€çš„å¾…åŠä»»åŠ¡ç³»ç»Ÿ,æ”¯æŒå¤šç§ä¸šåŠ¡ç±»å‹
- åŸ¹è®­å¾…åŠã€å®¡æ‰¹å¾…åŠã€è®¾å¤‡å¾…åŠç­‰å…±ç”¨æ­¤è¡¨
- é€šè¿‡ `type` å­—æ®µåŒºåˆ†å¾…åŠç±»å‹
- é€šè¿‡ `relatedId` å­—æ®µå…³è”ä¸åŒä¸šåŠ¡å®ä½“

```prisma
// ========== ç»Ÿä¸€å¾…åŠä»»åŠ¡ç³»ç»Ÿ ==========

model TodoTask {
  id          String   @id @default(cuid())
  userId      String   // å¾…åŠäºº
  type        String   // å¾…åŠç±»å‹
                       // - training_organize: åŸ¹è®­è´Ÿè´£äºº - ç»„ç»‡åŸ¹è®­
                       // - training_attend: è¢«åŸ¹è®­å‘˜å·¥ - å‚åŠ åŸ¹è®­å¹¶è€ƒè¯•
                       // - approval: å®¡æ‰¹å¾…åŠ
                       // - equipment_maintain: è®¾å¤‡ç»´æŠ¤å¾…åŠ(æœªæ¥åŠŸèƒ½)
                       // - inventory: ç›˜ç‚¹å¾…åŠ(æœªæ¥åŠŸèƒ½)
                       // - change_request: å˜æ›´å¾…åŠ(æœªæ¥åŠŸèƒ½)

  relatedId   String   // å…³è”ä¸šåŠ¡ ID(æ ¹æ® type ä¸åŒ,å«ä¹‰ä¸åŒ)
                       // - training_organize/training_attend: TrainingProject.id
                       // - approval: WorkflowTask.id
                       // - equipment_maintain: EquipmentTask.id

  title       String   // å¾…åŠæ ‡é¢˜(å¦‚ "ç»„ç»‡ GMP åŸ¹è®­")
  description String?  // å¾…åŠæè¿°(å¯é€‰)
  status      String   // pending, completed
  priority    String   @default("normal") // low, normal, high, urgent
  dueDate     DateTime? // æˆªæ­¢æ—¥æœŸ
  completedAt DateTime? // å®Œæˆæ—¶é—´
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User @relation(fields: [userId], references: [id])

  @@index([userId, status])
  @@index([type, relatedId])
  @@index([status, dueDate])
}
```

**å¾…åŠç±»å‹æšä¸¾**(packages/types/todo.ts):
```typescript
export type TodoType =
  | 'training_organize'   // åŸ¹è®­è´Ÿè´£äººå¾…åŠ
  | 'training_attend'     // è¢«åŸ¹è®­å‘˜å·¥å¾…åŠ
  | 'approval'            // å®¡æ‰¹å¾…åŠ
  | 'equipment_maintain'  // è®¾å¤‡ç»´æŠ¤å¾…åŠ
  | 'inventory'           // ç›˜ç‚¹å¾…åŠ
  | 'change_request';     // å˜æ›´å¾…åŠ

export type TodoStatus = 'pending' | 'completed';
export type TodoPriority = 'low' | 'normal' | 'high' | 'urgent';
```

---

#### 15.3.2 åŸ¹è®­æ¨¡å—æ ¸å¿ƒè¡¨

```prisma
// ========== åŸ¹è®­ç®¡ç†æ¨¡å— ==========

// 1. å¹´åº¦åŸ¹è®­è®¡åˆ’
model TrainingPlan {
  id          String   @id @default(cuid())
  year        Int      // å¹´åº¦(2024)
  title       String   // "2024 å¹´åº¦å…¨å‘˜åŸ¹è®­è®¡åˆ’"
  status      String   // draft, pending_approval, approved, completed

  createdBy   String   // åˆ›å»ºäºº
  approvedBy  String?  // å®¡æ‰¹äºº

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  approvedAt  DateTime? // å®¡æ‰¹æ—¶é—´

  creator     User @relation("CreatedTrainingPlans", fields: [createdBy], references: [id])
  approver    User? @relation("ApprovedTrainingPlans", fields: [approvedBy], references: [id])
  projects    TrainingProject[]

  @@index([year, status])
  @@index([createdBy])
}

// 2. åŸ¹è®­é¡¹ç›®(å…·ä½“åŸ¹è®­è¯¾ç¨‹)
model TrainingProject {
  id              String   @id @default(cuid())
  planId          String   // æ‰€å±å¹´åº¦è®¡åˆ’

  title           String   // "GMP åŸºç¡€åŸ¹è®­"
  description     String?  // åŸ¹è®­æè¿°
  department      String?  // éƒ¨é—¨(null = å…¨å‘˜åŸ¹è®­)
  quarter         Int?     // å­£åº¦ 1-4(null = ä¸´æ—¶åŸ¹è®­)

  trainerId       String   // åŸ¹è®­è®²å¸ˆ(é»˜è®¤éƒ¨é—¨ä¸»ç®¡)
  trainees        String[] // è¢«åŸ¹è®­äººå‘˜ ID æ•°ç»„

  scheduledDate   DateTime // è®¡åˆ’åŸ¹è®­æ—¥æœŸ
  documentIds     String[] // åŸ¹è®­èµ„æ–™(å¼•ç”¨æ–‡æ¡£ ID)

  // è€ƒè¯•é…ç½®
  passingScore    Int      @default(60)  // åŠæ ¼åˆ†æ•°
  maxAttempts     Int      @default(3)   // æœ€å¤šè€ƒè¯•æ¬¡æ•°

  status          String   // planned, ongoing, completed, cancelled

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  completedAt     DateTime? // å®Œæˆæ—¶é—´(æ‰€æœ‰äººè€ƒè¯•å®Œæ¯•)

  plan            TrainingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  trainer         User @relation("TrainedProjects", fields: [trainerId], references: [id])
  questions       TrainingQuestion[]
  records         LearningRecord[]
  archive         TrainingArchive?

  @@index([planId, status])
  @@index([department, scheduledDate])
  @@index([trainerId])
}

// 3. è€ƒè¯•é¢˜ç›®
model TrainingQuestion {
  id          String   @id @default(cuid())
  projectId   String   // æ‰€å±åŸ¹è®­é¡¹ç›®

  type        String   // multiple_choice, true_false
  question    String   // é¢˜å¹²
  options     Json?    // é€‰é¡¹(ä»…é€‰æ‹©é¢˜)
                       // æ ¼å¼: ["A. é€‰é¡¹1", "B. é€‰é¡¹2", "C. é€‰é¡¹3"]
  answer      String   // æ­£ç¡®ç­”æ¡ˆ("A" æˆ– "true"/"false")
  points      Int      @default(10) // åˆ†å€¼
  order       Int      // é¢˜ç›®é¡ºåº

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     TrainingProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, order])
}

// 4. å­¦ä¹ è®°å½•
model LearningRecord {
  id          String   @id @default(cuid())
  projectId   String   // åŸ¹è®­é¡¹ç›®
  userId      String   // å­¦å‘˜

  // è€ƒè¯•ç»“æœ
  examScore   Int?     // æœ€ç»ˆè€ƒè¯•åˆ†æ•°(null = æœªè€ƒè¯•)
  attempts    Int      @default(0) // å·²è€ƒè¯•æ¬¡æ•°
  passed      Boolean  @default(false) // æ˜¯å¦é€šè¿‡

  completedAt DateTime? // å®Œæˆæ—¶é—´(é€šè¿‡è€ƒè¯•çš„æ—¶é—´)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     TrainingProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        User @relation("LearningRecords", fields: [userId], references: [id])
  examRecords ExamRecord[]

  @@unique([projectId, userId]) // ä¸€ä¸ªç”¨æˆ·ä¸€ä¸ªé¡¹ç›®åªæœ‰ä¸€æ¡è®°å½•
  @@index([userId, passed])
  @@index([projectId, passed])
}

// 5. è€ƒè¯•è®°å½•(æ”¯æŒå¤šæ¬¡è€ƒè¯•)
model ExamRecord {
  id          String   @id @default(cuid())
  recordId    String   // å­¦ä¹ è®°å½• ID

  score       Int      // æœ¬æ¬¡è€ƒè¯•åˆ†æ•°
  answers     Json     // ç­”æ¡ˆ
                       // æ ¼å¼: { "q-001": "A", "q-002": "true", ... }

  createdAt   DateTime @default(now())

  record      LearningRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)

  @@index([recordId, createdAt])
}

// 6. åŸ¹è®­æ¡£æ¡ˆ(è‡ªåŠ¨å½’æ¡£åˆ°æ–‡æ¡£ç³»ç»Ÿ)
model TrainingArchive {
  id          String   @id @default(cuid())
  projectId   String   @unique // åŸ¹è®­é¡¹ç›® ID

  pdfUrl      String   // PDF æŠ¥å‘Šå­˜å‚¨è·¯å¾„(MinIO)
  documentId  String   // å½’æ¡£åˆ°æ–‡æ¡£ç³»ç»Ÿçš„æ–‡æ¡£ ID

  createdAt   DateTime @default(now())

  project     TrainingProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  document    Document @relation(fields: [documentId], references: [id])

  @@index([documentId])
}
```

---

#### 15.3.3 User è¡¨æ‰©å±•

```prisma
model User {
  // ... ç°æœ‰å­—æ®µ ...

  // åŸ¹è®­ç›¸å…³
  createdTrainingPlans  TrainingPlan[] @relation("CreatedTrainingPlans")
  approvedTrainingPlans TrainingPlan[] @relation("ApprovedTrainingPlans")
  trainedProjects       TrainingProject[] @relation("TrainedProjects")
  learningRecords       LearningRecord[] @relation("LearningRecords")

  // å¾…åŠä»»åŠ¡
  todoTasks             TodoTask[]
}
```

---

#### 15.3.4 Document è¡¨æ‰©å±•

```prisma
model Document {
  // ... ç°æœ‰å­—æ®µ ...

  // åŸ¹è®­æ¡£æ¡ˆå½’æ¡£
  trainingArchives      TrainingArchive[]
}
```


---

### 15.4 ä¸šåŠ¡è§„åˆ™

#### 15.4.1 åŸ¹è®­è®¡åˆ’è§„åˆ™(BR-091 ~ BR-095)

**BR-091: åŸ¹è®­è®¡åˆ’å”¯ä¸€æ€§**
- æ¯å¹´åªèƒ½æœ‰ä¸€ä¸ªåŸ¹è®­è®¡åˆ’
- å¹´åº¦ + å¹´ä»½å¿…é¡»å”¯ä¸€
- è¿åè§„åˆ™è¿”å›: `409 Conflict`

**BR-092: åŸ¹è®­è®¡åˆ’å®¡æ‰¹è§„åˆ™**
- åŸ¹è®­è®¡åˆ’åˆ›å»ºå,çŠ¶æ€ä¸º `draft`
- æäº¤å®¡æ‰¹å,çŠ¶æ€å˜ä¸º `pending_approval`
- å®¡æ‰¹é€šè¿‡å,çŠ¶æ€å˜ä¸º `approved`,è‡ªåŠ¨ç”Ÿæˆå¾…åŠä»»åŠ¡
- å®¡æ‰¹é©³å›å,çŠ¶æ€å˜ä¸º `draft`,å¯é‡æ–°ä¿®æ”¹

**BR-093: åŸ¹è®­è®¡åˆ’ä¿®æ”¹è§„åˆ™**
- çŠ¶æ€ä¸º `draft` æ—¶,å¯ç›´æ¥ä¿®æ”¹
- çŠ¶æ€ä¸º `approved` æ—¶:
  - å¢åˆ åŸ¹è®­é¡¹ç›®: å¿…é¡»é‡æ–°å®¡æ‰¹(status â†’ `pending_approval`)
  - ä¿®æ”¹é¡¹ç›®ä¿¡æ¯(æ—¶é—´ã€è®²å¸ˆ): å¿…é¡»é‡æ–°å®¡æ‰¹
  - ä¿®æ”¹å­¦å‘˜åå•: æ— éœ€å®¡æ‰¹,ç›´æ¥ä¿®æ”¹,è‡ªåŠ¨åŒæ­¥å¾…åŠä»»åŠ¡

**BR-094: åŸ¹è®­é¡¹ç›®åˆ é™¤è§„åˆ™**
- çŠ¶æ€ä¸º `planned`(æœªå¼€å§‹): å¯åˆ é™¤
- çŠ¶æ€ä¸º `ongoing`(è¿›è¡Œä¸­)æˆ– `completed`(å·²å®Œæˆ): ä¸èƒ½åˆ é™¤,åªèƒ½æ ‡è®°ä¸º `cancelled`
- åˆ é™¤é¡¹ç›®æ—¶,è‡ªåŠ¨åˆ é™¤å…³è”çš„å¾…åŠä»»åŠ¡

**BR-095: åŸ¹è®­è®¡åˆ’å®Œæˆæ¡ä»¶**
- æ‰€æœ‰åŸ¹è®­é¡¹ç›®çŠ¶æ€ä¸º `completed` æˆ– `cancelled`
- æ»¡è¶³æ¡ä»¶å,è®¡åˆ’çŠ¶æ€è‡ªåŠ¨å˜ä¸º `completed`

---

#### 15.4.2 åŸ¹è®­é¡¹ç›®è§„åˆ™(BR-096 ~ BR-101)

**BR-096: åŸ¹è®­é¡¹ç›®çŠ¶æ€æµè½¬**
```
planned(å·²è®¡åˆ’)
  â†“ ç¬¬ä¸€ä¸ªå­¦å‘˜å¼€å§‹è€ƒè¯•
ongoing(è¿›è¡Œä¸­)
  â†“ æ‰€æœ‰å­¦å‘˜è€ƒè¯•å®Œæ¯•
completed(å·²å®Œæˆ)

planned â†’ cancelled(ç®¡ç†å‘˜å–æ¶ˆ)
```

**BR-097: åŸ¹è®­èµ„æ–™å¼•ç”¨è§„åˆ™**
- åªèƒ½å¼•ç”¨å·²å‘å¸ƒçš„æ–‡æ¡£(status = `published`)
- å¼•ç”¨æ–‡æ¡£çš„æœ€æ–°ç‰ˆæœ¬(ä¸æŒ‡å®šç‰ˆæœ¬å·)
- æ–‡æ¡£è¢«æ’¤é”€å,åŸ¹è®­èµ„æ–™åˆ—è¡¨æ˜¾ç¤º"âš ï¸ æ–‡æ¡£å·²æ’¤é”€"æ ‡è®°

**BR-098: åŸ¹è®­è®²å¸ˆæƒé™**
- åŸ¹è®­è®²å¸ˆ(trainerId)é»˜è®¤ä¸ºéƒ¨é—¨ä¸»ç®¡
- åŸ¹è®­è®²å¸ˆå¯ä»¥:
  - æŸ¥çœ‹åŸ¹è®­é¡¹ç›®è¯¦æƒ…
  - æŸ¥çœ‹å­¦å‘˜è€ƒè¯•ç»Ÿè®¡
  - ä¿®æ”¹å­¦å‘˜åå•(æ— éœ€å®¡æ‰¹)
- åŸ¹è®­è®²å¸ˆä¸èƒ½:
  - ä¿®æ”¹è€ƒè¯•é¢˜ç›®(éœ€é‡æ–°å®¡æ‰¹)
  - åˆ é™¤åŸ¹è®­é¡¹ç›®

**BR-099: åŸ¹è®­å­¦å‘˜é™åˆ¶**
- æ¯ä¸ªåŸ¹è®­é¡¹ç›®æœ€å°‘ 1 ä¸ªå­¦å‘˜
- æ¯ä¸ªåŸ¹è®­é¡¹ç›®æœ€å¤š 100 ä¸ªå­¦å‘˜
- å­¦å‘˜å¿…é¡»ä¸ºåœ¨èŒå‘˜å·¥(status = `active`)

**BR-100: åŸ¹è®­å–æ¶ˆè§„åˆ™**
- å–æ¶ˆåŸ¹è®­é¡¹ç›®æ—¶:
  - é¡¹ç›®çŠ¶æ€ â†’ `cancelled`
  - åˆ é™¤æ‰€æœ‰å¾…åŠä»»åŠ¡(training_organize + training_attend)
  - ä¿ç•™å·²å®Œæˆçš„å­¦ä¹ è®°å½•(LearningRecord)
  - ä¸ç”ŸæˆåŸ¹è®­æ¡£æ¡ˆ

**BR-101: åŸ¹è®­é¡¹ç›®è‡ªåŠ¨å®Œæˆ**
- å½“æ‰€æœ‰å­¦å‘˜éƒ½å®Œæˆè€ƒè¯•(LearningRecord.examScore ä¸ä¸º null)
- è‡ªåŠ¨è§¦å‘:
  - é¡¹ç›®çŠ¶æ€ â†’ `completed`
  - ç”ŸæˆåŸ¹è®­æ¡£æ¡ˆ PDF
  - å½’æ¡£åˆ°æ–‡æ¡£ç³»ç»Ÿ

---

#### 15.4.3 è€ƒè¯•è§„åˆ™(BR-102 ~ BR-107)

**BR-102: è€ƒè¯•æ¬¡æ•°é™åˆ¶**
- æ¯ä¸ªå­¦å‘˜æœ€å¤šè€ƒè¯• `maxAttempts` æ¬¡(é»˜è®¤ 3 æ¬¡)
- è¶…è¿‡æ¬¡æ•°å,ä¸èƒ½å†è€ƒè¯•
- å³ä½¿æœªé€šè¿‡,ä¹Ÿç®—å®ŒæˆåŸ¹è®­(å¾…åŠä»»åŠ¡æ ‡è®°ä¸º completed,ä½† passed = false)

**BR-103: è€ƒè¯•åŠæ ¼è§„åˆ™**
- è€ƒè¯•åˆ†æ•° â‰¥ `passingScore`(é»˜è®¤ 60 åˆ†) â†’ passed = true
- è€ƒè¯•åˆ†æ•° < `passingScore` â†’ passed = false
- é€šè¿‡è€ƒè¯•å,ä¸èƒ½å†æ¬¡è€ƒè¯•

**BR-104: è€ƒè¯•ç­”æ¡ˆéªŒè¯**
- å¿…é¡»å›ç­”æ‰€æœ‰é¢˜ç›®
- é€‰æ‹©é¢˜ç­”æ¡ˆå¿…é¡»ä¸º A/B/C/D ä¹‹ä¸€
- åˆ¤æ–­é¢˜ç­”æ¡ˆå¿…é¡»ä¸º true/false
- è¿åè§„åˆ™è¿”å›: `400 Bad Request`

**BR-105: è€ƒè¯•è‡ªåŠ¨è¯„åˆ†**
- æäº¤ç­”æ¡ˆå,ç³»ç»Ÿè‡ªåŠ¨å¯¹æ¯”æ­£ç¡®ç­”æ¡ˆ
- æ¯é¢˜ç­”å¯¹ â†’ åŠ åˆ†å€¼(points)
- æ¯é¢˜ç­”é”™ â†’ ä¸åŠ åˆ†
- æ€»åˆ† = Î£(ç­”å¯¹é¢˜ç›®çš„åˆ†å€¼)

**BR-106: è€ƒè¯•è®°å½•ä¿å­˜**
- æ¯æ¬¡è€ƒè¯•éƒ½åˆ›å»º ExamRecord è®°å½•
- ä¿å­˜ç­”æ¡ˆ(answers JSON)å’Œåˆ†æ•°(score)
- æœ€ç»ˆåˆ†æ•° = æœ€é«˜åˆ†(examScore = MAX(ExamRecord.score))

**BR-107: è€ƒè¯•é¢˜ç›®é¡ºåº**
- é¢˜ç›®æŒ‰ `order` å­—æ®µå‡åºæ’åˆ—
- æ¯æ¬¡è€ƒè¯•é¢˜ç›®é¡ºåºä¸€è‡´(ä¸éšæœº)
- å¦‚éœ€éšæœº,å‰ç«¯å¯éšæœºæ‰“ä¹±(ä¸å½±å“åç«¯è¯„åˆ†)

---

#### 15.4.4 å¾…åŠä»»åŠ¡è§„åˆ™(BR-108 ~ BR-111)

**BR-108: å¾…åŠä»»åŠ¡è‡ªåŠ¨ç”Ÿæˆ**
- åŸ¹è®­è®¡åˆ’å®¡æ‰¹é€šè¿‡å,è‡ªåŠ¨ç”Ÿæˆå¾…åŠä»»åŠ¡:
  - æ¯ä¸ªåŸ¹è®­é¡¹ç›® â†’ 1 ä¸ªåŸ¹è®­è´Ÿè´£äººå¾…åŠ(type = `training_organize`)
  - æ¯ä¸ªåŸ¹è®­é¡¹ç›® â†’ N ä¸ªå­¦å‘˜å¾…åŠ(type = `training_attend`,N = å­¦å‘˜æ•°é‡)
- å¾…åŠä»»åŠ¡çš„ `dueDate` = åŸ¹è®­é¡¹ç›®çš„ `scheduledDate`

**BR-109: å¾…åŠä»»åŠ¡è‡ªåŠ¨å®Œæˆ**
- å­¦å‘˜é€šè¿‡è€ƒè¯•å,è‡ªåŠ¨å®Œæˆå¾…åŠä»»åŠ¡(status = `completed`)
- åŸ¹è®­è´Ÿè´£äººéœ€è¦æ‰‹åŠ¨å®Œæˆå¾…åŠ(æˆ–æ‰€æœ‰å­¦å‘˜è€ƒè¯•å®Œæ¯•åè‡ªåŠ¨å®Œæˆ)

**BR-110: å¾…åŠä»»åŠ¡åˆ é™¤è§„åˆ™**
- åŸ¹è®­é¡¹ç›®å–æ¶ˆ â†’ è‡ªåŠ¨åˆ é™¤å¾…åŠä»»åŠ¡
- åŸ¹è®­è®¡åˆ’é‡æ–°å®¡æ‰¹ â†’ åˆ é™¤æ—§å¾…åŠ,ç”Ÿæˆæ–°å¾…åŠ
- å­¦å‘˜ä»åŸ¹è®­é¡¹ç›®ä¸­ç§»é™¤ â†’ åˆ é™¤è¯¥å­¦å‘˜çš„å¾…åŠä»»åŠ¡

**BR-111: å¾…åŠä»»åŠ¡é€¾æœŸæé†’**
- å¾…åŠä»»åŠ¡é€¾æœŸ(dueDate < å½“å‰æ—¥æœŸ && status = `pending`)
- ç³»ç»Ÿæ¯å¤©å®šæ—¶å‘é€é€¾æœŸæé†’(é‚®ä»¶/ç«™å†…ä¿¡)
- é€¾æœŸå¾…åŠåœ¨å¾…åŠåˆ—è¡¨ä¸­é«˜äº®æ˜¾ç¤º

---

#### 15.4.5 åŸ¹è®­æ¡£æ¡ˆè§„åˆ™(BR-112 ~ BR-115)

**BR-112: åŸ¹è®­æ¡£æ¡ˆç”Ÿæˆæ—¶æœº**
- åŸ¹è®­é¡¹ç›®çŠ¶æ€å˜ä¸º `completed` æ—¶,è‡ªåŠ¨ç”Ÿæˆ
- ç”Ÿæˆå†…å®¹:
  - åŸ¹è®­è®¡åˆ’ä¿¡æ¯(æ ‡é¢˜ã€æ—¥æœŸã€è®²å¸ˆ)
  - å‚è®­äººå‘˜åå•(å§“åã€éƒ¨é—¨ã€ç­¾åˆ°çŠ¶æ€)
  - è€ƒè¯•æˆç»©æ±‡æ€»(å§“åã€åˆ†æ•°ã€æ˜¯å¦é€šè¿‡)
  - åŸ¹è®­èµ„æ–™æ¸…å•(æ–‡æ¡£ç¼–å·ã€æ ‡é¢˜ã€çº§åˆ«)

**BR-113: åŸ¹è®­æ¡£æ¡ˆå½’æ¡£è§„åˆ™**
- ç”Ÿæˆ PDF å,è‡ªåŠ¨å½’æ¡£åˆ°æ–‡æ¡£ç³»ç»Ÿ(åˆ›å»ºå››çº§æ–‡ä»¶)
- æ–‡æ¡£ç¼–å·: `REC-TRAIN-{YYYY}-{åºå·}`(è‡ªåŠ¨ç”Ÿæˆ)
- æ–‡æ¡£æ ‡é¢˜: `{åŸ¹è®­æ ‡é¢˜}-{æ—¥æœŸ}`
- æ–‡æ¡£ç±»å‹: `training_record`(å›ºå®š)
- å½’å±éƒ¨é—¨: ç»§æ‰¿åŸ¹è®­é¡¹ç›®çš„ `department`

**BR-114: åŸ¹è®­æ¡£æ¡ˆå”¯ä¸€æ€§**
- æ¯ä¸ªåŸ¹è®­é¡¹ç›®åªèƒ½ç”Ÿæˆä¸€æ¬¡æ¡£æ¡ˆ
- é‡å¤ç”Ÿæˆè¿”å›: `409 Conflict`

**BR-115: åŸ¹è®­æ¡£æ¡ˆ PDF æ ¼å¼**
```
ã€åŸ¹è®­è®°å½•è¡¨ã€‘

åŸºæœ¬ä¿¡æ¯:
- åŸ¹è®­ä¸»é¢˜: GMP åŸºç¡€åŸ¹è®­
- åŸ¹è®­æ—¶é—´: 2024-03-15
- åŸ¹è®­è®²å¸ˆ: å¼ ä¸‰
- åŸ¹è®­éƒ¨é—¨: ç”Ÿäº§éƒ¨

åŸ¹è®­å†…å®¹:
- åŸ¹è®­èµ„æ–™æ¸…å•:
  1. [äºŒçº§] GMP-SOP-001 è½¦é—´æ¸…æ´è§„ç¨‹
  2. [ä¸‰çº§] GMP-WI-001 æ¸…æ´å‰‚ä½¿ç”¨æŒ‡å—

å‚è®­äººå‘˜åŠè€ƒæ ¸:
| å§“å | éƒ¨é—¨ | è€ƒè¯•æˆç»© | æ˜¯å¦é€šè¿‡ | è€ƒè¯•æ—¶é—´ |
|------|------|----------|----------|----------|
| æå›› | ç”Ÿäº§éƒ¨ | 85 | é€šè¿‡ | 2024-03-15 14:30 |
| ç‹äº” | ç”Ÿäº§éƒ¨ | 75 | é€šè¿‡ | 2024-03-15 15:00 |

åŸ¹è®­æ•ˆæœè¯„ä¼°:
- æ€»å‚è®­äººæ•°: 10
- è€ƒè¯•é€šè¿‡ç‡: 90%
- å¹³å‡åˆ†: 80

ç”Ÿæˆæ—¶é—´: 2024-03-20 10:00:00
```


---

### 15.5 å¼€å‘å·¥ä½œé‡ä¼°ç®—

#### 15.5.1 åç«¯å¼€å‘(10-12 å¤©)

| æ¨¡å— | å·¥ä½œå†…å®¹ | å·¥ä½œé‡ |
|------|----------|--------|
| **ç»Ÿä¸€å¾…åŠä»»åŠ¡** | TodoTask è¡¨è®¾è®¡ã€API å¼€å‘ | 1.5 å¤© |
| **åŸ¹è®­è®¡åˆ’ç®¡ç†** | TrainingPlan CRUDã€å®¡æ‰¹é›†æˆ | 2 å¤© |
| **åŸ¹è®­é¡¹ç›®ç®¡ç†** | TrainingProject CRUDã€å­¦å‘˜ç®¡ç† | 2 å¤© |
| **åœ¨çº¿è€ƒè¯•** | Question è¡¨ã€ç­”é¢˜é€»è¾‘ã€è‡ªåŠ¨è¯„åˆ† | 2.5 å¤© |
| **å­¦ä¹ è®°å½•** | LearningRecordã€ExamRecord ç®¡ç† | 1 å¤© |
| **åŸ¹è®­æ¡£æ¡ˆ** | PDF ç”Ÿæˆã€è‡ªåŠ¨å½’æ¡£ | 2 å¤© |
| **å·¥ä½œæµé›†æˆ** | å®¡æ‰¹å›è°ƒã€å¾…åŠä»»åŠ¡ç”Ÿæˆ | 1 å¤© |
| **å•å…ƒæµ‹è¯•** | æ ¸å¿ƒé€»è¾‘æµ‹è¯• | 1.5 å¤© |

**å°è®¡: 13.5 å¤© â†’ é¢„ç•™ç¼“å†² â†’ 15 å¤©**

---

#### 15.5.2 å‰ç«¯å¼€å‘(12-14 å¤©)

| æ¨¡å— | å·¥ä½œå†…å®¹ | å·¥ä½œé‡ |
|------|----------|--------|
| **æˆ‘çš„å¾…åŠ** | TodoList.vue(ç»Ÿä¸€å¾…åŠä¸­å¿ƒ) | 2 å¤© |
| **åŸ¹è®­è®¡åˆ’** | TrainingPlanList.vueã€TrainingPlanDetail.vue | 2.5 å¤© |
| **åŸ¹è®­é¡¹ç›®** | TrainingProjectDetail.vue | 2 å¤© |
| **åœ¨çº¿è€ƒè¯•** | OnlineExam.vue(ç­”é¢˜ç•Œé¢ã€ç»“æœå±•ç¤º) | 3 å¤© |
| **åŸ¹è®­æ¡£æ¡ˆ** | TrainingArchiveList.vue | 1.5 å¤© |
| **çŠ¶æ€ç®¡ç†** | Pinia store(åŸ¹è®­æ¨¡å—) | 1 å¤© |
| **ç±»å‹å®šä¹‰** | packages/types(åŸ¹è®­ç›¸å…³ç±»å‹) | 0.5 å¤© |
| **E2E æµ‹è¯•** | Playwright æµ‹è¯•(æ ¸å¿ƒæµç¨‹) | 2 å¤© |

**å°è®¡: 14.5 å¤© â†’ é¢„ç•™ç¼“å†² â†’ 16 å¤©**

---

#### 15.5.3 æ€»å·¥ä½œé‡

| é˜¶æ®µ | å·¥ä½œé‡ | è¯´æ˜ |
|------|--------|------|
| **åç«¯å¼€å‘** | 15 å¤© | åŒ…å«å•å…ƒæµ‹è¯• |
| **å‰ç«¯å¼€å‘** | 16 å¤© | åŒ…å« E2E æµ‹è¯• |
| **è”è°ƒæµ‹è¯•** | 2 å¤© | å‰åç«¯è”è°ƒ |
| **æ–‡æ¡£ç¼–å†™** | 1 å¤© | API æ–‡æ¡£ã€ç”¨æˆ·æ‰‹å†Œ |

**æ€»è®¡: 34 å¤©(çº¦ 7 å‘¨)**

**å¹¶è¡Œå¼€å‘**(1 ååç«¯ + 1 åå‰ç«¯): **çº¦ 4-5 å‘¨**

---

### 15.6 ä¾èµ–ä¸é£é™©

#### 15.6.1 æŠ€æœ¯ä¾èµ–

| ä¾èµ–é¡¹ | ç‰ˆæœ¬ | ç”¨é€” | é£é™©ç­‰çº§ |
|--------|------|------|----------|
| **v2.0.0 å·¥ä½œæµå¼•æ“** | å¾…å¼€å‘ | åŸ¹è®­è®¡åˆ’å®¡æ‰¹ | é«˜ |
| **æ–‡æ¡£ç³»ç»Ÿ** | å·²å®Œæˆ | åŸ¹è®­èµ„æ–™å¼•ç”¨ã€æ¡£æ¡ˆå½’æ¡£ | ä½ |
| **MinIO** | å·²éƒ¨ç½² | åŸ¹è®­æ¡£æ¡ˆ PDF å­˜å‚¨ | ä½ |
| **PDF ç”Ÿæˆåº“** | pdfmake | ç”ŸæˆåŸ¹è®­æ¡£æ¡ˆ PDF | ä¸­ |

**å…³é”®ä¾èµ–**:
- âš ï¸ **v2.0.0 å·¥ä½œæµå¼•æ“å¿…é¡»å…ˆå®Œæˆ**(åŸ¹è®­è®¡åˆ’å®¡æ‰¹ä¾èµ–å·¥ä½œæµ)
- âœ… æ–‡æ¡£ç³»ç»Ÿã€MinIO å·²å°±ç»ª

---

#### 15.6.2 ä¸šåŠ¡é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| **åŸ¹è®­è®¡åˆ’é¢‘ç¹ä¿®æ”¹** | å¾…åŠä»»åŠ¡å¤§é‡å˜åŠ¨ | ä¸­ | é‡å¤§è°ƒæ•´éœ€é‡æ–°å®¡æ‰¹,å¾®è°ƒç›´æ¥ä¿®æ”¹ |
| **è€ƒè¯•ä½œå¼Š** | è€ƒè¯•ç»“æœä¸å¯ä¿¡ | ä¸­ | MVP ä¸é˜²ä½œå¼Š,v2.0 å¢åŠ é˜²ä½œå¼Š(é™æ—¶ã€æ‰“ä¹±é¢˜ç›®) |
| **åŸ¹è®­æ¡£æ¡ˆ PDF ç”Ÿæˆå¤±è´¥** | æ¡£æ¡ˆæ— æ³•å½’æ¡£ | ä½ | å¼‚æ­¥ç”Ÿæˆ,å¤±è´¥é‡è¯•,è®°å½•é”™è¯¯æ—¥å¿— |
| **å¾…åŠä»»åŠ¡è¿‡å¤š** | ç”¨æˆ·ä½“éªŒå·® | ä¸­ | æ”¯æŒç­›é€‰ã€åˆ†é¡µã€é€¾æœŸé«˜äº® |

---

### 15.7 åç»­æ‰©å±•æ–¹å‘(v1.1+)

#### v1.1.0: è€ƒè¯•å¢å¼º
- âœ… è€ƒè¯•é˜²ä½œå¼Š(é™æ—¶ã€é¢˜ç›®éšæœºæ‰“ä¹±)
- âœ… è€ƒè¯•é¢˜åº“ç®¡ç†(é¢˜åº“åˆ†ç±»ã€é¢˜ç›®å¤ç”¨)
- âœ… è€ƒè¯•ç­”æ¡ˆè§£æ(é”™é¢˜æŸ¥çœ‹è§£æ)

#### v1.2.0: åŸ¹è®­æ•ˆæœè¯„ä¼°
- âœ… åŸ¹è®­æ»¡æ„åº¦é—®å·(å­¦å‘˜åé¦ˆ)
- âœ… åŸ¹è®­æ•ˆæœç»Ÿè®¡(é€šè¿‡ç‡ã€å¹³å‡åˆ†ã€éƒ¨é—¨å¯¹æ¯”)
- âœ… åŸ¹è®­ KPI ä»ªè¡¨ç›˜

#### v1.3.0: åŸ¹è®­èµ„è´¨è”åŠ¨(å¯é€‰,ä¾èµ– PRD-02)
- âœ… èµ„è´¨åˆ°æœŸæ¨èç›¸å…³åŸ¹è®­
- âœ… åŸ¹è®­å®Œæˆè‡ªåŠ¨æ›´æ–°èµ„è´¨è®°å½•

#### v2.0.0: è§†é¢‘åŸ¹è®­
- âœ… æ”¯æŒä¸Šä¼ åŸ¹è®­è§†é¢‘(MinIO)
- âœ… è§†é¢‘å­¦ä¹ è¿›åº¦è·Ÿè¸ª
- âœ… è§†é¢‘å­¦ä¹ æ—¶é•¿ç»Ÿè®¡

---

### 15.8 æˆåŠŸæ ‡å‡†

**åŸ¹è®­è®¡åˆ’ç®¡ç†**:
- âœ… å¯åˆ›å»ºå¹´åº¦åŸ¹è®­è®¡åˆ’,åŒ…å«å¤šä¸ªåŸ¹è®­é¡¹ç›®
- âœ… åŸ¹è®­è®¡åˆ’æ”¯æŒå®¡æ‰¹æµç¨‹(v2.0.0 å·¥ä½œæµå¼•æ“)
- âœ… å®¡æ‰¹é€šè¿‡å,è‡ªåŠ¨ç”Ÿæˆå¾…åŠä»»åŠ¡

**åœ¨çº¿è€ƒè¯•**:
- âœ… æ”¯æŒé€‰æ‹©é¢˜ã€åˆ¤æ–­é¢˜
- âœ… æäº¤ç­”æ¡ˆå,ç³»ç»Ÿè‡ªåŠ¨è¯„åˆ†
- âœ… è€ƒè¯•é€šè¿‡å,è‡ªåŠ¨å®Œæˆå¾…åŠä»»åŠ¡

**åŸ¹è®­æ¡£æ¡ˆ**:
- âœ… åŸ¹è®­å®Œæˆå,è‡ªåŠ¨ç”Ÿæˆ PDF æ¡£æ¡ˆ
- âœ… æ¡£æ¡ˆè‡ªåŠ¨å½’æ¡£åˆ°æ–‡æ¡£ç³»ç»Ÿ(åˆ›å»ºå››çº§æ–‡ä»¶)
- âœ… æ¡£æ¡ˆåŒ…å«åŸ¹è®­ä¿¡æ¯ã€å‚è®­äººå‘˜ã€è€ƒè¯•æˆç»©

**ç»Ÿä¸€å¾…åŠ**:
- âœ… æ”¯æŒå¤šç§å¾…åŠç±»å‹(åŸ¹è®­ã€å®¡æ‰¹ã€è®¾å¤‡ç»´æŠ¤ç­‰)
- âœ… å¾…åŠåˆ—è¡¨æ”¯æŒç­›é€‰ã€åˆ†é¡µ
- âœ… é€¾æœŸå¾…åŠé«˜äº®æ˜¾ç¤º

---

**æœ¬ç« èŠ‚å®Œæˆ âœ…**


---

## åå…­ã€å†…å®¡ç®¡ç†ç³»ç»Ÿï¼ˆç‹¬ç«‹æ¨¡å— - PRD-04 ç®€åŒ–æ•´åˆï¼‰â­â­ Phase C ä½“ç³»ç®¡ç†

[â¬†ï¸ è¿”å›ç›®å½•](#-å®Œæ•´ç›®å½•) | [â¬†ï¸ è¿”å›å¿«é€Ÿå¯¼èˆª](#-å¿«é€Ÿå¯¼èˆª)

> **å»ºè®®ä¸Šçº¿é¡ºåº**: Chapter 21ï¼ˆåœ¨åŠ¨æ€è¡¨å•å¼•æ“ã€æ‰¹æ¬¡è¿½æº¯ã€ç§»åŠ¨ç«¯æ¶æ„å®Œæˆåï¼‰
> **ä¼˜å…ˆçº§**: ä¸­ç­‰ï¼ˆä½“ç³»ç®¡ç†åŠŸèƒ½ï¼‰
> **ä¾èµ–**: Chapter 15ï¼ˆåŠ¨æ€è¡¨å•å¼•æ“ï¼‰ã€Chapter 17ï¼ˆç§»åŠ¨ç«¯åº”ç”¨ï¼‰

> **è®¾è®¡ç‰ˆæœ¬**: v1.0
> **æœ€åæ›´æ–°**: 2026-02-12
> **çŠ¶æ€**: å¾…å¼€å‘
> **å…³è” PRD**: PRD-04-å†…å®¡ç®¡ç†.mdï¼ˆç®€åŒ–ç‰ˆï¼‰

---

### 16.1 ç³»ç»Ÿå®šä½

#### 16.1.1 æ¨¡å—ç‰¹æ€§

**å†…å®¡ç³»ç»Ÿ = ç‹¬ç«‹ä¸šåŠ¡æ¨¡å—(ç®€åŒ–ç‰ˆ)**

```
æ–‡æ¡£ç®¡ç†ç³»ç»Ÿ(æ ¸å¿ƒ)
â”œâ”€â”€ ä¸€çº§æ–‡ä»¶(è´¨é‡æ‰‹å†Œ)
â”œâ”€â”€ äºŒçº§æ–‡ä»¶(SOP)
â”œâ”€â”€ ä¸‰çº§æ–‡ä»¶(WI)
â””â”€â”€ å››çº§æ–‡ä»¶(è®°å½•)

å†…å®¡ç®¡ç†ç³»ç»Ÿ(ç‹¬ç«‹æ¨¡å—) â† ç®€åŒ–è®¾è®¡
â”œâ”€â”€ å†…å®¡è®¡åˆ’ç®¡ç†
â”‚   â”œâ”€â”€ åˆ›å»ºè®¡åˆ’(å­£åº¦/åŠå¹´/å¹´åº¦)
â”‚   â”œâ”€â”€ å‹¾é€‰å®¡æ ¸æ–‡æ¡£(æŒ‰çº§åˆ«/éƒ¨é—¨)
â”‚   â””â”€â”€ å¤åˆ¶å†å²è®¡åˆ’(é‡å¤åˆ©ç”¨)
â”œâ”€â”€ å®¡æ ¸æ‰§è¡Œ
â”‚   â”œâ”€â”€ é€ä¸ªå®¡æ ¸æ–‡æ¡£
â”‚   â”œâ”€â”€ è®°å½•å®¡æ ¸ç»“æœ(ç¬¦åˆ/ä¸ç¬¦åˆ)
â”‚   â””â”€â”€ è®°å½•ä¸ç¬¦åˆé¡¹(é—®é¢˜ç±»å‹ã€è´£ä»»äºº)
â”œâ”€â”€ æ•´æ”¹è·Ÿè¸ª
â”‚   â”œâ”€â”€ è‡ªåŠ¨ç”Ÿæˆæ•´æ”¹å¾…åŠ(TodoTask)
â”‚   â”œâ”€â”€ è´£ä»»äººæäº¤æ•´æ”¹
â”‚   â””â”€â”€ å†…å®¡å‘˜å¤å®¡éªŒè¯
â””â”€â”€ å†…å®¡æŠ¥å‘Šå½’æ¡£
    â”œâ”€â”€ è‡ªåŠ¨ç”Ÿæˆ PDF æŠ¥å‘Š
    â””â”€â”€ å½’æ¡£åˆ°æ–‡æ¡£ç³»ç»Ÿ(å››çº§æ–‡ä»¶)
    â†“ å…³è”
    ç°æœ‰æ–‡æ¡£ç³»ç»Ÿ(ä¸€çº§/äºŒçº§/ä¸‰çº§/å››çº§æ–‡ä»¶)
```

**æ ¸å¿ƒä¼˜åŠ¿**:
- âœ… **æ¶æ„ç®€åŒ–**: ä¸åšæ¡æ¬¾åŒ¹é…,ä¸åšæ£€æŸ¥è¡¨è‡ªåŠ¨ç”Ÿæˆ,ä¸åšç§»åŠ¨ç«¯
- âœ… **çµæ´»å¤ç”¨**: æ”¯æŒå¤åˆ¶å†å²å†…å®¡è®¡åˆ’,å­£åº¦/åŠå¹´/å¹´åº¦è®¡åˆ’å¯é‡å¤åˆ©ç”¨
- âœ… **æµç¨‹æ¸…æ™°**: åˆ›å»ºè®¡åˆ’ â†’ å¯åŠ¨å®¡æ ¸ â†’ è®°å½•å‘ç° â†’ ç”Ÿæˆå¾…åŠ â†’ æ•´æ”¹å¤å®¡ â†’ å½’æ¡£æŠ¥å‘Š
- âœ… **ç»Ÿä¸€å¾…åŠ**: å¤ç”¨ TodoTask ç³»ç»Ÿ,æ•´æ”¹ä»»åŠ¡ç»Ÿä¸€ç®¡ç†
- âœ… **è‡ªåŠ¨å½’æ¡£**: å†…å®¡æŠ¥å‘Šè‡ªåŠ¨ç”Ÿæˆ PDF å¹¶å½’æ¡£åˆ°æ–‡æ¡£ç³»ç»Ÿ

---

### 16.2 ä¸šåŠ¡æµç¨‹

#### 16.2.1 å®Œæ•´ä¸šåŠ¡æµç¨‹

```
ã€å†…å®¡è®¡åˆ’ç®¡ç†ã€‘
Step 1: åˆ›å»ºå†…å®¡è®¡åˆ’
  â”œâ”€â”€ è¾“å…¥åŸºæœ¬ä¿¡æ¯
  â”‚   â”œâ”€â”€ æ ‡é¢˜: "2024-Q1 å†…å®¡"
  â”‚   â”œâ”€â”€ ç±»å‹: å­£åº¦/åŠå¹´/å¹´åº¦
  â”‚   â”œâ”€â”€ å®¡æ ¸æ—¶é—´: 2024-03-01 ~ 2024-03-31
  â”‚   â””â”€â”€ å†…å®¡å‘˜: å¼ ä¸‰
  â”œâ”€â”€ å‹¾é€‰å®¡æ ¸æ–‡æ¡£
  â”‚   â”œâ”€â”€ æŒ‰æ–‡æ¡£çº§åˆ«ç­›é€‰(ä¸€çº§/äºŒçº§/ä¸‰çº§/å››çº§)
  â”‚   â”œâ”€â”€ æŒ‰éƒ¨é—¨ç­›é€‰(ç”Ÿäº§éƒ¨/è´¨é‡éƒ¨/...)
  â”‚   â””â”€â”€ æ‰¹é‡å‹¾é€‰æ–‡æ¡£(å¦‚: å‹¾é€‰æ‰€æœ‰äºŒçº§æ–‡ä»¶)
  â””â”€â”€ ä¿å­˜è®¡åˆ’(çŠ¶æ€: draft, å¯éšæ—¶å¯åŠ¨)

Step 1.5: å¤åˆ¶å†å²å†…å®¡è®¡åˆ’(å¯é€‰)
  â”œâ”€â”€ é€‰æ‹©å†å²è®¡åˆ’(å¦‚ "2023-Q4 å†…å®¡")
  â”œâ”€â”€ ç‚¹å‡»"å¤åˆ¶"æŒ‰é’®
  â”œâ”€â”€ ç³»ç»Ÿè‡ªåŠ¨å¤åˆ¶
  â”‚   â”œâ”€â”€ æ–‡æ¡£åˆ—è¡¨(documentIds)
  â”‚   â”œâ”€â”€ è®¡åˆ’ç±»å‹
  â”‚   â””â”€â”€ åŸºæœ¬é…ç½®
  â”œâ”€â”€ ä¿®æ”¹å†…å®¹
  â”‚   â”œâ”€â”€ æ ‡é¢˜ â†’ "2024-Q1 å†…å®¡"
  â”‚   â”œâ”€â”€ å®¡æ ¸æ—¶é—´ â†’ 2024-03-01 ~ 2024-03-31
  â”‚   â””â”€â”€ å†…å®¡å‘˜ â†’ æå››
  â””â”€â”€ ä¿å­˜æ–°è®¡åˆ’

ã€å®¡æ ¸æ‰§è¡Œã€‘
Step 2: å¯åŠ¨å†…å®¡è®¡åˆ’
  â”œâ”€â”€ ç‚¹å‡»"å¯åŠ¨å†…å®¡"æŒ‰é’®
  â”œâ”€â”€ çŠ¶æ€å˜æ›´: draft â†’ ongoing
  â””â”€â”€ è¿›å…¥å®¡æ ¸é¡µé¢(ä¸ç”Ÿæˆå¾…åŠä»»åŠ¡)

Step 3: å†…å®¡å‘˜é€ä¸ªå®¡æ ¸æ–‡æ¡£
  â”œâ”€â”€ æŸ¥çœ‹æ–‡æ¡£åˆ—è¡¨(å·²å‹¾é€‰çš„ 50 ä¸ªæ–‡æ¡£)
  â”œâ”€â”€ å®¡æ ¸è¿›åº¦æ˜¾ç¤º: "å·²å®¡æ ¸ 0/50"
  â”œâ”€â”€ é€ä¸ªå®¡æ ¸:
  â”‚   â”œâ”€â”€ ç‚¹å‡»"å®¡æ ¸" doc-001
  â”‚   â”œâ”€â”€ æŸ¥çœ‹æ–‡æ¡£å†…å®¹(é¢„è§ˆ/ä¸‹è½½)
  â”‚   â”œâ”€â”€ å¡«å†™å®¡æ ¸ç»“æœ:
  â”‚   â”‚   â”œâ”€â”€ å®¡æ ¸ç»“æœ: [ç¬¦åˆ] [ä¸ç¬¦åˆ] â† å•é€‰
  â”‚   â”‚   â”œâ”€â”€ å¦‚æœé€‰"ä¸ç¬¦åˆ" â†’ æ˜¾ç¤ºé—®é¢˜å¡«å†™åŒºåŸŸ:
  â”‚   â”‚   â”‚   â”œâ”€â”€ é—®é¢˜ç±»å‹: [éœ€è¦ä¿®æ”¹] [ç¼ºå¤±è®°å½•] [æ–‡æ¡£ç¼ºå¤±]
  â”‚   â”‚   â”‚   â”œâ”€â”€ é—®é¢˜æè¿°: [æ–‡æœ¬æ¡†, å¿…å¡«]
  â”‚   â”‚   â”‚   â”œâ”€â”€ è´£ä»»éƒ¨é—¨: [ä¸‹æ‹‰é€‰æ‹©]
  â”‚   â”‚   â”‚   â”œâ”€â”€ è´£ä»»äºº: [ä¸‹æ‹‰é€‰æ‹©]
  â”‚   â”‚   â”‚   â””â”€â”€ æ•´æ”¹æœŸé™: è‡ªåŠ¨è®¡ç®—(å®¡æ ¸æ—¥æœŸ + 30 å¤©)
  â”‚   â”‚   â””â”€â”€ å¦‚æœé€‰"ç¬¦åˆ" â†’ æ— éœ€å¡«å†™å…¶ä»–ä¿¡æ¯
  â”‚   â”œâ”€â”€ ç‚¹å‡»"ä¿å­˜" â†’ ç”Ÿæˆ AuditFinding è®°å½•
  â”‚   â””â”€â”€ å®¡æ ¸è¿›åº¦æ›´æ–°: "å·²å®¡æ ¸ 1/50"
  â”‚
  â”œâ”€â”€ ç»§ç»­å®¡æ ¸ä¸‹ä¸€ä¸ªæ–‡æ¡£...
  â””â”€â”€ æ‰€æœ‰æ–‡æ¡£å®¡æ ¸å®Œæ¯• â†’ å®¡æ ¸è¿›åº¦: "å·²å®¡æ ¸ 50/50"

Step 4: æäº¤å®¡æ ¸æŠ¥å‘Š
  â”œâ”€â”€ ç³»ç»Ÿæ˜¾ç¤ºå®¡æ ¸æ±‡æ€»:
  â”‚   â”œâ”€â”€ å®¡æ ¸æ–‡æ¡£æ€»æ•°: 50
  â”‚   â”œâ”€â”€ ç¬¦åˆ: 45
  â”‚   â”œâ”€â”€ ä¸ç¬¦åˆ: 5
  â”‚   â””â”€â”€ ä¸ç¬¦åˆé¡¹æ¸…å•: [doc-003, doc-010, doc-015, doc-020, doc-025]
  â”œâ”€â”€ å†…å®¡å‘˜ç¡®è®¤å®¡æ ¸ç»“æœ
  â””â”€â”€ ç‚¹å‡»"æäº¤å®¡æ ¸æŠ¥å‘Š"

ã€æ•´æ”¹è·Ÿè¸ªã€‘
Step 5: ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆæ•´æ”¹å¾…åŠ
  â”œâ”€â”€ å†…å®¡è®¡åˆ’çŠ¶æ€: ongoing â†’ pending_rectification
  â”œâ”€â”€ è‡ªåŠ¨ç”Ÿæˆæ•´æ”¹å¾…åŠä»»åŠ¡(TodoTask):
  â”‚   â”œâ”€â”€ å¾…åŠ 1:
  â”‚   â”‚   â”œâ”€â”€ ç±»å‹: audit_rectification
  â”‚   â”‚   â”œâ”€â”€ å…³è”: AuditFinding ID
  â”‚   â”‚   â”œâ”€â”€ è´£ä»»äºº: æå››(ç”Ÿäº§éƒ¨)
  â”‚   â”‚   â”œâ”€â”€ æ ‡é¢˜: "æ•´æ”¹'GMP-SOP-001'å®¡æ ¸å‘ç°"
  â”‚   â”‚   â”œâ”€â”€ æè¿°: "ç¬¬ 3.2 èŠ‚æ¸…æ´é¢‘æ¬¡æè¿°ä¸æ¸…"
  â”‚   â”‚   â””â”€â”€ æˆªæ­¢æ—¥æœŸ: 2024-04-15(å®¡æ ¸æ—¥æœŸ + 30 å¤©)
  â”‚   â”œâ”€â”€ å¾…åŠ 2: æ•´æ”¹ GMP-WI-001 å®¡æ ¸å‘ç°(è´£ä»»äºº: ç‹äº”)
  â”‚   â””â”€â”€ ... (å…± 5 ä¸ªå¾…åŠ, åªé’ˆå¯¹"ä¸ç¬¦åˆ"é¡¹)
  â”œâ”€â”€ ä¸ç¬¦åˆé¡¹çŠ¶æ€: pending â†’ rectifying
  â””â”€â”€ å‘é€é€šçŸ¥ç»™è´£ä»»äºº

Step 6: è´£ä»»äººæ•´æ”¹
  â”œâ”€â”€ è´£ä»»äººæ”¶åˆ°å¾…åŠä»»åŠ¡
  â”œâ”€â”€ è¿›å…¥"æˆ‘çš„å¾…åŠ"æŸ¥çœ‹è¯¦æƒ…
  â”œâ”€â”€ ç‚¹å‡»å¾…åŠ â†’ æŸ¥çœ‹ä¸ç¬¦åˆé¡¹ä¿¡æ¯:
  â”‚   â”œâ”€â”€ æ–‡æ¡£: GMP-SOP-001 è½¦é—´æ¸…æ´è§„ç¨‹
  â”‚   â”œâ”€â”€ é—®é¢˜ç±»å‹: éœ€è¦ä¿®æ”¹
  â”‚   â”œâ”€â”€ é—®é¢˜æè¿°: ç¬¬ 3.2 èŠ‚æ¸…æ´é¢‘æ¬¡æè¿°ä¸æ¸…
  â”‚   â””â”€â”€ æ•´æ”¹æœŸé™: 2024-04-15
  â”œâ”€â”€ æ•´æ”¹æ–‡æ¡£:
  â”‚   â”œâ”€â”€ åœºæ™¯ 1: éœ€è¦ä¿®æ”¹ â†’ ä¿®æ”¹æ–‡æ¡£ â†’ æäº¤å®¡æ‰¹ â†’ ç”Ÿæˆæ–°ç‰ˆæœ¬ v2.0
  â”‚   â”œâ”€â”€ åœºæ™¯ 2: ç¼ºå¤±è®°å½• â†’ è¡¥å¡«å››çº§è®°å½•è¡¨
  â”‚   â””â”€â”€ åœºæ™¯ 3: æ–‡æ¡£ç¼ºå¤± â†’ åˆ›å»ºæ–°æ–‡æ¡£ â†’ æäº¤å®¡æ‰¹
  â”œâ”€â”€ æäº¤å¤å®¡:
  â”‚   â”œâ”€â”€ ç³»ç»Ÿè‡ªåŠ¨å…³è”æ•´æ”¹åçš„æ–‡æ¡£ç‰ˆæœ¬
  â”‚   â”‚   â””â”€â”€ rectificationDocumentId = doc-001, rectificationVersion = "v2.0"
  â”‚   â”œâ”€â”€ ä¸ç¬¦åˆé¡¹çŠ¶æ€: rectifying â†’ pending_verification
  â”‚   â””â”€â”€ å¾…åŠçŠ¶æ€: pending â†’ pending_verification
  â””â”€â”€ ç­‰å¾…å†…å®¡å‘˜å¤å®¡

Step 7: å†…å®¡å‘˜å¤å®¡éªŒè¯
  â”œâ”€â”€ æŸ¥çœ‹å¾…å¤å®¡çš„ä¸ç¬¦åˆé¡¹åˆ—è¡¨(5 ä¸ª)
  â”œâ”€â”€ é€ä¸ªéªŒè¯:
  â”‚   â”œâ”€â”€ ç‚¹å‡»ä¸ç¬¦åˆé¡¹ â†’ æŸ¥çœ‹æ•´æ”¹è¯¦æƒ…:
  â”‚   â”‚   â”œâ”€â”€ åŸé—®é¢˜: ç¬¬ 3.2 èŠ‚æ¸…æ´é¢‘æ¬¡æè¿°ä¸æ¸…
  â”‚   â”‚   â”œâ”€â”€ æ•´æ”¹è¯æ®: GMP-SOP-001 v2.0
  â”‚   â”‚   â””â”€â”€ å¯¹æ¯”æ–°æ—§ç‰ˆæœ¬(ç³»ç»Ÿæä¾›ç‰ˆæœ¬å¯¹æ¯”åŠŸèƒ½)
  â”‚   â”œâ”€â”€ éªŒè¯ç»“æœ:
  â”‚   â”‚   â”œâ”€â”€ é€šè¿‡:
  â”‚   â”‚   â”‚   â”œâ”€â”€ ä¸ç¬¦åˆé¡¹çŠ¶æ€: pending_verification â†’ verified
  â”‚   â”‚   â”‚   â”œâ”€â”€ å¾…åŠä»»åŠ¡çŠ¶æ€: pending_verification â†’ completed
  â”‚   â”‚   â”‚   â””â”€â”€ è®°å½•éªŒè¯äººå’ŒéªŒè¯æ—¶é—´
  â”‚   â”‚   â””â”€â”€ é©³å›:
  â”‚   â”‚       â”œâ”€â”€ å¡«å†™é©³å›åŸå› 
  â”‚   â”‚       â”œâ”€â”€ ä¸ç¬¦åˆé¡¹çŠ¶æ€: pending_verification â†’ rectifying
  â”‚   â”‚       â”œâ”€â”€ å¾…åŠä»»åŠ¡é‡æ–°åˆ†é…ç»™è´£ä»»äºº
  â”‚   â”‚       â””â”€â”€ è´£ä»»äººé‡æ–°æ•´æ”¹
  â”‚   â””â”€â”€ ç»§ç»­éªŒè¯ä¸‹ä¸€ä¸ª...
  â””â”€â”€ æ‰€æœ‰ä¸ç¬¦åˆé¡¹éªŒè¯é€šè¿‡ â†’ å¯å®Œæˆå†…å®¡è®¡åˆ’

ã€å†…å®¡æŠ¥å‘Šå½’æ¡£ã€‘
Step 8: å®Œæˆå†…å®¡è®¡åˆ’
  â”œâ”€â”€ æ‰€æœ‰ä¸ç¬¦åˆé¡¹çŠ¶æ€ = verified
  â”œâ”€â”€ ç‚¹å‡»"å®Œæˆå†…å®¡"æŒ‰é’®
  â””â”€â”€ çŠ¶æ€: pending_rectification â†’ completed

Step 9: ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆå†…å®¡æŠ¥å‘Š
  â”œâ”€â”€ ç”Ÿæˆ PDF æŠ¥å‘Šå†…å®¹:
  â”‚   â”œâ”€â”€ åŸºæœ¬ä¿¡æ¯(æ ‡é¢˜ã€æ—¥æœŸã€å†…å®¡å‘˜)
  â”‚   â”œâ”€â”€ å®¡æ ¸èŒƒå›´(æ–‡æ¡£æ•°é‡ã€çº§åˆ«åˆ†å¸ƒ)
  â”‚   â”œâ”€â”€ å®¡æ ¸ç»“æœæ±‡æ€»(ç¬¦åˆ/ä¸ç¬¦åˆç»Ÿè®¡)
  â”‚   â”œâ”€â”€ ä¸ç¬¦åˆé¡¹æ¸…å•(æŒ‰éƒ¨é—¨ã€é—®é¢˜ç±»å‹åˆ†ç»„)
  â”‚   â””â”€â”€ æ•´æ”¹éªŒè¯è®°å½•
  â”œâ”€â”€ ä¸Šä¼  PDF åˆ° MinIO
  â””â”€â”€ è‡ªåŠ¨å½’æ¡£åˆ°æ–‡æ¡£ç³»ç»Ÿ(åˆ›å»ºå››çº§æ–‡ä»¶):
      â”œâ”€â”€ æ–‡æ¡£ç¼–å·: REC-AUDIT-{YYYY}-{åºå·}(è‡ªåŠ¨ç”Ÿæˆ)
      â”œâ”€â”€ æ–‡æ¡£æ ‡é¢˜: {å†…å®¡æ ‡é¢˜}-å†…å®¡æŠ¥å‘Š-{æ—¥æœŸ}
      â”œâ”€â”€ æ–‡æ¡£ç±»å‹: å†…å®¡è®°å½•(å›ºå®š)
      â”œâ”€â”€ æ–‡ä»¶çº§åˆ«: 4
      â””â”€â”€ æ–‡ä»¶ URL: MinIO è·¯å¾„
```

---

### 16.3 æ•°æ®æ¨¡å‹

#### 16.3.1 å†…å®¡ç®¡ç†æ ¸å¿ƒè¡¨

```prisma
// ========== å†…å®¡ç®¡ç†æ¨¡å— ==========

// 1. å†…å®¡è®¡åˆ’
model AuditPlan {
  id          String   @id @default(cuid())
  title       String   // "2024-Q1 å†…å®¡"
  type        String   // "quarterly" | "semiannual" | "annual"
  
  startDate   DateTime // å®¡æ ¸èµ·å§‹æ—¥æœŸ
  endDate     DateTime // å®¡æ ¸ç»“æŸæ—¥æœŸ
  
  documentIds String[] // è®¡åˆ’å®¡æ ¸çš„æ–‡æ¡£ ID åˆ—è¡¨(æ‰¹é‡å‹¾é€‰)
  
  status      String   @default("draft")
                       // draft: è‰ç¨¿(å¯å¯åŠ¨)
                       // ongoing: å®¡æ ¸ä¸­
                       // pending_rectification: ç­‰å¾…æ•´æ”¹
                       // completed: å·²å®Œæˆ
  
  auditorId   String   // å†…å®¡å‘˜
  createdBy   String   // åˆ›å»ºäºº
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  startedAt   DateTime? // å¯åŠ¨æ—¶é—´
  completedAt DateTime? // å®Œæˆæ—¶é—´
  
  auditor     User @relation("AuditedPlans", fields: [auditorId], references: [id])
  creator     User @relation("CreatedAuditPlans", fields: [createdBy], references: [id])
  
  findings    AuditFinding[]
  report      AuditReport?
  
  @@index([status, startDate])
  @@index([auditorId])
  @@index([createdBy])
}

// 2. å®¡æ ¸å‘ç°(å†…å®¡è®°å½•)
model AuditFinding {
  id          String   @id @default(cuid())
  planId      String   // æ‰€å±å†…å®¡è®¡åˆ’
  
  documentId  String   // å…³è”çš„æ–‡æ¡£
  auditResult String   // "ç¬¦åˆ" | "ä¸ç¬¦åˆ"
  
  // ä»¥ä¸‹å­—æ®µä»…åœ¨ auditResult = "ä¸ç¬¦åˆ" æ—¶å¡«å†™
  issueType   String?  // "éœ€è¦ä¿®æ”¹" | "ç¼ºå¤±è®°å½•" | "æ–‡æ¡£ç¼ºå¤±"
  description String?  // é—®é¢˜æè¿°(å¿…å¡«)
  
  department  String?  // è´£ä»»éƒ¨é—¨
  assigneeId  String?  // è´£ä»»äºº
  dueDate     DateTime? // æ•´æ”¹æœŸé™(å®¡æ ¸æ—¥æœŸ + 30 å¤©)
  
  status      String   @default("pending")
                       // pending: å¾…æ•´æ”¹(ä»…"ä¸ç¬¦åˆ"é¡¹æœ‰æ­¤çŠ¶æ€)
                       // rectifying: æ•´æ”¹ä¸­
                       // pending_verification: å¾…å¤å®¡
                       // verified: å·²éªŒè¯é€šè¿‡
                       // rejected: å¤å®¡é©³å›
  
  // æ•´æ”¹è¯æ®(ç³»ç»Ÿè‡ªåŠ¨è®°å½•)
  rectificationDocumentId String?  // æ•´æ”¹åçš„æ–‡æ¡£ ID
  rectificationVersion    String?  // æ•´æ”¹åçš„æ–‡æ¡£ç‰ˆæœ¬å·
  
  verifiedBy       String?  // éªŒè¯äºº(å†…å®¡å‘˜)
  verifiedAt       DateTime?
  rejectionReason  String?  // é©³å›åŸå› 
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  plan        AuditPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  document    Document @relation("AuditFindings", fields: [documentId], references: [id])
  assignee    User? @relation("AssignedAuditFindings", fields: [assigneeId], references: [id])
  verifier    User? @relation("VerifiedAuditFindings", fields: [verifiedBy], references: [id])
  
  @@index([planId, auditResult])
  @@index([assigneeId, status])
  @@index([status, dueDate])
}

// 3. å†…å®¡æŠ¥å‘Š(å½’æ¡£)
model AuditReport {
  id          String   @id @default(cuid())
  planId      String   @unique
  
  summary     Json     // æ±‡æ€»ä¿¡æ¯
                       // {
                       //   totalDocuments: 50,
                       //   conformCount: 45,
                       //   nonConformCount: 5,
                       //   byLevel: { "1": 1, "2": 10, "3": 20, "4": 19 },
                       //   byDepartment: { "ç”Ÿäº§éƒ¨": 3, "è´¨é‡éƒ¨": 2 },
                       //   byIssueType: { "éœ€è¦ä¿®æ”¹": 3, "ç¼ºå¤±è®°å½•": 2 }
                       // }
  
  pdfUrl      String   // PDF æŠ¥å‘Šè·¯å¾„(MinIO)
  documentId  String   // å½’æ¡£åˆ°æ–‡æ¡£ç³»ç»Ÿçš„æ–‡æ¡£ ID
  
  createdAt   DateTime @default(now())
  
  plan        AuditPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  document    Document @relation("AuditReports", fields: [documentId], references: [id])
  
  @@index([documentId])
}
```

---

#### 16.3.2 User è¡¨æ‰©å±•

```prisma
model User {
  // ... ç°æœ‰å­—æ®µ ...

  // å†…å®¡ç›¸å…³
  createdAuditPlans     AuditPlan[] @relation("CreatedAuditPlans")
  auditedPlans          AuditPlan[] @relation("AuditedPlans")
  assignedAuditFindings AuditFinding[] @relation("AssignedAuditFindings")
  verifiedAuditFindings AuditFinding[] @relation("VerifiedAuditFindings")
}
```

---

#### 16.3.3 Document è¡¨æ‰©å±•

```prisma
model Document {
  // ... ç°æœ‰å­—æ®µ ...

  // å†…å®¡ç›¸å…³
  auditFindings   AuditFinding[] @relation("AuditFindings")
  auditReports    AuditReport[] @relation("AuditReports")
}
```

---

#### 16.3.4 TodoTask ç±»å‹æ‰©å±•

```typescript
// packages/types/todo.ts
export type TodoType =
  | 'training_organize'
  | 'training_attend'
  | 'approval'
  | 'audit_rectification'  // æ–°å¢: å†…å®¡æ•´æ”¹å¾…åŠ
  | 'equipment_maintain'
  | 'inventory'
  | 'change_request';
```


---

### 16.4 ä¸šåŠ¡è§„åˆ™

#### 16.4.1 å†…å®¡è®¡åˆ’è§„åˆ™(BR-116 ~ BR-120)

**BR-116: å†…å®¡è®¡åˆ’åˆ›å»ºè§„åˆ™**
- æ ‡é¢˜å¿…å¡«,é•¿åº¦ 5-100 å­—ç¬¦
- ç±»å‹å¿…é€‰: quarterly(å­£åº¦) / semiannual(åŠå¹´) / annual(å¹´åº¦)
- å®¡æ ¸æ—¶é—´èŒƒå›´å¿…å¡«,startDate < endDate
- å†…å®¡å‘˜å¿…é€‰,ä¸”å¿…é¡»ä¸ºåœ¨èŒå‘˜å·¥
- è‡³å°‘å‹¾é€‰ 1 ä¸ªå®¡æ ¸æ–‡æ¡£

**BR-117: å†…å®¡è®¡åˆ’æ–‡æ¡£å‹¾é€‰è§„åˆ™**
- åªèƒ½å‹¾é€‰å·²å‘å¸ƒçš„æ–‡æ¡£(status = 'published')
- æ”¯æŒæŒ‰æ–‡æ¡£çº§åˆ«ç­›é€‰(1/2/3/4)
- æ”¯æŒæŒ‰éƒ¨é—¨ç­›é€‰
- æ”¯æŒæ‰¹é‡å‹¾é€‰/å–æ¶ˆå‹¾é€‰
- å‹¾é€‰åçš„æ–‡æ¡£åˆ—è¡¨ä¿å­˜åˆ° documentIds æ•°ç»„

**BR-118: å†…å®¡è®¡åˆ’å¤åˆ¶è§„åˆ™**
- å¯ä»¥å¤åˆ¶ä»»æ„çŠ¶æ€çš„å†å²è®¡åˆ’
- å¤åˆ¶å†…å®¹:
  - æ–‡æ¡£åˆ—è¡¨(documentIds)
  - è®¡åˆ’ç±»å‹(type)
- ä¸å¤åˆ¶å†…å®¹:
  - å®¡æ ¸å‘ç°(findings)
  - å®¡æ ¸æŠ¥å‘Š(report)
  - å®¡æ ¸æ—¶é—´(éœ€è¦æ‰‹åŠ¨ä¿®æ”¹)
  - å†…å®¡å‘˜(éœ€è¦æ‰‹åŠ¨é€‰æ‹©)
- å¤åˆ¶åçš„è®¡åˆ’çŠ¶æ€ä¸º draft

**BR-119: å†…å®¡è®¡åˆ’å¯åŠ¨è§„åˆ™**
- åªæœ‰ draft çŠ¶æ€çš„è®¡åˆ’å¯ä»¥å¯åŠ¨
- å¯åŠ¨åçŠ¶æ€å˜ä¸º ongoing
- å¯åŠ¨æ—¶ä¸ç”Ÿæˆå¾…åŠä»»åŠ¡
- å¯åŠ¨åç›´æ¥è¿›å…¥å®¡æ ¸é¡µé¢

**BR-120: å†…å®¡è®¡åˆ’çŠ¶æ€æµè½¬**
```
draft(è‰ç¨¿)
  â†“ ç‚¹å‡»"å¯åŠ¨å†…å®¡"
ongoing(å®¡æ ¸ä¸­)
  â†“ ç‚¹å‡»"æäº¤å®¡æ ¸æŠ¥å‘Š"
pending_rectification(ç­‰å¾…æ•´æ”¹)
  â†“ æ‰€æœ‰ä¸ç¬¦åˆé¡¹éªŒè¯é€šè¿‡
completed(å·²å®Œæˆ)
```

---

#### 16.4.2 å®¡æ ¸æ‰§è¡Œè§„åˆ™(BR-121 ~ BR-125)

**BR-121: å®¡æ ¸æ–‡æ¡£è®°å½•è§„åˆ™**
- æ‰€æœ‰æ–‡æ¡£éƒ½å¿…é¡»è®°å½•å®¡æ ¸ç»“æœ(åŒ…æ‹¬"ç¬¦åˆ"çš„)
- å®¡æ ¸ç»“æœåªæœ‰ä¸¤ç§: "ç¬¦åˆ" / "ä¸ç¬¦åˆ"
- å®¡æ ¸ç»“æœä¸º"ç¬¦åˆ":
  - åªè®°å½• auditResult = "ç¬¦åˆ"
  - issueType, description, assigneeId ç­‰å­—æ®µä¸º null
- å®¡æ ¸ç»“æœä¸º"ä¸ç¬¦åˆ":
  - å¿…é¡»å¡«å†™ issueType(é—®é¢˜ç±»å‹)
  - å¿…é¡»å¡«å†™ description(é—®é¢˜æè¿°,æœ€å°‘ 10 å­—ç¬¦)
  - å¿…é¡»å¡«å†™ department(è´£ä»»éƒ¨é—¨)
  - å¿…é¡»å¡«å†™ assigneeId(è´£ä»»äºº)
  - dueDate è‡ªåŠ¨è®¡ç®—(å®¡æ ¸æ—¥æœŸ + 30 å¤©)

**BR-122: é—®é¢˜ç±»å‹æšä¸¾**
- "éœ€è¦ä¿®æ”¹": æ–‡æ¡£å†…å®¹æœ‰é”™è¯¯æˆ–ä¸å®Œå–„,éœ€è¦ä¿®æ”¹
- "ç¼ºå¤±è®°å½•": å››çº§è®°å½•æ–‡ä»¶ç¼ºå°‘åº”æœ‰çš„è®°å½•
- "æ–‡æ¡£ç¼ºå¤±": åº”è¯¥å­˜åœ¨çš„æ–‡æ¡£ä¸å­˜åœ¨,éœ€è¦åˆ›å»º

**BR-123: å®¡æ ¸è¿›åº¦è®¡ç®—**
- å®¡æ ¸è¿›åº¦ = å·²å®¡æ ¸æ–‡æ¡£æ•° / è®¡åˆ’å®¡æ ¸æ–‡æ¡£æ•° Ã— 100%
- å·²å®¡æ ¸æ–‡æ¡£ = æœ‰ AuditFinding è®°å½•çš„æ–‡æ¡£
- æ‰€æœ‰æ–‡æ¡£å®¡æ ¸å®Œæ¯• = å®¡æ ¸è¿›åº¦ 100%

**BR-124: å®¡æ ¸æŠ¥å‘Šæäº¤æ¡ä»¶**
- å¿…é¡»æ‰€æœ‰æ–‡æ¡£éƒ½å·²å®¡æ ¸(å®¡æ ¸è¿›åº¦ = 100%)
- æäº¤åç”Ÿæˆæ•´æ”¹å¾…åŠä»»åŠ¡(ä»…é’ˆå¯¹"ä¸ç¬¦åˆ"é¡¹)
- æäº¤åå†…å®¡è®¡åˆ’çŠ¶æ€å˜ä¸º pending_rectification

**BR-125: å®¡æ ¸ç»“æœä¸å¯ä¿®æ”¹è§„åˆ™**
- å®¡æ ¸æŠ¥å‘Šæäº¤å,å®¡æ ¸ç»“æœä¸å¯ä¿®æ”¹
- å¦‚éœ€ä¿®æ”¹,å¿…é¡»"æ’¤å›å®¡æ ¸æŠ¥å‘Š"(çŠ¶æ€: pending_rectification â†’ ongoing)
- æ’¤å›å,å·²ç”Ÿæˆçš„æ•´æ”¹å¾…åŠä»»åŠ¡è‡ªåŠ¨åˆ é™¤

---

#### 16.4.3 æ•´æ”¹è·Ÿè¸ªè§„åˆ™(BR-126 ~ BR-130)

**BR-126: æ•´æ”¹å¾…åŠä»»åŠ¡ç”Ÿæˆè§„åˆ™**
- æäº¤å®¡æ ¸æŠ¥å‘Šæ—¶,è‡ªåŠ¨ç”Ÿæˆæ•´æ”¹å¾…åŠä»»åŠ¡
- åªä¸º"ä¸ç¬¦åˆ"é¡¹ç”Ÿæˆå¾…åŠ
- å¾…åŠä»»åŠ¡å†…å®¹:
  - type = 'audit_rectification'
  - relatedId = AuditFinding.id
  - userId = AuditFinding.assigneeId
  - title = "æ•´æ”¹'{æ–‡æ¡£æ ‡é¢˜}'å®¡æ ¸å‘ç°"
  - description = AuditFinding.description
  - dueDate = AuditFinding.dueDate
  - priority = 'high'

**BR-127: æ•´æ”¹æäº¤è§„åˆ™**
- è´£ä»»äººä¿®æ”¹/è¡¥å¡«æ–‡æ¡£å,ç‚¹å‡»"æäº¤å¤å®¡"
- ç³»ç»Ÿè‡ªåŠ¨è®°å½•æ•´æ”¹è¯æ®:
  - rectificationDocumentId = æ•´æ”¹åçš„æ–‡æ¡£ ID
  - rectificationVersion = æ•´æ”¹åçš„æ–‡æ¡£ç‰ˆæœ¬å·
- ä¸éœ€è¦è´£ä»»äººå¡«å†™æ•´æ”¹è¯´æ˜
- æäº¤å:
  - ä¸ç¬¦åˆé¡¹çŠ¶æ€: rectifying â†’ pending_verification
  - å¾…åŠä»»åŠ¡çŠ¶æ€: pending â†’ pending_verification

**BR-128: æ•´æ”¹å¤å®¡éªŒè¯è§„åˆ™**
- åªæœ‰å†…å®¡å‘˜å¯ä»¥éªŒè¯æ•´æ”¹
- éªŒè¯é€‰é¡¹:
  - é€šè¿‡:
    - ä¸ç¬¦åˆé¡¹çŠ¶æ€: pending_verification â†’ verified
    - å¾…åŠä»»åŠ¡çŠ¶æ€: pending_verification â†’ completed
    - è®°å½• verifiedBy, verifiedAt
  - é©³å›:
    - ä¸ç¬¦åˆé¡¹çŠ¶æ€: pending_verification â†’ rectifying
    - å¾…åŠä»»åŠ¡é‡æ–°åˆ†é…ç»™è´£ä»»äºº
    - è®°å½• rejectionReason(é©³å›åŸå› ,å¿…å¡«)
    - è´£ä»»äººé‡æ–°æ•´æ”¹

**BR-129: æ•´æ”¹æœŸé™ç›‘æ§è§„åˆ™**
- æ•´æ”¹æœŸé™é»˜è®¤ä¸ºå®¡æ ¸æ—¥æœŸ + 30 å¤©
- è¶…è¿‡æœŸé™æœªæ•´æ”¹:
  - å¾…åŠä»»åŠ¡æ ‡è®°ä¸º"é€¾æœŸ"(dueDate < å½“å‰æ—¥æœŸ)
  - ç³»ç»Ÿæ¯å¤©å‘é€é€¾æœŸæé†’(é‚®ä»¶/ç«™å†…ä¿¡)
- å…è®¸å»¶æœŸ:
  - è´£ä»»äººå¯ç”³è¯·å»¶æœŸ(éœ€å†…å®¡å‘˜å®¡æ‰¹)
  - å»¶æœŸåæ›´æ–° dueDate

**BR-130: å†…å®¡è®¡åˆ’å®Œæˆæ¡ä»¶**
- æ‰€æœ‰ä¸ç¬¦åˆé¡¹çŠ¶æ€ = verified
- æ»¡è¶³æ¡ä»¶å,å¯ç‚¹å‡»"å®Œæˆå†…å®¡"
- å®Œæˆå:
  - å†…å®¡è®¡åˆ’çŠ¶æ€: pending_rectification â†’ completed
  - è‡ªåŠ¨ç”Ÿæˆå†…å®¡æŠ¥å‘Š PDF
  - è‡ªåŠ¨å½’æ¡£åˆ°æ–‡æ¡£ç³»ç»Ÿ

---

#### 16.4.4 å†…å®¡æŠ¥å‘Šè§„åˆ™(BR-131 ~ BR-135)

**BR-131: å†…å®¡æŠ¥å‘Šç”Ÿæˆæ—¶æœº**
- å†…å®¡è®¡åˆ’çŠ¶æ€å˜ä¸º completed æ—¶,è‡ªåŠ¨ç”Ÿæˆ
- ç”Ÿæˆå†…å®¹:
  - åŸºæœ¬ä¿¡æ¯(æ ‡é¢˜ã€æ—¥æœŸã€å†…å®¡å‘˜)
  - å®¡æ ¸èŒƒå›´(æ–‡æ¡£æ•°é‡ã€çº§åˆ«åˆ†å¸ƒã€éƒ¨é—¨åˆ†å¸ƒ)
  - å®¡æ ¸ç»“æœæ±‡æ€»(ç¬¦åˆ/ä¸ç¬¦åˆç»Ÿè®¡)
  - ä¸ç¬¦åˆé¡¹æ¸…å•(æŒ‰éƒ¨é—¨ã€é—®é¢˜ç±»å‹åˆ†ç»„)
  - æ•´æ”¹éªŒè¯è®°å½•(è´£ä»»äººã€æ•´æ”¹è¯æ®ã€éªŒè¯ç»“æœ)

**BR-132: å†…å®¡æŠ¥å‘Šå½’æ¡£è§„åˆ™**
- ç”Ÿæˆ PDF å,è‡ªåŠ¨å½’æ¡£åˆ°æ–‡æ¡£ç³»ç»Ÿ(åˆ›å»ºå››çº§æ–‡ä»¶)
- æ–‡æ¡£ç¼–å·: `REC-AUDIT-{YYYY}-{åºå·}`(è‡ªåŠ¨ç”Ÿæˆ)
  - åºå·ä¸ºè¯¥å¹´åº¦å†…å®¡æŠ¥å‘Šçš„é¡ºåºå·(å¦‚ 001, 002...)
- æ–‡æ¡£æ ‡é¢˜: `{å†…å®¡æ ‡é¢˜}-å†…å®¡æŠ¥å‘Š-{å®Œæˆæ—¥æœŸ}`
  - ç¤ºä¾‹: "2024-Q1 å†…å®¡-å†…å®¡æŠ¥å‘Š-2024-04-30"
- æ–‡æ¡£ç±»å‹: `audit_record`(å›ºå®š)
- æ–‡ä»¶çº§åˆ«: 4
- å½’å±éƒ¨é—¨: è´¨é‡éƒ¨(å›ºå®š)

**BR-133: å†…å®¡æŠ¥å‘Š PDF æ ¼å¼**
```markdown
ã€å†…å®¡æŠ¥å‘Šã€‘

ä¸€ã€åŸºæœ¬ä¿¡æ¯
- å†…å®¡æ ‡é¢˜: 2024-Q1 å†…å®¡
- å®¡æ ¸ç±»å‹: å­£åº¦å†…å®¡
- å®¡æ ¸æ—¶é—´: 2024-03-01 ~ 2024-03-31
- å†…å®¡å‘˜: å¼ ä¸‰
- å®Œæˆæ—¥æœŸ: 2024-04-30

äºŒã€å®¡æ ¸èŒƒå›´
- å®¡æ ¸æ–‡æ¡£æ€»æ•°: 50
- ä¸€çº§æ–‡ä»¶: 1 ä»½
- äºŒçº§æ–‡ä»¶: 10 ä»½
- ä¸‰çº§æ–‡ä»¶: 20 ä»½
- å››çº§æ–‡ä»¶: 19 ä»½
- æ¶‰åŠéƒ¨é—¨: ç”Ÿäº§éƒ¨ã€è´¨é‡éƒ¨ã€é‡‡è´­éƒ¨

ä¸‰ã€å®¡æ ¸ç»“æœæ±‡æ€»
- ç¬¦åˆ: 45 (90%)
- ä¸ç¬¦åˆ: 5 (10%)

å››ã€ä¸ç¬¦åˆé¡¹æ¸…å•
| åºå· | æ–‡æ¡£ç¼–å· | æ–‡æ¡£æ ‡é¢˜ | é—®é¢˜ç±»å‹ | é—®é¢˜æè¿° | è´£ä»»éƒ¨é—¨ | è´£ä»»äºº | æ•´æ”¹æœŸé™ | éªŒè¯ç»“æœ |
|------|----------|----------|----------|----------|----------|--------|----------|----------|
| 1 | GMP-SOP-001 | è½¦é—´æ¸…æ´è§„ç¨‹ | éœ€è¦ä¿®æ”¹ | ç¬¬ 3.2 èŠ‚æ¸…æ´é¢‘æ¬¡æè¿°ä¸æ¸… | ç”Ÿäº§éƒ¨ | æå›› | 2024-04-15 | å·²é€šè¿‡ |
| 2 | GMP-WI-001 | æ¸…æ´å‰‚ä½¿ç”¨æŒ‡å— | ç¼ºå¤±è®°å½• | 2024-02 æœˆç¼ºå°‘ 15 å¤©è®°å½• | ç”Ÿäº§éƒ¨ | ç‹äº” | 2024-04-15 | å·²é€šè¿‡ |
| ... | ... | ... | ... | ... | ... | ... | ... | ... |

äº”ã€æ•´æ”¹éªŒè¯è®°å½•
| ä¸ç¬¦åˆé¡¹ | æ•´æ”¹è¯æ® | éªŒè¯äºº | éªŒè¯æ—¶é—´ | éªŒè¯ç»“æœ |
|----------|----------|--------|----------|----------|
| GMP-SOP-001 | v2.0 (2024-04-10) | å¼ ä¸‰ | 2024-04-12 | é€šè¿‡ |
| GMP-WI-001 | è¡¥å¡«è®°å½• | å¼ ä¸‰ | 2024-04-13 | é€šè¿‡ |
| ... | ... | ... | ... | ... |

å…­ã€ç»Ÿè®¡åˆ†æ
- ä¸ç¬¦åˆé¡¹æŒ‰éƒ¨é—¨åˆ†å¸ƒ: ç”Ÿäº§éƒ¨ 3, è´¨é‡éƒ¨ 2
- ä¸ç¬¦åˆé¡¹æŒ‰é—®é¢˜ç±»å‹åˆ†å¸ƒ: éœ€è¦ä¿®æ”¹ 3, ç¼ºå¤±è®°å½• 2
- æ•´æ”¹åŠæ—¶ç‡: 100% (5/5)
- å¹³å‡æ•´æ”¹æ—¶é•¿: 8 å¤©

ç”Ÿæˆæ—¶é—´: 2024-04-30 10:00:00
```

**BR-134: å†…å®¡æŠ¥å‘Šå”¯ä¸€æ€§**
- æ¯ä¸ªå†…å®¡è®¡åˆ’åªèƒ½ç”Ÿæˆä¸€æ¬¡æŠ¥å‘Š
- é‡å¤ç”Ÿæˆè¿”å›: `409 Conflict`

**BR-135: å†…å®¡æŠ¥å‘Šç‰ˆæœ¬ç®¡ç†**
- å†…å®¡æŠ¥å‘Šå½’æ¡£å,ä½œä¸ºå››çº§æ–‡ä»¶ç®¡ç†
- å¦‚éœ€ä¿®æ”¹æŠ¥å‘Š,éœ€è¦åˆ›å»ºæ–°ç‰ˆæœ¬(Document.version)
- å†å²ç‰ˆæœ¬å¯è¿½æº¯


---

### 16.5 å¼€å‘å·¥ä½œé‡ä¼°ç®—

#### 16.5.1 åç«¯å¼€å‘(8-10 å¤©)

| æ¨¡å— | å·¥ä½œå†…å®¹ | å·¥ä½œé‡ |
|------|----------|--------|
| **å†…å®¡è®¡åˆ’ç®¡ç†** | AuditPlan CRUDã€æ–‡æ¡£å‹¾é€‰ã€å¤åˆ¶åŠŸèƒ½ | 2 å¤© |
| **å®¡æ ¸æ‰§è¡Œ** | AuditFinding CRUDã€å®¡æ ¸è¿›åº¦è®¡ç®— | 2 å¤© |
| **æ•´æ”¹è·Ÿè¸ª** | æ•´æ”¹å¾…åŠç”Ÿæˆã€å¤å®¡éªŒè¯é€»è¾‘ | 2 å¤© |
| **å†…å®¡æŠ¥å‘Š** | PDF ç”Ÿæˆã€è‡ªåŠ¨å½’æ¡£ | 1.5 å¤© |
| **å•å…ƒæµ‹è¯•** | æ ¸å¿ƒé€»è¾‘æµ‹è¯• | 1.5 å¤© |

**å°è®¡: 9 å¤© â†’ é¢„ç•™ç¼“å†² â†’ 10 å¤©**

---

#### 16.5.2 å‰ç«¯å¼€å‘(9-11 å¤©)

| æ¨¡å— | å·¥ä½œå†…å®¹ | å·¥ä½œé‡ |
|------|----------|--------|
| **å†…å®¡è®¡åˆ’** | AuditPlanList.vueã€AuditPlanDetail.vueã€æ–‡æ¡£å‹¾é€‰ç»„ä»¶ | 2.5 å¤© |
| **å®¡æ ¸æ‰§è¡Œ** | AuditExecution.vue(å®¡æ ¸é¡µé¢ã€è¿›åº¦æ˜¾ç¤º) | 2.5 å¤© |
| **æ•´æ”¹ç®¡ç†** | RectificationList.vueã€éªŒè¯é¡µé¢ | 2 å¤© |
| **å†…å®¡æŠ¥å‘Š** | AuditReportList.vue | 1.5 å¤© |
| **çŠ¶æ€ç®¡ç†** | Pinia store(å†…å®¡æ¨¡å—) | 0.5 å¤© |
| **ç±»å‹å®šä¹‰** | packages/types(å†…å®¡ç›¸å…³ç±»å‹) | 0.5 å¤© |
| **E2E æµ‹è¯•** | Playwright æµ‹è¯•(æ ¸å¿ƒæµç¨‹) | 1.5 å¤© |

**å°è®¡: 11 å¤© â†’ é¢„ç•™ç¼“å†² â†’ 12 å¤©**

---

#### 16.5.3 æ€»å·¥ä½œé‡

| é˜¶æ®µ | å·¥ä½œé‡ | è¯´æ˜ |
|------|--------|------|
| **åç«¯å¼€å‘** | 10 å¤© | åŒ…å«å•å…ƒæµ‹è¯• |
| **å‰ç«¯å¼€å‘** | 12 å¤© | åŒ…å« E2E æµ‹è¯• |
| **è”è°ƒæµ‹è¯•** | 2 å¤© | å‰åç«¯è”è°ƒ |
| **æ–‡æ¡£ç¼–å†™** | 1 å¤© | API æ–‡æ¡£ã€ç”¨æˆ·æ‰‹å†Œ |

**æ€»è®¡: 25 å¤©(çº¦ 5 å‘¨)**

**å¹¶è¡Œå¼€å‘**(1 ååç«¯ + 1 åå‰ç«¯): **çº¦ 3 å‘¨**

---

### 16.6 ä¾èµ–ä¸é£é™©

#### 16.6.1 æŠ€æœ¯ä¾èµ–

| ä¾èµ–é¡¹ | ç‰ˆæœ¬ | ç”¨é€” | é£é™©ç­‰çº§ |
|--------|------|------|----------|
| **TodoTask ç³»ç»Ÿ** | å·²å®Œæˆ(Chapter 15) | æ•´æ”¹å¾…åŠä»»åŠ¡ | ä½ |
| **æ–‡æ¡£ç³»ç»Ÿ** | å·²å®Œæˆ | æ–‡æ¡£å‹¾é€‰ã€æ¡£æ¡ˆå½’æ¡£ | ä½ |
| **MinIO** | å·²éƒ¨ç½² | å†…å®¡æŠ¥å‘Š PDF å­˜å‚¨ | ä½ |
| **PDF ç”Ÿæˆåº“** | pdfmake | ç”Ÿæˆå†…å®¡æŠ¥å‘Š PDF | ä¸­ |

**å…³é”®ä¾èµ–**:
- âœ… TodoTask ç³»ç»Ÿ(Chapter 15 å·²è®¾è®¡)
- âœ… æ–‡æ¡£ç³»ç»Ÿã€MinIO å·²å°±ç»ª
- âš ï¸ éœ€è¦ç¡®è®¤ PDF ç”Ÿæˆåº“(pdfmake vs puppeteer)

---

#### 16.6.2 ä¸šåŠ¡é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| **å®¡æ ¸ç»“æœè®°å½•é—æ¼** | æ— æ³•è¯æ˜å®¡æ ¸è¦†ç›– | ä¸­ | å¼ºåˆ¶æ‰€æœ‰æ–‡æ¡£å¿…é¡»è®°å½•,å®¡æ ¸è¿›åº¦ç›‘æ§ |
| **æ•´æ”¹è¯æ®å…³è”å¤±è´¥** | æ— æ³•è¿½æº¯æ•´æ”¹è¿‡ç¨‹ | ä½ | è‡ªåŠ¨å…³è”æ–‡æ¡£ç‰ˆæœ¬,å¼‚å¸¸æ—¶æ‰‹åŠ¨è¡¥å…… |
| **å†…å®¡æŠ¥å‘Š PDF ç”Ÿæˆå¤±è´¥** | æŠ¥å‘Šæ— æ³•å½’æ¡£ | ä½ | å¼‚æ­¥ç”Ÿæˆ,å¤±è´¥é‡è¯•,è®°å½•é”™è¯¯æ—¥å¿— |
| **æ•´æ”¹é€¾æœŸç‡é«˜** | å†…å®¡è®¡åˆ’æ— æ³•å®Œæˆ | ä¸­ | 30 å¤©æœŸé™ã€é€¾æœŸæé†’ã€æ”¯æŒå»¶æœŸç”³è¯· |

---

### 16.7 åç»­æ‰©å±•æ–¹å‘(v1.1+)

#### v1.1.0: å†…å®¡å¢å¼º
- âœ… æ£€æŸ¥è¡¨æ¨¡æ¿ç®¡ç†(é¢„ç½®æ ‡å‡†æ£€æŸ¥è¦ç‚¹)
- âœ… å®¡æ ¸è®°å½•å¯¼å‡º(Excel æ ¼å¼)
- âœ… å†…å®¡ç»Ÿè®¡åˆ†æ(è¶‹åŠ¿å›¾ã€éƒ¨é—¨å¯¹æ¯”)

#### v1.2.0: æ¡æ¬¾ç®¡ç†(å¯é€‰)
- âœ… BRCGS æ¡æ¬¾åº“ç®¡ç†
- âœ… å®¡æ ¸æ—¶å…³è”æ¡æ¬¾
- âœ… æ¡æ¬¾è¦†ç›–ç‡ç»Ÿè®¡

#### v1.3.0: ç§»åŠ¨ç«¯å®¡æ ¸(å¯é€‰)
- âœ… ç§»åŠ¨ç«¯å®¡æ ¸ç•Œé¢
- âœ… ç°åœºæ‹ç…§ä¸Šä¼ è¯æ®
- âœ… ç¦»çº¿å®¡æ ¸ã€è”ç½‘åŒæ­¥

#### v2.0.0: AI å¢å¼º
- âœ… AI å®¡æ ¸å»ºè®®(åŸºäºå†å²å®¡æ ¸è®°å½•)
- âœ… æ™ºèƒ½ä¸ç¬¦åˆé¡¹åˆ†ç±»
- âœ… é‡å¤é—®é¢˜é¢„è­¦

---

### 16.8 æˆåŠŸæ ‡å‡†

**å†…å®¡è®¡åˆ’ç®¡ç†**:
- âœ… å¯åˆ›å»ºå­£åº¦/åŠå¹´/å¹´åº¦å†…å®¡è®¡åˆ’
- âœ… æ”¯æŒæŒ‰çº§åˆ«/éƒ¨é—¨æ‰¹é‡å‹¾é€‰å®¡æ ¸æ–‡æ¡£
- âœ… æ”¯æŒå¤åˆ¶å†å²è®¡åˆ’,é‡å¤åˆ©ç”¨

**å®¡æ ¸æ‰§è¡Œ**:
- âœ… é€ä¸ªå®¡æ ¸æ–‡æ¡£,è®°å½•å®¡æ ¸ç»“æœ(ç¬¦åˆ/ä¸ç¬¦åˆ)
- âœ… ä¸ç¬¦åˆé¡¹å¿…é¡»å¡«å†™é—®é¢˜è¯¦æƒ…
- âœ… æ˜¾ç¤ºå®¡æ ¸è¿›åº¦(å·²å®¡æ ¸ X/æ€»æ•°)

**æ•´æ”¹è·Ÿè¸ª**:
- âœ… æäº¤å®¡æ ¸æŠ¥å‘Šå,è‡ªåŠ¨ç”Ÿæˆæ•´æ”¹å¾…åŠä»»åŠ¡
- âœ… è´£ä»»äººæäº¤æ•´æ”¹,ç³»ç»Ÿè‡ªåŠ¨å…³è”æ–‡æ¡£ç‰ˆæœ¬
- âœ… å†…å®¡å‘˜å¤å®¡éªŒè¯,æ”¯æŒé€šè¿‡/é©³å›

**å†…å®¡æŠ¥å‘Š**:
- âœ… è‡ªåŠ¨ç”Ÿæˆ PDF æŠ¥å‘Š
- âœ… æŠ¥å‘Šè‡ªåŠ¨å½’æ¡£åˆ°æ–‡æ¡£ç³»ç»Ÿ(å››çº§æ–‡ä»¶)
- âœ… æŠ¥å‘ŠåŒ…å«å®¡æ ¸æ±‡æ€»ã€ä¸ç¬¦åˆé¡¹æ¸…å•ã€æ•´æ”¹è®°å½•

**ç³»ç»Ÿé›†æˆ**:
- âœ… å¤ç”¨ TodoTask ç»Ÿä¸€å¾…åŠç³»ç»Ÿ
- âœ… ä¸æ–‡æ¡£ç³»ç»Ÿæ— ç¼é›†æˆ
- âœ… æ”¯æŒæ–‡æ¡£ç‰ˆæœ¬è¿½æº¯

---

**æœ¬ç« èŠ‚å®Œæˆ âœ…**

---

## åä¸ƒã€ä»“åº“ç®¡ç†ç³»ç»Ÿï¼ˆç‹¬ç«‹æ¨¡å— - PRD-05/10/15 æ•´åˆï¼‰â­â­â­ Phase B æ ¸å¿ƒç”Ÿäº§

[â¬†ï¸ è¿”å›ç›®å½•](#-å®Œæ•´ç›®å½•) | [â¬†ï¸ è¿”å›å¿«é€Ÿå¯¼èˆª](#-å¿«é€Ÿå¯¼èˆª)

> **å»ºè®®ä¸Šçº¿é¡ºåº**: Chapter 18ï¼ˆåœ¨åŠ¨æ€è¡¨å•å¼•æ“ã€æ‰¹æ¬¡è¿½æº¯ã€ç§»åŠ¨ç«¯æ¶æ„å®Œæˆåï¼‰
> **ä¼˜å…ˆçº§**: æœ€é«˜ï¼ˆæ ¸å¿ƒç”Ÿäº§æµç¨‹ï¼ŒåŸæ–™â†’ç”Ÿäº§â†’æˆå“ï¼‰
> **ä¾èµ–**: Chapter 15ï¼ˆåŠ¨æ€è¡¨å•å¼•æ“ï¼‰ã€Chapter 16ï¼ˆæ‰¹æ¬¡è¿½æº¯ç³»ç»Ÿï¼‰ã€Chapter 17ï¼ˆç§»åŠ¨ç«¯åº”ç”¨ï¼‰

> **è®¾è®¡æ—¶é—´**: 2026-02-12
> **ç³»ç»Ÿç‰ˆæœ¬**: v1.0.0 (MVP)
> **ä¾èµ–ç« èŠ‚**: Chapter 15 (TodoTask ç»Ÿä¸€å¾…åŠ), Chapter 14 (v2.0.0 å·¥ä½œæµå¼•æ“)
> **å…³è” PRD**: PRD-05 ä»“åº“ç®¡ç†, PRD-10 å…¨é“¾æ¡è¿½æº¯, PRD-15 æ¥æ–™æ£€éªŒ

---

### 17.1 ç³»ç»Ÿå®šä½ä¸æ ¸å¿ƒä¼˜åŠ¿

#### 17.1.1 ç³»ç»Ÿå®šä½

**ä»“åº“ç®¡ç†ç³»ç»Ÿä½œä¸ºç‹¬ç«‹ä¸šåŠ¡æ¨¡å—**,æ˜¯æ•´ä¸ª BRCGS é£Ÿå“å®‰å…¨ç®¡ç†ä½“ç³»çš„**åŸºç¡€è®¾æ–½**ã€‚

**æ ¸å¿ƒèŒè´£**:
1. **ç‰©æ–™ç®¡ç†**: ç‰©æ–™åŸºç¡€ä¿¡æ¯ã€æ‰¹æ¬¡ç®¡ç†ã€åº“å­˜ç®¡ç†
2. **å‡ºå…¥åº“ç®¡ç†**: ç‰©æ–™å…¥åº“ã€é¢†æ–™å‡ºåº“ã€é€€æ–™ã€æŠ¥åºŸ
3. **æ‰¹æ¬¡è¿½æº¯**: åŸæ–™æ‰¹æ¬¡ â†’ ç”Ÿäº§æ‰¹æ¬¡ â†’ æˆå“æ‰¹æ¬¡çš„å…¨é“¾æ¡è¿½æº¯
4. **ä¾›åº”å•†ç®¡ç†**: ä¾›åº”å•†ä¿¡æ¯ã€èµ„è´¨ç®¡ç†ã€ç»©æ•ˆè¯„ä¼°
5. **ç‰©æ–™å¹³è¡¡æ ¡éªŒ**: é¢†æ–™æ•°é‡ vs é…æ–¹ç”¨é‡ vs å®é™…äº§é‡çš„å¹³è¡¡éªŒè¯
6. **åº“å­˜é¢„è­¦**: ç‰©æ–™ä¸´æœŸé¢„è­¦ã€è¿‡æœŸé”å®š

---

#### 17.1.2 æ ¸å¿ƒä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **æ¶æ„æ¸…æ™°** | ç‹¬ç«‹ä¸šåŠ¡æ¨¡å—,ä¸æ±¡æŸ“å…¶ä»–ç³»ç»Ÿ |
| **åˆ†é˜¶æ®µå®æ–½** | MVP æ‰‹å·¥å½•å…¥,v2.0 å¯¹æ¥é‡‘è¶ ERP |
| **ç»Ÿä¸€å¾…åŠ** | å¤ç”¨ TodoTask ç³»ç»Ÿ(Chapter 15) |
| **å…¨é“¾è¿½æº¯** | æ”¯æŒæ­£å‘/åå‘è¿½æº¯,æ»¡è¶³ BRCGS 4 å°æ—¶å¬å›è¦æ±‚ |
| **æ•°æ®é—­ç¯** | ä»“åº“ â†” æš‚å­˜é—´ â†” ç”Ÿäº§çš„å®Œæ•´æ•°æ®æµ |
| **çµæ´»æ‰©å±•** | é¢„ç•™æ¡å½¢ç å­—æ®µ,v2.0 å¯å¼•å…¥æ‰«ç åŠŸèƒ½ |

---

### 17.2 ä¸šåŠ¡æµç¨‹

#### 17.2.1 æ ¸å¿ƒæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä»“åº“ç®¡ç†æ ¸å¿ƒæµç¨‹                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. ç‰©æ–™å…¥åº“æµç¨‹
   ä¾›åº”å•†é€è´§ â†’ æ¥æ–™æ£€éªŒ(IQC) â†’ æ£€éªŒåˆæ ¼ â†’ å…¥åº“å• â†’ åº“å­˜+

2. é¢†æ–™å‡ºåº“æµç¨‹
   åˆ›å»ºé¢†æ–™å• â†’ é€‰æ‹©æ‰¹æ¬¡(FIFO) â†’ å®¡æ‰¹ â†’ å‡ºåº“å• â†’ ä»“åº“åº“å­˜- / æš‚å­˜é—´åº“å­˜+

3. æš‚å­˜é—´ç›˜ç‚¹æµç¨‹
   ä¸Šç­ç›˜ç‚¹(æœŸåˆ) â†’ è®°å½•ç‰©æ–™æ‰¹æ¬¡æ•°é‡ â†’ ä¸‹ç­ç›˜ç‚¹(æœŸæœ«) â†’ è®¡ç®—å®é™…æ¶ˆè€—

4. ç”Ÿäº§æ¶ˆè€—æµç¨‹
   ç”Ÿäº§å¼€å§‹ â†’ ä»æš‚å­˜é—´é¢†æ–™ â†’ ç”Ÿäº§è®°å½•(å››çº§æ–‡ä»¶) â†’ äº§å“å…¥åº“

5. ç‰©æ–™å¹³è¡¡æ ¡éªŒæµç¨‹
   äº§å“å…¥åº“ â†’ æ ¡éªŒ: æœŸåˆ + é¢†æ–™ - æœŸæœ« â‰ˆ é…æ–¹ç”¨é‡ Ã— äº§é‡ â†’ åå·®é¢„è­¦

6. é€€æ–™æµç¨‹
   å‘ç°è´¨é‡é—®é¢˜ â†’ åˆ›å»ºé€€æ–™å• â†’ å®¡æ‰¹ â†’ å…¥åº“å• â†’ ä»“åº“åº“å­˜+

7. æŠ¥åºŸæµç¨‹
   ç‰©æ–™è¿‡æœŸ/æŸå â†’ åˆ›å»ºæŠ¥åºŸå• â†’ å®¡æ‰¹ â†’ åº“å­˜- â†’ æŠ¥åºŸè®°å½•å½’æ¡£

8. æ‰¹æ¬¡è¿½æº¯æµç¨‹
   åå‘è¿½æº¯: æˆå“æ‰¹æ¬¡ â†’ ç”Ÿäº§æ‰¹æ¬¡ â†’ åŸæ–™æ‰¹æ¬¡ â†’ ä¾›åº”å•†æ‰¹æ¬¡
   æ­£å‘è¿½æº¯: ä¾›åº”å•†æ‰¹æ¬¡ â†’ åŸæ–™æ‰¹æ¬¡ â†’ ç”Ÿäº§æ‰¹æ¬¡ â†’ æˆå“æ‰¹æ¬¡
```

---

#### 17.2.2 å…³é”®ä¸šåŠ¡åœºæ™¯

**åœºæ™¯ 1: åŸæ–™å…¥åº“**
```
1. ä¾›åº”å•†é€è´§(é«˜ç­‹é¢ç²‰ 500kg, æ‰¹æ¬¡: SUP-001-20240101)
2. è´¨é‡éƒ¨ IQC æ£€éªŒ(æŠ½æ£€ 5 è¢‹)
3. æ£€éªŒåˆæ ¼ â†’ ç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºå…¥åº“å•
4. ä»“åº“ç®¡ç†å‘˜ç¡®è®¤å…¥åº“
5. ç³»ç»Ÿè®°å½•:
   - MaterialBatch è¡¨: æ‰¹æ¬¡å·ã€ä¾›åº”å•†æ‰¹æ¬¡ã€ç”Ÿäº§æ—¥æœŸã€ä¿è´¨æœŸ
   - StockRecord è¡¨: å…¥åº“è®°å½•
   - Material è¡¨: åº“å­˜æ•°é‡ + 500kg
```

**åœºæ™¯ 2: ç”Ÿäº§é¢†æ–™**
```
1. ç”Ÿäº§éƒ¨åˆ›å»ºé¢†æ–™å•(éœ€è¦é«˜ç­‹é¢ç²‰ 100kg)
2. ç³»ç»Ÿæ¨èæ‰¹æ¬¡(FIFO): æ‰¹æ¬¡ A(æœ€æ—§æ‰¹æ¬¡, åº“å­˜ 150kg)
3. å®¡æ‰¹äººå®¡æ‰¹é€šè¿‡
4. ä»“åº“ç®¡ç†å‘˜å‡ºåº“ â†’ æš‚å­˜é—´(å°æ–™æˆ¿)
5. ç³»ç»Ÿè®°å½•:
   - MaterialRequisition è¡¨: é¢†æ–™å•
   - MaterialRequisitionItem è¡¨: é¢†æ–™æ˜ç»†(æ‰¹æ¬¡ A, 100kg)
   - StockRecord è¡¨: å‡ºåº“è®°å½•
   - Material è¡¨: åº“å­˜ - 100kg
```

**åœºæ™¯ 3: ç‰©æ–™å¹³è¡¡æ ¡éªŒ**
```
1. ç”Ÿäº§æ‰¹æ¬¡ PROD-20240615-001 å®Œæˆ, äº§å‡º 500kg æ›²å¥‡é¥¼å¹²
2. ä»“åº“å½•å…¥äº§å“å…¥åº“å•
3. ç³»ç»Ÿè‡ªåŠ¨æ ¡éªŒç‰©æ–™å¹³è¡¡:
   - æš‚å­˜é—´æœŸåˆåº“å­˜: é¢ç²‰ 120kg
   - å½“æ—¥é¢†æ–™: 100kg
   - æš‚å­˜é—´æœŸæœ«åº“å­˜: é¢ç²‰ 20kg
   - å®é™…æ¶ˆè€—: 120 + 100 - 20 = 200kg
   - ç†è®ºæ¶ˆè€—: é…æ–¹ç”¨é‡ 0.4kg Ã— äº§é‡ 500kg = 200kg
   - åå·®: 0% (ç¬¦åˆé¢„æœŸ)
4. æ ¡éªŒé€šè¿‡ â†’ äº§å“å…¥åº“
```

**åœºæ™¯ 4: æ‰¹æ¬¡è¿½æº¯(åå‘)**
```
1. å®¢æˆ·æŠ•è¯‰: æ›²å¥‡é¥¼å¹²æ‰¹æ¬¡ FG-P001-20240615-001 æœ‰å¼‚ç‰©
2. è´¨é‡éƒ¨è¾“å…¥æˆå“æ‰¹æ¬¡å·æŸ¥è¯¢
3. ç³»ç»Ÿè‡ªåŠ¨è¿½æº¯:
   - æˆå“æ‰¹æ¬¡ FG-P001-20240615-001
     â†’ ç”Ÿäº§æ‰¹æ¬¡ PROD-20240615-001
     â†’ é¢†æ–™å• REQ-20240615-001
     â†’ åŸæ–™æ‰¹æ¬¡ B20240101 (é«˜ç­‹é¢ç²‰)
     â†’ ä¾›åº”å•†æ‰¹æ¬¡ SUP-001-20240101
     â†’ ä¾›åº”å•†: XXé¢ç²‰å‚
4. ç”Ÿæˆè¿½æº¯æŠ¥å‘Š(PDF), è€—æ—¶ < 4 å°æ—¶(æ»¡è¶³ BRCGS è¦æ±‚)
```

---

### 17.3 æ•°æ®æ¨¡å‹è®¾è®¡

#### 17.3.1 æ ¸å¿ƒæ•°æ®è¡¨(13 ä¸ª)

```prisma
// ==================== ç‰©æ–™ç®¡ç† ====================

// 1. ç‰©æ–™åŸºç¡€ä¿¡æ¯è¡¨
model Material {
  id              String   @id @default(cuid())
  code            String   @unique  // ç‰©æ–™ç¼–ç (æ¥è‡ªé‡‘è¶)
  name            String              // ç‰©æ–™åç§°
  category        String?             // åˆ†ç±»(åŸæ–™/è¾…æ–™/åŒ…æ)
  specification   String?             // è§„æ ¼å‹å·
  unit            String              // å•ä½(kg/ä¸ª/ç®±)
  stockQuantity   Float    @default(0) // å½“å‰åº“å­˜æ•°é‡
  safetyStock     Float?              // å®‰å…¨åº“å­˜(v2.0 æ‰©å±•)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // å…³è”
  batches         MaterialBatch[]     // æ‰¹æ¬¡
  requisitions    MaterialRequisitionItem[] // é¢†æ–™æ˜ç»†
  recipes         RecipeItem[]        // é…æ–¹æ˜ç»†

  @@map("materials")
}

// 2. ç‰©æ–™æ‰¹æ¬¡è¡¨
model MaterialBatch {
  id                  String   @id @default(cuid())
  materialId          String              // ç‰©æ–™ ID
  batchNumber         String   @unique    // æ‰¹æ¬¡å·(ç³»ç»Ÿç”Ÿæˆ)
  supplierBatchNumber String?             // ä¾›åº”å•†æ‰¹æ¬¡å·
  supplierId          String?             // ä¾›åº”å•† ID
  productionDate      DateTime?           // ç”Ÿäº§æ—¥æœŸ
  expiryDate          DateTime?           // åˆ°æœŸæ—¥æœŸ
  shelfLife           Int?                // ä¿è´¨æœŸ(å¤©)
  stockQuantity       Float    @default(0) // æ‰¹æ¬¡åº“å­˜æ•°é‡
  barcode             String?             // æ¡å½¢ç (v2.0 æ‰©å±•)
  status              String   @default("normal") // normal | expired | locked
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // å…³è”
  material            Material @relation(fields: [materialId], references: [id])
  stockRecords        StockRecord[]       // å‡ºå…¥åº“è®°å½•
  requisitionItems    MaterialRequisitionItem[] // é¢†æ–™æ˜ç»†
  traceability        BatchTraceability[] @relation("MaterialBatch") // è¿½æº¯å…³ç³»

  @@map("material_batches")
}

// 3. åº“å­˜è®°å½•è¡¨(å‡ºå…¥åº“æµæ°´)
model StockRecord {
  id              String   @id @default(cuid())
  materialId      String              // ç‰©æ–™ ID
  batchId         String              // æ‰¹æ¬¡ ID
  type            String              // in | out
  quantity        Float               // æ•°é‡(æ­£æ•°)
  relatedType     String?             // requisition | return | scrap | adjustment | stockin
  relatedId       String?             // å…³è”å•æ® ID
  operator        String              // æ“ä½œäºº
  remark          String?             // å¤‡æ³¨
  createdAt       DateTime @default(now())

  // å…³è”
  batch           MaterialBatch @relation(fields: [batchId], references: [id])

  @@map("stock_records")
}

// ==================== é¢†æ–™ç®¡ç† ====================

// 4. é¢†æ–™å•è¡¨
model MaterialRequisition {
  id              String   @id @default(cuid())
  requisitionNumber String @unique     // é¢†æ–™å•å·
  department      String              // ç”³è¯·éƒ¨é—¨
  applicant       String              // ç”³è¯·äºº ID
  applicantName   String              // ç”³è¯·äººå§“å
  purpose         String?             // ç”¨é€”(ç”Ÿäº§/å·¥ç¨‹/è´¨é‡)
  productionBatchId String?           // å…³è”ç”Ÿäº§æ‰¹æ¬¡(å¯é€‰)
  status          String   @default("draft") // draft | pending | approved | rejected | completed
  workflowId      String?             // å·¥ä½œæµå®ä¾‹ ID(å®¡æ‰¹)
  approver        String?             // å®¡æ‰¹äºº ID
  approverName    String?             // å®¡æ‰¹äººå§“å
  approvedAt      DateTime?           // å®¡æ‰¹æ—¶é—´
  rejectReason    String?             // é©³å›åŸå› 
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // å…³è”
  items           MaterialRequisitionItem[] // é¢†æ–™æ˜ç»†

  @@map("material_requisitions")
}

// 5. é¢†æ–™æ˜ç»†è¡¨
model MaterialRequisitionItem {
  id              String   @id @default(cuid())
  requisitionId   String              // é¢†æ–™å• ID
  materialId      String              // ç‰©æ–™ ID
  batchId         String              // æ‰¹æ¬¡ ID
  requestedQuantity Float             // ç”³è¯·æ•°é‡
  approvedQuantity Float?             // æ‰¹å‡†æ•°é‡
  actualQuantity  Float?              // å®é™…å‡ºåº“æ•°é‡
  createdAt       DateTime @default(now())

  // å…³è”
  requisition     MaterialRequisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)
  material        Material @relation(fields: [materialId], references: [id])
  batch           MaterialBatch @relation(fields: [batchId], references: [id])

  @@map("material_requisition_items")
}

// ==================== é…æ–¹ç®¡ç† ====================

// 6. é…æ–¹è¡¨
model Recipe {
  id              String   @id @default(cuid())
  code            String   @unique     // é…æ–¹ç¼–å·
  name            String              // é…æ–¹åç§°
  productId       String              // æˆå“ ID
  version         String   @default("1.0") // ç‰ˆæœ¬å·
  status          String   @default("draft") // draft | pending | approved | archived
  workflowId      String?             // å·¥ä½œæµå®ä¾‹ ID
  expectedYield   Float?              // é¢„æœŸäº§é‡(kg)
  createdBy       String              // åˆ›å»ºäºº ID
  createdByName   String              // åˆ›å»ºäººå§“å
  approver        String?             // å®¡æ‰¹äºº ID
  approverName    String?             // å®¡æ‰¹äººå§“å
  approvedAt      DateTime?           // å®¡æ‰¹æ—¶é—´
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // å…³è”
  items           RecipeItem[]        // é…æ–¹æ˜ç»†

  @@map("recipes")
}

// 7. é…æ–¹æ˜ç»†è¡¨
model RecipeItem {
  id              String   @id @default(cuid())
  recipeId        String              // é…æ–¹ ID
  materialId      String              // ç‰©æ–™ ID
  quantity        Float               // ç”¨é‡
  unit            String              // å•ä½
  percentage      Float?              // ç™¾åˆ†æ¯”(å¯é€‰)
  remark          String?             // å¤‡æ³¨
  createdAt       DateTime @default(now())

  // å…³è”
  recipe          Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  material        Material @relation(fields: [materialId], references: [id])

  @@map("recipe_items")
}

// ==================== æ‰¹æ¬¡è¿½æº¯ ====================

// 8. æ‰¹æ¬¡è¿½æº¯å…³ç³»è¡¨
model BatchTraceability {
  id                  String   @id @default(cuid())
  productionBatchId   String              // ç”Ÿäº§æ‰¹æ¬¡ ID
  materialBatchId     String              // åŸæ–™æ‰¹æ¬¡ ID
  quantity            Float               // ä½¿ç”¨æ•°é‡
  requisitionId       String?             // é¢†æ–™å• ID
  createdAt           DateTime @default(now())

  // å…³è”
  productionBatch     ProductionBatch @relation(fields: [productionBatchId], references: [id])
  materialBatch       MaterialBatch @relation("MaterialBatch", fields: [materialBatchId], references: [id])

  @@map("batch_traceability")
}

// 9. ç”Ÿäº§æ‰¹æ¬¡è¡¨(ç®€åŒ–ç‰ˆ)
model ProductionBatch {
  id              String   @id @default(cuid())
  batchNumber     String   @unique     // ç”Ÿäº§æ‰¹æ¬¡å·
  recipeId        String?             // é…æ–¹ ID(å¯é€‰)
  productId       String              // æˆå“ ID
  productName     String              // æˆå“åç§°
  plannedQuantity Float?              // è®¡åˆ’äº§é‡
  actualQuantity  Float?              // å®é™…äº§é‡
  productionDate  DateTime @default(now()) // ç”Ÿäº§æ—¥æœŸ
  status          String   @default("in_progress") // in_progress | completed
  barcode         String?             // æ¡å½¢ç (v2.0 æ‰©å±•)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // å…³è”
  traceability    BatchTraceability[] // è¿½æº¯å…³ç³»

  @@map("production_batches")
}

// ==================== ä¾›åº”å•†ç®¡ç† ====================

// 10. ä¾›åº”å•†è¡¨
model Supplier {
  id              String   @id @default(cuid())
  code            String   @unique     // ä¾›åº”å•†ç¼–å·
  name            String              // ä¾›åº”å•†åç§°
  type            String              // manufacturer | trader
  contactPerson   String?             // è”ç³»äºº
  contactPhone    String?             // è”ç³»ç”µè¯
  address         String?             // åœ°å€
  status          String   @default("active") // active | inactive
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // å…³è”
  qualifications  SupplierQualification[] // èµ„è´¨
  materials       MaterialBatch[]     // ç‰©æ–™æ‰¹æ¬¡

  @@map("suppliers")
}

// 11. ä¾›åº”å•†èµ„è´¨è¡¨
model SupplierQualification {
  id              String   @id @default(cuid())
  supplierId      String              // ä¾›åº”å•† ID
  type            String              // business_license | production_license | sales_license
  number          String?             // è¯ä¹¦ç¼–å·
  expiryDate      DateTime?           // åˆ°æœŸæ—¥æœŸ
  fileUrl         String?             // æ–‡ä»¶ URL(MinIO)
  status          String   @default("valid") // valid | expiring | expired
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // å…³è”
  supplier        Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@map("supplier_qualifications")
}

// ==================== æš‚å­˜é—´ç›˜ç‚¹ ====================

// 12. æš‚å­˜é—´ç›˜ç‚¹è¡¨
model StagingInventory {
  id              String   @id @default(cuid())
  location        String              // æš‚å­˜é—´ä½ç½®(å°æ–™æˆ¿/é¢ç²‰æˆ¿/ç§°æ²¹é—´)
  inventoryDate   DateTime            // ç›˜ç‚¹æ—¥æœŸ
  inventoryType   String              // opening | closing
  materialId      String              // ç‰©æ–™ ID
  batchId         String              // æ‰¹æ¬¡ ID
  quantity        Float               // æ•°é‡
  operator        String              // æ“ä½œäºº
  remark          String?             // å¤‡æ³¨
  createdAt       DateTime @default(now())

  @@map("staging_inventories")
}

// ==================== ç‰©æ–™å¹³è¡¡è®°å½• ====================

// 13. ç‰©æ–™å¹³è¡¡è®°å½•è¡¨
model MaterialBalance {
  id                  String   @id @default(cuid())
  productionBatchId   String              // ç”Ÿäº§æ‰¹æ¬¡ ID
  materialId          String              // ç‰©æ–™ ID
  openingStock        Float               // æœŸåˆåº“å­˜
  requisitionQuantity Float               // é¢†æ–™æ•°é‡
  closingStock        Float               // æœŸæœ«åº“å­˜
  actualConsumption   Float               // å®é™…æ¶ˆè€— = æœŸåˆ + é¢†æ–™ - æœŸæœ«
  theoreticalConsumption Float            // ç†è®ºæ¶ˆè€— = é…æ–¹ç”¨é‡ Ã— äº§é‡
  deviation           Float               // åå·®(%)
  deviationReason     String?             // åå·®åŸå› (è¶…æ ‡æ—¶å¿…å¡«)
  status              String   @default("normal") // normal | warning | error
  createdAt           DateTime @default(now())

  @@map("material_balances")
}
```

---

#### 17.3.2 æ•°æ®è¡¨å…³ç³»å›¾

```
Material (ç‰©æ–™)
  â”œâ”€ MaterialBatch (æ‰¹æ¬¡) 1:N
  â”‚    â”œâ”€ StockRecord (å‡ºå…¥åº“è®°å½•) 1:N
  â”‚    â”œâ”€ MaterialRequisitionItem (é¢†æ–™æ˜ç»†) 1:N
  â”‚    â””â”€ BatchTraceability (è¿½æº¯å…³ç³») 1:N
  â”‚
  â”œâ”€ RecipeItem (é…æ–¹æ˜ç»†) 1:N
  â””â”€ MaterialRequisitionItem (é¢†æ–™æ˜ç»†) 1:N

Recipe (é…æ–¹)
  â””â”€ RecipeItem (é…æ–¹æ˜ç»†) 1:N

MaterialRequisition (é¢†æ–™å•)
  â””â”€ MaterialRequisitionItem (é¢†æ–™æ˜ç»†) 1:N

ProductionBatch (ç”Ÿäº§æ‰¹æ¬¡)
  â””â”€ BatchTraceability (è¿½æº¯å…³ç³») 1:N

Supplier (ä¾›åº”å•†)
  â”œâ”€ SupplierQualification (èµ„è´¨) 1:N
  â””â”€ MaterialBatch (ç‰©æ–™æ‰¹æ¬¡) 1:N

æ ¸å¿ƒè¿½æº¯é“¾æ¡:
Supplier â†’ MaterialBatch â†’ BatchTraceability â†’ ProductionBatch â†’ æˆå“æ‰¹æ¬¡
```

---

### 17.4 ä¸šåŠ¡è§„åˆ™(BR-136 ~ BR-180, å…± 45 æ¡)

#### 17.4.1 ç‰©æ–™ç®¡ç†è§„åˆ™(BR-136 ~ BR-145)

| ç¼–å· | è§„åˆ™ | å®ç°æ–¹å¼ |
|------|------|----------|
| BR-136 | **ç‰©æ–™ç¼–ç å”¯ä¸€**: æ¯ä¸ªç‰©æ–™çš„ code å¿…é¡»å”¯ä¸€(æ¥è‡ªé‡‘è¶) | `Material.code @unique` |
| BR-137 | **ç‰©æ–™å½•å…¥æ–¹å¼**: MVP é˜¶æ®µæ”¯æŒæ‰‹å·¥å½•å…¥ + Excel æ‰¹é‡å¯¼å…¥ | API: `POST /api/materials/import` |
| BR-138 | **Excel å¯¼å…¥å­—æ®µ**: ç‰©æ–™ç¼–ç ã€åç§°ã€è§„æ ¼ã€å•ä½ã€æ‰¹æ¬¡å·ã€ä¾›åº”å•†æ‰¹æ¬¡ã€ç”Ÿäº§æ—¥æœŸã€ä¿è´¨æœŸ(å¤©) | å¯¼å…¥æ¨¡æ¿å›ºå®šæ ¼å¼ |
| BR-139 | **æ‰¹æ¬¡å·ç”Ÿæˆ**: ä¼˜å…ˆä½¿ç”¨ä¾›åº”å•†æ‰¹æ¬¡å·,æ— åˆ™è‡ªåŠ¨ç”Ÿæˆ `B{YYYYMMDD}-{åºå·}` | åç«¯è‡ªåŠ¨ç”Ÿæˆ |
| BR-140 | **åŒä¸€ç‰©æ–™å¤šæ‰¹æ¬¡**: åŒä¸€ç‰©æ–™å¯ä»¥æœ‰å¤šä¸ªæ‰¹æ¬¡åŒæ—¶å­˜åœ¨åº“å­˜ä¸­ | `MaterialBatch.materialId` éå”¯ä¸€ |
| BR-141 | **æ‰¹æ¬¡çŠ¶æ€**: `normal`(æ­£å¸¸) / `expired`(è¿‡æœŸ) / `locked`(é”å®š,ä¸å¯ç”¨) | `MaterialBatch.status` æšä¸¾ |
| BR-142 | **è¿‡æœŸè‡ªåŠ¨é”å®š**: ç³»ç»Ÿæ¯å¤©è‡ªåŠ¨æ£€æŸ¥æ‰¹æ¬¡åˆ°æœŸæ—¥æœŸ,è¿‡æœŸåˆ™é”å®š | å®šæ—¶ä»»åŠ¡(Cron Job) |
| BR-143 | **ä¸´æœŸé¢„è­¦**: è·ç¦»è¿‡æœŸ < 30 å¤©æ—¶,ç”Ÿæˆå¾…åŠä»»åŠ¡é€šçŸ¥ä»“åº“ç®¡ç†å‘˜ | TodoTask + å®šæ—¶ä»»åŠ¡ |
| BR-144 | **è¿‡æœŸç‰©æ–™å¤„ç†**: è¿‡æœŸç‰©æ–™å¿…é¡»æŠ¥åºŸ,ç”ŸæˆæŠ¥åºŸå• | æŠ¥åºŸæµç¨‹ |
| BR-145 | **æ¡å½¢ç é¢„ç•™**: æ•°æ®åº“é¢„ç•™ `barcode` å­—æ®µ,v2.0 å¯ç”¨æ‰«ç åŠŸèƒ½ | `MaterialBatch.barcode?` å¯é€‰å­—æ®µ |

---

#### 17.4.2 æ‰¹æ¬¡æ¨èè§„åˆ™(BR-146 ~ BR-150)

| ç¼–å· | è§„åˆ™ | å®ç°æ–¹å¼ |
|------|------|----------|
| BR-146 | **FIFO å¼ºåˆ¶æ¨¡å¼ï¼ˆå¯é…ç½®ï¼‰**: ç³»ç»Ÿå¼ºåˆ¶ FIFOï¼Œé¢†æ–™æ—¶ä¼˜å…ˆæ¨èæœ€æ—§æ‰¹æ¬¡ï¼ˆå…¥åº“æ—¶é—´æœ€æ—©ï¼‰| SystemConfig.fifoEnforced (true/false) |
| BR-146a | **æ‰‹åŠ¨æ‰¹æ¬¡é€‰æ‹©å¼€å…³**: ä¿ç•™æ‰‹åŠ¨é€‰æ‹©æ‰¹æ¬¡å¼€å…³ï¼Œç”¨äºåº”å¯¹ç‰¹æ®Šæƒ…å†µï¼ˆç”¨æˆ·ä¸šåŠ¡è§„åˆ™ BR-1.41ï¼‰| SystemConfig.allowManualBatchSelection |
| BR-146b | **å¤šæ‰¹æ¬¡æ··ç”¨**: æœ€æ—©æ‰¹æ¬¡åº“å­˜ä¸è¶³æ—¶ï¼Œå…è®¸ä»å¤šä¸ªæ‰¹æ¬¡é¢†æ–™ï¼ˆç”¨æˆ·ä¸šåŠ¡è§„åˆ™ BR-1.42ï¼‰| é¢†æ–™å•å¯é€‰æ‹©å¤šä¸ªæ‰¹æ¬¡ |
| BR-147 | **ä¸´æœŸä¸ä¼˜å…ˆï¼ˆç®€åŒ–ï¼‰**: ä¸è¦æŠŠç³»ç»Ÿæå¤ªå¤æ‚ï¼ŒæŒ‰å…¥åº“æ—¶é—´ FIFO å³å¯ï¼ˆç”¨æˆ·ä¸šåŠ¡è§„åˆ™ BR-1.43ï¼‰| ç§»é™¤ä¸´æœŸä¼˜å…ˆé€»è¾‘ |
| BR-148 | **è¿‡æœŸæ‰¹æ¬¡è¿‡æ»¤**: è¿‡æœŸç‰©æ–™(status = expired)ä¸æ˜¾ç¤ºåœ¨é¢†æ–™é€‰æ‹©åˆ—è¡¨ä¸­ | æŸ¥è¯¢æ—¶è¿‡æ»¤ `WHERE status != 'expired'` |
| BR-149 | **åº“å­˜å……è¶³æ ¡éªŒ**: é¢†æ–™æ•°é‡ > æ‰¹æ¬¡åº“å­˜æ—¶,æç¤º"åº“å­˜ä¸è¶³",å…è®¸é€‰æ‹©å…¶ä»–æ‰¹æ¬¡ | å‰ç«¯æ ¡éªŒ + åç«¯æ ¡éªŒ |
| BR-150 | **æ‰¹æ¬¡è‡ªåŠ¨æ¨è**: ç³»ç»Ÿæ¨è FIFO æ‰¹æ¬¡ï¼Œä½†å…è®¸æ‰‹åŠ¨ä¿®æ”¹ï¼ˆæ ¹æ® allowManualBatchSelection é…ç½®ï¼‰| å‰ç«¯æ‰¹æ¬¡é€‰æ‹©å™¨æ ¹æ®é…ç½®å¯ç”¨/ç¦ç”¨ |

---

#### 17.4.3 é¢†æ–™æµç¨‹è§„åˆ™(BR-151 ~ BR-160)

| ç¼–å· | è§„åˆ™ | å®ç°æ–¹å¼ |
|------|------|----------|
| BR-151 | **é¢†æ–™å•çŠ¶æ€**: `draft`(è‰ç¨¿) â†’ `pending`(å¾…å®¡æ‰¹) â†’ `approved`(å·²æ‰¹å‡†) â†’ `completed`(å·²å‡ºåº“) / `rejected`(å·²é©³å›) | `MaterialRequisition.status` çŠ¶æ€æœº |
| BR-152 | **é¢†æ–™ä¸å…³è”é…æ–¹**: é¢†æ–™å•ä¸éœ€è¦å…³è”é…æ–¹,ä¸éœ€è¦æŒ‡å®šç”Ÿäº§æ‰¹æ¬¡ | `MaterialRequisition.productionBatchId?` å¯é€‰ |
| BR-153 | **é¢†æ–™å®¡æ‰¹**: æ‰€æœ‰é¢†æ–™å•å¿…é¡»ç»è¿‡å®¡æ‰¹(å¤ç”¨ v2.0.0 å·¥ä½œæµå¼•æ“) | `MaterialRequisition.workflowId` |
| BR-154 | **å®¡æ‰¹å¾…åŠ**: é¢†æ–™å•æäº¤å,è‡ªåŠ¨ç”Ÿæˆå¾…åŠä»»åŠ¡ç»™å®¡æ‰¹äºº | TodoTask é›†æˆ |
| BR-155 | **é¢†æ–™å‡ºåº“**: å®¡æ‰¹é€šè¿‡å,ä»“åº“ç®¡ç†å‘˜ç¡®è®¤å‡ºåº“,ç”Ÿæˆ StockRecord(type=out) | å‡ºåº“æ“ä½œ |
| BR-156 | **åº“å­˜æ‰£å‡**: å‡ºåº“æ—¶æ‰£å‡æ‰¹æ¬¡åº“å­˜ `MaterialBatch.stockQuantity -= actualQuantity` | äº‹åŠ¡æ“ä½œ |
| BR-157 | **é¢†æ–™éƒ¨é—¨**: æ”¯æŒç”Ÿäº§éƒ¨ã€å·¥ç¨‹éƒ¨ã€è´¨é‡éƒ¨é¢†æ–™ | `MaterialRequisition.department` |
| BR-158 | **è¡¥æ–™å•**: è¡¥æ–™å•å°±æ˜¯é¢†æ–™å•,ä¸å•ç‹¬è®¾è®¡ | å¤ç”¨ MaterialRequisition |
| BR-159 | **é¢†æ–™å•å·ç”Ÿæˆ**: `REQ-{YYYYMMDD}-{åºå·}` | åç«¯è‡ªåŠ¨ç”Ÿæˆ |
| BR-160 | **é¢†æ–™å†å²**: æ”¯æŒæŸ¥è¯¢å†å²é¢†æ–™å•,æŒ‰æ—¥æœŸ/éƒ¨é—¨/ç‰©æ–™ç­›é€‰ | æŸ¥è¯¢ API |

---

#### 17.4.4 é€€æ–™æµç¨‹è§„åˆ™(BR-161 ~ BR-165)

| ç¼–å· | è§„åˆ™ | å®ç°æ–¹å¼ |
|------|------|----------|
| BR-161 | **é€€æ–™åœºæ™¯**: é¢†æ–™åå‘ç°è´¨é‡é—®é¢˜,é€€å›ä»“åº“ | é€€æ–™å•(å¤ç”¨ MaterialRequisition, æ ‡è®° type=return) |
| BR-162 | **é€€æ–™å®¡æ‰¹**: é€€æ–™å•éœ€è¦å®¡æ‰¹ | å·¥ä½œæµé›†æˆ |
| BR-163 | **é€€æ–™å…¥åº“**: å®¡æ‰¹é€šè¿‡å,è‡ªåŠ¨ç”Ÿæˆå…¥åº“å•,æ¢å¤æ‰¹æ¬¡åº“å­˜ | StockRecord(type=in) + åº“å­˜æ¢å¤ |
| BR-164 | **é€€æ–™æ•°é‡**: é€€æ–™æ•°é‡ â‰¤ åŸé¢†æ–™æ•°é‡ | å‰ç«¯æ ¡éªŒ + åç«¯æ ¡éªŒ |
| BR-165 | **æ•°æ®é—­ç¯**: å‡ºåº“æ•°é‡ = å®é™…æ¶ˆè€— + é€€æ–™æ•°é‡ | ç‰©æ–™å¹³è¡¡è®¡ç®—æ—¶è€ƒè™‘é€€æ–™ |

---

#### 17.4.5 æŠ¥åºŸæµç¨‹è§„åˆ™(BR-166 ~ BR-170)

| ç¼–å· | è§„åˆ™ | å®ç°æ–¹å¼ |
|------|------|----------|
| BR-166 | **æŠ¥åºŸåœºæ™¯**: ç‰©æ–™è¿‡æœŸã€æŸåã€è´¨é‡é—®é¢˜ | æŠ¥åºŸå• |
| BR-167 | **æŠ¥åºŸå®¡æ‰¹**: æŠ¥åºŸå•éœ€è¦å®¡æ‰¹ | å·¥ä½œæµé›†æˆ |
| BR-168 | **æŠ¥åºŸå‡ºåº“**: å®¡æ‰¹é€šè¿‡å,æ‰£å‡åº“å­˜,ç”Ÿæˆ StockRecord(type=out, relatedType=scrap) | å‡ºåº“æ“ä½œ |
| BR-169 | **æŠ¥åºŸè®°å½•å½’æ¡£**: æŠ¥åºŸå•ä½œä¸ºå››çº§æ–‡ä»¶å½’æ¡£åˆ°æ–‡æ¡£ç³»ç»Ÿ | æ–‡æ¡£ç³»ç»Ÿé›†æˆ |
| BR-170 | **æŠ¥åºŸå•å·ç”Ÿæˆ**: `SCRAP-{YYYYMMDD}-{åºå·}` | åç«¯è‡ªåŠ¨ç”Ÿæˆ |

---

#### 17.4.6 ç›˜ç‚¹æµç¨‹è§„åˆ™(BR-171 ~ BR-175)

| ç¼–å· | è§„åˆ™ | å®ç°æ–¹å¼ |
|------|------|----------|
| BR-171 | **ç›˜ç‚¹ç±»å‹**: ä»“åº“ç›˜ç‚¹ + æš‚å­˜é—´ç›˜ç‚¹(ä¸Šç­/ä¸‹ç­å„ä¸€æ¬¡) | `StagingInventory.inventoryType` = opening / closing |
| BR-172 | **ç›˜ç‚¹å®¡æ‰¹**: ç›˜ç›ˆç›˜äºéœ€è¦å®¡æ‰¹ | å·¥ä½œæµé›†æˆ |
| BR-173 | **åº“å­˜è°ƒæ•´**: å®¡æ‰¹é€šè¿‡å,æŒ‰å®é™…ç›˜ç‚¹æ•°é‡æ›´æ–°åº“å­˜ | `MaterialBatch.stockQuantity = å®é™…ç›˜ç‚¹æ•°é‡` |
| BR-174 | **ç›˜ç‚¹å•å½•å…¥**: åœ¨ç³»ç»Ÿå†…ç›´æ¥å½•å…¥,ä¸æ”¯æŒ Excel å¯¼å…¥ | å‰ç«¯è¡¨å• |
| BR-175 | **ç›˜ç‚¹å•å·ç”Ÿæˆ**: `INV-{YYYYMMDD}-{åºå·}` | åç«¯è‡ªåŠ¨ç”Ÿæˆ |

---

#### 17.4.7 ç‰©æ–™å¹³è¡¡è§„åˆ™(BR-176 ~ BR-180)

| ç¼–å· | è§„åˆ™ | å®ç°æ–¹å¼ |
|------|------|----------|
| BR-176 | **æ ¡éªŒæ—¶æœº**: äº§å“å…¥åº“æ—¶è§¦å‘ç‰©æ–™å¹³è¡¡æ ¡éªŒ | å…¥åº“ API è§¦å‘ |
| BR-177 | **æ ¡éªŒå…¬å¼**: `æœŸåˆ + é¢†æ–™ - æœŸæœ« â‰ˆ é…æ–¹ç”¨é‡ Ã— äº§é‡` | åç«¯è®¡ç®— |
| BR-178 | **å…è®¸åå·®**: ç”±ç”¨æˆ·åœ¨ç³»ç»Ÿè®¾ç½®ä¸­è‡ªå®šä¹‰(ä¾‹å¦‚: Â±5%) | ç³»ç»Ÿé…ç½®è¡¨ |
| BR-179 | **åå·®è¶…æ ‡**: è¶…æ ‡æ—¶è­¦å‘Š(ä¸é˜»æ­¢ä¿å­˜),ä½†éœ€è¦å¡«å†™åå·®åŸå›  | `MaterialBalance.deviationReason` å¿…å¡« |
| BR-180 | **è¡¥æ–™å½±å“**: è¡¥æ–™ä¼šå½±å“ç‰©æ–™å¹³è¡¡è®¡ç®—,é¢†æ–™æ•°é‡ += è¡¥æ–™æ•°é‡ | è®¡ç®—æ—¶æ±‡æ€»æ‰€æœ‰é¢†æ–™å• |

---

#### 17.4.8 ä¾›åº”å•†èµ„è´¨ç®¡ç†è§„åˆ™ï¼ˆBR-181 ~ BR-185ï¼‰â­ P0-6 ä¿®å¤

| ç¼–å· | è§„åˆ™ | å®ç°æ–¹å¼ |
|------|------|----------|
| **BR-181 (P0-6)** | **èµ„è´¨çŠ¶æ€**: valid(æœ‰æ•ˆ) / expiring(ä¸´æœŸï¼Œ< 30å¤©) / expired(å·²è¿‡æœŸ) | `SupplierQualification.status` |
| **BR-182 (P0-6)** | **è‡ªåŠ¨è¿‡æœŸæ£€æŸ¥**: å®šæ—¶ä»»åŠ¡æ¯å¤©æ£€æŸ¥èµ„è´¨åˆ°æœŸæ—¥æœŸï¼Œè‡ªåŠ¨æ›´æ–°çŠ¶æ€ | å®šæ—¶ä»»åŠ¡ + çŠ¶æ€æ›´æ–° |
| **BR-183 (P0-6)** | **ä¸´æœŸé¢„è­¦**: è·ç¦»è¿‡æœŸ < 30 å¤©æ—¶ï¼Œæ ‡è®°ä¸º expiringï¼Œç”Ÿæˆå¾…åŠä»»åŠ¡é€šçŸ¥é‡‡è´­éƒ¨ | TodoTask + å®šæ—¶ä»»åŠ¡ |
| **BR-184 (P0-6)** | **è¿‡æœŸè‡ªåŠ¨åœç”¨**: èµ„è´¨è¿‡æœŸåï¼Œä¾›åº”å•†çŠ¶æ€è‡ªåŠ¨å˜ä¸º inactiveï¼Œç¦æ­¢ç»§ç»­é‡‡è´­ | å®šæ—¶ä»»åŠ¡ + Supplier.status æ›´æ–° |
| **BR-185 (P0-6)** | **è¿‡æœŸä¾›åº”å•†é™åˆ¶**: status = inactive çš„ä¾›åº”å•†ä¸èƒ½åˆ›å»ºæ–°çš„å…¥åº“å• | å‰ç«¯é™åˆ¶ + åç«¯æ ¡éªŒ |

---

### 17.5 API è®¾è®¡(32 ä¸ªç«¯ç‚¹)

#### 17.5.1 ç‰©æ–™ç®¡ç† API(8 ä¸ª)

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | è¯·æ±‚ä½“ | å“åº” |
|------|------|------|--------|------|
| GET | `/api/materials` | æŸ¥è¯¢ç‰©æ–™åˆ—è¡¨ | `?page=1&limit=20&keyword=` | `{ items: Material[], total: number }` |
| GET | `/api/materials/:id` | æŸ¥è¯¢ç‰©æ–™è¯¦æƒ… | - | `Material` |
| POST | `/api/materials` | åˆ›å»ºç‰©æ–™(æ‰‹å·¥å½•å…¥) | `{ code, name, category, ... }` | `Material` |
| PUT | `/api/materials/:id` | æ›´æ–°ç‰©æ–™ | `{ name, specification, ... }` | `Material` |
| DELETE | `/api/materials/:id` | åˆ é™¤ç‰©æ–™ | - | `{ success: true }` |
| POST | `/api/materials/import` | Excel æ‰¹é‡å¯¼å…¥ | `FormData(file)` | `{ success: true, count: 10 }` |
| GET | `/api/materials/:id/batches` | æŸ¥è¯¢ç‰©æ–™çš„æ‰€æœ‰æ‰¹æ¬¡ | - | `MaterialBatch[]` |
| GET | `/api/materials/:id/stock-history` | æŸ¥è¯¢ç‰©æ–™åº“å­˜å†å² | `?startDate=&endDate=` | `StockRecord[]` |

---

#### 17.5.2 æ‰¹æ¬¡ç®¡ç† API(6 ä¸ª)

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | è¯·æ±‚ä½“ | å“åº” |
|------|------|------|--------|------|
| GET | `/api/batches` | æŸ¥è¯¢æ‰¹æ¬¡åˆ—è¡¨ | `?materialId=&status=` | `MaterialBatch[]` |
| GET | `/api/batches/:id` | æŸ¥è¯¢æ‰¹æ¬¡è¯¦æƒ… | - | `MaterialBatch` |
| POST | `/api/batches` | åˆ›å»ºæ‰¹æ¬¡(å…¥åº“) | `{ materialId, supplierBatchNumber, ... }` | `MaterialBatch` |
| PUT | `/api/batches/:id` | æ›´æ–°æ‰¹æ¬¡ | `{ expiryDate, ... }` | `MaterialBatch` |
| POST | `/api/batches/:id/lock` | é”å®šæ‰¹æ¬¡ | - | `{ success: true }` |
| GET | `/api/batches/expiring` | æŸ¥è¯¢ä¸´æœŸæ‰¹æ¬¡ | `?days=30` | `MaterialBatch[]` |

---

#### 17.5.3 é¢†æ–™ç®¡ç† API(7 ä¸ª)

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | è¯·æ±‚ä½“ | å“åº” |
|------|------|------|--------|------|
| GET | `/api/requisitions` | æŸ¥è¯¢é¢†æ–™å•åˆ—è¡¨ | `?status=&department=` | `MaterialRequisition[]` |
| GET | `/api/requisitions/:id` | æŸ¥è¯¢é¢†æ–™å•è¯¦æƒ… | - | `MaterialRequisition + items[]` |
| POST | `/api/requisitions` | åˆ›å»ºé¢†æ–™å• | `{ department, items: [{ materialId, batchId, quantity }] }` | `MaterialRequisition` |
| PUT | `/api/requisitions/:id` | æ›´æ–°é¢†æ–™å•(è‰ç¨¿çŠ¶æ€) | `{ items: [...] }` | `MaterialRequisition` |
| POST | `/api/requisitions/:id/submit` | æäº¤å®¡æ‰¹ | - | `{ success: true, workflowId }` |
| POST | `/api/requisitions/:id/approve` | å®¡æ‰¹é€šè¿‡ | `{ approver, approverName }` | `{ success: true }` |
| POST | `/api/requisitions/:id/reject` | å®¡æ‰¹é©³å› | `{ rejectReason }` | `{ success: true }` |

---

#### 17.5.4 é…æ–¹ç®¡ç† API(6 ä¸ª)

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | è¯·æ±‚ä½“ | å“åº” |
|------|------|------|--------|------|
| GET | `/api/recipes` | æŸ¥è¯¢é…æ–¹åˆ—è¡¨ | `?productId=&status=` | `Recipe[]` |
| GET | `/api/recipes/:id` | æŸ¥è¯¢é…æ–¹è¯¦æƒ… | - | `Recipe + items[]` |
| POST | `/api/recipes` | åˆ›å»ºé…æ–¹ | `{ code, name, productId, items: [{ materialId, quantity }] }` | `Recipe` |
| PUT | `/api/recipes/:id` | æ›´æ–°é…æ–¹ | `{ items: [...] }` | `Recipe` |
| POST | `/api/recipes/:id/submit` | æäº¤å®¡æ‰¹ | - | `{ success: true, workflowId }` |
| POST | `/api/recipes/:id/copy` | å¤åˆ¶é…æ–¹(æ–°ç‰ˆæœ¬) | - | `Recipe` |

---

#### 17.5.5 æ‰¹æ¬¡è¿½æº¯ API(3 ä¸ª)

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | è¯·æ±‚ä½“ | å“åº” |
|------|------|------|--------|------|
| GET | `/api/traceability/forward` | æ­£å‘è¿½æº¯(åŸæ–™ â†’ æˆå“) | `?materialBatchId=` | `{ chain: [...] }` |
| GET | `/api/traceability/backward` | åå‘è¿½æº¯(æˆå“ â†’ åŸæ–™) | `?productionBatchId=` | `{ chain: [...] }` |
| POST | `/api/traceability/report` | ç”Ÿæˆè¿½æº¯æŠ¥å‘Š(PDF) | `{ type, batchId }` | `{ reportUrl }` |

---

#### 17.5.6 ä¾›åº”å•†ç®¡ç† API(2 ä¸ª)

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | è¯·æ±‚ä½“ | å“åº” |
|------|------|------|--------|------|
| GET | `/api/suppliers` | æŸ¥è¯¢ä¾›åº”å•†åˆ—è¡¨ | `?type=&status=` | `Supplier[]` |
| POST | `/api/suppliers/:id/qualifications` | ä¸Šä¼ ä¾›åº”å•†èµ„è´¨ | `{ type, number, expiryDate, file }` | `SupplierQualification` |

---

### 17.6 å‰ç«¯è®¾è®¡(8 ä¸ªé¡µé¢)

#### 17.6.1 é¡µé¢åˆ—è¡¨

| é¡µé¢è·¯å¾„ | é¡µé¢åç§° | åŠŸèƒ½ |
|---------|---------|------|
| `/warehouse/materials` | ç‰©æ–™ç®¡ç† | ç‰©æ–™åˆ—è¡¨ã€æ–°å¢ã€ç¼–è¾‘ã€å¯¼å…¥ |
| `/warehouse/batches` | æ‰¹æ¬¡ç®¡ç† | æ‰¹æ¬¡åˆ—è¡¨ã€æŸ¥çœ‹ã€é”å®šã€ä¸´æœŸé¢„è­¦ |
| `/warehouse/requisitions` | é¢†æ–™ç®¡ç† | é¢†æ–™å•åˆ—è¡¨ã€åˆ›å»ºã€å®¡æ‰¹ã€å‡ºåº“ |
| `/warehouse/recipes` | é…æ–¹ç®¡ç† | é…æ–¹åˆ—è¡¨ã€åˆ›å»ºã€å®¡æ‰¹ã€ç‰ˆæœ¬ç®¡ç† |
| `/warehouse/traceability` | æ‰¹æ¬¡è¿½æº¯ | æ­£å‘/åå‘è¿½æº¯ã€ç”ŸæˆæŠ¥å‘Š |
| `/warehouse/suppliers` | ä¾›åº”å•†ç®¡ç† | ä¾›åº”å•†åˆ—è¡¨ã€èµ„è´¨ç®¡ç†ã€ç»©æ•ˆè¯„ä¼° |
| `/warehouse/inventory` | åº“å­˜ç›˜ç‚¹ | æš‚å­˜é—´ç›˜ç‚¹ã€ç›˜ç›ˆç›˜äº |
| `/warehouse/balance` | ç‰©æ–™å¹³è¡¡ | ç‰©æ–™å¹³è¡¡è®°å½•ã€åå·®åˆ†æ |

---

### 17.7 å¼€å‘å·¥ä½œé‡ä¼°ç®—

#### 17.7.1 åç«¯å¼€å‘(20 å¤©)

| æ¨¡å— | å·¥ä½œé‡ | è¯´æ˜ |
|------|--------|------|
| **ç‰©æ–™ç®¡ç†** | 3 å¤© | Material + MaterialBatch CRUD + Excel å¯¼å…¥ |
| **æ‰¹æ¬¡ç®¡ç†** | 2 å¤© | æ‰¹æ¬¡æŸ¥è¯¢ã€é”å®šã€ä¸´æœŸé¢„è­¦(å®šæ—¶ä»»åŠ¡) |
| **é¢†æ–™ç®¡ç†** | 4 å¤© | é¢†æ–™å• CRUD + å®¡æ‰¹é›†æˆ + å‡ºåº“é€»è¾‘ |
| **é…æ–¹ç®¡ç†** | 3 å¤© | é…æ–¹ CRUD + å®¡æ‰¹é›†æˆ + ç‰ˆæœ¬ç®¡ç† |
| **æ‰¹æ¬¡è¿½æº¯** | 3 å¤© | æ­£å‘/åå‘è¿½æº¯ + PDF æŠ¥å‘Šç”Ÿæˆ |
| **ä¾›åº”å•†ç®¡ç†** | 2 å¤© | ä¾›åº”å•† CRUD + èµ„è´¨ç®¡ç† |
| **ç‰©æ–™å¹³è¡¡** | 2 å¤© | ç‰©æ–™å¹³è¡¡è®¡ç®— + åå·®æ ¡éªŒ |
| **å•å…ƒæµ‹è¯•** | 1 å¤© | æ ¸å¿ƒä¸šåŠ¡é€»è¾‘æµ‹è¯• |

**åç«¯åˆè®¡: 20 å¤©**

---

#### 17.7.2 å‰ç«¯å¼€å‘(22 å¤©)

| æ¨¡å— | å·¥ä½œé‡ | è¯´æ˜ |
|------|--------|------|
| **ç‰©æ–™ç®¡ç†é¡µé¢** | 3 å¤© | åˆ—è¡¨ã€è¡¨å•ã€Excel å¯¼å…¥ç»„ä»¶ |
| **æ‰¹æ¬¡ç®¡ç†é¡µé¢** | 2 å¤© | åˆ—è¡¨ã€è¯¦æƒ…ã€ä¸´æœŸé¢„è­¦åˆ—è¡¨ |
| **é¢†æ–™ç®¡ç†é¡µé¢** | 4 å¤© | åˆ—è¡¨ã€åˆ›å»ºè¡¨å•ã€æ‰¹æ¬¡æ¨èã€å®¡æ‰¹æµç¨‹ |
| **é…æ–¹ç®¡ç†é¡µé¢** | 3 å¤© | åˆ—è¡¨ã€è¡¨å•ã€é…æ–¹æ˜ç»†ç¼–è¾‘å™¨ |
| **æ‰¹æ¬¡è¿½æº¯é¡µé¢** | 3 å¤© | è¿½æº¯æŸ¥è¯¢ã€å…³ç³»å›¾å¯è§†åŒ–ã€PDF é¢„è§ˆ |
| **ä¾›åº”å•†ç®¡ç†é¡µé¢** | 2 å¤© | åˆ—è¡¨ã€è¡¨å•ã€èµ„è´¨ä¸Šä¼  |
| **åº“å­˜ç›˜ç‚¹é¡µé¢** | 2 å¤© | ç›˜ç‚¹è¡¨å•ã€ç›˜ç›ˆç›˜äºå¤„ç† |
| **ç‰©æ–™å¹³è¡¡é¡µé¢** | 2 å¤© | ç‰©æ–™å¹³è¡¡è®°å½•åˆ—è¡¨ã€åå·®åˆ†æ |
| **E2E æµ‹è¯•** | 1 å¤© | å…³é”®æµç¨‹æµ‹è¯•(é¢†æ–™ã€è¿½æº¯) |

**å‰ç«¯åˆè®¡: 22 å¤©**

---

#### 17.7.3 æ€»å·¥ä½œé‡

| é˜¶æ®µ | å·¥ä½œé‡ | è¯´æ˜ |
|------|--------|------|
| **åç«¯å¼€å‘** | 20 å¤© | åŒ…å«å•å…ƒæµ‹è¯• |
| **å‰ç«¯å¼€å‘** | 22 å¤© | åŒ…å« E2E æµ‹è¯• |
| **è”è°ƒæµ‹è¯•** | 2 å¤© | å‰åç«¯è”è°ƒ |
| **æ–‡æ¡£ç¼–å†™** | 1 å¤© | API æ–‡æ¡£ã€ç”¨æˆ·æ‰‹å†Œ |

**æ€»è®¡: 45 å¤©(çº¦ 9 å‘¨)**

**å¹¶è¡Œå¼€å‘**(1 ååç«¯ + 1 åå‰ç«¯): **çº¦ 5 å‘¨**

---

### 17.8 ä¾èµ–ä¸é£é™©

#### 17.8.1 æŠ€æœ¯ä¾èµ–

| ä¾èµ–é¡¹ | ç‰ˆæœ¬ | ç”¨é€” | é£é™©ç­‰çº§ |
|--------|------|------|----------|
| **TodoTask ç³»ç»Ÿ** | å·²å®Œæˆ(Chapter 15) | é¢†æ–™å®¡æ‰¹å¾…åŠ | ä½ |
| **v2.0.0 å·¥ä½œæµå¼•æ“** | å·²å®Œæˆ(Chapter 14) | é¢†æ–™/é…æ–¹å®¡æ‰¹æµç¨‹ | ä½ |
| **æ–‡æ¡£ç³»ç»Ÿ** | å·²å®Œæˆ | æŠ¥åºŸå•å½’æ¡£ | ä½ |
| **MinIO** | å·²éƒ¨ç½² | è¿½æº¯æŠ¥å‘Š PDF å­˜å‚¨ | ä½ |
| **PDF ç”Ÿæˆåº“** | pdfmake | ç”Ÿæˆè¿½æº¯æŠ¥å‘Š PDF | ä¸­ |
| **Excel è§£æåº“** | xlsx | è§£æå¯¼å…¥çš„ Excel æ–‡ä»¶ | ä½ |

**å…³é”®ä¾èµ–**:
- âœ… TodoTaskã€v2.0.0 å·¥ä½œæµã€æ–‡æ¡£ç³»ç»Ÿã€MinIO å·²å°±ç»ª
- âš ï¸ éœ€è¦ç¡®è®¤ PDF ç”Ÿæˆåº“(pdfmake vs puppeteer)

---

#### 17.8.2 ä¸šåŠ¡é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| **é‡‘è¶é›†æˆå»¶æœŸ** | MVP æ— æ³•å¯¹æ¥ ERP | é«˜ | å…ˆæ‰‹å·¥å½•å…¥ + Excel å¯¼å…¥,v2.0 å†å¯¹æ¥ |
| **æ‰¹æ¬¡æ¨èç®—æ³•é”™è¯¯** | è¿å FIFO,å½±å“è¿½æº¯ | ä¸­ | å¼ºåˆ¶ FIFO,ç³»ç»Ÿè‡ªåŠ¨æ¨è,ç”¨æˆ·ä¸èƒ½æ‰‹åŠ¨é€‰æ‹© |
| **ç‰©æ–™å¹³è¡¡åå·®è¿‡å¤§** | æ— æ³•æ‰¾åˆ°åå·®åŸå›  | ä¸­ | å¼ºåˆ¶å¡«å†™åå·®åŸå› ,æ”¯æŒé‡æ–°ç›˜ç‚¹ |
| **è¿½æº¯æŸ¥è¯¢æ…¢** | æ— æ³•æ»¡è¶³ 4 å°æ—¶å¬å›è¦æ±‚ | ä½ | ä¼˜åŒ–æŸ¥è¯¢ SQL,å»ºç«‹è¿½æº¯å…³ç³»ç´¢å¼• |
| **æš‚å­˜é—´ç›˜ç‚¹é—æ¼** | ç‰©æ–™å¹³è¡¡æ•°æ®ä¸å‡† | é«˜ | å¼ºåˆ¶æ¯å¤©ç›˜ç‚¹(ä¸Šç­/ä¸‹ç­),ç³»ç»Ÿæé†’ |

---

### 17.9 åç»­æ‰©å±•æ–¹å‘(v2.0+)

#### v2.0.0: é‡‘è¶ ERP é›†æˆ
- âœ… å®æ—¶ API å¯¹æ¥é‡‘è¶
- âœ… ç‰©æ–™åŸºç¡€ä¿¡æ¯è‡ªåŠ¨åŒæ­¥
- âœ… åº“å­˜æ•°é‡å®æ—¶æ›´æ–°
- âœ… æ‰¹æ¬¡ä¿¡æ¯è‡ªåŠ¨å¯¼å…¥

#### v2.1.0: æ¡å½¢ç æ‰«ç 
- âœ… ç‰©æ–™æ‰¹æ¬¡æ¡å½¢ç æ‰“å°
- âœ… é¢†æ–™æ‰«ç å½•å…¥
- âœ… ç›˜ç‚¹æ‰«ç å½•å…¥
- âœ… è¿½æº¯æ‰«ç æŸ¥è¯¢

#### v2.2.0: ç§»åŠ¨ç«¯
- âœ… ç§»åŠ¨ç«¯é¢†æ–™å®¡æ‰¹
- âœ… ç§»åŠ¨ç«¯ç›˜ç‚¹å½•å…¥
- âœ… ç§»åŠ¨ç«¯è¿½æº¯æŸ¥è¯¢

#### v2.3.0: æ™ºèƒ½é¢„è­¦
- âœ… åº“å­˜ä¸è¶³é¢„è­¦(å®‰å…¨åº“å­˜)
- âœ… æ‰¹æ¬¡ä¸´æœŸé¢„è­¦(æå‰ 30 å¤©)
- âœ… ç‰©æ–™å¹³è¡¡åå·®é¢„è­¦
- âœ… ä¾›åº”å•†èµ„è´¨åˆ°æœŸé¢„è­¦

---

### 17.10 æˆåŠŸæ ‡å‡†

**ç‰©æ–™ç®¡ç†**:
- âœ… æ”¯æŒæ‰‹å·¥å½•å…¥ + Excel æ‰¹é‡å¯¼å…¥
- âœ… æ‰¹æ¬¡å·ä¼˜å…ˆä½¿ç”¨ä¾›åº”å•†æ‰¹æ¬¡,æ— åˆ™è‡ªåŠ¨ç”Ÿæˆ
- âœ… åŒä¸€ç‰©æ–™å¯ä»¥æœ‰å¤šä¸ªæ‰¹æ¬¡åŒæ—¶å­˜åœ¨

**é¢†æ–™ç®¡ç†**:
- âœ… é¢†æ–™å•æ”¯æŒå®¡æ‰¹æµç¨‹
- âœ… å¼ºåˆ¶ FIFO,ç³»ç»Ÿè‡ªåŠ¨æ¨èæœ€æ—§æ‰¹æ¬¡
- âœ… ä¸´æœŸç‰©æ–™ä¼˜å…ˆæ¨è
- âœ… è¿‡æœŸç‰©æ–™è‡ªåŠ¨é”å®š,ä¸å…è®¸é¢†ç”¨

**æ‰¹æ¬¡è¿½æº¯**:
- âœ… æ”¯æŒæ­£å‘è¿½æº¯(åŸæ–™ â†’ æˆå“)
- âœ… æ”¯æŒåå‘è¿½æº¯(æˆå“ â†’ åŸæ–™)
- âœ… è¿½æº¯æŸ¥è¯¢ < 4 å°æ—¶(æ»¡è¶³ BRCGS è¦æ±‚)
- âœ… è‡ªåŠ¨ç”Ÿæˆè¿½æº¯æŠ¥å‘Š(PDF)

**ç‰©æ–™å¹³è¡¡**:
- âœ… äº§å“å…¥åº“æ—¶è‡ªåŠ¨æ ¡éªŒç‰©æ–™å¹³è¡¡
- âœ… å…è®¸åå·®å¯ç”±ç”¨æˆ·è‡ªå®šä¹‰(ä¾‹å¦‚: Â±5%)
- âœ… åå·®è¶…æ ‡æ—¶è­¦å‘Š,éœ€è¦å¡«å†™åŸå› 

**ä¾›åº”å•†ç®¡ç†**:
- âœ… åŒºåˆ†ä¾›åº”å•†ç±»å‹(ç”Ÿäº§å•†/è´¸æ˜“å•†)
- âœ… èµ„è´¨åˆ†ç±»ç®¡ç†(è¥ä¸šæ‰§ç…§/ç”Ÿäº§è®¸å¯è¯/é”€å”®è®¸å¯è¯)
- âœ… èµ„è´¨åˆ°æœŸæå‰ 30 å¤©é¢„è­¦

**ç³»ç»Ÿé›†æˆ**:
- âœ… å¤ç”¨ TodoTask ç»Ÿä¸€å¾…åŠç³»ç»Ÿ
- âœ… å¤ç”¨ v2.0.0 å·¥ä½œæµå¼•æ“
- âœ… ä¸æ–‡æ¡£ç³»ç»Ÿæ— ç¼é›†æˆ(æŠ¥åºŸå•å½’æ¡£)

---

**æœ¬ç« èŠ‚å®Œæˆ âœ…**


---

## åå…«ã€è®¾å¤‡ç®¡ç†ç³»ç»Ÿï¼ˆç‹¬ç«‹æ¨¡å—ï¼‰â­â­ Phase B æ ¸å¿ƒç”Ÿäº§

[â¬†ï¸ è¿”å›ç›®å½•](#-å®Œæ•´ç›®å½•) | [â¬†ï¸ è¿”å›å¿«é€Ÿå¯¼èˆª](#-å¿«é€Ÿå¯¼èˆª)

> **å»ºè®®ä¸Šçº¿é¡ºåº**: Chapter 19ï¼ˆåœ¨ä»“åº“ç®¡ç†ç³»ç»Ÿå®Œæˆåï¼‰
> **ä¼˜å…ˆçº§**: é«˜ï¼ˆç”Ÿäº§è®¾å¤‡ç»´æŠ¤ä¿å…»ï¼‰
> **ä¾èµ–**: Chapter 15ï¼ˆåŠ¨æ€è¡¨å•å¼•æ“ï¼‰ã€Chapter 17ï¼ˆç§»åŠ¨ç«¯åº”ç”¨ï¼‰

> **è®¾è®¡æ—¶é—´**: 2026-02-12
> **ç³»ç»Ÿç‰ˆæœ¬**: v1.0.0 (å®Œæ•´ç‰ˆ)
> **ä¾èµ–ç« èŠ‚**: Chapter 15 (TodoTask ç»Ÿä¸€å¾…åŠ), Chapter 14 (v2.0.0 å·¥ä½œæµå¼•æ“)
> **ç§»åŠ¨ç«¯æ”¯æŒ**: âœ… å¾®ä¿¡å°ç¨‹åº + H5 + APP (uniapp)

---

### 18.1 ç³»ç»Ÿå®šä½ä¸æ ¸å¿ƒä¼˜åŠ¿

#### 18.1.1 ç³»ç»Ÿå®šä½

**è®¾å¤‡ç®¡ç†ç³»ç»Ÿä½œä¸ºç‹¬ç«‹ä¸šåŠ¡æ¨¡å—**ï¼Œè´Ÿè´£å·¥å‚æ‰€æœ‰è®¾å¤‡çš„å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚

**æ ¸å¿ƒèŒè´£**:
1. **è®¾å¤‡å°è´¦ç®¡ç†**: è®¾å¤‡åŸºç¡€ä¿¡æ¯ã€åˆ†ç±»ã€çŠ¶æ€ç®¡ç†
2. **ç»´æŠ¤ä¿å…»è®¡åˆ’**: è‡ªåŠ¨ç”Ÿæˆç»´æŠ¤è®¡åˆ’ã€åˆ°æœŸæé†’ã€æ—¥å†è§†å›¾
3. **ç»´ä¿è®°å½•ç®¡ç†**: åœ¨çº¿å¡«å†™ç»´ä¿è®°å½•ã€ç§»åŠ¨ç«¯æ‹ç…§ã€å®¡æ‰¹æµç¨‹
4. **è®¾å¤‡ç»Ÿè®¡åˆ†æ**: æ•…éšœç‡ã€ä½¿ç”¨ç‡ã€ç»´ä¿æˆæœ¬åˆ†æ
5. **ç§»åŠ¨ç«¯æ”¯æŒ**: ç°åœºå¡«å†™ã€æ‹ç…§ä¸Šä¼ ã€ç”µå­ç­¾åã€ç¦»çº¿å¡«å†™

---

#### 18.1.2 æ ¸å¿ƒä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **è‡ªåŠ¨åŒ–æé†’** | æ ¹æ®ç»´æŠ¤å‘¨æœŸè‡ªåŠ¨ç”Ÿæˆå¾…åŠä»»åŠ¡ï¼Œæå‰æé†’ |
| **ç§»åŠ¨ç«¯æ”¯æŒ** | ç°åœºç»´ä¿å¯ç›´æ¥åœ¨æ‰‹æœºå¡«å†™ï¼Œæ‹ç…§ä¸Šä¼  |
| **æ•°æ®ç”µå­åŒ–** | ç»´ä¿è®°å½•åœ¨çº¿å¡«å†™ï¼Œæ•°æ®åº“å­˜å‚¨ï¼Œå¯è¿½æº¯ |
| **æ—¥å†å¯è§†åŒ–** | ç»´æŠ¤è®¡åˆ’æ—¥å†è§†å›¾ï¼Œä¸€ç›®äº†ç„¶ |
| **å®¡æ‰¹æµç¨‹** | ç»´ä¿è®°å½•éœ€ä¸Šçº§å®¡æ ¸é€šè¿‡ï¼Œå…³é—­å¾…åŠ |
| **ç¦»çº¿å¡«å†™** | æ— ç½‘ç»œç¯å¢ƒä¹Ÿèƒ½å¡«å†™ï¼Œè”ç½‘åè‡ªåŠ¨åŒæ­¥ |

---

### 18.2 ä¸šåŠ¡æµç¨‹

#### 18.2.1 æ ¸å¿ƒæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è®¾å¤‡ç®¡ç†æ ¸å¿ƒæµç¨‹                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. è®¾å¤‡å°è´¦å½•å…¥
   å·¥ç¨‹éƒ¨å½•å…¥è®¾å¤‡ä¿¡æ¯ â†’ è®¾ç½®ç»´æŠ¤å‘¨æœŸ â†’ è®¾ç½®è´£ä»»äºº

2. ç»´æŠ¤è®¡åˆ’è‡ªåŠ¨ç”Ÿæˆ
   ç³»ç»Ÿæ ¹æ®ç»´æŠ¤å‘¨æœŸ â†’ è‡ªåŠ¨è®¡ç®—ä¸‹æ¬¡ç»´æŠ¤æ—¥æœŸ â†’ ç”Ÿæˆç»´æŠ¤è®¡åˆ’

3. åˆ°æœŸæé†’
   ç»´æŠ¤æ—¥æœŸä¸´è¿‘ â†’ æå‰ N å¤©ç”Ÿæˆå¾…åŠä»»åŠ¡ â†’ é€šçŸ¥è´£ä»»äººï¼ˆå¾®ä¿¡/ç«™å†…ä¿¡ï¼‰

4. ç»´ä¿æ‰§è¡Œï¼ˆç§»åŠ¨ç«¯ï¼‰
   è´£ä»»äººæŸ¥çœ‹å¾…åŠ â†’ ç°åœºç»´ä¿ â†’ å¡«å†™ç»´ä¿è®°å½• â†’ æ‹ç…§ä¸Šä¼  â†’ ç”µå­ç­¾å

5. ç»´ä¿è®°å½•å®¡æ‰¹
   æäº¤ç»´ä¿è®°å½• â†’ ç”Ÿæˆå®¡æ‰¹å¾…åŠ â†’ ä¸Šçº§å®¡æ ¸ â†’ å®¡æ‰¹é€šè¿‡ â†’ å…³é—­å¾…åŠ

6. ä¸‹æ¬¡ç»´æŠ¤è®¡åˆ’
   ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—ä¸‹æ¬¡ç»´æŠ¤æ—¥æœŸ â†’ ç”Ÿæˆæ–°çš„ç»´æŠ¤è®¡åˆ’

7. è®¾å¤‡ç»Ÿè®¡åˆ†æ
   ç»Ÿè®¡ç»´ä¿æ¬¡æ•°ã€æ•…éšœç‡ã€ç»´ä¿æˆæœ¬ â†’ ç”Ÿæˆåˆ†ææŠ¥è¡¨
```

---

#### 18.2.2 å…³é”®ä¸šåŠ¡åœºæ™¯

**åœºæ™¯ 1: è®¾å¤‡å°è´¦å½•å…¥**
```
1. å·¥ç¨‹éƒ¨å½•å…¥æ–°è®¾å¤‡
   - è®¾å¤‡ç¼–å·: EQ-001
   - è®¾å¤‡åç§°: æ…æ‹ŒæœºA
   - è®¾å¤‡å‹å·: JB-2000
   - åˆ†ç±»: ç”Ÿäº§è®¾å¤‡
   - ä½ç½®: ç”Ÿäº§è½¦é—´1æ¥¼
   - è´­ä¹°æ—¥æœŸ: 2024-01-01
   - å¯ç”¨æ—¥æœŸ: 2024-01-15
   - ç»´æŠ¤å‘¨æœŸ: 30 å¤©
   - æå‰æé†’: 3 å¤©
   - è´£ä»»äºº: å¼ ä¸‰

2. ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—ä¸‹æ¬¡ç»´æŠ¤æ—¥æœŸ
   - ä¸‹æ¬¡ç»´æŠ¤æ—¥æœŸ = å¯ç”¨æ—¥æœŸ + ç»´æŠ¤å‘¨æœŸ = 2024-02-14

3. ç³»ç»Ÿç”Ÿæˆç»´æŠ¤è®¡åˆ’
   - è®¡åˆ’ç¼–å·: MP-20240214-001
   - è®¾å¤‡: æ…æ‹ŒæœºA
   - è®¡åˆ’æ—¥æœŸ: 2024-02-14
   - çŠ¶æ€: å¾…æ‰§è¡Œ
```

**åœºæ™¯ 2: ç»´ä¿æé†’ä¸æ‰§è¡Œï¼ˆç§»åŠ¨ç«¯ï¼‰**
```
1. ç³»ç»Ÿè‡ªåŠ¨æé†’ï¼ˆ2024-02-11ï¼‰
   - è·ç¦»ç»´æŠ¤æ—¥æœŸè¿˜æœ‰ 3 å¤©
   - ç”Ÿæˆå¾…åŠä»»åŠ¡ï¼ˆTodoTaskï¼‰
   - å‘é€å¾®ä¿¡é€šçŸ¥ç»™å¼ ä¸‰

2. å¼ ä¸‰æ”¶åˆ°é€šçŸ¥ï¼ˆå¾®ä¿¡å°ç¨‹åºï¼‰
   - æŸ¥çœ‹å¾…åŠä»»åŠ¡
   - ç‚¹å‡»"å¼€å§‹ç»´ä¿"

3. ç°åœºç»´ä¿ï¼ˆç§»åŠ¨ç«¯å¡«å†™ï¼‰
   - è®¾å¤‡ç¼–å·: EQ-001ï¼ˆè‡ªåŠ¨å¸¦å‡ºï¼‰
   - è®¾å¤‡åç§°: æ…æ‹ŒæœºAï¼ˆè‡ªåŠ¨å¸¦å‡ºï¼‰
   - ç»´ä¿æ—¥æœŸ: 2024-02-14ï¼ˆé»˜è®¤ä»Šå¤©ï¼‰
   - ç»´ä¿ç±»å‹: æ—¥å¸¸ä¿å…»
   - ç»´ä¿å†…å®¹: æ¸…æ´æ…æ‹Œå¶ç‰‡ã€æ£€æŸ¥è½´æ‰¿ã€åŠ æ¶¦æ»‘æ²¹
   - ç»´ä¿å‰çŠ¶æ€: æ­£å¸¸
   - ç»´ä¿åçŠ¶æ€: æ­£å¸¸
   - ç°åœºç…§ç‰‡: [æ‹ç…§ä¸Šä¼  3 å¼ ]
   - æ›´æ¢é›¶ä»¶: æ— 
   - ç»´ä¿äººå‘˜ç­¾å: [æ‰‹å†™ç­¾å­—æ¿ç­¾å]

4. æäº¤ç»´ä¿è®°å½•
   - ç”Ÿæˆè®°å½•ç¼–å·: MAINT-20240214-001
   - çŠ¶æ€: å¾…å®¡æ‰¹
   - ç”Ÿæˆå®¡æ‰¹å¾…åŠä»»åŠ¡ç»™å·¥ç¨‹éƒ¨ç»ç†

5. ç¦»çº¿å¡«å†™ï¼ˆå¯é€‰ï¼‰
   - å¦‚æœç°åœºæ— ç½‘ç»œï¼Œæ•°æ®å­˜å‚¨åˆ°æœ¬åœ°
   - è”ç½‘åè‡ªåŠ¨åŒæ­¥åˆ°æœåŠ¡å™¨
```

**åœºæ™¯ 3: ç»´ä¿è®°å½•å®¡æ‰¹**
```
1. å·¥ç¨‹éƒ¨ç»ç†æ”¶åˆ°å®¡æ‰¹å¾…åŠ
   - æŸ¥çœ‹ç»´ä¿è®°å½•è¯¦æƒ…ï¼ˆPC æˆ–ç§»åŠ¨ç«¯ï¼‰
   - æŸ¥çœ‹ç°åœºç…§ç‰‡
   - æŸ¥çœ‹ç»´ä¿äººå‘˜ç­¾å

2. å®¡æ‰¹é€šè¿‡
   - å®¡æ‰¹æ„è§: ç»´ä¿è®°å½•å®Œæ•´ï¼Œé€šè¿‡
   - å®¡æ‰¹äººç­¾å: [æ‰‹å†™ç­¾å­—æ¿ç­¾å]

3. ç³»ç»Ÿè‡ªåŠ¨å¤„ç†
   - ç»´ä¿è®°å½•çŠ¶æ€: å·²å®¡æ‰¹
   - å…³é—­ç»´ä¿å¾…åŠä»»åŠ¡
   - è®¡ç®—ä¸‹æ¬¡ç»´æŠ¤æ—¥æœŸ: 2024-03-15
   - ç”Ÿæˆä¸‹æ¬¡ç»´æŠ¤è®¡åˆ’
```

**åœºæ™¯ 4: æ—¥å†è§†å›¾æŸ¥çœ‹**
```
å·¥ç¨‹éƒ¨ç»ç†æ‰“å¼€æ—¥å†è§†å›¾:

2024 å¹´ 2 æœˆ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘¨æ—¥ å‘¨ä¸€ å‘¨äºŒ å‘¨ä¸‰ å‘¨å›› å‘¨äº” å‘¨å…­     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  28   29   30   31    1    2    3   â”‚
â”‚                       ğŸ”§  ğŸ”§        â”‚
â”‚   4    5    6    7    8    9   10   â”‚
â”‚  ğŸ”§              ğŸ”§                  â”‚
â”‚  11   12   13   14   15   16   17   â”‚
â”‚             ğŸ”§  ğŸ”§                   â”‚
â”‚  18   19   20   21   22   23   24   â”‚
â”‚                                      â”‚
â”‚  25   26   27   28   29              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å›¾ä¾‹:
ğŸ”§ = ç»´æŠ¤è®¡åˆ’

ç‚¹å‡»æŸä¸€å¤©:
- æ˜¾ç¤ºå½“å¤©æ‰€æœ‰ç»´æŠ¤è®¡åˆ’
- æ…æ‹ŒæœºAï¼ˆæ—¥å¸¸ä¿å…»ï¼‰
- çƒ¤ç®±Bï¼ˆå¹´åº¦æ£€ä¿®ï¼‰
- åŒ…è£…æœºCï¼ˆæ•…éšœç»´ä¿®ï¼‰
```

---

### 18.3 æ•°æ®æ¨¡å‹è®¾è®¡

#### 18.3.1 æ ¸å¿ƒæ•°æ®è¡¨(4 ä¸ª)

```prisma
// ==================== è®¾å¤‡ç®¡ç† ====================

// 1. è®¾å¤‡å°è´¦è¡¨
model Equipment {
  id                String   @id @default(cuid())
  code              String   @unique     // è®¾å¤‡ç¼–å·
  name              String              // è®¾å¤‡åç§°
  model             String?             // è®¾å¤‡å‹å·
  category          String              // åˆ†ç±»ï¼ˆç”Ÿäº§è®¾å¤‡/æ£€éªŒè®¾å¤‡/è¾…åŠ©è®¾å¤‡ï¼‰
  location          String?             // ä½ç½®ï¼ˆè½¦é—´/æ¥¼å±‚ï¼‰
  purchaseDate      DateTime?           // è´­ä¹°æ—¥æœŸ
  commissionDate    DateTime?           // å¯ç”¨æ—¥æœŸ
  status            String   @default("active") // active | inactive | scrapped

  // ============ åˆ†çº§ä¿å…»é…ç½®ï¼ˆæ–°å¢ï¼‰============
  maintenanceConfig Json?               // ä¿å…»é…ç½® JSONï¼Œç¤ºä¾‹ï¼š
                                        // {
                                        //   "daily": { "enabled": true, "cycle": 1, "reminderDays": 0 },
                                        //   "weekly": { "enabled": true, "cycle": 7, "reminderDays": 1 },
                                        //   "monthly": { "enabled": true, "cycle": 30, "reminderDays": 3 },
                                        //   "quarterly": { "enabled": false, "cycle": 90, "reminderDays": 7 },
                                        //   "annual": { "enabled": true, "cycle": 365, "reminderDays": 14 }
                                        // }

  responsiblePerson String?             // è´£ä»»äºº ID
  responsibleName   String?             // è´£ä»»äººå§“å
  manufacturer      String?             // åˆ¶é€ å•†
  serialNumber      String?             // åºåˆ—å·
  warrantyExpiry    DateTime?           // ä¿ä¿®åˆ°æœŸæ—¥æœŸ
  remark            String?             // å¤‡æ³¨
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // å…³è”
  maintenanceRecords MaintenanceRecord[] // ç»´ä¿è®°å½•
  maintenancePlans   MaintenancePlan[]   // ç»´æŠ¤è®¡åˆ’
  faults             EquipmentFault[]    // æŠ¥ä¿®å•ï¼ˆæ–°å¢ï¼‰

  @@map("equipment")
}

// 2. ç»´æŠ¤è®¡åˆ’è¡¨ï¼ˆæ”¯æŒåˆ†çº§ä¿å…»ï¼‰
model MaintenancePlan {
  id                String   @id @default(cuid())
  planNumber        String   @unique     // è®¡åˆ’ç¼–å·
  equipmentId       String              // è®¾å¤‡ ID
  equipmentCode     String              // è®¾å¤‡ç¼–å·ï¼ˆå†—ä½™ï¼‰
  equipmentName     String              // è®¾å¤‡åç§°ï¼ˆå†—ä½™ï¼‰
  plannedDate       DateTime            // è®¡åˆ’ç»´æŠ¤æ—¥æœŸ

  // ============ åˆ†çº§ä¿å…»å­—æ®µï¼ˆæ–°å¢ï¼‰============
  maintenanceLevel  String              // ä¿å…»çº§åˆ«ï¼šdaily | weekly | monthly | quarterly | annual

  maintenanceType   String   @default("routine") // routine | repair | annual
  status            String   @default("pending") // pending | in_progress | completed | cancelled
  responsiblePerson String?             // è´£ä»»äºº ID
  responsibleName   String?             // è´£ä»»äººå§“å
  reminderDays      Int      @default(3) // æå‰æé†’å¤©æ•°ï¼ˆä¸åŒçº§åˆ«ä¸åŒï¼‰
  reminderSent      Boolean  @default(false) // æ˜¯å¦å·²å‘é€æé†’
  todoTaskId        String?             // å¾…åŠä»»åŠ¡ ID
  completedAt       DateTime?           // å®Œæˆæ—¶é—´
  remark            String?             // å¤‡æ³¨
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // å…³è”
  equipment         Equipment @relation(fields: [equipmentId], references: [id])

  @@index([equipmentId])
  @@index([maintenanceLevel])
  @@index([plannedDate])
  @@map("maintenance_plans")
}

// 3. ç»´ä¿è®°å½•è¡¨ï¼ˆå››çº§è®°å½•æ–‡ä»¶ï¼‰
model MaintenanceRecord {
  id                  String   @id @default(cuid())
  recordNumber        String   @unique     // è®°å½•ç¼–å·
  equipmentId         String              // è®¾å¤‡ ID
  equipmentCode       String              // è®¾å¤‡ç¼–å·ï¼ˆå†—ä½™ï¼‰
  equipmentName       String              // è®¾å¤‡åç§°ï¼ˆå†—ä½™ï¼‰
  maintenanceDate     DateTime            // ç»´ä¿æ—¥æœŸ

  // ============ åˆ†çº§ä¿å…»å­—æ®µï¼ˆæ–°å¢ï¼‰============
  maintenanceLevel    String?             // ä¿å…»çº§åˆ«ï¼šdaily | weekly | monthly | quarterly | annual

  maintenanceType     String              // ç±»å‹ï¼ˆæ—¥å¸¸ä¿å…»/æ•…éšœç»´ä¿®/å¹´åº¦æ£€ä¿®ï¼‰
  maintenanceContent  String              // ç»´ä¿å†…å®¹
  statusBefore        String?             // ç»´ä¿å‰çŠ¶æ€
  statusAfter         String?             // ç»´ä¿åçŠ¶æ€
  replacedParts       String?             // æ›´æ¢çš„é›¶ä»¶
  photos              Json?               // ç°åœºç…§ç‰‡ï¼ˆæ•°ç»„ï¼‰
  maintenancePerson   String              // ç»´ä¿äººå‘˜ ID
  maintenancePersonName String            // ç»´ä¿äººå‘˜å§“å
  maintenancePersonSignature String?     // ç»´ä¿äººå‘˜ç­¾åï¼ˆå›¾ç‰‡ URLï¼‰
  reviewer            String?             // å®¡æ ¸äººå‘˜ ID
  reviewerName        String?             // å®¡æ ¸äººå‘˜å§“å
  reviewerSignature   String?             // å®¡æ ¸äººå‘˜ç­¾åï¼ˆå›¾ç‰‡ URLï¼‰
  reviewDate          DateTime?           // å®¡æ ¸æ—¥æœŸ
  reviewComment       String?             // å®¡æ ¸æ„è§
  status              String   @default("draft") // draft | submitted | approved | rejected
  workflowId          String?             // å·¥ä½œæµå®ä¾‹ ID
  nextMaintenanceDate DateTime?           // ä¸‹æ¬¡ç»´ä¿æ—¥æœŸ
  cost                Float?              // ç»´ä¿æˆæœ¬
  duration            Int?                // ç»´ä¿è€—æ—¶ï¼ˆåˆ†é’Ÿï¼‰
  remark              String?             // å¤‡æ³¨
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // å…³è”
  equipment           Equipment @relation(fields: [equipmentId], references: [id])

  @@index([equipmentId])
  @@index([maintenanceLevel])
  @@map("maintenance_records")
}

// 4. è®¾å¤‡æŠ¥ä¿®å•è¡¨ï¼ˆæ–°å¢ï¼‰
model EquipmentFault {
  id                String   @id @default(cuid())
  faultNumber       String   @unique           // æŠ¥ä¿®å•å·ï¼Œæ ¼å¼ï¼šFR-{YYYYMMDD}-{åºå·}
  equipmentId       String                     // è®¾å¤‡ ID
  equipmentCode     String                     // è®¾å¤‡ç¼–å·ï¼ˆå†—ä½™ï¼‰
  equipmentName     String                     // è®¾å¤‡åç§°ï¼ˆå†—ä½™ï¼‰
  location          String                     // æŠ¥ä¿®åŒºåŸŸï¼ˆè½¦é—´/æ¥¼å±‚ï¼‰

  // ============ æŠ¥ä¿®ä¿¡æ¯ ============
  reporterId        String                     // æŠ¥ä¿®äºº ID
  reporterName      String                     // æŠ¥ä¿®äººå§“å
  reportTime        DateTime @default(now())   // æŠ¥ä¿®æ—¶é—´
  faultDescription  String                     // æ•…éšœæè¿°
  urgencyLevel      String   @default("normal") // ç´§æ€¥ç¨‹åº¦ï¼šurgent(ç´§æ€¥) | normal(ä¸€èˆ¬) | low(ä½)

  // ============ ç»´ä¿®ä¿¡æ¯ ============
  status            String   @default("pending") // pending(å¾…å¤„ç†) | in_progress(å¤„ç†ä¸­) | completed(å·²å®Œæˆ) | cancelled(å·²å–æ¶ˆ)
  assignedTo        String?                     // æŒ‡æ´¾ç»™ï¼ˆå·¥ç¨‹éƒ¨äººå‘˜ IDï¼‰
  assignedToName    String?                     // æŒ‡æ´¾ç»™ï¼ˆå·¥ç¨‹éƒ¨äººå‘˜å§“åï¼‰
  acceptedAt        DateTime?                   // æ¥å•æ—¶é—´

  // ============ ç»´ä¿®è®°å½•ï¼ˆå®Œæˆæ—¶å¡«å†™ï¼‰============
  faultCause        String?                     // æ•…éšœåŸå› 
  repairMeasure     String?                     // å¤„ç†æªæ–½
  photos            Json?                       // ç°åœºç…§ç‰‡ï¼ˆæ•°ç»„ï¼‰
  repairPerson      String?                     // ç»´ä¿®äººå‘˜ ID
  repairPersonName  String?                     // ç»´ä¿®äººå‘˜å§“å
  repairSignature   String?                     // ç»´ä¿®äººå‘˜ç­¾åï¼ˆå›¾ç‰‡ URLï¼‰
  completedAt       DateTime?                   // å®Œæˆæ—¶é—´
  duration          Int?                        // ç»´ä¿®è€—æ—¶ï¼ˆåˆ†é’Ÿï¼‰

  // ============ å¾…åŠä»»åŠ¡ ============
  todoTaskId        String?                     // å¾…åŠä»»åŠ¡ ID

  remark            String?                     // å¤‡æ³¨
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // å…³è”
  equipment         Equipment @relation(fields: [equipmentId], references: [id])

  @@index([equipmentId])
  @@index([reporterId])
  @@index([status])
  @@index([urgencyLevel])
  @@index([reportTime])
  @@map("equipment_faults")
}
```

---

#### 18.3.2 æ•°æ®è¡¨å…³ç³»å›¾

```
Equipment (è®¾å¤‡)
  â”œâ”€ MaintenancePlan (ç»´æŠ¤è®¡åˆ’) 1:N  â† æ”¯æŒåˆ†çº§ä¿å…»ï¼ˆä¸€ä¸ªè®¾å¤‡å¤šä¸ªè®¡åˆ’ï¼‰
  â”œâ”€ MaintenanceRecord (ç»´ä¿è®°å½•) 1:N
  â””â”€ EquipmentFault (æŠ¥ä¿®å•) 1:N  â† æ–°å¢

æ ¸å¿ƒé€»è¾‘:
1. è®¾å¤‡å¯ç”¨åï¼Œæ ¹æ® maintenanceConfig è‡ªåŠ¨ç”Ÿæˆå¤šä¸ªç»´æŠ¤è®¡åˆ’ï¼ˆæ—¥/å‘¨/æœˆ/å­£/å¹´ï¼‰
2. ç»´ä¿è®°å½•æäº¤åï¼Œç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆè¯¥çº§åˆ«çš„ä¸‹æ¬¡ç»´æŠ¤è®¡åˆ’
3. ç»´æŠ¤è®¡åˆ’åˆ°æœŸå‰ N å¤©ï¼Œç”Ÿæˆå¾…åŠä»»åŠ¡ï¼ˆä¸åŒçº§åˆ«æé†’å¤©æ•°ä¸åŒï¼‰
4. ç»´ä¿è®°å½•å®¡æ‰¹é€šè¿‡åï¼Œå…³é—­å¾…åŠä»»åŠ¡
5. å‘˜å·¥å‘èµ·æŠ¥ä¿®åï¼Œè‡ªåŠ¨ç”Ÿæˆå¾…åŠä»»åŠ¡ç»™å·¥ç¨‹éƒ¨
6. å·¥ç¨‹éƒ¨å®Œæˆç»´ä¿®åï¼Œå…³é—­æŠ¥ä¿®å•å’Œå¾…åŠä»»åŠ¡
```

---

### 18.4 ä¸šåŠ¡è§„åˆ™(BR-181 ~ BR-210, å…± 30 æ¡)

#### 18.4.1 è®¾å¤‡å°è´¦è§„åˆ™(BR-181 ~ BR-190)

| ç¼–å· | è§„åˆ™ | å®ç°æ–¹å¼ |
|------|------|----------|
| BR-181 | **è®¾å¤‡ç¼–å·å”¯ä¸€**: æ¯ä¸ªè®¾å¤‡çš„ code å¿…é¡»å”¯ä¸€ | `Equipment.code @unique` |
| BR-182 | **è®¾å¤‡åˆ†ç±»**: ç”Ÿäº§è®¾å¤‡/æ£€éªŒè®¾å¤‡/è¾…åŠ©è®¾å¤‡ | `Equipment.category` æšä¸¾ |
| BR-183 | **è®¾å¤‡çŠ¶æ€**: active(å¯ç”¨) / inactive(åœç”¨) / scrapped(æŠ¥åºŸ) | `Equipment.status` æšä¸¾ |
| BR-184 | **ç»´æŠ¤å‘¨æœŸ**: æ¯ä¸ªè®¾å¤‡å¯ä»¥æœ‰ä¸åŒçš„ç»´æŠ¤å‘¨æœŸï¼ˆå¤©æ•°ï¼‰ | `Equipment.maintenanceCycle` |
| BR-185 | **æå‰æé†’**: ç”¨æˆ·å¯è‡ªå®šä¹‰æå‰å‡ å¤©æé†’ï¼ˆé»˜è®¤ 3 å¤©ï¼‰ | `Equipment.reminderDays` |
| BR-186 | **ä¸‹æ¬¡ç»´æŠ¤æ—¥æœŸ**: ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—å¹¶æ›´æ–° | è‡ªåŠ¨è®¡ç®—ï¼šä¸Šæ¬¡ç»´æŠ¤æ—¥æœŸ + ç»´æŠ¤å‘¨æœŸ |
| BR-187 | **è´£ä»»äºº**: æ¯ä¸ªè®¾å¤‡å¿…é¡»æŒ‡å®šè´£ä»»äºº | `Equipment.responsiblePerson` |
| BR-188 | **ä¿ä¿®æœŸ**: è®°å½•ä¿ä¿®åˆ°æœŸæ—¥æœŸï¼Œåˆ°æœŸå‰æé†’ | `Equipment.warrantyExpiry` |
| BR-189 | **è®¾å¤‡æŠ¥åºŸ**: æŠ¥åºŸåä¸å†ç”Ÿæˆç»´æŠ¤è®¡åˆ’ | `status = scrapped` æ—¶åœæ­¢ç”Ÿæˆè®¡åˆ’ |
| BR-190 | **è®¾å¤‡ç¼–å·ç”Ÿæˆ**: æ ¼å¼ `EQ-{YYYYMMDD}-{åºå·}` | åç«¯è‡ªåŠ¨ç”Ÿæˆ |

---

#### 18.4.2 åˆ†çº§ä¿å…»è§„åˆ™(BR-191 ~ BR-200ï¼Œæ–°å¢)

| ç¼–å· | è§„åˆ™ | å®ç°æ–¹å¼ |
|------|------|----------|
| BR-191 | **ä¿å…»çº§åˆ«å®šä¹‰**: æ—¥ä¿å…»(daily)/å‘¨ä¿å…»(weekly)/æœˆä¿å…»(monthly)/å­£åº¦ä¿å…»(quarterly)/å¹´åº¦ä¿å…»(annual) | `MaintenancePlan.maintenanceLevel` æšä¸¾ |
| BR-192 | **æ—¥ä¿å…»å‘¨æœŸ**: æ¯å¤©ï¼Œå½“å¤©æ—©ä¸Šæé†’ï¼ˆreminderDays=0ï¼‰ | cycle=1, reminderDays=0 |
| BR-193 | **å‘¨ä¿å…»å‘¨æœŸ**: æ¯å‘¨ï¼Œæå‰1å¤©æé†’ | cycle=7, reminderDays=1 |
| BR-194 | **æœˆä¿å…»å‘¨æœŸ**: æ¯æœˆï¼ˆ30å¤©ï¼‰ï¼Œæå‰3å¤©æé†’ | cycle=30, reminderDays=3 |
| BR-195 | **å­£åº¦ä¿å…»å‘¨æœŸ**: æ¯å­£åº¦ï¼ˆ90å¤©ï¼‰ï¼Œæå‰7å¤©æé†’ | cycle=90, reminderDays=7 |
| BR-196 | **å¹´åº¦ä¿å…»å‘¨æœŸ**: æ¯å¹´ï¼ˆ365å¤©ï¼‰ï¼Œæå‰14å¤©æé†’ | cycle=365, reminderDays=14 |
| BR-197 | **å¤šè®¡åˆ’å¹¶è¡Œ**: ä¸€ä¸ªè®¾å¤‡å¯ä»¥åŒæ—¶æœ‰å¤šä¸ªä¸åŒçº§åˆ«çš„ä¿å…»è®¡åˆ’ | MaintenancePlan ä¸€å¯¹å¤šå…³ç³» |
| BR-198 | **ä¿å…»çº§åˆ«å¿…å¡«**: åˆ›å»ºä¿å…»è®¡åˆ’æ—¶å¿…é¡»æŒ‡å®šçº§åˆ« | `MaintenancePlan.maintenanceLevel` éç©º |
| BR-199 | **ä¸‹æ¬¡è®¡åˆ’ç”Ÿæˆ**: å½“å‰çº§åˆ«ä¿å…»å®Œæˆåï¼Œè‡ªåŠ¨ç”Ÿæˆè¯¥çº§åˆ«çš„ä¸‹æ¬¡è®¡åˆ’ | ä¿å…»æ—¥æœŸ + å¯¹åº”çº§åˆ«å‘¨æœŸ |
| BR-200 | **çµæ´»é…ç½®**: ç”¨æˆ·å¯è‡ªå®šä¹‰å¯ç”¨å“ªäº›ä¿å…»çº§åˆ« | `Equipment.maintenanceConfig` JSON |

---

#### 18.4.3 ç»´æŠ¤è®¡åˆ’è§„åˆ™(BR-201 ~ BR-210)

| ç¼–å· | è§„åˆ™ | å®ç°æ–¹å¼ |
|------|------|----------|
| BR-191 | **è‡ªåŠ¨ç”Ÿæˆ**: è®¾å¤‡å¯ç”¨åè‡ªåŠ¨ç”Ÿæˆé¦–æ¬¡ç»´æŠ¤è®¡åˆ’ | å¯ç”¨æ—¥æœŸ + ç»´æŠ¤å‘¨æœŸ |
| BR-192 | **è®¡åˆ’çŠ¶æ€**: pending(å¾…æ‰§è¡Œ) â†’ in_progress(è¿›è¡Œä¸­) â†’ completed(å·²å®Œæˆ) / cancelled(å·²å–æ¶ˆ) | `MaintenancePlan.status` çŠ¶æ€æœº |
| BR-193 | **æé†’æ—¶æœº**: è®¡åˆ’æ—¥æœŸå‰ N å¤©ç”Ÿæˆå¾…åŠä»»åŠ¡ | å®šæ—¶ä»»åŠ¡æ£€æŸ¥ |
| BR-194 | **é€¾æœŸæé†’**: è®¡åˆ’æ—¥æœŸè¿‡åä»æœªå®Œæˆï¼ŒæŒç»­æé†’ | å®šæ—¶ä»»åŠ¡æ£€æŸ¥ |
| BR-195 | **å¾…åŠä»»åŠ¡**: ç”Ÿæˆå¾…åŠä»»åŠ¡æ—¶ï¼Œå…³è” TodoTask | `MaintenancePlan.todoTaskId` |
| BR-196 | **è®¡åˆ’å–æ¶ˆ**: è®¾å¤‡åœç”¨/æŠ¥åºŸæ—¶ï¼Œå–æ¶ˆæœªå®Œæˆçš„ç»´æŠ¤è®¡åˆ’ | æ‰¹é‡æ›´æ–° status = cancelled |
| BR-197 | **è®¡åˆ’è°ƒæ•´**: è´£ä»»äººå¯ä»¥å»¶æœŸç»´æŠ¤è®¡åˆ’ï¼ˆéœ€å®¡æ‰¹ï¼‰ | å·¥ä½œæµé›†æˆ |
| BR-198 | **æ—¥å†è§†å›¾**: ç»´æŠ¤è®¡åˆ’åœ¨æ—¥å†ä¸Šæ˜¾ç¤º | å‰ç«¯æ—¥å†ç»„ä»¶ |
| BR-199 | **çœ‹æ¿è§†å›¾**: ç»´æŠ¤è®¡åˆ’åœ¨çœ‹æ¿ä¸Šæ˜¾ç¤ºï¼ˆå¾…æ‰§è¡Œ/è¿›è¡Œä¸­/å·²å®Œæˆï¼‰ | å‰ç«¯çœ‹æ¿ç»„ä»¶ |
| BR-200 | **è®¡åˆ’ç¼–å·**: æ ¼å¼ `MP-{YYYYMMDD}-{åºå·}` | åç«¯è‡ªåŠ¨ç”Ÿæˆ |

---

#### 18.4.3 ç»´æŠ¤è®¡åˆ’è§„åˆ™(BR-201 ~ BR-210)

| ç¼–å· | è§„åˆ™ | å®ç°æ–¹å¼ |
|------|------|----------|
| BR-201 | **è‡ªåŠ¨ç”Ÿæˆ**: è®¾å¤‡å¯ç”¨åæ ¹æ®é…ç½®è‡ªåŠ¨ç”Ÿæˆå¤šä¸ªä¿å…»è®¡åˆ’ | å¯ç”¨æ—¥æœŸ + å¯¹åº”çº§åˆ«å‘¨æœŸ |
| BR-202 | **è®¡åˆ’çŠ¶æ€**: pending(å¾…æ‰§è¡Œ) â†’ in_progress(è¿›è¡Œä¸­) â†’ completed(å·²å®Œæˆ) / cancelled(å·²å–æ¶ˆ) | `MaintenancePlan.status` çŠ¶æ€æœº |
| BR-203 | **æé†’æ—¶æœº**: è®¡åˆ’æ—¥æœŸå‰ N å¤©ç”Ÿæˆå¾…åŠä»»åŠ¡ï¼ˆä¸åŒçº§åˆ«Nä¸åŒï¼‰ | å®šæ—¶ä»»åŠ¡æ£€æŸ¥ |
| BR-204 | **é€¾æœŸæé†’**: è®¡åˆ’æ—¥æœŸè¿‡åä»æœªå®Œæˆï¼ŒæŒç»­æé†’ | å®šæ—¶ä»»åŠ¡æ£€æŸ¥ |
| BR-205 | **å¾…åŠä»»åŠ¡**: ç”Ÿæˆå¾…åŠä»»åŠ¡æ—¶ï¼Œå…³è” TodoTask | `MaintenancePlan.todoTaskId` |
| BR-206 | **è®¡åˆ’å–æ¶ˆ**: è®¾å¤‡åœç”¨/æŠ¥åºŸæ—¶ï¼Œå–æ¶ˆæœªå®Œæˆçš„ç»´æŠ¤è®¡åˆ’ | æ‰¹é‡æ›´æ–° status = cancelled |
| BR-207 | **è®¡åˆ’è°ƒæ•´**: è´£ä»»äººå¯ä»¥å»¶æœŸç»´æŠ¤è®¡åˆ’ï¼ˆéœ€å®¡æ‰¹ï¼‰ | å·¥ä½œæµé›†æˆ |
| BR-208 | **æ—¥å†è§†å›¾**: ç»´æŠ¤è®¡åˆ’åœ¨æ—¥å†ä¸Šæ˜¾ç¤º | å‰ç«¯æ—¥å†ç»„ä»¶ |
| BR-209 | **çœ‹æ¿è§†å›¾**: ç»´æŠ¤è®¡åˆ’åœ¨çœ‹æ¿ä¸Šæ˜¾ç¤ºï¼ˆå¾…æ‰§è¡Œ/è¿›è¡Œä¸­/å·²å®Œæˆï¼‰ | å‰ç«¯çœ‹æ¿ç»„ä»¶ |
| BR-210 | **è®¡åˆ’ç¼–å·**: æ ¼å¼ `MP-{YYYYMMDD}-{åºå·}` | åç«¯è‡ªåŠ¨ç”Ÿæˆ |

---

#### 18.4.4 ç»´ä¿è®°å½•è§„åˆ™(BR-211 ~ BR-220)

#### 18.4.4 ç»´ä¿è®°å½•è§„åˆ™(BR-211 ~ BR-220)

| ç¼–å· | è§„åˆ™ | å®ç°æ–¹å¼ |
|------|------|----------|
| BR-211 | **è®°å½•çŠ¶æ€**: draft(è‰ç¨¿) â†’ submitted(å·²æäº¤) â†’ approved(å·²å®¡æ‰¹) / rejected(å·²é©³å›) | `MaintenanceRecord.status` çŠ¶æ€æœº |
| BR-212 | **å¿…å¡«å­—æ®µ**: ç»´ä¿æ—¥æœŸã€ç»´ä¿çº§åˆ«ã€ç»´ä¿å†…å®¹ã€ç»´ä¿äººå‘˜ç­¾å | å‰ç«¯æ ¡éªŒ + åç«¯æ ¡éªŒ |
| BR-213 | **ç°åœºæ‹ç…§**: æ”¯æŒä¸Šä¼ å¤šå¼ ç…§ç‰‡ï¼ˆæœ€å¤š 9 å¼ ï¼‰ | `MaintenanceRecord.photos` JSON æ•°ç»„ |
| BR-214 | **ç”µå­ç­¾å**: ç»´ä¿äººå‘˜å’Œå®¡æ ¸äººå‘˜å¿…é¡»ç”µå­ç­¾å | æ‰‹å†™ç­¾å­—æ¿ |
| BR-215 | **å®¡æ‰¹æµç¨‹**: ç»´ä¿è®°å½•æäº¤åï¼Œç”Ÿæˆå®¡æ‰¹å¾…åŠä»»åŠ¡ | å·¥ä½œæµé›†æˆ |
| BR-216 | **å®¡æ‰¹é€šè¿‡**: å®¡æ‰¹é€šè¿‡åï¼Œå…³é—­ç»´ä¿å¾…åŠä»»åŠ¡ï¼Œç”Ÿæˆè¯¥çº§åˆ«çš„ä¸‹æ¬¡ç»´æŠ¤è®¡åˆ’ | è‡ªåŠ¨è§¦å‘ |
| BR-217 | **å®¡æ‰¹é©³å›**: å®¡æ‰¹é©³å›åï¼Œç»´ä¿è®°å½•å›åˆ°è‰ç¨¿çŠ¶æ€ï¼Œå¯ä¿®æ”¹é‡æ–°æäº¤ | çŠ¶æ€å›é€€ |
| BR-218 | **ç¦»çº¿å¡«å†™**: ç§»åŠ¨ç«¯æ”¯æŒç¦»çº¿å¡«å†™ï¼Œè”ç½‘åè‡ªåŠ¨åŒæ­¥ | æœ¬åœ°å­˜å‚¨ + åŒæ­¥é˜Ÿåˆ— |
| BR-219 | **è®°å½•ç¼–å·**: æ ¼å¼ `MAINT-{YYYYMMDD}-{åºå·}` | åç«¯è‡ªåŠ¨ç”Ÿæˆ |
| BR-220 | **è®°å½•æŸ¥è¯¢**: æ”¯æŒæŒ‰è®¾å¤‡/æ—¥æœŸ/çº§åˆ«/ç±»å‹/è´£ä»»äººæŸ¥è¯¢ | æŸ¥è¯¢ API |

---

#### 18.4.5 è®¾å¤‡æŠ¥ä¿®è§„åˆ™(BR-221 ~ BR-230ï¼Œæ–°å¢)

### 18.5 API è®¾è®¡(18 ä¸ªç«¯ç‚¹)

#### 18.5.1 è®¾å¤‡å°è´¦ API(6 ä¸ª)

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | è¯·æ±‚ä½“ | å“åº” |
|------|------|------|--------|------|
| GET | `/api/equipment` | æŸ¥è¯¢è®¾å¤‡åˆ—è¡¨ | `?page=1&limit=20&category=&status=` | `{ items: Equipment[], total: number }` |
| GET | `/api/equipment/:id` | æŸ¥è¯¢è®¾å¤‡è¯¦æƒ… | - | `Equipment` |
| POST | `/api/equipment` | åˆ›å»ºè®¾å¤‡ | `{ code, name, category, ... }` | `Equipment` |
| PUT | `/api/equipment/:id` | æ›´æ–°è®¾å¤‡ | `{ name, location, ... }` | `Equipment` |
| DELETE | `/api/equipment/:id` | åˆ é™¤è®¾å¤‡ | - | `{ success: true }` |
| PUT | `/api/equipment/:id/status` | æ›´æ–°è®¾å¤‡çŠ¶æ€ | `{ status: 'scrapped' }` | `Equipment` |

---

#### 18.5.2 ç»´æŠ¤è®¡åˆ’ API(6 ä¸ª)

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | è¯·æ±‚ä½“ | å“åº” |
|------|------|------|--------|------|
| GET | `/api/maintenance-plans` | æŸ¥è¯¢ç»´æŠ¤è®¡åˆ’åˆ—è¡¨ | `?status=&equipmentId=&startDate=&endDate=` | `MaintenancePlan[]` |
| GET | `/api/maintenance-plans/:id` | æŸ¥è¯¢ç»´æŠ¤è®¡åˆ’è¯¦æƒ… | - | `MaintenancePlan` |
| GET | `/api/maintenance-plans/calendar` | æ—¥å†è§†å›¾æ•°æ® | `?year=2024&month=2` | `{ [date]: MaintenancePlan[] }` |
| POST | `/api/maintenance-plans/:id/start` | å¼€å§‹ç»´ä¿ | - | `{ success: true }` |
| POST | `/api/maintenance-plans/:id/complete` | å®Œæˆç»´ä¿ | - | `{ success: true }` |
| POST | `/api/maintenance-plans/:id/cancel` | å–æ¶ˆç»´ä¿ | `{ reason }` | `{ success: true }` |

---

#### 18.5.3 ç»´ä¿è®°å½• API(6 ä¸ª)

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | è¯·æ±‚ä½“ | å“åº” |
|------|------|------|--------|------|
| GET | `/api/maintenance-records` | æŸ¥è¯¢ç»´ä¿è®°å½•åˆ—è¡¨ | `?status=&equipmentId=&startDate=&endDate=` | `MaintenanceRecord[]` |
| GET | `/api/maintenance-records/:id` | æŸ¥è¯¢ç»´ä¿è®°å½•è¯¦æƒ… | - | `MaintenanceRecord` |
| POST | `/api/maintenance-records` | åˆ›å»ºç»´ä¿è®°å½• | `{ equipmentId, maintenanceDate, ... }` | `MaintenanceRecord` |
| PUT | `/api/maintenance-records/:id` | æ›´æ–°ç»´ä¿è®°å½•ï¼ˆè‰ç¨¿çŠ¶æ€ï¼‰ | `{ maintenanceContent, photos, ... }` | `MaintenanceRecord` |
| POST | `/api/maintenance-records/:id/submit` | æäº¤å®¡æ‰¹ | - | `{ success: true, workflowId }` |
| POST | `/api/maintenance-records/:id/approve` | å®¡æ‰¹é€šè¿‡ | `{ reviewComment, reviewerSignature }` | `{ success: true }` |

---

### 18.6 å‰ç«¯è®¾è®¡(5 ä¸ªé¡µé¢)

#### 18.6.1 PC ç«¯é¡µé¢åˆ—è¡¨

| é¡µé¢è·¯å¾„ | é¡µé¢åç§° | åŠŸèƒ½ |
|---------|---------|------|
| `/equipment/list` | è®¾å¤‡å°è´¦åˆ—è¡¨ | è®¾å¤‡åˆ—è¡¨ã€æ–°å¢ã€ç¼–è¾‘ã€åˆ é™¤ã€çŠ¶æ€ç®¡ç† |
| `/equipment/detail/:id` | è®¾å¤‡è¯¦æƒ… | æŸ¥çœ‹è®¾å¤‡è¯¦æƒ…ã€ç»´ä¿å†å²ã€ç»´æŠ¤è®¡åˆ’ |
| `/maintenance/plans` | ç»´æŠ¤è®¡åˆ’åˆ—è¡¨ | ç»´æŠ¤è®¡åˆ’åˆ—è¡¨ã€ç­›é€‰ã€å¼€å§‹/å®Œæˆ/å–æ¶ˆ |
| `/maintenance/calendar` | ç»´æŠ¤è®¡åˆ’æ—¥å† | æ—¥å†è§†å›¾ã€ç‚¹å‡»æŸ¥çœ‹å½“å¤©è®¡åˆ’ |
| `/maintenance/records` | ç»´ä¿è®°å½•åˆ—è¡¨ | ç»´ä¿è®°å½•åˆ—è¡¨ã€æŸ¥è¯¢ã€æŸ¥çœ‹è¯¦æƒ…ã€å®¡æ‰¹ |

---

#### 18.6.2 ç§»åŠ¨ç«¯é¡µé¢åˆ—è¡¨ï¼ˆuniappï¼‰

| é¡µé¢è·¯å¾„ | é¡µé¢åç§° | åŠŸèƒ½ |
|---------|---------|------|
| `/pages/equipment/list` | è®¾å¤‡åˆ—è¡¨ | æŸ¥çœ‹è®¾å¤‡åˆ—è¡¨ã€æœç´¢ |
| `/pages/equipment/detail` | è®¾å¤‡è¯¦æƒ… | æŸ¥çœ‹è®¾å¤‡è¯¦æƒ…ã€æ‰«ç è¯†åˆ« |
| `/pages/maintenance/todo` | ç»´ä¿å¾…åŠ | æŸ¥çœ‹ç»´ä¿å¾…åŠã€å¼€å§‹ç»´ä¿ |
| `/pages/maintenance/create` | å¡«å†™ç»´ä¿è®°å½• | åœ¨çº¿å¡«å†™ã€æ‹ç…§ã€ç­¾å |
| `/pages/maintenance/calendar` | ç»´æŠ¤è®¡åˆ’æ—¥å† | æ—¥å†è§†å›¾ã€ç‚¹å‡»æŸ¥çœ‹ |

---

### 18.7 å¼€å‘å·¥ä½œé‡ä¼°ç®—

#### 18.7.1 åç«¯å¼€å‘(2 å‘¨)

| æ¨¡å— | å·¥ä½œé‡ | è¯´æ˜ |
|------|--------|------|
| **è®¾å¤‡å°è´¦ç®¡ç†** | 3 å¤© | Equipment CRUD + çŠ¶æ€ç®¡ç† |
| **ç»´æŠ¤è®¡åˆ’ç®¡ç†** | 3 å¤© | è‡ªåŠ¨ç”Ÿæˆè®¡åˆ’ + å®šæ—¶ä»»åŠ¡ + å¾…åŠé›†æˆ |
| **ç»´ä¿è®°å½•ç®¡ç†** | 3 å¤© | ç»´ä¿è®°å½• CRUD + å®¡æ‰¹é›†æˆ |
| **API å¼€å‘** | 2 å¤© | æ—¥å†è§†å›¾ API + ç»Ÿè®¡ API |
| **å•å…ƒæµ‹è¯•** | 1 å¤© | æ ¸å¿ƒä¸šåŠ¡é€»è¾‘æµ‹è¯• |

**åç«¯åˆè®¡: 2 å‘¨**

---

#### 18.7.2 å‰ç«¯å¼€å‘(3 å‘¨)

| æ¨¡å— | å·¥ä½œé‡ | è¯´æ˜ |
|------|--------|------|
| **PC ç«¯é¡µé¢** | 1.5 å‘¨ | è®¾å¤‡åˆ—è¡¨/è¯¦æƒ…ã€ç»´æŠ¤è®¡åˆ’ã€æ—¥å†è§†å›¾ |
| **ç§»åŠ¨ç«¯é¡µé¢ï¼ˆuniappï¼‰** | 1 å‘¨ | è®¾å¤‡åˆ—è¡¨ã€ç»´ä¿å¡«å†™ã€æ‹ç…§ç­¾å |
| **E2E æµ‹è¯•** | 0.5 å‘¨ | å…³é”®æµç¨‹æµ‹è¯• |

**å‰ç«¯åˆè®¡: 3 å‘¨**

---

#### 18.7.3 æ€»å·¥ä½œé‡

| é˜¶æ®µ | å·¥ä½œé‡ | è¯´æ˜ |
|------|--------|------|
| **åç«¯å¼€å‘** | 2 å‘¨ | åŒ…å«å•å…ƒæµ‹è¯• |
| **å‰ç«¯å¼€å‘ï¼ˆPC + ç§»åŠ¨ç«¯ï¼‰** | 3 å‘¨ | åŒ…å« E2E æµ‹è¯• |
| **è”è°ƒæµ‹è¯•** | 0.5 å‘¨ | å‰åç«¯ + ç§»åŠ¨ç«¯è”è°ƒ |
| **æ–‡æ¡£ç¼–å†™** | 0.5 å‘¨ | API æ–‡æ¡£ã€ç”¨æˆ·æ‰‹å†Œ |

**æ€»è®¡: 6 å‘¨**

**å¹¶è¡Œå¼€å‘**(1 ååç«¯ + 1 åå‰ç«¯): **çº¦ 3 å‘¨**

---

### 18.8 ä¾èµ–ä¸é£é™©

#### 18.8.1 æŠ€æœ¯ä¾èµ–

| ä¾èµ–é¡¹ | ç‰ˆæœ¬ | ç”¨é€” | é£é™©ç­‰çº§ |
|--------|------|------|----------|
| **TodoTask ç³»ç»Ÿ** | å·²å®Œæˆ(Chapter 15) | ç»´ä¿å¾…åŠä»»åŠ¡ | ä½ |
| **v2.0.0 å·¥ä½œæµå¼•æ“** | å·²å®Œæˆ(Chapter 14) | ç»´ä¿è®°å½•å®¡æ‰¹æµç¨‹ | ä½ |
| **uniapp** | æœ€æ–°ç‰ˆ | ç§»åŠ¨ç«¯è·¨å¹³å°å¼€å‘ | ä½ |
| **å®šæ—¶ä»»åŠ¡** | node-cron | ç»´æŠ¤è®¡åˆ’æé†’ | ä½ |

**å…³é”®ä¾èµ–**:
- âœ… TodoTaskã€v2.0.0 å·¥ä½œæµå·²å°±ç»ª
- âœ… uniapp ç¤¾åŒºæˆç†Ÿï¼Œé£é™©ä½

---

#### 18.8.2 ä¸šåŠ¡é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| **ç»´ä¿è®°å½•é—æ¼** | è®¾å¤‡ç»´æŠ¤ä¸åŠæ—¶ | ä¸­ | å¤šæ¬¡æé†’ã€é€¾æœŸå‡çº§é€šçŸ¥ |
| **ç¦»çº¿åŒæ­¥å¤±è´¥** | æ•°æ®ä¸¢å¤± | ä½ | æœ¬åœ°æŒä¹…åŒ–å­˜å‚¨ã€åŒæ­¥é˜Ÿåˆ—é‡è¯• |
| **æ‹ç…§å¤±è´¥** | ç°åœºç…§ç‰‡ç¼ºå¤± | ä½ | æ”¯æŒåç»­è¡¥å……ç…§ç‰‡ |
| **ç”µå­ç­¾åä¸è§„èŒƒ** | å®¡è®¡é—®é¢˜ | ä¸­ | å¼ºåˆ¶ç­¾åã€ç­¾åé¢„è§ˆç¡®è®¤ |

---

#### 18.4.5 è®¾å¤‡æŠ¥ä¿®è§„åˆ™(BR-221 ~ BR-230ï¼Œæ–°å¢)

| ç¼–å· | è§„åˆ™ | å®ç°æ–¹å¼ |
|------|------|----------|
| BR-221 | **æ‰€æœ‰å‘˜å·¥å¯å‘èµ·æŠ¥ä¿®**: ä»»ä½•å‘˜å·¥éƒ½å¯ä»¥æäº¤è®¾å¤‡æŠ¥ä¿®å• | å‰ç«¯æƒé™æ§åˆ¶ + API æƒé™æ£€æŸ¥ |
| BR-222 | **æŠ¥ä¿®å•å·è‡ªåŠ¨ç”Ÿæˆ**: æ ¼å¼ `FR-{YYYYMMDD}-{åºå·}` | åç«¯è‡ªåŠ¨ç”Ÿæˆ |
| BR-223 | **è‡ªåŠ¨ç”Ÿæˆå¾…åŠä»»åŠ¡**: æŠ¥ä¿®å•æäº¤åï¼Œè‡ªåŠ¨ä¸ºå·¥ç¨‹éƒ¨ç”Ÿæˆå¾…åŠ | TodoTask é›†æˆ |
| BR-224 | **ç´§æ€¥æŠ¥ä¿®ä¼˜å…ˆçº§é«˜**: urgent çº§åˆ«çš„æŠ¥ä¿®å•ä¼˜å…ˆæ˜¾ç¤º | å¾…åŠä»»åŠ¡ä¼˜å…ˆçº§è®¾ç½® |
| BR-225 | **æ¥å•åçŠ¶æ€å˜æ›´**: å·¥ç¨‹éƒ¨äººå‘˜æ¥å•åï¼ŒçŠ¶æ€å˜ä¸º in_progress | çŠ¶æ€æœº |
| BR-226 | **å®Œæˆç»´ä¿®åå…³é—­å¾…åŠ**: æäº¤å®Œæˆå·¥å•åï¼Œå…³é—­å¯¹åº”çš„å¾…åŠä»»åŠ¡ | TodoTask çŠ¶æ€æ›´æ–° |
| BR-227 | **ç§»åŠ¨ç«¯æ”¯æŒ**: å·¥ç¨‹éƒ¨äººå‘˜å¯åœ¨ç§»åŠ¨ç«¯å¡«å†™ç»´ä¿®è®°å½•ã€æ‹ç…§ã€ç­¾å | uniapp ç§»åŠ¨ç«¯ |
| BR-228 | **æŠ¥ä¿®å•ä¸å¯åˆ é™¤**: åªèƒ½å–æ¶ˆï¼Œä¿ç•™å†å²è®°å½• | è½¯åˆ é™¤æˆ–çŠ¶æ€æ ‡è®° |
| BR-229 | **æŠ¥ä¿®ç»Ÿè®¡**: ç»Ÿè®¡æ¯æœˆæŠ¥ä¿®æ¬¡æ•°ã€å¹³å‡å“åº”æ—¶é—´ã€å®Œæˆç‡ | å®šæ—¶ä»»åŠ¡ + ç»Ÿè®¡ API |
| BR-230 | **åŒºåŸŸè®¾å¤‡è”åŠ¨**: é€‰æ‹©åŒºåŸŸåï¼Œè‡ªåŠ¨è¿‡æ»¤è¯¥åŒºåŸŸçš„è®¾å¤‡ | å‰ç«¯è”åŠ¨ + Equipment.location |

---

### 18.5è¡¥. è®¾å¤‡æŠ¥ä¿® API(8 ä¸ªï¼Œæ–°å¢)

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | è¯·æ±‚ä½“ | å“åº” |
|------|------|------|--------|------|
| POST | `/api/equipment/faults` | å‘èµ·æŠ¥ä¿®ï¼ˆæ‰€æœ‰å‘˜å·¥ï¼‰ | `{ equipmentId, location, faultDescription, urgencyLevel }` | `EquipmentFault` |
| GET | `/api/equipment/faults` | æŸ¥è¯¢æŠ¥ä¿®å•åˆ—è¡¨ï¼ˆå·¥ç¨‹éƒ¨ï¼‰ | `?status=&urgencyLevel=&page=1&limit=20` | `{ items: EquipmentFault[], total }` |
| GET | `/api/equipment/faults/my` | æŸ¥è¯¢æˆ‘çš„æŠ¥ä¿®å•ï¼ˆæ™®é€šå‘˜å·¥ï¼‰ | `?page=1&limit=20` | `{ items: EquipmentFault[], total }` |
| GET | `/api/equipment/faults/:id` | æŸ¥è¯¢æŠ¥ä¿®å•è¯¦æƒ… | - | `EquipmentFault` |
| POST | `/api/equipment/faults/:id/accept` | æ¥å•ï¼ˆå·¥ç¨‹éƒ¨äººå‘˜ï¼‰ | `{ assignedTo }` | `{ success: true }` |
| POST | `/api/equipment/faults/:id/complete` | å®Œæˆç»´ä¿®ï¼ˆå·¥ç¨‹éƒ¨ï¼Œç§»åŠ¨ç«¯ï¼‰ | `{ faultCause, repairMeasure, photos, repairSignature, duration }` | `{ success: true }` |
| POST | `/api/equipment/faults/:id/cancel` | å–æ¶ˆæŠ¥ä¿®ï¼ˆæŠ¥ä¿®äººï¼‰ | `{ reason }` | `{ success: true }` |
| GET | `/api/equipment/faults/stats` | æŠ¥ä¿®ç»Ÿè®¡ | `?startDate=&endDate=` | `{ totalFaults, avgResponseTime, completionRate }` |

---

### 18.9 æˆåŠŸæ ‡å‡†

**è®¾å¤‡å°è´¦ç®¡ç†**:
- âœ… æ”¯æŒè®¾å¤‡åˆ†ç±»ã€çŠ¶æ€ç®¡ç†
- âœ… æ”¯æŒåˆ†çº§ä¿å…»é…ç½®ï¼ˆæ—¥/å‘¨/æœˆ/å­£/å¹´ï¼‰

**ç»´æŠ¤è®¡åˆ’ç®¡ç†**:
- âœ… ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆå¤šçº§ä¿å…»è®¡åˆ’
- âœ… ä¸åŒçº§åˆ«æå‰æé†’å¤©æ•°ä¸åŒ
- âœ… æ—¥å†è§†å›¾æ¸…æ™°å±•ç¤ºç»´æŠ¤è®¡åˆ’

**ç»´ä¿è®°å½•ç®¡ç†**:
- âœ… ç§»åŠ¨ç«¯åœ¨çº¿å¡«å†™ï¼ˆæ‹ç…§ã€ç­¾åï¼‰
- âœ… æ”¯æŒç¦»çº¿å¡«å†™ã€è”ç½‘åŒæ­¥
- âœ… å®¡æ‰¹é€šè¿‡åè‡ªåŠ¨å…³é—­å¾…åŠå¹¶ç”Ÿæˆè¯¥çº§åˆ«ä¸‹æ¬¡è®¡åˆ’

**è®¾å¤‡æŠ¥ä¿®åŠŸèƒ½ï¼ˆæ–°å¢ï¼‰**:
- âœ… æ‰€æœ‰å‘˜å·¥å¯å‘èµ·æŠ¥ä¿®
- âœ… é€‰æ‹©åŒºåŸŸè‡ªåŠ¨è¿‡æ»¤è®¾å¤‡
- âœ… è‡ªåŠ¨ç”Ÿæˆå¾…åŠä»»åŠ¡ç»™å·¥ç¨‹éƒ¨
- âœ… å·¥ç¨‹éƒ¨ç§»åŠ¨ç«¯å®Œæˆç»´ä¿®
- âœ… æŠ¥ä¿®ç»Ÿè®¡åˆ†æ

**ç§»åŠ¨ç«¯æ”¯æŒ**:
- âœ… å¾®ä¿¡å°ç¨‹åº + H5 + APP
- âœ… ç°åœºæ‹ç…§ã€ç”µå­ç­¾å
- âœ… ç¦»çº¿å¡«å†™ã€è‡ªåŠ¨åŒæ­¥

---

**æœ¬ç« èŠ‚å®Œæˆ âœ…**


---

## åä¹ã€åŠ¨æ€è¡¨å•å¼•æ“ä¸è®°å½•ç®¡ç†ï¼ˆæ ¸å¿ƒæ¶æ„ï¼‰â­â­â­ Phase A åŸºç¡€è®¾æ–½

[â¬†ï¸ è¿”å›ç›®å½•](#-å®Œæ•´ç›®å½•) | [â¬†ï¸ è¿”å›å¿«é€Ÿå¯¼èˆª](#-å¿«é€Ÿå¯¼èˆª)

> **å»ºè®®ä¸Šçº¿é¡ºåº**: Chapter 15ï¼ˆç¬¬ä¸€ä¼˜å…ˆçº§ï¼Œæ‰€æœ‰ä¸šåŠ¡æ¨¡å—çš„åŸºç¡€ï¼‰
> **ä¼˜å…ˆçº§**: æœ€é«˜ï¼ˆæ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼‰
> **ä¾èµ–**: Chapter 14ï¼ˆå·¥ä½œæµå¼•æ“ï¼‰
> **è¯´æ˜**: æœ¬ç« èŠ‚æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼Œæ‰€æœ‰ä¸šåŠ¡æ¨¡å—ï¼ˆåŸ¹è®­ã€å®¡æ ¸ã€ä»“åº“ã€è®¾å¤‡ã€ç”Ÿäº§ï¼‰çš„è®°å½•ç®¡ç†éƒ½åŸºäºæ­¤åŠ¨æ€è¡¨å•å¼•æ“

> **è®¾è®¡æ—¶é—´**: 2026-02-12
> **ç³»ç»Ÿç‰ˆæœ¬**: v1.0.0 (å®Œæ•´ç‰ˆ)
> **ä¾èµ–ç« èŠ‚**: Chapter 14 (v2.0.0 å·¥ä½œæµå¼•æ“), Chapter 15 (TodoTask)
> **æ ¸å¿ƒå®šä½**: ç»Ÿä¸€çš„å››çº§è®°å½•æ–‡ä»¶ç®¡ç†å¹³å°

---

### 19.1 ç³»ç»Ÿå®šä½ä¸æ ¸å¿ƒä¼˜åŠ¿

#### 19.1.1 ç³»ç»Ÿå®šä½

**åŠ¨æ€è¡¨å•å¼•æ“æ˜¯æ•´ä¸ªæ•°æ®ç”µå­åŒ–å¹³å°çš„æ ¸å¿ƒåŸºç¡€è®¾æ–½**ï¼Œè§£å†³"æ¯å®¶å…¬å¸éœ€æ±‚ä¸åŒã€è®°å½•æ–‡ä»¶ç§ç±»ç¹å¤š"çš„é—®é¢˜ã€‚

**æ ¸å¿ƒèŒè´£**:
1. **è®°å½•æ¨¡æ¿ç®¡ç†**: ç®¡ç†å‘˜å¯è§†åŒ–é…ç½®è®°å½•æ¨¡æ¿ï¼ˆä½ä»£ç ï¼‰
2. **åŠ¨æ€è¡¨å•æ¸²æŸ“**: æ ¹æ®æ¨¡æ¿åŠ¨æ€æ¸²æŸ“è¡¨å•ï¼ˆPC + ç§»åŠ¨ç«¯ï¼‰
3. **è®°å½•å®ä¾‹ç®¡ç†**: ç”¨æˆ·åœ¨çº¿å¡«å†™è®°å½•ï¼Œæ•°æ®åº“å­˜å‚¨
4. **ç»Ÿä¸€æŸ¥è¯¢å¯¼å‡º**: æ‰€æœ‰å››çº§è®°å½•æ–‡ä»¶ç»Ÿä¸€æŸ¥è¯¢/å¯¼å‡º/æ‰“å°
5. **å®¡æ‰¹æµç¨‹é›†æˆ**: è®°å½•æäº¤åè‡ªåŠ¨è§¦å‘å®¡æ‰¹æµç¨‹
6. **PDF å¯¼å‡º**: æŒ‰éœ€å¯¼å‡º PDFï¼ˆå¤–å®¡éœ€è¦ï¼‰

---

#### 19.1.2 æ ¸å¿ƒä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **çµæ´»é…ç½®** | ç®¡ç†å‘˜å¯è‡ªå·±åˆ›å»ºæ–°çš„è®°å½•ç±»å‹ï¼Œä¸éœ€è¦å¼€å‘ |
| **å¤šç«¯ç»Ÿä¸€** | PC + ç§»åŠ¨ç«¯ï¼ˆå°ç¨‹åº/H5/APPï¼‰ç»Ÿä¸€æ¸²æŸ“ |
| **æ•°æ®ç”µå­åŒ–** | æ•°æ®å­˜æ•°æ®åº“ï¼Œä¸æ˜¯ä¸Šä¼  PDF |
| **é€‚åº”å˜åŒ–** | é€‚åº”ä¸åŒå…¬å¸éœ€æ±‚ï¼Œä¸šåŠ¡å˜åŒ–æ— éœ€é‡æ–°å¼€å‘ |
| **å®¡æ‰¹é›†æˆ** | ä¸å·¥ä½œæµå¼•æ“æ— ç¼é›†æˆ |
| **ç§»åŠ¨ç«¯æ”¯æŒ** | ç°åœºå¡«å†™ã€æ‹ç…§ã€ç­¾åã€ç¦»çº¿å¡«å†™ |

---

### 19.2 ä¸šåŠ¡æµç¨‹

#### 19.2.1 æ ¸å¿ƒæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              åŠ¨æ€è¡¨å•å¼•æ“æ ¸å¿ƒæµç¨‹                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. ç®¡ç†å‘˜åˆ›å»ºè®°å½•æ¨¡æ¿
   é€‰æ‹©è®°å½•ç±»å‹ â†’ æ‹–æ‹½å­—æ®µ â†’ é…ç½®å±æ€§ â†’ é…ç½®é€»è¾‘ â†’ ä¿å­˜æ¨¡æ¿

2. ç”¨æˆ·å¡«å†™è®°å½•ï¼ˆPC/ç§»åŠ¨ç«¯ï¼‰
   é€‰æ‹©è®°å½•æ¨¡æ¿ â†’ åŠ¨æ€æ¸²æŸ“è¡¨å• â†’ åœ¨çº¿å¡«å†™ â†’ è‡ªåŠ¨ä¿å­˜è‰ç¨¿

3. æäº¤å®¡æ‰¹ï¼ˆå¯é€‰ï¼‰
   æäº¤è®°å½• â†’ è§¦å‘å®¡æ‰¹æµç¨‹ â†’ ç”Ÿæˆå¾…åŠä»»åŠ¡ â†’ å®¡æ‰¹äººå®¡æ ¸

4. å®¡æ‰¹é€šè¿‡
   è®°å½•çŠ¶æ€æ›´æ–° â†’ å…³é—­å¾…åŠä»»åŠ¡ â†’ å¯å¯¼å‡º PDF

5. ç»Ÿä¸€æŸ¥è¯¢
   æŒ‰éƒ¨é—¨/ç±»å‹/æ—¶é—´ç­›é€‰ â†’ æŸ¥çœ‹è®°å½•è¯¦æƒ… â†’ å¯¼å‡º/æ‰“å°
```

---

#### 19.2.2 å…³é”®ä¸šåŠ¡åœºæ™¯

**åœºæ™¯ 1: ç®¡ç†å‘˜åˆ›å»º"æ¸…æ´æ¶ˆæ¯’è®°å½•"æ¨¡æ¿**
```
1. è¿›å…¥æ¨¡æ¿ç®¡ç†é¡µé¢
   - ç‚¹å‡»"åˆ›å»ºè®°å½•æ¨¡æ¿"

2. åŸºæœ¬ä¿¡æ¯
   - æ¨¡æ¿åç§°: æ¸…æ´æ¶ˆæ¯’è®°å½•
   - åˆ†ç±»: ç”Ÿäº§éƒ¨
   - è®°å½•ç¼–å·å‰ç¼€: CLEAN-
   - æ˜¯å¦éœ€è¦å®¡æ‰¹: æ˜¯

3. æ‹–æ‹½å­—æ®µ
   ä»å­—æ®µåº“æ‹–æ‹½åˆ°è¡¨å•é¢„è§ˆåŒº:
   - æ¸…æ´æ—¥æœŸï¼ˆæ—¥æœŸé€‰æ‹©ï¼‰
   - æ¸…æ´åŒºåŸŸï¼ˆä¸‹æ‹‰é€‰æ‹©: ç”Ÿäº§è½¦é—´/ä»“åº“/åŠå…¬åŒºï¼‰
   - æ¸…æ´äººå‘˜ï¼ˆä¸‹æ‹‰é€‰æ‹©: ä»ç”¨æˆ·è¡¨è·å–ï¼‰
   - æ¸…æ´å†…å®¹ï¼ˆå¤šè¡Œæ–‡æœ¬ï¼‰
   - æ¶ˆæ¯’å‰‚ç±»å‹ï¼ˆä¸‹æ‹‰é€‰æ‹©: 84æ¶ˆæ¯’æ¶²/75%é…’ç²¾/å…¶ä»–ï¼‰
   - æ¶ˆæ¯’æµ“åº¦ï¼ˆæ•°å­—è¾“å…¥ï¼‰
   - ç°åœºç…§ç‰‡ï¼ˆå›¾ç‰‡ä¸Šä¼ ï¼Œæœ€å¤š 5 å¼ ï¼‰
   - æ¸…æ´äººå‘˜ç­¾åï¼ˆç”µå­ç­¾åï¼‰

4. é…ç½®å­—æ®µå±æ€§
   - æ¸…æ´åŒºåŸŸ:
     * å­—æ®µåç§°: area
     * å­—æ®µæ ‡ç­¾: æ¸…æ´åŒºåŸŸ
     * å­—æ®µç±»å‹: ä¸‹æ‹‰é€‰æ‹©
     * æ˜¯å¦å¿…å¡«: æ˜¯
     * é€‰é¡¹: ç”Ÿäº§è½¦é—´ã€ä»“åº“ã€åŠå…¬åŒº

5. é…ç½®å­—æ®µé€»è¾‘ï¼ˆå¯é€‰ï¼‰
   - æ˜¾éšè§„åˆ™:
     å½“"æ¶ˆæ¯’å‰‚ç±»å‹ = å…¶ä»–"æ—¶ï¼Œæ˜¾ç¤º"å…¶ä»–æ¶ˆæ¯’å‰‚åç§°"å­—æ®µ

6. é…ç½®æ‰“å°æ¨¡æ¿
   - é€‰æ‹©æ¨¡æ¿å¸ƒå±€: ä¸¤åˆ—
   - é…ç½®é¡µçœ‰: å…¬å¸ Logo + æ ‡é¢˜
   - é…ç½®é¡µè„š: å®¡æ‰¹äººç­¾å + æ—¥æœŸ

7. ä¿å­˜æ¨¡æ¿
   - æ¨¡æ¿çŠ¶æ€: å¯ç”¨
   - ç”Ÿæˆæ¨¡æ¿ ID
```

**åœºæ™¯ 2: ç”¨æˆ·å¡«å†™"æ¸…æ´æ¶ˆæ¯’è®°å½•"ï¼ˆç§»åŠ¨ç«¯ï¼‰**
```
1. æ‰“å¼€å¾®ä¿¡å°ç¨‹åº
   - é¦–é¡µ â†’ è®°å½•å¡«å†™ â†’ é€‰æ‹©"æ¸…æ´æ¶ˆæ¯’è®°å½•"

2. ç³»ç»ŸåŠ¨æ€æ¸²æŸ“è¡¨å•
   - æ ¹æ®æ¨¡æ¿ formSchema åŠ¨æ€ç”Ÿæˆè¡¨å•

3. ç”¨æˆ·å¡«å†™
   - æ¸…æ´æ—¥æœŸ: 2024-06-15ï¼ˆé»˜è®¤ä»Šå¤©ï¼‰
   - æ¸…æ´åŒºåŸŸ: ç”Ÿäº§è½¦é—´ï¼ˆä¸‹æ‹‰é€‰æ‹©ï¼‰
   - æ¸…æ´äººå‘˜: å¼ ä¸‰ï¼ˆè‡ªåŠ¨å¸¦å‡ºå½“å‰ç”¨æˆ·ï¼‰
   - æ¸…æ´å†…å®¹: æ¸…æ´åœ°é¢ã€å¢™é¢ã€è®¾å¤‡è¡¨é¢
   - æ¶ˆæ¯’å‰‚ç±»å‹: 84æ¶ˆæ¯’æ¶²
   - æ¶ˆæ¯’æµ“åº¦: 500ï¼ˆppmï¼‰
   - ç°åœºç…§ç‰‡: [æ‹ç…§ä¸Šä¼  3 å¼ ]
   - æ¸…æ´äººå‘˜ç­¾å: [æ‰‹å†™ç­¾å­—æ¿ç­¾å]

4. ä¿å­˜è‰ç¨¿
   - æ•°æ®å­˜å‚¨åˆ°æœ¬åœ°ï¼ˆç¦»çº¿ä¹Ÿå¯ä»¥ï¼‰
   - è‡ªåŠ¨ä¿å­˜ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±

5. æäº¤è®°å½•
   - æ ¡éªŒå¿…å¡«å­—æ®µ
   - ä¸Šä¼ åˆ°æœåŠ¡å™¨
   - ç”Ÿæˆè®°å½•ç¼–å·: CLEAN-20240615-001
   - è§¦å‘å®¡æ‰¹æµç¨‹
```

**åœºæ™¯ 3: å®¡æ‰¹äººå®¡æ ¸è®°å½•ï¼ˆPC ç«¯ï¼‰**
```
1. æ”¶åˆ°å®¡æ‰¹å¾…åŠ
   - å¾…åŠåˆ—è¡¨æ˜¾ç¤º: "æ¸…æ´æ¶ˆæ¯’è®°å½•å¾…å®¡æ‰¹"

2. æŸ¥çœ‹è®°å½•è¯¦æƒ…
   - åŠ¨æ€æ¸²æŸ“è®°å½•å†…å®¹ï¼ˆåªè¯»ï¼‰
   - æŸ¥çœ‹ç°åœºç…§ç‰‡ï¼ˆå¤§å›¾é¢„è§ˆï¼‰
   - æŸ¥çœ‹æ¸…æ´äººå‘˜ç­¾å

3. å®¡æ‰¹é€šè¿‡
   - å¡«å†™å®¡æ‰¹æ„è§: æ¸…æ´åˆ°ä½ï¼Œé€šè¿‡
   - å®¡æ‰¹äººç­¾å: [æ‰‹å†™ç­¾å­—æ¿ç­¾å]
   - æäº¤å®¡æ‰¹

4. ç³»ç»Ÿè‡ªåŠ¨å¤„ç†
   - è®°å½•çŠ¶æ€: å·²å®¡æ‰¹
   - å…³é—­å¾…åŠä»»åŠ¡
   - å¯å¯¼å‡º PDF
```

---

### 19.3 æ•°æ®æ¨¡å‹è®¾è®¡

#### 19.3.1 æ ¸å¿ƒæ•°æ®è¡¨(2 ä¸ª)

```prisma
// ==================== åŠ¨æ€è¡¨å•å¼•æ“ ====================

// 1. è®°å½•æ¨¡æ¿è¡¨
model RecordTemplate {
  id              String   @id @default(cuid())
  code            String   @unique     // æ¨¡æ¿ç¼–å·ï¼ˆREC-TPL-001ï¼‰
  name            String              // æ¨¡æ¿åç§°ï¼ˆè®¾å¤‡ç»´ä¿è®°å½•ï¼‰
  category        String              // åˆ†ç±»ï¼ˆå·¥ç¨‹éƒ¨/è´¨é‡éƒ¨/ç”Ÿäº§éƒ¨/ä»“åº“ï¼‰
  description     String?             // æè¿°
  formSchema      Json                // è¡¨å•ç»“æ„ï¼ˆJSON Schemaï¼‰
  printTemplate   Json?               // æ‰“å°æ¨¡æ¿ï¼ˆJSON é…ç½®ï¼‰
  status          String   @default("active") // active | archived
  numberPrefix    String              // è®°å½•ç¼–å·å‰ç¼€ï¼ˆMAINT-ï¼‰
  numberSequence  Int      @default(1) // è®°å½•ç¼–å·åºå·
  approvalRequired Boolean  @default(false) // æ˜¯å¦éœ€è¦å®¡æ‰¹
  workflowConfig  Json?               // å·¥ä½œæµé…ç½®ï¼ˆå®¡æ‰¹äººè§’è‰²ç­‰ï¼‰
  version         String   @default("1.0") // æ¨¡æ¿ç‰ˆæœ¬

  // P0-5 ä¿®å¤ï¼šè®°å½•ä¿ç•™æœŸé™ç®¡ç†
  retentionYears  Int      @default(5) // ä¿ç•™å¹´é™ï¼ˆç”¨æˆ·ä¸šåŠ¡è§„åˆ™ï¼šé»˜è®¤ 5 å¹´ï¼ŒBRCGS æŠ•è¯‰è®°å½• 5 å¹´ï¼‰

  // æ‰¹æ¬¡å…³è”é…ç½®ï¼ˆä¸æ‰¹æ¬¡è¿½æº¯ç³»ç»Ÿé›†æˆï¼Œä»£ç ä¸­å·²å®ç°ï¼‰
  batchLinkEnabled Boolean  @default(false) // æ˜¯å¦å…³è”æ‰¹æ¬¡
  batchLinkType    String?                  // æ‰¹æ¬¡ç±»å‹ï¼ˆmaterial/production/finishedï¼‰
  batchLinkField   String?                  // æ‰¹æ¬¡å…³è”å­—æ®µå

  createdBy       String              // åˆ›å»ºäºº ID
  createdByName   String              // åˆ›å»ºäººå§“å
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // å…³è”
  records         Record[]            // è®°å½•å®ä¾‹

  @@map("record_templates")
}

// 2. è®°å½•å®ä¾‹è¡¨ï¼ˆé€šç”¨ï¼‰
model Record {
  id              String   @id @default(cuid())
  templateId      String              // æ¨¡æ¿ ID
  templateName    String              // æ¨¡æ¿åç§°ï¼ˆå†—ä½™ï¼‰
  recordNumber    String   @unique     // è®°å½•ç¼–å·
  category        String              // åˆ†ç±»ï¼ˆå†—ä½™ï¼Œä¾¿äºæŸ¥è¯¢ï¼‰
  formData        Json                // è¡¨å•æ•°æ®ï¼ˆJSON æ ¼å¼ï¼‰
  status          String   @default("draft") // draft | submitted | approved | rejected | deleted
  workflowId      String?             // å·¥ä½œæµå®ä¾‹ IDï¼ˆå¦‚æœéœ€è¦å®¡æ‰¹ï¼‰
  pdfUrl          String?             // PDF æ–‡ä»¶ URLï¼ˆå¯¼å‡ºåï¼‰

  // ============ æ‰¹æ¬¡å…³è”ï¼ˆä¸æ‰¹æ¬¡è¿½æº¯ç³»ç»Ÿé›†æˆï¼‰============
  relatedBatchType   String?          // "production" | "finished_goods" | "material"
  relatedBatchId     String?          // æ‰¹æ¬¡ ID
  relatedBatchNumber String?          // æ‰¹æ¬¡å·ï¼ˆå†—ä½™ï¼ŒåŠ é€ŸæŸ¥è¯¢ï¼‰

  // ============ é˜²ç¯¡æ”¹æœºåˆ¶ï¼ˆBRCGS åˆè§„è¦æ±‚ï¼‰============
  signatureTimestamp DateTime?        // ç”µå­ç­¾åæ—¶çš„æœåŠ¡å™¨æ—¶é—´ï¼ˆé”å®šï¼‰
  offlineFilled      Boolean @default(false) // æ˜¯å¦ç¦»çº¿å¡«å†™
  syncedAt           DateTime?        // ç¦»çº¿åŒæ­¥æ—¶é—´

  // ============ P0-5 ä¿®å¤ï¼šè®°å½•ä¿ç•™æœŸé™ç®¡ç† ============
  retentionUntil     DateTime?        // ä¿ç•™æˆªæ­¢æ—¥æœŸï¼ˆè®¡ç®—å¾—å‡ºï¼šcreatedAt + retentionYearsï¼‰
  autoArchiveStatus  String @default("active") // active | to_archive | archived

  // ============ å®¡æ‰¹æµç¨‹ ============
  createdBy       String              // åˆ›å»ºäºº ID
  createdByName   String              // åˆ›å»ºäººå§“å
  submittedAt     DateTime?           // æäº¤æ—¶é—´ï¼ˆæœåŠ¡å™¨æ—¶é—´ï¼Œä¸å¯ç¯¡æ”¹ï¼‰
  approver        String?             // å®¡æ‰¹äºº ID
  approverName    String?             // å®¡æ‰¹äººå§“å
  approvedAt      DateTime?           // å®¡æ‰¹æ—¶é—´
  rejectReason    String?             // é©³å›åŸå› 

  // ============ æ—¶é—´æˆ³ï¼ˆæœåŠ¡å™¨æ—¶é—´ï¼Œé˜²ç¯¡æ”¹ï¼‰============
  createdAt       DateTime @default(now()) // æœåŠ¡å™¨æ—¶é—´ï¼Œä¸ä¿¡ä»»å®¢æˆ·ç«¯
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?           // è½¯åˆ é™¤æ—¶é—´

  // ============ å…³è” ============
  template        RecordTemplate @relation(fields: [templateId], references: [id])
  changeLogs      RecordChangeLog[]   // è®°å½•å˜æ›´å†å²ï¼ˆé˜²ç¯¡æ”¹ï¼‰

  @@index([category])
  @@index([status])
  @@index([createdAt])
  @@index([relatedBatchNumber])
  @@index([autoArchiveStatus])  // P0-5 ç´¢å¼•ï¼šç”¨äºå®šæ—¶ä»»åŠ¡æŸ¥è¯¢å¾…å½’æ¡£è®°å½•
  @@map("records")
}

// 3. è®°å½•å˜æ›´å†å²è¡¨ï¼ˆBRCGS åˆè§„ï¼šé˜²ç¯¡æ”¹ï¼‰
model RecordChangeLog {
  id            String   @id @default(cuid())
  recordId      String                        // è®°å½• ID
  fieldName     String                        // ä¿®æ”¹çš„å­—æ®µå
  oldValue      Json                          // åŸå€¼
  newValue      Json                          // æ–°å€¼
  changedBy     String                        // ä¿®æ”¹äºº ID
  changedByName String                        // ä¿®æ”¹äººå§“å
  changedAt     DateTime @default(now())      // ä¿®æ”¹æ—¶é—´ï¼ˆæœåŠ¡å™¨æ—¶é—´ï¼‰
  reason        String?                       // ä¿®æ”¹åŸå› 
  approvedBy    String?                       // æ‰¹å‡†äºº IDï¼ˆä¿®æ”¹å·²å®¡æ‰¹è®°å½•éœ€è¦å®¡æ‰¹ï¼‰
  approvedByName String?                      // æ‰¹å‡†äººå§“å

  // å…³è”
  record        Record @relation(fields: [recordId], references: [id], onDelete: Cascade)

  @@index([recordId])
  @@index([changedAt])
  @@map("record_change_logs")
}
```

---

#### 19.3.2 formSchema å­—æ®µç»“æ„

```typescript
interface FormSchema {
  title: string;            // è¡¨å•æ ‡é¢˜
  description?: string;     // è¡¨å•æè¿°
  layout?: {
    columns?: number;       // åˆ—æ•°ï¼ˆ1/2/3ï¼‰
    labelWidth?: string;    // æ ‡ç­¾å®½åº¦
  };
  fields: FormField[];      // å­—æ®µæ•°ç»„
}

interface FormField {
  name: string;             // å­—æ®µåç§°ï¼ˆå”¯ä¸€ï¼‰
  label: string;            // å­—æ®µæ ‡ç­¾
  type: FieldType;          // å­—æ®µç±»å‹
  required?: boolean;       // æ˜¯å¦å¿…å¡«
  placeholder?: string;     // å ä½ç¬¦
  defaultValue?: any;       // é»˜è®¤å€¼
  
  // æ ¡éªŒè§„åˆ™
  validation?: {
    min?: number;           // æœ€å°å€¼/æœ€å°é•¿åº¦
    max?: number;           // æœ€å¤§å€¼/æœ€å¤§é•¿åº¦
    pattern?: string;       // æ­£åˆ™è¡¨è¾¾å¼
    message?: string;       // é”™è¯¯æç¤º
  };
  
  // æ•°æ®æºï¼ˆä¸‹æ‹‰é€‰æ‹©ï¼‰
  options?: Option[] | string;  // é™æ€é€‰é¡¹ æˆ– åŠ¨æ€æ•°æ®æºåç§°
  
  // æ–‡ä»¶ä¸Šä¼ 
  accept?: string;          // æ¥å—çš„æ–‡ä»¶ç±»å‹
  maxCount?: number;        // æœ€å¤§ä¸Šä¼ æ•°é‡
  maxSize?: number;         // æœ€å¤§æ–‡ä»¶å¤§å°ï¼ˆMBï¼‰
  
  // çº§è”é€‰æ‹©
  cascadeSource?: string;   // çº§è”æ•°æ®æº
  
  // æ˜¾éšè§„åˆ™
  visibleWhen?: {
    field: string;          // ä¾èµ–çš„å­—æ®µ
    operator: '==' | '!=' | '>' | '<' | 'in';
    value: any;             // æ¡ä»¶å€¼
  };
  
  // è”åŠ¨è§„åˆ™
  linkTo?: {
    field: string;          // å…³è”çš„å­—æ®µ
    mapping: string;        // æ˜ å°„å…³ç³»
  };
  
  // è®¡ç®—è§„åˆ™
  computed?: {
    formula: string;        // è®¡ç®—å…¬å¼ï¼ˆä¾‹å¦‚: "fieldA * fieldB"ï¼‰
  };
  
  // å…¶ä»–é…ç½®
  width?: string;           // å­—æ®µå®½åº¦ï¼ˆ1/2/3/4ï¼‰
  readonly?: boolean;       // æ˜¯å¦åªè¯»
  hidden?: boolean;         // æ˜¯å¦éšè—
  remark?: string;          // å­—æ®µè¯´æ˜
}

type FieldType = 
  | 'text'              // æ–‡æœ¬è¾“å…¥
  | 'number'            // æ•°å­—è¾“å…¥
  | 'textarea'          // å¤šè¡Œæ–‡æœ¬
  | 'date'              // æ—¥æœŸé€‰æ‹©
  | 'time'              // æ—¶é—´é€‰æ‹©
  | 'datetime'          // æ—¥æœŸæ—¶é—´
  | 'select'            // ä¸‹æ‹‰å•é€‰
  | 'multiselect'       // ä¸‹æ‹‰å¤šé€‰
  | 'radio'             // å•é€‰æŒ‰é’®
  | 'checkbox'          // å¤šé€‰æ¡†
  | 'cascade'           // çº§è”é€‰æ‹©
  | 'tree'              // æ ‘å½¢é€‰æ‹©
  | 'upload'            // æ–‡ä»¶ä¸Šä¼ 
  | 'image'             // å›¾ç‰‡ä¸Šä¼ 
  | 'signature'         // ç”µå­ç­¾å
  | 'richtext'          // å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
  | 'location'          // åœ°ç†ä½ç½®
  | 'scan'              // æ‰«ç è¾“å…¥
  | 'divider'           // åˆ†å‰²çº¿
  | 'title';            // æ ‡é¢˜

interface Option {
  label: string;        // æ˜¾ç¤ºæ–‡æœ¬
  value: any;           // å€¼
  disabled?: boolean;   // æ˜¯å¦ç¦ç”¨
}
```

---

#### 19.3.3 formSchema å®Œæ•´ç¤ºä¾‹

**ç¤ºä¾‹ 1: è®¾å¤‡ç»´ä¿è®°å½•**

```json
{
  "title": "è®¾å¤‡ç»´ä¿è®°å½•",
  "description": "ç”¨äºè®°å½•è®¾å¤‡ç»´æŠ¤ä¿å…»æƒ…å†µ",
  "layout": {
    "columns": 2,
    "labelWidth": "120px"
  },
  "fields": [
    {
      "name": "equipmentCode",
      "label": "è®¾å¤‡ç¼–å·",
      "type": "select",
      "required": true,
      "options": "equipment",
      "placeholder": "è¯·é€‰æ‹©è®¾å¤‡"
    },
    {
      "name": "equipmentName",
      "label": "è®¾å¤‡åç§°",
      "type": "text",
      "readonly": true,
      "linkTo": {
        "field": "equipmentCode",
        "mapping": "name"
      }
    },
    {
      "name": "maintenanceDate",
      "label": "ç»´ä¿æ—¥æœŸ",
      "type": "date",
      "required": true,
      "defaultValue": "today"
    },
    {
      "name": "maintenanceType",
      "label": "ç»´ä¿ç±»å‹",
      "type": "radio",
      "required": true,
      "options": [
        { "label": "æ—¥å¸¸ä¿å…»", "value": "routine" },
        { "label": "æ•…éšœç»´ä¿®", "value": "repair" },
        { "label": "å¹´åº¦æ£€ä¿®", "value": "annual" }
      ]
    },
    {
      "name": "faultReason",
      "label": "æ•…éšœåŸå› ",
      "type": "textarea",
      "required": true,
      "visibleWhen": {
        "field": "maintenanceType",
        "operator": "==",
        "value": "repair"
      }
    },
    {
      "name": "maintenanceContent",
      "label": "ç»´ä¿å†…å®¹",
      "type": "textarea",
      "required": true,
      "placeholder": "è¯·è¯¦ç»†æè¿°ç»´ä¿å†…å®¹",
      "validation": {
        "min": 10,
        "message": "ç»´ä¿å†…å®¹è‡³å°‘ 10 ä¸ªå­—"
      }
    },
    {
      "name": "statusBefore",
      "label": "ç»´ä¿å‰çŠ¶æ€",
      "type": "text"
    },
    {
      "name": "statusAfter",
      "label": "ç»´ä¿åçŠ¶æ€",
      "type": "text"
    },
    {
      "name": "replacedParts",
      "label": "æ›´æ¢çš„é›¶ä»¶",
      "type": "textarea"
    },
    {
      "name": "photos",
      "label": "ç°åœºç…§ç‰‡",
      "type": "image",
      "accept": "image/*",
      "maxCount": 9,
      "maxSize": 5,
      "width": "full"
    },
    {
      "name": "maintenancePersonSignature",
      "label": "ç»´ä¿äººå‘˜ç­¾å",
      "type": "signature",
      "required": true,
      "width": "full"
    },
    {
      "name": "cost",
      "label": "ç»´ä¿æˆæœ¬ï¼ˆå…ƒï¼‰",
      "type": "number",
      "validation": {
        "min": 0
      }
    },
    {
      "name": "duration",
      "label": "ç»´ä¿è€—æ—¶ï¼ˆåˆ†é’Ÿï¼‰",
      "type": "number",
      "validation": {
        "min": 0
      }
    },
    {
      "name": "remark",
      "label": "å¤‡æ³¨",
      "type": "textarea",
      "width": "full"
    }
  ]
}
```

---

**ç¤ºä¾‹ 2: æŠ¥åºŸå•**

```json
{
  "title": "æŠ¥åºŸå•",
  "layout": {
    "columns": 2
  },
  "fields": [
    {
      "name": "scrapDate",
      "label": "æŠ¥åºŸæ—¥æœŸ",
      "type": "date",
      "required": true,
      "defaultValue": "today"
    },
    {
      "name": "materialCode",
      "label": "ç‰©æ–™ç¼–å·",
      "type": "select",
      "required": true,
      "options": "material"
    },
    {
      "name": "materialName",
      "label": "ç‰©æ–™åç§°",
      "type": "text",
      "readonly": true,
      "linkTo": {
        "field": "materialCode",
        "mapping": "name"
      }
    },
    {
      "name": "batchNumber",
      "label": "æ‰¹æ¬¡å·",
      "type": "select",
      "required": true,
      "options": "batch"
    },
    {
      "name": "stockQuantity",
      "label": "åº“å­˜æ•°é‡",
      "type": "number",
      "readonly": true,
      "linkTo": {
        "field": "batchNumber",
        "mapping": "stockQuantity"
      }
    },
    {
      "name": "scrapQuantity",
      "label": "æŠ¥åºŸæ•°é‡",
      "type": "number",
      "required": true,
      "validation": {
        "min": 0,
        "message": "æŠ¥åºŸæ•°é‡å¿…é¡»å¤§äº 0"
      }
    },
    {
      "name": "scrapReason",
      "label": "æŠ¥åºŸåŸå› ",
      "type": "select",
      "required": true,
      "options": [
        { "label": "è¿‡æœŸ", "value": "expired" },
        { "label": "æŸå", "value": "damaged" },
        { "label": "è´¨é‡é—®é¢˜", "value": "quality" },
        { "label": "å…¶ä»–", "value": "other" }
      ]
    },
    {
      "name": "scrapReasonDetail",
      "label": "è¯¦ç»†è¯´æ˜",
      "type": "textarea",
      "required": true,
      "width": "full"
    },
    {
      "name": "photos",
      "label": "ç°åœºç…§ç‰‡",
      "type": "image",
      "maxCount": 5,
      "width": "full"
    },
    {
      "name": "applicantSignature",
      "label": "ç”³è¯·äººç­¾å",
      "type": "signature",
      "required": true,
      "width": "full"
    }
  ]
}
```

---

### 19.4 å‰ç«¯è®¾è®¡ï¼ˆå¯è§†åŒ–è¡¨å•è®¾è®¡å™¨ï¼‰

#### 19.4.1 ç®¡ç†å‘˜ç«¯ - è¡¨å•è®¾è®¡å™¨ç•Œé¢

```
é¡µé¢è·¯å¾„: /admin/record-templates/designer

å¸ƒå±€ç»“æ„ï¼ˆä¸‰æ ï¼‰:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     é¡¶éƒ¨å·¥å…·æ                           â”‚
â”‚  [ä¿å­˜æ¨¡æ¿] [é¢„è§ˆ] [å¯¼å…¥] [å¯¼å‡º] [è¿”å›]                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           â”‚                        â”‚                â”‚
â”‚  å­—æ®µåº“   â”‚      è¡¨å•é¢„è§ˆåŒº         â”‚   å±æ€§é…ç½®åŒº    â”‚
â”‚           â”‚                        â”‚                â”‚
â”‚  åŸºç¡€å­—æ®µ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  å­—æ®µå±æ€§      â”‚
â”‚  â˜° æ–‡æœ¬   â”‚  â”‚  è®¾å¤‡ç»´ä¿è®°å½•     â”‚ â”‚  å­—æ®µåç§°:     â”‚
â”‚  â˜° æ•°å­—   â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚  equipmentCodeâ”‚
â”‚  â˜° æ—¥æœŸ   â”‚  â”‚ [è®¾å¤‡ç¼–å·*]       â”‚ â”‚                â”‚
â”‚  â˜° ä¸‹æ‹‰   â”‚  â”‚ [è®¾å¤‡åç§°]        â”‚ â”‚  å­—æ®µæ ‡ç­¾:     â”‚
â”‚  â˜° å•é€‰   â”‚  â”‚ [ç»´ä¿æ—¥æœŸ*]       â”‚ â”‚  è®¾å¤‡ç¼–å·      â”‚
â”‚  â˜° å¤šé€‰   â”‚  â”‚ [ç»´ä¿ç±»å‹*]       â”‚ â”‚                â”‚
â”‚  â˜° æ–‡æœ¬åŸŸ â”‚  â”‚ [ç»´ä¿å†…å®¹*]       â”‚ â”‚  å­—æ®µç±»å‹:     â”‚
â”‚           â”‚  â”‚ [ç°åœºç…§ç‰‡]        â”‚ â”‚  ä¸‹æ‹‰é€‰æ‹© â–¼    â”‚
â”‚  é«˜çº§å­—æ®µ â”‚  â”‚ [ç»´ä¿äººå‘˜ç­¾å*]   â”‚ â”‚                â”‚
â”‚  â˜° çº§è”   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  æ˜¯å¦å¿…å¡«:     â”‚
â”‚  â˜° æ ‘å½¢   â”‚                        â”‚  â˜‘ æ˜¯          â”‚
â”‚  â˜° ä¸Šä¼    â”‚  æ‹–æ‹½å­—æ®µåˆ°æ­¤å¤„          â”‚                â”‚
â”‚  â˜° å›¾ç‰‡   â”‚  æˆ–ç‚¹å‡»å­—æ®µæ·»åŠ          â”‚  æ•°æ®æº:       â”‚
â”‚  â˜° ç­¾å   â”‚                        â”‚  è®¾å¤‡å°è´¦ â–¼    â”‚
â”‚  â˜° å¯Œæ–‡æœ¬ â”‚                        â”‚                â”‚
â”‚  â˜° ä½ç½®   â”‚                        â”‚  [åˆ é™¤å­—æ®µ]    â”‚
â”‚  â˜° æ‰«ç    â”‚                        â”‚                â”‚
â”‚           â”‚                        â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ“ä½œè¯´æ˜:
1. ä»å·¦ä¾§å­—æ®µåº“æ‹–æ‹½å­—æ®µåˆ°ä¸­é—´é¢„è§ˆåŒº
2. ç‚¹å‡»é¢„è§ˆåŒºçš„å­—æ®µï¼Œå³ä¾§æ˜¾ç¤ºå±æ€§é…ç½®
3. é…ç½®å­—æ®µå±æ€§ï¼ˆåç§°ã€æ ‡ç­¾ã€ç±»å‹ã€å¿…å¡«ã€æ•°æ®æºç­‰ï¼‰
4. é…ç½®å­—æ®µé€»è¾‘ï¼ˆæ˜¾éšè§„åˆ™ã€è”åŠ¨è§„åˆ™ã€è®¡ç®—è§„åˆ™ï¼‰
5. æ”¯æŒæ‹–æ‹½è°ƒæ•´å­—æ®µé¡ºåº
6. æ”¯æŒåˆ é™¤å­—æ®µ
7. å®æ—¶é¢„è§ˆè¡¨å•æ•ˆæœ
```

---

#### 19.4.2 å­—æ®µå±æ€§é…ç½®é¢æ¿

```
å½“é€‰ä¸­æŸä¸ªå­—æ®µæ—¶ï¼Œå³ä¾§æ˜¾ç¤ºå±æ€§é…ç½®:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       å­—æ®µå±æ€§é…ç½®              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                â”‚
â”‚  åŸºæœ¬å±æ€§                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ å­—æ®µåç§°: equipmentCode   â”‚ â”‚
â”‚  â”‚ å­—æ®µæ ‡ç­¾: è®¾å¤‡ç¼–å·         â”‚ â”‚
â”‚  â”‚ å­—æ®µç±»å‹: ä¸‹æ‹‰é€‰æ‹© â–¼      â”‚ â”‚
â”‚  â”‚ å­—æ®µå®½åº¦: 1/2 â–¼          â”‚ â”‚
â”‚  â”‚ æ˜¯å¦å¿…å¡«: â˜‘              â”‚ â”‚
â”‚  â”‚ æ˜¯å¦åªè¯»: â˜              â”‚ â”‚
â”‚  â”‚ å ä½ç¬¦: è¯·é€‰æ‹©è®¾å¤‡         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                â”‚
â”‚  æ•°æ®æºé…ç½®ï¼ˆä¸‹æ‹‰é€‰æ‹©ï¼‰          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ•°æ®æºç±»å‹:               â”‚ â”‚
â”‚  â”‚   â—‹ é™æ€é€‰é¡¹              â”‚ â”‚
â”‚  â”‚   â— åŠ¨æ€æ•°æ®æº            â”‚ â”‚
â”‚  â”‚                          â”‚ â”‚
â”‚  â”‚ æ•°æ®æº: è®¾å¤‡å°è´¦ â–¼        â”‚ â”‚
â”‚  â”‚ æ˜¾ç¤ºå­—æ®µ: code - name     â”‚ â”‚
â”‚  â”‚ å€¼å­—æ®µ: id                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                â”‚
â”‚  æ ¡éªŒè§„åˆ™                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æœ€å°å€¼/æœ€å°é•¿åº¦: [ç©º]     â”‚ â”‚
â”‚  â”‚ æœ€å¤§å€¼/æœ€å¤§é•¿åº¦: [ç©º]     â”‚ â”‚
â”‚  â”‚ æ­£åˆ™è¡¨è¾¾å¼: [ç©º]          â”‚ â”‚
â”‚  â”‚ é”™è¯¯æç¤º: [ç©º]            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                â”‚
â”‚  æ˜¾éšè§„åˆ™ï¼ˆå¯é€‰ï¼‰               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ä¾èµ–å­—æ®µ: [é€‰æ‹©å­—æ®µ â–¼]    â”‚ â”‚
â”‚  â”‚ æ¡ä»¶: == â–¼                â”‚ â”‚
â”‚  â”‚ æ¡ä»¶å€¼: [è¾“å…¥å€¼]          â”‚ â”‚
â”‚  â”‚                          â”‚ â”‚
â”‚  â”‚ [+ æ·»åŠ è§„åˆ™]              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                â”‚
â”‚  è”åŠ¨è§„åˆ™ï¼ˆå¯é€‰ï¼‰               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ å…³è”å­—æ®µ: equipmentName   â”‚ â”‚
â”‚  â”‚ æ˜ å°„å…³ç³»: è‡ªåŠ¨å¸¦å‡ºè®¾å¤‡åç§° â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                â”‚
â”‚  [ä¿å­˜é…ç½®] [å–æ¶ˆ]              â”‚
â”‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### 19.4.3 ç”¨æˆ·ç«¯ - åŠ¨æ€è¡¨å•æ¸²æŸ“ï¼ˆPCï¼‰

```vue
<!-- PC ç«¯åŠ¨æ€è¡¨å•ç»„ä»¶ -->
<template>
  <div class="dynamic-form">
    <el-form 
      :model="formData" 
      :rules="rules" 
      ref="formRef"
      :label-width="template.formSchema.layout?.labelWidth || '120px'"
    >
      <!-- åŠ¨æ€æ¸²æŸ“å­—æ®µ -->
      <el-row :gutter="20">
        <el-col 
          v-for="field in visibleFields" 
          :key="field.name"
          :span="getColSpan(field)"
        >
          <!-- æ–‡æœ¬è¾“å…¥ -->
          <el-form-item 
            v-if="field.type === 'text'" 
            :label="field.label"
            :prop="field.name"
          >
            <el-input 
              v-model="formData[field.name]" 
              :placeholder="field.placeholder"
              :readonly="field.readonly"
            />
          </el-form-item>

          <!-- æ•°å­—è¾“å…¥ -->
          <el-form-item 
            v-if="field.type === 'number'" 
            :label="field.label"
            :prop="field.name"
          >
            <el-input-number 
              v-model="formData[field.name]"
              :min="field.validation?.min"
              :max="field.validation?.max"
            />
          </el-form-item>

          <!-- æ—¥æœŸé€‰æ‹© -->
          <el-form-item 
            v-if="field.type === 'date'" 
            :label="field.label"
            :prop="field.name"
          >
            <el-date-picker 
              v-model="formData[field.name]"
              type="date"
            />
          </el-form-item>

          <!-- ä¸‹æ‹‰é€‰æ‹© -->
          <el-form-item 
            v-if="field.type === 'select'" 
            :label="field.label"
            :prop="field.name"
          >
            <el-select 
              v-model="formData[field.name]"
              :placeholder="field.placeholder"
              @change="handleFieldChange(field.name)"
            >
              <el-option
                v-for="option in getOptions(field)"
                :key="option.value"
                :label="option.label"
                :value="option.value"
              />
            </el-select>
          </el-form-item>

          <!-- å•é€‰æŒ‰é’® -->
          <el-form-item 
            v-if="field.type === 'radio'" 
            :label="field.label"
            :prop="field.name"
          >
            <el-radio-group 
              v-model="formData[field.name]"
              @change="handleFieldChange(field.name)"
            >
              <el-radio
                v-for="option in field.options"
                :key="option.value"
                :label="option.value"
              >
                {{ option.label }}
              </el-radio>
            </el-radio-group>
          </el-form-item>

          <!-- å¤šè¡Œæ–‡æœ¬ -->
          <el-form-item 
            v-if="field.type === 'textarea'" 
            :label="field.label"
            :prop="field.name"
          >
            <el-input 
              v-model="formData[field.name]" 
              type="textarea"
              :rows="3"
              :placeholder="field.placeholder"
            />
          </el-form-item>

          <!-- å›¾ç‰‡ä¸Šä¼  -->
          <el-form-item 
            v-if="field.type === 'image'" 
            :label="field.label"
            :prop="field.name"
          >
            <el-upload
              v-model:file-list="formData[field.name]"
              :action="uploadUrl"
              list-type="picture-card"
              :limit="field.maxCount"
              :accept="field.accept"
            >
              <el-icon><Plus /></el-icon>
            </el-upload>
          </el-form-item>

          <!-- ç”µå­ç­¾å -->
          <el-form-item 
            v-if="field.type === 'signature'" 
            :label="field.label"
            :prop="field.name"
          >
            <SignaturePad 
              v-model="formData[field.name]"
              :width="400"
              :height="200"
            />
          </el-form-item>
        </el-col>
      </el-row>
    </el-form>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="form-actions">
      <el-button @click="handleSaveDraft">ä¿å­˜è‰ç¨¿</el-button>
      <el-button type="primary" @click="handleSubmit">æäº¤</el-button>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue'
import type { RecordTemplate, FormField } from '@/types'

const props = defineProps<{
  template: RecordTemplate
  recordId?: string
}>()

const formData = ref<Record<string, any>>({})
const formRef = ref()

// åˆå§‹åŒ–è¡¨å•æ•°æ®
function initFormData() {
  props.template.formSchema.fields.forEach(field => {
    if (field.defaultValue === 'today') {
      formData.value[field.name] = new Date()
    } else {
      formData.value[field.name] = field.defaultValue || null
    }
  })
}

// åŠ¨æ€ç”Ÿæˆæ ¡éªŒè§„åˆ™
const rules = computed(() => {
  const result: any = {}
  props.template.formSchema.fields.forEach(field => {
    if (field.required) {
      result[field.name] = [
        { required: true, message: `è¯·è¾“å…¥${field.label}`, trigger: 'blur' }
      ]
    }
    if (field.validation) {
      const rules = []
      if (field.validation.min !== undefined) {
        rules.push({ min: field.validation.min, message: field.validation.message })
      }
      if (field.validation.max !== undefined) {
        rules.push({ max: field.validation.max, message: field.validation.message })
      }
      if (field.validation.pattern) {
        rules.push({ pattern: new RegExp(field.validation.pattern), message: field.validation.message })
      }
      result[field.name] = rules
    }
  })
  return result
})

// æ ¹æ®æ˜¾éšè§„åˆ™è¿‡æ»¤å­—æ®µ
const visibleFields = computed(() => {
  return props.template.formSchema.fields.filter(field => {
    if (!field.visibleWhen) return true
    
    const dependentValue = formData.value[field.visibleWhen.field]
    const { operator, value } = field.visibleWhen
    
    switch (operator) {
      case '==': return dependentValue === value
      case '!=': return dependentValue !== value
      case '>': return dependentValue > value
      case '<': return dependentValue < value
      case 'in': return Array.isArray(value) && value.includes(dependentValue)
      default: return true
    }
  })
})

// è·å–åˆ—å®½
function getColSpan(field: FormField) {
  const columns = props.template.formSchema.layout?.columns || 1
  if (field.width === 'full') return 24
  return 24 / columns
}

// è·å–ä¸‹æ‹‰é€‰é¡¹
async function getOptions(field: FormField) {
  if (Array.isArray(field.options)) {
    return field.options
  }
  
  // åŠ¨æ€æ•°æ®æº
  if (typeof field.options === 'string') {
    const res = await fetch(`/api/data-source/${field.options}`)
    return res.json()
  }
  
  return []
}

// å­—æ®µå˜åŒ–å¤„ç†ï¼ˆè”åŠ¨ï¼‰
function handleFieldChange(fieldName: string) {
  const field = props.template.formSchema.fields.find(f => f.name === fieldName)
  if (!field?.linkTo) return
  
  // è‡ªåŠ¨å¸¦å‡ºå…³è”å­—æ®µçš„å€¼
  const linkedField = props.template.formSchema.fields.find(f => f.name === field.linkTo.field)
  if (linkedField) {
    // ä»é€‰ä¸­çš„é€‰é¡¹ä¸­è·å–æ˜ å°„çš„å€¼
    const selectedOption = getOptions(field).find(opt => opt.value === formData.value[fieldName])
    if (selectedOption) {
      formData.value[linkedField.name] = selectedOption[field.linkTo.mapping]
    }
  }
}

// ä¿å­˜è‰ç¨¿
async function handleSaveDraft() {
  const res = await fetch('/api/records', {
    method: 'POST',
    body: JSON.stringify({
      templateId: props.template.id,
      formData: formData.value,
      status: 'draft'
    })
  })
  ElMessage.success('è‰ç¨¿ä¿å­˜æˆåŠŸ')
}

// æäº¤
async function handleSubmit() {
  const valid = await formRef.value.validate()
  if (!valid) return
  
  const res = await fetch('/api/records', {
    method: 'POST',
    body: JSON.stringify({
      templateId: props.template.id,
      formData: formData.value,
      status: 'submitted'
    })
  })
  
  ElMessage.success('æäº¤æˆåŠŸ')
  router.push('/records')
}

onMounted(() => {
  initFormData()
  if (props.recordId) {
    // åŠ è½½å·²æœ‰è®°å½•
    fetch(`/api/records/${props.recordId}`).then(res => {
      formData.value = res.formData
    })
  }
})
</script>
```

---

### 19.4è¡¥. é˜²ç¯¡æ”¹æœºåˆ¶è®¾è®¡ï¼ˆBRCGS åˆè§„æ ¸å¿ƒï¼‰â­â­â­

#### 19.4è¡¥1. é—®é¢˜èƒŒæ™¯

**BRCGS å®¡æ ¸å‘˜çš„è´¨ç–‘**ï¼š
> "å¦‚ä½•è¯æ˜è¿™äº›è®°å½•æ˜¯å®æ—¶å¡«å†™çš„ï¼Œä¸æ˜¯äº‹åè¡¥å¡«çš„ï¼Ÿ"
> "å¦‚ä½•è¯æ˜å®¡æ‰¹é€šè¿‡åçš„è®°å½•æœªè¢«ä¿®æ”¹ï¼Ÿ"
> "å¦‚ä½•è¯æ˜ç”µå­ç­¾åæ˜¯æœ¬äººå½“æ—¶ç­¾ç½²çš„ï¼Ÿ"

**å½“å‰è®¾è®¡çš„é£é™©**ï¼š
- âŒ å®¢æˆ·ç«¯å¯èƒ½ç¯¡æ”¹ç³»ç»Ÿæ—¶é—´ï¼Œæäº¤è™šå‡è®°å½•
- âŒ å®¡æ‰¹é€šè¿‡åè®°å½•ä»å¯ä¿®æ”¹ï¼Œæ— å˜æ›´å†å²
- âŒ ç”µå­ç­¾åæ—¶é—´æˆ³å¯èƒ½ä¸å‡†ç¡®

---

#### 19.4è¡¥2. è§£å†³æ–¹æ¡ˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              é˜²ç¯¡æ”¹æœºåˆ¶ä¸‰å±‚é˜²æŠ¤                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ç¬¬ä¸€å±‚ï¼šæœåŠ¡å™¨æ—¶é—´æˆ³å¼ºåˆ¶è¦†ç›–                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ å®¢æˆ·ç«¯æäº¤æ—¶é—´ â†’ ä¸¢å¼ƒ                             â”‚   â”‚
â”‚  â”‚ â€¢ æœåŠ¡å™¨æ—¶é—´æˆ³ â†’ å†™å…¥ createdAt, submittedAt      â”‚   â”‚
â”‚  â”‚ â€¢ æ—¶é—´å·®æ ¡éªŒ â†’ è¶…è¿‡ 5 åˆ†é’Ÿæ‹’ç»æäº¤                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  ç¬¬äºŒå±‚ï¼šè®°å½•å˜æ›´å†å²ï¼ˆRecordChangeLogï¼‰                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ è®°å½•çŠ¶æ€ = approved åï¼Œä»»ä½•ä¿®æ”¹è®°å½•å˜æ›´å†å²      â”‚   â”‚
â”‚  â”‚ â€¢ è®°å½•ä¿®æ”¹äººã€ä¿®æ”¹æ—¶é—´ã€åŸå€¼ã€æ–°å€¼ã€ä¿®æ”¹åŸå›          â”‚   â”‚
â”‚  â”‚ â€¢ ä¿®æ”¹å·²å®¡æ‰¹è®°å½•éœ€è¦ç‰¹æ®Šæƒé™ + äºŒæ¬¡å®¡æ‰¹             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  ç¬¬ä¸‰å±‚ï¼šç”µå­ç­¾åæ—¶é—´æˆ³é”å®š                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ ç­¾åæ—¶é”å®šæœåŠ¡å™¨æ—¶é—´æˆ³ signatureTimestamp         â”‚   â”‚
â”‚  â”‚ â€¢ ç­¾åæ—¶é—´ä¸å¯ä¿®æ”¹                                  â”‚   â”‚
â”‚  â”‚ â€¢ ç¦»çº¿å¡«å†™æ ‡è®° offlineFilled = true                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### 19.4è¡¥3. æœåŠ¡å™¨æ—¶é—´æˆ³æ ¡éªŒé€»è¾‘

```typescript
// åç«¯ APIï¼šåˆ›å»ºè®°å½•æ—¶å¼ºåˆ¶ä½¿ç”¨æœåŠ¡å™¨æ—¶é—´
async function createRecord(dto: CreateRecordDto, userId: string) {
  const serverTime = new Date().getTime()
  const clientSubmitTime = dto.submittedAt
    ? new Date(dto.submittedAt).getTime()
    : serverTime

  // 1. æ—¶é—´æ ¡éªŒï¼šå®¢æˆ·ç«¯æ—¶é—´ä¸æœåŠ¡å™¨æ—¶é—´å·®ä¸èƒ½è¶…è¿‡ 5 åˆ†é’Ÿ
  const timeDiff = Math.abs(clientSubmitTime - serverTime)
  if (timeDiff > 300000) { // 5åˆ†é’Ÿ = 300,000ms
    throw new BadRequestException(
      `è®°å½•æäº¤æ—¶é—´å¼‚å¸¸ï¼ˆä¸æœåŠ¡å™¨æ—¶é—´å·® ${Math.floor(timeDiff / 60000)} åˆ†é’Ÿï¼‰ï¼Œ` +
      `å¯èƒ½å­˜åœ¨ç³»ç»Ÿæ—¶é—´ç¯¡æ”¹`
    )
  }

  // 2. å¼ºåˆ¶ä½¿ç”¨æœåŠ¡å™¨æ—¶é—´ï¼ˆä¸ä¿¡ä»»å®¢æˆ·ç«¯æ—¶é—´ï¼‰
  const record = await prisma.record.create({
    data: {
      ...dto,
      createdBy: userId,
      createdAt: new Date(),      // æœåŠ¡å™¨æ—¶é—´
      submittedAt: dto.status === 'submitted' ? new Date() : null,
      offlineFilled: dto.offlineFilled || false
    }
  })

  return record
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… æœåŠ¡å™¨æ—¶é—´æˆ³ä¸å¯ç¯¡æ”¹ï¼ˆæ•°æ®åº“ `@default(now())`ï¼‰
- âœ… å®¢æˆ·ç«¯æ—¶é—´åªç”¨äºæ ¡éªŒï¼Œä¸å†™å…¥æ•°æ®åº“
- âœ… ç¦»çº¿å¡«å†™çš„è®°å½•æ ‡è®° `offlineFilled = true`ï¼Œå®¡æ ¸æ—¶é‡ç‚¹å…³æ³¨

---

#### 19.4è¡¥4. è®°å½•å˜æ›´å†å²æ‹¦æˆªå™¨

```typescript
// åç«¯æ‹¦æˆªå™¨ï¼šè‡ªåŠ¨è®°å½•å·²å®¡æ‰¹è®°å½•çš„å˜æ›´
@Injectable()
export class RecordChangeInterceptor implements NestInterceptor {
  async intercept(context: ExecutionContext, next: CallHandler) {
    const request = context.switchToHttp().getRequest()
    const recordId = request.params.id
    const userId = request.user.id

    // è·å–åŸè®°å½•
    const oldRecord = await prisma.record.findUnique({
      where: { id: recordId }
    })

    // æ‰§è¡Œæ›´æ–°
    const result = await next.handle().toPromise()

    // å¦‚æœè®°å½•çŠ¶æ€æ˜¯ approvedï¼Œè®°å½•å˜æ›´å†å²
    if (oldRecord.status === 'approved') {
      const newFormData = request.body.formData
      const changeLogs = []

      // å¯¹æ¯”å­—æ®µå˜åŒ–
      for (const [fieldName, newValue] of Object.entries(newFormData)) {
        const oldValue = oldRecord.formData[fieldName]
        if (JSON.stringify(oldValue) !== JSON.stringify(newValue)) {
          changeLogs.push({
            recordId,
            fieldName,
            oldValue,
            newValue,
            changedBy: userId,
            changedByName: request.user.name,
            reason: request.body.reason || 'ä¿®æ”¹è®°å½•'
          })
        }
      }

      // æ‰¹é‡åˆ›å»ºå˜æ›´æ—¥å¿—
      if (changeLogs.length > 0) {
        await prisma.recordChangeLog.createMany({
          data: changeLogs
        })
      }
    }

    return result
  }
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… æ‹¦æˆªå™¨è‡ªåŠ¨è®°å½•ï¼Œå¼€å‘è€…æ— éœ€æ‰‹åŠ¨è°ƒç”¨
- âœ… åªè®°å½•å·²å®¡æ‰¹è®°å½•çš„å˜æ›´ï¼ˆdraft çŠ¶æ€çš„ä¿®æ”¹ä¸è®°å½•ï¼‰
- âœ… è®°å½•å­—æ®µçº§åˆ«çš„å˜æ›´ï¼ˆç²¾ç¡®åˆ°æ¯ä¸ªå­—æ®µï¼‰

---

#### 19.4è¡¥5. ç”µå­ç­¾åæ—¶é—´æˆ³é”å®š

```typescript
// åç«¯ APIï¼šä¿å­˜ç”µå­ç­¾åæ—¶é”å®šæœåŠ¡å™¨æ—¶é—´æˆ³
async function saveSignature(
  recordId: string,
  dto: SaveSignatureDto,
  userId: string
) {
  // 1. ä¸Šä¼ ç­¾åå›¾ç‰‡åˆ° MinIO
  const signatureBuffer = Buffer.from(
    dto.signatureBase64.replace(/^data:image\/\w+;base64,/, ''),
    'base64'
  )
  const signatureUrl = await minioService.upload({
    buffer: signatureBuffer,
    filename: `signature-${recordId}-${Date.now()}.png`,
    mimetype: 'image/png'
  })

  // 2. é”å®šæœåŠ¡å™¨æ—¶é—´æˆ³ï¼ˆä¸å¯ç¯¡æ”¹ï¼‰
  const signatureTimestamp = new Date()

  // 3. æ›´æ–°è®°å½•ï¼ˆä½¿ç”¨ Prisma JSON å­—æ®µæ›´æ–°ï¼‰
  const record = await prisma.record.findUnique({ where: { id: recordId } })
  const updatedFormData = {
    ...record.formData,
    [dto.fieldName]: signatureUrl  // ä¾‹å¦‚ operatorSignature
  }

  await prisma.record.update({
    where: { id: recordId },
    data: {
      formData: updatedFormData,
      signatureTimestamp  // ç­¾åæ—¶çš„æœåŠ¡å™¨æ—¶é—´
    }
  })

  return {
    signatureUrl,
    signatureTimestamp
  }
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… ç­¾åæ—¶é—´æˆ³æ˜¯æœåŠ¡å™¨æ—¶é—´ï¼Œä¸å¯ç¯¡æ”¹
- âœ… ç­¾å URL å­˜åœ¨ formData ä¸­ï¼Œæ—¶é—´æˆ³å•ç‹¬å­˜å‚¨
- âœ… å®¡æ ¸æ—¶å¯éªŒè¯ç­¾åæ—¶é—´ä¸è®°å½•æäº¤æ—¶é—´çš„åˆç†æ€§

---

#### 19.4è¡¥6. è½¯åˆ é™¤å®ç°

```typescript
// åç«¯ APIï¼šè½¯åˆ é™¤è®°å½•ï¼ˆä¸çœŸæ­£åˆ é™¤æ•°æ®ï¼‰
async function deleteRecord(recordId: string, userId: string) {
  const record = await prisma.record.findUnique({ where: { id: recordId } })

  // åªæœ‰è‰ç¨¿çŠ¶æ€å¯ä»¥åˆ é™¤
  if (record.status === 'approved') {
    throw new BadRequestException('å·²å®¡æ‰¹çš„è®°å½•ä¸å…è®¸åˆ é™¤')
  }

  // è½¯åˆ é™¤ï¼šè®¾ç½® deletedAt æ—¶é—´æˆ³
  await prisma.record.update({
    where: { id: recordId },
    data: {
      status: 'deleted',
      deletedAt: new Date()
    }
  })

  return { success: true }
}

// æŸ¥è¯¢æ—¶è‡ªåŠ¨è¿‡æ»¤å·²åˆ é™¤è®°å½•
async function findRecords(filters: RecordFilters) {
  return await prisma.record.findMany({
    where: {
      ...filters,
      deletedAt: null  // æ’é™¤å·²åˆ é™¤è®°å½•
    }
  })
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… å·²åˆ é™¤çš„è®°å½•æ•°æ®ä»ä¿ç•™åœ¨æ•°æ®åº“
- âœ… å®¡æ ¸æ—¶å¯ä»¥æŸ¥çœ‹åˆ é™¤è®°å½•ï¼ˆWHERE deletedAt IS NOT NULLï¼‰
- âœ… ç¬¦åˆ BRCGS "æ•°æ®å¯è¿½æº¯"è¦æ±‚

---

#### 19.4è¡¥7. BRCGS å®¡æ ¸æ—¶çš„è¯æ®å±•ç¤º

**å®¡æ ¸å‘˜é—®é¢˜ 1**ï¼šå¦‚ä½•è¯æ˜è®°å½•æ˜¯å®æ—¶å¡«å†™çš„ï¼Ÿ

**å›ç­”**ï¼š
1. è®°å½•çš„ `createdAt` æ˜¯æœåŠ¡å™¨æ—¶é—´ï¼Œä¸å¯ç¯¡æ”¹
2. æäº¤æ—¶æ ¡éªŒå®¢æˆ·ç«¯æ—¶é—´ä¸æœåŠ¡å™¨æ—¶é—´å·®ï¼ˆ< 5 åˆ†é’Ÿï¼‰
3. ç¦»çº¿å¡«å†™çš„è®°å½•æœ‰ `offlineFilled = true` æ ‡è®°ï¼Œå¹¶è®°å½•åŒæ­¥æ—¶é—´ `syncedAt`

**å®¡æ ¸å‘˜é—®é¢˜ 2**ï¼šå¦‚ä½•è¯æ˜å®¡æ‰¹é€šè¿‡åçš„è®°å½•æœªè¢«ä¿®æ”¹ï¼Ÿ

**å›ç­”**ï¼š
1. æŸ¥è¯¢è®°å½•å˜æ›´å†å²ï¼š`GET /api/records/:id/change-logs`
2. å˜æ›´å†å²è®°å½•äº†ä¿®æ”¹äººã€ä¿®æ”¹æ—¶é—´ã€åŸå€¼ã€æ–°å€¼ã€ä¿®æ”¹åŸå› 
3. ä¿®æ”¹å·²å®¡æ‰¹è®°å½•éœ€è¦ç‰¹æ®Šæƒé™ï¼ˆåªæœ‰è´¨é‡éƒ¨ + ç®¡ç†å±‚ï¼‰

**å®¡æ ¸å‘˜é—®é¢˜ 3**ï¼šå¦‚ä½•è¯æ˜ç”µå­ç­¾åæ˜¯æœ¬äººå½“æ—¶ç­¾ç½²çš„ï¼Ÿ

**å›ç­”**ï¼š
1. ç­¾åæ—¶é”å®šäº†æœåŠ¡å™¨æ—¶é—´æˆ³ `signatureTimestamp`
2. ç­¾åæ—¶é—´æˆ³ä¸è®°å½•æäº¤æ—¶é—´æ¥è¿‘ï¼ˆåˆç†æ€§æ ¡éªŒï¼‰
3. ç­¾å URL å­˜å‚¨åœ¨ MinIOï¼Œæœ‰è®¿é—®æ—¥å¿—

---

#### 19.4è¡¥8. æˆåŠŸæ ‡å‡†

**é˜²ç¯¡æ”¹æœºåˆ¶**ï¼š
- âœ… æœåŠ¡å™¨æ—¶é—´æˆ³å¼ºåˆ¶è¦†ç›–å®¢æˆ·ç«¯æ—¶é—´
- âœ… æ—¶é—´å·®è¶…è¿‡ 5 åˆ†é’Ÿæ‹’ç»æäº¤
- âœ… å·²å®¡æ‰¹è®°å½•çš„ä¿®æ”¹è®°å½•å˜æ›´å†å²
- âœ… ç”µå­ç­¾åæ—¶é—´æˆ³é”å®š
- âœ… è½¯åˆ é™¤ä¿ç•™æ•°æ®
- âœ… ç¦»çº¿å¡«å†™æ ‡è®°æ˜ç¡®
- âœ… å˜æ›´å†å²å¯æŸ¥è¯¢ã€å¯å¯¼å‡º

**BRCGS å®¡æ ¸é€šè¿‡æ ‡å‡†**ï¼š
- âœ… è®°å½•çœŸå®æ€§å¯éªŒè¯ï¼ˆæœåŠ¡å™¨æ—¶é—´æˆ³ï¼‰
- âœ… è®°å½•å®Œæ•´æ€§å¯éªŒè¯ï¼ˆå˜æ›´å†å²å®Œæ•´ï¼‰
- âœ… è´£ä»»äººå¯è¿½æº¯ï¼ˆç­¾åæ—¶é—´æˆ³ + ä¿®æ”¹è®°å½•ï¼‰

---

### 19.5 ä¸šåŠ¡è§„åˆ™(BR-211 ~ BR-260, å…± 50 æ¡)

#### 19.5.1 è®°å½•æ¨¡æ¿è§„åˆ™(BR-211 ~ BR-220)

| ç¼–å· | è§„åˆ™ | å®ç°æ–¹å¼ |
|------|------|----------|
| BR-211 | **æ¨¡æ¿ç¼–å·å”¯ä¸€**: æ¯ä¸ªæ¨¡æ¿çš„ code å¿…é¡»å”¯ä¸€ | `RecordTemplate.code @unique` |
| BR-212 | **æ¨¡æ¿çŠ¶æ€**: active(å¯ç”¨) / archived(å½’æ¡£) | `RecordTemplate.status` |
| BR-213 | **æ¨¡æ¿ç‰ˆæœ¬**: æ”¯æŒç‰ˆæœ¬ç®¡ç†ï¼Œä¿®æ”¹æ¨¡æ¿æ—¶ç”Ÿæˆæ–°ç‰ˆæœ¬ | `RecordTemplate.version` |
| BR-214 | **æ¨¡æ¿å½’æ¡£**: å½’æ¡£åä¸èƒ½æ–°å»ºè®°å½•ï¼Œå·²æœ‰è®°å½•å¯æŸ¥çœ‹ | å‰ç«¯é™åˆ¶ + åç«¯æ ¡éªŒ |
| BR-215 | **å­—æ®µå”¯ä¸€æ€§**: åŒä¸€æ¨¡æ¿å†…å­—æ®µåç§°å¿…é¡»å”¯ä¸€ | å‰ç«¯æ ¡éªŒ + åç«¯æ ¡éªŒ |
| BR-216 | **å­—æ®µç±»å‹**: æ”¯æŒ 20+ ç§å­—æ®µç±»å‹ | FieldType æšä¸¾ |
| BR-217 | **æ•°æ®æºé…ç½®**: æ”¯æŒé™æ€é€‰é¡¹ + åŠ¨æ€æ•°æ®æº | options å­—æ®µé…ç½® |
| BR-218 | **æ˜¾éšè§„åˆ™**: æ”¯æŒåŸºäºå…¶ä»–å­—æ®µå€¼çš„æ˜¾éšæ§åˆ¶ | visibleWhen é…ç½® |
| BR-219 | **è”åŠ¨è§„åˆ™**: æ”¯æŒå­—æ®µé—´è”åŠ¨ï¼ˆè‡ªåŠ¨å¸¦å‡ºï¼‰ | linkTo é…ç½® |
| BR-220 | **è®¡ç®—è§„åˆ™**: æ”¯æŒå­—æ®µè®¡ç®—ï¼ˆä¾‹å¦‚ï¼šæ€»ä»· = å•ä»· Ã— æ•°é‡ï¼‰ | computed é…ç½® |

---

#### 19.5.2 è®°å½•å®ä¾‹è§„åˆ™(BR-221 ~ BR-230)

| ç¼–å· | è§„åˆ™ | å®ç°æ–¹å¼ |
|------|------|----------|
| BR-221 | **è®°å½•ç¼–å·ç”Ÿæˆ**: æ ¼å¼ `{å‰ç¼€}-{YYYYMMDD}-{åºå·}` | åç«¯è‡ªåŠ¨ç”Ÿæˆ |
| BR-222 | **è®°å½•çŠ¶æ€**: draft(è‰ç¨¿) â†’ submitted(å·²æäº¤) â†’ approved(å·²å®¡æ‰¹) / rejected(å·²é©³å›) | `Record.status` çŠ¶æ€æœº |
| BR-223 | **è‰ç¨¿è‡ªåŠ¨ä¿å­˜**: å¡«å†™è¿‡ç¨‹ä¸­è‡ªåŠ¨ä¿å­˜è‰ç¨¿ï¼ˆæ¯ 30 ç§’ï¼‰ | å‰ç«¯å®šæ—¶ä¿å­˜ |
| BR-224 | **å¿…å¡«æ ¡éªŒ**: æäº¤æ—¶æ ¡éªŒå¿…å¡«å­—æ®µ | å‰ç«¯æ ¡éªŒ + åç«¯æ ¡éªŒ |
| BR-225 | **æ ¼å¼æ ¡éªŒ**: æ ¹æ®å­—æ®µç±»å‹å’Œ validation é…ç½®æ ¡éªŒ | å‰ç«¯æ ¡éªŒ + åç«¯æ ¡éªŒ |
| BR-226 | **å®¡æ‰¹é›†æˆ**: å¦‚æœæ¨¡æ¿é…ç½®éœ€è¦å®¡æ‰¹ï¼Œæäº¤åè§¦å‘å·¥ä½œæµ | å·¥ä½œæµå¼•æ“é›†æˆ |
| BR-227 | **å®¡æ‰¹é€šè¿‡**: å®¡æ‰¹é€šè¿‡åï¼Œè®°å½•çŠ¶æ€å˜ä¸º approvedï¼Œå¯å¯¼å‡º PDF | çŠ¶æ€æ›´æ–° |
| BR-228 | **å®¡æ‰¹é©³å›**: å®¡æ‰¹é©³å›åï¼Œè®°å½•å›åˆ° draft çŠ¶æ€ï¼Œå¯ä¿®æ”¹é‡æ–°æäº¤ | çŠ¶æ€å›é€€ |
| BR-229 | **è®°å½•åˆ é™¤**: åªæœ‰è‰ç¨¿çŠ¶æ€å¯ä»¥åˆ é™¤ | å‰ç«¯é™åˆ¶ + åç«¯æ ¡éªŒ |
| BR-230 | **è®°å½•ç¼–è¾‘**: åªæœ‰è‰ç¨¿çŠ¶æ€å¯ä»¥ç¼–è¾‘ | å‰ç«¯é™åˆ¶ + åç«¯æ ¡éªŒ |

---

#### 19.5.3 ç»Ÿä¸€æŸ¥è¯¢è§„åˆ™(BR-231 ~ BR-240)

| ç¼–å· | è§„åˆ™ | å®ç°æ–¹å¼ |
|------|------|----------|
| BR-231 | **æŒ‰éƒ¨é—¨ç­›é€‰**: æ”¯æŒæŒ‰åˆ†ç±»ï¼ˆéƒ¨é—¨ï¼‰ç­›é€‰è®°å½• | æŸ¥è¯¢æ¡ä»¶ WHERE category |
| BR-232 | **æŒ‰ç±»å‹ç­›é€‰**: æ”¯æŒæŒ‰è®°å½•æ¨¡æ¿ç­›é€‰ | æŸ¥è¯¢æ¡ä»¶ WHERE templateId |
| BR-233 | **æŒ‰æ—¶é—´ç­›é€‰**: æ”¯æŒæŒ‰åˆ›å»ºæ—¶é—´èŒƒå›´ç­›é€‰ | æŸ¥è¯¢æ¡ä»¶ WHERE createdAt BETWEEN |
| BR-234 | **æŒ‰çŠ¶æ€ç­›é€‰**: æ”¯æŒæŒ‰è®°å½•çŠ¶æ€ç­›é€‰ | æŸ¥è¯¢æ¡ä»¶ WHERE status |
| BR-235 | **å…³é”®å­—æœç´¢**: æ”¯æŒæŒ‰è®°å½•ç¼–å·ã€åˆ›å»ºäººæœç´¢ | æŸ¥è¯¢æ¡ä»¶ WHERE recordNumber LIKE |
| BR-236 | **å¯¼å‡º Excel**: æ”¯æŒå°†æŸ¥è¯¢ç»“æœå¯¼å‡ºä¸º Excel | xlsx åº“å¯¼å‡º |
| BR-237 | **å¯¼å‡º PDF**: æ”¯æŒå°†å•æ¡è®°å½•å¯¼å‡ºä¸º PDF | pdfmake ç”Ÿæˆ |
| BR-238 | **æ‰“å°**: æ”¯æŒæ‰“å°è®°å½•ï¼ˆä½¿ç”¨æ‰“å°æ¨¡æ¿ï¼‰ | window.print() |
| BR-239 | **æƒé™æ§åˆ¶**: åªèƒ½æŸ¥çœ‹è‡ªå·±éƒ¨é—¨çš„è®°å½• | åç«¯æƒé™è¿‡æ»¤ |
| BR-240 | **åˆ†é¡µæŸ¥è¯¢**: æ”¯æŒåˆ†é¡µï¼Œé»˜è®¤æ¯é¡µ 20 æ¡ | æŸ¥è¯¢å‚æ•° page/limit |

---

#### 19.5.4 é˜²ç¯¡æ”¹ä¸åˆè§„è§„åˆ™ï¼ˆBR-251 ~ BR-260ï¼‰â­ BRCGS æ ¸å¿ƒè¦æ±‚

| ç¼–å· | è§„åˆ™ | å®ç°æ–¹å¼ |
|------|------|----------|
| BR-251 | **è®°å½•å˜æ›´å†å²**: è®°å½•çŠ¶æ€ä¸º `approved` åï¼Œä»»ä½•ä¿®æ”¹å¿…é¡»è®°å½•åˆ° RecordChangeLog | åç«¯æ‹¦æˆªå™¨è‡ªåŠ¨è®°å½• |
| BR-252 | **ä¿®æ”¹å·²å®¡æ‰¹è®°å½•**: ä¿®æ”¹å·²å®¡æ‰¹è®°å½•éœ€è¦ç‰¹æ®Šæƒé™ + äºŒæ¬¡å®¡æ‰¹ | RBAC æƒé™æ ¡éªŒ + å·¥ä½œæµ |
| BR-253 | **è½¯åˆ é™¤**: åˆ é™¤è®°å½•ä¸çœŸæ­£åˆ é™¤æ•°æ®ï¼Œè®¾ç½® `deletedAt` æ—¶é—´æˆ³ | `Record.deletedAt` + æŸ¥è¯¢è¿‡æ»¤ |
| BR-254 | **æœåŠ¡å™¨æ—¶é—´æˆ³**: è®°å½•åˆ›å»º/æäº¤æ—¶é—´å¿…é¡»ä½¿ç”¨æœåŠ¡å™¨æ—¶é—´ï¼Œä¸ä¿¡ä»»å®¢æˆ·ç«¯ | åç«¯å¼ºåˆ¶è¦†ç›– `createdAt`, `submittedAt` |
| BR-255 | **æ—¶é—´æ ¡éªŒ**: æäº¤æ—¶é—´ä¸æœåŠ¡å™¨æ—¶é—´å·®è¶…è¿‡ 5 åˆ†é’Ÿï¼Œæ‹’ç»æäº¤ | åç«¯ API æ ¡éªŒé€»è¾‘ |
| BR-256 | **ç¦»çº¿æ ‡è®°**: ç¦»çº¿å¡«å†™çš„è®°å½•æ ‡è®° `offlineFilled = true`ï¼Œå®¡æ ¸æ—¶é‡ç‚¹å…³æ³¨ | ç§»åŠ¨ç«¯æäº¤æ—¶æ ‡è¯† |
| BR-257 | **ç­¾åæ—¶é—´é”å®š**: ç”µå­ç­¾åæ—¶ï¼Œé”å®šæœåŠ¡å™¨æ—¶é—´æˆ³ `signatureTimestamp` | åç«¯ç­¾å API è‡ªåŠ¨è®°å½• |
| BR-258 | **æ‰¹æ¬¡è‡ªåŠ¨å…³è”**: å¦‚æœæ¨¡æ¿å¯ç”¨æ‰¹æ¬¡å…³è”ï¼Œè®°å½•æäº¤æ—¶è‡ªåŠ¨å…³è”æ‰¹æ¬¡ | åç«¯è‡ªåŠ¨å¡«å…… `relatedBatchId` |
| BR-259 | **å˜æ›´å®¡è®¡è½¨è¿¹**: RecordChangeLog è®°å½•ä¿®æ”¹äººã€ä¿®æ”¹æ—¶é—´ã€ä¿®æ”¹åŸå› ã€æ‰¹å‡†äºº | æ•°æ®åº“å­—æ®µå®Œæ•´è®°å½• |
| BR-260 | **è®°å½•çŠ¶æ€æµè½¬**: draft â†’ submitted â†’ approved/rejected â†’ deletedï¼ŒçŠ¶æ€ä¸å¯é€†å‘ | çŠ¶æ€æœºæ ¡éªŒ |

---

#### 19.5.5 è®°å½•ä¿ç•™æœŸé™ç®¡ç†è§„åˆ™ï¼ˆBR-261 ~ BR-265ï¼‰â­ P0-5 ä¿®å¤

| ç¼–å· | è§„åˆ™ | å®ç°æ–¹å¼ |
|------|------|----------|
| **BR-261 (P0-5)** | **ä¿ç•™æœŸé™é…ç½®**: RecordTemplate å¯é…ç½®ä¿ç•™å¹´é™ï¼ˆé»˜è®¤ 3 å¹´ï¼ŒæŠ•è¯‰è®°å½• 5 å¹´ï¼‰ | `RecordTemplate.retentionYears` |
| **BR-262 (P0-5)** | **ä¿ç•™æˆªæ­¢æ—¥æœŸè®¡ç®—**: Record åˆ›å»ºæ—¶è‡ªåŠ¨è®¡ç®— `retentionUntil = createdAt + retentionYears` | åç«¯åˆ›å»ºè®°å½•æ—¶è‡ªåŠ¨è®¡ç®— |
| **BR-263 (P0-5)** | **è‡ªåŠ¨å½’æ¡£æ ‡è®°**: å®šæ—¶ä»»åŠ¡æ¯å¤©æ£€æŸ¥ï¼Œå°†è¿‡æœŸè®°å½•æ ‡è®°ä¸º `to_archive` | å®šæ—¶ä»»åŠ¡ + çŠ¶æ€æ›´æ–° |
| **BR-264 (P0-5)** | **å½’æ¡£ç¡®è®¤**: ç®¡ç†å‘˜å®¡æ ¸ `to_archive` è®°å½•ï¼Œç¡®è®¤åæ ‡è®°ä¸º `archived` | æ‰‹åŠ¨ç¡®è®¤ + API |
| **BR-265 (P0-5)** | **å½’æ¡£è®°å½•åªè¯»**: `archived` çŠ¶æ€çš„è®°å½•ä¸å¯ä¿®æ”¹ï¼Œåªèƒ½æŸ¥çœ‹å’Œå¯¼å‡º | å‰ç«¯é™åˆ¶ + åç«¯æ ¡éªŒ |

---

### 19.6 API è®¾è®¡(12 ä¸ªç«¯ç‚¹)

#### 19.6.1 è®°å½•æ¨¡æ¿ API(6 ä¸ª)

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | è¯·æ±‚ä½“ | å“åº” |
|------|------|------|--------|------|
| GET | `/api/record-templates` | æŸ¥è¯¢æ¨¡æ¿åˆ—è¡¨ | `?category=&status=` | `RecordTemplate[]` |
| GET | `/api/record-templates/:id` | æŸ¥è¯¢æ¨¡æ¿è¯¦æƒ… | - | `RecordTemplate` |
| POST | `/api/record-templates` | åˆ›å»ºæ¨¡æ¿ | `{ name, category, formSchema, ... }` | `RecordTemplate` |
| PUT | `/api/record-templates/:id` | æ›´æ–°æ¨¡æ¿ | `{ formSchema, ... }` | `RecordTemplate` |
| POST | `/api/record-templates/:id/archive` | å½’æ¡£æ¨¡æ¿ | - | `{ success: true }` |
| GET | `/api/record-templates/:id/preview` | é¢„è§ˆæ¨¡æ¿ | - | `HTML` |

---

#### 19.6.2 è®°å½•å®ä¾‹ API(6 ä¸ª)

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | è¯·æ±‚ä½“ | å“åº” |
|------|------|------|--------|------|
| GET | `/api/records` | æŸ¥è¯¢è®°å½•åˆ—è¡¨ | `?category=&status=&startDate=&endDate=` | `{ items: Record[], total: number }` |
| GET | `/api/records/:id` | æŸ¥è¯¢è®°å½•è¯¦æƒ… | - | `Record` |
| POST | `/api/records` | åˆ›å»ºè®°å½• | `{ templateId, formData, status }` | `Record` |
| PUT | `/api/records/:id` | æ›´æ–°è®°å½•ï¼ˆè‰ç¨¿ï¼‰ | `{ formData }` | `Record` |
| POST | `/api/records/:id/submit` | æäº¤å®¡æ‰¹ | - | `{ success: true, workflowId }` |
| GET | `/api/records/:id/export-pdf` | å¯¼å‡º PDF | - | `{ pdfUrl }` |

---

#### 19.6.3 é˜²ç¯¡æ”¹ä¸å®¡è®¡ APIï¼ˆ3 ä¸ªï¼‰â­ BRCGS åˆè§„

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | è¯·æ±‚ä½“ | å“åº” |
|------|------|------|--------|------|
| GET | `/api/records/:id/change-logs` | æŸ¥è¯¢è®°å½•å˜æ›´å†å² | - | `RecordChangeLog[]` |
| POST | `/api/records/:id/signature` | ä¿å­˜ç”µå­ç­¾åï¼ˆé”å®šæ—¶é—´æˆ³ï¼‰ | `{ signatureBase64, fieldName }` | `{ signatureUrl, signatureTimestamp }` |
| PUT | `/api/records/:id/approved-modify` | ä¿®æ”¹å·²å®¡æ‰¹è®°å½•ï¼ˆéœ€ç‰¹æ®Šæƒé™ï¼‰ | `{ formData, reason }` | `{ success: true, changeLogId }` |

**API è¯¦ç»†è¯´æ˜**ï¼š

**1. æŸ¥è¯¢è®°å½•å˜æ›´å†å²**
```typescript
GET /api/records/:id/change-logs

Response: {
  "success": true,
  "data": [
    {
      "id": "log-001",
      "recordId": "rec-001",
      "fieldName": "maintenanceContent",
      "oldValue": "æ¸…æ´è®¾å¤‡å¤–å£³",
      "newValue": "æ¸…æ´è®¾å¤‡å¤–å£³ï¼Œæ›´æ¢æ»¤èŠ¯",
      "changedBy": "user-001",
      "changedByName": "å¼ ä¸‰",
      "changedAt": "2024-06-15T15:30:00Z",
      "reason": "è¡¥å……ç»´ä¿å†…å®¹",
      "approvedBy": "user-manager",
      "approvedByName": "æç»ç†"
    }
  ]
}
```

**2. ä¿å­˜ç”µå­ç­¾åï¼ˆé”å®šæœåŠ¡å™¨æ—¶é—´æˆ³ï¼‰**
```typescript
POST /api/records/:id/signature
Body: {
  signatureBase64: "data:image/png;base64,iVBORw0KGgo...",
  fieldName: "operatorSignature"  // formData ä¸­çš„å­—æ®µå
}

// åç«¯é€»è¾‘ï¼š
async function saveSignature(recordId: string, dto: SaveSignatureDto) {
  // 1. ä¸Šä¼ ç­¾åå›¾ç‰‡åˆ° MinIO
  const signatureUrl = await uploadSignature(dto.signatureBase64)

  // 2. é”å®šæœåŠ¡å™¨æ—¶é—´æˆ³
  const signatureTimestamp = new Date()

  // 3. æ›´æ–°è®°å½•
  await prisma.record.update({
    where: { id: recordId },
    data: {
      [`formData.${dto.fieldName}`]: signatureUrl,
      signatureTimestamp  // æœåŠ¡å™¨æ—¶é—´ï¼Œä¸å¯ç¯¡æ”¹
    }
  })

  return { signatureUrl, signatureTimestamp }
}

Response: {
  "success": true,
  "signatureUrl": "https://minio.example.com/signatures/xxx.png",
  "signatureTimestamp": "2024-06-15T10:23:45.000Z"
}
```

**3. ä¿®æ”¹å·²å®¡æ‰¹è®°å½•ï¼ˆéœ€ç‰¹æ®Šæƒé™ + è®°å½•å˜æ›´å†å²ï¼‰**
```typescript
PUT /api/records/:id/approved-modify
Body: {
  formData: { maintenanceContent: "æ¸…æ´è®¾å¤‡å¤–å£³ï¼Œæ›´æ¢æ»¤èŠ¯" },
  reason: "è¡¥å……ç»´ä¿å†…å®¹"
}

// åç«¯é€»è¾‘ï¼š
async function modifyApprovedRecord(recordId: string, dto: ModifyDto, userId: string) {
  // 1. æƒé™æ ¡éªŒï¼ˆåªæœ‰è´¨é‡éƒ¨ + ç®¡ç†å±‚å¯ä»¥ä¿®æ”¹å·²å®¡æ‰¹è®°å½•ï¼‰
  if (!hasPermission(userId, 'MODIFY_APPROVED_RECORD')) {
    throw new ForbiddenException('æ— æƒé™ä¿®æ”¹å·²å®¡æ‰¹è®°å½•')
  }

  // 2. è·å–åŸè®°å½•
  const record = await prisma.record.findUnique({ where: { id: recordId } })
  if (record.status !== 'approved') {
    throw new BadRequestException('åªèƒ½ä¿®æ”¹å·²å®¡æ‰¹çš„è®°å½•')
  }

  // 3. è®°å½•å˜æ›´å†å²
  const changeLogs = []
  for (const [fieldName, newValue] of Object.entries(dto.formData)) {
    const oldValue = record.formData[fieldName]
    if (oldValue !== newValue) {
      changeLogs.push({
        recordId,
        fieldName,
        oldValue,
        newValue,
        changedBy: userId,
        changedByName: 'å¼ ä¸‰',
        reason: dto.reason
      })
    }
  }

  // 4. æ‰¹é‡åˆ›å»ºå˜æ›´æ—¥å¿—
  await prisma.recordChangeLog.createMany({ data: changeLogs })

  // 5. æ›´æ–°è®°å½•
  await prisma.record.update({
    where: { id: recordId },
    data: {
      formData: { ...record.formData, ...dto.formData }
    }
  })

  return { success: true, changeLogId: changeLogs[0].id }
}

Response: {
  "success": true,
  "changeLogId": "log-001",
  "message": "è®°å½•å·²æ›´æ–°ï¼Œå˜æ›´å†å²å·²è®°å½•"
}
```

---

### 19.7 å¼€å‘å·¥ä½œé‡ä¼°ç®—

#### 19.7.1 åç«¯å¼€å‘(5 å‘¨)

| æ¨¡å— | å·¥ä½œé‡ | è¯´æ˜ |
|------|--------|------|
| **è®°å½•æ¨¡æ¿ç®¡ç†** | 1 å‘¨ | RecordTemplate CRUD + ç‰ˆæœ¬ç®¡ç† |
| **è®°å½•å®ä¾‹ç®¡ç†** | 1 å‘¨ | Record CRUD + è‰ç¨¿è‡ªåŠ¨ä¿å­˜ |
| **åŠ¨æ€æ•°æ®æº** | 0.5 å‘¨ | åŠ¨æ€è·å–ä¸‹æ‹‰é€‰é¡¹ï¼ˆè®¾å¤‡/ç‰©æ–™/ç”¨æˆ·ï¼‰ |
| **å®¡æ‰¹é›†æˆ** | 0.5 å‘¨ | ä¸å·¥ä½œæµå¼•æ“é›†æˆ |
| **é˜²ç¯¡æ”¹æœºåˆ¶** | 1 å‘¨ | RecordChangeLog + æ—¶é—´æˆ³æ ¡éªŒ + ç­¾åé”å®š â­ |
| **PDF å¯¼å‡º** | 1 å‘¨ | pdfmake ç”Ÿæˆ PDF + æ¨¡æ¿æ¸²æŸ“ |
| **å•å…ƒæµ‹è¯•** | 0.5 å‘¨ | æ ¸å¿ƒä¸šåŠ¡é€»è¾‘æµ‹è¯• |

**åç«¯åˆè®¡: 5.5 å‘¨**

---

#### 19.7.2 å‰ç«¯å¼€å‘(6.5 å‘¨)

| æ¨¡å— | å·¥ä½œé‡ | è¯´æ˜ |
|------|--------|------|
| **è¡¨å•è®¾è®¡å™¨ï¼ˆPCï¼‰** | 2 å‘¨ | æ‹–æ‹½å¼è®¾è®¡å™¨ + å±æ€§é…ç½® |
| **åŠ¨æ€è¡¨å•æ¸²æŸ“ï¼ˆPCï¼‰** | 1 å‘¨ | æ ¹æ® schema åŠ¨æ€æ¸²æŸ“ 20+ å­—æ®µç±»å‹ |
| **åŠ¨æ€è¡¨å•æ¸²æŸ“ï¼ˆç§»åŠ¨ç«¯ï¼‰** | 1.5 å‘¨ | uniapp å®ç°åŠ¨æ€æ¸²æŸ“ + ç§»åŠ¨ç«¯ç‰¹æœ‰ç»„ä»¶ |
| **è®°å½•æŸ¥è¯¢é¡µé¢** | 0.5 å‘¨ | ç»Ÿä¸€æŸ¥è¯¢å…¥å£ + ç­›é€‰ + å¯¼å‡º |
| **å˜æ›´å†å²æŸ¥çœ‹** | 0.5 å‘¨ | è®°å½•å˜æ›´å†å²å±•ç¤º + å¯¹æ¯”è§†å›¾ â­ |
| **E2E æµ‹è¯•** | 1 å‘¨ | å…³é”®æµç¨‹æµ‹è¯• |

**å‰ç«¯åˆè®¡: 6.5 å‘¨**

---

#### 19.7.3 æ€»å·¥ä½œé‡

| é˜¶æ®µ | å·¥ä½œé‡ | è¯´æ˜ |
|------|--------|------|
| **åç«¯å¼€å‘** | 5.5 å‘¨ | åŒ…å«é˜²ç¯¡æ”¹æœºåˆ¶ + å•å…ƒæµ‹è¯• |
| **å‰ç«¯å¼€å‘ï¼ˆPC + ç§»åŠ¨ç«¯ï¼‰** | 6.5 å‘¨ | åŒ…å«å˜æ›´å†å² + E2E æµ‹è¯• |
| **è”è°ƒæµ‹è¯•** | 1 å‘¨ | å‰åç«¯ + ç§»åŠ¨ç«¯è”è°ƒ |
| **æ–‡æ¡£ç¼–å†™** | 0.5 å‘¨ | API æ–‡æ¡£ã€ç”¨æˆ·æ‰‹å†Œ |

**æ€»è®¡: 11.5 å‘¨ï¼ˆçº¦ 3 ä¸ªæœˆï¼‰**

**å¹¶è¡Œå¼€å‘**(1 ååç«¯ + 2 åå‰ç«¯): **çº¦ 6 å‘¨ï¼ˆ1.5 ä¸ªæœˆï¼‰**

---

### 19.8 æˆåŠŸæ ‡å‡†

**è®°å½•æ¨¡æ¿ç®¡ç†**:
- âœ… ç®¡ç†å‘˜å¯è§†åŒ–åˆ›å»ºè®°å½•æ¨¡æ¿ï¼ˆæ‹–æ‹½å¼ï¼‰
- âœ… æ”¯æŒ 20+ ç§å­—æ®µç±»å‹
- âœ… æ”¯æŒå­—æ®µæ˜¾éšè§„åˆ™ã€è”åŠ¨è§„åˆ™ã€è®¡ç®—è§„åˆ™
- âœ… æ”¯æŒæ¨¡æ¿ç‰ˆæœ¬ç®¡ç†

**åŠ¨æ€è¡¨å•æ¸²æŸ“**:
- âœ… PC ç«¯åŠ¨æ€æ¸²æŸ“è¡¨å•ï¼ˆElement Plusï¼‰
- âœ… ç§»åŠ¨ç«¯åŠ¨æ€æ¸²æŸ“è¡¨å•ï¼ˆuniappï¼‰
- âœ… æ”¯æŒå®æ—¶æ ¡éªŒã€è‡ªåŠ¨ä¿å­˜è‰ç¨¿

**è®°å½•å®ä¾‹ç®¡ç†**:
- âœ… ç”¨æˆ·åœ¨çº¿å¡«å†™è®°å½•
- âœ… æ”¯æŒå®¡æ‰¹æµç¨‹
- âœ… æ”¯æŒå¯¼å‡º PDF/Excel

**ç»Ÿä¸€æŸ¥è¯¢**:
- âœ… æŒ‰éƒ¨é—¨/ç±»å‹/æ—¶é—´/çŠ¶æ€ç­›é€‰
- âœ… æŸ¥çœ‹è®°å½•è¯¦æƒ…
- âœ… å¯¼å‡º/æ‰“å°

---

**æœ¬ç« èŠ‚å®Œæˆ âœ…**


---

## åä¹ç« è¡¥å……ï¼šæ‰¹æ¬¡è¿½æº¯ç³»ç»Ÿï¼ˆBRCGS æ ¸å¿ƒï¼‰â­â­â­ Phase A åŸºç¡€è®¾æ–½

[â¬†ï¸ è¿”å›ç›®å½•](#-å®Œæ•´ç›®å½•) | [â¬†ï¸ è¿”å›å¿«é€Ÿå¯¼èˆª](#-å¿«é€Ÿå¯¼èˆª)

> **å»ºè®®ä¸Šçº¿é¡ºåº**: Chapter 16ï¼ˆåœ¨åŠ¨æ€è¡¨å•å¼•æ“å®Œæˆåï¼‰
> **ä¼˜å…ˆçº§**: æœ€é«˜ï¼ˆBRCGS è®¤è¯æ ¸å¿ƒè¦æ±‚ï¼‰
> **ä¾èµ–**: Chapter 15ï¼ˆåŠ¨æ€è¡¨å•å¼•æ“ï¼‰ã€Chapter 17ï¼ˆä»“åº“ç®¡ç†ç³»ç»Ÿï¼‰
> **è¯´æ˜**: æœ¬ç« èŠ‚å®šä¹‰ç¡¬ç¼–ç çš„æ‰¹æ¬¡è¿½æº¯æ•°æ®è¡¨ï¼Œæ˜¯ BRCGS 4 å°æ—¶è¿½æº¯çš„åŸºç¡€ä¿éšœ

---

### 19è¡¥1. ç³»ç»Ÿå®šä½ä¸æ ¸å¿ƒè¦æ±‚

#### 19è¡¥1.1 BRCGS æ‰¹æ¬¡è¿½æº¯è¦æ±‚

**BRCGS æ ‡å‡† 3.9 æ‰¹æ¬¡è¿½æº¯è¦æ±‚**:
- âœ… **4 å°æ—¶è¿½æº¯**: ä»»æ„æˆå“æ‰¹æ¬¡èƒ½åœ¨ 4 å°æ—¶å†…è¿½æº¯åˆ°æ‰€æœ‰åŸæ–™æ‰¹æ¬¡
- âœ… **æ­£å‘è¿½æº¯**: åŸæ–™æ‰¹æ¬¡ â†’ ç”Ÿäº§æ‰¹æ¬¡ â†’ æˆå“æ‰¹æ¬¡ â†’ å®¢æˆ·
- âœ… **åå‘è¿½æº¯**: æˆå“æ‰¹æ¬¡ â†’ ç”Ÿäº§æ‰¹æ¬¡ â†’ åŸæ–™æ‰¹æ¬¡
- âœ… **å®Œæ•´é“¾æ¡**: æ‰¹æ¬¡å…³è”ä¸èƒ½æ–­è£‚ï¼Œæ¯ä¸ªç¯èŠ‚éƒ½æœ‰æ˜ç¡®çš„æ‰¹æ¬¡å·
- âœ… **å¯éªŒè¯æ€§**: è¿½æº¯æŠ¥å‘Šæ ¼å¼è§„èŒƒï¼Œå¤–å®¡å‘˜å¯å¿«é€ŸéªŒè¯

---

#### 19è¡¥1.2 æ¶æ„å†³ç­–ï¼šç¡¬ç¼–ç æ‰¹æ¬¡è¡¨ vs åŠ¨æ€è¡¨å•

**æœ€ç»ˆå†³ç­–**: âœ… **ç¡¬ç¼–ç æ‰¹æ¬¡è¡¨ + åŠ¨æ€è¡¨å•æ‰©å±•**

| æ•°æ®ç±»å‹ | å­˜å‚¨æ–¹å¼ | åŸå›  |
|---------|---------|------|
| æ‰¹æ¬¡å· | ç¡¬ç¼–ç è¡¨ | è¿½æº¯ä¸»çº¿ï¼Œä¸å¯é…ç½® |
| æ‰¹æ¬¡å…³è”å…³ç³» | ç¡¬ç¼–ç è¡¨ | å¤–é”®çº¦æŸä¿è¯å®Œæ•´æ€§ |
| äº§å“ã€åŸæ–™åŸºç¡€ä¿¡æ¯ | ç¡¬ç¼–ç è¡¨ | å¼•ç”¨ä¸»æ•°æ® |
| ç”Ÿäº§å‚æ•°ï¼ˆæ¸©åº¦ã€æ—¶é—´ï¼‰ | åŠ¨æ€è¡¨å• | ä¸åŒäº§å“å‚æ•°ä¸åŒ |
| è´¨æ£€æŒ‡æ ‡ | åŠ¨æ€è¡¨å• | ä¸åŒäº§å“æ ‡å‡†ä¸åŒ |
| æ“ä½œå‘˜ç­¾åã€ç…§ç‰‡ | åŠ¨æ€è¡¨å• | ç¬¦åˆç”µå­è®°å½•éœ€æ±‚ |

**ç¡¬ç¼–ç æ–¹æ¡ˆä¼˜åŠ¿**:
1. **è¿½æº¯ç¨³å®šæ€§**: æ•°æ®åº“å¤–é”®çº¦æŸä¿è¯è¿½æº¯é“¾ä¸ä¼šæ–­è£‚
2. **æŸ¥è¯¢æ€§èƒ½**: ç›´æ¥ JOIN æŸ¥è¯¢ï¼Œæ¯«ç§’çº§å“åº”ï¼ˆ4 å°æ—¶è¿½æº¯è¦æ±‚ï¼‰
3. **å®¡æ ¸å¯ä¿¡åº¦**: å¤–å®¡å‘˜æ›´ä¿¡ä»»ç»“æ„åŒ–çš„æ•°æ®è¡¨
4. **æ•°æ®å®Œæ•´æ€§**: ç¦æ­¢åˆ é™¤æœ‰å…³è”çš„æ‰¹æ¬¡è®°å½•
5. **å‘åå…¼å®¹**: ç³»ç»Ÿå‡çº§ä¸å½±å“å†å²è¿½æº¯æ•°æ®

---

### 19è¡¥2. æ•°æ®æ¨¡å‹è®¾è®¡

#### 19è¡¥2.1 æ ¸å¿ƒæ‰¹æ¬¡è¡¨ï¼ˆ4 ä¸ªç¡¬ç¼–ç è¡¨ï¼‰

```prisma
// ==================== æ‰¹æ¬¡è¿½æº¯ç³»ç»Ÿï¼ˆç¡¬ç¼–ç ï¼‰ ====================

// 1. åŸæ–™æ‰¹æ¬¡è¡¨ï¼ˆChapter 17 ä»“åº“ç®¡ç†ç³»ç»Ÿå®šä¹‰ï¼‰
model MaterialBatch {
  id                String   @id @default(cuid())
  batchNumber       String   @unique              // æ‰¹æ¬¡å·ï¼ˆä¾›åº”å•†æä¾› æˆ– ç³»ç»Ÿç”Ÿæˆï¼‰
  materialId        String                        // åŸæ–™ ID
  materialCode      String                        // åŸæ–™ç¼–å·
  materialName      String                        // åŸæ–™åç§°
  supplierId        String                        // ä¾›åº”å•† ID
  supplierName      String                        // ä¾›åº”å•†åç§°
  quantity          Float                         // å…¥åº“æ•°é‡
  unit              String                        // å•ä½
  productionDate    DateTime?                     // ç”Ÿäº§æ—¥æœŸ
  expiryDate        DateTime?                     // è¿‡æœŸæ—¥æœŸ
  receivedDate      DateTime                      // æ”¶è´§æ—¥æœŸ
  status            String   @default("in_stock") // in_stock | used | expired | scrapped

  // æ‰¹æ¬¡è¿½æº¯å…³è”
  usedInProduction  BatchMaterialUsage[]          // ç”¨äºå“ªäº›ç”Ÿäº§æ‰¹æ¬¡

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([batchNumber])
  @@index([materialId])
  @@map("material_batches")
}

// 2. ç”Ÿäº§æ‰¹æ¬¡è¡¨ï¼ˆæ ¸å¿ƒè¿½æº¯è¡¨ï¼‰
model ProductionBatch {
  id                String   @id @default(cuid())
  batchNumber       String   @unique              // ç”Ÿäº§æ‰¹æ¬¡å·ï¼ˆç³»ç»Ÿç”Ÿæˆï¼‰
  productId         String                        // äº§å“ ID
  productCode       String                        // äº§å“ç¼–å·
  productName       String                        // äº§å“åç§°
  recipeId          String?                       // é…æ–¹ ID
  recipeName        String?                       // é…æ–¹åç§°
  productionDate    DateTime                      // ç”Ÿäº§æ—¥æœŸ
  plannedQuantity   Float                         // è®¡åˆ’æ•°é‡
  actualQuantity    Float                         // å®é™…æ•°é‡
  unit              String                        // å•ä½
  status            String   @default("in_progress") // in_progress | completed | cancelled

  // ç”Ÿäº§ä¿¡æ¯
  workshopId        String?                       // è½¦é—´ ID
  productionLine    String?                       // ç”Ÿäº§çº¿
  shift             String?                       // ç­æ¬¡ï¼ˆæ—©ç­/ä¸­ç­/æ™šç­ï¼‰

  // æ‰¹æ¬¡è¿½æº¯å…³è”
  materialsUsed     BatchMaterialUsage[]          // ä½¿ç”¨çš„åŸæ–™æ‰¹æ¬¡
  finishedGoods     FinishedGoodsBatch[]          // äº§å‡ºçš„æˆå“æ‰¹æ¬¡
  relatedRecords    Record[]                      // å…³è”çš„ç”Ÿäº§è®°å½•ï¼ˆåŠ¨æ€è¡¨å•ï¼‰

  // åˆ›å»ºä¿¡æ¯
  createdBy         String
  createdByName     String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  completedAt       DateTime?

  @@index([batchNumber])
  @@index([productId])
  @@index([productionDate])
  @@map("production_batches")
}

// 3. æ‰¹æ¬¡ç‰©æ–™ä½¿ç”¨è¡¨ï¼ˆå…³è”åŸæ–™æ‰¹æ¬¡å’Œç”Ÿäº§æ‰¹æ¬¡ï¼‰
model BatchMaterialUsage {
  id                String   @id @default(cuid())
  productionBatchId String                        // ç”Ÿäº§æ‰¹æ¬¡ ID
  productionBatchNo String                        // ç”Ÿäº§æ‰¹æ¬¡å·ï¼ˆå†—ä½™ï¼ŒåŠ é€ŸæŸ¥è¯¢ï¼‰
  materialBatchId   String                        // åŸæ–™æ‰¹æ¬¡ ID
  materialBatchNo   String                        // åŸæ–™æ‰¹æ¬¡å·ï¼ˆå†—ä½™ï¼‰
  materialId        String                        // åŸæ–™ ID
  materialCode      String                        // åŸæ–™ç¼–å·
  materialName      String                        // åŸæ–™åç§°
  quantity          Float                         // ä½¿ç”¨æ•°é‡
  unit              String                        // å•ä½
  requisitionId     String?                       // é¢†æ–™å• IDï¼ˆå…³è”åˆ°ä»“åº“ç®¡ç†ï¼‰
  requisitionItemId String?                       // é¢†æ–™æ˜ç»† ID

  // å¤–é”®å…³è”
  productionBatch   ProductionBatch @relation(fields: [productionBatchId], references: [id], onDelete: Restrict)
  materialBatch     MaterialBatch @relation(fields: [materialBatchId], references: [id], onDelete: Restrict)

  createdAt         DateTime @default(now())

  @@index([productionBatchId])
  @@index([materialBatchId])
  @@index([productionBatchNo])
  @@index([materialBatchNo])
  @@map("batch_material_usage")
}

// 4. æˆå“æ‰¹æ¬¡è¡¨
model FinishedGoodsBatch {
  id                String   @id @default(cuid())
  batchNumber       String   @unique              // æˆå“æ‰¹æ¬¡å·ï¼ˆç³»ç»Ÿç”Ÿæˆ æˆ– ä¸ç”Ÿäº§æ‰¹æ¬¡å·ä¸€è‡´ï¼‰
  productionBatchId String                        // ç”Ÿäº§æ‰¹æ¬¡ ID
  productionBatchNo String                        // ç”Ÿäº§æ‰¹æ¬¡å·ï¼ˆå†—ä½™ï¼‰
  productId         String                        // äº§å“ ID
  productCode       String                        // äº§å“ç¼–å·
  productName       String                        // äº§å“åç§°
  quantity          Float                         // æ•°é‡
  unit              String                        // å•ä½
  productionDate    DateTime                      // ç”Ÿäº§æ—¥æœŸ
  expiryDate        DateTime?                     // è¿‡æœŸæ—¥æœŸ
  status            String   @default("in_stock") // in_stock | shipped | expired | recalled

  // ä»“åº“ä¿¡æ¯
  warehouseId       String?
  warehouseName     String?
  location          String?                       // åº“ä½

  // æ‰¹æ¬¡è¿½æº¯å…³è”
  productionBatch   ProductionBatch @relation(fields: [productionBatchId], references: [id], onDelete: Restrict)
  relatedRecords    Record[]                      // å…³è”çš„è´¨æ£€è®°å½•ï¼ˆåŠ¨æ€è¡¨å•ï¼‰
  shipments         ShipmentItem[]                // å‡ºåº“è®°å½•

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([batchNumber])
  @@index([productionBatchId])
  @@index([productId])
  @@map("finished_goods_batches")
}

// 5. å‡ºåº“æ˜ç»†è¡¨ï¼ˆè¿½æº¯åˆ°å®¢æˆ·ï¼‰
model ShipmentItem {
  id                String   @id @default(cuid())
  shipmentId        String                        // å‡ºåº“å• ID
  shipmentNumber    String                        // å‡ºåº“å•å·
  finishedGoodsBatchId String                     // æˆå“æ‰¹æ¬¡ ID
  finishedGoodsBatchNo String                     // æˆå“æ‰¹æ¬¡å·ï¼ˆå†—ä½™ï¼‰
  productId         String
  productCode       String
  productName       String
  quantity          Float
  unit              String

  // å®¢æˆ·ä¿¡æ¯
  customerId        String
  customerName      String

  // æ‰¹æ¬¡è¿½æº¯å…³è”
  finishedGoodsBatch FinishedGoodsBatch @relation(fields: [finishedGoodsBatchId], references: [id], onDelete: Restrict)

  shippedAt         DateTime
  createdAt         DateTime @default(now())

  @@index([finishedGoodsBatchId])
  @@index([shipmentId])
  @@map("shipment_items")
}
```

---

#### 19è¡¥2.2 æ‰¹æ¬¡å·ç”Ÿæˆè§„åˆ™é…ç½®

```prisma
// ç³»ç»Ÿé…ç½®è¡¨ï¼ˆæ”¯æŒæ‰¹æ¬¡å·æ ¼å¼è‡ªå®šä¹‰ï¼‰
model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique                   // é…ç½®é”®
  value       String                             // é…ç½®å€¼
  label       String                             // é…ç½®åç§°
  description String?                            // è¯´æ˜
  type        String   @default("text")          // text | number | json | boolean
  category    String   @default("system")        // system | batch | notification

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("system_configs")
}

// æ‰¹æ¬¡å·æ ¼å¼é…ç½®ç¤ºä¾‹:
// key: "production_batch_number_format"
// value: "PB-{YYYYMMDD}-{åºå·}"
// æˆ–: "PB-{äº§å“ç¼–å·}-{YYYYMMDD}-{åºå·}"

// key: "material_batch_number_format"
// value: "MAT-{åŸæ–™ç¼–å·}-{YYYYMMDD}-{åºå·}"

// key: "finished_goods_batch_number_format"
// value: "FG-{YYYYMMDD}-{åºå·}"
// æˆ–: "same_as_production" ï¼ˆä¸ç”Ÿäº§æ‰¹æ¬¡å·ä¸€è‡´ï¼‰
```

---

### 19è¡¥3. è¿½æº¯ API ç¤ºä¾‹

**åå‘è¿½æº¯ï¼ˆæˆå“ â†’ åŸæ–™ï¼‰**:
```typescript
POST /api/trace/backward
Body: { finishedGoodsBatchNumber: "FG-20240615-001" }

Response: {
  "finishedGoodsBatch": { ... },
  "productionBatch": { ... },
  "materials": [
    { "materialName": "é¢ç²‰", "batchNumber": "MAT-FLOUR-20240610-001", ... },
    { "materialName": "é¸¡è›‹", "batchNumber": "SUPPLIER-EGG-20240614", ... }
  ],
  "relatedRecords": [ ... ],  // ç”Ÿäº§è®°å½•ï¼ˆåŠ¨æ€è¡¨å•ï¼‰
  "duration": "120ms"
}
```

**æ­£å‘è¿½æº¯ï¼ˆåŸæ–™ â†’ æˆå“ â†’ å®¢æˆ·ï¼‰**:
```typescript
POST /api/trace/forward
Body: { materialBatchNumber: "MAT-FLOUR-20240610-001" }

Response: {
  "materialBatch": { ... },
  "usedInProductions": [
    {
      "productionBatchNumber": "PB-20240615-001",
      "finishedGoods": [
        {
          "batchNumber": "FG-20240615-001",
          "shipments": [
            { "customerName": "æ²ƒå°”ç›", "quantity": 60 },
            { "customerName": "å®¶ä¹ç¦", "quantity": 40 }
          ]
        }
      ]
    }
  ]
}
```

---

### 19è¡¥4. åŠ¨æ€è¡¨å•ä¸æ‰¹æ¬¡å…³è”

**RecordTemplate æ‰¹æ¬¡å…³è”é…ç½®**:
```prisma
model RecordTemplate {
  // ...åŸæœ‰å­—æ®µ

  // æ‰¹æ¬¡å…³è”é…ç½®
  batchLinkEnabled Boolean  @default(false)       // æ˜¯å¦å¯ç”¨æ‰¹æ¬¡å…³è”
  batchLinkType    String?                        // "production" | "finished_goods"
  batchLinkField   String?                        // å“ªä¸ªå­—æ®µå­˜å‚¨æ‰¹æ¬¡å·
}
```

**Record è‡ªåŠ¨å…³è”åˆ°æ‰¹æ¬¡**:
```prisma
model Record {
  // ...åŸæœ‰å­—æ®µ

  // æ‰¹æ¬¡å…³è”
  relatedBatchType   String?                      // "production" | "finished_goods"
  relatedBatchId     String?                      // æ‰¹æ¬¡ ID
  relatedBatchNumber String?                      // æ‰¹æ¬¡å·ï¼ˆå†—ä½™ï¼ŒåŠ é€ŸæŸ¥è¯¢ï¼‰

  productionBatch    ProductionBatch? @relation(...)
  finishedGoodsBatch FinishedGoodsBatch? @relation(...)

  @@index([relatedBatchNumber])
}
```

---

### 19è¡¥5. ä¸šåŠ¡è§„åˆ™

| ç¼–å· | è§„åˆ™ | å®ç°æ–¹å¼ |
|------|------|----------|
| BR-241 | **æ‰¹æ¬¡å·å”¯ä¸€æ€§**: æ‰€æœ‰æ‰¹æ¬¡å·å¿…é¡»å…¨å±€å”¯ä¸€ | `@unique` çº¦æŸ |
| BR-242 | **æ‰¹æ¬¡å·ä¸å¯ä¿®æ”¹**: æ‰¹æ¬¡åˆ›å»ºåæ‰¹æ¬¡å·ä¸èƒ½ä¿®æ”¹ | å‰ç«¯ç¦ç”¨ + åç«¯æ ¡éªŒ |
| **BR-243 (P0-2 ä¿®å¤)** | **æ‰¹æ¬¡å…³è”ä¸å¯åˆ é™¤**: æœ‰å…³è”çš„æ‰¹æ¬¡ä¸èƒ½åˆ é™¤ï¼Œå¤–é”®è®¾ç½® `onDelete: Restrict` | Prisma å¤–é”®çº¦æŸ |
| BR-244 | **4 å°æ—¶è¿½æº¯**: ä»»æ„æˆå“æ‰¹æ¬¡èƒ½åœ¨ 4 å°æ—¶å†…å®Œæˆè¿½æº¯ | æ•°æ®åº“ç´¢å¼•ä¼˜åŒ– |
| **BR-245 (P0-2 ä¿®å¤)** | **è¿½æº¯é“¾å®Œæ•´æ€§**: æˆå“ â†’ ç”Ÿäº§ â†’ åŸæ–™ é“¾æ¡ä¸èƒ½æ–­è£‚ï¼Œæ‰€æœ‰å¤–é”®å¿…é¡»æœ‰ç´¢å¼• | Prisma å¤–é”®çº¦æŸ + ç´¢å¼• |
| BR-246 | **æ‰¹æ¬¡å·æ ¼å¼å¯é…ç½®**: æ”¯æŒä¼ä¸šè‡ªå®šä¹‰æ‰¹æ¬¡å·æ ¼å¼ | SystemConfig é…ç½® |
| BR-247 | **è¿½æº¯æƒé™æ§åˆ¶**: åªæœ‰è´¨é‡éƒ¨ + ç®¡ç†å±‚å¯æŸ¥çœ‹ | RBAC æƒé™ |
| BR-248 | **è¿½æº¯æŠ¥å‘Šå¯¼å‡º**: æ”¯æŒå¯¼å‡º PDF æ ¼å¼ | pdfmake ç”Ÿæˆ |

---

### 19è¡¥6. æˆåŠŸæ ‡å‡†

**æ‰¹æ¬¡è¿½æº¯ç³»ç»Ÿ**:
- âœ… åŸæ–™å…¥åº“è‡ªåŠ¨åˆ›å»º MaterialBatch
- âœ… ç”Ÿäº§è®¡åˆ’è‡ªåŠ¨åˆ›å»º ProductionBatch
- âœ… é¢†æ–™å®Œæˆè‡ªåŠ¨å…³è” BatchMaterialUsage
- âœ… æˆå“å…¥åº“è‡ªåŠ¨åˆ›å»º FinishedGoodsBatch
- âœ… åå‘è¿½æº¯ï¼šæˆå“ â†’ åŸæ–™ï¼ˆ4 å°æ—¶å†…å®Œæˆï¼‰
- âœ… æ­£å‘è¿½æº¯ï¼šåŸæ–™ â†’ æˆå“ â†’ å®¢æˆ·
- âœ… è¿½æº¯æŠ¥å‘Š PDF å¯¼å‡º
- âœ… åŠ¨æ€è¡¨å•è®°å½•è‡ªåŠ¨å…³è”åˆ°æ‰¹æ¬¡
- âœ… æ‰¹æ¬¡å·æ ¼å¼å¯é…ç½®
- âœ… å¤–é”®çº¦æŸä¿è¯æ•°æ®å®Œæ•´æ€§

---

**æœ¬ç« èŠ‚è¡¥å……å®Œæˆ âœ…**


---

## äºŒåã€ç§»åŠ¨ç«¯åº”ç”¨è®¾è®¡ï¼ˆuniapp è·¨å¹³å°ï¼‰â­â­â­ Phase A åŸºç¡€è®¾æ–½

[â¬†ï¸ è¿”å›ç›®å½•](#-å®Œæ•´ç›®å½•) | [â¬†ï¸ è¿”å›å¿«é€Ÿå¯¼èˆª](#-å¿«é€Ÿå¯¼èˆª)

> **å»ºè®®ä¸Šçº¿é¡ºåº**: Chapter 17ï¼ˆåœ¨åŠ¨æ€è¡¨å•å¼•æ“å’Œæ‰¹æ¬¡è¿½æº¯ç³»ç»Ÿå®Œæˆåï¼‰
> **ä¼˜å…ˆçº§**: æœ€é«˜ï¼ˆæ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼‰
> **ä¾èµ–**: Chapter 15ï¼ˆåŠ¨æ€è¡¨å•å¼•æ“ï¼‰ã€Chapter 16ï¼ˆæ‰¹æ¬¡è¿½æº¯ç³»ç»Ÿï¼‰
> **è¯´æ˜**: ç§»åŠ¨ç«¯æ˜¯ç°åœºäººå‘˜ï¼ˆç”Ÿäº§ã€ä»“åº“ã€è®¾å¤‡ç»´æŠ¤ï¼‰çš„ä¸»è¦å·¥ä½œç•Œé¢ï¼Œå¿…é¡»åœ¨ä¸šåŠ¡æ¨¡å—å®æ–½å‰å®Œæˆ

> **è®¾è®¡æ—¶é—´**: 2026-02-12
> **æŠ€æœ¯æ–¹æ¡ˆ**: uniapp + Vue 3 + uni-ui
> **ç¼–è¯‘ç›®æ ‡**: å¾®ä¿¡å°ç¨‹åº + H5 + Android APP + iOS APP
> **æ ¸å¿ƒå®šä½**: ç§»åŠ¨ç«¯æ•°æ®é‡‡é›†ä¸å®¡æ‰¹å¹³å°

---

### 20.1 ç³»ç»Ÿå®šä½ä¸æ ¸å¿ƒä¼˜åŠ¿

#### 20.1.1 ç³»ç»Ÿå®šä½

**ç§»åŠ¨ç«¯åº”ç”¨ä½œä¸º PC ç«¯çš„å»¶ä¼¸**ï¼Œä¸“æ³¨äº"ç°åœºæ•°æ®é‡‡é›†"å’Œ"ç§»åŠ¨å®¡æ‰¹"åœºæ™¯ã€‚

**æ ¸å¿ƒèŒè´£**:
1. **ç°åœºæ•°æ®é‡‡é›†**: ç»´ä¿è®°å½•ã€æ£€éªŒè®°å½•ã€æ¸…æ´è®°å½•ç­‰ç°åœºå¡«å†™
2. **ç§»åŠ¨å®¡æ‰¹**: å¾…åŠä»»åŠ¡æŸ¥çœ‹ã€å®¡æ‰¹æ“ä½œ
3. **æ—¥å†è§†å›¾**: ç»´æŠ¤è®¡åˆ’ã€åŸ¹è®­è®¡åˆ’å¯è§†åŒ–
4. **æ¶ˆæ¯é€šçŸ¥**: å¾®ä¿¡æ¨é€ã€ç«™å†…æ¶ˆæ¯
5. **ç¦»çº¿å¡«å†™**: æ— ç½‘ç»œç¯å¢ƒä¹Ÿèƒ½å¡«å†™ï¼Œè”ç½‘åè‡ªåŠ¨åŒæ­¥
6. **æ‰«ç è¿½æº¯**: æ‰«ææ‰¹æ¬¡ç è¿½æº¯ï¼ˆv2.0 æ¡å½¢ç ï¼‰

---

#### 20.1.2 æ ¸å¿ƒä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **ä¸€å¥—ä»£ç å¤šç«¯è¿è¡Œ** | ç¼–è¯‘ä¸ºå¾®ä¿¡å°ç¨‹åº + H5 + APPï¼Œé™ä½å¼€å‘æˆæœ¬ |
| **ç°åœºæ‹ç…§ä¸Šä¼ ** | è°ƒç”¨æ‰‹æœºç›¸æœºï¼Œç°åœºæ‹ç…§ä¸Šä¼  |
| **ç”µå­ç­¾å** | æ‰‹å†™ç­¾å­—æ¿ï¼Œç”µå­ç­¾å |
| **ç¦»çº¿å¡«å†™** | æœ¬åœ°å­˜å‚¨ï¼Œè”ç½‘åè‡ªåŠ¨åŒæ­¥ |
| **å¾®ä¿¡ç”Ÿæ€** | å¾®ä¿¡é€šçŸ¥æ¨é€ï¼Œç”¨æˆ·ä½“éªŒå¥½ |
| **è¯­éŸ³è¾“å…¥** | è¯­éŸ³è½¬æ–‡å­—ï¼Œæé«˜å¡«å†™æ•ˆç‡ |

---

### 20.2 æŠ€æœ¯æ¶æ„

#### 20.2.1 æŠ€æœ¯é€‰å‹

```
å‰ç«¯æŠ€æœ¯æ ˆ:
- uniapp (åŸºäº Vue 3 Composition API)
- uni-ui ç»„ä»¶åº“
- Pinia (çŠ¶æ€ç®¡ç†)
- uni-request (ç½‘ç»œè¯·æ±‚)
- uni-storage (æœ¬åœ°å­˜å‚¨)

ç¼–è¯‘ç›®æ ‡:
- å¾®ä¿¡å°ç¨‹åºï¼ˆä¸»æ¨ï¼Œ80% ç”¨æˆ·ï¼‰
- H5 ç½‘é¡µï¼ˆå¤‡ç”¨ï¼Œ20% ç”¨æˆ·ï¼‰
- Android APPï¼ˆå¯é€‰ï¼‰
- iOS APPï¼ˆå¯é€‰ï¼‰

åç«¯ API:
- å¤ç”¨ PC ç«¯ API
- æ–°å¢ç§»åŠ¨ç«¯ä¸“ç”¨ APIï¼ˆæ–‡ä»¶ä¸Šä¼ ã€æ¶ˆæ¯æ¨é€ï¼‰
```

---

#### 20.2.2 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç§»åŠ¨ç«¯åº”ç”¨å±‚                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ å¾®ä¿¡å°ç¨‹åº   â”‚  â”‚   H5 ç½‘é¡µ   â”‚  â”‚   åŸç”Ÿ APP  â”‚   â”‚
â”‚  â”‚  (80%)      â”‚  â”‚   (15%)     â”‚  â”‚   (5%)      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                 â”‚                â”‚           â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                         â”‚                              â”‚
â”‚                  uniapp ç»Ÿä¸€ç¼–è¯‘                        â”‚
â”‚                         â”‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     åç«¯ API                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  - å¾…åŠä»»åŠ¡ API (å¤ç”¨)                                  â”‚
â”‚  - åŠ¨æ€è¡¨å• API (å¤ç”¨)                                  â”‚
â”‚  - è®°å½•æŸ¥è¯¢ API (å¤ç”¨)                                  â”‚
â”‚  - æ–‡ä»¶ä¸Šä¼  API (ç§»åŠ¨ç«¯ä¼˜åŒ–)                            â”‚
â”‚  - å¾®ä¿¡æ¨é€ API (æ–°å¢)                                  â”‚
â”‚  - ç¦»çº¿åŒæ­¥ API (æ–°å¢)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ç¬¬ä¸‰æ–¹æœåŠ¡                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  - å¾®ä¿¡å°ç¨‹åº API (æ‰«ç ã€æ‹ç…§ã€ä½ç½®)                    â”‚
â”‚  - å¾®ä¿¡å…¬ä¼—å· API (æ¶ˆæ¯æ¨é€)                            â”‚
â”‚  - è…¾è®¯äº‘ COS (æ–‡ä»¶åŠ é€Ÿä¸Šä¼ )                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 20.3 æ ¸å¿ƒåŠŸèƒ½è®¾è®¡

#### 20.3.1 é¦–é¡µï¼ˆ/pages/index/indexï¼‰

```
é¡µé¢å¸ƒå±€:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é¡¶éƒ¨å¯¼èˆªæ                       â”‚
â”‚  [â† è¿”å›] é¦–é¡µ      [ğŸ””æ¶ˆæ¯(3)] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  ç”¨æˆ·ä¿¡æ¯å¡ç‰‡                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ‘¤ å¼ ä¸‰  |  å·¥ç¨‹éƒ¨          â”‚ â”‚
â”‚  â”‚ ä»Šæ—¥å¾…åŠ: 3 ä¸ª               â”‚ â”‚
â”‚  â”‚ æœªè¯»æ¶ˆæ¯: 5 æ¡               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  å¾…åŠä»»åŠ¡ï¼ˆä¼˜å…ˆï¼‰                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ”§ è®¾å¤‡ç»´ä¿å¾…åŠ              â”‚ â”‚
â”‚  â”‚ æ…æ‹ŒæœºAéœ€è¦ç»´ä¿              â”‚ â”‚
â”‚  â”‚ æˆªæ­¢æ—¥æœŸ: 2024-06-15         â”‚ â”‚
â”‚  â”‚                [å»å¤„ç† â†’]   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ âœ… æ¸…æ´æ¶ˆæ¯’è®°å½•å¾…å®¡æ‰¹        â”‚ â”‚
â”‚  â”‚ å¼ ä¸‰æäº¤çš„æ¸…æ´è®°å½•           â”‚ â”‚
â”‚  â”‚ æäº¤æ—¶é—´: 2024-06-14 15:30  â”‚ â”‚
â”‚  â”‚                [å»å®¡æ‰¹ â†’]   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  å¿«æ·å…¥å£ï¼ˆå®«æ ¼ï¼‰                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ğŸ“  â”‚ ğŸ“‹  â”‚ ğŸ“…  â”‚ ğŸ“Š  â”‚    â”‚
â”‚  â”‚è®°å½•  â”‚æŸ¥è¯¢  â”‚æ—¥å†  â”‚ç»Ÿè®¡  â”‚    â”‚
â”‚  â”‚å¡«å†™  â”‚è®°å½•  â”‚è§†å›¾  â”‚åˆ†æ  â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚ ğŸ”  â”‚ ğŸ“¦  â”‚ ğŸ”§  â”‚ âš™ï¸  â”‚    â”‚
â”‚  â”‚æ‰«ç   â”‚ä»“åº“  â”‚è®¾å¤‡  â”‚è®¾ç½®  â”‚    â”‚
â”‚  â”‚è¿½æº¯  â”‚ç®¡ç†  â”‚å°è´¦  â”‚     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åº•éƒ¨ Tabbar:
[é¦–é¡µ] [å¾…åŠ] [è®°å½•] [æˆ‘çš„]
```

---

#### 20.3.2 å¾…åŠåˆ—è¡¨ï¼ˆ/pages/todo/listï¼‰

```
é¡µé¢å¸ƒå±€:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [â† è¿”å›] æˆ‘çš„å¾…åŠ               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  Tab åˆ‡æ¢                        â”‚
â”‚  [å¾…å¤„ç†(3)] [å·²å®Œæˆ(15)]        â”‚
â”‚                                 â”‚
â”‚  å¾…å¤„ç†åˆ—è¡¨ï¼ˆå¡ç‰‡å¼ï¼‰             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ”§ è®¾å¤‡ç»´ä¿å¾…åŠ              â”‚ â”‚
â”‚  â”‚ æ…æ‹ŒæœºAéœ€è¦æ—¥å¸¸ä¿å…»          â”‚ â”‚
â”‚  â”‚ è®¡åˆ’æ—¥æœŸ: 2024-06-15         â”‚ â”‚
â”‚  â”‚ æå‰ 2 å¤©æé†’               â”‚ â”‚
â”‚  â”‚ [å¼€å§‹ç»´ä¿]                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ âœ… æ¸…æ´æ¶ˆæ¯’è®°å½•å¾…å®¡æ‰¹        â”‚ â”‚
â”‚  â”‚ å¼ ä¸‰ | ç”Ÿäº§è½¦é—´æ¸…æ´          â”‚ â”‚
â”‚  â”‚ æäº¤æ—¶é—´: 2024-06-14 15:30  â”‚ â”‚
â”‚  â”‚ [æŸ¥çœ‹è¯¦æƒ…] [å®¡æ‰¹]            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ“‹ é¢†æ–™å•å¾…å®¡æ‰¹              â”‚ â”‚
â”‚  â”‚ æå›› | é¢ç²‰ 100kg            â”‚ â”‚
â”‚  â”‚ æäº¤æ—¶é—´: 2024-06-14 10:00  â”‚ â”‚
â”‚  â”‚ [æŸ¥çœ‹è¯¦æƒ…] [å®¡æ‰¹]            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  å·²å®Œæˆåˆ—è¡¨                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ âœ… è®¾å¤‡ç»´ä¿è®°å½•              â”‚ â”‚
â”‚  â”‚ çƒ¤ç®±Bå¹´åº¦æ£€ä¿® | å·²å®¡æ‰¹       â”‚ â”‚
â”‚  â”‚ å®Œæˆæ—¶é—´: 2024-06-10         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### 20.3.3 åŠ¨æ€è¡¨å•å¡«å†™ï¼ˆ/pages/records/createï¼‰

```
é¡µé¢å¸ƒå±€ï¼ˆä»¥è®¾å¤‡ç»´ä¿è®°å½•ä¸ºä¾‹ï¼‰:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [â† è¿”å›] è®¾å¤‡ç»´ä¿è®°å½•           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  è¡¨å•å­—æ®µï¼ˆåŠ¨æ€æ¸²æŸ“ï¼‰             â”‚
â”‚                                 â”‚
â”‚  è®¾å¤‡ç¼–å· *                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ è¯·é€‰æ‹©è®¾å¤‡       [â–¼]       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  è®¾å¤‡åç§°ï¼ˆè‡ªåŠ¨å¸¦å‡ºï¼‰             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ…æ‹ŒæœºA                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  ç»´ä¿æ—¥æœŸ *                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 2024-06-15      [ğŸ“…]      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  ç»´ä¿ç±»å‹ *                      â”‚
â”‚  â—‹ æ—¥å¸¸ä¿å…»  â—‹ æ•…éšœç»´ä¿®  â—‹ å¹´åº¦æ£€ä¿®â”‚
â”‚                                 â”‚
â”‚  ç»´ä¿å†…å®¹ *                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ è¯·è¾“å…¥ç»´ä¿å†…å®¹...           â”‚ â”‚
â”‚  â”‚                           â”‚ â”‚
â”‚  â”‚                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  ç°åœºç…§ç‰‡                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ ğŸ“·  â”‚ ğŸ“·  â”‚  +  â”‚          â”‚
â”‚  â”‚     â”‚     â”‚æ·»åŠ  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                 â”‚
â”‚  ç»´ä¿äººå‘˜ç­¾å *                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                           â”‚ â”‚
â”‚  â”‚    è¯·åœ¨æ­¤å¤„ç­¾å âœï¸          â”‚ â”‚
â”‚  â”‚                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  [æ¸…é™¤] [é‡ç­¾]                  â”‚
â”‚                                 â”‚
â”‚  æ“ä½œæŒ‰é’®                        â”‚
â”‚  [ä¿å­˜è‰ç¨¿]      [æäº¤å®¡æ‰¹]     â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç§»åŠ¨ç«¯ç‰¹æœ‰åŠŸèƒ½:
- æ‹ç…§: è°ƒç”¨æ‰‹æœºç›¸æœºï¼Œç°åœºæ‹ç…§
- ç­¾å: æ‰‹å†™ç­¾å­—æ¿ï¼Œæ”¯æŒè§¦æ‘¸ç­¾å
- è¯­éŸ³: è¯­éŸ³è¾“å…¥ç»´ä¿å†…å®¹ï¼ˆv2.0ï¼‰
- æ‰«ç : æ‰«æè®¾å¤‡äºŒç»´ç è‡ªåŠ¨å¡«å……ï¼ˆv2.0ï¼‰
```

---

#### 20.3.4 æ—¥å†è§†å›¾ï¼ˆ/pages/calendar/indexï¼‰

```
é¡µé¢å¸ƒå±€:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [â† è¿”å›] ç»´æŠ¤è®¡åˆ’æ—¥å†           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  æœˆä»½åˆ‡æ¢                        â”‚
â”‚  [<] 2024 å¹´ 6 æœˆ [>]           â”‚
â”‚                                 â”‚
â”‚  æ—¥å†                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ æ—¥ ä¸€ äºŒ ä¸‰ å›› äº” å…­         â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚       1   2   3             â”‚â”‚
â”‚  â”‚   ğŸ”§      ğŸ”§                 â”‚â”‚
â”‚  â”‚ 4   5   6   7   8   9  10   â”‚â”‚
â”‚  â”‚ğŸ”§                            â”‚â”‚
â”‚  â”‚11  12  13  14  15  16  17   â”‚â”‚
â”‚  â”‚         ğŸ”§  ğŸ”§               â”‚â”‚
â”‚  â”‚18  19  20  21  22  23  24   â”‚â”‚
â”‚  â”‚                              â”‚â”‚
â”‚  â”‚25  26  27  28  29  30       â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                 â”‚
â”‚  ä»Šæ—¥è®¡åˆ’ï¼ˆ2024-06-15ï¼‰          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ”§ æ…æ‹ŒæœºA - æ—¥å¸¸ä¿å…»        â”‚ â”‚
â”‚  â”‚ è´£ä»»äºº: å¼ ä¸‰                â”‚ â”‚
â”‚  â”‚ çŠ¶æ€: å¾…æ‰§è¡Œ                â”‚ â”‚
â”‚  â”‚         [å¼€å§‹ç»´ä¿]          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ”§ çƒ¤ç®±B - å¹´åº¦æ£€ä¿®          â”‚ â”‚
â”‚  â”‚ è´£ä»»äºº: æå››                â”‚ â”‚
â”‚  â”‚ çŠ¶æ€: è¿›è¡Œä¸­                â”‚ â”‚
â”‚  â”‚         [æŸ¥çœ‹è¯¦æƒ…]          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### 20.3.5 è®°å½•æŸ¥è¯¢ï¼ˆ/pages/records/listï¼‰

```
é¡µé¢å¸ƒå±€:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [â† è¿”å›] è®°å½•æŸ¥è¯¢               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  æœç´¢æ¡†                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ” æœç´¢è®°å½•ç¼–å·/è®¾å¤‡å...   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  ç­›é€‰æ¡ä»¶ï¼ˆæŠ˜å å¼ï¼‰               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç­›é€‰  [â–¼]                   â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ éƒ¨é—¨: [å…¨éƒ¨ â–¼]              â”‚ â”‚
â”‚  â”‚ è®°å½•ç±»å‹: [å…¨éƒ¨ â–¼]          â”‚ â”‚
â”‚  â”‚ çŠ¶æ€: [å…¨éƒ¨ â–¼]              â”‚ â”‚
â”‚  â”‚ æ—¶é—´: [æœ€è¿‘ä¸€å‘¨ â–¼]          â”‚ â”‚
â”‚  â”‚         [é‡ç½®] [åº”ç”¨]       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  å¿«æ·ç­›é€‰ï¼ˆTagï¼‰                 â”‚
â”‚  [å…¨éƒ¨] [å¾…å®¡æ‰¹] [å·²å®¡æ‰¹] [è‰ç¨¿]â”‚
â”‚                                 â”‚
â”‚  è®°å½•åˆ—è¡¨ï¼ˆå¡ç‰‡å¼ï¼‰               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ è®¾å¤‡ç»´ä¿è®°å½•                â”‚ â”‚
â”‚  â”‚ MAINT-20240615-001         â”‚ â”‚
â”‚  â”‚ ç»´ä¿æ—¥æœŸ: 2024-06-15        â”‚ â”‚
â”‚  â”‚ è®¾å¤‡: æ…æ‹ŒæœºA               â”‚ â”‚
â”‚  â”‚ çŠ¶æ€: âœ… å·²å®¡æ‰¹             â”‚ â”‚
â”‚  â”‚         [æŸ¥çœ‹è¯¦æƒ…]          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ¸…æ´æ¶ˆæ¯’è®°å½•                â”‚ â”‚
â”‚  â”‚ CLEAN-20240614-002         â”‚ â”‚
â”‚  â”‚ æ¸…æ´æ—¥æœŸ: 2024-06-14        â”‚ â”‚
â”‚  â”‚ åŒºåŸŸ: ç”Ÿäº§è½¦é—´              â”‚ â”‚
â”‚  â”‚ çŠ¶æ€: â³ å¾…å®¡æ‰¹             â”‚ â”‚
â”‚  â”‚         [æŸ¥çœ‹è¯¦æƒ…]          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  [åŠ è½½æ›´å¤š...]                  â”‚
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 20.4 ç§»åŠ¨ç«¯ç‰¹æœ‰åŠŸèƒ½å®ç°

#### 20.4.1 æ‹ç…§ä¸Šä¼ 

```vue
<!-- æ‹ç…§ä¸Šä¼ ç»„ä»¶ -->
<template>
  <view class="photo-upload">
    <view class="photo-list">
      <view 
        v-for="(photo, index) in photos" 
        :key="index"
        class="photo-item"
      >
        <image :src="photo" mode="aspectFill" />
        <view class="photo-delete" @click="handleDelete(index)">
          <text>Ã—</text>
        </view>
      </view>
      
      <view 
        v-if="photos.length < maxCount"
        class="photo-add"
        @click="handleChooseImage"
      >
        <text class="icon">ğŸ“·</text>
        <text class="text">æ‹ç…§</text>
      </view>
    </view>
  </view>
</template>

<script setup>
import { ref } from 'vue'

const props = defineProps({
  maxCount: { type: Number, default: 9 },
  maxSize: { type: Number, default: 5 } // MB
})

const photos = ref([])

// é€‰æ‹©å›¾ç‰‡ï¼ˆæ‹ç…§æˆ–ç›¸å†Œï¼‰
async function handleChooseImage() {
  uni.chooseImage({
    count: props.maxCount - photos.value.length,
    sizeType: ['compressed'], // å‹ç¼©å›¾
    sourceType: ['camera', 'album'], // ç›¸æœº + ç›¸å†Œ
    success: async (res) => {
      const tempFilePaths = res.tempFilePaths
      
      // ä¸Šä¼ åˆ°æœåŠ¡å™¨
      for (const filePath of tempFilePaths) {
        const uploadedUrl = await uploadImage(filePath)
        photos.value.push(uploadedUrl)
      }
    }
  })
}

// ä¸Šä¼ å›¾ç‰‡
async function uploadImage(filePath) {
  return new Promise((resolve, reject) => {
    uni.uploadFile({
      url: '/api/upload',
      filePath: filePath,
      name: 'file',
      success: (uploadRes) => {
        const data = JSON.parse(uploadRes.data)
        resolve(data.url)
      },
      fail: reject
    })
  })
}

// åˆ é™¤å›¾ç‰‡
function handleDelete(index) {
  photos.value.splice(index, 1)
}
</script>
```

---

#### 20.4.2 ç”µå­ç­¾å

```vue
<!-- ç”µå­ç­¾åç»„ä»¶ -->
<template>
  <view class="signature-pad">
    <canvas 
      canvas-id="signatureCanvas"
      class="canvas"
      @touchstart="handleTouchStart"
      @touchmove="handleTouchMove"
      @touchend="handleTouchEnd"
    />
    
    <view class="actions">
      <button @click="handleClear">æ¸…é™¤</button>
      <button @click="handleSave" type="primary">ä¿å­˜</button>
    </view>
  </view>
</template>

<script setup>
import { ref, onMounted } from 'vue'

const canvasContext = ref(null)
const isDrawing = ref(false)
const lastPoint = ref({ x: 0, y: 0 })

onMounted(() => {
  canvasContext.value = uni.createCanvasContext('signatureCanvas')
  canvasContext.value.setStrokeStyle('#000')
  canvasContext.value.setLineWidth(3)
  canvasContext.value.setLineCap('round')
})

function handleTouchStart(e) {
  isDrawing.value = true
  const touch = e.touches[0]
  lastPoint.value = { x: touch.x, y: touch.y }
}

function handleTouchMove(e) {
  if (!isDrawing.value) return
  
  const touch = e.touches[0]
  const currentPoint = { x: touch.x, y: touch.y }
  
  canvasContext.value.beginPath()
  canvasContext.value.moveTo(lastPoint.value.x, lastPoint.value.y)
  canvasContext.value.lineTo(currentPoint.x, currentPoint.y)
  canvasContext.value.stroke()
  canvasContext.value.draw(true)
  
  lastPoint.value = currentPoint
}

function handleTouchEnd() {
  isDrawing.value = false
}

function handleClear() {
  canvasContext.value.clearRect(0, 0, 400, 200)
  canvasContext.value.draw()
}

async function handleSave() {
  uni.canvasToTempFilePath({
    canvasId: 'signatureCanvas',
    success: async (res) => {
      const signatureUrl = await uploadSignature(res.tempFilePath)
      emit('update:modelValue', signatureUrl)
      uni.showToast({ title: 'ç­¾åä¿å­˜æˆåŠŸ' })
    }
  })
}

async function uploadSignature(filePath) {
  return new Promise((resolve, reject) => {
    uni.uploadFile({
      url: '/api/upload',
      filePath: filePath,
      name: 'file',
      success: (uploadRes) => {
        const data = JSON.parse(uploadRes.data)
        resolve(data.url)
      },
      fail: reject
    })
  })
}
</script>
```

---

#### 20.4.3 ç¦»çº¿å¡«å†™ä¸åŒæ­¥

```typescript
// utils/offline.ts

import { ref } from 'vue'

// ç¦»çº¿æ•°æ®é˜Ÿåˆ—
const offlineQueue = ref<any[]>([])

// æ£€æŸ¥ç½‘ç»œçŠ¶æ€
async function checkNetwork() {
  return new Promise<boolean>((resolve) => {
    uni.getNetworkType({
      success: (res) => {
        resolve(res.networkType !== 'none')
      },
      fail: () => resolve(false)
    })
  })
}

// ä¿å­˜åˆ°ç¦»çº¿é˜Ÿåˆ—
export async function saveToOfflineQueue(data: any) {
  const queueItem = {
    ...data,
    timestamp: Date.now(),
    synced: false,
    retryCount: 0
  }
  
  offlineQueue.value.push(queueItem)
  
  // å­˜å‚¨åˆ°æœ¬åœ°
  uni.setStorageSync('offlineQueue', offlineQueue.value)
  
  // å°è¯•åŒæ­¥
  await syncOfflineData()
}

// åŒæ­¥ç¦»çº¿æ•°æ®
export async function syncOfflineData() {
  const isOnline = await checkNetwork()
  if (!isOnline) {
    console.log('ç½‘ç»œä¸å¯ç”¨ï¼Œæš‚ä¸åŒæ­¥')
    return
  }
  
  const queue = uni.getStorageSync('offlineQueue') || []
  
  for (const item of queue) {
    if (item.synced) continue
    
    try {
      // ä¸Šä¼ åˆ°æœåŠ¡å™¨
      const res = await uni.request({
        url: '/api/records',
        method: 'POST',
        data: item.data
      })
      
      // æ ‡è®°ä¸ºå·²åŒæ­¥
      item.synced = true
      
      uni.showToast({ title: 'æ•°æ®å·²åŒæ­¥' })
    } catch (error) {
      console.error('åŒæ­¥å¤±è´¥', error)
      
      // é‡è¯•è®¡æ•°
      item.retryCount++
      
      // é‡è¯•æ¬¡æ•°è¶…è¿‡ 3 æ¬¡ï¼Œæç¤ºç”¨æˆ·
      if (item.retryCount >= 3) {
        uni.showToast({ 
          title: 'æ•°æ®åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 
          icon: 'none' 
        })
      }
    }
  }
  
  // æ›´æ–°å­˜å‚¨ï¼ˆç§»é™¤å·²åŒæ­¥çš„ï¼‰
  const unsynced = queue.filter(item => !item.synced)
  uni.setStorageSync('offlineQueue', unsynced)
  
  // æ›´æ–°é˜Ÿåˆ—
  offlineQueue.value = unsynced
}

// ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
uni.onNetworkStatusChange((res) => {
  if (res.isConnected) {
    console.log('ç½‘ç»œå·²è¿æ¥ï¼Œå¼€å§‹åŒæ­¥')
    syncOfflineData()
  }
})

// è·å–æœªåŒæ­¥æ•°æ®æ•°é‡
export function getUnsyncedCount() {
  return offlineQueue.value.filter(item => !item.synced).length
}
```

---

#### 20.4.4 å¾®ä¿¡æ¶ˆæ¯æ¨é€

```typescript
// server/src/wechat/wechat.service.ts

import { Injectable } from '@nestjs/common';
import axios from 'axios';

@Injectable()
export class WechatService {
  private readonly appId = process.env.WECHAT_APPID;
  private readonly appSecret = process.env.WECHAT_APPSECRET;
  private accessToken: string;
  
  // è·å– Access Token
  async getAccessToken() {
    if (this.accessToken) {
      return this.accessToken;
    }
    
    const res = await axios.get(
      `https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=${this.appId}&secret=${this.appSecret}`
    );
    
    this.accessToken = res.data.access_token;
    
    // 2 å°æ—¶åè¿‡æœŸï¼Œæå‰ 10 åˆ†é’Ÿåˆ·æ–°
    setTimeout(() => {
      this.accessToken = null;
    }, 110 * 60 * 1000);
    
    return this.accessToken;
  }
  
  // å‘é€è®¢é˜…æ¶ˆæ¯ï¼ˆå¾…åŠæé†’ï¼‰
  async sendTodoNotification(userId: string, todo: any) {
    const openId = await this.getUserOpenId(userId);
    const accessToken = await this.getAccessToken();
    
    const data = {
      touser: openId,
      template_id: process.env.WECHAT_TEMPLATE_TODO,
      page: `/pages/todo/detail?id=${todo.id}`,
      data: {
        thing1: { value: todo.title },         // å¾…åŠæ ‡é¢˜
        time2: { value: todo.dueDate },        // æˆªæ­¢æ—¶é—´
        thing3: { value: todo.type },          // å¾…åŠç±»å‹
      }
    };
    
    await axios.post(
      `https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token=${accessToken}`,
      data
    );
  }
  
  // å‘é€ä¸´æœŸé¢„è­¦
  async sendExpiryAlert(userId: string, batch: any) {
    const openId = await this.getUserOpenId(userId);
    const accessToken = await this.getAccessToken();
    
    const data = {
      touser: openId,
      template_id: process.env.WECHAT_TEMPLATE_EXPIRY,
      page: `/pages/warehouse/batch-detail?id=${batch.id}`,
      data: {
        thing1: { value: `ç‰©æ–™æ‰¹æ¬¡ ${batch.batchNumber}` },
        date2: { value: batch.expiryDate },
        thing3: { value: 'å³å°†è¿‡æœŸï¼Œè¯·å°½å¿«å¤„ç†' },
      }
    };
    
    await axios.post(
      `https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token=${accessToken}`,
      data
    );
  }
  
  // å‘é€å®¡æ‰¹é€šçŸ¥
  async sendApprovalNotification(userId: string, record: any) {
    const openId = await this.getUserOpenId(userId);
    const accessToken = await this.getAccessToken();
    
    const data = {
      touser: openId,
      template_id: process.env.WECHAT_TEMPLATE_APPROVAL,
      page: `/pages/records/detail?id=${record.id}`,
      data: {
        thing1: { value: record.templateName },  // è®°å½•ç±»å‹
        thing2: { value: record.createdByName }, // æäº¤äºº
        time3: { value: record.submittedAt },    // æäº¤æ—¶é—´
      }
    };
    
    await axios.post(
      `https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token=${accessToken}`,
      data
    );
  }
  
  // è·å–ç”¨æˆ· OpenID
  private async getUserOpenId(userId: string): Promise<string> {
    // ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·çš„ OpenID
    const user = await this.userService.findOne(userId);
    return user.wechatOpenId;
  }
}
```

---

### 20.5 API è®¾è®¡(4 ä¸ªç§»åŠ¨ç«¯ä¸“ç”¨ API)

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | è¯·æ±‚ä½“ | å“åº” |
|------|------|------|--------|------|
| POST | `/api/mobile/upload` | ç§»åŠ¨ç«¯æ–‡ä»¶ä¸Šä¼ ï¼ˆä¼˜åŒ–ï¼‰ | `FormData(file)` | `{ url, thumbnail }` |
| POST | `/api/mobile/sync` | ç¦»çº¿æ•°æ®åŒæ­¥ | `{ queue: [...] }` | `{ success: true, synced: number }` |
| GET | `/api/mobile/config` | è·å–å°ç¨‹åºé…ç½® | - | `{ appId, version, ... }` |
| POST | `/api/mobile/feedback` | ç”¨æˆ·åé¦ˆ | `{ content, images }` | `{ success: true }` |

---

### 20.6 å¼€å‘å·¥ä½œé‡ä¼°ç®—

#### 20.6.1 ç§»åŠ¨ç«¯å¼€å‘(5 å‘¨)

| æ¨¡å— | å·¥ä½œé‡ | è¯´æ˜ |
|------|--------|------|
| **åŸºç¡€æ¡†æ¶æ­å»º** | 0.5 å‘¨ | uniapp é¡¹ç›®åˆå§‹åŒ– + è·¯ç”± + çŠ¶æ€ç®¡ç† |
| **é¦–é¡µ + å¾…åŠåˆ—è¡¨** | 0.5 å‘¨ | é¦–é¡µå¸ƒå±€ + å¾…åŠåˆ—è¡¨ |
| **åŠ¨æ€è¡¨å•æ¸²æŸ“** | 1.5 å‘¨ | æ”¯æŒ 20+ å­—æ®µç±»å‹ï¼ˆç§»åŠ¨ç«¯é€‚é…ï¼‰ |
| **æ‹ç…§ + ç­¾å** | 0.5 å‘¨ | æ‹ç…§ä¸Šä¼  + ç”µå­ç­¾åç»„ä»¶ |
| **ç¦»çº¿å¡«å†™** | 0.5 å‘¨ | æœ¬åœ°å­˜å‚¨ + åŒæ­¥é˜Ÿåˆ— |
| **æ—¥å†è§†å›¾** | 0.5 å‘¨ | æ—¥å†ç»„ä»¶ + è®¡åˆ’å±•ç¤º |
| **è®°å½•æŸ¥è¯¢** | 0.5 å‘¨ | æŸ¥è¯¢åˆ—è¡¨ + ç­›é€‰ |
| **å¾®ä¿¡æ¨é€é›†æˆ** | 0.5 å‘¨ | è®¢é˜…æ¶ˆæ¯ + æ¨¡æ¿é…ç½® |
| **E2E æµ‹è¯•** | 0.5 å‘¨ | å…³é”®æµç¨‹æµ‹è¯• |

**ç§»åŠ¨ç«¯åˆè®¡: 5 å‘¨**

---

#### 20.6.2 åç«¯ API è°ƒæ•´(1 å‘¨)

| æ¨¡å— | å·¥ä½œé‡ | è¯´æ˜ |
|------|--------|------|
| **æ–‡ä»¶ä¸Šä¼ ä¼˜åŒ–** | 0.3 å‘¨ | ç§»åŠ¨ç«¯æ–‡ä»¶å‹ç¼© + ç¼©ç•¥å›¾ |
| **ç¦»çº¿åŒæ­¥ API** | 0.3 å‘¨ | æ‰¹é‡åŒæ­¥æ¥å£ |
| **å¾®ä¿¡æ¨é€æœåŠ¡** | 0.4 å‘¨ | å¾®ä¿¡ API é›†æˆ + æ¶ˆæ¯æ¨¡æ¿ |

**åç«¯åˆè®¡: 1 å‘¨**

---

#### 20.6.3 æ€»å·¥ä½œé‡

| é˜¶æ®µ | å·¥ä½œé‡ | è¯´æ˜ |
|------|--------|------|
| **ç§»åŠ¨ç«¯å¼€å‘** | 5 å‘¨ | åŒ…å« E2E æµ‹è¯• |
| **åç«¯ API è°ƒæ•´** | 1 å‘¨ | ç§»åŠ¨ç«¯ä¸“ç”¨ API |
| **è”è°ƒæµ‹è¯•** | 0.5 å‘¨ | ç§»åŠ¨ç«¯ + åç«¯è”è°ƒ |
| **å°ç¨‹åºå®¡æ ¸** | 1 å‘¨ | å¾®ä¿¡å°ç¨‹åºæå®¡ + å‘å¸ƒ |

**æ€»è®¡: 7.5 å‘¨ï¼ˆçº¦ 2 ä¸ªæœˆï¼‰**

**å¹¶è¡Œå¼€å‘**(1 åç§»åŠ¨ç«¯ + 1 ååç«¯): **çº¦ 5 å‘¨**

---

### 20.7 ä¾èµ–ä¸é£é™©

#### 20.7.1 æŠ€æœ¯ä¾èµ–

| ä¾èµ–é¡¹ | ç‰ˆæœ¬ | ç”¨é€” | é£é™©ç­‰çº§ |
|--------|------|------|----------|
| **uniapp** | æœ€æ–°ç‰ˆ | è·¨å¹³å°å¼€å‘æ¡†æ¶ | ä½ |
| **uni-ui** | æœ€æ–°ç‰ˆ | UI ç»„ä»¶åº“ | ä½ |
| **å¾®ä¿¡å°ç¨‹åº API** | æœ€æ–°ç‰ˆ | æ‹ç…§ã€æ‰«ç ã€æ¨é€ | ä½ |
| **è…¾è®¯äº‘ COS** | æœ€æ–°ç‰ˆ | æ–‡ä»¶åŠ é€Ÿä¸Šä¼  | ä½ |

**å…³é”®ä¾èµ–**:
- âœ… uniapp ç¤¾åŒºæˆç†Ÿï¼Œé£é™©ä½
- âœ… å¾®ä¿¡å°ç¨‹åº API ç¨³å®š

---

#### 20.7.2 ä¸šåŠ¡é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| **å¾®ä¿¡å°ç¨‹åºå®¡æ ¸ä¸é€šè¿‡** | æ— æ³•ä¸Šçº¿ | ä¸­ | æå‰äº†è§£å®¡æ ¸è§„åˆ™ï¼Œé¿å…è¿è§„å†…å®¹ |
| **ç¦»çº¿åŒæ­¥æ•°æ®ä¸¢å¤±** | ç”¨æˆ·æ•°æ®ä¸¢å¤± | ä½ | æœ¬åœ°æŒä¹…åŒ–å­˜å‚¨ï¼ŒåŒæ­¥å¤±è´¥é‡è¯• |
| **æ‹ç…§æ–‡ä»¶è¿‡å¤§** | ä¸Šä¼ å¤±è´¥ | ä¸­ | è‡ªåŠ¨å‹ç¼©å›¾ç‰‡ï¼Œé™åˆ¶å¤§å° |
| **ç”µå­ç­¾åä¸æ¸…æ™°** | å®¡è®¡é—®é¢˜ | ä½ | ç­¾åé¢„è§ˆç¡®è®¤ï¼Œæ”¯æŒé‡ç­¾ |

---

### 20.8 æˆåŠŸæ ‡å‡†

**ç§»åŠ¨ç«¯åŸºç¡€åŠŸèƒ½**:
- âœ… ä¸€å¥—ä»£ç ç¼–è¯‘ä¸ºå¾®ä¿¡å°ç¨‹åº + H5 + APP
- âœ… é¦–é¡µ + å¾…åŠåˆ—è¡¨ + è®°å½•æŸ¥è¯¢

**ç§»åŠ¨ç«¯ç‰¹æœ‰åŠŸèƒ½**:
- âœ… ç°åœºæ‹ç…§ä¸Šä¼ ï¼ˆè°ƒç”¨ç›¸æœºï¼‰
- âœ… ç”µå­ç­¾åï¼ˆæ‰‹å†™ç­¾å­—æ¿ï¼‰
- âœ… ç¦»çº¿å¡«å†™ï¼ˆæœ¬åœ°å­˜å‚¨ + è‡ªåŠ¨åŒæ­¥ï¼‰

**åŠ¨æ€è¡¨å•æ¸²æŸ“**:
- âœ… æ”¯æŒ 20+ å­—æ®µç±»å‹ï¼ˆç§»åŠ¨ç«¯é€‚é…ï¼‰
- âœ… å®æ—¶æ ¡éªŒã€è‡ªåŠ¨ä¿å­˜è‰ç¨¿

**å¾®ä¿¡ç”Ÿæ€é›†æˆ**:
- âœ… å¾®ä¿¡è®¢é˜…æ¶ˆæ¯æ¨é€
- âœ… å¾®ä¿¡æ‰«ç ï¼ˆv2.0 æ¡å½¢ç ï¼‰

---

**æœ¬ç« èŠ‚å®Œæˆ âœ…**


---

## äºŒåä¸€ã€ç³»ç»Ÿè¿ç»´ä¸ç›‘æ§è®¾è®¡ â­â­â­ Phase A åŸºç¡€è®¾æ–½

[â¬†ï¸ è¿”å›ç›®å½•](#-å®Œæ•´ç›®å½•) | [â¬†ï¸ è¿”å›å¿«é€Ÿå¯¼èˆª](#-å¿«é€Ÿå¯¼èˆª)

> **å»ºè®®ä¸Šçº¿é¡ºåº**: Chapter 21ï¼ˆä¸ Phase A å…¶ä»–æ¨¡å—åŒæ­¥å®æ–½ï¼‰
> **ä¼˜å…ˆçº§**: æœ€é«˜ï¼ˆç³»ç»Ÿç¨³å®šæ€§ä¿éšœï¼‰
> **ä¾èµ–**: æ— ï¼ˆç‹¬ç«‹æ¨¡å—ï¼‰
> **è¯´æ˜**: æœ¬ç« èŠ‚å®šä¹‰ç³»ç»Ÿè¿ç»´ã€ç›‘æ§ã€å¤‡ä»½ã€éƒ¨ç½²ã€å®¡è®¡æ—¥å¿—çš„å®Œæ•´æ–¹æ¡ˆ

> **è®¾è®¡æ—¶é—´**: 2026-02-12
> **ç³»ç»Ÿç‰ˆæœ¬**: v1.0.0 (MVP)
> **å®¡æŸ¥æ¥æº**: IT ç³»ç»Ÿç®¡ç†å‘˜ï¼ˆæå·¥ï¼‰å¤šéƒ¨é—¨éœ€æ±‚å®¡æŸ¥
---

### 21.1 æ•°æ®å¤‡ä»½ä¸æ¢å¤è®¾è®¡

#### 21.1.1 å¤‡ä»½ç­–ç•¥æ€»è§ˆ

| å¤‡ä»½å¯¹è±¡ | å¤‡ä»½æ–¹å¼ | å¤‡ä»½é¢‘ç‡ | ä¿ç•™æ—¶é•¿ | RPO | RTO |
|---------|---------|---------|---------|-----|-----|
| PostgreSQL | pg_dump å…¨é‡ | æ¯å¤©å‡Œæ™¨ 2:00 | 7 å¤© | 24h | 2h |
| MinIO æ–‡ä»¶ | mc mirror | æ¯å¤©å‡Œæ™¨ 3:00 | 7 å¤© | 24h | 2h |
| Redis | RDB å¿«ç…§ | æ¯å¤©å‡Œæ™¨ 1:00 | 3 å¤© | 24h | 1h |
| åº”ç”¨é…ç½® | Git ç‰ˆæœ¬æ§åˆ¶ | å®æ—¶ | æ°¸ä¹… | 0 | 10min |

**RPOï¼ˆRecovery Point Objectiveï¼‰**: æ•°æ®æ¢å¤ç‚¹ç›®æ ‡ï¼Œæœ€å¤šä¸¢å¤± 24 å°æ—¶æ•°æ®
**RTOï¼ˆRecovery Time Objectiveï¼‰**: æ¢å¤æ—¶é—´ç›®æ ‡ï¼Œ2 å°æ—¶å†…æ¢å¤ç³»ç»Ÿ

---

#### 21.1.2 PostgreSQL å¤‡ä»½æ–¹æ¡ˆ

**æ–¹æ¡ˆï¼špg_dump + å®šæ—¶ä»»åŠ¡ + æœ¬åœ°å­˜å‚¨**

**Docker Compose é…ç½®**ï¼š

```yaml
# docker-compose.yml æ–°å¢å¤‡ä»½æœåŠ¡
services:
  postgres-backup:
    image: postgres:15
    container_name: doc_postgres_backup
    restart: unless-stopped
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_DB=document_system
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - ./backups/postgres:/backups
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        echo "ç­‰å¾… PostgreSQL å¯åŠ¨..."
        sleep 30
        echo "å¼€å§‹å¤‡ä»½å¾ªç¯..."
        while true; do
          timestamp=$(date +%Y%m%d_%H%M%S)
          echo "[$(date)] å¼€å§‹å¤‡ä»½æ•°æ®åº“..."
          PGPASSWORD=${POSTGRES_PASSWORD} pg_dump \
            -h postgres \
            -U ${POSTGRES_USER} \
            -d document_system \
            --format=custom \
            --compress=9 \
            > /backups/backup_$timestamp.dump

          if [ $? -eq 0 ]; then
            echo "[$(date)] å¤‡ä»½æˆåŠŸ: backup_$timestamp.dump"
          else
            echo "[$(date)] å¤‡ä»½å¤±è´¥!"
          fi

          # åªä¿ç•™æœ€è¿‘ 7 å¤©çš„å¤‡ä»½
          find /backups -name "backup_*.dump" -mtime +7 -delete
          echo "[$(date)] æ¸…ç†æ—§å¤‡ä»½å®Œæˆ"

          # ç­‰å¾… 24 å°æ—¶
          sleep 86400
        done
    depends_on:
      - postgres
```

**æ‰‹åŠ¨å¤‡ä»½å‘½ä»¤**ï¼š
```bash
# ç«‹å³æ‰§è¡Œå¤‡ä»½
docker exec doc_postgres_backup bash -c 'PGPASSWORD=${POSTGRES_PASSWORD} pg_dump -h postgres -U ${POSTGRES_USER} -d document_system --format=custom > /backups/manual_$(date +%Y%m%d_%H%M%S).dump'

# éªŒè¯å¤‡ä»½æ–‡ä»¶
ls -lh backups/postgres/
```

**æ¢å¤å‘½ä»¤**ï¼š
```bash
# 1. åœæ­¢åº”ç”¨æœåŠ¡
docker-compose stop server

# 2. æ¢å¤æ•°æ®åº“
docker exec -i doc_postgres pg_restore \
  -U postgres \
  -d document_system \
  --clean \
  --if-exists \
  < backups/postgres/backup_20260212_020000.dump

# 3. é‡å¯åº”ç”¨
docker-compose start server
```

---

#### 21.1.3 MinIO æ–‡ä»¶å¤‡ä»½æ–¹æ¡ˆ

**æ–¹æ¡ˆï¼šmc mirror + å®šæ—¶ä»»åŠ¡**

**Docker Compose é…ç½®**ï¼š

```yaml
services:
  minio-backup:
    image: minio/mc:latest
    container_name: doc_minio_backup
    restart: unless-stopped
    volumes:
      - ./backups/minio:/backups
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "ç­‰å¾… MinIO å¯åŠ¨..."
        sleep 30

        echo "é…ç½® mc åˆ«å..."
        mc alias set local http://minio:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD}

        echo "å¼€å§‹å¤‡ä»½å¾ªç¯..."
        while true; do
          timestamp=$(date +%Y%m%d_%H%M%S)
          echo "[$(date)] å¼€å§‹å¤‡ä»½ MinIO æ–‡ä»¶..."

          # é•œåƒå¤‡ä»½æ‰€æœ‰æ¡¶
          mc mirror local/documents /backups/$timestamp/documents
          mc mirror local/templates /backups/$timestamp/templates
          mc mirror local/audit-archive /backups/$timestamp/audit-archive

          if [ $? -eq 0 ]; then
            echo "[$(date)] å¤‡ä»½æˆåŠŸ: $timestamp"
          else
            echo "[$(date)] å¤‡ä»½å¤±è´¥!"
          fi

          # åªä¿ç•™æœ€è¿‘ 7 å¤©
          find /backups -maxdepth 1 -type d -mtime +7 -exec rm -rf {} \;
          echo "[$(date)] æ¸…ç†æ—§å¤‡ä»½å®Œæˆ"

          # ç­‰å¾… 24 å°æ—¶
          sleep 86400
        done
    depends_on:
      - minio
```

**æ‰‹åŠ¨å¤‡ä»½å‘½ä»¤**ï¼š
```bash
# ç«‹å³å¤‡ä»½
docker exec doc_minio_backup mc mirror local/documents /backups/$(date +%Y%m%d)/documents

# éªŒè¯å¤‡ä»½
ls -lh backups/minio/
```

**æ¢å¤å‘½ä»¤**ï¼š
```bash
# æ¢å¤æŒ‡å®šæ—¥æœŸçš„æ–‡ä»¶
docker exec doc_minio_backup mc mirror /backups/20260212/documents local/documents
```

---

#### 21.1.4 ç¾éš¾æ¢å¤æ¼”ç»ƒ

**æ¯æœˆæ¼”ç»ƒå†…å®¹**ï¼š

1. **æ¨¡æ‹Ÿæ•°æ®åº“æŸå**ï¼š
   ```bash
   # å¤‡ä»½å½“å‰æ•°æ®
   docker exec doc_postgres pg_dump -U postgres document_system > /tmp/before_test.sql

   # åˆ é™¤æµ‹è¯•è¡¨
   docker exec -it doc_postgres psql -U postgres -d document_system \
     -c "DROP TABLE documents;"

   # ä»å¤‡ä»½æ¢å¤
   docker exec -i doc_postgres pg_restore -U postgres -d document_system \
     < backups/postgres/backup_latest.dump

   # éªŒè¯æ•°æ®å®Œæ•´æ€§
   docker exec -it doc_postgres psql -U postgres -d document_system \
     -c "SELECT COUNT(*) FROM documents;"
   ```

2. **å®Œæ•´ç³»ç»Ÿæ¢å¤**ï¼š
   - ç›®æ ‡ï¼š2 å°æ—¶å†…å®Œæˆ
   - æ­¥éª¤ï¼šåœæ­¢æœåŠ¡ â†’ æ¢å¤æ•°æ®åº“ â†’ æ¢å¤æ–‡ä»¶ â†’ æ¢å¤é…ç½® â†’ å¯åŠ¨æœåŠ¡ â†’ éªŒè¯åŠŸèƒ½

---

### 21.2 ç³»ç»Ÿç›‘æ§è®¾è®¡

#### 21.2.1 ç›‘æ§æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç›‘æ§ä¸æ—¥å¿—æ¶æ„                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åº”ç”¨å±‚
  â”œâ”€â”€ NestJS (metrics ç«¯ç‚¹ /metrics)
  â”‚     â””â”€â”€ @willsoto/nestjs-prometheus
  â”‚
  â”œâ”€â”€ Docker å®¹å™¨æ—¥å¿—
  â”‚     â””â”€â”€ JSON æ ¼å¼æ—¥å¿—è¾“å‡º
  â”‚
  â””â”€â”€ PostgreSQL æ…¢æŸ¥è¯¢æ—¥å¿—

           â†“

é‡‡é›†å±‚
  â”œâ”€â”€ Prometheus (æŒ‡æ ‡é‡‡é›†)
  â”‚     â””â”€â”€ æŠ“å– /metrics ç«¯ç‚¹
  â”‚
  â””â”€â”€ Promtail (æ—¥å¿—é‡‡é›†)
        â””â”€â”€ è¯»å– Docker æ—¥å¿—

           â†“

å­˜å‚¨å±‚
  â”œâ”€â”€ Prometheus TSDB (30å¤©)
  â””â”€â”€ Loki (æ—¥å¿—å­˜å‚¨ï¼Œ30å¤©)

           â†“

å¯è§†åŒ–å±‚
  â””â”€â”€ Grafana
        â”œâ”€â”€ ç³»ç»Ÿä»ªè¡¨æ¿
        â”œâ”€â”€ åº”ç”¨ä»ªè¡¨æ¿
        â”œâ”€â”€ ä¸šåŠ¡ä»ªè¡¨æ¿
        â””â”€â”€ æ—¥å¿—æŸ¥è¯¢ç•Œé¢

           â†“

å‘Šè­¦å±‚
  â””â”€â”€ Alertmanager
        â”œâ”€â”€ ä¼ä¸šå¾®ä¿¡
        â”œâ”€â”€ é‚®ä»¶
        â””â”€â”€ é’‰é’‰
```

---

#### 21.2.2 ç›‘æ§æŒ‡æ ‡æ¸…å•

**ç³»ç»ŸæŒ‡æ ‡**ï¼ˆè‡ªåŠ¨é‡‡é›†ï¼‰ï¼š

| æŒ‡æ ‡ | è¯´æ˜ | å‘Šè­¦é˜ˆå€¼ |
|------|------|---------|
| `node_cpu_seconds_total` | CPU ä½¿ç”¨æ—¶é—´ | > 80% æŒç»­ 5min |
| `node_memory_MemAvailable_bytes` | å¯ç”¨å†…å­˜ | < 512MB |
| `node_disk_io_time_seconds_total` | ç£ç›˜ I/O æ—¶é—´ | > 90% æŒç»­ 5min |
| `node_filesystem_avail_bytes` | ç£ç›˜å¯ç”¨ç©ºé—´ | < 10% |

**åº”ç”¨æŒ‡æ ‡**ï¼ˆNestJSï¼‰ï¼š

| æŒ‡æ ‡ | è¯´æ˜ | å‘Šè­¦é˜ˆå€¼ |
|------|------|---------|
| `doc_system_http_requests_total` | HTTP è¯·æ±‚æ€»æ•° | ç›‘æ§ QPS |
| `doc_system_http_request_duration_seconds` | è¯·æ±‚å“åº”æ—¶é—´ | P99 > 2s |
| `doc_system_http_errors_total{status="5xx"}` | æœåŠ¡ç«¯é”™è¯¯æ•° | é”™è¯¯ç‡ > 5% |
| `doc_system_db_query_duration_seconds` | æ•°æ®åº“æŸ¥è¯¢è€—æ—¶ | P99 > 1s |

**ä¸šåŠ¡æŒ‡æ ‡**ï¼ˆè‡ªå®šä¹‰ï¼‰ï¼š

| æŒ‡æ ‡ | è¯´æ˜ | å‘Šè­¦é˜ˆå€¼ |
|------|------|---------|
| `doc_system_document_uploads_total` | æ–‡æ¡£ä¸Šä¼ æ¬¡æ•° | ç›‘æ§è¶‹åŠ¿ |
| `doc_system_approval_duration_seconds` | å®¡æ‰¹è€—æ—¶ | P99 > 24h |
| `doc_system_active_users` | åœ¨çº¿ç”¨æˆ·æ•° | ç›‘æ§å³°å€¼ |
| `doc_system_login_failures_total` | ç™»å½•å¤±è´¥æ¬¡æ•° | > 10/minï¼ˆæš´åŠ›ç ´è§£ï¼‰ |

---

#### 21.2.3 NestJS é›†æˆ Prometheus

**1. å®‰è£…ä¾èµ–**ï¼š

```bash
cd server
npm install @willsoto/nestjs-prometheus prom-client
```

**2. é…ç½® app.module.ts**ï¼š

```typescript
import { Module } from '@nestjs/common';
import { PrometheusModule } from '@willsoto/nestjs-prometheus';

@Module({
  imports: [
    PrometheusModule.register({
      defaultMetrics: {
        enabled: true,
        config: {
          prefix: 'doc_system_',
        },
      },
      path: '/metrics',
      defaultLabels: {
        app: 'document-system',
        environment: process.env.NODE_ENV || 'development',
      },
    }),
    // ... å…¶ä»–æ¨¡å—
  ],
})
export class AppModule {}
```

**3. è‡ªå®šä¹‰ä¸šåŠ¡æŒ‡æ ‡**ï¼š

```typescript
// monitoring/metrics.service.ts
import { Injectable } from '@nestjs/common';
import { Counter, Histogram, Gauge } from 'prom-client';
import { InjectMetric } from '@willsoto/nestjs-prometheus';

@Injectable()
export class MetricsService {
  constructor(
    @InjectMetric('doc_system_document_uploads_total')
    public documentUploadsCounter: Counter<string>,

    @InjectMetric('doc_system_approval_duration_seconds')
    public approvalDurationHistogram: Histogram<string>,

    @InjectMetric('doc_system_active_users')
    public activeUsersGauge: Gauge<string>,
  ) {}

  // è®°å½•æ–‡æ¡£ä¸Šä¼ 
  recordDocumentUpload(level: string, department: string) {
    this.documentUploadsCounter.labels(level, department).inc();
  }

  // è®°å½•å®¡æ‰¹è€—æ—¶
  recordApprovalDuration(duration: number, result: 'approved' | 'rejected') {
    this.approvalDurationHistogram.labels(result).observe(duration);
  }

  // æ›´æ–°åœ¨çº¿ç”¨æˆ·æ•°
  updateActiveUsers(count: number) {
    this.activeUsersGauge.set(count);
  }
}
```

---

#### 21.2.4 å‘Šè­¦è§„åˆ™

**monitoring/alerts/app-alerts.yml**ï¼š

```yaml
groups:
  - name: application_alerts
    interval: 30s
    rules:
      # HTTP é”™è¯¯ç‡è¿‡é«˜
      - alert: HighHTTPErrorRate
        expr: |
          rate(doc_system_http_errors_total{status=~"5.."}[5m])
          /
          rate(doc_system_http_requests_total[5m]) > 0.05
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "HTTP 5xx é”™è¯¯ç‡è¿‡é«˜"
          description: "æœ€è¿‘ 5 åˆ†é’Ÿé”™è¯¯ç‡: {{ $value | humanizePercentage }}"

      # API å“åº”æ…¢
      - alert: SlowAPIResponse
        expr: |
          histogram_quantile(0.99,
            rate(doc_system_http_request_duration_seconds_bucket[5m])
          ) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "API å“åº”æ—¶é—´è¿‡é•¿"
          description: "P99 å“åº”æ—¶é—´: {{ $value | humanizeDuration }}"

      # ç™»å½•å¤±è´¥æ¬¡æ•°å¼‚å¸¸ï¼ˆç–‘ä¼¼æš´åŠ›ç ´è§£ï¼‰
      - alert: SuspiciousBruteForce
        expr: |
          rate(doc_system_login_failures_total[1m]) > 10
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "æ£€æµ‹åˆ°ç–‘ä¼¼æš´åŠ›ç ´è§£æ”»å‡»"
          description: "1 åˆ†é’Ÿå†…ç™»å½•å¤±è´¥ {{ $value }} æ¬¡"

  - name: system_alerts
    interval: 30s
    rules:
      # CPU ä½¿ç”¨ç‡é«˜
      - alert: HighCPUUsage
        expr: |
          100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "CPU ä½¿ç”¨ç‡è¿‡é«˜"
          description: "CPU ä½¿ç”¨ç‡: {{ $value | humanize }}%"

      # å†…å­˜ä¸è¶³
      - alert: LowMemory
        expr: |
          node_memory_MemAvailable_bytes < 512 * 1024 * 1024
        for: 3m
        labels:
          severity: critical
        annotations:
          summary: "å¯ç”¨å†…å­˜ä¸è¶³"
          description: "å‰©ä½™å†…å­˜: {{ $value | humanize1024 }}B"

      # æœåŠ¡å®•æœº
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "æœåŠ¡ {{ $labels.job }} å®•æœº"
          description: "æœåŠ¡å·²åœæ­¢å“åº”è¶…è¿‡ 1 åˆ†é’Ÿ"
```

---

### 21.3 éƒ¨ç½²æ¶æ„è®¾è®¡

#### 21.3.1 MVP é˜¶æ®µéƒ¨ç½²æ¶æ„

**å•èŠ‚ç‚¹ Docker Compose æ¶æ„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               å•æœåŠ¡å™¨ (4C8G / 8C16G)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚  â”‚   Nginx     â”‚  â† åå‘ä»£ç† + é™æ€æ–‡ä»¶                    â”‚
â”‚  â”‚   :80/:443  â”‚                                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚         â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚  NestJS     â”‚â”€â”€â”€â”€â–¶â”‚ PostgreSQL  â”‚                     â”‚
â”‚  â”‚  :3000      â”‚     â”‚  :5432      â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚         â”‚                                                  â”‚
â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Redis :6379                        â”‚
â”‚         â”‚                                                  â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ MinIO :9000                        â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚          ç›‘æ§æ ˆ                       â”‚                 â”‚
â”‚  â”‚  Prometheus + Grafana + Loki         â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚          å¤‡ä»½æœåŠ¡                     â”‚                 â”‚
â”‚  â”‚  PostgreSQL Backup + MinIO Backup    â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æœåŠ¡å™¨é…ç½®è¦æ±‚**ï¼š

| é˜¶æ®µ | CPU | å†…å­˜ | ç£ç›˜ | å¹¶å‘ç”¨æˆ· |
|------|-----|------|------|----------|
| å¼€å‘/æµ‹è¯• | 2C | 4G | 50GB SSD | 10 |
| MVP ç”Ÿäº§ | 4C | 8G | 100GB SSD | 100 |
| æ‰©å±• | 8C | 16G | 200GB SSD | 500 |

---

#### 21.3.2 éƒ¨ç½²å‘½ä»¤

**åˆå§‹åŒ–éƒ¨ç½²**ï¼š

```bash
# 1. å…‹éš†ä»£ç 
git clone <repository-url>
cd noidear

# 2. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env.production
vi .env.production  # ä¿®æ”¹å¯†ç å’Œé…ç½®

# 3. æ„å»ºå‰ç«¯
cd client
npm install
npm run build

# 4. å¯åŠ¨æ‰€æœ‰æœåŠ¡
cd ..
docker-compose -f docker-compose.prod.yml up -d

# 5. åˆå§‹åŒ–æ•°æ®åº“
docker exec doc_server npx prisma migrate deploy
docker exec doc_server npx prisma db seed

# 6. éªŒè¯æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps
```

**æ—¥å¸¸è¿ç»´**ï¼š

```bash
# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f server

# é‡å¯æœåŠ¡
docker-compose -f docker-compose.prod.yml restart server

# æ›´æ–°ä»£ç 
git pull
docker-compose -f docker-compose.prod.yml build server
docker-compose -f docker-compose.prod.yml up -d server

# å¤‡ä»½æ•°æ®ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
docker exec doc_postgres_backup bash -c '<å¤‡ä»½å‘½ä»¤>'

# æŸ¥çœ‹èµ„æºä½¿ç”¨
docker stats
```

---

#### 21.3.3 é«˜å¯ç”¨æ–¹æ¡ˆï¼ˆæœªæ¥æ‰©å±•ï¼‰

**Phase 2: é«˜å¯ç”¨æ¶æ„**ï¼ˆç”Ÿäº§è§„æ¨¡ï¼‰ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  è´Ÿè½½å‡è¡¡å™¨                              â”‚
â”‚            Nginx + Keepalived (ä¸»å¤‡)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”      â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ NestJS 1 â”‚      â”‚ NestJS 2   â”‚      â”‚ NestJS 3   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜      â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
            â”‚             â”‚                       â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚               â”‚                       â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚ PostgreSQL â”‚  â”‚   Redis    â”‚  â”‚  MinIO Cluster  â”‚
   â”‚  ä¸» + ä»    â”‚  â”‚  Sentinel  â”‚  â”‚    (4 èŠ‚ç‚¹)      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ‰©å±•æ–¹æ¡ˆ**ï¼š

| ç»„ä»¶ | MVP | é«˜å¯ç”¨æ–¹æ¡ˆ |
|------|-----|-----------|
| NestJS | å•å®ä¾‹ | 3+ å®ä¾‹ + è´Ÿè½½å‡è¡¡ |
| PostgreSQL | å•èŠ‚ç‚¹ | ä¸»ä»å¤åˆ¶ï¼ˆPatroni + etcdï¼‰ |
| Redis | å•èŠ‚ç‚¹ | Sentinelï¼ˆ1ä¸»2ä»ï¼‰ |
| MinIO | å•èŠ‚ç‚¹ | åˆ†å¸ƒå¼é›†ç¾¤ï¼ˆ4èŠ‚ç‚¹ï¼Œçº åˆ ç ï¼‰ |
| Nginx | å•å®ä¾‹ | Keepalived åŒæœºçƒ­å¤‡ |

---

### 21.4 å®‰å…¨å®¡è®¡æ—¥å¿—è®¾è®¡

#### 21.4.1 å®¡è®¡æ—¥å¿—åˆ†ç±»

| æ—¥å¿—ç±»å‹ | å†…å®¹ | ä¿ç•™æ—¶é•¿ | é‡è¦æ€§ | BRCGS è¦æ±‚ |
|---------|------|---------|--------|-----------|
| **ç™»å½•æ—¥å¿—** | ç”¨æˆ·ç™»å½•/ç™»å‡ºã€IPã€è®¾å¤‡ | 90 å¤© | P0 | âœ… 3.5.4 |
| **æƒé™å˜æ›´æ—¥å¿—** | è§’è‰²åˆ†é…ã€æƒé™ä¿®æ”¹ | æ°¸ä¹… | P0 | âœ… 3.5.3 |
| **æ•æ„Ÿæ“ä½œæ—¥å¿—** | æ–‡æ¡£åˆ é™¤ã€æ•°æ®å¯¼å‡ºã€å®¡æ‰¹ | æ°¸ä¹… | P0 | âœ… 3.5.2 |
| **æ“ä½œæ—¥å¿—** | æ–‡æ¡£ä¸Šä¼ ã€ç¼–è¾‘ã€æŸ¥çœ‹ | 30 å¤© | P1 | - |
| **ç³»ç»Ÿæ—¥å¿—** | åº”ç”¨å¯åŠ¨ã€é”™è¯¯ã€å¼‚å¸¸ | 30 å¤© | P1 | - |

---

#### 21.4.2 æ•°æ®æ¨¡å‹

```prisma
// ==================== ç™»å½•æ—¥å¿— ====================
model LoginLog {
  id          String   @id @default(cuid())
  userId      String?  // ç™»å½•å¤±è´¥æ—¶ä¸º null
  username    String
  action      String   // "login" | "logout" | "login_failed"
  ipAddress   String
  userAgent   String
  location    String?  // IP åœ°ç†ä½ç½®ï¼ˆå¯é€‰ï¼‰
  loginTime   DateTime @default(now())
  logoutTime  DateTime?
  status      String   // "success" | "failed"
  failReason  String?  // å¤±è´¥åŸå› 

  @@index([userId])
  @@index([loginTime])
  @@index([ipAddress])
  @@index([status])
  @@map("login_logs")
}

// ==================== æƒé™å˜æ›´æ—¥å¿— ====================
model PermissionLog {
  id              String   @id @default(cuid())
  operatorId      String   // æ“ä½œäºº ID
  operatorName    String
  targetUserId    String   // è¢«æ“ä½œç”¨æˆ· ID
  targetUsername  String
  action          String   // "assign_role" | "revoke_role" | "change_department"
  beforeValue     Json     // å˜æ›´å‰å€¼
  afterValue      Json     // å˜æ›´åå€¼
  reason          String?  // å˜æ›´åŸå› 
  approvedBy      String?  // æ‰¹å‡†äºº IDï¼ˆå¦‚éœ€è¦å®¡æ‰¹ï¼‰
  approvedByName  String?
  ipAddress       String
  createdAt       DateTime @default(now())

  @@index([operatorId])
  @@index([targetUserId])
  @@index([action])
  @@index([createdAt])
  @@map("permission_logs")
}

// ==================== æ•æ„Ÿæ“ä½œæ—¥å¿— ====================
model SensitiveLog {
  id            String   @id @default(cuid())
  userId        String
  username      String
  action        String   // "delete_document" | "export_data" | "approve" | "reject"
  resourceType  String   // "document" | "task" | "record" | "user"
  resourceId    String
  resourceName  String
  details       Json     // è¯¦ç»†ä¿¡æ¯
  ipAddress     String
  userAgent     String
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([resourceType])
  @@index([createdAt])
  @@map("sensitive_logs")
}
```

---

#### 21.4.3 å®¡è®¡æ—¥å¿— API

```typescript
// ==================== ç™»å½•æ—¥å¿— API ====================
POST   /api/v1/audit/login-logs/query      // æŸ¥è¯¢ç™»å½•æ—¥å¿—
GET    /api/v1/audit/login-logs/export     // å¯¼å‡ºç™»å½•æ—¥å¿—
GET    /api/v1/audit/login-logs/stats      // ç™»å½•ç»Ÿè®¡

// ==================== æƒé™å˜æ›´æ—¥å¿— API ====================
POST   /api/v1/audit/permission-logs/query
GET    /api/v1/audit/permission-logs/export
GET    /api/v1/audit/permission-logs/:userId  // æŸ¥è¯¢æŸç”¨æˆ·çš„æƒé™å˜æ›´å†å²

// ==================== æ•æ„Ÿæ“ä½œæ—¥å¿— API ====================
POST   /api/v1/audit/sensitive-logs/query
GET    /api/v1/audit/sensitive-logs/export
GET    /api/v1/audit/sensitive-logs/stats    // æ•æ„Ÿæ“ä½œç»Ÿè®¡

// ==================== ç»¼åˆæŸ¥è¯¢ API ====================
POST   /api/v1/audit/search                  // è·¨æ—¥å¿—ç±»å‹æœç´¢
GET    /api/v1/audit/dashboard                // å®¡è®¡ä»ªè¡¨æ¿ç»Ÿè®¡
GET    /api/v1/audit/timeline/:userId        // ç”¨æˆ·æ“ä½œæ—¶é—´çº¿
```

---

#### 21.4.4 è‡ªåŠ¨è®°å½•æ‹¦æˆªå™¨

**æ•æ„Ÿæ“ä½œè£…é¥°å™¨**ï¼š

```typescript
// audit/decorators/sensitive-log.decorator.ts
import { SetMetadata } from '@nestjs/common';

export const SENSITIVE_LOG_KEY = 'sensitive_log';

export const SensitiveLog = (action: string, resourceType: string) =>
  SetMetadata(SENSITIVE_LOG_KEY, { action, resourceType });
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```typescript
// document.controller.ts
import { UseInterceptors } from '@nestjs/common';
import { SensitiveLog } from '@/audit/decorators/sensitive-log.decorator';
import { SensitiveLogInterceptor } from '@/audit/interceptors/sensitive-log.interceptor';

@Controller('documents')
@UseInterceptors(SensitiveLogInterceptor)
export class DocumentController {
  constructor(private documentService: DocumentService) {}

  // åˆ é™¤æ–‡æ¡£ - æ•æ„Ÿæ“ä½œ
  @Delete(':id')
  @SensitiveLog('delete_document', 'document')
  async deleteDocument(@Param('id') id: string) {
    return this.documentService.delete(id);
  }

  // æ‰¹é‡å¯¼å‡ºæ•°æ® - æ•æ„Ÿæ“ä½œ
  @Post('export')
  @SensitiveLog('export_data', 'document')
  async exportDocuments(@Body() dto: ExportDto) {
    return this.documentService.export(dto);
  }

  // å®¡æ‰¹é€šè¿‡ - æ•æ„Ÿæ“ä½œ
  @Post(':id/approve')
  @SensitiveLog('approve', 'document')
  async approveDocument(@Param('id') id: string) {
    return this.documentService.approve(id);
  }
}
```

---

#### 21.4.5 å®¡è®¡æ—¥å¿—å½’æ¡£ç­–ç•¥

**å®šæ—¶å½’æ¡£ä»»åŠ¡**ï¼š

```typescript
// audit/tasks/archive.task.ts
import { Injectable } from '@nestjs/common';
import { Cron } from '@nestjs/schedule';
import { PrismaService } from '@/prisma/prisma.service';
import { MinioService } from '@/minio/minio.service';

@Injectable()
export class AuditArchiveTask {
  constructor(
    private prisma: PrismaService,
    private minioService: MinioService,
  ) {}

  // æ¯æœˆ 1 å·å‡Œæ™¨æ‰§è¡Œ
  @Cron('0 0 1 * *')
  async archiveLoginLogs() {
    const threeMonthsAgo = new Date();
    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

    // æŸ¥è¯¢éœ€è¦å½’æ¡£çš„æ—¥å¿—
    const logs = await this.prisma.loginLog.findMany({
      where: { loginTime: { lt: threeMonthsAgo } },
    });

    if (logs.length === 0) {
      console.log('[å½’æ¡£ä»»åŠ¡] æ— éœ€å½’æ¡£ç™»å½•æ—¥å¿—');
      return;
    }

    // å¯¼å‡ºåˆ° JSON æ–‡ä»¶
    const filename = `login_logs_${format(threeMonthsAgo, 'yyyyMM')}.json`;
    const content = JSON.stringify(logs, null, 2);

    // ä¸Šä¼ åˆ° MinIO
    await this.minioService.upload(
      'audit-archive',
      filename,
      Buffer.from(content),
      'application/json',
    );

    // åˆ é™¤å·²å½’æ¡£æ•°æ®
    await this.prisma.loginLog.deleteMany({
      where: { loginTime: { lt: threeMonthsAgo } },
    });

    console.log(`[å½’æ¡£ä»»åŠ¡] å·²å½’æ¡£ ${logs.length} æ¡ç™»å½•æ—¥å¿—åˆ° ${filename}`);
  }
}
```

---

#### 21.4.6 BRCGS å®¡è®¡æŠ¥å‘Šç”Ÿæˆ

```typescript
// audit/audit-report.service.ts
@Injectable()
export class AuditReportService {
  constructor(private prisma: PrismaService) {}

  // ç”Ÿæˆ BRCGS å®¡è®¡æŠ¥å‘Š
  async generateBRCGSReport(startDate: string, endDate: string) {
    const start = new Date(startDate);
    const end = new Date(endDate);

    // 1. ç™»å½•æ—¥å¿—ç»Ÿè®¡
    const loginStats = await this.prisma.loginLog.count({
      where: { loginTime: { gte: start, lte: end } },
    });

    const loginFailures = await this.prisma.loginLog.count({
      where: {
        loginTime: { gte: start, lte: end },
        status: 'failed',
      },
    });

    // 2. æƒé™å˜æ›´è®°å½•
    const permissionChanges = await this.prisma.permissionLog.findMany({
      where: {
        createdAt: { gte: start, lte: end },
      },
      orderBy: { createdAt: 'desc' },
    });

    // 3. æ•æ„Ÿæ“ä½œè®°å½•
    const sensitiveOps = await this.prisma.sensitiveLog.findMany({
      where: {
        createdAt: { gte: start, lte: end },
      },
      orderBy: { createdAt: 'desc' },
    });

    // 4. è®°å½•ä¿®æ”¹å†å²
    const recordChanges = await this.prisma.recordChangeLog.findMany({
      where: {
        changedAt: { gte: start, lte: end },
      },
      orderBy: { changedAt: 'desc' },
    });

    return {
      period: { startDate, endDate },
      summary: {
        totalLogins: loginStats,
        loginFailures,
        loginFailureRate: (loginFailures / loginStats * 100).toFixed(2) + '%',
        permissionChanges: permissionChanges.length,
        sensitiveOperations: sensitiveOps.length,
        recordModifications: recordChanges.length,
      },
      brcgsCompliance: {
        '3.5.2': recordChanges.length > 0 ? 'âœ… å·²è®°å½•æ‰€æœ‰è®°å½•ä¿®æ”¹' : 'âš ï¸ æ— è®°å½•ä¿®æ”¹',
        '3.5.3': permissionChanges.length >= 0 ? 'âœ… å·²è®°å½•æƒé™å˜æ›´' : 'N/A',
        '3.5.4': loginStats > 0 ? 'âœ… å·²è®°å½•æ‰€æœ‰ç™»å½•' : 'N/A',
      },
    };
  }
}
```

---

### 21.5 ä¸šåŠ¡è§„åˆ™

| è§„åˆ™ç¼–å· | è§„åˆ™æè¿° | å®æ–½æ–¹å¼ |
|---------|---------|---------|
| **BR-261** | PostgreSQL æ¯å¤©è‡ªåŠ¨å¤‡ä»½ï¼Œä¿ç•™ 7 å¤© | Docker å®šæ—¶ä»»åŠ¡ |
| **BR-262** | MinIO æ–‡ä»¶æ¯å¤©è‡ªåŠ¨å¤‡ä»½ï¼Œä¿ç•™ 7 å¤© | mc mirror å®šæ—¶ä»»åŠ¡ |
| **BR-263** | ç³»ç»Ÿ RPO ç›®æ ‡ 24 å°æ—¶ï¼ŒRTO ç›®æ ‡ 2 å°æ—¶ | å¤‡ä»½ç­–ç•¥ + æ¢å¤æ¼”ç»ƒ |
| **BR-264** | Prometheus æŒ‡æ ‡ä¿ç•™ 30 å¤© | Prometheus é…ç½® |
| **BR-265** | Loki æ—¥å¿—ä¿ç•™ 30 å¤© | Loki é…ç½® |
| **BR-266** | API P99 å“åº”æ—¶é—´ > 2ç§’ è§¦å‘å‘Šè­¦ | Prometheus å‘Šè­¦è§„åˆ™ |
| **BR-267** | HTTP 5xx é”™è¯¯ç‡ > 5% è§¦å‘å‘Šè­¦ | Prometheus å‘Šè­¦è§„åˆ™ |
| **BR-268** | ç™»å½•å¤±è´¥æ¬¡æ•° > 10æ¬¡/åˆ†é’Ÿ è§¦å‘å‘Šè­¦ï¼ˆç–‘ä¼¼æš´åŠ›ç ´è§£ï¼‰ | Prometheus å‘Šè­¦è§„åˆ™ |
| **BR-269** | ç™»å½•æ—¥å¿—ä¿ç•™ 90 å¤©ï¼Œæƒé™å˜æ›´/æ•æ„Ÿæ“ä½œæ°¸ä¹…ä¿ç•™ | å®šæ—¶å½’æ¡£ä»»åŠ¡ |
| **BR-270** | æ‰€æœ‰æ•æ„Ÿæ“ä½œå¿…é¡»è®°å½•å®¡è®¡æ—¥å¿— | SensitiveLog æ‹¦æˆªå™¨ |
| **BR-271** | æ¯æœˆæ‰§è¡Œä¸€æ¬¡ç¾éš¾æ¢å¤æ¼”ç»ƒ | è¿ç»´æµç¨‹ |
| **BR-272** | å®¡è®¡æ—¥å¿—å½’æ¡£åˆ° MinIO audit-archive æ¡¶ | å®šæ—¶ä»»åŠ¡ + MinIO |

---

### 21.6 æˆåŠŸæ ‡å‡†

**æ•°æ®å®‰å…¨**:
- âœ… PostgreSQL å¤‡ä»½æˆåŠŸç‡ 100%
- âœ… MinIO æ–‡ä»¶å¤‡ä»½æˆåŠŸç‡ 100%
- âœ… ç¾éš¾æ¢å¤æ¼”ç»ƒ RTO < 2 å°æ—¶

**ç³»ç»Ÿç›‘æ§**:
- âœ… Prometheus æˆåŠŸé‡‡é›†æ‰€æœ‰æŒ‡æ ‡
- âœ… Grafana å¯è§†åŒ–ä»ªè¡¨æ¿æ­£å¸¸æ˜¾ç¤º
- âœ… å‘Šè­¦è§„åˆ™è§¦å‘å‡†ç¡®ï¼Œæ— è¯¯æŠ¥

**å®¡è®¡æ—¥å¿—**:
- âœ… ç™»å½•/æƒé™/æ•æ„Ÿæ“ä½œ 100% è®°å½•
- âœ… å®¡è®¡æ—¥å¿—å¯æŸ¥è¯¢ã€å¯å¯¼å‡º
- âœ… ç¬¦åˆ BRCGS 3.5.2/3.5.3/3.5.4 è¦æ±‚

**éƒ¨ç½²æ¶æ„**:
- âœ… Docker Compose ä¸€é”®éƒ¨ç½²
- âœ… æ‰€æœ‰æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡
- âœ… æ”¯æŒ 100 å¹¶å‘ç”¨æˆ·

---

**æœ¬ç« èŠ‚å®Œæˆ âœ…**

---

## ç¬¬äºŒåäºŒç« ï¼šæŠ€æœ¯å€ºåŠ¡ä¸å¾…å®æ–½æ”¹è¿›

> **ç›®çš„**: è®°å½•ä»£ç å®ç°ä¸è®¾è®¡æ–‡æ¡£çš„å·®å¼‚ï¼Œä½œä¸ºåç»­å¼€å‘çš„æ”¹è¿›æ¸…å•
> **æ›´æ–°æ—¶é—´**: 2026-02-13
> **æ£€æŸ¥èŒƒå›´**: DESIGN.md vs schema.prisma + Controller + Vue ç»„ä»¶

---

### 22.1 æ•°æ®æ¨¡å‹å¾…è¡¥å……ï¼ˆP1 ä¼˜å…ˆçº§ï¼‰

#### 22.1.1 Document è¡¨å½’æ¡£/ä½œåºŸå­—æ®µï¼ˆP1-1ï¼‰

**é—®é¢˜æè¿°**:
- å½“å‰ Document è¡¨ç¼ºå°‘å½’æ¡£/ä½œåºŸç›¸å…³å­—æ®µ
- æ–‡æ¡£çŠ¶æ€åªæœ‰ draft/under_review/approvedï¼Œæ— æ³•æ ‡è®°ä¸º archived/obsolete
- ä¸ç¬¦åˆ BRCGS æ–‡æ¡£ç®¡ç†åˆè§„è¦æ±‚

**å½±å“èŒƒå›´**:
- BRCGS 3.11.2 æ–‡æ¡£ä½œåºŸæµç¨‹æ— æ³•å®æ–½
- æ— æ³•è¿½è¸ªå½’æ¡£åŸå› å’Œæ—¶é—´
- æ— æ³•è®°å½•ä½œåºŸè´£ä»»äºº

**ä¿®å¤æ–¹æ¡ˆ**:

```prisma
// server/src/prisma/schema.prisma
model Document {
  id              String    @id
  level           Int
  number          String    @unique
  title           String
  filePath        String
  fileName        String
  fileSize        Int
  fileType        String
  version         Decimal   @default(1.0) @db.Decimal(3, 1)
  status          String    // æ–°å¢çŠ¶æ€: "archived" | "obsolete"
  creatorId       String
  approverId      String?
  approvedAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  // ==================== æ–°å¢å½’æ¡£/ä½œåºŸå­—æ®µ ====================
  archiveReason   String?    // å½’æ¡£åŸå› 
  archivedAt      DateTime?  // å½’æ¡£æ—¶é—´
  archivedBy      String?    // å½’æ¡£äºº IDï¼ˆå…³è” User.idï¼‰

  obsoleteReason  String?    // ä½œåºŸåŸå› 
  obsoletedAt     DateTime?  // ä½œåºŸæ—¶é—´
  obsoletedBy     String?    // ä½œåºŸäºº IDï¼ˆå…³è” User.idï¼‰

  // å…³è”å…³ç³»
  creator         User      @relation("DocumentCreator", fields: [creatorId], references: [id])
  approver        User?     @relation("DocumentApprover", fields: [approverId], references: [id])
  archiver        User?     @relation("DocumentArchiver", fields: [archivedBy], references: [id])
  obsoleter       User?     @relation("DocumentObsoleter", fields: [obsoletedBy], references: [id])

  @@index([status])
  @@index([archivedAt])
  @@index([obsoletedAt])
  @@map("documents")
}
```

**è¿ç§»å‘½ä»¤**:

```bash
# ç”Ÿæˆè¿ç§»æ–‡ä»¶
npx prisma migrate dev --name add_document_archive_fields

# è¿ç§»å†…å®¹
ALTER TABLE documents ADD COLUMN archive_reason VARCHAR(500);
ALTER TABLE documents ADD COLUMN archived_at TIMESTAMP;
ALTER TABLE documents ADD COLUMN archived_by VARCHAR(50);
ALTER TABLE documents ADD COLUMN obsolete_reason VARCHAR(500);
ALTER TABLE documents ADD COLUMN obsoleted_at TIMESTAMP;
ALTER TABLE documents ADD COLUMN obsoleted_by VARCHAR(50);

CREATE INDEX idx_documents_archived_at ON documents(archived_at);
CREATE INDEX idx_documents_obsoleted_at ON documents(obsoleted_at);
```

**é…å¥—å®ç°**:
- API ç«¯ç‚¹: `POST /api/v1/documents/:id/archive` å’Œ `POST /api/v1/documents/:id/obsolete`
- DTO éªŒè¯: ArchiveDocumentDtoã€ObsoleteDocumentDto
- å‰ç«¯ç•Œé¢: DocumentDetail.vue æ–°å¢å½’æ¡£/ä½œåºŸæŒ‰é’®å’Œå¯¹è¯æ¡†
- ä¸šåŠ¡è§„åˆ™: BR-273 ~ BR-277ï¼ˆå½’æ¡£/ä½œåºŸæµç¨‹è§„åˆ™ï¼‰

**é¢„ä¼°å·¥ä½œé‡**: 2-3 å°æ—¶

---

#### 22.1.2 Permission å’Œ UserPermission è¡¨ï¼ˆP1-2ï¼‰

**é—®é¢˜æè¿°**:
- å½“å‰ç³»ç»Ÿåªæœ‰ç®€å•çš„è§’è‰²æƒé™ï¼ˆadmin/manager/userï¼‰
- æ— æ³•å®ç°ç»†ç²’åº¦æƒé™æ§åˆ¶ï¼ˆå¦‚è·¨éƒ¨é—¨æŸ¥çœ‹ç‰¹å®šè®°å½•ï¼‰
- æ— æ³•æ»¡è¶³ BR-017/018/019 ä¸šåŠ¡è§„åˆ™è¦æ±‚

**å½±å“èŒƒå›´**:
- è´¨é‡éƒ¨æ— æ³•è·¨éƒ¨é—¨æŸ¥çœ‹è®°å½•
- æ— æ³•å®ç°èµ„æºçº§æƒé™ï¼ˆæŸ¥çœ‹ç‰¹å®šæ–‡æ¡£ã€ç‰¹å®šè®°å½•ï¼‰
- æƒé™å˜æ›´æ— æ³•å®¡è®¡

**ä¿®å¤æ–¹æ¡ˆ**:

```prisma
// server/src/prisma/schema.prisma

model Permission {
  id          String   @id @default(cuid())
  code        String   @unique  // æƒé™ç¼–ç : "viewRecords:production"
  name        String              // æƒé™åç§°: "æŸ¥çœ‹ç”Ÿäº§è®°å½•"
  category    String              // æƒé™ç±»åˆ«: document | record | approval | system
  scope       String   @default("department")  // æƒé™èŒƒå›´: department | cross_department | global
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       UserPermission[]

  @@index([category])
  @@index([scope])
  @@map("permissions")
}

model UserPermission {
  id            String   @id @default(cuid())
  userId        String
  permissionId  String
  grantedBy     String   // æˆæƒäºº ID
  grantedByName String   // æˆæƒäººå§“å
  grantedAt     DateTime @default(now())
  expiresAt     DateTime?  // æƒé™è¿‡æœŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰
  reason        String?    // æˆæƒåŸå› 

  // èµ„æºçº§æƒé™ï¼ˆå¯é€‰ï¼‰
  resourceType  String?  // èµ„æºç±»å‹: document | record | task
  resourceId    String?  // èµ„æº ID

  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission    Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId, resourceType, resourceId])
  @@index([userId])
  @@index([permissionId])
  @@index([expiresAt])
  @@map("user_permissions")
}
```

**é…å¥—å®ç°**:
- æƒé™å®šä¹‰: åˆå§‹åŒ– 12+ æƒé™ï¼ˆæ–‡æ¡£ã€è®°å½•ã€å®¡æ‰¹ã€ç³»ç»Ÿæƒé™ï¼‰
- æƒé™è£…é¥°å™¨: `@RequirePermission('viewRecords:crossDepartment')`
- æƒé™å®ˆå«: PermissionGuardï¼ˆæ£€æŸ¥ç”¨æˆ·æƒé™ã€è¿‡æœŸæ—¶é—´ï¼‰
- API ç«¯ç‚¹: `/api/v1/permissions`ï¼ˆæŸ¥è¯¢ã€æˆäºˆã€æ’¤é”€æƒé™ï¼‰
- å‰ç«¯ç•Œé¢: UserPermissions.vueï¼ˆæƒé™ç®¡ç†é¡µé¢ï¼‰
- ä¸šåŠ¡è§„åˆ™: BR-017/018/019ã€BR-278 ~ BR-280

**é¢„ä¼°å·¥ä½œé‡**: 8-16 å°æ—¶

---

#### 22.1.3 WorkflowTemplate/Instance/Task è¡¨ï¼ˆP1-3ï¼‰

**é—®é¢˜æè¿°**:
- å½“å‰å®¡æ‰¹æµç¨‹ç¡¬ç¼–ç åœ¨ä¸šåŠ¡é€»è¾‘ä¸­
- æ— æ³•å®ç°å¯é…ç½®çš„å·¥ä½œæµå¼•æ“
- æ— æ³•æ»¡è¶³å®¡æ‰¹è¶…æ—¶å‡çº§ã€å¹¶è¡Œå®¡æ‰¹ç­‰å¤æ‚éœ€æ±‚

**å½±å“èŒƒå›´**:
- å®¡æ‰¹æµç¨‹ä¸çµæ´»ï¼Œæ–°å¢å®¡æ‰¹èŠ‚ç‚¹éœ€è¦ä¿®æ”¹ä»£ç 
- æ— æ³•å®ç°å®¡æ‰¹è¶…æ—¶è‡ªåŠ¨å‡çº§ï¼ˆBR-1.19 ~ BR-1.22ï¼‰
- æ— æ³•å®ç°å¹¶è¡Œå®¡æ‰¹ï¼ˆBR-1.15 ~ BR-1.18ï¼‰
- æ— æ³•å®ç°å·¥ä½œæµå–æ¶ˆï¼ˆBR-1.26ï¼‰

**ä¿®å¤æ–¹æ¡ˆ**:

```prisma
// server/src/prisma/schema.prisma

model WorkflowTemplate {
  id            String   @id @default(cuid())
  code          String   @unique  // å·¥ä½œæµç¼–ç : "document_approval_001"
  name          String              // å·¥ä½œæµåç§°
  departmentId  String              // æ‰€å±éƒ¨é—¨ ID
  category      String              // ç±»åˆ«: document | task | record
  steps         Json                // å·¥ä½œæµæ­¥éª¤é…ç½®ï¼ˆJSON æ•°ç»„ï¼‰
  version       Int      @default(1)
  status        String   @default("active")  // active | inactive
  createdBy     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  department    Department        @relation(fields: [departmentId], references: [id])
  instances     WorkflowInstance[]

  @@index([departmentId])
  @@index([category])
  @@index([status])
  @@map("workflow_templates")
}

model WorkflowInstance {
  id              String   @id @default(cuid())
  templateId      String
  templateCode    String
  resourceType    String      // èµ„æºç±»å‹: document | task | record
  resourceId      String      // èµ„æº ID
  resourceTitle   String
  initiatorId     String      // å‘èµ·äºº ID
  initiatorName   String
  status          String      // pending | in_progress | approved | rejected | cancelled | timeout
  currentStep     Int         // å½“å‰æ­¥éª¤åºå·
  startedAt       DateTime    @default(now())
  completedAt     DateTime?
  cancelledAt     DateTime?
  cancelledBy     String?
  cancelReason    String?

  template        WorkflowTemplate @relation(fields: [templateId], references: [id])
  tasks           WorkflowTask[]

  @@index([templateId])
  @@index([resourceType, resourceId])
  @@index([initiatorId])
  @@index([status])
  @@map("workflow_instances")
}

model WorkflowTask {
  id              String   @id @default(cuid())
  instanceId      String
  stepIndex       Int
  stepName        String
  assigneeId      String      // å®¡æ‰¹äºº ID
  assigneeName    String
  parallelMode    Boolean     @default(false)  // æ˜¯å¦å¹¶è¡Œå®¡æ‰¹
  parallelGroupId String?     // å¹¶è¡Œç»„ ID
  status          String      // pending | approved | rejected | timeout | skipped
  action          String?     // approve | reject | timeout
  comment         String?     // å®¡æ‰¹æ„è§
  dueAt           DateTime?   // æˆªæ­¢æ—¶é—´
  startedAt       DateTime?
  completedAt     DateTime?
  escalatedTo     String?     // è¶…æ—¶å‡çº§ç»™è°ï¼ˆUser IDï¼‰
  escalatedAt     DateTime?

  instance        WorkflowInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@index([instanceId])
  @@index([assigneeId])
  @@index([status])
  @@index([dueAt])
  @@map("workflow_tasks")
}
```

**é…å¥—å®ç°**:
- å·¥ä½œæµå¼•æ“: WorkflowServiceï¼ˆå¯åŠ¨ã€å®¡æ‰¹ã€å–æ¶ˆã€è¶…æ—¶æ£€æŸ¥ï¼‰
- å®šæ—¶ä»»åŠ¡: WorkflowSchedulerï¼ˆæ¯ 10 åˆ†é’Ÿæ£€æŸ¥è¶…æ—¶ä»»åŠ¡ï¼‰
- API ç«¯ç‚¹: `/api/v1/workflows`ï¼ˆå¯åŠ¨ã€å®¡æ‰¹ã€å–æ¶ˆã€æŸ¥è¯¢ï¼‰
- å‰ç«¯é…ç½®ç•Œé¢: WorkflowTemplateEditor.vueï¼ˆå¯è§†åŒ–å·¥ä½œæµè®¾è®¡å™¨ï¼‰
- ä¸šåŠ¡è§„åˆ™: BR-1.12 ~ BR-1.22ã€BR-1.26

**é¢„ä¼°å·¥ä½œé‡**: 24-40 å°æ—¶

---

### 22.2 å®Œæ•´æŠ€æœ¯æ–¹æ¡ˆï¼ˆAPI + ä¸šåŠ¡è§„åˆ™ + å‰ç«¯ç•Œé¢ï¼‰

> **ç›®çš„**: è¡¥å…… P1-1ã€P1-2ã€P1-3 çš„å®Œæ•´å®ç°æ–¹æ¡ˆï¼Œç¡®ä¿å¼€å‘æ—¶æœ‰æ¸…æ™°çš„æŠ€æœ¯æŒ‡å¯¼

---

#### 22.2.1 P1-1: Document å½’æ¡£/ä½œåºŸåŠŸèƒ½å®Œæ•´æ–¹æ¡ˆ

##### ğŸ“‹ ä¸šåŠ¡è§„åˆ™è¡¥å……

**BR-346: æ–‡æ¡£å½’æ¡£è§„åˆ™**
- å½’æ¡£æ¡ä»¶ï¼šæ–‡æ¡£çŠ¶æ€å¿…é¡»ä¸º `approved`ï¼ˆå·²å‘å¸ƒï¼‰ï¼Œä¸èƒ½å½’æ¡£è‰ç¨¿æˆ–å®¡æ ¸ä¸­çš„æ–‡æ¡£
- å½’æ¡£åŸå› ï¼šå¿…å¡«ï¼Œæœ€å°‘ 10 ä¸ªå­—ç¬¦ï¼Œè¯´æ˜å½’æ¡£åŸå› 
- å½’æ¡£æƒé™ï¼šä»…æ–‡æ¡£åˆ›å»ºè€…æˆ–ç®¡ç†å‘˜å¯å½’æ¡£
- å½’æ¡£åçŠ¶æ€ï¼šæ–‡æ¡£çŠ¶æ€å˜æ›´ä¸º `archived`ï¼Œä¸å¯å†ç¼–è¾‘
- å½’æ¡£åè®¿é—®ï¼šå½’æ¡£åä»å¯æŸ¥çœ‹å’Œä¸‹è½½ï¼Œä½†æœç´¢æ—¶é»˜è®¤ä¸æ˜¾ç¤ºï¼ˆéœ€å‹¾é€‰"åŒ…å«å½’æ¡£æ–‡æ¡£"ï¼‰

**BR-347: æ–‡æ¡£ä½œåºŸè§„åˆ™**
- ä½œåºŸæ¡ä»¶ï¼šæ–‡æ¡£çŠ¶æ€å¿…é¡»ä¸º `approved`ï¼ˆå·²å‘å¸ƒï¼‰
- ä½œåºŸåŸå› ï¼šå¿…å¡«ï¼Œæœ€å°‘ 10 ä¸ªå­—ç¬¦ï¼Œè¯´æ˜ä½œåºŸåŸå› ï¼ˆå¦‚"å‘ç°é‡å¤§é”™è¯¯"ã€"æµç¨‹å˜æ›´"ï¼‰
- ä½œåºŸæƒé™ï¼šä»…è´¨é‡éƒ¨ç®¡ç†å‘˜æˆ–ç³»ç»Ÿç®¡ç†å‘˜å¯ä½œåºŸæ–‡æ¡£
- ä½œåºŸåçŠ¶æ€ï¼šæ–‡æ¡£çŠ¶æ€å˜æ›´ä¸º `obsolete`ï¼Œå®Œå…¨ä¸å¯ç¼–è¾‘
- ä½œåºŸåè®¿é—®ï¼šä½œåºŸåä»å¯æŸ¥çœ‹ï¼ˆåªè¯»ï¼‰ï¼Œä½†æœç´¢æ—¶é»˜è®¤ä¸æ˜¾ç¤ºï¼Œéœ€å‹¾é€‰"åŒ…å«ä½œåºŸæ–‡æ¡£"
- ä½œåºŸé€šçŸ¥ï¼šä½œåºŸåè‡ªåŠ¨é€šçŸ¥æ‰€æœ‰æ›¾å¼•ç”¨è¯¥æ–‡æ¡£çš„ç”¨æˆ·

**BR-348: å½’æ¡£/ä½œåºŸæ–‡æ¡£æ¢å¤è§„åˆ™**
- å½’æ¡£æ¢å¤ï¼šå½’æ¡£çš„æ–‡æ¡£å¯æ¢å¤åˆ° `approved` çŠ¶æ€ï¼Œéœ€æä¾›æ¢å¤åŸå› 
- ä½œåºŸä¸å¯æ¢å¤ï¼šä½œåºŸçš„æ–‡æ¡£ä¸å¯æ¢å¤ï¼Œç¬¦åˆ BRCGS 3.11.2 è¦æ±‚ï¼ˆä½œåºŸæ–‡æ¡£åº”æ°¸ä¹…æ ‡è®°ï¼‰
- æ¢å¤æƒé™ï¼šä»…ç®¡ç†å‘˜å¯æ¢å¤å½’æ¡£æ–‡æ¡£
- æ¢å¤é€šçŸ¥ï¼šæ¢å¤åè‡ªåŠ¨é€šçŸ¥ç›¸å…³ç”¨æˆ·

##### ğŸ”Œ API è®¾è®¡

**1. å½’æ¡£æ–‡æ¡£**

```
POST /api/v1/documents/:id/archive
```

**è¯·æ±‚ä½“**:
```typescript
{
  "reason": "è¯¥æ–‡æ¡£å·²è¿‡æ—¶ï¼Œæ–°ç‰ˆæœ¬ä¸º DOC-2026-002"  // å¿…å¡«ï¼Œæœ€å°‘ 10 ä¸ªå­—ç¬¦
}
```

**å“åº”**:
```typescript
{
  "success": true,
  "data": {
    "id": "doc_123",
    "status": "archived",
    "archiveReason": "è¯¥æ–‡æ¡£å·²è¿‡æ—¶ï¼Œæ–°ç‰ˆæœ¬ä¸º DOC-2026-002",
    "archivedAt": "2026-02-13T10:30:00Z",
    "archivedBy": "user_456"
  }
}
```

**é”™è¯¯å“åº”**:
```typescript
// 400 Bad Request
{
  "success": false,
  "error": "å½’æ¡£åŸå› ä¸èƒ½å°‘äº 10 ä¸ªå­—ç¬¦"
}

// 403 Forbidden
{
  "success": false,
  "error": "åªæœ‰æ–‡æ¡£åˆ›å»ºè€…æˆ–ç®¡ç†å‘˜å¯ä»¥å½’æ¡£æ–‡æ¡£"
}

// 422 Unprocessable Entity
{
  "success": false,
  "error": "åªèƒ½å½’æ¡£å·²å‘å¸ƒçš„æ–‡æ¡£ï¼Œå½“å‰çŠ¶æ€ä¸º draft"
}
```

**2. ä½œåºŸæ–‡æ¡£**

```
POST /api/v1/documents/:id/obsolete
```

**è¯·æ±‚ä½“**:
```typescript
{
  "reason": "å‘ç°é‡å¤§é”™è¯¯ï¼Œéœ€åºŸæ­¢ä½¿ç”¨"  // å¿…å¡«ï¼Œæœ€å°‘ 10 ä¸ªå­—ç¬¦
}
```

**å“åº”** åŒä¸Šï¼ˆstatus ä¸º `obsolete`ï¼‰

**3. æ¢å¤å½’æ¡£æ–‡æ¡£**

```
POST /api/v1/documents/:id/restore
```

**è¯·æ±‚ä½“**:
```typescript
{
  "reason": "æ–‡æ¡£ä»éœ€ä½¿ç”¨ï¼Œæ¢å¤ä¸ºæœ‰æ•ˆç‰ˆæœ¬"  // å¿…å¡«
}
```

**å“åº”**:
```typescript
{
  "success": true,
  "data": {
    "id": "doc_123",
    "status": "approved",
    "restoredAt": "2026-02-13T11:00:00Z",
    "restoredBy": "user_789"
  }
}
```

**4. æŸ¥è¯¢æ–‡æ¡£ï¼ˆæ”¯æŒå½’æ¡£/ä½œåºŸç­›é€‰ï¼‰**

```
GET /api/v1/documents?includeArchived=true&includeObsolete=false
```

**æŸ¥è¯¢å‚æ•°**:
- `includeArchived`: æ˜¯å¦åŒ…å«å½’æ¡£æ–‡æ¡£ï¼ˆé»˜è®¤ `false`ï¼‰
- `includeObsolete`: æ˜¯å¦åŒ…å«ä½œåºŸæ–‡æ¡£ï¼ˆé»˜è®¤ `false`ï¼‰

##### ğŸ¨ å‰ç«¯ç•Œé¢è®¾è®¡

**1. æ–‡æ¡£è¯¦æƒ…é¡µæ–°å¢æŒ‰é’®**

æŒ‰é’®ä½ç½®ï¼šæ–‡æ¡£è¯¦æƒ…é¡µå³ä¸Šè§’æ“ä½œæŒ‰é’®ç»„

æŒ‰é’®é¡ºåºï¼ˆä»å·¦åˆ°å³ï¼‰:
1. `[ç¼–è¾‘]` - ä¸»æŒ‰é’®ï¼ˆä»…è‰ç¨¿çŠ¶æ€å¯è§ï¼‰
2. `[å½’æ¡£]` - æ¬¡è¦æŒ‰é’®ï¼ˆä»…å·²å‘å¸ƒçŠ¶æ€ + æœ‰æƒé™æ—¶å¯è§ï¼‰
3. `[ä½œåºŸ]` - å±é™©æŒ‰é’®ï¼ˆä»…å·²å‘å¸ƒçŠ¶æ€ + è´¨é‡éƒ¨ç®¡ç†å‘˜å¯è§ï¼‰
4. `[ä¸‹è½½]` - æ¬¡è¦æŒ‰é’®ï¼ˆå§‹ç»ˆå¯è§ï¼‰

**æŒ‰é’®çŠ¶æ€æ˜ å°„**:
| æŒ‰é’® | æ˜¾ç¤ºæ¡ä»¶ | å¯ç”¨æ¡ä»¶ |
|------|---------|----------|
| å½’æ¡£ | çŠ¶æ€=approved | å½“å‰ç”¨æˆ·=åˆ›å»ºè€… æˆ– ç®¡ç†å‘˜ |
| ä½œåºŸ | çŠ¶æ€=approved | å½“å‰ç”¨æˆ·=è´¨é‡éƒ¨ç®¡ç†å‘˜ æˆ– ç³»ç»Ÿç®¡ç†å‘˜ |
| æ¢å¤ | çŠ¶æ€=archived | å½“å‰ç”¨æˆ·=ç®¡ç†å‘˜ |

**2. å½’æ¡£/ä½œåºŸå¯¹è¯æ¡†**

å¯¹è¯æ¡†å°ºå¯¸ï¼š`60% Ã— 40%`ï¼ˆé€‰æ‹©å¯¹è¯æ¡†ï¼‰

å¯¹è¯æ¡†å†…å®¹ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å½’æ¡£æ–‡æ¡£                         [Ã—]     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ–‡æ¡£åç§°: è´¨é‡æ‰‹å†Œ V2.0                  â”‚
â”‚ æ–‡æ¡£ç¼–å·: DOC-2026-001                   â”‚
â”‚                                         â”‚
â”‚ *å½’æ¡£åŸå› :                               â”‚
â”‚ [___________________________________]   â”‚
â”‚ [___________________________________]   â”‚
â”‚ [___________________________________]   â”‚
â”‚ æœ€å°‘ 10 ä¸ªå­—ç¬¦                           â”‚
â”‚                                         â”‚
â”‚ âš ï¸ å½’æ¡£åæ–‡æ¡£å°†ä¸å†æ˜¾ç¤ºåœ¨é»˜è®¤åˆ—è¡¨ä¸­       â”‚
â”‚ âš ï¸ ä»å¯é€šè¿‡"åŒ…å«å½’æ¡£æ–‡æ¡£"é€‰é¡¹æŸ¥çœ‹         â”‚
â”‚                                         â”‚
â”‚              [å–æ¶ˆ]  [ç¡®å®šå½’æ¡£]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**3. æ–‡æ¡£åˆ—è¡¨é¡µç­›é€‰**

æœç´¢æ æ–°å¢å¤é€‰æ¡†ï¼š
```
[âœ“] åŒ…å«å½’æ¡£æ–‡æ¡£    [ ] åŒ…å«ä½œåºŸæ–‡æ¡£
```

**4. å½’æ¡£/ä½œåºŸæ ‡ç­¾æ˜¾ç¤º**

çŠ¶æ€æ ‡ç­¾ï¼š
```vue
<el-tag type="primary">å·²å½’æ¡£</el-tag>  <!-- è“è‰² -->
<el-tag type="danger">å·²ä½œåºŸ</el-tag>   <!-- çº¢è‰² -->
```

**5. Vue 3 ä»£ç ç¤ºä¾‹**

```vue
<script setup lang="ts">
import { ref } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { archiveDocument, obsoleteDocument } from '@/api/document'

const archiveDialogVisible = ref(false)
const archiveReason = ref('')

const handleArchive = async () => {
  if (archiveReason.value.length < 10) {
    ElMessage.warning('å½’æ¡£åŸå› ä¸èƒ½å°‘äº 10 ä¸ªå­—ç¬¦')
    return
  }

  try {
    await archiveDocument(documentId, { reason: archiveReason.value })
    ElMessage.success('æ–‡æ¡£å·²å½’æ¡£')
    archiveDialogVisible.value = false
    // åˆ·æ–°æ–‡æ¡£è¯¦æƒ…
    fetchDocumentDetail()
  } catch (error) {
    ElMessage.error(error.message || 'å½’æ¡£å¤±è´¥')
  }
}

const handleObsolete = async () => {
  const { value: reason } = await ElMessageBox.prompt(
    'è¯·è¾“å…¥ä½œåºŸåŸå› ï¼ˆæœ€å°‘ 10 ä¸ªå­—ç¬¦ï¼‰',
    'ä½œåºŸæ–‡æ¡£',
    {
      confirmButtonText: 'ç¡®å®šä½œåºŸ',
      cancelButtonText: 'å–æ¶ˆ',
      inputType: 'textarea',
      inputValidator: (value) => {
        if (!value || value.length < 10) {
          return 'ä½œåºŸåŸå› ä¸èƒ½å°‘äº 10 ä¸ªå­—ç¬¦'
        }
        return true
      }
    }
  )

  try {
    await obsoleteDocument(documentId, { reason })
    ElMessage.success('æ–‡æ¡£å·²ä½œåºŸ')
    fetchDocumentDetail()
  } catch (error) {
    ElMessage.error(error.message || 'ä½œåºŸå¤±è´¥')
  }
}
</script>

<template>
  <div class="document-detail">
    <!-- æ“ä½œæŒ‰é’® -->
    <div class="actions">
      <el-button v-if="canArchive" @click="archiveDialogVisible = true">
        å½’æ¡£
      </el-button>
      <el-button
        v-if="canObsolete"
        type="danger"
        @click="handleObsolete"
      >
        ä½œåºŸ
      </el-button>
    </div>

    <!-- å½’æ¡£å¯¹è¯æ¡† -->
    <el-dialog
      v-model="archiveDialogVisible"
      title="å½’æ¡£æ–‡æ¡£"
      width="60%"
    >
      <el-form label-width="100px">
        <el-form-item label="æ–‡æ¡£åç§°">
          {{ document.title }}
        </el-form-item>
        <el-form-item label="æ–‡æ¡£ç¼–å·">
          {{ document.number }}
        </el-form-item>
        <el-form-item label="å½’æ¡£åŸå› " required>
          <el-input
            v-model="archiveReason"
            type="textarea"
            :rows="3"
            placeholder="è¯·è¾“å…¥å½’æ¡£åŸå› ï¼ˆæœ€å°‘ 10 ä¸ªå­—ç¬¦ï¼‰"
            maxlength="500"
            show-word-limit
          />
        </el-form-item>
        <el-alert
          title="å½’æ¡£åæ–‡æ¡£å°†ä¸å†æ˜¾ç¤ºåœ¨é»˜è®¤åˆ—è¡¨ä¸­"
          type="warning"
          :closable="false"
        />
      </el-form>
      <template #footer>
        <el-button @click="archiveDialogVisible = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="handleArchive">ç¡®å®šå½’æ¡£</el-button>
      </template>
    </el-dialog>
  </div>
</template>
```

##### âœ… å®æ–½æ£€æŸ¥æ¸…å•

```
â–¡ 1. æ•°æ®æ¨¡å‹
   â–¡ 1a. Document è¡¨æ–°å¢ 6 ä¸ªå½’æ¡£/ä½œåºŸå­—æ®µ
   â–¡ 1b. ç´¢å¼•åˆ›å»ºæˆåŠŸï¼ˆarchived_at, obsoleted_atï¼‰
   â–¡ 1c. User å…³è”å…³ç³»æ­£ç¡®ï¼ˆarchiver, obsoleterï¼‰

â–¡ 2. API å®ç°
   â–¡ 2a. POST /api/v1/documents/:id/archive å®ç°
   â–¡ 2b. POST /api/v1/documents/:id/obsolete å®ç°
   â–¡ 2c. POST /api/v1/documents/:id/restore å®ç°
   â–¡ 2d. GET /api/v1/documents æ”¯æŒ includeArchived/includeObsolete å‚æ•°
   â–¡ 2e. DTO éªŒè¯ï¼ˆArchiveDocumentDto, ObsoleteDocumentDtoï¼‰

â–¡ 3. ä¸šåŠ¡é€»è¾‘
   â–¡ 3a. BR-346 å½’æ¡£è§„åˆ™éªŒè¯é€šè¿‡
   â–¡ 3b. BR-347 ä½œåºŸè§„åˆ™éªŒè¯é€šè¿‡
   â–¡ 3c. BR-348 æ¢å¤è§„åˆ™éªŒè¯é€šè¿‡
   â–¡ 3d. æƒé™æ ¡éªŒæ­£ç¡®ï¼ˆåˆ›å»ºè€…/ç®¡ç†å‘˜ï¼‰

â–¡ 4. å‰ç«¯ç•Œé¢
   â–¡ 4a. æ–‡æ¡£è¯¦æƒ…é¡µæ–°å¢å½’æ¡£/ä½œåºŸæŒ‰é’®
   â–¡ 4b. å½’æ¡£/ä½œåºŸå¯¹è¯æ¡†å®ç°
   â–¡ 4c. åˆ—è¡¨é¡µç­›é€‰å¤é€‰æ¡†å®ç°
   â–¡ 4d. å½’æ¡£/ä½œåºŸçŠ¶æ€æ ‡ç­¾æ˜¾ç¤ºæ­£ç¡®

â–¡ 5. é€šçŸ¥ç³»ç»Ÿ
   â–¡ 5a. ä½œåºŸæ–‡æ¡£åé€šçŸ¥ç›¸å…³ç”¨æˆ·
   â–¡ 5b. æ¢å¤æ–‡æ¡£åé€šçŸ¥ç›¸å…³ç”¨æˆ·

â–¡ 6. æµ‹è¯•
   â–¡ 6a. å½’æ¡£åœºæ™¯æµ‹è¯•é€šè¿‡
   â–¡ 6b. ä½œåºŸåœºæ™¯æµ‹è¯•é€šè¿‡
   â–¡ 6c. æ¢å¤åœºæ™¯æµ‹è¯•é€šè¿‡
   â–¡ 6d. æƒé™æ ¡éªŒæµ‹è¯•é€šè¿‡
```

---

#### 22.2.2 P1-2: ç»†ç²’åº¦æƒé™ç³»ç»Ÿå®Œæ•´æ–¹æ¡ˆ

##### ğŸ“‹ ä¸šåŠ¡è§„åˆ™è¡¥å……

**BR-349: æƒé™å®šä¹‰è§„åˆ™**
- æƒé™ç¼–ç æ ¼å¼ï¼š`{action}:{scope}:{resource}`ï¼Œå¦‚ `view:cross_department:document`
- æƒé™ç±»åˆ«ï¼šdocumentï¼ˆæ–‡æ¡£ï¼‰ã€recordï¼ˆè®°å½•ï¼‰ã€taskï¼ˆä»»åŠ¡ï¼‰ã€approvalï¼ˆå®¡æ‰¹ï¼‰ã€systemï¼ˆç³»ç»Ÿï¼‰
- æƒé™èŒƒå›´ï¼šdepartmentï¼ˆæœ¬éƒ¨é—¨ï¼‰ã€cross_departmentï¼ˆè·¨éƒ¨é—¨ï¼‰ã€globalï¼ˆå…¨å±€ï¼‰
- æƒé™ä¸å¯åˆ é™¤ï¼šå·²ä½¿ç”¨çš„æƒé™ä¸å¯åˆ é™¤ï¼Œåªèƒ½åœç”¨

**BR-350: æƒé™æˆäºˆè§„åˆ™**
- æˆæƒæƒé™ï¼šä»…ç®¡ç†å‘˜æˆ–éƒ¨é—¨ä¸»ç®¡å¯æˆäºˆæƒé™
- æˆæƒåŸå› ï¼šå¿…é¡»å¡«å†™æˆæƒåŸå› ï¼ˆå¦‚"è´¨é‡éƒ¨éœ€è¦è·¨éƒ¨é—¨æŸ¥çœ‹ç”Ÿäº§è®°å½•"ï¼‰
- æƒé™è¿‡æœŸï¼šå¯è®¾ç½®æƒé™è¿‡æœŸæ—¶é—´ï¼ˆå¦‚ä¸´æ—¶æˆäºˆ 1 ä¸ªæœˆæŸ¥çœ‹æƒé™ï¼‰
- æˆæƒé€šçŸ¥ï¼šæƒé™æˆäºˆåè‡ªåŠ¨é€šçŸ¥è¢«æˆæƒç”¨æˆ·

**BR-351: æƒé™æ’¤é”€è§„åˆ™**
- æ’¤é”€æƒé™ï¼šç®¡ç†å‘˜æˆ–åŸæˆæƒäººå¯æ’¤é”€æƒé™
- ç«‹å³ç”Ÿæ•ˆï¼šæ’¤é”€åç«‹å³ç”Ÿæ•ˆï¼Œç”¨æˆ·åˆ·æ–°é¡µé¢åå¤±å»æƒé™
- æ’¤é”€é€šçŸ¥ï¼šæƒé™æ’¤é”€åè‡ªåŠ¨é€šçŸ¥è¢«æ’¤é”€ç”¨æˆ·

**BR-352: èµ„æºçº§æƒé™è§„åˆ™**
- èµ„æºçº§æƒé™ï¼šå¯é’ˆå¯¹ç‰¹å®šèµ„æºæˆäºˆæƒé™ï¼ˆå¦‚ä»…æŸ¥çœ‹ç‰¹å®šæ–‡æ¡£ DOC-001ï¼‰
- ä¼˜å…ˆçº§ï¼šèµ„æºçº§æƒé™ä¼˜å…ˆäºå…¨å±€æƒé™ï¼ˆå¦‚ç¦æ­¢æŸ¥çœ‹ DOC-001ï¼Œå³ä½¿æœ‰å…¨å±€æŸ¥çœ‹æƒé™ï¼‰
- èµ„æºåˆ é™¤ï¼šèµ„æºåˆ é™¤æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤è¯¥èµ„æºçš„æ‰€æœ‰èµ„æºçº§æƒé™

**BR-353: æƒé™è¿‡æœŸå¤„ç†è§„åˆ™**
- å®šæ—¶æ£€æŸ¥ï¼šæ¯æ—¥å‡Œæ™¨ 1 ç‚¹æ£€æŸ¥è¿‡æœŸæƒé™
- è‡ªåŠ¨æ’¤é”€ï¼šè¿‡æœŸæƒé™è‡ªåŠ¨æ’¤é”€
- è¿‡æœŸé€šçŸ¥ï¼šè¿‡æœŸå‰ 3 å¤©é€šçŸ¥ç”¨æˆ·å’Œæˆæƒäºº

##### ğŸ”Œ API è®¾è®¡

**1. æŸ¥è¯¢æ‰€æœ‰æƒé™å®šä¹‰**

```
GET /api/v1/permissions
```

**å“åº”**:
```typescript
{
  "success": true,
  "data": [
    {
      "id": "perm_001",
      "code": "document:view",
      "name": "æŸ¥çœ‹æ–‡æ¡£",
      "category": "document",
      "scope": "department",
      "description": "æŸ¥çœ‹æœ¬éƒ¨é—¨æ–‡æ¡£"
    },
    {
      "id": "perm_002",
      "code": "document:view:cross_department",
      "name": "è·¨éƒ¨é—¨æŸ¥çœ‹æ–‡æ¡£",
      "category": "document",
      "scope": "cross_department",
      "description": "æŸ¥çœ‹å…¶ä»–éƒ¨é—¨æ–‡æ¡£"
    }
  ]
}
```

**2. æˆäºˆæƒé™**

```
POST /api/v1/user-permissions
```

**è¯·æ±‚ä½“**:
```typescript
{
  "userId": "user_123",
  "permissionId": "perm_002",
  "reason": "è´¨é‡éƒ¨éœ€è¦è·¨éƒ¨é—¨æŸ¥çœ‹ç”Ÿäº§è®°å½•",
  "expiresAt": "2026-03-13T23:59:59Z",  // å¯é€‰ï¼Œæƒé™è¿‡æœŸæ—¶é—´
  "resourceType": "document",            // å¯é€‰ï¼Œèµ„æºç±»å‹
  "resourceId": "doc_456"                // å¯é€‰ï¼Œèµ„æº ID
}
```

**å“åº”**:
```typescript
{
  "success": true,
  "data": {
    "id": "up_789",
    "userId": "user_123",
    "permissionId": "perm_002",
    "grantedBy": "user_admin",
    "grantedByName": "ç®¡ç†å‘˜",
    "grantedAt": "2026-02-13T10:00:00Z",
    "expiresAt": "2026-03-13T23:59:59Z",
    "reason": "è´¨é‡éƒ¨éœ€è¦è·¨éƒ¨é—¨æŸ¥çœ‹ç”Ÿäº§è®°å½•"
  }
}
```

**3. æ’¤é”€æƒé™**

```
DELETE /api/v1/user-permissions/:id
```

**å“åº”**:
```typescript
{
  "success": true,
  "message": "æƒé™å·²æ’¤é”€"
}
```

**4. æŸ¥è¯¢ç”¨æˆ·æƒé™åˆ—è¡¨**

```
GET /api/v1/user-permissions?userId=user_123
```

**å“åº”**:
```typescript
{
  "success": true,
  "data": [
    {
      "id": "up_789",
      "permission": {
        "code": "document:view:cross_department",
        "name": "è·¨éƒ¨é—¨æŸ¥çœ‹æ–‡æ¡£"
      },
      "grantedBy": "ç®¡ç†å‘˜",
      "grantedAt": "2026-02-13T10:00:00Z",
      "expiresAt": "2026-03-13T23:59:59Z",
      "status": "active"  // active | expired
    }
  ]
}
```

**5. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ç‰¹å®šæƒé™**

```
GET /api/v1/user-permissions/check?userId=user_123&permissionCode=document:view:cross_department
```

**å“åº”**:
```typescript
{
  "success": true,
  "data": {
    "hasPermission": true,
    "expiresAt": "2026-03-13T23:59:59Z"
  }
}
```

##### ğŸ¨ å‰ç«¯ç•Œé¢è®¾è®¡

**1. ç”¨æˆ·æƒé™ç®¡ç†é¡µé¢**

é¡µé¢è·¯ç”±ï¼š`/users/:id/permissions`

é¡µé¢å¸ƒå±€ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·æƒé™ç®¡ç† - å¼ ä¸‰ï¼ˆç”Ÿäº§éƒ¨ï¼‰                 [+ æˆäºˆæƒé™]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æƒé™åˆ—è¡¨                                                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ æƒé™åç§°           â”‚ èŒƒå›´     â”‚ æˆäºˆäºº â”‚ è¿‡æœŸæ—¶é—´ â”‚æ“ä½œâ”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ æŸ¥çœ‹æ–‡æ¡£            â”‚ æœ¬éƒ¨é—¨   â”‚ ç®¡ç†å‘˜ â”‚ æ°¸ä¹…     â”‚[æ’¤]â”‚ â”‚
â”‚ â”‚ è·¨éƒ¨é—¨æŸ¥çœ‹æ–‡æ¡£      â”‚ è·¨éƒ¨é—¨   â”‚ ç®¡ç†å‘˜ â”‚ 2026-03 â”‚[æ’¤]â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**2. æˆäºˆæƒé™å¯¹è¯æ¡†**

å¯¹è¯æ¡†å°ºå¯¸ï¼š`60% Ã— 70%`

å¯¹è¯æ¡†å†…å®¹ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æˆäºˆæƒé™                         [Ã—]     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ *æƒé™ç±»åˆ«: [æ–‡æ¡£æƒé™ â–¼]                  â”‚
â”‚                                         â”‚
â”‚ *æƒé™åç§°: [è·¨éƒ¨é—¨æŸ¥çœ‹æ–‡æ¡£ â–¼]            â”‚
â”‚                                         â”‚
â”‚ *æˆæƒåŸå› :                               â”‚
â”‚ [___________________________________]   â”‚
â”‚ [___________________________________]   â”‚
â”‚                                         â”‚
â”‚ æƒé™è¿‡æœŸæ—¶é—´: [2026-03-13 â–¼]  (å¯é€‰)    â”‚
â”‚                                         â”‚
â”‚ èµ„æºçº§æƒé™ (å¯é€‰):                       â”‚
â”‚ èµ„æºç±»å‹: [æ–‡æ¡£ â–¼]                       â”‚
â”‚ èµ„æºID: [DOC-2026-001]                  â”‚
â”‚                                         â”‚
â”‚              [å–æ¶ˆ]  [ç¡®å®šæˆäºˆ]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**3. Vue 3 ä»£ç ç¤ºä¾‹**

```vue
<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import {
  getUserPermissions,
  grantPermission,
  revokePermission
} from '@/api/permission'

const userId = ref('')
const permissions = ref([])
const grantDialogVisible = ref(false)

const grantForm = ref({
  permissionId: '',
  reason: '',
  expiresAt: null,
  resourceType: null,
  resourceId: null
})

const fetchPermissions = async () => {
  const res = await getUserPermissions(userId.value)
  permissions.value = res.data
}

const handleGrant = async () => {
  try {
    await grantPermission({
      userId: userId.value,
      ...grantForm.value
    })
    ElMessage.success('æƒé™æˆäºˆæˆåŠŸ')
    grantDialogVisible.value = false
    fetchPermissions()
  } catch (error) {
    ElMessage.error(error.message || 'æˆäºˆå¤±è´¥')
  }
}

const handleRevoke = async (permissionId: string) => {
  await ElMessageBox.confirm('ç¡®å®šæ’¤é”€è¯¥æƒé™ï¼Ÿ', 'æ’¤é”€æƒé™', {
    type: 'warning'
  })

  try {
    await revokePermission(permissionId)
    ElMessage.success('æƒé™å·²æ’¤é”€')
    fetchPermissions()
  } catch (error) {
    ElMessage.error(error.message || 'æ’¤é”€å¤±è´¥')
  }
}

onMounted(() => {
  fetchPermissions()
})
</script>

<template>
  <div class="user-permissions">
    <el-button type="primary" @click="grantDialogVisible = true">
      + æˆäºˆæƒé™
    </el-button>

    <el-table :data="permissions">
      <el-table-column prop="permission.name" label="æƒé™åç§°" />
      <el-table-column prop="permission.scope" label="èŒƒå›´" />
      <el-table-column prop="grantedByName" label="æˆäºˆäºº" />
      <el-table-column label="è¿‡æœŸæ—¶é—´">
        <template #default="{ row }">
          {{ row.expiresAt || 'æ°¸ä¹…' }}
        </template>
      </el-table-column>
      <el-table-column label="çŠ¶æ€">
        <template #default="{ row }">
          <el-tag :type="row.status === 'active' ? 'success' : 'danger'">
            {{ row.status === 'active' ? 'æœ‰æ•ˆ' : 'å·²è¿‡æœŸ' }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column label="æ“ä½œ" width="80">
        <template #default="{ row }">
          <el-button
            link
            type="danger"
            @click="handleRevoke(row.id)"
          >
            æ’¤é”€
          </el-button>
        </template>
      </el-table-column>
    </el-table>

    <!-- æˆäºˆæƒé™å¯¹è¯æ¡† -->
    <el-dialog
      v-model="grantDialogVisible"
      title="æˆäºˆæƒé™"
      width="60%"
    >
      <el-form :model="grantForm" label-width="120px">
        <el-form-item label="æƒé™åç§°" required>
          <el-select v-model="grantForm.permissionId" placeholder="è¯·é€‰æ‹©">
            <el-option label="è·¨éƒ¨é—¨æŸ¥çœ‹æ–‡æ¡£" value="perm_002" />
            <el-option label="ç¼–è¾‘ä»»åŠ¡" value="perm_003" />
          </el-select>
        </el-form-item>
        <el-form-item label="æˆæƒåŸå› " required>
          <el-input
            v-model="grantForm.reason"
            type="textarea"
            :rows="3"
            placeholder="è¯·è¾“å…¥æˆæƒåŸå› "
          />
        </el-form-item>
        <el-form-item label="æƒé™è¿‡æœŸæ—¶é—´">
          <el-date-picker
            v-model="grantForm.expiresAt"
            type="datetime"
            placeholder="é€‰æ‹©æ—¥æœŸæ—¶é—´"
          />
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="grantDialogVisible = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="handleGrant">ç¡®å®šæˆäºˆ</el-button>
      </template>
    </el-dialog>
  </div>
</template>
```

##### âœ… å®æ–½æ£€æŸ¥æ¸…å•

```
â–¡ 1. æ•°æ®æ¨¡å‹
   â–¡ 1a. Permission è¡¨åˆ›å»ºæˆåŠŸ
   â–¡ 1b. UserPermission è¡¨åˆ›å»ºæˆåŠŸ
   â–¡ 1c. ç´¢å¼•åˆ›å»ºæˆåŠŸï¼ˆuserId, permissionId, expiresAtï¼‰
   â–¡ 1d. åˆå§‹åŒ– 12+ æƒé™å®šä¹‰

â–¡ 2. API å®ç°
   â–¡ 2a. GET /api/v1/permissions å®ç°
   â–¡ 2b. POST /api/v1/user-permissions å®ç°
   â–¡ 2c. DELETE /api/v1/user-permissions/:id å®ç°
   â–¡ 2d. GET /api/v1/user-permissions å®ç°
   â–¡ 2e. GET /api/v1/user-permissions/check å®ç°

â–¡ 3. æƒé™å®ˆå«
   â–¡ 3a. PermissionGuard å®ç°
   â–¡ 3b. @RequirePermission() è£…é¥°å™¨å®ç°
   â–¡ 3c. æƒé™æ ¡éªŒé€»è¾‘æ­£ç¡®ï¼ˆå«è¿‡æœŸæ£€æŸ¥ï¼‰
   â–¡ 3d. èµ„æºçº§æƒé™æ ¡éªŒæ­£ç¡®

â–¡ 4. å®šæ—¶ä»»åŠ¡
   â–¡ 4a. æ¯æ—¥æ£€æŸ¥è¿‡æœŸæƒé™å®šæ—¶ä»»åŠ¡
   â–¡ 4b. è¿‡æœŸæƒé™è‡ªåŠ¨æ’¤é”€
   â–¡ 4c. è¿‡æœŸå‰ 3 å¤©é€šçŸ¥ç”¨æˆ·

â–¡ 5. ä¸šåŠ¡è§„åˆ™
   â–¡ 5a. BR-349 æƒé™å®šä¹‰è§„åˆ™éªŒè¯é€šè¿‡
   â–¡ 5b. BR-350 æƒé™æˆäºˆè§„åˆ™éªŒè¯é€šè¿‡
   â–¡ 5c. BR-351 æƒé™æ’¤é”€è§„åˆ™éªŒè¯é€šè¿‡
   â–¡ 5d. BR-352 èµ„æºçº§æƒé™è§„åˆ™éªŒè¯é€šè¿‡
   â–¡ 5e. BR-353 æƒé™è¿‡æœŸå¤„ç†è§„åˆ™éªŒè¯é€šè¿‡

â–¡ 6. å‰ç«¯ç•Œé¢
   â–¡ 6a. ç”¨æˆ·æƒé™ç®¡ç†é¡µé¢å®ç°
   â–¡ 6b. æˆäºˆæƒé™å¯¹è¯æ¡†å®ç°
   â–¡ 6c. æƒé™åˆ—è¡¨æ˜¾ç¤ºæ­£ç¡®
   â–¡ 6d. è¿‡æœŸçŠ¶æ€æ ‡ç­¾æ˜¾ç¤ºæ­£ç¡®

â–¡ 7. æµ‹è¯•
   â–¡ 7a. æƒé™æˆäºˆåœºæ™¯æµ‹è¯•é€šè¿‡
   â–¡ 7b. æƒé™æ’¤é”€åœºæ™¯æµ‹è¯•é€šè¿‡
   â–¡ 7c. æƒé™è¿‡æœŸåœºæ™¯æµ‹è¯•é€šè¿‡
   â–¡ 7d. èµ„æºçº§æƒé™åœºæ™¯æµ‹è¯•é€šè¿‡
```

---

#### 22.2.3 P1-3: å·¥ä½œæµå¼•æ“å®Œæ•´æ–¹æ¡ˆ

##### ğŸ“‹ ä¸šåŠ¡è§„åˆ™è¡¥å……

**BR-354: å·¥ä½œæµæ¨¡æ¿è§„åˆ™**
- æ¨¡æ¿åˆ›å»ºï¼šä»…ç®¡ç†å‘˜æˆ–éƒ¨é—¨ä¸»ç®¡å¯åˆ›å»ºå·¥ä½œæµæ¨¡æ¿
- æ¨¡æ¿ç¼–ç ï¼šå”¯ä¸€ï¼Œæ ¼å¼ä¸º `{category}_{department}_{seq}`ï¼Œå¦‚ `document_production_001`
- æ­¥éª¤é…ç½®ï¼šå·¥ä½œæµæ­¥éª¤ä½¿ç”¨ JSON é…ç½®ï¼ŒåŒ…å«æ­¥éª¤åç§°ã€å®¡æ‰¹äººè§’è‰²ã€è¶…æ—¶æ—¶é—´ã€å¹¶è¡Œæ¨¡å¼
- æ¨¡æ¿ç‰ˆæœ¬ï¼šä¿®æ”¹æ¨¡æ¿æ—¶åˆ›å»ºæ–°ç‰ˆæœ¬ï¼Œæ—§ç‰ˆæœ¬ä»å¯æŸ¥çœ‹ä½†ä¸å¯ä½¿ç”¨
- æ¨¡æ¿åœç”¨ï¼šåœç”¨æ¨¡æ¿åï¼Œå·²å¯åŠ¨çš„å·¥ä½œæµå®ä¾‹ä»å¯ç»§ç»­æ‰§è¡Œ

**BR-355: å·¥ä½œæµå¯åŠ¨è§„åˆ™**
- å¯åŠ¨æ¡ä»¶ï¼šèµ„æºï¼ˆæ–‡æ¡£/ä»»åŠ¡/è®°å½•ï¼‰å¿…é¡»æ»¡è¶³å¯åŠ¨æ¡ä»¶ï¼ˆå¦‚æ–‡æ¡£çŠ¶æ€ä¸º draftï¼‰
- æ¨¡æ¿é€‰æ‹©ï¼šæ ¹æ®èµ„æºç±»å‹å’Œéƒ¨é—¨è‡ªåŠ¨åŒ¹é…å·¥ä½œæµæ¨¡æ¿
- å‘èµ·äººè®°å½•ï¼šè®°å½•å·¥ä½œæµå‘èµ·äººå’Œå‘èµ·æ—¶é—´
- åˆå§‹çŠ¶æ€ï¼šå·¥ä½œæµå¯åŠ¨åçŠ¶æ€ä¸º `pending`ï¼Œç¬¬ä¸€æ­¥ä»»åŠ¡ä¸º `pending`

**BR-356: ä¸²è¡Œå®¡æ‰¹è§„åˆ™**
- é¡ºåºæ‰§è¡Œï¼šä¸²è¡Œå®¡æ‰¹æŒ‰æ­¥éª¤é¡ºåºæ‰§è¡Œï¼Œå‰ä¸€æ­¥æœªå®Œæˆæ—¶åä¸€æ­¥ä¸å¯æ‰§è¡Œ
- è‡ªåŠ¨åˆ†é…ï¼šå½“å‰æ­¥éª¤å®Œæˆåï¼Œè‡ªåŠ¨åˆ›å»ºä¸‹ä¸€æ­¥ä»»åŠ¡å¹¶é€šçŸ¥å®¡æ‰¹äºº
- å®¡æ‰¹è¶…æ—¶ï¼šè¶…è¿‡æˆªæ­¢æ—¶é—´æœªå®¡æ‰¹ï¼ŒçŠ¶æ€å˜ä¸º `timeout`ï¼Œè‡ªåŠ¨å‡çº§ç»™ä¸Šçº§

**BR-357: å¹¶è¡Œå®¡æ‰¹è§„åˆ™ï¼ˆä¼šç­¾ï¼‰**
- åŒæ­¥å¼€å§‹ï¼šå¹¶è¡Œå®¡æ‰¹çš„æ‰€æœ‰ä»»åŠ¡åŒæ—¶åˆ›å»ºï¼ŒåŒæ—¶é€šçŸ¥æ‰€æœ‰å®¡æ‰¹äºº
- å…¨éƒ¨é€šè¿‡ï¼šæ‰€æœ‰å¹¶è¡Œä»»åŠ¡éƒ½é€šè¿‡åï¼Œæ‰è¿›å…¥ä¸‹ä¸€æ­¥
- ä¸€äººæ‹’ç»ï¼šä»»ä¸€å¹¶è¡Œä»»åŠ¡æ‹’ç»ï¼Œæ•´ä¸ªå·¥ä½œæµçŠ¶æ€å˜ä¸º `rejected`ï¼Œå…¶ä»–å¹¶è¡Œä»»åŠ¡è‡ªåŠ¨è·³è¿‡
- ä¸€äººè¶…æ—¶ï¼šä»»ä¸€å¹¶è¡Œä»»åŠ¡è¶…æ—¶ï¼Œå…¶ä»–å¹¶è¡Œä»»åŠ¡ä¸èƒ½ç»§ç»­ï¼Œæ•´ä¸ªå·¥ä½œæµçŠ¶æ€å˜ä¸º `timeout`

**BR-358: å®¡æ‰¹è¶…æ—¶å‡çº§è§„åˆ™**
- è¶…æ—¶æ—¶é—´ï¼šæ¯ä¸ªæ­¥éª¤å¯é…ç½®è¶…æ—¶æ—¶é—´ï¼ˆå¦‚ 24 å°æ—¶ã€48 å°æ—¶ï¼‰
- è‡ªåŠ¨å‡çº§ï¼šè¶…æ—¶åè‡ªåŠ¨å‡çº§ç»™ä¸Šçº§å®¡æ‰¹äººï¼ˆescalatedToï¼‰
- å‡çº§é€šçŸ¥ï¼šå‡çº§åé€šçŸ¥åŸå®¡æ‰¹äººå’Œä¸Šçº§å®¡æ‰¹äºº
- åŸå®¡æ‰¹äººä»å¯å®¡æ‰¹ï¼šå‡çº§ååŸå®¡æ‰¹äººä»å¯å®Œæˆå®¡æ‰¹

**BR-359: å·¥ä½œæµå–æ¶ˆè§„åˆ™**
- å–æ¶ˆæƒé™ï¼šä»…å·¥ä½œæµå‘èµ·äººæˆ–ç®¡ç†å‘˜å¯å–æ¶ˆ
- å–æ¶ˆæ—¶æœºï¼šä»… `pending` æˆ– `in_progress` çŠ¶æ€å¯å–æ¶ˆ
- å–æ¶ˆåŸå› ï¼šå¿…é¡»å¡«å†™å–æ¶ˆåŸå› 
- å–æ¶ˆé€šçŸ¥ï¼šå–æ¶ˆåé€šçŸ¥æ‰€æœ‰ç›¸å…³å®¡æ‰¹äºº

##### ğŸ”Œ API è®¾è®¡

**1. åˆ›å»ºå·¥ä½œæµæ¨¡æ¿**

```
POST /api/v1/workflow-templates
```

**è¯·æ±‚ä½“**:
```typescript
{
  "code": "document_production_001",
  "name": "ç”Ÿäº§éƒ¨æ–‡æ¡£å®¡æ‰¹æµç¨‹",
  "departmentId": "dept_123",
  "category": "document",
  "steps": [
    {
      "index": 0,
      "name": "éƒ¨é—¨ä¸»ç®¡å®¡æ‰¹",
      "assigneeRole": "manager",  // å®¡æ‰¹äººè§’è‰²
      "parallelMode": false,
      "timeoutHours": 24
    },
    {
      "index": 1,
      "name": "è´¨é‡éƒ¨ä¼šç­¾",
      "assigneeRole": "quality_manager",
      "parallelMode": true,       // å¹¶è¡Œå®¡æ‰¹
      "parallelAssignees": ["user_001", "user_002"],  // æŒ‡å®šå®¡æ‰¹äºº
      "timeoutHours": 48
    }
  ]
}
```

**å“åº”**:
```typescript
{
  "success": true,
  "data": {
    "id": "wft_789",
    "code": "document_production_001",
    "name": "ç”Ÿäº§éƒ¨æ–‡æ¡£å®¡æ‰¹æµç¨‹",
    "version": 1,
    "status": "active"
  }
}
```

**2. å¯åŠ¨å·¥ä½œæµ**

```
POST /api/v1/workflow-instances
```

**è¯·æ±‚ä½“**:
```typescript
{
  "templateId": "wft_789",
  "resourceType": "document",
  "resourceId": "doc_456",
  "resourceTitle": "è´¨é‡æ‰‹å†Œ V2.0"
}
```

**å“åº”**:
```typescript
{
  "success": true,
  "data": {
    "id": "wfi_101",
    "templateCode": "document_production_001",
    "status": "in_progress",
    "currentStep": 0,
    "tasks": [
      {
        "id": "wft_201",
        "stepName": "éƒ¨é—¨ä¸»ç®¡å®¡æ‰¹",
        "assigneeId": "user_manager",
        "status": "pending",
        "dueAt": "2026-02-14T10:00:00Z"
      }
    ]
  }
}
```

**3. å®¡æ‰¹å·¥ä½œæµä»»åŠ¡**

```
POST /api/v1/workflow-tasks/:taskId/approve
```

**è¯·æ±‚ä½“**:
```typescript
{
  "action": "approve",  // approve | reject
  "comment": "æ–‡æ¡£å†…å®¹ç¬¦åˆè¦æ±‚ï¼ŒåŒæ„å‘å¸ƒ"
}
```

**å“åº”**:
```typescript
{
  "success": true,
  "data": {
    "taskId": "wft_201",
    "status": "approved",
    "completedAt": "2026-02-13T14:00:00Z",
    "nextTask": {
      "id": "wft_202",
      "stepName": "è´¨é‡éƒ¨ä¼šç­¾",
      "assigneeId": "user_001",
      "status": "pending"
    }
  }
}
```

**4. å–æ¶ˆå·¥ä½œæµ**

```
POST /api/v1/workflow-instances/:id/cancel
```

**è¯·æ±‚ä½“**:
```typescript
{
  "reason": "æ–‡æ¡£å†…å®¹éœ€é‡æ–°ä¿®è®¢"
}
```

**å“åº”**:
```typescript
{
  "success": true,
  "message": "å·¥ä½œæµå·²å–æ¶ˆ"
}
```

**5. æŸ¥è¯¢æˆ‘çš„å¾…å®¡æ‰¹ä»»åŠ¡**

```
GET /api/v1/workflow-tasks/my-tasks?status=pending
```

**å“åº”**:
```typescript
{
  "success": true,
  "data": [
    {
      "id": "wft_201",
      "instanceId": "wfi_101",
      "stepName": "éƒ¨é—¨ä¸»ç®¡å®¡æ‰¹",
      "resourceType": "document",
      "resourceTitle": "è´¨é‡æ‰‹å†Œ V2.0",
      "initiatorName": "å¼ ä¸‰",
      "status": "pending",
      "dueAt": "2026-02-14T10:00:00Z"
    }
  ]
}
```

##### ğŸ¨ å‰ç«¯ç•Œé¢è®¾è®¡

**1. å·¥ä½œæµæ¨¡æ¿ç¼–è¾‘å™¨ï¼ˆå¯è§†åŒ–è®¾è®¡å™¨ï¼‰**

é¡µé¢è·¯ç”±ï¼š`/workflow-templates/editor`

é¡µé¢å¸ƒå±€ï¼ˆç®€åŒ–ç‰ˆï¼Œè¯¦ç»†è®¾è®¡è§ INTERACTION_DESIGN.mdï¼‰:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å·¥ä½œæµè®¾è®¡å™¨                             [ä¿å­˜] [é¢„è§ˆ]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åŸºæœ¬ä¿¡æ¯:                                                 â”‚
â”‚ æ¨¡æ¿åç§°: [ç”Ÿäº§éƒ¨æ–‡æ¡£å®¡æ‰¹æµç¨‹__________]                   â”‚
â”‚ æ‰€å±éƒ¨é—¨: [ç”Ÿäº§éƒ¨ â–¼]  ç±»åˆ«: [æ–‡æ¡£ â–¼]                      â”‚
â”‚                                                          â”‚
â”‚ å®¡æ‰¹æ­¥éª¤:                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ æ­¥éª¤ 1: éƒ¨é—¨ä¸»ç®¡å®¡æ‰¹                    [ç¼–è¾‘][åˆ é™¤]â”‚   â”‚
â”‚ â”‚ å®¡æ‰¹äººè§’è‰²: éƒ¨é—¨ä¸»ç®¡  è¶…æ—¶: 24å°æ—¶                  â”‚   â”‚
â”‚ â”‚                                                    â”‚   â”‚
â”‚ â”‚              â†“                                     â”‚   â”‚
â”‚ â”‚                                                    â”‚   â”‚
â”‚ â”‚ æ­¥éª¤ 2: è´¨é‡éƒ¨ä¼šç­¾ï¼ˆå¹¶è¡Œï¼‰              [ç¼–è¾‘][åˆ é™¤]â”‚   â”‚
â”‚ â”‚ å®¡æ‰¹äºº: å¼ ä¸‰, æå››   è¶…æ—¶: 48å°æ—¶                   â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ [+ æ·»åŠ æ­¥éª¤]                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**2. æˆ‘çš„å¾…åŠä»»åŠ¡é¡µé¢**

é¡µé¢è·¯ç”±ï¼š`/my-tasks`

é¡µé¢å¸ƒå±€ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æˆ‘çš„å¾…åŠ                     [å…¨éƒ¨] [æ–‡æ¡£] [ä»»åŠ¡] [è®°å½•]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ èµ„æºæ ‡é¢˜    â”‚ æ­¥éª¤     â”‚ å‘èµ·äºº â”‚ æˆªæ­¢æ—¶é—´ â”‚ æ“ä½œ â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚ è´¨é‡æ‰‹å†ŒV2  â”‚ ä¸»ç®¡å®¡æ‰¹ â”‚ å¼ ä¸‰   â”‚ æ˜å¤©     â”‚[å®¡]â”‚   â”‚
â”‚ â”‚ ç”Ÿäº§è®°å½•001 â”‚ è´¨é‡ä¼šç­¾ â”‚ æå››   â”‚ 2å¤©å    â”‚[å®¡]â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**3. å®¡æ‰¹å¯¹è¯æ¡†**

å¯¹è¯æ¡†å°ºå¯¸ï¼š`70% Ã— 80%`

å¯¹è¯æ¡†å†…å®¹ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¡æ‰¹ - è´¨é‡æ‰‹å†Œ V2.0             [Ã—]     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å®¡æ‰¹æµç¨‹:                                â”‚
â”‚ [âœ“] éƒ¨é—¨ä¸»ç®¡å®¡æ‰¹ â†’ [â—] è´¨é‡éƒ¨ä¼šç­¾        â”‚
â”‚                                         â”‚
â”‚ æ–‡æ¡£é¢„è§ˆ:                                â”‚
â”‚ [PDFé¢„è§ˆåŒºåŸŸ........................]   â”‚
â”‚                                         â”‚
â”‚ å®¡æ‰¹æ„è§:                                â”‚
â”‚ [___________________________________]   â”‚
â”‚ [___________________________________]   â”‚
â”‚                                         â”‚
â”‚          [æ‹’ç»]  [é€šè¿‡]                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**4. Vue 3 ä»£ç ç¤ºä¾‹**

```vue
<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { ElMessage } from 'element-plus'
import { getMyTasks, approveTask, rejectTask } from '@/api/workflow'

const myTasks = ref([])
const approveDialogVisible = ref(false)
const currentTask = ref(null)
const approveComment = ref('')

const fetchMyTasks = async () => {
  const res = await getMyTasks({ status: 'pending' })
  myTasks.value = res.data
}

const handleApprove = async (action: 'approve' | 'reject') => {
  try {
    if (action === 'approve') {
      await approveTask(currentTask.value.id, {
        action: 'approve',
        comment: approveComment.value
      })
      ElMessage.success('å®¡æ‰¹é€šè¿‡')
    } else {
      await rejectTask(currentTask.value.id, {
        action: 'reject',
        comment: approveComment.value
      })
      ElMessage.success('å·²æ‹’ç»')
    }

    approveDialogVisible.value = false
    fetchMyTasks()
  } catch (error) {
    ElMessage.error(error.message || 'æ“ä½œå¤±è´¥')
  }
}

onMounted(() => {
  fetchMyTasks()
})
</script>

<template>
  <div class="my-tasks">
    <h2>æˆ‘çš„å¾…åŠ</h2>

    <el-table :data="myTasks">
      <el-table-column prop="resourceTitle" label="èµ„æºæ ‡é¢˜" />
      <el-table-column prop="stepName" label="æ­¥éª¤" />
      <el-table-column prop="initiatorName" label="å‘èµ·äºº" />
      <el-table-column label="æˆªæ­¢æ—¶é—´">
        <template #default="{ row }">
          <span :class="{ 'text-danger': isOverdue(row.dueAt) }">
            {{ formatDueDate(row.dueAt) }}
          </span>
        </template>
      </el-table-column>
      <el-table-column label="æ“ä½œ" width="80">
        <template #default="{ row }">
          <el-button
            link
            type="primary"
            @click="openApproveDialog(row)"
          >
            å®¡æ‰¹
          </el-button>
        </template>
      </el-table-column>
    </el-table>

    <!-- å®¡æ‰¹å¯¹è¯æ¡† -->
    <el-dialog
      v-model="approveDialogVisible"
      :title="`å®¡æ‰¹ - ${currentTask?.resourceTitle}`"
      width="70%"
    >
      <div v-if="currentTask">
        <!-- å®¡æ‰¹æµç¨‹å±•ç¤º -->
        <div class="workflow-steps">
          <el-steps :active="currentTask.stepIndex" finish-status="success">
            <el-step title="éƒ¨é—¨ä¸»ç®¡å®¡æ‰¹" />
            <el-step title="è´¨é‡éƒ¨ä¼šç­¾" />
          </el-steps>
        </div>

        <!-- å®¡æ‰¹æ„è§ -->
        <el-form label-width="100px">
          <el-form-item label="å®¡æ‰¹æ„è§">
            <el-input
              v-model="approveComment"
              type="textarea"
              :rows="4"
              placeholder="è¯·è¾“å…¥å®¡æ‰¹æ„è§"
            />
          </el-form-item>
        </el-form>
      </div>

      <template #footer>
        <el-button type="danger" @click="handleApprove('reject')">
          æ‹’ç»
        </el-button>
        <el-button type="success" @click="handleApprove('approve')">
          é€šè¿‡
        </el-button>
      </template>
    </el-dialog>
  </div>
</template>
```

##### âœ… å®æ–½æ£€æŸ¥æ¸…å•

```
â–¡ 1. æ•°æ®æ¨¡å‹
   â–¡ 1a. WorkflowTemplate è¡¨åˆ›å»ºæˆåŠŸ
   â–¡ 1b. WorkflowInstance è¡¨åˆ›å»ºæˆåŠŸ
   â–¡ 1c. WorkflowTask è¡¨åˆ›å»ºæˆåŠŸ
   â–¡ 1d. ç´¢å¼•åˆ›å»ºæˆåŠŸ

â–¡ 2. å·¥ä½œæµå¼•æ“
   â–¡ 2a. WorkflowService å®ç°
   â–¡ 2b. å¯åŠ¨å·¥ä½œæµé€»è¾‘æ­£ç¡®
   â–¡ 2c. ä¸²è¡Œå®¡æ‰¹é€»è¾‘æ­£ç¡®
   â–¡ 2d. å¹¶è¡Œå®¡æ‰¹é€»è¾‘æ­£ç¡®
   â–¡ 2e. å®¡æ‰¹è¶…æ—¶å‡çº§é€»è¾‘æ­£ç¡®
   â–¡ 2f. å·¥ä½œæµå–æ¶ˆé€»è¾‘æ­£ç¡®

â–¡ 3. å®šæ—¶ä»»åŠ¡
   â–¡ 3a. WorkflowScheduler å®ç°
   â–¡ 3b. æ¯ 10 åˆ†é’Ÿæ£€æŸ¥è¶…æ—¶ä»»åŠ¡
   â–¡ 3c. è¶…æ—¶ä»»åŠ¡è‡ªåŠ¨å‡çº§
   â–¡ 3d. è¶…æ—¶é€šçŸ¥å‘é€æ­£ç¡®

â–¡ 4. API å®ç°
   â–¡ 4a. POST /api/v1/workflow-templates å®ç°
   â–¡ 4b. POST /api/v1/workflow-instances å®ç°
   â–¡ 4c. POST /api/v1/workflow-tasks/:id/approve å®ç°
   â–¡ 4d. POST /api/v1/workflow-instances/:id/cancel å®ç°
   â–¡ 4e. GET /api/v1/workflow-tasks/my-tasks å®ç°

â–¡ 5. ä¸šåŠ¡è§„åˆ™
   â–¡ 5a. BR-354 å·¥ä½œæµæ¨¡æ¿è§„åˆ™éªŒè¯é€šè¿‡
   â–¡ 5b. BR-355 å·¥ä½œæµå¯åŠ¨è§„åˆ™éªŒè¯é€šè¿‡
   â–¡ 5c. BR-356 ä¸²è¡Œå®¡æ‰¹è§„åˆ™éªŒè¯é€šè¿‡
   â–¡ 5d. BR-357 å¹¶è¡Œå®¡æ‰¹è§„åˆ™éªŒè¯é€šè¿‡
   â–¡ 5e. BR-358 å®¡æ‰¹è¶…æ—¶å‡çº§è§„åˆ™éªŒè¯é€šè¿‡
   â–¡ 5f. BR-359 å·¥ä½œæµå–æ¶ˆè§„åˆ™éªŒè¯é€šè¿‡

â–¡ 6. å‰ç«¯ç•Œé¢
   â–¡ 6a. å·¥ä½œæµæ¨¡æ¿ç¼–è¾‘å™¨å®ç°ï¼ˆå¯è§†åŒ–è®¾è®¡å™¨ï¼‰
   â–¡ 6b. æˆ‘çš„å¾…åŠä»»åŠ¡é¡µé¢å®ç°
   â–¡ 6c. å®¡æ‰¹å¯¹è¯æ¡†å®ç°
   â–¡ 6d. å®¡æ‰¹æµç¨‹å¯è§†åŒ–æ˜¾ç¤ºæ­£ç¡®

â–¡ 7. æµ‹è¯•
   â–¡ 7a. ä¸²è¡Œå®¡æ‰¹åœºæ™¯æµ‹è¯•é€šè¿‡
   â–¡ 7b. å¹¶è¡Œå®¡æ‰¹åœºæ™¯æµ‹è¯•é€šè¿‡
   â–¡ 7c. å®¡æ‰¹è¶…æ—¶å‡çº§åœºæ™¯æµ‹è¯•é€šè¿‡
   â–¡ 7d. å·¥ä½œæµå–æ¶ˆåœºæ™¯æµ‹è¯•é€šè¿‡
   â–¡ 7e. ä¸€äººæ‹’ç»å…¨éƒ¨å¤±æ•ˆåœºæ™¯æµ‹è¯•é€šè¿‡
   â–¡ 7f. ä¸€äººè¶…æ—¶é˜»å¡åœºæ™¯æµ‹è¯•é€šè¿‡
```

---

### 22.3 API ç«¯ç‚¹è§„èŒƒåŒ–ï¼ˆP2 ä¼˜å…ˆçº§ï¼‰

#### 22.2.1 ç»Ÿä¸€ API è·¯å¾„å‰ç¼€ï¼ˆP2-1ï¼‰

**é—®é¢˜æè¿°**:
- DESIGN.md å®šä¹‰æ‰€æœ‰ API ä½¿ç”¨ `/api/v1` å‰ç¼€
- å®é™…å®ç°ç¼ºå°‘ç‰ˆæœ¬å‰ç¼€ï¼ˆå¦‚ `POST /documents` è€Œé `POST /api/v1/documents`ï¼‰

**ä¿®å¤æ–¹æ¡ˆ**:

```typescript
// server/src/main.ts

async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  // è®¾ç½®å…¨å±€ API å‰ç¼€
  app.setGlobalPrefix('api/v1');

  // ... å…¶ä»–é…ç½® ...

  await app.listen(3000);
}
```

**é¢„ä¼°å·¥ä½œé‡**: 10 åˆ†é’Ÿ

---

### 22.3 å®æ–½ç­–ç•¥ä¸ä¼˜å…ˆçº§

#### 22.3.1 å®æ–½åŸåˆ™ âš ï¸ é‡è¦

**æ ¸å¿ƒåŸåˆ™**: **æŠ€æœ¯å€ºåŠ¡ä¼˜å…ˆäºæ–°éœ€æ±‚**

åœ¨å¼€å‘æ–°åŠŸèƒ½å‰ï¼Œå¿…é¡»å…ˆå¤„ç†ç›¸å…³çš„æŠ€æœ¯å€ºåŠ¡ï¼Œé¿å…å€ºåŠ¡ç´¯ç§¯ï¼š

| åœºæ™¯ | å¤„ç†ç­–ç•¥ | åŸå›  |
|------|---------|------|
| **å¼€å‘æ–° Phase åŠŸèƒ½** | å…ˆä¿®å¤ P1 å€ºåŠ¡ï¼Œå†å¼€å‘æ–°åŠŸèƒ½ | é¿å…åœ¨æœ‰ç¼ºé™·çš„åŸºç¡€ä¸Šå åŠ åŠŸèƒ½ |
| **åŠŸèƒ½ä¾èµ–æŠ€æœ¯å€ºåŠ¡** | å¿…é¡»å…ˆä¿®å¤å€ºåŠ¡å†å¼€å‘ | ä¾‹å¦‚ï¼šè·¨éƒ¨é—¨æƒé™åŠŸèƒ½éœ€è¦å…ˆå®æ–½ P1-2 |
| **ç‹¬ç«‹åŠŸèƒ½** | å¯å¹¶è¡Œå¼€å‘ï¼Œä½†ä¼˜å…ˆä¿®å¤å€ºåŠ¡ | èµ„æºæœ‰é™æ—¶ä¼˜å…ˆå€ºåŠ¡ä¿®å¤ |
| **ç´§æ€¥éœ€æ±‚** | è¯„ä¼°æ˜¯å¦å¯å»¶åå€ºåŠ¡ä¿®å¤ | ç‰¹æ®Šæƒ…å†µéœ€é¡¹ç›®ä¸»å¯¼è€…æ‰¹å‡† |

**åä¾‹**ï¼ˆç¦æ­¢ï¼‰ï¼š
- âŒ å…ˆå¼€å‘ Phase 10-12 åŠŸèƒ½ï¼ŒæŠŠæŠ€æœ¯å€ºåŠ¡ç•™åˆ°æœ€å
- âŒ å› ä¸º"å·¥ä½œé‡å¤§"è·³è¿‡ P1-3 å·¥ä½œæµå¼•æ“ï¼Œç»§ç»­ç”¨ç¡¬ç¼–ç 
- âŒ æ–°åŠŸèƒ½ä¸å€ºåŠ¡å¹¶è¡Œå¼€å‘ï¼Œå¯¼è‡´å†²çªå’Œè¿”å·¥

**æ­£ä¾‹**ï¼ˆæ¨èï¼‰ï¼š
- âœ… å¼€å‘ Phase 10 å‰ï¼Œå…ˆä¿®å¤ P1-2 æƒé™ç³»ç»Ÿ
- âœ… å¼€å‘ Phase 11 å‰ï¼Œå…ˆä¿®å¤ P1-3 å·¥ä½œæµå¼•æ“
- âœ… æ¯ä¸ªè¿­ä»£é¢„ç•™ 20% æ—¶é—´ä¿®å¤æŠ€æœ¯å€ºåŠ¡

---

#### 22.3.2 å®æ–½è·¯çº¿å›¾

**é˜¶æ®µ 0: ç«‹å³ä¿®å¤ï¼ˆæœ¬å‘¨å†…ï¼‰**

| æ”¹è¿›é¡¹ | å·¥ä½œé‡ | ä¼˜å…ˆçº§ | åŸå›  |
|-------|--------|--------|------|
| **P1-1** Document å½’æ¡£/ä½œåºŸå­—æ®µ | 2-3 å°æ—¶ | ğŸ”´ æœ€é«˜ | BRCGS åˆè§„è¦æ±‚ |
| **P2-1** API è·¯å¾„å‰ç¼€ç»Ÿä¸€ | 10 åˆ†é’Ÿ | ğŸŸ¡ ä¸­ | å½±å“æ‰€æœ‰åç»­ API å¼€å‘ |

**æ€»å·¥ä½œé‡**: 3 å°æ—¶

**å®Œæˆæ ‡å‡†**:
- âœ… Document è¡¨æ–°å¢ 6 ä¸ªå½’æ¡£/ä½œåºŸå­—æ®µ
- âœ… å½’æ¡£/ä½œåºŸ API å®ç°å¹¶æµ‹è¯•é€šè¿‡
- âœ… å‰ç«¯å½’æ¡£/ä½œåºŸç•Œé¢å¯ç”¨
- âœ… å…¨å±€ API å‰ç¼€æ”¹ä¸º `/api/v1`

---

**é˜¶æ®µ 1: Phase 10 å¼€å‘å‰ç½®ï¼ˆéœ€æ±‚ç¡®è®¤å 1 å‘¨å†…ï¼‰**

| æ”¹è¿›é¡¹ | å·¥ä½œé‡ | ä¾èµ–å…³ç³» |
|-------|--------|----------|
| **P1-2** Permission/UserPermission è¡¨ | 8-16 å°æ—¶ | Phase 10 è·¨éƒ¨é—¨æƒé™åŠŸèƒ½çš„åŸºç¡€ |

**å®æ–½æ—¶æœº**: Phase 10ï¼ˆåŸ¹è®­ç®¡ç†ã€è·¨éƒ¨é—¨åä½œï¼‰å¯åŠ¨å‰

**å®Œæˆæ ‡å‡†**:
- âœ… Permission å’Œ UserPermission è¡¨åˆ›å»º
- âœ… 12+ æƒé™å®šä¹‰åˆå§‹åŒ–
- âœ… æƒé™è£…é¥°å™¨å’Œå®ˆå«å®ç°
- âœ… æƒé™ç®¡ç† API å¯ç”¨
- âœ… å‰ç«¯æƒé™ç®¡ç†ç•Œé¢å®Œæˆ

**é£é™©**: å¦‚æœè·³è¿‡æ­¤æ­¥éª¤ï¼ŒPhase 10 æ— æ³•å®ç°è·¨éƒ¨é—¨æƒé™æ§åˆ¶

---

**é˜¶æ®µ 2: Phase 11 å¼€å‘å‰ç½®ï¼ˆéœ€æ±‚ç¡®è®¤å 1.5-2 å‘¨å†…ï¼‰**

| æ”¹è¿›é¡¹ | å·¥ä½œé‡ | ä¾èµ–å…³ç³» |
|-------|--------|----------|
| **P1-3** WorkflowTemplate ç›¸å…³è¡¨ | 24-40 å°æ—¶ | Phase 11 å†…å®¡ç®¡ç†ã€å¤æ‚å®¡æ‰¹æµç¨‹çš„åŸºç¡€ |

**å®æ–½æ—¶æœº**: Phase 11ï¼ˆå†…å®¡ç®¡ç†ã€é«˜çº§å·¥ä½œæµï¼‰å¯åŠ¨å‰

**å®Œæˆæ ‡å‡†**:
- âœ… WorkflowTemplate/Instance/Task è¡¨åˆ›å»º
- âœ… å·¥ä½œæµå¼•æ“æ ¸å¿ƒé€»è¾‘å®ç°
- âœ… å¹¶è¡Œå®¡æ‰¹ã€è¶…æ—¶å‡çº§åŠŸèƒ½å¯ç”¨
- âœ… å®šæ—¶ä»»åŠ¡æ­£å¸¸è¿è¡Œ
- âœ… å·¥ä½œæµé…ç½®ç•Œé¢å®Œæˆ

**é£é™©**: å¦‚æœè·³è¿‡æ­¤æ­¥éª¤ï¼ŒPhase 11 å®¡æ‰¹æµç¨‹ä»ç„¶ç¡¬ç¼–ç ï¼Œæ— æ³•çµæ´»é…ç½®

---

#### 22.3.3 æ€»å·¥ä½œé‡ä¸æ—¶é—´è§„åˆ’

| é˜¶æ®µ | å·¥ä½œé‡ | å»ºè®®æ—¶é—´å®‰æ’ | å¯å¹¶è¡Œåº¦ |
|------|--------|-------------|----------|
| é˜¶æ®µ 0ï¼ˆç«‹å³ï¼‰ | 3 å°æ—¶ | æœ¬å‘¨å†…å®Œæˆ | å•äººå³å¯ |
| é˜¶æ®µ 1ï¼ˆPhase 10 å‰ï¼‰ | 8-16 å°æ—¶ | 1-2 ä¸ªå·¥ä½œæ—¥ | 1-2 äººå¹¶è¡Œ |
| é˜¶æ®µ 2ï¼ˆPhase 11 å‰ï¼‰ | 24-40 å°æ—¶ | 3-5 ä¸ªå·¥ä½œæ—¥ | 2-3 äººå¹¶è¡Œ |
| **æ€»è®¡** | **35-59 å°æ—¶** | **4-7 ä¸ªå·¥ä½œæ—¥** | **å¯åˆ†é˜¶æ®µå®æ–½** |

**å»ºè®®æ’æœŸ**:
- ç¬¬ 1 å‘¨ï¼šä¿®å¤ P1-1 + P2-1ï¼ˆé˜¶æ®µ 0ï¼‰
- ç¬¬ 2-3 å‘¨ï¼šä¿®å¤ P1-2ï¼ˆé˜¶æ®µ 1ï¼Œä¸ Phase 10 éœ€æ±‚è°ƒç ”å¹¶è¡Œï¼‰
- ç¬¬ 4-5 å‘¨ï¼šä¿®å¤ P1-3ï¼ˆé˜¶æ®µ 2ï¼Œä¸ Phase 11 éœ€æ±‚è°ƒç ”å¹¶è¡Œï¼‰

---

#### 22.3.4 é£é™©è¯„ä¼°

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| **æŠ€æœ¯å€ºåŠ¡æ‹–å»¶** | åç»­åŠŸèƒ½æ— æ³•æ­£å¸¸å¼€å‘ï¼Œè¿”å·¥æˆæœ¬é«˜ | ä¸¥æ ¼æ‰§è¡Œ"å€ºåŠ¡ä¼˜å…ˆäºæ–°éœ€æ±‚"åŸåˆ™ |
| **P1-3 å·¥ä½œé‡å¤§** | å¯èƒ½å»¶è¯¯ Phase 11 å¼€å‘ | æå‰ 2 å‘¨å¯åŠ¨ï¼Œé¢„ç•™ç¼“å†²æ—¶é—´ |
| **å¹¶è¡Œå¼€å‘å†²çª** | å€ºåŠ¡ä¿®å¤ä¸æ–°åŠŸèƒ½å†²çª | å¼ºåˆ¶ä¸²è¡Œï¼šå…ˆå€ºåŠ¡åæ–°åŠŸèƒ½ |
| **æµ‹è¯•ä¸å……åˆ†** | å€ºåŠ¡ä¿®å¤å¼•å…¥æ–° bug | æ¯ä¸ªé˜¶æ®µå¿…é¡»æœ‰å®Œæ•´æµ‹è¯•éªŒè¯ |

---

### 22.4 æŠ€æœ¯å€ºåŠ¡ç®¡ç†æµç¨‹

1. **è®°å½•å€ºåŠ¡**: æ‰€æœ‰å‘ç°çš„ä¸ä¸€è‡´é—®é¢˜è®°å½•åˆ°æœ¬ç« èŠ‚
2. **ä¼˜å…ˆçº§è¯„ä¼°**: P0ï¼ˆç«‹å³ä¿®å¤ï¼‰ã€P1ï¼ˆæ–°åŠŸèƒ½å‰ç½®æ¡ä»¶ï¼‰ã€P2ï¼ˆä¼˜åŒ–æ”¹è¿›ï¼‰
3. **å®æ–½æ—¶æœº**: âš ï¸ **æ–°åŠŸèƒ½å¼€å‘å‰å¼ºåˆ¶ä¿®å¤ç›¸å…³å€ºåŠ¡**
4. **éªŒæ”¶æ ‡å‡†**:
   - æ•°æ®åº“è¿ç§»æˆåŠŸ
   - API æµ‹è¯•é€šè¿‡ï¼ˆå•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯•ï¼‰
   - å‰ç«¯ç•Œé¢éªŒæ”¶é€šè¿‡
   - ä¸šåŠ¡è§„åˆ™éªŒè¯é€šè¿‡
   - ä»£ç å®¡æŸ¥é€šè¿‡

---

### 22.5 å®æ–½æ£€æŸ¥æ¸…å•

æ¯ä¸ªé˜¶æ®µå®Œæˆåï¼Œå¿…é¡»é€šè¿‡ä»¥ä¸‹æ£€æŸ¥ï¼š

#### é˜¶æ®µ 0 æ£€æŸ¥æ¸…å•

```
â–¡ 1. Document è¡¨è¿ç§»æˆåŠŸ
   â–¡ 1a. æ•°æ®åº“æ–°å¢ 6 ä¸ªå½’æ¡£/ä½œåºŸå­—æ®µ
   â–¡ 1b. ç´¢å¼•åˆ›å»ºæˆåŠŸ
   â–¡ 1c. ç°æœ‰æ•°æ®ä¸å—å½±å“

â–¡ 2. å½’æ¡£/ä½œåºŸ API å®ç°
   â–¡ 2a. POST /api/v1/documents/:id/archive å¯ç”¨
   â–¡ 2b. POST /api/v1/documents/:id/obsolete å¯ç”¨
   â–¡ 2c. DTO éªŒè¯é€šè¿‡ï¼ˆreason å¿…å¡«ï¼‰
   â–¡ 2d. æƒé™æ£€æŸ¥æ­£å¸¸ï¼ˆç®¡ç†å‘˜æ‰èƒ½ä½œåºŸï¼‰

â–¡ 3. å‰ç«¯ç•Œé¢å®Œæˆ
   â–¡ 3a. DocumentDetail é¡µé¢æœ‰å½’æ¡£/ä½œåºŸæŒ‰é’®
   â–¡ 3b. å½’æ¡£å¯¹è¯æ¡†å¯ç”¨ï¼ˆå¡«å†™åŸå› ï¼‰
   â–¡ 3c. ä½œåºŸå¯¹è¯æ¡†å¯ç”¨ï¼ˆæ˜¾ç¤ºè­¦å‘Šï¼‰
   â–¡ 3d. æ“ä½œæˆåŠŸååˆ·æ–°é¡µé¢

â–¡ 4. API è·¯å¾„å‰ç¼€ç»Ÿä¸€
   â–¡ 4a. main.ts è®¾ç½® app.setGlobalPrefix('api/v1')
   â–¡ 4b. å‰ç«¯æ‰€æœ‰ API è°ƒç”¨è·¯å¾„æ›´æ–°
   â–¡ 4c. ç°æœ‰åŠŸèƒ½æ­£å¸¸è¿è¡Œ
   â–¡ 4d. Swagger æ–‡æ¡£è·¯å¾„æ­£ç¡®

â–¡ 5. æµ‹è¯•éªŒè¯
   â–¡ 5a. å•å…ƒæµ‹è¯•é€šè¿‡
   â–¡ 5b. é›†æˆæµ‹è¯•é€šè¿‡
   â–¡ 5c. æ‰‹åŠ¨æµ‹è¯•é€šè¿‡
   â–¡ 5d. æ— å›å½’ bug
```

#### é˜¶æ®µ 1 æ£€æŸ¥æ¸…å•

```
â–¡ 1. Permission è¡¨åˆå§‹åŒ–
   â–¡ 1a. è¡¨ç»“æ„åˆ›å»ºæˆåŠŸ
   â–¡ 1b. 12+ æƒé™å®šä¹‰æ’å…¥
   â–¡ 1c. æƒé™åˆ†ç±»æ­£ç¡®ï¼ˆdocument/record/approval/systemï¼‰

â–¡ 2. UserPermission è¡¨åˆ›å»º
   â–¡ 2a. è¡¨ç»“æ„åˆ›å»ºæˆåŠŸ
   â–¡ 2b. ä¸ User è¡¨å…³è”æ­£å¸¸
   â–¡ 2c. å”¯ä¸€çº¦æŸç”Ÿæ•ˆ

â–¡ 3. æƒé™ç³»ç»Ÿå®ç°
   â–¡ 3a. RequirePermission è£…é¥°å™¨å¯ç”¨
   â–¡ 3b. PermissionGuard å®ˆå«æ­£å¸¸
   â–¡ 3c. ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™
   â–¡ 3d. æƒé™è¿‡æœŸæ£€æŸ¥æ­£å¸¸

â–¡ 4. æƒé™ç®¡ç† API
   â–¡ 4a. GET /api/v1/permissions è¿”å›æ‰€æœ‰æƒé™
   â–¡ 4b. POST /api/v1/permissions/grant æˆäºˆæƒé™
   â–¡ 4c. DELETE /api/v1/permissions/:id æ’¤é”€æƒé™
   â–¡ 4d. GET /api/v1/permissions/user/:userId æŸ¥è¯¢ç”¨æˆ·æƒé™

â–¡ 5. å‰ç«¯æƒé™ç®¡ç†ç•Œé¢
   â–¡ 5a. UserPermissions.vue é¡µé¢å¯ç”¨
   â–¡ 5b. æƒé™åˆ—è¡¨æ˜¾ç¤ºæ­£å¸¸
   â–¡ 5c. æˆäºˆæƒé™å¯¹è¯æ¡†å¯ç”¨
   â–¡ 5d. æ’¤é”€æƒé™åŠŸèƒ½æ­£å¸¸

â–¡ 6. ä¸šåŠ¡è§„åˆ™éªŒè¯
   â–¡ 6a. BR-017 è´¨é‡éƒ¨è·¨éƒ¨é—¨æŸ¥çœ‹è®°å½•
   â–¡ 6b. BR-018 å…¶ä»–éƒ¨é—¨åªèƒ½æŸ¥çœ‹æœ¬éƒ¨é—¨
   â–¡ 6c. BR-019 æƒé™æˆäºˆè®°å½•åŸå› 
   â–¡ 6d. BR-278 æƒé™å˜æ›´è®°å½•å®¡è®¡æ—¥å¿—

â–¡ 7. æµ‹è¯•éªŒè¯
   â–¡ 7a. æƒé™æ£€æŸ¥å•å…ƒæµ‹è¯•é€šè¿‡
   â–¡ 7b. API é›†æˆæµ‹è¯•é€šè¿‡
   â–¡ 7c. è·¨éƒ¨é—¨æƒé™åœºæ™¯æµ‹è¯•é€šè¿‡
   â–¡ 7d. æƒé™è¿‡æœŸæµ‹è¯•é€šè¿‡
```

#### é˜¶æ®µ 2 æ£€æŸ¥æ¸…å•

```
â–¡ 1. WorkflowTemplate è¡¨åˆ›å»º
   â–¡ 1a. è¡¨ç»“æ„åˆ›å»ºæˆåŠŸ
   â–¡ 1b. ä¸ Department è¡¨å…³è”æ­£å¸¸
   â–¡ 1c. steps JSON å­—æ®µå¯ç”¨

â–¡ 2. WorkflowInstance è¡¨åˆ›å»º
   â–¡ 2a. è¡¨ç»“æ„åˆ›å»ºæˆåŠŸ
   â–¡ 2b. ä¸ WorkflowTemplate å…³è”æ­£å¸¸
   â–¡ 2c. ç´¢å¼•åˆ›å»ºæˆåŠŸ

â–¡ 3. WorkflowTask è¡¨åˆ›å»º
   â–¡ 3a. è¡¨ç»“æ„åˆ›å»ºæˆåŠŸ
   â–¡ 3b. çº§è”åˆ é™¤é…ç½®æ­£å¸¸
   â–¡ 3c. ç´¢å¼•åˆ›å»ºæˆåŠŸ

â–¡ 4. å·¥ä½œæµå¼•æ“å®ç°
   â–¡ 4a. startWorkflow æ–¹æ³•å¯ç”¨
   â–¡ 4b. approveTask æ–¹æ³•å¯ç”¨
   â–¡ 4c. cancelWorkflow æ–¹æ³•å¯ç”¨
   â–¡ 4d. checkTimeouts æ–¹æ³•å¯ç”¨

â–¡ 5. å¹¶è¡Œå®¡æ‰¹é€»è¾‘
   â–¡ 5a. å¹¶è¡Œä»»åŠ¡åˆ›å»ºæ­£å¸¸
   â–¡ 5b. ä¸€äººæ‹’ç» â†’ æ‰€æœ‰ä»»åŠ¡å¤±æ•ˆ
   â–¡ 5c. æ‰€æœ‰äººé€šè¿‡ â†’ è¿›å…¥ä¸‹ä¸€æ­¥
   â–¡ 5d. å¹¶è¡Œç»„ ID æ­£ç¡®

â–¡ 6. è¶…æ—¶å‡çº§é€»è¾‘
   â–¡ 6a. å®šæ—¶ä»»åŠ¡æ­£å¸¸è¿è¡Œ
   â–¡ 6b. è¶…æ—¶ä»»åŠ¡æ ‡è®°æ­£ç¡®
   â–¡ 6c. è¶…æ—¶é€šçŸ¥å‘é€æˆåŠŸ
   â–¡ 6d. åŸå®¡æ‰¹äººä»å¯å®¡æ‰¹

â–¡ 7. å·¥ä½œæµå–æ¶ˆåŠŸèƒ½
   â–¡ 7a. å‘èµ·äººå¯å–æ¶ˆå·¥ä½œæµ
   â–¡ 7b. å¾…å¤„ç†ä»»åŠ¡æ ‡è®°ä¸º skipped
   â–¡ 7c. å–æ¶ˆåŸå› è®°å½•æ­£ç¡®

â–¡ 8. ä¸šåŠ¡è§„åˆ™éªŒè¯
   â–¡ 8a. BR-1.12 ä¸²è¡Œå’Œå¹¶è¡Œå®¡æ‰¹
   â–¡ 8b. BR-1.15 ~ BR-1.18 å¹¶è¡Œå®¡æ‰¹è§„åˆ™
   â–¡ 8c. BR-1.19 ~ BR-1.22 å®¡æ‰¹è¶…æ—¶è§„åˆ™
   â–¡ 8d. BR-1.26 å·¥ä½œæµå–æ¶ˆè§„åˆ™

â–¡ 9. æµ‹è¯•éªŒè¯
   â–¡ 9a. å·¥ä½œæµå¼•æ“å•å…ƒæµ‹è¯•é€šè¿‡
   â–¡ 9b. ä¸²è¡Œå®¡æ‰¹åœºæ™¯æµ‹è¯•é€šè¿‡
   â–¡ 9c. å¹¶è¡Œå®¡æ‰¹åœºæ™¯æµ‹è¯•é€šè¿‡
   â–¡ 9d. è¶…æ—¶å‡çº§åœºæ™¯æµ‹è¯•é€šè¿‡
   â–¡ 9e. å·¥ä½œæµå–æ¶ˆåœºæ™¯æµ‹è¯•é€šè¿‡
```

---

### 22.6 ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ |
|------|------|---------|
| 1.2 | 2026-02-13 | **è¡¥å…… P1-1/P1-2/P1-3 å®Œæ•´æŠ€æœ¯æ–¹æ¡ˆ**ï¼šæ•°æ®æ¨¡å‹ + API è®¾è®¡ + ä¸šåŠ¡è§„åˆ™ï¼ˆBR-346 ~ BR-359ï¼Œå…± 14 æ¡ï¼‰+ å‰ç«¯ç•Œé¢è®¾è®¡ + Vue 3 ä»£ç ç¤ºä¾‹ + å®Œæ•´å®æ–½æ£€æŸ¥æ¸…å• |
| 1.1 | 2026-02-13 | è°ƒæ•´å®æ–½ç­–ç•¥ï¼Œæ˜ç¡®"æŠ€æœ¯å€ºåŠ¡ä¼˜å…ˆäºæ–°éœ€æ±‚"åŸåˆ™ï¼Œæ–°å¢å®æ–½æ£€æŸ¥æ¸…å• |
| 1.0 | 2026-02-13 | åˆå§‹ç‰ˆæœ¬ï¼Œè®°å½• 3 ä¸ª P1 é—®é¢˜å’Œ 1 ä¸ª P2 é—®é¢˜ |

---

**æœ¬ç« èŠ‚å®Œæˆ âœ…**
