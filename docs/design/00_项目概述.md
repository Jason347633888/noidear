# 00 - 项目概述

> **来源**: DESIGN.md 第 1-500 行
> **版本**: v10.7
> **最后更新**: 2026-02-13

---

## 📋 基本信息

| 项目 | 内容 |
|------|------|
| **项目名称** | 文档管理系统 |
| **核心定位** | 企业级三级文档管理与四级配方填报系统 |
| **行业标准** | BRCGS（食品安全全球标准） |
| **当前版本** | v10.7 |
| **文档行数** | ~20,000 行（已拆分为 35 个模块文件） |

---

## 🚀 MVP 实现状态

### 完成度统计

- ✅ **已实现**: 51 个功能点（**98.1%**）
- ⏳ **未完成**: 1 个功能点（1.9%）- **回收站UI**

### Phase 1-6 核心功能实现状态

| Phase | 模块 | 功能点 | 实现状态 | 代码位置 |
|-------|------|--------|---------|---------|
| **Phase 1** | **用户管理** | 用户CRUD | ✅ 已实现 | `server/src/modules/user/`<br>`client/src/views/user/` |
| Phase 1 | 用户管理 | 组织架构 | ✅ 已实现 | `server/src/modules/department/`<br>`client/src/views/department/` |
| **Phase 2** | **文档管理** | 三级文档CRUD | ✅ 已实现 | `server/src/modules/document/`<br>`client/src/views/document/` |
| Phase 2 | 文档管理 | 文件上传（MinIO） | ✅ 已实现 | `server/src/modules/file/` |
| Phase 2 | 文档管理 | 版本控制 | ✅ 已实现 | `Document.version` 字段 |
| Phase 2 | 文档管理 | 文档预览（PDF） | ✅ 已实现 | `client/src/components/PdfViewer.vue` |
| **Phase 3** | **审批流程** | 单级审批 | ✅ 已实现 | `server/src/modules/approval/`<br>`client/src/views/approval/` |
| Phase 3 | 审批流程 | 审批记录 | ✅ 已实现 | `Approval` 表 |
| **Phase 4** | **模板管理** | 四级模板CRUD | ✅ 已实现 | `server/src/modules/template/`<br>`client/src/views/template/` |
| Phase 4 | 模板管理 | 字段类型支持 | ✅ 已实现 | 20+ 字段类型 |
| **Phase 5** | **任务管理** | 任务派发 | ✅ 已实现 | `server/src/modules/task/`<br>`client/src/views/task/` |
| Phase 5 | 任务管理 | 任务填报 | ✅ 已实现 | 动态表单填写 |
| **Phase 6** | **通知系统** | 站内消息 | ✅ 已实现 | `server/src/modules/notification/`<br>`client/src/views/notification/` |
| Phase 6 | 通知系统 | 消息已读/未读 | ✅ 已实现 | `Notification.read` 字段 |
| **Phase 7** | **偏离检测** | 公差配置 | ✅ 已实现 | `TemplateField.tolerance` |
| Phase 7 | 偏离检测 | 自动偏离检测 | ✅ 已实现 | 填报时自动检测 |
| Phase 7 | 偏离检测 | 偏离报告生成 | ✅ 已实现 | `DeviationReport` 表 |
| **Phase 9** | **数据导出** | Excel 批量导出 | ✅ 已实现 | `server/src/modules/export/` |
| Phase 9 | 数据导出 | 动态列支持 | ✅ 已实现 | ExcelJS 生成 |
| **Phase 12** | **偏离统计** | 偏离趋势分析 | ✅ 已实现 | `client/src/views/statistics/` |
| Phase 12 | 偏离统计 | 字段分布统计 | ✅ 已实现 | 饼图展示 |
| Phase 12 | 偏离统计 | 部门偏离率 | ✅ 已实现 | 柱状图对比 |
| **其他** | **回收站** | 软删除功能 | ✅ 已实现 | `deleted_at` 字段 |
| 其他 | 回收站 | 回收站UI | ⏳ **未完成** | - |

### Phase 8/10/11 设计完成但未实施

- Phase 8: 偏离检测（部分已实现）
- Phase 10: 二级审批流程（PRD 已完成，见 [04_审批流程.md](./mvp/04_审批流程.md)）
- Phase 11: 文件预览（PDF 已实现，Word/Excel 待完善）

---

## 📦 技术栈总结

| 层级 | 技术 | 版本 | 已配置 |
|------|------|------|--------|
| **前端** | Vue 3 | 3.4+ | ✅ |
| 前端 | Element Plus | 2.5+ | ✅ |
| 前端 | TypeScript | 5.0+ | ✅ |
| 前端 | Vite | 5.0+ | ✅ |
| 前端 | Pinia | 2.1+ | ✅ |
| 前端 | ECharts | 6.0+ | ✅ 偏离统计图表 |
| 前端 | sortablejs | 1.15+ | ✅ 拖拽排序 |
| **后端** | Node.js | 18+ | ✅ |
| 后端 | NestJS | 10+ | ✅ |
| 后端 | TypeScript | 5.3+ | ✅ |
| 后端 | Prisma | 5.7+ | ✅ |
| 后端 | ExcelJS | 4.4+ | ✅ 数据导出 |
| 后端 | bcrypt | 5.1+ | ✅ 密码加密 |
| 后端 | jsonwebtoken | 9.0+ | ✅ JWT 认证 |
| 后端 | @nestjs/swagger | 7.1+ | ✅ API 文档 |
| 后端 | helmet | 8.1+ | ✅ 安全头 |
| **数据库** | PostgreSQL | 15+ | ✅ Docker |
| 数据库 | Redis | 7+ | ✅ Docker |
| **存储** | MinIO | 8.0+ | ✅ Docker S3兼容 |
| **测试** | Jest | - | ✅ 164 tests, 85.3% coverage |
| **部署** | Docker | - | ✅ docker-compose.yml |

### 关键配置文件

- ✅ `server/src/prisma/schema.prisma` - 完整数据模型
- ✅ `server/.env` - 环境变量配置
- ✅ `docker-compose.yml` - PostgreSQL + Redis + MinIO
- ✅ `client/vite.config.ts` - 前端构建配置
- ✅ `server/tsconfig.json` - 后端 TypeScript 配置

---

## 🏗️ 系统分层架构（自底向上）

```
┌─────────────────────────────────────────────────────────────────┐
│ Layer 4: 移动端与运维层                                          │
│  - 移动端应用（uniapp）                                          │
│  - 系统运维监控（Prometheus + Grafana）                         │
│  - 审计日志与合规                                                │
└─────────────────────────────────────────────────────────────────┘
                              ▲
                              │ 依赖
┌─────────────────────────────────────────────────────────────────┐
│ Layer 3: 体系管理模块                                            │
│  - 培训管理（依赖：动态表单 + 工作流 + 待办）                   │
│  - 内审管理（依赖：动态表单 + 工作流 + 文档引擎）               │
│  - 供应商管理（依赖：权限系统 + 待办）                          │
└─────────────────────────────────────────────────────────────────┘
                              ▲
                              │ 依赖
┌─────────────────────────────────────────────────────────────────┐
│ Layer 2: 核心生产流程                                            │
│  - 批次追溯系统（依赖：动态表单）                               │
│  - 仓库管理（依赖：批次追溯 + 工作流 + 动态表单）               │
│  - 设备管理（依赖：动态表单 + 待办）                            │
└─────────────────────────────────────────────────────────────────┘
                              ▲
                              │ 依赖
┌─────────────────────────────────────────────────────────────────┐
│ Layer 1: 通用引擎层 ⭐ 核心能力层                               │
│  - 动态表单引擎（20+ 字段类型，完整定义）                      │
│  - 工作流引擎（审批流程，超时升级，完整定义）                  │
│  - 智能文档引擎（文档引用，自动同步）                          │
│  - 待办任务系统（统一待办，优先级管理）                        │
└─────────────────────────────────────────────────────────────────┘
                              ▲
                              │ 依赖
┌─────────────────────────────────────────────────────────────────┐
│ Layer 0: 数据基础设施层                                          │
│  - 用户与组织架构（User + Department）                          │
│  - 权限管理系统（Permission + RBAC）                            │
│  - 文档分级体系（Document 1-4 级）                              │
│  - 编号规则引擎（NumberRule）                                   │
│  - 文件存储（MinIO）                                             │
└─────────────────────────────────────────────────────────────────┘
```

### 分层架构说明

| 层级 | 名称 | 核心职责 | 关键模块 |
|------|------|----------|----------|
| **Layer 0** | 数据基础设施层 | 用户、权限、文档体系、存储 | User, Department, Permission, Document, MinIO |
| **Layer 1** | 通用引擎层 | 工作流、动态表单、文档引擎、待办 | WorkflowEngine, FormEngine, DocumentEngine, TodoTask |
| **Layer 2** | 核心生产流程 | 批次追溯、仓库、设备管理 | BatchTraceability, Warehouse, Equipment |
| **Layer 3** | 体系管理模块 | 培训、内审、供应商管理 | Training, Audit, Supplier |
| **Layer 4** | 移动端与运维 | 移动应用、监控、审计 | UniApp, Prometheus, AuditLog |

---

## 📝 业务规则总览

本系统共定义 **113 条业务规则**（BR-1.1 ~ BR-359），分布在各层级模块中：

| 规则类别 | 数量 | 文件链接 |
|---------|------|---------|
| **MVP 核心规则** | 100 条 | [BR_MVP.md](./mvp/BR_MVP.md) |
| **Layer 0 规则** | 30 条 | [BR_Layer0.md](./layer0_核心架构/BR_Layer0.md) |
| **Layer 1 规则** | 50 条 | [BR_Layer1.md](./layer1_核心生产/BR_Layer1.md) |
| **Layer 2 规则** | 50 条 | [BR_Layer2.md](./layer2_体系管理/BR_Layer2.md) |
| **Layer 3 规则** | 30 条 | [BR_Layer3.md](./layer3_移动端/BR_Layer3.md) |
| **Layer 4 规则** | 30 条 | [BR_Layer4.md](./layer4_运维/BR_Layer4.md) |
| **高级功能规则** | 37 条 | [BR_Advanced.md](./advanced/BR_Advanced.md) |

快速索引所有业务规则：[业务规则索引.md](./appendix/业务规则索引.md)

---

## 🔥 技术债务状态

### P1 技术债务（3 个，完整方案已完成）

| 编号 | 问题 | 估时 | 方案状态 | 文件链接 |
|------|------|------|---------|---------|
| **P1-1** | 文档归档/作废功能缺失 | 2-3h | ✅ 完整方案 | [P1-1_文档归档作废.md](./technical_debt/P1-1_文档归档作废.md) |
| **P1-2** | 细粒度权限系统缺失 | 8-16h | ✅ 完整方案 | [P1-2_细粒度权限.md](./technical_debt/P1-2_细粒度权限.md) |
| **P1-3** | 工作流引擎需简化 | 24-40h | ✅ 完整方案 | [P1-3_简化工作流.md](./technical_debt/P1-3_简化工作流.md) |

**重要说明**: 以上 P1 技术债务的完整技术方案已在 v10.7 补充完成，包含：
- 数据模型（Prisma Schema）
- API 接口定义（RESTful + TypeScript 类型）
- 业务规则（BR-346 ~ BR-359）
- 前端界面设计（Element Plus 组件使用）
- 代码示例

### v10.0 修复的 8 个 P0 问题

| 问题 | 描述 | 状态 |
|------|------|------|
| **P0-1** | 工作流与偏离检测集成接口不明确 | ✅ 已定义完整 JSON 配置示例 |
| **P0-2** | 批次追溯外键约束策略混乱 | ✅ 统一 onDelete: Restrict |
| **P0-3** | 权限管理无细粒度控制 | ✅ 定义 RBAC + 资源级权限 |
| **P0-4** | 审批超时升级机制不完整 | ✅ 定义自动转交 + 多级升级 |
| **P0-5** | 记录保留期限缺乏执行机制 | ✅ 定义定时任务 + 归档策略 |
| **P0-6** | 供应商资质到期缺乏自动处理 | ✅ 定义每日检查 + 在途订单处理 |
| **P0-7** | 动态表单与硬编码字段冲突 | ✅ 明确核心字段 vs 扩展字段 |
| **P0-8** | 文档引用循环依赖风险 | ✅ 限制引用深度 + 异步队列 |

---

## 🔄 增量开发指导

> **核心原则**: 所有新功能必须与现有 MVP 代码库无缝集成，不破坏已有功能，遵循现有架构和技术栈。

### ✅ 新功能开发前检查（强制）

**1. 技术栈兼容性检查**
```
□ 是否使用文档中列出的技术栈？（不引入新库）
□ 前端是否使用 Vue 3 + Element Plus？
□ 后端是否使用 NestJS + Prisma？
□ 是否复用现有组件/服务？（检查 client/src/components/ 和 server/src/modules/）
```

**2. 数据模型兼容性检查**
```
□ 新增表是否符合 Prisma Schema 规范？
□ 是否复用现有表关系？（如 User、Department、Document）
□ 外键约束是否设置正确？（onDelete: Restrict / Cascade）
□ 是否添加 created_at、updated_at、deleted_at？（软删除支持）
□ 字段命名是否符合现有风格？（snake_case）
```

**3. API 设计兼容性检查**
```
□ 路由是否符合 RESTful 规范？
□ 是否复用现有鉴权中间件？（@UseGuards(JwtAuthGuard)）
□ 是否复用现有权限装饰器？（@RequirePermissions(...)）
□ 响应格式是否统一？（{ success, data, error, meta }）
□ 错误处理是否使用 try-catch？
```

**4. 前端集成检查**
```
□ 页面路由是否添加到 client/src/router/index.ts？
□ 菜单是否添加到侧边栏配置？
□ 是否复用现有 API 请求封装？（client/src/api/request.ts）
□ 是否使用 Element Plus 组件？（不引入新 UI 库）
□ 状态管理是否使用 Pinia？（不引入 Vuex）
```

**5. 测试覆盖检查**
```
□ 是否编写单元测试？（server/test/）
□ 测试覆盖率是否 ≥ 80%？
□ 是否测试核心业务逻辑？
□ 是否测试异常情况？
```

---

## 🔗 相关文档导航

| 文档类型 | 文件路径 | 说明 |
|---------|---------|------|
| **分层架构** | [README.md](./README.md) | 完整文件导航 |
| **MVP 功能** | [mvp/](./mvp/) | 已完成的 Phase 1-6 功能详细设计 |
| **核心架构** | [layer0_核心架构/](./layer0_核心架构/) | Layer 0 动态表单引擎 + 批次追溯 |
| **核心生产** | [layer1_核心生产/](./layer1_核心生产/) | Layer 1 仓库 + 设备管理 |
| **体系管理** | [layer2_体系管理/](./layer2_体系管理/) | Layer 2 培训 + 内审 |
| **移动端** | [layer3_移动端/](./layer3_移动端/) | Layer 3 移动应用 |
| **运维** | [layer4_运维/](./layer4_运维/) | Layer 4 监控 + 审计 |
| **技术债务** | [technical_debt/](./technical_debt/) | P1-1/P1-2/P1-3 完整方案 |
| **附录** | [appendix/](./appendix/) | 数据模型 + API + UI 汇总 |
| **TodoList** | [../tasks/tasks/README.md](../tasks/tasks/README.md) | Issue 级别实施计划 |
| **交互设计** | [../../INTERACTION_DESIGN.md](../../INTERACTION_DESIGN.md) | 前端 UI/UX 规范 |

---

**文档版本**: v10.7
**最后更新**: 2026-02-13
**下一步**: 阅读 [README.md](./README.md) 了解完整文件导航
