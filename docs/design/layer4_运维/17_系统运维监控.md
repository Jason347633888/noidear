# 系统运维与监控（Layer 4 运维）

> **来源**: DESIGN.md 第二十一章（系统运维与监控设计）  
> **文档版本**: 1.0  
> **最后更新**: 2026-02-14  
> **实现状态**: ⏳ 未实现（PRD + LLD 已完成）  
> **优先级**: ⭐⭐⭐ 最高（Phase A 基础设施）  
> **依赖**: 无（独立模块）

---

## 目录

- [1. 数据备份与恢复设计](#1-数据备份与恢复设计)
- [2. 系统监控设计](#2-系统监控设计)
- [3. 部署架构设计](#3-部署架构设计)
- [4. 安全审计日志设计](#4-安全审计日志设计)
- [5. 业务规则（BR-261 ~ BR-272）](#5-业务规则br-261--br-272)

---

## 1. 数据备份与恢复设计

### 1.1 备份策略总览

| 备份对象 | 备份方式 | 备份频率 | 保留时长 | RPO | RTO |
|---------|---------|---------|---------|-----|-----|
| PostgreSQL | pg_dump 全量 | 每天凌晨 2:00 | 7 天 | 24h | 2h |
| MinIO 文件 | mc mirror | 每天凌晨 3:00 | 7 天 | 24h | 2h |
| Redis | RDB 快照 | 每天凌晨 1:00 | 3 天 | 24h | 1h |
| 应用配置 | Git 版本控制 | 实时 | 永久 | 0 | 10min |

**RPO（Recovery Point Objective）**: 数据恢复点目标，最多丢失 24 小时数据  
**RTO（Recovery Time Objective）**: 恢复时间目标，2 小时内恢复系统

---

### 1.2 PostgreSQL 备份方案

**方案：pg_dump + 定时任务 + 本地存储**

#### Docker Compose 配置

```yaml
# docker-compose.yml 新增备份服务
services:
  postgres-backup:
    image: postgres:15
    container_name: doc_postgres_backup
    restart: unless-stopped
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_DB=document_system
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - ./backups/postgres:/backups
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        echo "等待 PostgreSQL 启动..."
        sleep 30
        echo "开始备份循环..."
        while true; do
          timestamp=$(date +%Y%m%d_%H%M%S)
          echo "[$(date)] 开始备份数据库..."
          PGPASSWORD=${POSTGRES_PASSWORD} pg_dump \
            -h postgres \
            -U ${POSTGRES_USER} \
            -d document_system \
            --format=custom \
            --compress=9 \
            > /backups/backup_$timestamp.dump

          if [ $? -eq 0 ]; then
            echo "[$(date)] 备份成功: backup_$timestamp.dump"
          else
            echo "[$(date)] 备份失败!"
          fi

          # 只保留最近 7 天的备份
          find /backups -name "backup_*.dump" -mtime +7 -delete
          echo "[$(date)] 清理旧备份完成"

          # 等待 24 小时
          sleep 86400
        done
    depends_on:
      - postgres
```

#### 手动备份命令

```bash
# 立即执行备份
docker exec doc_postgres_backup bash -c 'PGPASSWORD=${POSTGRES_PASSWORD} pg_dump -h postgres -U ${POSTGRES_USER} -d document_system --format=custom > /backups/manual_$(date +%Y%m%d_%H%M%S).dump'

# 验证备份文件
ls -lh backups/postgres/
```

#### 恢复命令

```bash
# 1. 停止应用服务
docker-compose stop server

# 2. 恢复数据库
docker exec -i doc_postgres pg_restore \
  -U postgres \
  -d document_system \
  --clean \
  --if-exists \
  < backups/postgres/backup_20260212_020000.dump

# 3. 重启应用
docker-compose start server
```

---

### 1.3 MinIO 文件备份方案

**方案：mc mirror + 定时任务**

#### Docker Compose 配置

```yaml
services:
  minio-backup:
    image: minio/mc:latest
    container_name: doc_minio_backup
    restart: unless-stopped
    volumes:
      - ./backups/minio:/backups
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "等待 MinIO 启动..."
        sleep 30

        echo "配置 mc 别名..."
        mc alias set local http://minio:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD}

        echo "开始备份循环..."
        while true; do
          timestamp=$(date +%Y%m%d_%H%M%S)
          echo "[$(date)] 开始备份 MinIO 文件..."

          # 镜像备份所有桶
          mc mirror local/documents /backups/$timestamp/documents
          mc mirror local/templates /backups/$timestamp/templates
          mc mirror local/audit-archive /backups/$timestamp/audit-archive

          if [ $? -eq 0 ]; then
            echo "[$(date)] 备份成功: $timestamp"
          else
            echo "[$(date)] 备份失败!"
          fi

          # 只保留最近 7 天
          find /backups -maxdepth 1 -type d -mtime +7 -exec rm -rf {} \;
          echo "[$(date)] 清理旧备份完成"

          # 等待 24 小时
          sleep 86400
        done
    depends_on:
      - minio
```

#### 手动备份与恢复

```bash
# 立即备份
docker exec doc_minio_backup mc mirror local/documents /backups/$(date +%Y%m%d)/documents

# 验证备份
ls -lh backups/minio/

# 恢复指定日期的文件
docker exec doc_minio_backup mc mirror /backups/20260212/documents local/documents
```

---

### 1.4 灾难恢复演练

**每月演练内容**：

#### 模拟数据库损坏

```bash
# 备份当前数据
docker exec doc_postgres pg_dump -U postgres document_system > /tmp/before_test.sql

# 删除测试表
docker exec -it doc_postgres psql -U postgres -d document_system \
  -c "DROP TABLE documents;"

# 从备份恢复
docker exec -i doc_postgres pg_restore -U postgres -d document_system \
  < backups/postgres/backup_latest.dump

# 验证数据完整性
docker exec -it doc_postgres psql -U postgres -d document_system \
  -c "SELECT COUNT(*) FROM documents;"
```

#### 完整系统恢复

- **目标**: 2 小时内完成
- **步骤**: 停止服务 → 恢复数据库 → 恢复文件 → 恢复配置 → 启动服务 → 验证功能

---

## 2. 系统监控设计

### 2.1 监控架构

```
┌─────────────────────────────────────────────────────────────┐
│                     监控与日志架构                            │
└─────────────────────────────────────────────────────────────┘

应用层
  ├── NestJS (metrics 端点 /metrics)
  │     └── @willsoto/nestjs-prometheus
  │
  ├── Docker 容器日志
  │     └── JSON 格式日志输出
  │
  └── PostgreSQL 慢查询日志

           ↓

采集层
  ├── Prometheus (指标采集)
  │     └── 抓取 /metrics 端点
  │
  └── Promtail (日志采集)
        └── 读取 Docker 日志

           ↓

存储层
  ├── Prometheus TSDB (30天)
  └── Loki (日志存储，30天)

           ↓

可视化层
  └── Grafana
        ├── 系统仪表板
        ├── 应用仪表板
        ├── 业务仪表板
        └── 日志查询界面

           ↓

告警层
  └── Alertmanager
        ├── 企业微信
        ├── 邮件
        └── 钉钉
```

---

### 2.2 监控指标清单

#### 系统指标（自动采集）

| 指标 | 说明 | 告警阈值 |
|------|------|---------|
| `node_cpu_seconds_total` | CPU 使用时间 | > 80% 持续 5min |
| `node_memory_MemAvailable_bytes` | 可用内存 | < 512MB |
| `node_disk_io_time_seconds_total` | 磁盘 I/O 时间 | > 90% 持续 5min |
| `node_filesystem_avail_bytes` | 磁盘可用空间 | < 10% |

#### 应用指标（NestJS）

| 指标 | 说明 | 告警阈值 |
|------|------|---------|
| `doc_system_http_requests_total` | HTTP 请求总数 | 监控 QPS |
| `doc_system_http_request_duration_seconds` | 请求响应时间 | P99 > 2s |
| `doc_system_http_errors_total{status="5xx"}` | 服务端错误数 | 错误率 > 5% |
| `doc_system_db_query_duration_seconds` | 数据库查询耗时 | P99 > 1s |

#### 业务指标（自定义）

| 指标 | 说明 | 告警阈值 |
|------|------|---------|
| `doc_system_document_uploads_total` | 文档上传次数 | 监控趋势 |
| `doc_system_approval_duration_seconds` | 审批耗时 | P99 > 24h |
| `doc_system_active_users` | 在线用户数 | 监控峰值 |
| `doc_system_login_failures_total` | 登录失败次数 | > 10/min（暴力破解） |

---

### 2.3 NestJS 集成 Prometheus

#### 安装依赖

```bash
cd server
npm install @willsoto/nestjs-prometheus prom-client
```

#### 配置 app.module.ts

```typescript
import { Module } from '@nestjs/common';
import { PrometheusModule } from '@willsoto/nestjs-prometheus';

@Module({
  imports: [
    PrometheusModule.register({
      defaultMetrics: {
        enabled: true,
        config: {
          prefix: 'doc_system_',
        },
      },
      path: '/metrics',
      defaultLabels: {
        app: 'document-system',
        environment: process.env.NODE_ENV || 'development',
      },
    }),
    // ... 其他模块
  ],
})
export class AppModule {}
```

#### 自定义业务指标

```typescript
// monitoring/metrics.service.ts
import { Injectable } from '@nestjs/common';
import { Counter, Histogram, Gauge } from 'prom-client';
import { InjectMetric } from '@willsoto/nestjs-prometheus';

@Injectable()
export class MetricsService {
  constructor(
    @InjectMetric('doc_system_document_uploads_total')
    public documentUploadsCounter: Counter<string>,

    @InjectMetric('doc_system_approval_duration_seconds')
    public approvalDurationHistogram: Histogram<string>,

    @InjectMetric('doc_system_active_users')
    public activeUsersGauge: Gauge<string>,
  ) {}

  // 记录文档上传
  recordDocumentUpload(level: string, department: string) {
    this.documentUploadsCounter.labels(level, department).inc();
  }

  // 记录审批耗时
  recordApprovalDuration(duration: number, result: 'approved' | 'rejected') {
    this.approvalDurationHistogram.labels(result).observe(duration);
  }

  // 更新在线用户数
  updateActiveUsers(count: number) {
    this.activeUsersGauge.set(count);
  }
}
```

---

### 2.4 告警规则

#### monitoring/alerts/app-alerts.yml

```yaml
groups:
  - name: application_alerts
    interval: 30s
    rules:
      # HTTP 错误率过高
      - alert: HighHTTPErrorRate
        expr: |
          rate(doc_system_http_errors_total{status=~"5.."}[5m])
          /
          rate(doc_system_http_requests_total[5m]) > 0.05
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "HTTP 5xx 错误率过高"
          description: "最近 5 分钟错误率: {{ $value | humanizePercentage }}"

      # API 响应慢
      - alert: SlowAPIResponse
        expr: |
          histogram_quantile(0.99,
            rate(doc_system_http_request_duration_seconds_bucket[5m])
          ) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "API 响应时间过长"
          description: "P99 响应时间: {{ $value | humanizeDuration }}"

      # 登录失败次数异常（疑似暴力破解）
      - alert: SuspiciousBruteForce
        expr: |
          rate(doc_system_login_failures_total[1m]) > 10
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "检测到疑似暴力破解攻击"
          description: "1 分钟内登录失败 {{ $value }} 次"

  - name: system_alerts
    interval: 30s
    rules:
      # CPU 使用率高
      - alert: HighCPUUsage
        expr: |
          100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "CPU 使用率过高"
          description: "CPU 使用率: {{ $value | humanize }}%"

      # 内存不足
      - alert: LowMemory
        expr: |
          node_memory_MemAvailable_bytes < 512 * 1024 * 1024
        for: 3m
        labels:
          severity: critical
        annotations:
          summary: "可用内存不足"
          description: "剩余内存: {{ $value | humanize1024 }}B"

      # 服务宕机
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "服务 {{ $labels.job }} 宕机"
          description: "服务已停止响应超过 1 分钟"
```

---

## 3. 部署架构设计

### 3.1 MVP 阶段部署架构

**单节点 Docker Compose 架构**：

```
┌──────────────────────────────────────────────────────────┐
│               单服务器 (4C8G / 8C16G)                      │
├──────────────────────────────────────────────────────────┤
│                                                            │
│  ┌─────────────┐                                          │
│  │   Nginx     │  ← 反向代理 + 静态文件                    │
│  │   :80/:443  │                                          │
│  └──────┬──────┘                                          │
│         │                                                  │
│  ┌──────▼──────┐     ┌─────────────┐                     │
│  │  NestJS     │────▶│ PostgreSQL  │                     │
│  │  :3000      │     │  :5432      │                     │
│  └──────┬──────┘     └─────────────┘                     │
│         │                                                  │
│         ├────────────▶ Redis :6379                        │
│         │                                                  │
│         └────────────▶ MinIO :9000                        │
│                                                            │
│  ┌─────────────────────────────────────┐                 │
│  │          监控栈                       │                 │
│  │  Prometheus + Grafana + Loki         │                 │
│  └─────────────────────────────────────┘                 │
│                                                            │
│  ┌─────────────────────────────────────┐                 │
│  │          备份服务                     │                 │
│  │  PostgreSQL Backup + MinIO Backup    │                 │
│  └─────────────────────────────────────┘                 │
│                                                            │
└──────────────────────────────────────────────────────────┘
```

#### 服务器配置要求

| 阶段 | CPU | 内存 | 磁盘 | 并发用户 |
|------|-----|------|------|----------|
| 开发/测试 | 2C | 4G | 50GB SSD | 10 |
| MVP 生产 | 4C | 8G | 100GB SSD | 100 |
| 扩展 | 8C | 16G | 200GB SSD | 500 |

---

### 3.2 部署命令

#### 初始化部署

```bash
# 1. 克隆代码
git clone <repository-url>
cd noidear

# 2. 配置环境变量
cp .env.example .env.production
vi .env.production  # 修改密码和配置

# 3. 构建前端
cd client
npm install
npm run build

# 4. 启动所有服务
cd ..
docker-compose -f docker-compose.prod.yml up -d

# 5. 初始化数据库
docker exec doc_server npx prisma migrate deploy
docker exec doc_server npx prisma db seed

# 6. 验证服务状态
docker-compose -f docker-compose.prod.yml ps
```

#### 日常运维

```bash
# 查看日志
docker-compose -f docker-compose.prod.yml logs -f server

# 重启服务
docker-compose -f docker-compose.prod.yml restart server

# 更新代码
git pull
docker-compose -f docker-compose.prod.yml build server
docker-compose -f docker-compose.prod.yml up -d server

# 备份数据（手动触发）
docker exec doc_postgres_backup bash -c '<备份命令>'

# 查看资源使用
docker stats
```

---

### 3.3 高可用方案（未来扩展）

**Phase 2: 高可用架构**（生产规模）：

```
┌────────────────────────────────────────────────────────┐
│                  负载均衡器                              │
│            Nginx + Keepalived (主备)                    │
└───────────┬──────────────┬─────────────────────────────┘
            │              │
    ┌───────▼──┐      ┌───▼────────┐      ┌────────────┐
    │ NestJS 1 │      │ NestJS 2   │      │ NestJS 3   │
    └───────┬──┘      └───┬────────┘      └──────┬─────┘
            │             │                       │
            └─────────────┼───────────────────────┘
                          │
          ┌───────────────┼───────────────────────┐
          │               │                       │
   ┌──────▼─────┐  ┌─────▼──────┐  ┌────────────▼────┐
   │ PostgreSQL │  │   Redis    │  │  MinIO Cluster  │
   │  主 + 从    │  │  Sentinel  │  │    (4 节点)      │
   └────────────┘  └────────────┘  └─────────────────┘
```

#### 扩展方案

| 组件 | MVP | 高可用方案 |
|------|-----|-----------|
| NestJS | 单实例 | 3+ 实例 + 负载均衡 |
| PostgreSQL | 单节点 | 主从复制（Patroni + etcd） |
| Redis | 单节点 | Sentinel（1主2从） |
| MinIO | 单节点 | 分布式集群（4节点，纠删码） |
| Nginx | 单实例 | Keepalived 双机热备 |

---

## 4. 安全审计日志设计

### 4.1 审计日志分类

| 日志类型 | 内容 | 保留时长 | 重要性 | BRCGS 要求 |
|---------|------|---------|--------|-----------|
| **登录日志** | 用户登录/登出、IP、设备 | 90 天 | P0 | ✅ 3.5.4 |
| **权限变更日志** | 角色分配、权限修改 | 永久 | P0 | ✅ 3.5.3 |
| **敏感操作日志** | 文档删除、数据导出、审批 | 永久 | P0 | ✅ 3.5.2 |
| **操作日志** | 文档上传、编辑、查看 | 30 天 | P1 | - |
| **系统日志** | 应用启动、错误、异常 | 30 天 | P1 | - |

---

### 4.2 数据模型

```prisma
// ==================== 登录日志 ====================
model LoginLog {
  id          String   @id @default(cuid())
  userId      String?  // 登录失败时为 null
  username    String
  action      String   // "login" | "logout" | "login_failed"
  ipAddress   String
  userAgent   String
  location    String?  // IP 地理位置（可选）
  loginTime   DateTime @default(now())
  logoutTime  DateTime?
  status      String   // "success" | "failed"
  failReason  String?  // 失败原因

  @@index([userId])
  @@index([loginTime])
  @@index([ipAddress])
  @@index([status])
  @@map("login_logs")
}

// ==================== 权限变更日志 ====================
model PermissionLog {
  id              String   @id @default(cuid())
  operatorId      String   // 操作人 ID
  operatorName    String
  targetUserId    String   // 被操作用户 ID
  targetUsername  String
  action          String   // "assign_role" | "revoke_role" | "change_department"
  beforeValue     Json     // 变更前值
  afterValue      Json     // 变更后值
  reason          String?  // 变更原因
  approvedBy      String?  // 批准人 ID（如需要审批）
  approvedByName  String?
  ipAddress       String
  createdAt       DateTime @default(now())

  @@index([operatorId])
  @@index([targetUserId])
  @@index([action])
  @@index([createdAt])
  @@map("permission_logs")
}

// ==================== 敏感操作日志 ====================
model SensitiveLog {
  id            String   @id @default(cuid())
  userId        String
  username      String
  action        String   // "delete_document" | "export_data" | "approve" | "reject"
  resourceType  String   // "document" | "task" | "record" | "user"
  resourceId    String
  resourceName  String
  details       Json     // 详细信息
  ipAddress     String
  userAgent     String
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([resourceType])
  @@index([createdAt])
  @@map("sensitive_logs")
}
```

---

### 4.3 审计日志 API

```typescript
// ==================== 登录日志 API ====================
POST   /api/v1/audit/login-logs/query      // 查询登录日志
GET    /api/v1/audit/login-logs/export     // 导出登录日志
GET    /api/v1/audit/login-logs/stats      // 登录统计

// ==================== 权限变更日志 API ====================
POST   /api/v1/audit/permission-logs/query
GET    /api/v1/audit/permission-logs/export
GET    /api/v1/audit/permission-logs/:userId  // 查询某用户的权限变更历史

// ==================== 敏感操作日志 API ====================
POST   /api/v1/audit/sensitive-logs/query
GET    /api/v1/audit/sensitive-logs/export
GET    /api/v1/audit/sensitive-logs/stats    // 敏感操作统计

// ==================== 综合查询 API ====================
POST   /api/v1/audit/search                  // 跨日志类型搜索
GET    /api/v1/audit/dashboard                // 审计仪表板统计
GET    /api/v1/audit/timeline/:userId        // 用户操作时间线
```

---

### 4.4 自动记录拦截器

#### 敏感操作装饰器

```typescript
// audit/decorators/sensitive-log.decorator.ts
import { SetMetadata } from '@nestjs/common';

export const SENSITIVE_LOG_KEY = 'sensitive_log';

export const SensitiveLog = (action: string, resourceType: string) =>
  SetMetadata(SENSITIVE_LOG_KEY, { action, resourceType });
```

#### 使用示例

```typescript
// document.controller.ts
import { UseInterceptors } from '@nestjs/common';
import { SensitiveLog } from '@/audit/decorators/sensitive-log.decorator';
import { SensitiveLogInterceptor } from '@/audit/interceptors/sensitive-log.interceptor';

@Controller('documents')
@UseInterceptors(SensitiveLogInterceptor)
export class DocumentController {
  constructor(private documentService: DocumentService) {}

  // 删除文档 - 敏感操作
  @Delete(':id')
  @SensitiveLog('delete_document', 'document')
  async deleteDocument(@Param('id') id: string) {
    return this.documentService.delete(id);
  }

  // 批量导出数据 - 敏感操作
  @Post('export')
  @SensitiveLog('export_data', 'document')
  async exportDocuments(@Body() dto: ExportDto) {
    return this.documentService.export(dto);
  }

  // 审批通过 - 敏感操作
  @Post(':id/approve')
  @SensitiveLog('approve', 'document')
  async approveDocument(@Param('id') id: string) {
    return this.documentService.approve(id);
  }
}
```

---

### 4.5 BRCGS 审计报告生成

```typescript
// audit/audit-report.service.ts
@Injectable()
export class AuditReportService {
  constructor(private prisma: PrismaService) {}

  // 生成 BRCGS 审计报告
  async generateBRCGSReport(startDate: string, endDate: string) {
    const start = new Date(startDate);
    const end = new Date(endDate);

    // 1. 登录日志统计
    const loginStats = await this.prisma.loginLog.count({
      where: { loginTime: { gte: start, lte: end } },
    });

    const loginFailures = await this.prisma.loginLog.count({
      where: {
        loginTime: { gte: start, lte: end },
        status: 'failed',
      },
    });

    // 2. 权限变更记录
    const permissionChanges = await this.prisma.permissionLog.findMany({
      where: {
        createdAt: { gte: start, lte: end },
      },
      orderBy: { createdAt: 'desc' },
    });

    // 3. 敏感操作记录
    const sensitiveOps = await this.prisma.sensitiveLog.findMany({
      where: {
        createdAt: { gte: start, lte: end },
      },
      orderBy: { createdAt: 'desc' },
    });

    // 4. 记录修改历史
    const recordChanges = await this.prisma.recordChangeLog.findMany({
      where: {
        changedAt: { gte: start, lte: end },
      },
      orderBy: { changedAt: 'desc' },
    });

    return {
      period: { startDate, endDate },
      summary: {
        totalLogins: loginStats,
        loginFailures,
        loginFailureRate: (loginFailures / loginStats * 100).toFixed(2) + '%',
        permissionChanges: permissionChanges.length,
        sensitiveOperations: sensitiveOps.length,
        recordModifications: recordChanges.length,
      },
      brcgsCompliance: {
        '3.5.2': recordChanges.length > 0 ? '✅ 已记录所有记录修改' : '⚠️ 无记录修改',
        '3.5.3': permissionChanges.length >= 0 ? '✅ 已记录权限变更' : 'N/A',
        '3.5.4': loginStats > 0 ? '✅ 已记录所有登录' : 'N/A',
      },
    };
  }
}
```

---

## 5. 业务规则（BR-261 ~ BR-272）

| 规则编号 | 规则描述 | 实施方式 |
|---------|---------|---------|
| **BR-261** | PostgreSQL 每天自动备份，保留 7 天 | Docker 定时任务 |
| **BR-262** | MinIO 文件每天自动备份，保留 7 天 | mc mirror 定时任务 |
| **BR-263** | 系统 RPO 目标 24 小时，RTO 目标 2 小时 | 备份策略 + 恢复演练 |
| **BR-264** | Prometheus 指标保留 30 天 | Prometheus 配置 |
| **BR-265** | Loki 日志保留 30 天 | Loki 配置 |
| **BR-266** | API P99 响应时间 > 2秒 触发告警 | Prometheus 告警规则 |
| **BR-267** | HTTP 5xx 错误率 > 5% 触发告警 | Prometheus 告警规则 |
| **BR-268** | 登录失败次数 > 10次/分钟 触发告警（疑似暴力破解） | Prometheus 告警规则 |
| **BR-269** | 登录日志保留 90 天，权限变更/敏感操作永久保留 | 定时归档任务 |
| **BR-270** | 所有敏感操作必须记录审计日志 | SensitiveLog 拦截器 |
| **BR-271** | 每月执行一次灾难恢复演练 | 运维流程 |
| **BR-272** | 审计日志归档到 MinIO audit-archive 桶 | 定时任务 + MinIO |

---

**本文档完成 ✅**
