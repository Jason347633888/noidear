# 培训管理系统（Layer 2 体系管理）

> **来源**: DESIGN.md 第十五章（培训管理系统）  
> **文档版本**: 1.0  
> **最后更新**: 2026-02-14  
> **实现状态**: ⏳ 未实现（PRD + LLD 已完成）  
> **优先级**: ⭐⭐ 中等（Phase C 体系管理）  
> **依赖**: 动态表单引擎、v2.0 工作流引擎、移动端应用

---

## 目录

- [1. 系统定位](#1-系统定位)
- [2. 业务流程](#2-业务流程)
- [3. 数据模型](#3-数据模型)
- [4. 业务规则](#4-业务规则)

---

## 1. 系统定位

**培训系统作为独立业务模块**（不属于文档体系），负责企业人员培训计划、在线考试、培训档案管理。

### 1.1 核心优势

| 优势 | 说明 |
|------|------|
| **架构清晰** | 培训业务独立，不污染文档体系 |
| **灵活复用** | 培训资料引用任意级别文档（二级/三级/四级） |
| **统一待办** | TodoTask 支持培训、审批、设备维护等多种待办类型 |
| **可选归档** | 培训档案可选择性归档到文档系统 |
| **模块开关** | 可作为可选模块启用/禁用 |

### 1.2 核心职责

1. **年度培训计划**: 创建年度计划、配置培训项目、审批流程
2. **培训项目管理**: 培训资料引用、学员管理、讲师指定
3. **在线考试系统**: 选择题/判断题、自动评分、多次考试
4. **学习记录跟踪**: 考试成绩、通过状态、考试次数
5. **培训档案归档**: PDF 生成、自动归档到文档系统
6. **统一待办任务**: 培训待办、审批待办、设备待办等

---

## 2. 业务流程

### 2.1 核心流程

```
【年度培训计划管理】
Step 1: 创建年度培训计划
  ├── 输入: 年度、标题
  ├── 配置培训项目列表
  │   ├── 项目标题(如 "GMP 基础培训")
  │   ├── 部门(可选, null = 全员培训)
  │   ├── 季度(可选, null = 临时培训)
  │   ├── 培训讲师(默认部门主管)
  │   ├── 计划日期
  │   ├── 被培训人员(多选)
  │   ├── 培训资料(引用已有文档)
  │   └── 考试配置(及格分、考试次数)
  └── 提交审批

Step 2: 培训计划审批(v2.0.0 工作流引擎)
  ├── 发起审批流程(WorkflowInstance)
  ├── 审批人审批(WorkflowTask)
  └── 审批通过 / 驳回

Step 3: 审批通过后,自动生成待办任务(TodoTask)
  ├── 培训负责人待办:
  │   ├── 类型: training_organize
  │   ├── 标题: "组织'GMP 基础培训'(2024-Q1)"
  │   ├── 关联: TrainingProject.id
  │   └── 截止日期: 培训计划日期
  │
  └── 被培训员工待办:
      ├── 类型: training_attend
      ├── 标题: "参加'GMP 基础培训'并完成考试"
      ├── 关联: TrainingProject.id
      └── 截止日期: 培训计划日期

【培训执行】
Step 4: 员工查看待办任务
  ├── 进入"我的待办"页面
  ├── 查看待办类型: 培训、审批、设备维护等
  └── 点击培训待办 → 跳转到培训项目详情

Step 5: 员工学习培训资料
  ├── 查看培训项目信息
  ├── 下载/预览培训资料(引用的文档)
  └── 自主学习

Step 6: 员工参加在线考试
  ├── 点击"开始考试"
  ├── 显示题目(选择题 + 判断题)
  ├── 提交答案
  ├── 系统自动评分
  └── 显示考试结果
      ├── 通过(≥ 及格分) → 完成培训 → 待办任务标记为 completed
      └── 不通过(< 及格分) → 显示剩余考试次数 → 可重新考试

Step 7: 培训项目完成(所有学员考试完毕)
  ├── 系统判断: 所有 LearningRecord.passed = true
  ├── 自动生成培训档案 PDF
  │   ├── 培训计划信息
  │   ├── 参训人员名单
  │   ├── 考试成绩汇总
  │   └── 培训资料清单
  ├── 上传 PDF 到 MinIO
  └── 自动归档到文档系统(创建四级文件)
      ├── 文档编号: REC-TRAIN-{YYYY}-{序号}(自动生成)
      ├── 文档标题: {培训标题}-{日期}
      ├── 文档类型: 培训记录(固定)
      ├── 归属部门: 继承培训项目的 department
      └── 文件 URL: MinIO 路径

【培训计划调整】
Step 8: 修改培训计划(增删项目)
  ├── 新增项目 / 删除项目 / 修改项目
  ├── 计划状态 → pending_approval(重新审批)
  ├── 提交审批
  └── 审批通过后
      ├── 删除旧的待办任务(所有关联的 TodoTask)
      └── 重新生成待办任务(根据新的项目列表)

Step 9: 修改学员名单(不需要审批)
  ├── 新增学员 → 自动生成待办任务
  ├── 删除学员 → 自动删除待办任务
  └── 无需重新审批
```

---

## 3. 数据模型

### 3.1 统一待办任务表（TodoTask）

**设计说明**:
- 统一的待办任务系统，支持多种业务类型
- 培训待办、审批待办、设备待办等共用此表
- 通过 `type` 字段区分待办类型
- 通过 `relatedId` 字段关联不同业务实体

```prisma
model TodoTask {
  id          String   @id @default(cuid())
  userId      String   // 待办人
  type        String   // 待办类型
                       // - training_organize: 培训负责人 - 组织培训
                       // - training_attend: 被培训员工 - 参加培训并考试
                       // - approval: 审批待办
                       // - equipment_maintain: 设备维护待办(未来功能)
                       // - inventory: 盘点待办(未来功能)
                       // - change_request: 变更待办(未来功能)

  relatedId   String   // 关联业务 ID(根据 type 不同,含义不同)
                       // - training_organize/training_attend: TrainingProject.id
                       // - approval: WorkflowTask.id
                       // - equipment_maintain: EquipmentTask.id

  title       String   // 待办标题(如 "组织 GMP 培训")
  description String?  // 待办描述(可选)
  status      String   // pending, completed
  priority    String   @default("normal") // low, normal, high, urgent
  dueDate     DateTime? // 截止日期
  completedAt DateTime? // 完成时间
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User @relation(fields: [userId], references: [id])

  @@index([userId, status])
  @@index([type, relatedId])
  @@index([status, dueDate])
}
```

### 3.2 培训模块核心表（6 个）

**核心表**:
1. TrainingPlan - 年度培训计划
2. TrainingProject - 培训项目（具体培训课程）
3. TrainingQuestion - 考试题目
4. LearningRecord - 学习记录
5. ExamRecord - 考试记录（支持多次考试）
6. TrainingArchive - 培训档案（自动归档到文档系统）

**培训项目表示例**:

```prisma
model TrainingProject {
  id              String   @id @default(cuid())
  planId          String   // 所属年度计划

  title           String   // "GMP 基础培训"
  description     String?  // 培训描述
  department      String?  // 部门(null = 全员培训)
  quarter         Int?     // 季度 1-4(null = 临时培训)

  trainerId       String   // 培训讲师(默认部门主管)
  trainees        String[] // 被培训人员 ID 数组

  scheduledDate   DateTime // 计划培训日期
  documentIds     String[] // 培训资料(引用文档 ID)

  // 考试配置
  passingScore    Int      @default(60)  // 及格分数
  maxAttempts     Int      @default(3)   // 最多考试次数

  status          String   // planned, ongoing, completed, cancelled

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  completedAt     DateTime? // 完成时间(所有人考试完毕)

  plan            TrainingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  trainer         User @relation("TrainedProjects", fields: [trainerId], references: [id])
  questions       TrainingQuestion[]
  records         LearningRecord[]
  archive         TrainingArchive?

  @@index([planId, status])
  @@index([department, scheduledDate])
  @@index([trainerId])
}
```

**学习记录表示例**:

```prisma
model LearningRecord {
  id          String   @id @default(cuid())
  projectId   String   // 培训项目
  userId      String   // 学员

  // 考试结果
  examScore   Int?     // 最终考试分数(null = 未考试)
  attempts    Int      @default(0) // 已考试次数
  passed      Boolean  @default(false) // 是否通过

  completedAt DateTime? // 完成时间(通过考试的时间)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     TrainingProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        User @relation("LearningRecords", fields: [userId], references: [id])
  examRecords ExamRecord[]

  @@unique([projectId, userId]) // 一个用户一个项目只有一条记录
  @@index([userId, passed])
  @@index([projectId, passed])
}
```

---

## 4. 业务规则

### 4.1 培训计划规则（BR-091 ~ BR-095）

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-091 | **培训计划唯一性**: 每年只能有一个培训计划，年度 + 年份必须唯一 | `@unique([year])` |
| BR-092 | **培训计划审批规则**: 创建后状态为 draft，提交审批后变为 pending_approval，审批通过后变为 approved，审批驳回后回到 draft | `TrainingPlan.status` 状态机 |
| BR-093 | **培训计划修改规则**: draft 可直接修改；approved 时增删项目/修改信息需重新审批，修改学员名单无需审批 | 前端权限控制 + 后端校验 |
| BR-094 | **培训项目删除规则**: planned 可删除，ongoing/completed 只能标记为 cancelled；删除项目时自动删除关联待办任务 | 软删除 + 级联删除 |
| BR-095 | **培训计划完成条件**: 所有培训项目状态为 completed 或 cancelled 时，计划状态自动变为 completed | 自动触发逻辑 |

### 4.2 培训项目规则（BR-096 ~ BR-101）

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-096 | **培训项目状态流转**: planned → ongoing（第一个学员开始考试）→ completed（所有学员考试完毕）；planned 可取消为 cancelled | `TrainingProject.status` 状态机 |
| BR-097 | **培训资料引用规则**: 只能引用已发布的文档（status = published），引用最新版本；文档被撤销后显示"⚠️ 文档已撤销"标记 | 前端校验 + 后端校验 |
| BR-098 | **培训讲师权限**: 培训讲师默认为部门主管；可查看项目详情、学员统计，可修改学员名单（无需审批）；不能修改考试题目、删除项目 | RBAC 权限 |
| BR-099 | **培训学员限制**: 每个项目最少 1 个学员，最多 100 个学员；学员必须为在职员工（status = active） | 前端校验 + 后端校验 |
| BR-100 | **培训取消规则**: 取消时项目状态变为 cancelled，删除所有待办任务，保留已完成的学习记录，不生成培训档案 | 自动触发逻辑 |
| BR-101 | **培训项目自动完成**: 所有学员都完成考试时，自动触发：项目状态变为 completed，生成培训档案 PDF，归档到文档系统 | 自动触发逻辑 |

### 4.3 考试规则（BR-102 ~ BR-107）

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-102 | **考试次数限制**: 每个学员最多考试 maxAttempts 次（默认 3 次）；超过次数后不能再考试；即使未通过也算完成培训 | `LearningRecord.attempts` |
| BR-103 | **考试及格规则**: 分数 ≥ passingScore（默认 60 分）→ passed = true；分数 < passingScore → passed = false；通过考试后不能再次考试 | 自动评分逻辑 |
| BR-104 | **考试答案验证**: 必须回答所有题目；选择题答案必须为 A/B/C/D 之一；判断题答案必须为 true/false | 前端校验 + 后端校验 |
| BR-105 | **考试自动评分**: 提交答案后系统自动对比正确答案；每题答对加分值（points），答错不加分；总分 = Σ(答对题目的分值) | 自动评分逻辑 |
| BR-106 | **考试记录保存**: 每次考试都创建 ExamRecord 记录；保存答案（answers JSON）和分数（score）；最终分数 = 最高分 | `ExamRecord` 表 |
| BR-107 | **考试题目顺序**: 题目按 order 字段升序排列；每次考试题目顺序一致（不随机）；如需随机前端可随机打乱 | `TrainingQuestion.order` |

### 4.4 待办任务规则（BR-108 ~ BR-111）

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-108 | **待办任务自动生成**: 培训计划审批通过后，每个项目自动生成 1 个培训负责人待办 + N 个学员待办；dueDate = scheduledDate | TodoTask 自动创建 |
| BR-109 | **待办任务自动完成**: 学员通过考试后自动完成待办任务（status = completed）；培训负责人需手动完成或所有学员考试完毕后自动完成 | 自动触发逻辑 |
| BR-110 | **待办任务删除规则**: 培训项目取消 → 自动删除待办任务；培训计划重新审批 → 删除旧待办生成新待办；学员从项目中移除 → 删除该学员的待办任务 | 级联删除 |
| BR-111 | **待办任务逾期提醒**: dueDate < 当前日期 && status = pending 时系统每天定时发送逾期提醒（邮件/站内信）；逾期待办在列表中高亮显示 | 定时任务 |

### 4.5 培训档案规则（BR-112 ~ BR-115）

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-112 | **培训档案生成时机**: 培训项目状态变为 completed 时自动生成；内容包括培训计划信息、参训人员名单、考试成绩汇总、培训资料清单 | PDF 生成 |
| BR-113 | **培训档案归档规则**: 生成 PDF 后自动归档到文档系统（创建四级文件）；文档编号 REC-TRAIN-{YYYY}-{序号}；文档标题 {培训标题}-{日期}；文档类型 training_record（固定）；归属部门继承培训项目的 department | 自动创建 Document |
| BR-114 | **培训档案唯一性**: 每个培训项目只能生成一次档案；重复生成返回 409 Conflict | `TrainingArchive.projectId @unique` |
| BR-115 | **培训档案 PDF 格式**: 包含基本信息（培训主题、时间、讲师、部门）、培训内容（培训资料清单）、参训人员及考核（姓名、部门、成绩、是否通过、考试时间）、培训效果评估（总参训人数、通过率、平均分）、生成时间 | PDF 模板 |

---

**本文档完成 ✅**
