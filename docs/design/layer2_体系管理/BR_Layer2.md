# Layer 2 体系管理 - 业务规则汇总

> **来源**: DESIGN.md 第十五章、第十六章  
> **文档版本**: 1.0  
> **最后更新**: 2026-02-14  
> **规则编号范围**: BR-091 ~ BR-135  
> **规则总数**: 45 条

---

## 目录

- [1. 培训管理系统（BR-091 ~ BR-115）](#1-培训管理系统br-091--br-115)
- [2. 内审管理系统（BR-116 ~ BR-135）](#2-内审管理系统br-116--br-135)

---

## 1. 培训管理系统（BR-091 ~ BR-115）

### 1.1 培训计划规则（BR-091 ~ BR-095）

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-091 | **培训计划唯一性**: 每年只能有一个培训计划，年度 + 年份必须唯一 | `@unique([year])` |
| BR-092 | **培训计划审批规则**: 创建后状态为 draft，提交审批后变为 pending_approval，审批通过后变为 approved，审批驳回后回到 draft | `TrainingPlan.status` 状态机 |
| BR-093 | **培训计划修改规则**: draft 可直接修改；approved 时增删项目/修改信息需重新审批，修改学员名单无需审批 | 前端权限控制 + 后端校验 |
| BR-094 | **培训项目删除规则**: planned 可删除，ongoing/completed 只能标记为 cancelled；删除项目时自动删除关联待办任务 | 软删除 + 级联删除 |
| BR-095 | **培训计划完成条件**: 所有培训项目状态为 completed 或 cancelled 时，计划状态自动变为 completed | 自动触发逻辑 |

### 1.2 培训项目规则（BR-096 ~ BR-101）

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-096 | **培训项目状态流转**: planned → ongoing（第一个学员开始考试）→ completed（所有学员考试完毕）；planned 可取消为 cancelled | `TrainingProject.status` 状态机 |
| BR-097 | **培训资料引用规则**: 只能引用已发布的文档（status = published），引用最新版本；文档被撤销后显示"⚠️ 文档已撤销"标记 | 前端校验 + 后端校验 |
| BR-098 | **培训讲师权限**: 培训讲师默认为部门主管；可查看项目详情、学员统计，可修改学员名单（无需审批）；不能修改考试题目、删除项目 | RBAC 权限 |
| BR-099 | **培训学员限制**: 每个项目最少 1 个学员，最多 100 个学员；学员必须为在职员工（status = active） | 前端校验 + 后端校验 |
| BR-100 | **培训取消规则**: 取消时项目状态变为 cancelled，删除所有待办任务，保留已完成的学习记录，不生成培训档案 | 自动触发逻辑 |
| BR-101 | **培训项目自动完成**: 所有学员都完成考试时，自动触发：项目状态变为 completed，生成培训档案 PDF，归档到文档系统 | 自动触发逻辑 |

### 1.3 考试规则（BR-102 ~ BR-107）

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-102 | **考试次数限制**: 每个学员最多考试 maxAttempts 次（默认 3 次）；超过次数后不能再考试；即使未通过也算完成培训 | `LearningRecord.attempts` |
| BR-103 | **考试及格规则**: 分数 ≥ passingScore（默认 60 分）→ passed = true；分数 < passingScore → passed = false；通过考试后不能再次考试 | 自动评分逻辑 |
| BR-104 | **考试答案验证**: 必须回答所有题目；选择题答案必须为 A/B/C/D 之一；判断题答案必须为 true/false | 前端校验 + 后端校验 |
| BR-105 | **考试自动评分**: 提交答案后系统自动对比正确答案；每题答对加分值（points），答错不加分；总分 = Σ(答对题目的分值) | 自动评分逻辑 |
| BR-106 | **考试记录保存**: 每次考试都创建 ExamRecord 记录；保存答案（answers JSON）和分数（score）；最终分数 = 最高分 | `ExamRecord` 表 |
| BR-107 | **考试题目顺序**: 题目按 order 字段升序排列；每次考试题目顺序一致（不随机）；如需随机前端可随机打乱 | `TrainingQuestion.order` |

### 1.4 待办任务规则（BR-108 ~ BR-111）

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-108 | **待办任务自动生成**: 培训计划审批通过后，每个项目自动生成 1 个培训负责人待办 + N 个学员待办；dueDate = scheduledDate | TodoTask 自动创建 |
| BR-109 | **待办任务自动完成**: 学员通过考试后自动完成待办任务（status = completed）；培训负责人需手动完成或所有学员考试完毕后自动完成 | 自动触发逻辑 |
| BR-110 | **待办任务删除规则**: 培训项目取消 → 自动删除待办任务；培训计划重新审批 → 删除旧待办生成新待办；学员从项目中移除 → 删除该学员的待办任务 | 级联删除 |
| BR-111 | **待办任务逾期提醒**: dueDate < 当前日期 && status = pending 时系统每天定时发送逾期提醒（邮件/站内信）；逾期待办在列表中高亮显示 | 定时任务 |

### 1.5 培训档案规则（BR-112 ~ BR-115）

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-112 | **培训档案生成时机**: 培训项目状态变为 completed 时自动生成；内容包括培训计划信息、参训人员名单、考试成绩汇总、培训资料清单 | PDF 生成 |
| BR-113 | **培训档案归档规则**: 生成 PDF 后自动归档到文档系统（创建四级文件）；文档编号 REC-TRAIN-{YYYY}-{序号}；文档标题 {培训标题}-{日期}；文档类型 training_record（固定）；归属部门继承培训项目的 department | 自动创建 Document |
| BR-114 | **培训档案唯一性**: 每个培训项目只能生成一次档案；重复生成返回 409 Conflict | `TrainingArchive.projectId @unique` |
| BR-115 | **培训档案 PDF 格式**: 包含基本信息、培训内容、参训人员及考核表格、培训效果评估、生成时间 | PDF 模板 |

---

## 2. 内审管理系统（BR-116 ~ BR-135）

### 2.1 内审计划规则（BR-116 ~ BR-120）

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-116 | **内审计划创建规则**: 标题必填（5-100字符）；类型必选（quarterly/semiannual/annual）；审核时间范围必填（startDate < endDate）；内审员必选且必须为在职员工；至少勾选 1 个审核文档 | 前端校验 + 后端校验 |
| BR-117 | **内审计划文档勾选规则**: 只能勾选已发布的文档（status = published）；支持按文档级别筛选（1/2/3/4）；支持按部门筛选；支持批量勾选/取消勾选；勾选后的文档列表保存到 documentIds 数组 | 前端组件 + 后端存储 |
| BR-118 | **内审计划复制规则**: 可以复制任意状态的历史计划；复制内容（文档列表、计划类型）；不复制内容（审核发现、审核报告、审核时间、内审员）；复制后的计划状态为 draft | 复制 API |
| BR-119 | **内审计划启动规则**: 只有 draft 状态的计划可以启动；启动后状态变为 ongoing；启动时不生成待办任务；启动后直接进入审核页面 | 状态机 |
| BR-120 | **内审计划状态流转**: draft（草稿）→ ongoing（审核中）→ pending_rectification（等待整改）→ completed（已完成） | 状态机 |

### 2.2 审核执行规则（BR-121 ~ BR-125）

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-121 | **审核文档记录规则**: 所有文档都必须记录审核结果（包括"符合"的）；审核结果只有两种（符合/不符合）；审核结果为"符合"时只记录 auditResult = "符合"，其他字段为 null；审核结果为"不符合"时必须填写问题类型、问题描述（最少 10 字符）、责任部门、责任人，dueDate 自动计算（审核日期 + 30 天） | 前端校验 + 后端校验 |
| BR-122 | **问题类型枚举**: "需要修改"（文档内容有错误或不完善，需要修改）；"缺失记录"（四级记录文件缺少应有的记录）；"文档缺失"（应该存在的文档不存在，需要创建） | 枚举类型 |
| BR-123 | **审核进度计算**: 审核进度 = 已审核文档数 / 计划审核文档数 × 100%；已审核文档 = 有 AuditFinding 记录的文档；所有文档审核完毕 = 审核进度 100% | 自动计算 |
| BR-124 | **审核报告提交条件**: 必须所有文档都已审核（审核进度 = 100%）；提交后生成整改待办任务（仅针对"不符合"项）；提交后内审计划状态变为 pending_rectification | 前端校验 + 自动触发 |
| BR-125 | **审核结果不可修改规则**: 审核报告提交后审核结果不可修改；如需修改必须"撤回审核报告"（状态: pending_rectification → ongoing）；撤回后已生成的整改待办任务自动删除 | 状态机 + 级联删除 |

### 2.3 整改跟踪规则（BR-126 ~ BR-130）

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-126 | **整改待办任务生成规则**: 提交审核报告时自动生成整改待办任务；只为"不符合"项生成待办；待办任务内容（type = audit_rectification，relatedId = AuditFinding.id，userId = AuditFinding.assigneeId，title = "整改'{文档标题}'审核发现"，description = AuditFinding.description，dueDate = AuditFinding.dueDate，priority = high） | TodoTask 自动创建 |
| BR-127 | **整改提交规则**: 责任人修改/补填文档后点击"提交复审"；系统自动记录整改证据（rectificationDocumentId、rectificationVersion）；不需要责任人填写整改说明；提交后不符合项状态变为 pending_verification，待办任务状态变为 pending_verification | 自动触发逻辑 |
| BR-128 | **整改复审验证规则**: 只有内审员可以验证整改；验证选项（通过：不符合项状态 → verified，待办任务状态 → completed，记录 verifiedBy/verifiedAt；驳回：不符合项状态 → rectifying，待办任务重新分配给责任人，记录 rejectionReason（必填），责任人重新整改） | 权限控制 + 状态机 |
| BR-129 | **整改期限监控规则**: 整改期限默认为审核日期 + 30 天；超过期限未整改时待办任务标记为"逾期"（dueDate < 当前日期），系统每天发送逾期提醒（邮件/站内信）；允许延期（责任人可申请延期需内审员审批，延期后更新 dueDate） | 定时任务 + 通知系统 |
| BR-130 | **内审计划完成条件**: 所有不符合项状态 = verified；满足条件后可点击"完成内审"；完成后内审计划状态变为 completed，自动生成内审报告 PDF，自动归档到文档系统 | 自动触发逻辑 |

### 2.4 内审报告规则（BR-131 ~ BR-135）

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-131 | **内审报告生成时机**: 内审计划状态变为 completed 时自动生成；生成内容包括基本信息、审核范围、审核结果汇总、不符合项清单、整改验证记录 | PDF 生成 |
| BR-132 | **内审报告归档规则**: 生成 PDF 后自动归档到文档系统（创建四级文件）；文档编号 REC-AUDIT-{YYYY}-{序号}（序号为该年度内审报告的顺序号如 001, 002...）；文档标题 {内审标题}-内审报告-{完成日期}；文档类型 audit_record（固定）；文件级别 4；归属部门质量部（固定） | 自动创建 Document |
| BR-133 | **内审报告 PDF 格式**: 包含基本信息、审核范围、审核结果汇总、不符合项清单表格、整改验证记录表格、统计分析、生成时间 | PDF 模板 |
| BR-134 | **内审报告唯一性**: 每个内审计划只能生成一次报告；重复生成返回 409 Conflict | `AuditReport.planId @unique` |
| BR-135 | **内审报告版本管理**: 内审报告归档后作为四级文件管理；如需修改报告需要创建新版本（Document.version）；历史版本可追溯 | Document 版本机制 |

---

**本文档完成 ✅**
