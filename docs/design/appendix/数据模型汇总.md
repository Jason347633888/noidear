# 数据模型索引

> **来源**: DESIGN.md 各章节 + server/src/prisma/schema.prisma  
> **文档版本**: 1.0  
> **最后更新**: 2026-02-14  
> **数据表数量**: 40+ 张表  
> **数据库**: PostgreSQL 15

---

## 目录

- [1. 核心模块表](#1-核心模块表)
- [2. 文档管理表](#2-文档管理表)
- [3. 模板与记录表](#3-模板与记录表)
- [4. 批次追溯表](#4-批次追溯表)
- [5. 工作流表](#5-工作流表)
- [6. 权限管理表](#6-权限管理表)
- [7. 审计日志表](#7-审计日志表)
- [8. 系统配置表](#8-系统配置表)
- [9. 索引设计原则](#9-索引设计原则)

---

## 1. 核心模块表

### 1.1 User（用户表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | String | PK | 用户 ID（Snowflake） |
| username | String | UNIQUE | 用户名 |
| password | String | NOT NULL | 密码（bcrypt 哈希） |
| name | String | NOT NULL | 姓名 |
| email | String | UNIQUE | 邮箱 |
| phone | String | | 电话 |
| departmentId | String | FK | 部门 ID |
| role | String | NOT NULL | 角色（admin/manager/user） |
| status | String | NOT NULL | 状态（active/inactive） |
| createdAt | DateTime | DEFAULT now() | 创建时间 |
| updatedAt | DateTime | AUTO | 更新时间 |

**索引**:
- `@@index([departmentId])`
- `@@index([status])`
- `@@index([role])`

---

### 1.2 Department（部门表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | String | PK | 部门 ID |
| code | String | UNIQUE | 部门编码 |
| name | String | NOT NULL | 部门名称 |
| parentId | String | FK | 父部门 ID |
| managerId | String | FK | 部门主管 ID |
| description | String | | 描述 |
| createdAt | DateTime | DEFAULT now() | 创建时间 |
| updatedAt | DateTime | AUTO | 更新时间 |

**索引**:
- `@@index([parentId])`
- `@@index([managerId])`

---

### 1.3 Notification（通知表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | String | PK | 通知 ID |
| userId | String | FK | 接收用户 ID |
| type | String | NOT NULL | 通知类型 |
| title | String | NOT NULL | 标题 |
| content | String | NOT NULL | 内容 |
| relatedId | String | | 关联对象 ID |
| relatedType | String | | 关联对象类型 |
| isRead | Boolean | DEFAULT false | 是否已读 |
| readAt | DateTime | | 阅读时间 |
| createdAt | DateTime | DEFAULT now() | 创建时间 |

**索引**:
- `@@index([userId, isRead])`
- `@@index([createdAt])`

---

## 2. 文档管理表

### 2.1 Document（文档表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | String | PK | 文档 ID |
| number | String | UNIQUE | 文档编号 |
| title | String | NOT NULL | 文档标题 |
| level | Int | NOT NULL | 文档级别（1/2/3） |
| departmentId | String | FK | 归属部门 |
| categoryId | String | FK | 文档分类 |
| filePath | String | NOT NULL | 文件路径（MinIO） |
| fileName | String | NOT NULL | 文件名 |
| fileSize | Int | NOT NULL | 文件大小（字节） |
| fileType | String | NOT NULL | 文件类型 |
| version | Decimal | DEFAULT 1.0 | 版本号 |
| status | String | NOT NULL | 状态（draft/under_review/approved/rejected/archived/obsolete） |
| creatorId | String | FK | 创建人 ID |
| approverId | String | FK | 审批人 ID |
| approvedAt | DateTime | | 审批时间 |
| publishedAt | DateTime | | 发布时间 |
| archivedAt | DateTime | | 归档时间 |
| archivedBy | String | FK | 归档人 ID |
| archiveReason | String | | 归档原因 |
| obsoletedAt | DateTime | | 作废时间 |
| obsoletedBy | String | FK | 作废人 ID |
| obsoleteReason | String | | 作废原因 |
| createdAt | DateTime | DEFAULT now() | 创建时间 |
| updatedAt | DateTime | AUTO | 更新时间 |
| deletedAt | DateTime | | 删除时间（软删除） |

**索引**:
- `@@index([level, status])`
- `@@index([departmentId])`
- `@@index([creatorId])`
- `@@index([status])`
- `@@index([archivedAt])`
- `@@index([obsoletedAt])`
- `@@index([deletedAt])`

---

### 2.2 DocumentCategory（文档分类表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | String | PK | 分类 ID |
| name | String | NOT NULL | 分类名称 |
| code | String | UNIQUE | 分类编码 |
| level | Int | NOT NULL | 适用文档级别（1/2/3） |
| parentId | String | FK | 父分类 ID |
| sortOrder | Int | DEFAULT 0 | 排序顺序 |
| createdAt | DateTime | DEFAULT now() | 创建时间 |

**索引**:
- `@@index([level])`
- `@@index([parentId])`

---

## 3. 模板与记录表

### 3.1 Template（模板表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | String | PK | 模板 ID |
| code | String | UNIQUE | 模板编码 |
| name | String | NOT NULL | 模板名称 |
| departmentId | String | FK | 归属部门 |
| type | String | NOT NULL | 模板类型 |
| version | Int | DEFAULT 1 | 版本号 |
| status | String | NOT NULL | 状态（active/inactive） |
| description | String | | 描述 |
| creatorId | String | FK | 创建人 ID |
| createdAt | DateTime | DEFAULT now() | 创建时间 |
| updatedAt | DateTime | AUTO | 更新时间 |

**索引**:
- `@@index([departmentId, status])`
- `@@index([type])`

---

### 3.2 TemplateField（模板字段表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | String | PK | 字段 ID |
| templateId | String | FK | 模板 ID |
| name | String | NOT NULL | 字段名称 |
| fieldKey | String | NOT NULL | 字段 Key |
| type | String | NOT NULL | 字段类型（text/number/date/select...） |
| required | Boolean | DEFAULT false | 是否必填 |
| options | Json | | 选项配置（select/radio/checkbox） |
| validation | Json | | 验证规则 |
| sortOrder | Int | DEFAULT 0 | 排序顺序 |
| createdAt | DateTime | DEFAULT now() | 创建时间 |

**索引**:
- `@@index([templateId])`
- `@@unique([templateId, fieldKey])`

---

### 3.3 Record（记录表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | String | PK | 记录 ID |
| templateId | String | FK | 模板 ID |
| recordNumber | String | UNIQUE | 记录编号 |
| title | String | NOT NULL | 记录标题 |
| departmentId | String | FK | 归属部门 |
| status | String | NOT NULL | 状态（draft/submitted/approved/rejected） |
| data | Json | NOT NULL | 记录数据（JSON 格式） |
| signatures | Json | | 电子签名数据 |
| creatorId | String | FK | 创建人 ID |
| submittedAt | DateTime | | 提交时间 |
| approverId | String | FK | 审批人 ID |
| approvedAt | DateTime | | 审批时间 |
| createdAt | DateTime | DEFAULT now() | 创建时间 |
| updatedAt | DateTime | AUTO | 更新时间 |
| deletedAt | DateTime | | 删除时间（软删除） |

**索引**:
- `@@index([templateId])`
- `@@index([departmentId, status])`
- `@@index([creatorId])`
- `@@index([status])`
- `@@index([deletedAt])`

---

### 3.4 RecordChangeLog（记录修改日志表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | String | PK | 日志 ID |
| recordId | String | FK | 记录 ID |
| field | String | NOT NULL | 修改字段 |
| oldValue | String | | 修改前值 |
| newValue | String | | 修改后值 |
| reason | String | NOT NULL | 修改原因 |
| changedBy | String | FK | 修改人 ID |
| changedByName | String | NOT NULL | 修改人姓名 |
| changedAt | DateTime | DEFAULT now() | 修改时间 |

**索引**:
- `@@index([recordId])`
- `@@index([changedAt])`

---

## 4. 批次追溯表

### 4.1 MaterialBatch（物料批次表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | String | PK | 批次 ID |
| batchNumber | String | UNIQUE | 批次号 |
| materialCode | String | NOT NULL | 物料编码 |
| materialName | String | NOT NULL | 物料名称 |
| quantity | Decimal | NOT NULL | 数量 |
| unit | String | NOT NULL | 单位 |
| supplierId | String | FK | 供应商 ID |
| supplierBatchNumber | String | | 供应商批次号 |
| productionDate | DateTime | | 生产日期 |
| expiryDate | DateTime | | 到期日期 |
| status | String | NOT NULL | 状态（available/used/expired/locked） |
| createdAt | DateTime | DEFAULT now() | 创建时间 |
| updatedAt | DateTime | AUTO | 更新时间 |

**索引**:
- `@@index([materialCode])`
- `@@index([status])`
- `@@index([expiryDate])`
- `@@index([productionDate])`

---

### 4.2 ProductBatch（成品批次表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | String | PK | 批次 ID |
| batchNumber | String | UNIQUE | 批次号 |
| productCode | String | NOT NULL | 产品编码 |
| productName | String | NOT NULL | 产品名称 |
| quantity | Decimal | NOT NULL | 数量 |
| unit | String | NOT NULL | 单位 |
| productionDate | DateTime | NOT NULL | 生产日期 |
| expiryDate | DateTime | | 到期日期 |
| status | String | NOT NULL | 状态 |
| createdAt | DateTime | DEFAULT now() | 创建时间 |

**索引**:
- `@@index([productCode])`
- `@@index([productionDate])`
- `@@index([status])`

---

### 4.3 BatchRelation（批次关联表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | String | PK | 关联 ID |
| productBatchId | String | FK | 成品批次 ID |
| materialBatchId | String | FK | 物料批次 ID |
| usedQuantity | Decimal | NOT NULL | 使用数量 |
| relatedAt | DateTime | DEFAULT now() | 关联时间 |

**索引**:
- `@@index([productBatchId])`
- `@@index([materialBatchId])`
- `@@unique([productBatchId, materialBatchId])`

---

## 5. 工作流表

### 5.1 WorkflowTemplate（工作流模板表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | String | PK | 模板 ID |
| code | String | UNIQUE | 模板编码 |
| name | String | NOT NULL | 模板名称 |
| departmentId | String | FK | 归属部门 |
| steps | Json | NOT NULL | 步骤配置（JSON） |
| version | Int | DEFAULT 1 | 版本号 |
| status | String | DEFAULT active | 状态（active/inactive） |
| createdById | String | FK | 创建人 ID |
| createdAt | DateTime | DEFAULT now() | 创建时间 |
| updatedAt | DateTime | AUTO | 更新时间 |

**索引**:
- `@@index([departmentId, status])`
- `@@index([code])`

---

### 5.2 WorkflowInstance（工作流实例表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | String | PK | 实例 ID |
| templateId | String | FK | 模板 ID |
| documentId | String | FK | 关联文档 ID |
| recordId | String | FK | 关联记录 ID |
| currentStep | Int | DEFAULT 1 | 当前步骤 |
| status | String | DEFAULT running | 状态（running/completed/rejected/cancelled） |
| initiatorId | String | FK | 发起人 ID |
| startedAt | DateTime | DEFAULT now() | 开始时间 |
| completedAt | DateTime | | 完成时间 |

**索引**:
- `@@index([documentId])`
- `@@index([recordId])`
- `@@index([initiatorId, status])`
- `@@index([status, currentStep])`

---

### 5.3 WorkflowTask（工作流任务表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | String | PK | 任务 ID |
| instanceId | String | FK | 实例 ID |
| stepOrder | Int | NOT NULL | 步骤顺序 |
| stepName | String | NOT NULL | 步骤名称 |
| assigneeId | String | FK | 审批人 ID |
| status | String | DEFAULT pending | 状态（pending/completed/rejected/skipped） |
| action | String | | 操作（approved/rejected） |
| comment | String | | 审批意见 |
| timeoutHours | Int | DEFAULT 24 | 超时小时数 |
| escalationUserId | String | FK | 超时升级用户 ID |
| isOverdue | Boolean | DEFAULT false | 是否超时 |
| overdueNotifiedAt | DateTime | | 超时通知时间 |
| completedAt | DateTime | | 完成时间 |
| createdAt | DateTime | DEFAULT now() | 创建时间 |

**索引**:
- `@@index([assigneeId, status])`
- `@@index([instanceId, stepOrder])`
- `@@index([isOverdue, status])`

---

## 6. 权限管理表

### 6.1 Permission（权限表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | String | PK | 权限 ID |
| code | String | UNIQUE | 权限编码 |
| name | String | NOT NULL | 权限名称 |
| category | String | NOT NULL | 权限类别 |
| scope | String | DEFAULT department | 权限范围（department/cross_department/global） |
| description | String | | 描述 |
| createdAt | DateTime | DEFAULT now() | 创建时间 |
| updatedAt | DateTime | AUTO | 更新时间 |

**索引**:
- `@@index([category])`
- `@@index([scope])`

---

### 6.2 UserPermission（用户权限表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | String | PK | 用户权限 ID |
| userId | String | FK | 用户 ID |
| permissionId | String | FK | 权限 ID |
| grantedBy | String | FK | 授权人 ID |
| grantedByName | String | NOT NULL | 授权人姓名 |
| grantedAt | DateTime | DEFAULT now() | 授权时间 |
| expiresAt | DateTime | | 过期时间 |
| reason | String | | 授权原因 |
| resourceType | String | | 资源类型 |
| resourceId | String | | 资源 ID |

**索引**:
- `@@index([userId])`
- `@@index([permissionId])`
- `@@index([expiresAt])`
- `@@unique([userId, permissionId, resourceType, resourceId])`

---

## 7. 审计日志表

### 7.1 LoginLog（登录日志表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | String | PK | 日志 ID |
| userId | String | FK | 用户 ID |
| username | String | NOT NULL | 用户名 |
| action | String | NOT NULL | 操作（login/logout/login_failed） |
| ipAddress | String | NOT NULL | IP 地址 |
| userAgent | String | NOT NULL | User Agent |
| location | String | | IP 地理位置 |
| loginTime | DateTime | DEFAULT now() | 登录时间 |
| logoutTime | DateTime | | 登出时间 |
| status | String | NOT NULL | 状态（success/failed） |
| failReason | String | | 失败原因 |

**索引**:
- `@@index([userId])`
- `@@index([loginTime])`
- `@@index([ipAddress])`
- `@@index([status])`

---

### 7.2 PermissionLog（权限变更日志表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | String | PK | 日志 ID |
| operatorId | String | FK | 操作人 ID |
| operatorName | String | NOT NULL | 操作人姓名 |
| targetUserId | String | FK | 被操作用户 ID |
| targetUsername | String | NOT NULL | 被操作用户名 |
| action | String | NOT NULL | 操作类型 |
| beforeValue | Json | | 变更前值 |
| afterValue | Json | | 变更后值 |
| reason | String | | 变更原因 |
| approvedBy | String | FK | 批准人 ID |
| approvedByName | String | | 批准人姓名 |
| ipAddress | String | NOT NULL | IP 地址 |
| createdAt | DateTime | DEFAULT now() | 创建时间 |

**索引**:
- `@@index([operatorId])`
- `@@index([targetUserId])`
- `@@index([action])`
- `@@index([createdAt])`

---

### 7.3 SensitiveLog（敏感操作日志表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | String | PK | 日志 ID |
| userId | String | FK | 用户 ID |
| username | String | NOT NULL | 用户名 |
| action | String | NOT NULL | 操作类型 |
| resourceType | String | NOT NULL | 资源类型 |
| resourceId | String | NOT NULL | 资源 ID |
| resourceName | String | NOT NULL | 资源名称 |
| details | Json | | 详细信息 |
| ipAddress | String | NOT NULL | IP 地址 |
| userAgent | String | NOT NULL | User Agent |
| createdAt | DateTime | DEFAULT now() | 创建时间 |

**索引**:
- `@@index([userId])`
- `@@index([action])`
- `@@index([resourceType])`
- `@@index([createdAt])`

---

## 8. 系统配置表

### 8.1 NumberingRule（编号规则表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | String | PK | 规则 ID |
| code | String | UNIQUE | 规则编码 |
| name | String | NOT NULL | 规则名称 |
| prefix | String | NOT NULL | 前缀 |
| separator | String | DEFAULT - | 分隔符 |
| dateFormat | String | | 日期格式（YYYY/YYYYMM/YYYYMMDD） |
| sequence | Int | DEFAULT 1 | 当前序号 |
| sequenceLength | Int | DEFAULT 3 | 序号长度 |
| resetMode | String | DEFAULT never | 重置模式（never/yearly/monthly） |
| lastResetAt | DateTime | | 最后重置时间 |
| status | String | DEFAULT active | 状态（active/inactive） |
| createdAt | DateTime | DEFAULT now() | 创建时间 |
| updatedAt | DateTime | AUTO | 更新时间 |

**索引**:
- `@@index([status])`

---

### 8.2 SystemConfig（系统配置表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | String | PK | 配置 ID |
| key | String | UNIQUE | 配置键 |
| value | String | NOT NULL | 配置值 |
| type | String | NOT NULL | 类型（string/number/boolean/json） |
| description | String | | 描述 |
| updatedAt | DateTime | AUTO | 更新时间 |

**索引**: 无

---

## 9. 索引设计原则

### 9.1 主键索引

- 所有表必须有主键
- 主键类型：String（Snowflake ID 或 CUID）
- 主键自动创建聚簇索引

### 9.2 外键索引

- 所有外键字段必须创建索引
- 格式：`@@index([foreignKeyField])`

### 9.3 查询优化索引

- 高频查询字段创建单列索引
- 联合查询创建复合索引
- 复合索引遵循最左前缀原则

### 9.4 唯一索引

- 业务唯一字段创建唯一索引
- 格式：`@@unique([field])` 或 `@unique`

### 9.5 软删除索引

- 软删除表必须在 `deletedAt` 字段创建索引
- 查询时必须过滤 `deletedAt IS NULL`

---

## 数据库命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| 表名 | 大驼峰，复数形式 | `Users`, `Documents` |
| 字段名 | 小驼峰 | `createdAt`, `userId` |
| 索引名 | `idx_table_field` | `idx_users_department_id` |
| 外键名 | `fk_table_field` | `fk_documents_creator_id` |

---

**本文档完成 ✅**
