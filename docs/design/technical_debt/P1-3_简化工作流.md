# P1-3: 工作流引擎完整方案

> **来源**: DESIGN.md Chapter 22.2.3 (第 13914-14355 行)  
> **文档版本**: 3.0  
> **最后更新**: 2026-02-14  
> **技术债务优先级**: P1（高优先级）  
> **依赖**: Phase 11 内审管理、复杂审批流程的基础

---

## 目录

- [1. 业务规则](#1-业务规则)
- [2. API 设计](#2-api-设计)
- [3. 前端界面设计](#3-前端界面设计)
- [4. 实施检查清单](#4-实施检查清单)

---

## 1. 业务规则

### BR-354: 工作流模板规则

- **模板创建**：仅管理员或部门主管可创建工作流模板
- **模板编码**：唯一，格式为 `{category}_{department}_{seq}`，如 `document_production_001`
- **步骤配置**：工作流步骤使用 JSON 配置，包含步骤名称、审批人角色、超时时间、并行模式
- **模板版本**：修改模板时创建新版本，旧版本仍可查看但不可使用
- **模板停用**：停用模板后，已启动的工作流实例仍可继续执行

---

### BR-355: 工作流启动规则

- **启动条件**：资源（文档/任务/记录）必须满足启动条件（如文档状态为 draft）
- **模板选择**：根据资源类型和部门自动匹配工作流模板
- **发起人记录**：记录工作流发起人和发起时间
- **初始状态**：工作流启动后状态为 `pending`，第一步任务为 `pending`

---

### BR-356: 串行审批规则

- **顺序执行**：串行审批按步骤顺序执行，前一步未完成时后一步不可执行
- **自动分配**：当前步骤完成后，自动创建下一步任务并通知审批人
- **审批超时**：超过截止时间未审批，状态变为 `timeout`，自动升级给上级

---

### BR-357: 并行审批规则（会签）

- **同步开始**：并行审批的所有任务同时创建，同时通知所有审批人
- **全部通过**：所有并行任务都通过后，才进入下一步
- **一人拒绝**：任一并行任务拒绝，整个工作流状态变为 `rejected`，其他并行任务自动跳过
- **一人超时**：任一并行任务超时，其他并行任务不能继续，整个工作流状态变为 `timeout`

---

### BR-358: 审批超时升级规则

- **超时时间**：每个步骤可配置超时时间（如 24 小时、48 小时）
- **自动升级**：超时后自动升级给上级审批人（escalatedTo）
- **升级通知**：升级后通知原审批人和上级审批人
- **原审批人仍可审批**：升级后原审批人仍可完成审批

---

### BR-359: 工作流取消规则

- **取消权限**：仅工作流发起人或管理员可取消
- **取消时机**：仅 `pending` 或 `in_progress` 状态可取消
- **取消原因**：必须填写取消原因
- **取消通知**：取消后通知所有相关审批人

---

## 2. API 设计

### 2.1 创建工作流模板

```
POST /api/v1/workflow-templates
```

**请求体**:
```typescript
{
  "code": "document_production_001",
  "name": "生产部文档审批流程",
  "departmentId": "dept_123",
  "category": "document",
  "steps": [
    {
      "index": 0,
      "name": "部门主管审批",
      "assigneeRole": "manager",  // 审批人角色
      "parallelMode": false,
      "timeoutHours": 24
    },
    {
      "index": 1,
      "name": "质量部会签",
      "assigneeRole": "quality_manager",
      "parallelMode": true,       // 并行审批
      "parallelAssignees": ["user_001", "user_002"],  // 指定审批人
      "timeoutHours": 48
    }
  ]
}
```

**响应**:
```typescript
{
  "success": true,
  "data": {
    "id": "wft_789",
    "code": "document_production_001",
    "name": "生产部文档审批流程",
    "version": 1,
    "status": "active"
  }
}
```

---

### 2.2 启动工作流

```
POST /api/v1/workflow-instances
```

**请求体**:
```typescript
{
  "templateId": "wft_789",
  "resourceType": "document",
  "resourceId": "doc_456",
  "resourceTitle": "质量手册 V2.0"
}
```

**响应**:
```typescript
{
  "success": true,
  "data": {
    "id": "wfi_101",
    "templateCode": "document_production_001",
    "status": "in_progress",
    "currentStep": 0,
    "tasks": [
      {
        "id": "wft_201",
        "stepName": "部门主管审批",
        "assigneeId": "user_manager",
        "status": "pending",
        "dueAt": "2026-02-14T10:00:00Z"
      }
    ]
  }
}
```

---

### 2.3 审批工作流任务

```
POST /api/v1/workflow-tasks/:taskId/approve
```

**请求体**:
```typescript
{
  "action": "approve",  // approve | reject
  "comment": "文档内容符合要求，同意发布"
}
```

**响应**:
```typescript
{
  "success": true,
  "data": {
    "taskId": "wft_201",
    "status": "approved",
    "completedAt": "2026-02-13T14:00:00Z",
    "nextTask": {
      "id": "wft_202",
      "stepName": "质量部会签",
      "assigneeId": "user_001",
      "status": "pending"
    }
  }
}
```

---

### 2.4 取消工作流

```
POST /api/v1/workflow-instances/:id/cancel
```

**请求体**:
```typescript
{
  "reason": "文档内容需重新修订"
}
```

**响应**:
```typescript
{
  "success": true,
  "message": "工作流已取消"
}
```

---

### 2.5 查询我的待审批任务

```
GET /api/v1/workflow-tasks/my-tasks?status=pending
```

**响应**:
```typescript
{
  "success": true,
  "data": [
    {
      "id": "wft_201",
      "instanceId": "wfi_101",
      "stepName": "部门主管审批",
      "resourceType": "document",
      "resourceTitle": "质量手册 V2.0",
      "initiatorName": "张三",
      "status": "pending",
      "dueAt": "2026-02-14T10:00:00Z"
    }
  ]
}
```

---

## 3. 前端界面设计

### 3.1 工作流模板编辑器（可视化设计器）

**页面路由**: `/workflow-templates/editor`

**页面布局**（简化版）:
```
┌──────────────────────────────────────────────────────────┐
│ 工作流设计器                             [保存] [预览]    │
├──────────────────────────────────────────────────────────┤
│ 基本信息:                                                 │
│ 模板名称: [生产部文档审批流程__________]                   │
│ 所属部门: [生产部 ▼]  类别: [文档 ▼]                      │
│                                                          │
│ 审批步骤:                                                 │
│ ┌────────────────────────────────────────────────────┐   │
│ │ 步骤 1: 部门主管审批                    [编辑][删除]│   │
│ │ 审批人角色: 部门主管  超时: 24小时                  │   │
│ │                                                    │   │
│ │              ↓                                     │   │
│ │                                                    │   │
│ │ 步骤 2: 质量部会签（并行）              [编辑][删除]│   │
│ │ 审批人: 张三, 李四   超时: 48小时                   │   │
│ └────────────────────────────────────────────────────┘   │
│ [+ 添加步骤]                                              │
└──────────────────────────────────────────────────────────┘
```

---

### 3.2 我的待办任务页面

**页面路由**: `/my-tasks`

**页面布局**:
```
┌──────────────────────────────────────────────────────────┐
│ 我的待办                     [全部] [文档] [任务] [记录]  │
├──────────────────────────────────────────────────────────┤
│ ┌────────────────────────────────────────────────────┐   │
│ │ 资源标题    │ 步骤     │ 发起人 │ 截止时间 │ 操作 │   │
│ ├────────────────────────────────────────────────────┤   │
│ │ 质量手册V2  │ 主管审批 │ 张三   │ 明天     │[审]│   │
│ │ 生产记录001 │ 质量会签 │ 李四   │ 2天后    │[审]│   │
│ └────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────┘
```

---

### 3.3 审批对话框

**对话框尺寸**: `70% × 80%`

**对话框内容**:
```
┌─────────────────────────────────────────┐
│ 审批 - 质量手册 V2.0             [×]     │
├─────────────────────────────────────────┤
│ 审批流程:                                │
│ [✓] 部门主管审批 → [●] 质量部会签        │
│                                         │
│ 文档预览:                                │
│ [PDF预览区域........................]   │
│                                         │
│ 审批意见:                                │
│ [___________________________________]   │
│ [___________________________________]   │
│                                         │
│          [拒绝]  [通过]                  │
└─────────────────────────────────────────┘
```

---

### 3.4 Vue 3 代码示例

详见完整代码示例（参考原文档第 14192-14302 行）

**核心功能**:
- 我的待办任务列表显示
- 审批对话框（查看资源、填写意见、通过/拒绝）
- 审批流程可视化（el-steps）
- 截止时间高亮显示

---

## 4. 实施检查清单

### 4.1 数据模型

- [ ] 1a. WorkflowTemplate 表创建成功
- [ ] 1b. WorkflowInstance 表创建成功
- [ ] 1c. WorkflowTask 表创建成功
- [ ] 1d. 索引创建成功

---

### 4.2 工作流引擎

- [ ] 2a. WorkflowService 实现
- [ ] 2b. 启动工作流逻辑正确
- [ ] 2c. 串行审批逻辑正确
- [ ] 2d. 并行审批逻辑正确
- [ ] 2e. 审批超时升级逻辑正确
- [ ] 2f. 工作流取消逻辑正确

---

### 4.3 定时任务

- [ ] 3a. WorkflowScheduler 实现
- [ ] 3b. 每 10 分钟检查超时任务
- [ ] 3c. 超时任务自动升级
- [ ] 3d. 超时通知发送正确

---

### 4.4 API 实现

- [ ] 4a. POST /api/v1/workflow-templates 实现
- [ ] 4b. POST /api/v1/workflow-instances 实现
- [ ] 4c. POST /api/v1/workflow-tasks/:id/approve 实现
- [ ] 4d. POST /api/v1/workflow-instances/:id/cancel 实现
- [ ] 4e. GET /api/v1/workflow-tasks/my-tasks 实现

---

### 4.5 业务规则

- [ ] 5a. BR-354 工作流模板规则验证通过
- [ ] 5b. BR-355 工作流启动规则验证通过
- [ ] 5c. BR-356 串行审批规则验证通过
- [ ] 5d. BR-357 并行审批规则验证通过
- [ ] 5e. BR-358 审批超时升级规则验证通过
- [ ] 5f. BR-359 工作流取消规则验证通过

---

### 4.6 前端界面

- [ ] 6a. 工作流模板编辑器实现（可视化设计器）
- [ ] 6b. 我的待办任务页面实现
- [ ] 6c. 审批对话框实现
- [ ] 6d. 审批流程可视化显示正确

---

### 4.7 测试

- [ ] 7a. 串行审批场景测试通过
- [ ] 7b. 并行审批场景测试通过
- [ ] 7c. 审批超时升级场景测试通过
- [ ] 7d. 工作流取消场景测试通过
- [ ] 7e. 一人拒绝全部失效场景测试通过
- [ ] 7f. 一人超时阻塞场景测试通过

---

**本文档完成 ✅**
