# Layer 1 核心生产 - 业务规则汇总

> **来源**: DESIGN.md 第十七章、第十八章  
> **文档版本**: 1.0  
> **最后更新**: 2026-02-14  
> **规则编号范围**: BR-101 ~ BR-230  
> **规则总数**: 60 条

---

## 目录

- [1. 仓库管理系统（BR-101 ~ BR-108）](#1-仓库管理系统br-101--br-108)
- [2. 设备管理系统（BR-181 ~ BR-230）](#2-设备管理系统br-181--br-230)

---

## 1. 仓库管理系统（BR-101 ~ BR-108）

### 物料与批次管理

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-101 | **物料批次号唯一**: 每个物料批次的 batchNumber 必须全局唯一 | `MaterialBatch.batchNumber @unique` |
| BR-102 | **领料遵循 FIFO 规则（先进先出）**: 系统推荐最旧批次优先领用 | 查询 API 按 productionDate 升序排序 |
| BR-103 | **过期物料自动锁定，不可领用**: 到期日期 < 今天时，status = expired，前端禁用 | 定时任务检查 + 前端禁用 |
| BR-104 | **物料平衡偏差 > 5% 时预警**: 实际消耗与理论消耗偏差超过 5% 时，生成预警通知 | 后端校验逻辑 + 通知系统 |
| BR-105 | **批次追溯必须 < 4 小时完成**: BRCGS 合规要求，任意成品批次能在 4 小时内追溯到所有原料批次 | 数据库索引优化 + 追溯 API |
| BR-106 | **供应商批次号必须记录**: 原料入库时必须记录供应商批次号 | `MaterialBatch.supplierBatchNumber` 必填 |
| BR-107 | **领料单需审批**: 领料单创建后必须提交审批，审批通过后才能出库 | 工作流引擎集成 |
| BR-108 | **暂存间每日盘点**: 生产部暂存间每日上班前/下班后盘点，记录期初期末库存 | 定时提醒 + TodoTask |

---

## 2. 设备管理系统（BR-181 ~ BR-230）

### 2.1 设备台账规则（BR-181 ~ BR-190）

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-181 | **设备编号唯一**: 每个设备的 code 必须唯一 | `Equipment.code @unique` |
| BR-182 | **设备分类**: 生产设备/检验设备/辅助设备 | `Equipment.category` 枚举 |
| BR-183 | **设备状态**: active(启用) / inactive(停用) / scrapped(报废) | `Equipment.status` 枚举 |
| BR-184 | **维护周期**: 每个设备可以有不同的维护周期（天数） | `Equipment.maintenanceCycle` |
| BR-185 | **提前提醒**: 用户可自定义提前几天提醒（默认 3 天） | `Equipment.reminderDays` |
| BR-186 | **下次维护日期**: 系统自动计算并更新 | 自动计算：上次维护日期 + 维护周期 |
| BR-187 | **责任人**: 每个设备必须指定责任人 | `Equipment.responsiblePerson` |
| BR-188 | **保修期**: 记录保修到期日期，到期前提醒 | `Equipment.warrantyExpiry` |
| BR-189 | **设备报废**: 报废后不再生成维护计划 | `status = scrapped` 时停止生成计划 |
| BR-190 | **设备编号生成**: 格式 `EQ-{YYYYMMDD}-{序号}` | 后端自动生成 |

### 2.2 分级保养规则（BR-191 ~ BR-200）

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-191 | **保养级别定义**: 日保养(daily)/周保养(weekly)/月保养(monthly)/季度保养(quarterly)/年度保养(annual) | `MaintenancePlan.maintenanceLevel` 枚举 |
| BR-192 | **日保养周期**: 每天，当天早上提醒（reminderDays=0） | cycle=1, reminderDays=0 |
| BR-193 | **周保养周期**: 每周，提前1天提醒 | cycle=7, reminderDays=1 |
| BR-194 | **月保养周期**: 每月（30天），提前3天提醒 | cycle=30, reminderDays=3 |
| BR-195 | **季度保养周期**: 每季度（90天），提前7天提醒 | cycle=90, reminderDays=7 |
| BR-196 | **年度保养周期**: 每年（365天），提前14天提醒 | cycle=365, reminderDays=14 |
| BR-197 | **多计划并行**: 一个设备可以同时有多个不同级别的保养计划 | MaintenancePlan 一对多关系 |
| BR-198 | **保养级别必填**: 创建保养计划时必须指定级别 | `MaintenancePlan.maintenanceLevel` 非空 |
| BR-199 | **下次计划生成**: 当前级别保养完成后，自动生成该级别的下次计划 | 保养日期 + 对应级别周期 |
| BR-200 | **灵活配置**: 用户可自定义启用哪些保养级别 | `Equipment.maintenanceConfig` JSON |

### 2.3 维护计划规则（BR-201 ~ BR-210）

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-201 | **自动生成**: 设备启用后根据配置自动生成多个保养计划 | 启用日期 + 对应级别周期 |
| BR-202 | **计划状态**: pending(待执行) → in_progress(进行中) → completed(已完成) / cancelled(已取消) | `MaintenancePlan.status` 状态机 |
| BR-203 | **提醒时机**: 计划日期前 N 天生成待办任务（不同级别N不同） | 定时任务检查 |
| BR-204 | **逾期提醒**: 计划日期过后仍未完成，持续提醒 | 定时任务检查 |
| BR-205 | **待办任务**: 生成待办任务时，关联 TodoTask | `MaintenancePlan.todoTaskId` |
| BR-206 | **计划取消**: 设备停用/报废时，取消未完成的维护计划 | 批量更新 status = cancelled |
| BR-207 | **计划调整**: 责任人可以延期维护计划（需审批） | 工作流集成 |
| BR-208 | **日历视图**: 维护计划在日历上显示 | 前端日历组件 |
| BR-209 | **看板视图**: 维护计划在看板上显示（待执行/进行中/已完成） | 前端看板组件 |
| BR-210 | **计划编号**: 格式 `MP-{YYYYMMDD}-{序号}` | 后端自动生成 |

### 2.4 维保记录规则（BR-211 ~ BR-220）

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-211 | **记录状态**: draft(草稿) → submitted(已提交) → approved(已审批) / rejected(已驳回) | `MaintenanceRecord.status` 状态机 |
| BR-212 | **必填字段**: 维保日期、维保级别、维保内容、维保人员签名 | 前端校验 + 后端校验 |
| BR-213 | **现场拍照**: 支持上传多张照片（最多 9 张） | `MaintenanceRecord.photos` JSON 数组 |
| BR-214 | **电子签名**: 维保人员和审核人员必须电子签名 | 手写签字板 |
| BR-215 | **审批流程**: 维保记录提交后，生成审批待办任务 | 工作流集成 |
| BR-216 | **审批通过**: 审批通过后，关闭维保待办任务，生成该级别的下次维护计划 | 自动触发 |
| BR-217 | **审批驳回**: 审批驳回后，维保记录回到草稿状态，可修改重新提交 | 状态回退 |
| BR-218 | **离线填写**: 移动端支持离线填写，联网后自动同步 | 本地存储 + 同步队列 |
| BR-219 | **记录编号**: 格式 `MAINT-{YYYYMMDD}-{序号}` | 后端自动生成 |
| BR-220 | **记录查询**: 支持按设备/日期/级别/类型/责任人查询 | 查询 API |

### 2.5 设备报修规则（BR-221 ~ BR-230）

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-221 | **所有员工可发起报修**: 任何员工都可以提交设备报修单 | 前端权限控制 + API 权限检查 |
| BR-222 | **报修单号自动生成**: 格式 `FR-{YYYYMMDD}-{序号}` | 后端自动生成 |
| BR-223 | **自动生成待办任务**: 报修单提交后，自动为工程部生成待办 | TodoTask 集成 |
| BR-224 | **紧急报修优先级高**: urgent 级别的报修单优先显示 | 待办任务优先级设置 |
| BR-225 | **接单后状态变更**: 工程部人员接单后，状态变为 in_progress | 状态机 |
| BR-226 | **完成维修后关闭待办**: 提交完成工单后，关闭对应的待办任务 | TodoTask 状态更新 |
| BR-227 | **移动端支持**: 工程部人员可在移动端填写维修记录、拍照、签名 | uniapp 移动端 |
| BR-228 | **报修单不可删除**: 只能取消，保留历史记录 | 软删除或状态标记 |
| BR-229 | **报修统计**: 统计每月报修次数、平均响应时间、完成率 | 定时任务 + 统计 API |
| BR-230 | **区域设备联动**: 选择区域后，自动过滤该区域的设备 | 前端联动 + Equipment.location |

---

**本文档完成 ✅**
