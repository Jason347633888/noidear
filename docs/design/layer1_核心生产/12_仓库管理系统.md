# 仓库管理系统（Layer 1 核心生产）

> **来源**: DESIGN.md 第十七章（仓库管理系统）  
> **文档版本**: 1.0  
> **最后更新**: 2026-02-14  
> **实现状态**: ⏳ 未实现（PRD + LLD 已完成）  
> **优先级**: ⭐⭐⭐ 最高（Phase B 核心生产）  
> **依赖**: 动态表单引擎、批次追溯系统、移动端应用

---

## 目录

- [1. 系统定位](#1-系统定位)
- [2. 核心职责](#2-核心职责)
- [3. 业务流程](#3-业务流程)
- [4. 数据模型](#4-数据模型)
- [5. 业务规则](#5-业务规则)

---

## 1. 系统定位

**仓库管理系统作为独立业务模块**，是整个 BRCGS 食品安全管理体系的**基础设施**。

### 1.1 核心优势

| 优势 | 说明 |
|------|------|
| **架构清晰** | 独立业务模块，不污染其他系统 |
| **分阶段实施** | MVP 手工录入，v2.0 对接金蝶 ERP |
| **统一待办** | 复用 TodoTask 系统 |
| **全链追溯** | 支持正向/反向追溯，满足 BRCGS 4 小时召回要求 |
| **数据闭环** | 仓库 ↔ 暂存间 ↔ 生产的完整数据流 |
| **灵活扩展** | 预留条形码字段，v2.0 可引入扫码功能 |

---

## 2. 核心职责

1. **物料管理**: 物料基础信息、批次管理、库存管理
2. **出入库管理**: 物料入库、领料出库、退料、报废
3. **批次追溯**: 原料批次 → 生产批次 → 成品批次的全链条追溯
4. **供应商管理**: 供应商信息、资质管理、绩效评估
5. **物料平衡校验**: 领料数量 vs 配方用量 vs 实际产量的平衡验证
6. **库存预警**: 物料临期预警、过期锁定

---

## 3. 业务流程

### 3.1 核心流程

```
1. 物料入库流程
   供应商送货 → 来料检验(IQC) → 检验合格 → 入库单 → 库存+

2. 领料出库流程
   创建领料单 → 选择批次(FIFO) → 审批 → 出库单 → 仓库库存- / 暂存间库存+

3. 暂存间盘点流程
   上班盘点(期初) → 记录物料批次数量 → 下班盘点(期末) → 计算实际消耗

4. 生产消耗流程
   生产开始 → 从暂存间领料 → 生产记录(四级文件) → 产品入库

5. 物料平衡校验流程
   产品入库 → 校验: 期初 + 领料 - 期末 ≈ 配方用量 × 产量 → 偏差预警

6. 退料流程
   发现质量问题 → 创建退料单 → 审批 → 入库单 → 仓库库存+

7. 报废流程
   物料过期/损坏 → 创建报废单 → 审批 → 库存- → 报废记录归档

8. 批次追溯流程
   反向追溯: 成品批次 → 生产批次 → 原料批次 → 供应商批次
   正向追溯: 供应商批次 → 原料批次 → 生产批次 → 成品批次
```

### 3.2 关键业务场景

**场景 1: 原料入库**
1. 供应商送货(高筋面粉 500kg, 批次: SUP-001-20240101)
2. 质量部 IQC 检验(抽检 5 袋)
3. 检验合格 → 系统自动创建入库单
4. 仓库管理员确认入库
5. 系统记录: MaterialBatch 表、StockRecord 表、Material 表

**场景 2: 批次追溯(反向)**
1. 客户投诉: 曲奇饼干批次 FG-P001-20240615-001 有异物
2. 质量部输入成品批次号查询
3. 系统自动追溯: 成品 → 生产 → 领料 → 原料 → 供应商
4. 生成追溯报告(PDF), 耗时 < 4 小时(满足 BRCGS 要求)

---

## 4. 数据模型

### 4.1 核心数据表（13 个）

**物料管理**:
1. Material - 物料基础信息表
2. MaterialBatch - 物料批次表
3. StockRecord - 库存记录表（出入库流水）

**出入库管理**:
4. MaterialRequisition - 领料单表
5. MaterialRequisitionItem - 领料明细表
6. MaterialReturn - 退料单表
7. MaterialScrap - 报废单表

**供应商管理**:
8. Supplier - 供应商表
9. SupplierQualification - 供应商资质表

**批次追溯**:
10. BatchTraceability - 批次追溯关系表

**物料平衡**:
11. MaterialBalance - 物料平衡记录表

**暂存间管理**:
12. StagingAreaStock - 暂存间库存表
13. StagingAreaRecord - 暂存间盘点记录表

### 4.2 物料批次表示例

```prisma
model MaterialBatch {
  id                  String   @id @default(cuid())
  materialId          String              // 物料 ID
  batchNumber         String   @unique    // 批次号(系统生成)
  supplierBatchNumber String?             // 供应商批次号
  supplierId          String?             // 供应商 ID
  productionDate      DateTime?           // 生产日期
  expiryDate          DateTime?           // 到期日期
  shelfLife           Int?                // 保质期(天)
  stockQuantity       Float    @default(0) // 批次库存数量
  barcode             String?             // 条形码(v2.0 扩展)
  status              String   @default("normal") // normal | expired | locked
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@map("material_batches")
}
```

---

## 5. 业务规则

| 规则编号 | 规则描述 | 实现方式 |
|---------|----------|----------|
| **BR-101** | 物料批次号唯一 | @unique 约束 |
| **BR-102** | 领料遵循 FIFO 规则（先进先出） | 系统推荐最旧批次 |
| **BR-103** | 过期物料自动锁定，不可领用 | status = expired, 前端禁用 |
| **BR-104** | 物料平衡偏差 > 5% 时预警 | 后端校验逻辑 |
| **BR-105** | 批次追溯必须 < 4 小时完成 | BRCGS 合规要求 |
| **BR-106** | 供应商批次号必须记录 | 必填字段 |
| **BR-107** | 领料单需审批 | 工作流引擎 |
| **BR-108** | 暂存间每日盘点 | 定时提醒 |

---

**本文档完成 ✅**
