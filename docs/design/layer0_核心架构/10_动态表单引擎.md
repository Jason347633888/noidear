# 动态表单引擎与记录管理（核心架构）

> **来源**: DESIGN.md Chapter 19 (第 9119-10741 行)  
> **文档版本**: 3.0  
> **最后更新**: 2026-02-14  
> **依赖章节**: [14_工作流引擎.md](14_工作流引擎.md)

---

## 目录

- [1. 系统定位与核心优势](#1-系统定位与核心优势)
- [2. 业务流程](#2-业务流程)
- [3. 数据模型设计](#3-数据模型设计)
- [4. 前端设计](#4-前端设计)
- [5. 防篡改机制设计](#5-防篡改机制设计)
- [6. 业务规则](#6-业务规则)
- [7. API 设计](#7-api-设计)
- [8. 开发工作量估算](#8-开发工作量估算)
- [9. 成功标准](#9-成功标准)

---

## 1. 系统定位与核心优势

### 1.1 系统定位

**动态表单引擎是整个数据电子化平台的核心基础设施**，解决"每家公司需求不同、记录文件种类繁多"的问题。

**核心职责**:
1. **记录模板管理**: 管理员可视化配置记录模板（低代码）
2. **动态表单渲染**: 根据模板动态渲染表单（PC + 移动端）
3. **记录实例管理**: 用户在线填写记录，数据库存储
4. **统一查询导出**: 所有四级记录文件统一查询/导出/打印
5. **审批流程集成**: 记录提交后自动触发审批流程
6. **PDF 导出**: 按需导出 PDF（外审需要）

---

### 1.2 核心优势

| 优势 | 说明 |
|------|------|
| **灵活配置** | 管理员可自己创建新的记录类型，不需要开发 |
| **多端统一** | PC + 移动端（小程序/H5/APP）统一渲染 |
| **数据电子化** | 数据存数据库，不是上传 PDF |
| **适应变化** | 适应不同公司需求，业务变化无需重新开发 |
| **审批集成** | 与工作流引擎无缝集成 |
| **移动端支持** | 现场填写、拍照、签名、离线填写 |

---

## 2. 业务流程

### 2.1 核心流程图

```
┌─────────────────────────────────────────────────────────────┐
│              动态表单引擎核心流程                               │
└─────────────────────────────────────────────────────────────┘

1. 管理员创建记录模板
   选择记录类型 → 拖拽字段 → 配置属性 → 配置逻辑 → 保存模板

2. 用户填写记录（PC/移动端）
   选择记录模板 → 动态渲染表单 → 在线填写 → 自动保存草稿

3. 提交审批（可选）
   提交记录 → 触发审批流程 → 生成待办任务 → 审批人审核

4. 审批通过
   记录状态更新 → 关闭待办任务 → 可导出 PDF

5. 统一查询
   按部门/类型/时间筛选 → 查看记录详情 → 导出/打印
```

---

### 2.2 关键业务场景

**场景 1: 管理员创建"清洁消毒记录"模板**

（详细内容略，参考原文档第 9193-9235 行）

**场景 2: 用户填写"清洁消毒记录"（移动端）**

（详细内容略，参考原文档第 9237-9264 行）

**场景 3: 审批人审核记录（PC 端）**

（详细内容略，参考原文档第 9266-9285 行）

---

## 3. 数据模型设计

### 3.1 核心数据表(3 个)

详见完整 Prisma Schema（参考原文档第 9294-9398 行）

**关键表**:
1. **RecordTemplate**: 记录模板表
2. **Record**: 记录实例表（通用）
3. **RecordChangeLog**: 记录变更历史表（BRCGS 合规：防篡改）

---

### 3.2 formSchema 字段结构

详见完整 TypeScript 类型定义（参考原文档第 9405-9495 行）

**支持的字段类型**（20+ 种）:
- text, number, textarea
- date, time, datetime
- select, multiselect, radio, checkbox
- cascade, tree
- upload, image, signature
- richtext, location, scan
- divider, title

---

### 3.3 formSchema 完整示例

详见完整示例（参考原文档第 9501-9724 行）:
1. 设备维保记录
2. 报废单

---

## 4. 前端设计

### 4.1 管理员端 - 表单设计器界面

详见完整 UI 布局（参考原文档第 9732-9773 行）

**三栏布局**:
- 左侧：字段库（基础字段 + 高级字段）
- 中间：表单预览区（拖拽式设计）
- 右侧：属性配置区（字段属性 + 显隐规则 + 联动规则）

---

### 4.2 用户端 - 动态表单渲染（PC）

详见完整 Vue 代码示例（参考原文档第 9840-10137 行）

**核心功能**:
- 根据 formSchema 动态渲染 20+ 种字段类型
- 支持字段显隐规则、联动规则、计算规则
- 支持实时校验、自动保存草稿
- 支持草稿保存和提交审批

---

## 5. 防篡改机制设计（BRCGS 合规核心）

### 5.1 问题背景

**BRCGS 审核员的质疑**：
> "如何证明这些记录是实时填写的，不是事后补填的？"
> "如何证明审批通过后的记录未被修改？"
> "如何证明电子签名是本人当时签署的？"

---

### 5.2 解决方案架构

**三层防护**:
1. **服务器时间戳强制覆盖**: 客户端时间 → 丢弃，服务器时间戳 → 写入 createdAt
2. **记录变更历史**: 记录状态 = approved 后，任何修改记录到 RecordChangeLog
3. **电子签名时间戳锁定**: 签名时锁定服务器时间戳 signatureTimestamp

详见完整架构设计（参考原文档第 10141-10426 行）

---

## 6. 业务规则

### 6.1 记录模板规则(BR-211 ~ BR-220)

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-211 | **模板编号唯一**: 每个模板的 code 必须唯一 | `RecordTemplate.code @unique` |
| BR-212 | **模板状态**: active(启用) / archived(归档) | `RecordTemplate.status` |
| BR-213 | **模板版本**: 支持版本管理，修改模板时生成新版本 | `RecordTemplate.version` |
| ... | ... | ... |

详见完整业务规则（参考原文档第 10428-10507 行）

---

### 6.2 记录实例规则(BR-221 ~ BR-230)

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-221 | **记录编号生成**: 格式 `{前缀}-{YYYYMMDD}-{序号}` | 后端自动生成 |
| BR-222 | **记录状态**: draft → submitted → approved/rejected | `Record.status` 状态机 |
| ... | ... | ... |

---

### 6.3 防篡改与合规规则（BR-251 ~ BR-260）⭐ BRCGS 核心要求

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-251 | **记录变更历史**: approved 后任何修改记录到 RecordChangeLog | 后端拦截器自动记录 |
| BR-254 | **服务器时间戳**: 记录创建/提交时间必须使用服务器时间 | 后端强制覆盖 createdAt |
| BR-255 | **时间校验**: 提交时间与服务器时间差超过 5 分钟，拒绝提交 | 后端 API 校验逻辑 |
| ... | ... | ... |

---

### 6.4 记录保留期限管理规则（BR-261 ~ BR-265）⭐ P0-5 修复

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-261 | **保留期限配置**: RecordTemplate 可配置保留年限 | `RecordTemplate.retentionYears` |
| BR-262 | **保留截止日期计算**: 自动计算 retentionUntil | 后端创建记录时自动计算 |
| ... | ... | ... |

---

## 7. API 设计

### 7.1 记录模板 API(6 个)

| 方法 | 路径 | 功能 |
|------|------|------|
| GET | `/api/record-templates` | 查询模板列表 |
| GET | `/api/record-templates/:id` | 查询模板详情 |
| POST | `/api/record-templates` | 创建模板 |
| PUT | `/api/record-templates/:id` | 更新模板 |
| POST | `/api/record-templates/:id/archive` | 归档模板 |
| GET | `/api/record-templates/:id/preview` | 预览模板 |

---

### 7.2 记录实例 API(6 个)

| 方法 | 路径 | 功能 |
|------|------|------|
| GET | `/api/records` | 查询记录列表 |
| GET | `/api/records/:id` | 查询记录详情 |
| POST | `/api/records` | 创建记录 |
| PUT | `/api/records/:id` | 更新记录（草稿） |
| POST | `/api/records/:id/submit` | 提交审批 |
| GET | `/api/records/:id/export-pdf` | 导出 PDF |

---

### 7.3 防篡改与审计 API（3 个）⭐ BRCGS 合规

| 方法 | 路径 | 功能 |
|------|------|------|
| GET | `/api/records/:id/change-logs` | 查询记录变更历史 |
| POST | `/api/records/:id/signature` | 保存电子签名（锁定时间戳） |
| PUT | `/api/records/:id/approved-modify` | 修改已审批记录（需特殊权限） |

详见完整 API 说明（参考原文档第 10510-10665 行）

---

## 8. 开发工作量估算

### 8.1 后端开发(5.5 周)

| 模块 | 工作量 | 说明 |
|------|--------|------|
| **记录模板管理** | 1 周 | RecordTemplate CRUD + 版本管理 |
| **记录实例管理** | 1 周 | Record CRUD + 草稿自动保存 |
| **防篡改机制** | 1 周 | RecordChangeLog + 时间戳校验 ⭐ |
| **PDF 导出** | 1 周 | pdfmake 生成 PDF |
| ... | ... | ... |

**后端合计: 5.5 周**

---

### 8.2 前端开发(6.5 周)

| 模块 | 工作量 | 说明 |
|------|--------|------|
| **表单设计器（PC）** | 2 周 | 拖拽式设计器 + 属性配置 |
| **动态表单渲染（PC）** | 1 周 | 根据 schema 动态渲染 20+ 字段类型 |
| **动态表单渲染（移动端）** | 1.5 周 | uniapp 实现动态渲染 |
| ... | ... | ... |

**前端合计: 6.5 周**

---

### 8.3 总工作量

**总计: 13.5 周（约 3.4 个月）**

**并行开发**(1 名后端 + 2 名前端): **约 6 周（1.5 个月）**

---

## 9. 成功标准

**记录模板管理**:
- ✅ 管理员可视化创建记录模板（拖拽式）
- ✅ 支持 20+ 种字段类型
- ✅ 支持字段显隐规则、联动规则、计算规则
- ✅ 支持模板版本管理

**动态表单渲染**:
- ✅ PC 端动态渲染表单（Element Plus）
- ✅ 移动端动态渲染表单（uniapp）
- ✅ 支持实时校验、自动保存草稿

**记录实例管理**:
- ✅ 用户在线填写记录
- ✅ 支持审批流程
- ✅ 支持导出 PDF/Excel

**防篡改机制**:
- ✅ 服务器时间戳强制覆盖客户端时间
- ✅ 时间差超过 5 分钟拒绝提交
- ✅ 已审批记录的修改记录变更历史
- ✅ 电子签名时间戳锁定
- ✅ 软删除保留数据

**BRCGS 审核通过标准**:
- ✅ 记录真实性可验证（服务器时间戳）
- ✅ 记录完整性可验证（变更历史完整）
- ✅ 责任人可追溯（签名时间戳 + 修改记录）

---

**本文档完成 ✅**
