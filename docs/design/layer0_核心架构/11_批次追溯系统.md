# 批次追溯系统（BRCGS 核心）

> **来源**: DESIGN.md 十九章补充 (第 10746-11100 行)  
> **文档版本**: 3.0  
> **最后更新**: 2026-02-14  
> **优先级**: 最高（BRCGS 认证核心要求）  
> **依赖章节**: [10_动态表单引擎.md](10_动态表单引擎.md)、仓库管理系统

---

## 目录

- [1. 系统定位与核心要求](#1-系统定位与核心要求)
- [2. 数据模型设计](#2-数据模型设计)
- [3. 追溯 API 示例](#3-追溯-api-示例)
- [4. 动态表单与批次关联](#4-动态表单与批次关联)
- [5. 业务规则](#5-业务规则)
- [6. 成功标准](#6-成功标准)

---

## 1. 系统定位与核心要求

### 1.1 BRCGS 批次追溯要求

**BRCGS 标准 3.9 批次追溯要求**:
- ✅ **4 小时追溯**: 任意成品批次能在 4 小时内追溯到所有原料批次
- ✅ **正向追溯**: 原料批次 → 生产批次 → 成品批次 → 客户
- ✅ **反向追溯**: 成品批次 → 生产批次 → 原料批次
- ✅ **完整链条**: 批次关联不能断裂，每个环节都有明确的批次号
- ✅ **可验证性**: 追溯报告格式规范，外审员可快速验证

---

### 1.2 架构决策：硬编码批次表 vs 动态表单

**最终决策**: ✅ **硬编码批次表 + 动态表单扩展**

| 数据类型 | 存储方式 | 原因 |
|---------|---------|------|
| 批次号 | 硬编码表 | 追溯主线，不可配置 |
| 批次关联关系 | 硬编码表 | 外键约束保证完整性 |
| 产品、原料基础信息 | 硬编码表 | 引用主数据 |
| 生产参数（温度、时间） | 动态表单 | 不同产品参数不同 |
| 质检指标 | 动态表单 | 不同产品标准不同 |
| 操作员签名、照片 | 动态表单 | 符合电子记录需求 |

**硬编码方案优势**:
1. **追溯稳定性**: 数据库外键约束保证追溯链不会断裂
2. **查询性能**: 直接 JOIN 查询，毫秒级响应（4 小时追溯要求）
3. **审核可信度**: 外审员更信任结构化的数据表
4. **数据完整性**: 禁止删除有关联的批次记录
5. **向后兼容**: 系统升级不影响历史追溯数据

---

## 2. 数据模型设计

### 2.1 核心批次表（5 个硬编码表）

详见完整 Prisma Schema（参考原文档第 10797-10952 行）

**关键表**:
1. **MaterialBatch**: 原料批次表（Chapter 17 仓库管理系统定义）
2. **ProductionBatch**: 生产批次表（核心追溯表）
3. **BatchMaterialUsage**: 批次物料使用表（关联原料批次和生产批次）
4. **FinishedGoodsBatch**: 成品批次表
5. **ShipmentItem**: 出库明细表（追溯到客户）

**关键外键约束**:
```prisma
// 所有批次关联都使用 onDelete: Restrict
productionBatch   ProductionBatch @relation(..., onDelete: Restrict)
materialBatch     MaterialBatch @relation(..., onDelete: Restrict)
finishedGoodsBatch FinishedGoodsBatch @relation(..., onDelete: Restrict)
```

---

### 2.2 批次号生成规则配置

```prisma
// 系统配置表（支持批次号格式自定义）
model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  label       String
  description String?
  type        String   @default("text")  // text | number | json | boolean
  category    String   @default("system") // system | batch | notification
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("system_configs")
}
```

**批次号格式配置示例**:
- `production_batch_number_format`: `"PB-{YYYYMMDD}-{序号}"`
- `material_batch_number_format`: `"MAT-{原料编号}-{YYYYMMDD}-{序号}"`
- `finished_goods_batch_number_format`: `"FG-{YYYYMMDD}-{序号}"` 或 `"same_as_production"`

---

## 3. 追溯 API 示例

### 3.1 反向追溯（成品 → 原料）

```
POST /api/trace/backward
Body: { finishedGoodsBatchNumber: "FG-20240615-001" }
```

**响应**:
```typescript
{
  "finishedGoodsBatch": { ... },
  "productionBatch": { ... },
  "materials": [
    { "materialName": "面粉", "batchNumber": "MAT-FLOUR-20240610-001", ... },
    { "materialName": "鸡蛋", "batchNumber": "SUPPLIER-EGG-20240614", ... }
  ],
  "relatedRecords": [ ... ],  // 生产记录（动态表单）
  "duration": "120ms"
}
```

---

### 3.2 正向追溯（原料 → 成品 → 客户）

```
POST /api/trace/forward
Body: { materialBatchNumber: "MAT-FLOUR-20240610-001" }
```

**响应**:
```typescript
{
  "materialBatch": { ... },
  "usedInProductions": [
    {
      "productionBatchNumber": "PB-20240615-001",
      "finishedGoods": [
        {
          "batchNumber": "FG-20240615-001",
          "shipments": [
            { "customerName": "沃尔玛", "quantity": 60 },
            { "customerName": "家乐福", "quantity": 40 }
          ]
        }
      ]
    }
  ]
}
```

---

## 4. 动态表单与批次关联

### 4.1 RecordTemplate 批次关联配置

```prisma
model RecordTemplate {
  // ...原有字段
  
  // 批次关联配置
  batchLinkEnabled Boolean  @default(false)       // 是否启用批次关联
  batchLinkType    String?                        // "production" | "finished_goods"
  batchLinkField   String?                        // 哪个字段存储批次号
}
```

---

### 4.2 Record 自动关联到批次

```prisma
model Record {
  // ...原有字段
  
  // 批次关联
  relatedBatchType   String?                      // "production" | "finished_goods"
  relatedBatchId     String?                      // 批次 ID
  relatedBatchNumber String?                      // 批次号（冗余，加速查询）
  
  productionBatch    ProductionBatch? @relation(...)
  finishedGoodsBatch FinishedGoodsBatch? @relation(...)
  
  @@index([relatedBatchNumber])
}
```

---

## 5. 业务规则

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-241 | **批次号唯一性**: 所有批次号必须全局唯一 | `@unique` 约束 |
| BR-242 | **批次号不可修改**: 批次创建后批次号不能修改 | 前端禁用 + 后端校验 |
| **BR-243 (P0-2 修复)** | **批次关联不可删除**: 有关联的批次不能删除，外键设置 `onDelete: Restrict` | Prisma 外键约束 |
| BR-244 | **4 小时追溯**: 任意成品批次能在 4 小时内完成追溯 | 数据库索引优化 |
| **BR-245 (P0-2 修复)** | **追溯链完整性**: 成品 → 生产 → 原料 链条不能断裂，所有外键必须有索引 | Prisma 外键约束 + 索引 |
| BR-246 | **批次号格式可配置**: 支持企业自定义批次号格式 | SystemConfig 配置 |
| BR-247 | **追溯权限控制**: 只有质量部 + 管理层可查看 | RBAC 权限 |
| BR-248 | **追溯报告导出**: 支持导出 PDF 格式 | pdfmake 生成 |

---

## 6. 成功标准

**批次追溯系统**:
- ✅ 原料入库自动创建 MaterialBatch
- ✅ 生产计划自动创建 ProductionBatch
- ✅ 领料完成自动关联 BatchMaterialUsage
- ✅ 成品入库自动创建 FinishedGoodsBatch
- ✅ 反向追溯：成品 → 原料（4 小时内完成）
- ✅ 正向追溯：原料 → 成品 → 客户
- ✅ 追溯报告 PDF 导出
- ✅ 动态表单记录自动关联到批次
- ✅ 批次号格式可配置
- ✅ 外键约束保证数据完整性

---

**本文档完成 ✅**
