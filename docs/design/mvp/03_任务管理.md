# 任务管理（四级文件填写任务）

> **来源**: DESIGN.md 第四章 4.6 节（任务分发）  
> **文档版本**: 1.0  
> **最后更新**: 2026-02-14  
> **实现状态**: ✅ 已实现（MVP Phase 5, 98.1% 完成）  
> **代码位置**: `server/src/modules/task/` + `client/src/views/task/`

---

## 目录

- [1. 功能概述](#1-功能概述)
- [2. 核心功能](#2-核心功能)
- [3. 任务流程](#3-任务流程)
- [4. 业务规则](#4-业务规则)
- [5. 数据模型](#5-数据模型)
- [6. API 设计](#6-api-设计)
- [7. 前端界面](#7-前端界面)

---

## 1. 功能概述

任务管理系统用于分发四级文件（记录表单）的填写任务给指定部门。

### 1.1 核心特性

- ✅ **任务分发**: 管理员/Leader 选择模板并分发给指定部门
- ✅ **部门执行**: 部门内任意一人都可填写
- ✅ **第一人锁定**: 第一人提交后任务锁定，其他人不可修改
- ✅ **截止日期**: 必填截止时间，逾期红色标记
- ✅ **任务筛选**: Tabs 切换（全部/待完成/已完成）
- ✅ **任务取消**: 发起人可取消任务

### 1.2 与审批流程的关系

```
任务流程：
1. 管理员/Leader 创建任务 → 分发给部门
2. 部门内任意一人填写数据 → 提交
3. 提交后自动触发审批流程（见 04_审批流程.md）
4. 审批通过后，任务状态变为"已完成"
```

---

## 2. 核心功能

### 2.1 任务管理功能

| 功能 | 说明 | 实现状态 |
|------|------|---------|
| **任务分发** | 发给部门，部门内人人都能看到 | ✅ 已实现 |
| **任务列表** | 显示模板名称、执行人、截止时间、状态 | ✅ 已实现 |
| **任务筛选** | Tabs切换（全部/待完成/已完成） | ✅ 已实现 |
| **任务填写** | 部门内任意一人填写 | ✅ 已实现 |
| **任务提交** | 第一人提交后锁定，不能修改 | ✅ 已实现 |
| **任务取消** | 发起人可以取消任务 | ✅ 已实现 |
| **任务转发** | 不支持 | ❌ MVP 未实现 |
| **逾期标记** | 红色标记 | ✅ 已实现 |

### 2.2 任务状态

| 状态 | 说明 | 可执行操作 |
|------|------|-----------|
| `pending` | 待完成 | 填写、提交、取消 |
| `completed` | 已完成 | 查看（只读） |
| `cancelled` | 已取消 | 查看（只读） |

---

## 3. 任务流程

### 3.1 任务分发流程

```
管理员/Leader:
1. 选择模板（如"生产记录表"）
2. 选择执行部门（如"生产部"）
3. 设置截止日期（如 2026-02-20）
4. 点击"分发任务"

系统:
1. 创建任务记录（task）
2. 发送站内消息通知部门内所有人
3. 任务显示在部门成员的"待完成"列表中
```

### 3.2 任务填写流程

```
部门成员（任意一人）:
1. 进入"我的任务"页面
2. 点击"填写"按钮
3. 根据模板字段填写数据
4. 点击"暂存"（草稿）或"提交"

系统:
- 暂存：数据保存为草稿，其他人仍可填写
- 提交：锁定任务，其他人不可再填写，触发审批流程
```

### 3.3 任务审批流程

```
提交后:
1. 系统自动创建审批流程（见 04_审批流程.md）
2. 审批人收到通知
3. 审批通过 → 任务状态变为"已完成"
4. 审批驳回 → 任务状态变为"待完成"，可重新填写
```

---

## 4. 业务规则

| 规则编号 | 规则描述 | 来源 |
|---------|----------|------|
| **BR-009** | 任务必须指定执行人，否则无法分发 | DESIGN.md 第五章 |
| **BR-004** | 四级文件（记录）填写后提交审批，审批通过后归档 | DESIGN.md 第五章 |
| **BR-005** | 模板停用后，不可再新建数据，历史数据可查询 | DESIGN.md 第五章 |

### 4.1 执行规则

- ✅ 部门内任意一人都可以填写
- ✅ 第一人提交后锁定（`submitter_id` 字段记录提交人）
- ✅ 锁定后其他人不可修改
- ✅ 截止日期必填
- ✅ 过期站内消息提醒

---

## 5. 数据模型

### 5.1 任务表 (tasks)

```sql
tasks (
  id          SnowflakeID   PRIMARY KEY,
  template_id SnowflakeID   REFERENCES templates(id), -- 使用的模板
  department_id SnowflakeID REFERENCES departments(id), -- 执行部门
  deadline    TIMESTAMP   NOT NULL,            -- 截止日期
  status      VARCHAR(20)  NOT NULL DEFAULT 'pending', -- pending/completed/cancelled
  creator_id  SnowflakeID   REFERENCES users(id),       -- 分发人
  created_at  TIMESTAMP   DEFAULT NOW(),
  updated_at  TIMESTAMP   DEFAULT NOW(),
  deleted_at  TIMESTAMP                              -- 软删除
);
```

### 5.2 任务记录表 (task_records)

```sql
task_records (
  id          SnowflakeID   PRIMARY KEY,
  task_id     SnowflakeID   REFERENCES tasks(id),
  template_id SnowflakeID   REFERENCES templates(id),
  data_json   JSONB         NOT NULL,            -- 填写数据
  status      VARCHAR(20)   NOT NULL DEFAULT 'pending', -- pending/submitted/approved/rejected
  submitter_id SnowflakeID  REFERENCES users(id),    -- 提交人（第一人提交后锁定）
  submitted_at TIMESTAMP,
  approver_id SnowflakeID   REFERENCES users(id),
  approved_at TIMESTAMP,
  created_at  TIMESTAMP   DEFAULT NOW(),
  updated_at  TIMESTAMP   DEFAULT NOW(),
  deleted_at  TIMESTAMP                              -- 软删除
);
```

**说明**: 每个任务只能有一条提交后的记录（第一人提交后锁定）

### 5.3 数据填写示例 (data_json)

```json
{
  "field_001": "面包",        // 产品名称
  "field_002": 1000,         // 生产数量
  "field_003": "2026-02-14", // 生产日期
  "field_004": "A类",        // 产品类型
  "field_005": "https://minio.example.com/images/product.jpg" // 产品图片
}
```

---

## 6. API 设计

### 6.1 任务 API

| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/v1/tasks` | GET | 获取任务列表（我的任务） |
| `/api/v1/tasks` | POST | 创建任务（分发） |
| `/api/v1/tasks/:id` | GET | 获取任务详情 |
| `/api/v1/tasks/:id` | PUT | 更新任务 |
| `/api/v1/tasks/:id/cancel` | POST | 取消任务 |
| `/api/v1/tasks/:id/submit` | POST | 提交任务（填写完成） |

### 6.2 分发任务 API

**请求**:
```http
POST /api/v1/tasks
Content-Type: application/json
Authorization: Bearer <token>

{
  "templateId": "tpl_789",
  "departmentId": "dept_123",
  "deadline": "2026-02-20T23:59:59Z"
}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "id": "task_456",
    "templateId": "tpl_789",
    "templateTitle": "生产记录表",
    "departmentId": "dept_123",
    "departmentName": "生产部",
    "deadline": "2026-02-20T23:59:59Z",
    "status": "pending",
    "creatorId": "user_001",
    "createdAt": "2026-02-14T10:00:00Z"
  }
}
```

### 6.3 提交任务 API

**请求**:
```http
POST /api/v1/tasks/:id/submit
Content-Type: application/json
Authorization: Bearer <token>

{
  "data": {
    "field_001": "面包",
    "field_002": 1000,
    "field_003": "2026-02-14"
  }
}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "taskId": "task_456",
    "recordId": "rec_789",
    "status": "submitted",
    "submitterId": "user_002",
    "submittedAt": "2026-02-14T14:00:00Z"
  },
  "message": "任务已提交，等待审批"
}
```

---

## 7. 前端界面

### 7.1 我的任务页面

**页面路由**: `/my-tasks`

**主要组件**:
- `TaskList.vue` - 任务列表组件
- `TaskForm.vue` - 动态表单填写组件
- `TaskDetail.vue` - 任务详情组件

**功能按钮**:
```
┌─────────────────────────────────────────────────────┐
│ 我的任务          [全部] [待完成] [已完成]          │
├─────────────────────────────────────────────────────┤
│ 模板名称      │ 执行部门 │ 截止时间   │ 状态   │ 操作 │
├─────────────────────────────────────────────────────┤
│ 生产记录表    │ 生产部   │ 2026-02-20 │ 待完成 │[填写]│
│ 检验记录表    │ 质量部   │ 2026-02-15 │ 已完成 │[查看]│
│ 清洁记录表    │ 生产部   │ 2026-02-10 │ 已逾期 │[填写]│ (红色)
└─────────────────────────────────────────────────────┘
```

### 7.2 任务填写页面

**页面布局**:
```
┌─────────────────────────────────────────────────────┐
│ 填写任务 - 生产记录表               [返回] [暂存]   │
├─────────────────────────────────────────────────────┤
│ 任务信息：                                           │
│ - 执行部门：生产部                                   │
│ - 截止时间：2026-02-20 23:59:59                     │
│ - 分发人：张三                                       │
│                                                     │
│ 填写内容：                                           │
│ ┌───────────────────────────────────────────────┐   │
│ │ *产品名称: [_____________________]            │   │
│ │ *生产数量: [_____]                            │   │
│ │ *生产日期: [2026-02-14 ▼]                     │   │
│ │  产品类型: [A类 ▼]                            │   │
│ │  产品图片: [选择文件]                          │   │
│ └───────────────────────────────────────────────┘   │
│                                                     │
│                      [暂存]  [提交审批]             │
└─────────────────────────────────────────────────────┘
```

### 7.3 操作按钮规则

| 状态 | 可见按钮 | 说明 |
|------|---------|------|
| `pending` | 填写、取消 | 待完成状态可操作 |
| `submitted` | 查看（只读） | 已提交等待审批 |
| `completed` | 查看（只读） | 已完成不可修改 |
| `cancelled` | 查看（只读） | 已取消不可修改 |

### 7.4 逾期标记规则

- ✅ 当前时间 > 截止时间 → 红色标记
- ✅ 截止时间 - 当前时间 < 24小时 → 黄色警告
- ✅ 逾期任务仍可填写，但会显著提示

---

**本文档完成 ✅**
