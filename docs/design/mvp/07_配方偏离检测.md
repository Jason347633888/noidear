# 配方偏离检测（Phase 7-8）

> **来源**: DESIGN.md 第十三章 13.1 节（Phase 7-8）  
> **文档版本**: 1.0  
> **最后更新**: 2026-02-14  
> **实现状态**: ✅ 已实现（MVP Phase 7-8, 98.1% 完成）  
> **代码位置**: `server/src/modules/deviation/` + `client/src/views/statistics/`

---

## 目录

- [1. 功能概述](#1-功能概述)
- [2. 核心功能](#2-核心功能)
- [3. 偏离检测流程](#3-偏离检测流程)
- [4. 业务规则](#4-业务规则)
- [5. 数据模型](#5-数据模型)

---

## 1. 功能概述

配方偏离检测系统，用于自动检测生产记录填写值是否偏离配方标准值。

### 1.1 核心特性

- ✅ **公差定义**: 模板字段支持范围公差（±5g）和百分比公差（±5%）
- ✅ **实时检测**: 填写时实时显示是否偏离
- ✅ **强制说明**: 偏离时弹窗强制填写原因
- ✅ **偏离报告**: 自动生成偏离报告
- ✅ **版本锁定**: 配方更新后，已提交记录不受影响
- ✅ **额外审批**: 偏离记录触发2级审批流程

---

## 2. 核心功能

### 2.1 配方公差定义

**支持的公差类型**:

| 公差类型 | 配置参数 | 示例 | 计算公式 |
|---------|---------|------|---------|
| **范围公差** | min, max | 175°C ~ 185°C | 偏离 = (实际值 < min) OR (实际值 > max) |
| **百分比公差** | percentage | ±5% | 偏离率 = (实际值 - 期望值) / 期望值 * 100% |

**模板配置示例**:
```json
{
  "id": "field_001",
  "type": "number",
  "label": "温度",
  "tolerance": {
    "type": "range",      // range | percentage
    "min": 175,
    "max": 185
  }
}
```

### 2.2 自动偏离检测

**检测时机**:
- ✅ 填写时：实时检测，前端显示（✅正常 / ❌偏离）
- ✅ 提交时：后端验证，生成偏离报告

**检测逻辑**:
```typescript
function checkDeviation(field, actualValue) {
  if (!field.tolerance) return { isDeviation: false }
  
  if (field.tolerance.type === 'range') {
    const isDeviation = actualValue < field.tolerance.min || 
                       actualValue > field.tolerance.max
    const deviationAmount = Math.min(
      Math.abs(actualValue - field.tolerance.min),
      Math.abs(actualValue - field.tolerance.max)
    )
    return { isDeviation, deviationAmount }
  }
  
  if (field.tolerance.type === 'percentage') {
    const expectedValue = (field.tolerance.min + field.tolerance.max) / 2
    const deviationRate = (actualValue - expectedValue) / expectedValue * 100
    const isDeviation = Math.abs(deviationRate) > field.tolerance.percentage
    return { isDeviation, deviationRate }
  }
}
```

### 2.3 偏离报告生成

**触发时机**: 员工提交包含偏离的任务记录时

**报告内容**:

| 字段 | 说明 | 示例 |
|------|------|------|
| recordId | 任务记录ID | rec_123 |
| fieldName | 偏离字段名称 | temperature |
| expectedValue | 期望值（配方值） | 180°C |
| actualValue | 实际值（填写值） | 190°C |
| deviationAmount | 偏离量（绝对值） | 5°C |
| reason | 偏离原因（员工填写） | 生产线温度控制器故障，已报修 |
| status | 报告状态 | pending（待审批）|
| reportedAt | 报告时间 | 2026-02-05 14:30:00 |

---

## 3. 偏离检测流程

### 3.1 正常流程（无偏离）

```
员工填写记录
  ↓
所有数值在公差范围内
  ↓
提交
  ↓
触发单级审批流程（见 04_审批流程.md）
  ↓
审批通过 → 任务完成
```

### 3.2 偏离流程

```
员工填写记录
  ↓
部分数值偏离公差范围（实时标红）
  ↓
点击"提交"
  ↓
弹窗强制填写偏离原因（每个偏离字段一个原因）
  ↓
生成偏离报告（DeviationReport 表）
  ↓
触发2级审批流程（主管 → 质量主管）
  ↓
审批通过 → 任务完成
审批拒绝 → 任务回到草稿，可修改后重新提交
```

---

## 4. 业务规则

| 规则编号 | 规则描述 | 来源 |
|---------|----------|------|
| **BR-017** | 数值型字段可配置公差（范围公差 or 百分比公差），非数值型字段不支持 | DESIGN.md 13.1.4 |
| **BR-018** | 偏离检测结果实时显示，不阻塞填写 | DESIGN.md 13.1.3.2 |
| **BR-019** | 提交时若有偏离，强制弹窗填写原因（每个偏离字段一个原因） | DESIGN.md 13.1.3.2 |
| **BR-020** | 偏离原因最少10个字符，最多500个字符 | DESIGN.md 13.1.3.2 |
| **BR-021** | 一个任务记录可以包含多个偏离字段，每个字段生成一条偏离报告 | DESIGN.md 13.1.3.3 |
| **BR-022** | 偏离报告不可修改，只能查看和审批 | DESIGN.md 13.1.3.3 |
| **BR-023** | 员工提交记录时，系统自动锁定配方版本号 | DESIGN.md 13.1.3.4 |
| **BR-024** | 提交后的记录，版本号永久锁定，不可修改 | DESIGN.md 13.1.3.4 |

---

## 5. 数据模型

### 5.1 偏离报告表 (deviation_reports)

```sql
deviation_reports (
  id          SnowflakeID   PRIMARY KEY,
  record_id   SnowflakeID   REFERENCES task_records(id),
  template_id SnowflakeID   REFERENCES templates(id),
  field_name  VARCHAR(100)  NOT NULL,            -- 偏离字段名称
  expected_value   VARCHAR(100),                  -- 期望值
  actual_value     VARCHAR(100),                  -- 实际值
  tolerance_min    DECIMAL(10,2),                 -- 公差最小值
  tolerance_max    DECIMAL(10,2),                 -- 公差最大值
  deviation_amount DECIMAL(10,2),                 -- 偏离量
  deviation_rate   DECIMAL(5,2),                  -- 偏离率（%）
  reason      TEXT          NOT NULL,             -- 偏离原因
  status      VARCHAR(20)   NOT NULL DEFAULT 'pending', -- pending/approved/rejected
  reported_by SnowflakeID   REFERENCES users(id),
  reported_at TIMESTAMP   DEFAULT NOW(),
  created_at  TIMESTAMP   DEFAULT NOW(),
  updated_at  TIMESTAMP   DEFAULT NOW()
);
```

### 5.2 任务记录表扩展字段

```sql
task_records (
  -- ...原有字段
  
  has_deviation      BOOLEAN  DEFAULT FALSE,      -- 是否包含偏离
  deviation_count    INT      DEFAULT 0,          -- 偏离字段数量
  related_template_version DECIMAL(3,1),          -- 锁定的配方版本号
);
```

---

**本文档完成 ✅**
