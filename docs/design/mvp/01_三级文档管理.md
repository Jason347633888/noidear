# 三级文档管理（MVP 核心功能）

> **来源**: DESIGN.md 第三章（文档分级体系）+ 第四章（核心功能模块）  
> **文档版本**: 1.0  
> **最后更新**: 2026-02-14  
> **实现状态**: ✅ 已实现（MVP Phase 2, 98.1% 完成）  
> **代码位置**: `server/src/modules/document/` + `client/src/views/document/`

---

## 目录

- [1. 功能概述](#1-功能概述)
- [2. 四级文件定义](#2-四级文件定义)
- [3. 核心功能](#3-核心功能)
- [4. 业务规则](#4-业务规则)
- [5. 数据模型](#5-数据模型)
- [6. API 设计](#6-api-设计)
- [7. 前端界面](#7-前端界面)

---

## 1. 功能概述

一级/二级/三级文件管理系统，支持：
- **文件上传**: 支持 PDF、Word、Excel 格式，最大 10MB
- **版本控制**: 修改后自动版本号递增（1.0 → 1.1）
- **审批流程**: 上传 → 提交审批 → 通过 → 发布
- **文件下载**: 权限控制，只有授权用户可下载
- **文件预览**: 原生 PDF 预览（PdfViewer.vue 组件）

### 1.1 与四级文件的区别

| 项目 | 一/二/三级文件 | 四级文件 |
|------|---------------|----------|
| **创建方式** | 上传文件 | 创建表单模板 |
| **文件类型** | PDF/Word/Excel | 无文件，纯数据 |
| **审批流程** | 上传后提交审批 | 模板创建后直接发布 |
| **填写方式** | - | 任务分发 → 填写 → 审批 |
| **存储方式** | MinIO 对象存储 | PostgreSQL JSON字段 |

---

## 2. 四级文件定义

### 2.1 文件级别说明

| 级别 | 文件类型 | 说明 | 上传/创建方式 | 审批流程 |
|------|----------|------|---------------|----------|
| **一级** | 管理手册 | 质量方针、目标 | 上传文件（PDF/Word/Excel） | 上传→提交审批→通过→发布 |
| **二级** | 程序文件 | 管理制度、流程 | 上传文件（PDF/Word/Excel） | 上传→提交审批→通过→发布 |
| **三级** | 作业指导书 | 操作规范、标准 | 上传文件（PDF/Word/Excel） | 上传→提交审批→通过→发布 |
| **四级** | 记录表单 | 填写记录、证据 | 创建表单模板 | 创建模板→发布→任务分发→填写→审批 |

### 2.2 编号规则

**编号格式**: `{级别}-{部门代码}-{序号}`

**示例**:
```
1-RD-001    （一级文件 - 研发部）
2-RD-001    （二级文件 - 研发部）
3-RD-001    （三级文件 - 研发部）
4-RD-001    （四级文件 - 研发部）
```

**编号规则**:
- ✅ 文件编号生成后不能修改
- ✅ 编号删除后记录待补齐，下次新建时优先使用（BR-008）
- ✅ 不同级别的文件使用不同的编号序列
- ✅ 同一级别内文件编号唯一（BR-001）

---

## 3. 核心功能

### 3.1 文件管理功能

| 功能 | 说明 | 实现状态 |
|------|------|---------|
| **文件上传** | 支持拖拽、批量上传 | ✅ 已实现 |
| **文件列表** | 显示编号、名称、状态、创建人、创建时间 | ✅ 已实现 |
| **文件搜索** | 支持名称和编号搜索 | ✅ 已实现 |
| **文件排序** | 支持创建时间、编号排序 | ✅ 已实现 |
| **文件删除** | 草稿/待审批可删；已发布不能删除只能停用；停用后可彻底删除 | ✅ 已实现 |
| **文件下载** | 有权限才能下载 | ✅ 已实现 |
| **版本管理** | 修改后自动+版本号，旧版本可查看但不能下载 | ✅ 已实现 |
| **版本回滚** | MVP 不支持 | ❌ 未实现 |

### 3.2 文件类型与大小限制

- **支持类型**: PDF、Word、Excel
- **单文件最大**: 10MB
- **文件名**: 需要填写，可重复时提示用户修改

### 3.3 文件状态

| 状态 | 说明 | 可执行操作 |
|------|------|-----------|
| `draft` | 草稿 | 编辑、删除、提交审批 |
| `under_review` | 审批中 | 查看、撤回 |
| `approved` | 审批通过 | 查看、下载、发布 |
| `current` | 当前版本 | 查看、下载、归档、作废 |
| `archived` | 已归档 | 查看（只读） |
| `obsolete` | 已作废 | 查看（只读） |

---

## 4. 业务规则

| 规则编号 | 规则描述 | 来源 |
|---------|----------|------|
| **BR-001** | 编号规则配置后，新文件自动按规则生成文件编号 | DESIGN.md 第五章 |
| **BR-002** | 一级/二级/三级文件创建后必须提交审批，不审批不可发布 | DESIGN.md 第五章 |
| **BR-006** | 文件提交后不允许修改，只能查看或撤回 | DESIGN.md 第五章 |
| **BR-007** | 文件名称同级别内不可重复 | DESIGN.md 第五章 |
| **BR-008** | 编号删除后，系统记录待补齐编号，下次新建时优先使用 | DESIGN.md 第五章 |

---

## 5. 数据模型

### 5.1 文档表 (documents)

```sql
documents (
  id          SnowflakeID   PRIMARY KEY,
  level       INT           NOT NULL,            -- 1/2/3级
  number      VARCHAR(50)   UNIQUE NOT NULL,     -- 文件编号
  title       VARCHAR(200)  NOT NULL,            -- 文件标题
  file_path   VARCHAR(500)  NOT NULL,            -- MinIO路径
  file_name   VARCHAR(200)  NOT NULL,            -- 原始文件名
  file_size   BIGINT        NOT NULL,            -- 文件大小
  file_type   VARCHAR(50)   NOT NULL,            -- 文件类型
  version     DECIMAL(3,1)  NOT NULL DEFAULT 1.0, -- 版本号
  status      VARCHAR(20)   NOT NULL,            -- draft/under_review/approved/current/archived/obsolete
  creator_id  SnowflakeID   REFERENCES users(id),
  approver_id SnowflakeID   REFERENCES users(id),    -- 审批人
  approved_at TIMESTAMP,                              -- 审批时间

  -- P0-1 修复：文档归档/作废流程
  archive_reason    VARCHAR(500),                     -- 归档/作废原因
  archived_at       TIMESTAMP,                        -- 归档时间
  archived_by       SnowflakeID   REFERENCES users(id), -- 归档人
  obsolete_reason   VARCHAR(500),                     -- 作废原因
  obsoleted_at      TIMESTAMP,                        -- 作废时间
  obsoleted_by      SnowflakeID   REFERENCES users(id), -- 作废人

  created_at  TIMESTAMP   DEFAULT NOW(),
  updated_at  TIMESTAMP   DEFAULT NOW(),
  deleted_at  TIMESTAMP                              -- 软删除
);
```

### 5.2 文档版本历史表 (document_versions)

```sql
document_versions (
  id          SnowflakeID   PRIMARY KEY,
  document_id SnowflakeID   REFERENCES documents(id),
  version     DECIMAL(3,1)  NOT NULL,
  file_path   VARCHAR(500)  NOT NULL,
  file_name   VARCHAR(200)  NOT NULL,
  file_size   BIGINT        NOT NULL,
  creator_id  SnowflakeID   REFERENCES users(id),
  created_at  TIMESTAMP   DEFAULT NOW()
);
```

### 5.3 编号规则表 (number_rules)

```sql
number_rules (
  id              SnowflakeID   PRIMARY KEY,
  level           INT           NOT NULL,        -- 1/2/3/4级
  department_id   SnowflakeID   REFERENCES departments(id),
  sequence        INT           NOT NULL DEFAULT 0,  -- 当前序号
  created_at      TIMESTAMP   DEFAULT NOW(),
  updated_at      TIMESTAMP   DEFAULT NOW()
);
```

---

## 6. API 设计

### 6.1 文档 API

| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/v1/documents/level/:level` | GET | 获取指定级别文档列表 |
| `/api/v1/documents` | POST | 上传文档 |
| `/api/v1/documents/:id` | GET | 获取文档详情 |
| `/api/v1/documents/:id` | PUT | 更新文档 |
| `/api/v1/documents/:id` | DELETE | 删除文档（软删除） |
| `/api/v1/documents/:id/download` | GET | 下载文档 |
| `/api/v1/documents/:id/versions` | GET | 获取版本历史 |

### 6.2 上传文档 API

**请求**:
```http
POST /api/v1/documents
Content-Type: multipart/form-data
Authorization: Bearer <token>

{
  "level": 1,
  "title": "质量手册 V2.0",
  "file": <binary>,
  "departmentId": "dept_123"
}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "id": "doc_456",
    "number": "1-RD-001",
    "title": "质量手册 V2.0",
    "level": 1,
    "version": 1.0,
    "status": "draft",
    "filePath": "documents/1-RD-001/v1.0/quality-manual.pdf",
    "fileSize": 2048576,
    "fileType": "application/pdf",
    "createdAt": "2026-02-14T10:00:00Z"
  }
}
```

---

## 7. 前端界面

### 7.1 文档列表页面

**页面路由**: `/documents/level1` | `/documents/level2` | `/documents/level3`

**主要组件**:
- `DocumentList.vue` - 文档列表组件
- `PdfViewer.vue` - PDF 预览组件
- `FileUpload.vue` - 文件上传组件

**功能按钮**:
```
┌─────────────────────────────────────────────────────┐
│ 一级文件列表               [+ 上传文件] [刷新]       │
├─────────────────────────────────────────────────────┤
│ 搜索: [_________________]  部门: [全部▼]  状态: [全部▼] │
├─────────────────────────────────────────────────────┤
│ 编号        │ 标题          │ 版本 │ 状态   │ 操作 │
├─────────────────────────────────────────────────────┤
│ 1-RD-001   │ 质量手册V2.0  │ 1.0  │ 草稿   │[审][删]│
│ 1-RD-002   │ 质量方针      │ 2.1  │ 已发布 │[查][下]│
└─────────────────────────────────────────────────────┘
```

### 7.2 操作按钮规则

| 状态 | 可见按钮 | 说明 |
|------|---------|------|
| `draft` | 提交审批、编辑、删除 | 草稿状态可操作 |
| `under_review` | 撤回、查看 | 审批中只能撤回 |
| `approved` | 发布、查看、下载 | 审批通过可发布 |
| `current` | 归档、作废、查看、下载 | 当前版本只能归档或作废 |
| `archived` | 查看（只读） | 已归档不可修改 |
| `obsolete` | 查看（只读） | 已作废不可修改 |

---

**本文档完成 ✅**
