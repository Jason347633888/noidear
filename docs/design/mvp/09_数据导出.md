# 数据导出（Phase 9）

> **来源**: DESIGN.md 第十三章（Phase 9）  
> **文档版本**: 1.0  
> **最后更新**: 2026-02-14  
> **实现状态**: ✅ 已实现（MVP Phase 9, 98.1% 完成）  
> **代码位置**: `server/src/modules/export/`

---

## 1. 功能概述

Excel 批量导出功能，支持导出文档列表、任务记录、偏离报告。

### 1.1 核心特性

- ✅ **Excel 导出**: 使用 ExcelJS 4.4+ 生成 Excel 文件
- ✅ **动态列支持**: 根据模板字段动态生成列
- ✅ **批量导出**: 支持勾选多条记录批量导出
- ✅ **数据筛选**: 导出前可筛选数据
- ✅ **格式化**: 自动格式化日期、数值

---

## 2. 导出功能

### 2.1 支持的导出类型

| 导出类型 | 说明 | API 端点 |
|---------|------|---------|
| **文档列表** | 导出一/二/三级文件列表 | `GET /api/v1/export/documents` |
| **任务记录** | 导出四级文件填写记录 | `GET /api/v1/export/task-records` |
| **偏离报告** | 导出偏离报告 | `GET /api/v1/export/deviation-reports` |

### 2.2 导出 API

**请求**:
```http
GET /api/v1/export/documents?level=1&status=current
Authorization: Bearer <token>
```

**响应**:
```http
Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
Content-Disposition: attachment; filename="documents_20260214.xlsx"

<binary data>
```

### 2.3 Excel 格式示例

**文档列表导出格式**:

| 编号 | 标题 | 级别 | 状态 | 版本 | 创建人 | 创建时间 |
|------|------|------|------|------|--------|----------|
| 1-RD-001 | 质量手册 V2.0 | 1 | 已发布 | 1.0 | 张三 | 2026-02-14 |
| 1-RD-002 | 质量方针 | 1 | 已发布 | 2.1 | 李四 | 2026-02-13 |

**任务记录导出格式（动态列）**:

| 任务ID | 模板名称 | 产品名称 | 生产数量 | 生产日期 | 提交人 | 提交时间 |
|--------|---------|---------|---------|---------|--------|----------|
| task_001 | 生产记录表 | 面包 | 1000 | 2026-02-14 | 张三 | 2026-02-14 14:00 |
| task_002 | 生产记录表 | 蛋糕 | 500 | 2026-02-14 | 李四 | 2026-02-14 15:00 |

---

## 3. 代码示例

```typescript
import * as ExcelJS from 'exceljs'

export async function exportDocuments(filters) {
  const workbook = new ExcelJS.Workbook()
  const worksheet = workbook.addWorksheet('文档列表')
  
  // 设置列
  worksheet.columns = [
    { header: '编号', key: 'number', width: 15 },
    { header: '标题', key: 'title', width: 30 },
    { header: '级别', key: 'level', width: 10 },
    { header: '状态', key: 'status', width: 15 },
    { header: '版本', key: 'version', width: 10 },
    { header: '创建人', key: 'creator', width: 15 },
    { header: '创建时间', key: 'createdAt', width: 20 }
  ]
  
  // 查询数据
  const documents = await prisma.document.findMany({ where: filters })
  
  // 添加行
  documents.forEach(doc => {
    worksheet.addRow({
      number: doc.number,
      title: doc.title,
      level: doc.level,
      status: doc.status,
      version: doc.version,
      creator: doc.creator.name,
      createdAt: doc.createdAt.toISOString()
    })
  })
  
  // 生成 Excel 文件
  return await workbook.xlsx.writeBuffer()
}
```

---

**本文档完成 ✅**
