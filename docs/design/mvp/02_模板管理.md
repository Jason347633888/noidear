# 模板管理（四级文件模板）

> **来源**: DESIGN.md 第四章 4.5 节（四级模板管理）  
> **文档版本**: 1.0  
> **最后更新**: 2026-02-14  
> **实现状态**: ✅ 已实现（MVP Phase 4, 98.1% 完成）  
> **代码位置**: `server/src/modules/template/` + `client/src/views/template/`

---

## 目录

- [1. 功能概述](#1-功能概述)
- [2. 核心功能](#2-核心功能)
- [3. 字段类型](#3-字段类型)
- [4. 业务规则](#4-业务规则)
- [5. 数据模型](#5-数据模型)
- [6. API 设计](#6-api-设计)
- [7. 前端界面](#7-前端界面)

---

## 1. 功能概述

四级文件模板管理系统，用于创建可复用的记录表单模板。

### 1.1 核心特性

- ✅ **Excel 上传解析**: 上传 Excel 自动解析为模板字段
- ✅ **手动创建**: 可视化拖拽式字段配置
- ✅ **动态字段**: 支持 20+ 种字段类型（文本、数值、日期、下拉等）
- ✅ **字段排序**: 支持拖拽排序（sortablejs）
- ✅ **模板复制**: 快速基于已有模板创建新模板
- ✅ **版本管理**: 修改模板时版本号自动递增

### 1.2 与一/二/三级文件的区别

| 项目 | 一/二/三级文件 | 四级文件（模板） |
|------|---------------|------------------|
| **存储方式** | 上传文件（PDF/Word/Excel） | 数据库 JSON 字段 |
| **审批流程** | 上传后需审批 | 创建后直接发布，无需审批 |
| **使用方式** | 下载查看 | 任务分发 → 填写数据 |
| **版本控制** | MinIO 存储多版本 | 数据库记录版本 |

---

## 2. 核心功能

### 2.1 模板管理功能

| 功能 | 说明 | 实现状态 |
|------|------|---------|
| **模板创建** | Excel上传解析 / 手动创建 | ✅ 已实现 |
| **模板字段** | 文本、长文本、数值、日期、下拉、是/否 | ✅ 已实现（20+ 字段类型） |
| **字段排序** | 支持拖拽排序 | ✅ 已实现（sortablejs） |
| **字段默认值** | 支持设置默认值 | ✅ 已实现 |
| **模板复制** | 支持复制模板 | ✅ 已实现 |
| **模板列表** | 显示编号、名称、版本、创建人、创建时间 | ✅ 已实现 |
| **模板筛选** | 支持筛选 | ✅ 已实现 |
| **模板停用** | 停用后已分发任务不受影响 | ✅ 已实现 |
| **模板删除** | 支持删除 | ✅ 已实现 |

### 2.2 模板状态

| 状态 | 说明 | 可执行操作 |
|------|------|-----------|
| `active` | 启用中 | 编辑、停用、删除、分发任务 |
| `inactive` | 已停用 | 查看、启用、删除 |

**停用规则（BR-005）**:
- ✅ 模板停用后，不可再新建数据
- ✅ 历史数据可查询
- ✅ 已分发任务不受影响

---

## 3. 字段类型

### 3.1 支持的字段类型（20+ 种）

| 字段类型 | 说明 | 前端组件 | 数据存储 |
|----------|------|---------|----------|
| **文本** | 单行文本 | `<el-input>` | string |
| **长文本** | 多行文本 | `<el-input type="textarea">` | string |
| **数值** | 数字输入 | `<el-input-number>` | number |
| **日期** | 日期选择 | `<el-date-picker>` | ISO 8601 |
| **时间** | 时间选择 | `<el-time-picker>` | string |
| **日期时间** | 日期时间选择 | `<el-date-picker type="datetime">` | ISO 8601 |
| **下拉** | 单选下拉 | `<el-select>` | string |
| **多选** | 多选下拉 | `<el-select multiple>` | string[] |
| **单选框** | 单选按钮 | `<el-radio-group>` | string |
| **复选框** | 多选复选框 | `<el-checkbox-group>` | string[] |
| **是/否** | 布尔选择 | `<el-switch>` | boolean |
| **上传** | 文件上传 | `<el-upload>` | string (MinIO路径) |
| **图片** | 图片上传 | `<el-upload accept="image/*">` | string (MinIO路径) |
| **签名** | 手写签名 | 手写签名组件 | base64 |
| **富文本** | 富文本编辑 | Tiptap 编辑器 | JSON |
| **位置** | 地理位置 | 地图选点组件 | { lat, lng } |
| **扫码** | 二维码/条形码 | 扫码组件 | string |
| **级联选择** | 级联选择器 | `<el-cascader>` | string[] |
| **树选择** | 树形选择 | `<el-tree-select>` | string |
| **分割线** | 分隔符 | `<el-divider>` | - |
| **标题** | 章节标题 | `<h3>` | - |

### 3.2 字段配置（JSON Schema）

```typescript
interface TemplateField {
  id: string              // 字段 ID
  type: string            // 字段类型（text/number/date...）
  label: string           // 字段标签
  placeholder?: string    // 输入提示
  required: boolean       // 是否必填
  defaultValue?: any      // 默认值
  validation?: {
    min?: number          // 最小值（数值/日期）
    max?: number          // 最大值（数值/日期）
    pattern?: string      // 正则验证
    message?: string      // 验证失败提示
  }
  options?: string[]      // 下拉/单选/多选的选项
  order: number           // 排序顺序
}
```

**示例**:
```json
{
  "id": "field_001",
  "type": "text",
  "label": "产品名称",
  "placeholder": "请输入产品名称",
  "required": true,
  "validation": {
    "min": 2,
    "max": 100,
    "message": "产品名称长度为 2-100 字符"
  },
  "order": 1
}
```

---

## 4. 业务规则

| 规则编号 | 规则描述 | 来源 |
|---------|----------|------|
| **BR-003** | 四级文件（模板）创建后直接发布，无需审批 | DESIGN.md 第五章 |
| **BR-004** | 四级文件（记录）填写后提交审批，审批通过后归档 | DESIGN.md 第五章 |
| **BR-005** | 模板停用后，不可再新建数据，历史数据可查询 | DESIGN.md 第五章 |

---

## 5. 数据模型

### 5.1 模板表 (templates)

```sql
templates (
  id          SnowflakeID   PRIMARY KEY,
  level       INT           NOT NULL DEFAULT 4,  -- 固定为 4 级
  number      VARCHAR(50)   UNIQUE NOT NULL,     -- 模板编号
  title       VARCHAR(200)  NOT NULL,            -- 模板标题
  fields_json JSONB         NOT NULL,            -- 字段配置（TemplateField[]）
  version     DECIMAL(3,1)  NOT NULL DEFAULT 1.0, -- 版本号
  status      VARCHAR(20)   NOT NULL DEFAULT 'active', -- active/inactive
  creator_id  SnowflakeID   REFERENCES users(id),
  created_at  TIMESTAMP   DEFAULT NOW(),
  updated_at  TIMESTAMP   DEFAULT NOW(),
  deleted_at  TIMESTAMP                              -- 软删除
);
```

### 5.2 字段配置示例 (fields_json)

```json
[
  {
    "id": "field_001",
    "type": "text",
    "label": "产品名称",
    "required": true,
    "order": 1
  },
  {
    "id": "field_002",
    "type": "number",
    "label": "生产数量",
    "required": true,
    "validation": { "min": 1 },
    "order": 2
  },
  {
    "id": "field_003",
    "type": "date",
    "label": "生产日期",
    "required": true,
    "defaultValue": "{{today}}",
    "order": 3
  },
  {
    "id": "field_004",
    "type": "select",
    "label": "产品类型",
    "required": true,
    "options": ["A类", "B类", "C类"],
    "order": 4
  }
]
```

---

## 6. API 设计

### 6.1 模板 API

| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/v1/templates` | GET | 获取模板列表 |
| `/api/v1/templates` | POST | 创建模板 |
| `/api/v1/templates/:id` | GET | 获取模板详情 |
| `/api/v1/templates/:id` | PUT | 更新模板 |
| `/api/v1/templates/:id` | DELETE | 删除模板 |
| `/api/v1/templates/:id/copy` | POST | 复制模板 |
| `/api/v1/templates/:id/toggle-status` | POST | 启用/停用模板 |

### 6.2 创建模板 API

**请求**:
```http
POST /api/v1/templates
Content-Type: application/json
Authorization: Bearer <token>

{
  "title": "生产记录表",
  "departmentId": "dept_123",
  "fields": [
    {
      "type": "text",
      "label": "产品名称",
      "required": true,
      "order": 1
    },
    {
      "type": "number",
      "label": "生产数量",
      "required": true,
      "validation": { "min": 1 },
      "order": 2
    }
  ]
}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "id": "tpl_789",
    "number": "4-RD-001",
    "title": "生产记录表",
    "version": 1.0,
    "status": "active",
    "fields": [ ... ],
    "createdAt": "2026-02-14T10:00:00Z"
  }
}
```

---

## 7. 前端界面

### 7.1 模板列表页面

**页面路由**: `/templates`

**主要组件**:
- `TemplateList.vue` - 模板列表组件
- `TemplateEditor.vue` - 模板编辑器（拖拽式）
- `FieldConfig.vue` - 字段配置组件

**功能按钮**:
```
┌─────────────────────────────────────────────────────┐
│ 四级模板管理               [+ 新建模板] [刷新]       │
├─────────────────────────────────────────────────────┤
│ 搜索: [_________________]  状态: [全部▼]            │
├─────────────────────────────────────────────────────┤
│ 编号        │ 标题          │ 版本 │ 状态   │ 操作 │
├─────────────────────────────────────────────────────┤
│ 4-RD-001   │ 生产记录表    │ 1.0  │ 启用   │[编][停][删][复制][分发]│
│ 4-RD-002   │ 检验记录表    │ 2.1  │ 停用   │[查][启][删]│
└─────────────────────────────────────────────────────┘
```

### 7.2 模板编辑器界面

**布局**（三栏）:
```
┌─────────────────────────────────────────────────────────┐
│ 字段库        │    预览区域        │    属性配置          │
│              │                    │                      │
│ [文本]        │ 产品名称: [____]    │ 字段类型: 文本       │
│ [数值]        │                    │ 字段标签: [产品名称] │
│ [日期]        │ 生产数量: [____]    │ 必填: ☑              │
│ [下拉]        │                    │ 默认值: [_______]    │
│ [是/否]       │ 生产日期: [____]    │                      │
│ [上传]        │                    │                      │
│              │ 产品类型: [____▼]  │                      │
└─────────────────────────────────────────────────────────┘
```

### 7.3 操作按钮规则

| 状态 | 可见按钮 | 说明 |
|------|---------|------|
| `active` | 编辑、停用、删除、复制、分发任务 | 启用状态可操作 |
| `inactive` | 查看、启用、删除 | 停用状态不可分发任务 |

---

**本文档完成 ✅**
