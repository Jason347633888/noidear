# 审批流程（单级审批）

> **来源**: DESIGN.md 第四章 4.4 节（审批流程）  
> **文档版本**: 1.0  
> **最后更新**: 2026-02-14  
> **实现状态**: ✅ 已实现（MVP Phase 3, 98.1% 完成）  
> **代码位置**: `server/src/modules/approval/` + `client/src/views/approval/`

---

## 目录

- [1. 功能概述](#1-功能概述)
- [2. 核心功能](#2-核心功能)
- [3. 审批流程](#3-审批流程)
- [4. 业务规则](#4-业务规则)
- [5. 数据模型](#5-数据模型)
- [6. API 设计](#6-api-设计)
- [7. 前端界面](#7-前端界面)

---

## 1. 功能概述

单级审批流程系统，用于一级/二级/三级文件的审批和四级文件记录的审批。

### 1.1 核心特性

- ✅ **单级审批**: 上传者 → 审批人 → 通过/驳回
- ✅ **会签支持**: 支持多人同时审批（需全部通过）
- ✅ **依次审批**: 支持一人审批后下一人审批
- ✅ **审批意见**: 通过可选填意见，驳回必填意见
- ✅ **审批历史**: 能查看自己审批过的文件
- ✅ **意见可见**: 依次审批时能看到前面人的意见
- ✅ **Admin兜底**: Admin 可以审批任何文件

### 1.2 MVP 限制

- ❌ **多级审批**: 不支持（如 部门主管 → 质量部 → 总经理）
- ❌ **条件分支**: 不支持（如 金额>1000 走特殊流程）
- ❌ **自定义流程**: 不支持部门自定义审批流程
- ❌ **超时升级**: 不支持审批超时自动升级

**注**: 多级审批、自定义流程等高级功能见 [P1-3_简化工作流.md](../technical_debt/P1-3_简化工作流.md)

---

## 2. 核心功能

### 2.1 审批功能

| 功能 | 说明 | 实现状态 |
|------|------|---------|
| **提交审批** | 上传文件后提交 | ✅ 已实现 |
| **审批操作** | 通过（选填意见）/ 驳回（必填意见） | ✅ 已实现 |
| **审批历史** | 能查看自己审批过的文件 | ✅ 已实现 |
| **意见可见** | 依次审批时能看到前面人的意见 | ✅ 已实现 |
| **驳回处理** | 驳回后状态变"草稿"，修改后重新提交 | ✅ 已实现 |

### 2.2 审批人确定规则

| 资源类型 | 审批人确定方式 | 说明 |
|---------|---------------|------|
| **一/二/三级文件** | 从用户的上级中选择 | 用户必须有上级 |
| **四级文件记录** | 任务分发人指定 | 任务创建时指定审批人 |
| **兜底** | Admin | Admin 可以审批任何文件 |

### 2.3 审批模式

#### 2.3.1 会签（多人同时审批）

```
发起人 → 审批人A + 审批人B + 审批人C → 全部通过 → 完成
                                    → 任一拒绝 → 驳回
```

**规则**:
- ✅ 所有审批人同时收到通知
- ✅ 必须全部通过才能完成
- ✅ 任一拒绝则整个审批失败

#### 2.3.2 依次审批（串行审批）

```
发起人 → 审批人A → 通过 → 审批人B → 通过 → 完成
                → 拒绝 → 驳回
```

**规则**:
- ✅ 审批人依次收到通知
- ✅ 前一人通过后下一人才能审批
- ✅ 后一人能看到前面人的审批意见

---

## 3. 审批流程

### 3.1 一/二/三级文件审批流程

```
用户:
1. 上传文件（PDF/Word/Excel）
2. 填写文件标题
3. 点击"提交审批"
4. 选择审批人（从上级列表中选择）

系统:
1. 文件状态变为 under_review
2. 创建审批记录（approval）
3. 发送站内消息通知审批人

审批人:
1. 进入"待审批"页面
2. 点击"审批"按钮
3. 预览文件内容
4. 填写审批意见（驳回必填，通过可选）
5. 点击"通过"或"驳回"

系统:
- 通过 → 文件状态变为 approved → 发送通知给上传者
- 驳回 → 文件状态变为 draft → 发送通知给上传者
```

### 3.2 四级文件记录审批流程

```
用户:
1. 填写任务表单
2. 点击"提交"（见 03_任务管理.md）

系统:
1. 任务记录状态变为 submitted
2. 自动创建审批流程（审批人为任务分发人指定）
3. 发送站内消息通知审批人

审批人:
1. 进入"待审批"页面
2. 查看填写的数据
3. 填写审批意见
4. 点击"通过"或"驳回"

系统:
- 通过 → 记录状态变为 approved → 任务状态变为 completed
- 驳回 → 记录状态变为 rejected → 任务状态变为 pending（可重新填写）
```

---

## 4. 业务规则

| 规则编号 | 规则描述 | 来源 |
|---------|----------|------|
| **BR-002** | 一级/二级/三级文件创建后必须提交审批，不审批不可发布 | DESIGN.md 第五章 |
| **BR-004** | 四级文件（记录）填写后提交审批，审批通过后归档 | DESIGN.md 第五章 |
| **BR-006** | 文件提交后不允许修改，只能查看或撤回 | DESIGN.md 第五章 |

### 4.1 审批规则细化

- ✅ **驳回后可修改**: 驳回后状态变为 draft，用户可修改后重新提交
- ✅ **审批意见必填**: 驳回时必须填写原因
- ✅ **审批意见可选**: 通过时可选填意见
- ✅ **Admin 兜底**: Admin 可以审批任何文件
- ✅ **会签全部通过**: 会签模式下，所有人都通过才算通过
- ✅ **依次审批**: 串行模式下，前一人通过后下一人才能审批

---

## 5. 数据模型

### 5.1 审批记录表 (approvals)

```sql
approvals (
  id          SnowflakeID   PRIMARY KEY,
  document_id SnowflakeID   REFERENCES documents(id),  -- 一/二/三级文件
  record_id   SnowflakeID   REFERENCES task_records(id), -- 四级记录
  approver_id SnowflakeID   REFERENCES users(id),
  status      VARCHAR(20)   NOT NULL,            -- approved/rejected
  comment     TEXT,                               -- 审批意见
  created_at  TIMESTAMP   DEFAULT NOW()
);
```

**说明**:
- `document_id` 和 `record_id` 二选一，用于关联不同类型的资源
- `status` 只有两种：approved（通过）、rejected（驳回）
- `comment` 在 rejected 时必填，approved 时可选

---

## 6. API 设计

### 6.1 审批 API

| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/v1/approvals/pending` | GET | 获取待审批列表 |
| `/api/v1/approvals/history` | GET | 获取审批历史 |
| `/api/v1/approvals/:id/approve` | POST | 通过审批 |
| `/api/v1/approvals/:id/reject` | POST | 驳回审批 |

### 6.2 待审批列表 API

**请求**:
```http
GET /api/v1/approvals/pending
Authorization: Bearer <token>
```

**响应**:
```json
{
  "success": true,
  "data": [
    {
      "id": "appr_123",
      "resourceType": "document",
      "resourceId": "doc_456",
      "resourceTitle": "质量手册 V2.0",
      "resourceNumber": "1-RD-001",
      "submitterId": "user_001",
      "submitterName": "张三",
      "submittedAt": "2026-02-14T10:00:00Z",
      "status": "pending"
    },
    {
      "id": "appr_124",
      "resourceType": "record",
      "resourceId": "rec_789",
      "resourceTitle": "生产记录表",
      "submitterId": "user_002",
      "submitterName": "李四",
      "submittedAt": "2026-02-14T11:00:00Z",
      "status": "pending"
    }
  ]
}
```

### 6.3 通过审批 API

**请求**:
```http
POST /api/v1/approvals/:id/approve
Content-Type: application/json
Authorization: Bearer <token>

{
  "comment": "文档内容符合要求，同意发布"
}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "approvalId": "appr_123",
    "status": "approved",
    "approvedAt": "2026-02-14T14:00:00Z",
    "comment": "文档内容符合要求，同意发布"
  },
  "message": "审批已通过"
}
```

### 6.4 驳回审批 API

**请求**:
```http
POST /api/v1/approvals/:id/reject
Content-Type: application/json
Authorization: Bearer <token>

{
  "comment": "文档格式不符合要求，请重新修改"
}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "approvalId": "appr_123",
    "status": "rejected",
    "rejectedAt": "2026-02-14T14:00:00Z",
    "comment": "文档格式不符合要求，请重新修改"
  },
  "message": "审批已驳回"
}
```

---

## 7. 前端界面

### 7.1 待审批页面

**页面路由**: `/approvals/pending`

**主要组件**:
- `ApprovalList.vue` - 审批列表组件
- `ApprovalDialog.vue` - 审批对话框组件
- `PdfViewer.vue` - 文件预览组件（一/二/三级文件）
- `RecordViewer.vue` - 记录查看组件（四级文件）

**功能按钮**:
```
┌─────────────────────────────────────────────────────┐
│ 待审批                 [待审批] [已审批]             │
├─────────────────────────────────────────────────────┤
│ 资源标题      │ 类型   │ 提交人 │ 提交时间   │ 操作 │
├─────────────────────────────────────────────────────┤
│ 质量手册V2.0  │ 一级文件 │ 张三   │ 2天前     │[审批]│
│ 生产记录表    │ 四级记录 │ 李四   │ 1小时前   │[审批]│
└─────────────────────────────────────────────────────┘
```

### 7.2 审批对话框

**对话框尺寸**: `70% × 80%`

**对话框内容**:
```
┌─────────────────────────────────────────┐
│ 审批 - 质量手册 V2.0             [×]     │
├─────────────────────────────────────────┤
│ 提交人: 张三                             │
│ 提交时间: 2026-02-14 10:00:00           │
│                                         │
│ 文件预览:                                │
│ [PDF预览区域........................]   │
│                                         │
│ 审批意见:                                │
│ [___________________________________]   │
│ [___________________________________]   │
│                                         │
│          [驳回]  [通过]                  │
└─────────────────────────────────────────┘
```

### 7.3 审批历史页面

**页面路由**: `/approvals/history`

**功能按钮**:
```
┌─────────────────────────────────────────────────────┐
│ 审批历史               [全部] [已通过] [已驳回]      │
├─────────────────────────────────────────────────────┤
│ 资源标题      │ 类型   │ 提交人 │ 审批结果 │ 操作 │
├─────────────────────────────────────────────────────┤
│ 质量手册V2.0  │ 一级文件 │ 张三   │ 已通过   │[查看]│
│ 生产记录表    │ 四级记录 │ 李四   │ 已驳回   │[查看]│
└─────────────────────────────────────────────────────┘
```

### 7.4 操作按钮规则

| 页面 | 可见按钮 | 说明 |
|------|---------|------|
| **待审批** | 审批 | 点击后弹出审批对话框 |
| **已审批** | 查看 | 只能查看，不可再次审批 |

---

**本文档完成 ✅**
