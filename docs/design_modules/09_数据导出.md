# 数据导出（Phase 9）

> **来源**: DESIGN.md 第十三章（Phase 9）  
> **文档版本**: 1.0  
> **最后更新**: 2026-02-14  
> **实现状态**: ✅ 已实现（MVP Phase 9, 98.1% 完成）  
> **代码位置**: `server/src/modules/export/`

---

## 1. 功能概述

Excel 批量导出功能，支持导出文档列表、任务记录、偏离报告。

### 1.1 核心特性

- ✅ **Excel 导出**: 使用 ExcelJS 4.4+ 生成 Excel 文件
- ✅ **动态列支持**: 根据模板字段动态生成列
- ✅ **批量导出**: 支持勾选多条记录批量导出
- ✅ **数据筛选**: 导出前可筛选数据
- ✅ **格式化**: 自动格式化日期、数值

---

## 2. 导出功能

### 2.1 支持的导出类型

| 导出类型 | 说明 | API 端点 |
|---------|------|---------|
| **文档列表** | 导出一/二/三级文件列表 | `GET /api/v1/export/documents` |
| **任务记录** | 导出四级文件填写记录 | `GET /api/v1/export/task-records` |
| **偏离报告** | 导出偏离报告 | `GET /api/v1/export/deviation-reports` |

### 2.2 导出 API

**请求**:
```http
GET /api/v1/export/documents?level=1&status=current
Authorization: Bearer <token>
```

**响应**:
```http
Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
Content-Disposition: attachment; filename="documents_20260214.xlsx"

<binary data>
```

### 2.3 Excel 格式示例

**文档列表导出格式**:

| 编号 | 标题 | 级别 | 状态 | 版本 | 创建人 | 创建时间 |
|------|------|------|------|------|--------|----------|
| 1-RD-001 | 质量手册 V2.0 | 1 | 已发布 | 1.0 | 张三 | 2026-02-14 |
| 1-RD-002 | 质量方针 | 1 | 已发布 | 2.1 | 李四 | 2026-02-13 |

**任务记录导出格式（动态列）**:

| 任务ID | 模板名称 | 产品名称 | 生产数量 | 生产日期 | 提交人 | 提交时间 |
|--------|---------|---------|---------|---------|--------|----------|
| task_001 | 生产记录表 | 面包 | 1000 | 2026-02-14 | 张三 | 2026-02-14 14:00 |
| task_002 | 生产记录表 | 蛋糕 | 500 | 2026-02-14 | 李四 | 2026-02-14 15:00 |

---

## 3. 代码示例

```typescript
import * as ExcelJS from 'exceljs'

export async function exportDocuments(filters) {
  const workbook = new ExcelJS.Workbook()
  const worksheet = workbook.addWorksheet('文档列表')
  
  // 设置列
  worksheet.columns = [
    { header: '编号', key: 'number', width: 15 },
    { header: '标题', key: 'title', width: 30 },
    { header: '级别', key: 'level', width: 10 },
    { header: '状态', key: 'status', width: 15 },
    { header: '版本', key: 'version', width: 10 },
    { header: '创建人', key: 'creator', width: 15 },
    { header: '创建时间', key: 'createdAt', width: 20 }
  ]
  
  // 查询数据
  const documents = await prisma.document.findMany({ where: filters })
  
  // 添加行
  documents.forEach(doc => {
    worksheet.addRow({
      number: doc.number,
      title: doc.title,
      level: doc.level,
      status: doc.status,
      version: doc.version,
      creator: doc.creator.name,
      createdAt: doc.createdAt.toISOString()
    })
  })
  
  // 生成 Excel 文件
  return await workbook.xlsx.writeBuffer()
}
```

---

**本文档完成 ✅**

---

## 业务规则（BR-026, BR-028, BR-029, BR-030）

### BR-026: 任务记录导出表头格式
**规则描述**: 任务记录导出表头 = 固定列（ID、标题、状态、创建人、创建时间）+ 动态列（模板字段）

**实施方式**:
- 固定列: 从 TaskRecord 表读取
- 动态列: 从 Template.fieldsJson 解析
- Excel 表头顺序: 固定列在前，动态列在后

**影响范围**: 数据导出

---

### BR-028: 导出权限控制
**规则描述**: 导出权限：Admin 可导出全部，Leader 可导出本部门，User 可导出自己的

**实施方式**:
- 导出前校验用户角色
- Admin: 查询全部数据
- Leader: 查询 `WHERE creatorId IN (本部门用户)`
- User: 查询 `WHERE creatorId = 当前用户ID`

**影响范围**: 数据导出、权限控制

---

### BR-029: 导出数量限制
**规则描述**: 导出数量 ≤1000 条同步返回，>1000 条异步生成（返回任务 ID，提供下载链接）

**实施方式**:
- ≤1000 条: 同步生成 Excel，直接返回文件流
- >1000 条: 创建异步任务，返回任务 ID
- 异步任务: 生成后上传到 MinIO，返回下载链接

**影响范围**: 数据导出、异步任务

---

### BR-030: 异步导出文件保留期
**规则描述**: 异步导出文件保留 7 天，超期自动删除

**实施方式**:
- 文件存储在 MinIO `/export-files` 目录
- 文件名包含时间戳: `export-{timestamp}.xlsx`
- Cron 任务每天清理 7 天前的文件

**影响范围**: 存储管理、定时任务

---

**BR 补充完成 ✅** (2026-02-14)
