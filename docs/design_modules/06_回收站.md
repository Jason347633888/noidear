# 回收站（软删除与恢复）

> **来源**: DESIGN.md 第四章（核心功能模块）  
> **文档版本**: 1.0  
> **最后更新**: 2026-02-14  
> **实现状态**: ⚠️ 部分实现（软删除已实现，回收站 UI 待完善）  
> **代码位置**: 所有核心表的 `deleted_at` 字段

---

## 目录

- [1. 功能概述](#1-功能概述)
- [2. 软删除机制](#2-软删除机制)
- [3. 回收站功能](#3-回收站功能)
- [4. 数据模型](#4-数据模型)
- [5. API 设计](#5-api-设计)
- [6. 前端界面](#6-前端界面)

---

## 1. 功能概述

回收站系统提供软删除和恢复功能，防止误删重要数据。

### 1.1 核心特性

- ✅ **软删除**: 所有核心表支持 `deleted_at` 字段
- ✅ **数据保留**: 删除的数据不会立即从数据库中删除
- ✅ **恢复功能**: 可从回收站恢复已删除的数据
- ✅ **自动清理**: 30天后自动清理（可配置）
- ⏳ **回收站UI**: 待完善（MVP 最后 1/52 Issue）

### 1.2 支持软删除的资源

| 资源类型 | 表名 | 软删除字段 | 实现状态 |
|---------|------|-----------|---------|
| **用户** | users | deleted_at | ✅ 已实现 |
| **部门** | departments | deleted_at | ✅ 已实现 |
| **文档** | documents | deleted_at | ✅ 已实现 |
| **模板** | templates | deleted_at | ✅ 已实现 |
| **任务** | tasks | deleted_at | ✅ 已实现 |
| **记录** | task_records | deleted_at | ✅ 已实现 |

---

## 2. 软删除机制

### 2.1 软删除 vs 硬删除

| 对比项 | 软删除 | 硬删除 |
|--------|-------|-------|
| **数据保留** | ✅ 保留在数据库 | ❌ 永久删除 |
| **可恢复** | ✅ 可恢复 | ❌ 不可恢复 |
| **查询影响** | 需添加 `deleted_at IS NULL` 条件 | 无影响 |
| **存储成本** | 较高（保留数据） | 较低 |
| **审计追溯** | ✅ 可追溯 | ❌ 无法追溯 |

### 2.2 软删除实现

**Prisma 查询示例**:
```typescript
// 查询未删除的文档
const documents = await prisma.document.findMany({
  where: {
    deleted_at: null  // 只查询未删除的
  }
})

// 软删除文档
await prisma.document.update({
  where: { id: 'doc_123' },
  data: {
    deleted_at: new Date()
  }
})

// 查询回收站中的文档
const trashedDocuments = await prisma.document.findMany({
  where: {
    deleted_at: { not: null }  // 只查询已删除的
  }
})
```

---

## 3. 回收站功能

### 3.1 回收站功能列表

| 功能 | 说明 | 实现状态 |
|------|------|---------|
| **查看回收站** | 查看所有已删除的数据 | ⏳ UI 待实现 |
| **恢复数据** | 将数据从回收站恢复 | ⏳ UI 待实现 |
| **彻底删除** | 永久删除数据（硬删除） | ⏳ UI 待实现 |
| **批量恢复** | 批量恢复多条数据 | ⏳ UI 待实现 |
| **批量清空** | 批量彻底删除 | ⏳ UI 待实现 |
| **自动清理** | 30天后自动清理 | ❌ 未实现 |

### 3.2 恢复规则

| 资源类型 | 恢复条件 | 说明 |
|---------|---------|------|
| **文档** | 无特殊条件 | 可直接恢复 |
| **模板** | 无特殊条件 | 可直接恢复 |
| **任务** | 关联的模板未删除 | 模板删除则不可恢复 |
| **用户** | 用户名/邮箱未被占用 | 避免冲突 |
| **部门** | 部门代码未被占用 | 避免冲突 |

---

## 4. 数据模型

### 4.1 所有核心表的 deleted_at 字段

所有核心表（users、departments、documents、templates、tasks、task_records）都包含：

```sql
deleted_at  TIMESTAMP  -- 软删除时间戳（NULL = 未删除）
```

### 4.2 查询示例

**查询未删除的数据**:
```sql
SELECT * FROM documents WHERE deleted_at IS NULL;
```

**查询回收站数据**:
```sql
SELECT * FROM documents WHERE deleted_at IS NOT NULL;
```

**恢复数据**:
```sql
UPDATE documents SET deleted_at = NULL WHERE id = 'doc_123';
```

**彻底删除**:
```sql
DELETE FROM documents WHERE id = 'doc_123';
```

---

## 5. API 设计

### 5.1 回收站 API

| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/v1/trash/:resourceType` | GET | 获取回收站列表（文档/模板/任务等） |
| `/api/v1/trash/:resourceType/:id/restore` | POST | 恢复数据 |
| `/api/v1/trash/:resourceType/:id` | DELETE | 彻底删除 |
| `/api/v1/trash/:resourceType/clear` | DELETE | 清空回收站 |

### 5.2 获取回收站列表 API

**请求**:
```http
GET /api/v1/trash/documents
Authorization: Bearer <token>
```

**响应**:
```json
{
  "success": true,
  "data": [
    {
      "id": "doc_123",
      "number": "1-RD-001",
      "title": "质量手册 V2.0",
      "level": 1,
      "deletedAt": "2026-02-10T14:00:00Z",
      "deletedBy": "user_001",
      "deletedByName": "张三",
      "canRestore": true
    }
  ]
}
```

### 5.3 恢复数据 API

**请求**:
```http
POST /api/v1/trash/documents/doc_123/restore
Authorization: Bearer <token>
```

**响应**:
```json
{
  "success": true,
  "data": {
    "id": "doc_123",
    "title": "质量手册 V2.0",
    "restoredAt": "2026-02-14T10:00:00Z"
  },
  "message": "数据已恢复"
}
```

---

## 6. 前端界面

### 6.1 回收站页面（待实现 ⏳）

**页面路由**: `/trash`

**功能按钮**:
```
┌─────────────────────────────────────────────────────┐
│ 回收站        [文档] [模板] [任务] [用户]           │
├─────────────────────────────────────────────────────┤
│ 搜索: [_________________]  [清空回收站]            │
├─────────────────────────────────────────────────────┤
│ 标题          │ 类型   │ 删除时间   │ 删除人 │ 操作 │
├─────────────────────────────────────────────────────┤
│ 质量手册V2.0  │ 一级文件 │ 4天前     │ 张三   │[恢复][删]│
│ 生产记录表    │ 四级模板 │ 2天前     │ 李四   │[恢复][删]│
└─────────────────────────────────────────────────────┘
```

### 6.2 操作按钮说明

| 按钮 | 功能 | 说明 |
|------|------|------|
| **恢复** | 恢复数据 | 将 deleted_at 设为 NULL |
| **删** | 彻底删除 | 永久删除数据（不可恢复） |
| **清空回收站** | 批量删除 | 清空所有回收站数据 |

### 6.3 自动清理规则（待实现 ❌）

```typescript
// 定时任务：每天凌晨 2 点执行
cron.schedule('0 2 * * *', async () => {
  const thirtyDaysAgo = new Date()
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30)
  
  // 彻底删除 30 天前的回收站数据
  await prisma.document.deleteMany({
    where: {
      deleted_at: {
        lt: thirtyDaysAgo
      }
    }
  })
})
```

---

**本文档完成 ✅**
