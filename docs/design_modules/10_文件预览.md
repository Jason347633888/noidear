# 文件预览（Phase 11）

> **来源**: DESIGN.md 第十三章（Phase 11）  
> **文档版本**: 1.0  
> **最后更新**: 2026-02-14  
> **实现状态**: ⚠️ 部分实现（PDF 已实现，Word/Excel 待完善）  
> **代码位置**: `client/src/components/PdfViewer.vue`

---

## 1. 功能概述

文件预览系统，支持 PDF、Word、Excel 全格式原生预览。

### 1.1 核心特性

- ✅ **PDF 预览**: 原生 PDF 预览（已实现）
- ⏳ **Word 预览**: Office Online Viewer（待实现）
- ⏳ **Excel 预览**: Office Online Viewer（待实现）
- ✅ **预览组件**: PdfViewer.vue 组件

---

## 2. 预览功能

### 2.1 支持的文件类型

| 文件类型 | 预览方式 | 实现状态 |
|---------|---------|---------|
| **PDF** | 原生 `<embed>` 标签 | ✅ 已实现 |
| **Word** | Office Online Viewer | ⏳ 待实现 |
| **Excel** | Office Online Viewer | ⏳ 待实现 |

### 2.2 PDF 预览组件

**组件路径**: `client/src/components/PdfViewer.vue`

**使用示例**:
```vue
<template>
  <PdfViewer :url="pdfUrl" />
</template>

<script setup>
import PdfViewer from '@/components/PdfViewer.vue'

const pdfUrl = 'https://minio.example.com/documents/1-RD-001/v1.0/quality-manual.pdf'
</script>
```

**组件代码**:
```vue
<template>
  <embed
    :src="url"
    type="application/pdf"
    width="100%"
    height="600px"
  />
</template>

<script setup>
defineProps<{
  url: string
}>()
</script>
```

---

## 3. Word/Excel 预览（待实现 ⏳）

### 3.1 方案一：Office Online Viewer

**优点**: 官方支持，渲染效果好  
**缺点**: 需要公网访问

**URL 格式**:
```
https://view.officeapps.live.com/op/embed.aspx?src=<文件URL>
```

### 3.2 方案二：前端渲染库

| 文件类型 | 推荐库 | 说明 |
|---------|--------|------|
| **Word** | mammoth.js | 将 .docx 转换为 HTML |
| **Excel** | SheetJS | 渲染 Excel 表格 |

---

**本文档完成 ✅**

---

## 4. 业务规则（BR-041 ~ BR-050）

### BR-041: 支持三种格式在线预览
**规则描述**: 支持 PDF、Word（.doc/.docx）、Excel（.xls/.xlsx）三种格式在线预览

**实施方式**: 
- PDF: 原生 `<embed>` 标签渲染
- Word/Excel: 后端转换为 HTML 后预览
- 文件类型校验

**影响范围**: 文档管理、文件上传

---

### BR-042: PDF 直接渲染，Word/Excel 转换后预览
**规则描述**: PDF 文件直接渲染，Word/Excel 文件需后端转换为 HTML 后预览

**实施方式**:
- PDF: 直接返回文件 URL
- Word/Excel: 后端使用 LibreOffice/Pandoc 转换为 HTML
- 转换结果缓存到 MinIO

**影响范围**: 文件预览、文件转换

---

### BR-043: 文件大小限制
**规则描述**: 预览文件大小限制：≤10MB 直接预览，>10MB 提示建议下载（可强制预览）

**实施方式**:
- 前端检查文件大小
- >10MB 显示警告提示
- 提供"仍要预览"和"直接下载"按钮

**影响范围**: 文件预览、用户体验

---

### BR-044: 转换结果缓存 7 天
**规则描述**: Word/Excel 转换后的 HTML 缓存 7 天，文件更新后缓存失效

**实施方式**:
- 缓存键: `preview-cache/{documentId}/{version}.html`
- 缓存存储在 MinIO `/preview-cache` 目录
- 定时任务每日清理过期缓存

**影响范围**: 性能优化、存储管理

---

### BR-045: 预览加载超时设置
**规则描述**: 预览加载超时时间：转换 30 秒，渲染 10 秒，超时提示并提供下载链接

**实施方式**:
- 后端转换超时: 30 秒
- 前端渲染超时: 10 秒
- 超时后显示友好错误提示

**影响范围**: 用户体验、错误处理

---

### BR-046: 预览权限校验
**规则描述**: 预览权限：拥有文档查看权限的用户才能预览文件

**实施方式**:
- 预览 API 集成权限校验
- 无权限返回 403 Forbidden
- 前端隐藏预览按钮

**影响范围**: 权限管理、安全控制

---

### BR-047: Excel 多 Sheet 支持
**规则描述**: Excel 多 Sheet 文件支持 Sheet 切换，单 Sheet 行数 >1000 时分页显示

**实施方式**:
- Sheet 列表显示在顶部 Tab
- 单 Sheet 超过 1000 行时分页（每页 100 行）
- 前端虚拟滚动优化性能

**影响范围**: Excel 预览、性能优化

---

### BR-048: 预览窗口操作
**规则描述**: 预览窗口支持全屏、缩放、下载、打印（PDF）等操作

**实施方式**:
- 全屏按钮: 使用浏览器全屏 API
- 缩放按钮: 调整 iframe 比例
- 下载按钮: 直接下载原文件
- 打印按钮: 浏览器打印（仅 PDF）

**影响范围**: 用户体验、交互设计

---

### BR-049: 预览失败友好提示
**规则描述**: 预览失败时，显示友好错误提示，并提供下载原文件的备用方案

**实施方式**:
- 错误类型分类: 格式不支持、文件损坏、转换失败
- 显示对应错误提示
- 提供"下载原文件"按钮

**影响范围**: 错误处理、用户体验

---

### BR-050: 预览缓存存储策略
**规则描述**: 预览缓存存储在 MinIO（/preview-cache 目录），定时任务每日清理过期缓存

**实施方式**:
- MinIO Bucket: `preview-cache`
- 缓存目录: `/preview-cache/{documentId}/{version}.html`
- Cron 任务: 每天凌晨 2:00 清理 7 天前的缓存

**影响范围**: 存储管理、定时任务

---

## 5. 业务规则汇总表

| 规则编号 | 规则描述 | 实施方式 |
|---------|----------|---------|
| **BR-041** | 支持 PDF、Word、Excel 三种格式在线预览 | 文件类型校验 + 渲染/转换 |
| **BR-042** | PDF 直接渲染，Word/Excel 转换后预览 | LibreOffice/Pandoc 转换 |
| **BR-043** | ≤10MB 直接预览，>10MB 提示建议下载 | 前端文件大小检查 |
| **BR-044** | 转换结果缓存 7 天，文件更新后失效 | MinIO 缓存 + 版本控制 |
| **BR-045** | 转换 30 秒，渲染 10 秒超时 | 超时处理 + 友好提示 |
| **BR-046** | 拥有文档查看权限的用户才能预览 | 权限校验 + 403 拒绝 |
| **BR-047** | Excel 多 Sheet 切换，>1000 行分页 | Tab 切换 + 虚拟滚动 |
| **BR-048** | 支持全屏、缩放、下载、打印 | 浏览器 API + 交互设计 |
| **BR-049** | 预览失败显示友好提示 + 下载按钮 | 错误分类 + 备用方案 |
| **BR-050** | 缓存存储 MinIO，定时清理过期缓存 | Cron 任务 + 存储管理 |

---

**更新日期**: 2026-02-14  
**BR 补充完成 ✅**
