# 仓库管理系统（Layer 1 核心生产）

> **来源**: DESIGN.md 第十七章（仓库管理系统）  
> **文档版本**: 1.0  
> **最后更新**: 2026-02-14  
> **实现状态**: ⏳ 未实现（PRD + LLD 已完成）  
> **优先级**: ⭐⭐⭐ 最高（Phase B 核心生产）  
> **依赖**: 动态表单引擎、批次追溯系统、移动端应用

---

## 目录

- [1. 系统定位](#1-系统定位)
- [2. 核心职责](#2-核心职责)
- [3. 业务流程](#3-业务流程)
- [4. 数据模型](#4-数据模型)
- [5. 业务规则](#5-业务规则)

---

## 1. 系统定位

**仓库管理系统作为独立业务模块**，是整个 BRCGS 食品安全管理体系的**基础设施**。

### 1.1 核心优势

| 优势 | 说明 |
|------|------|
| **架构清晰** | 独立业务模块，不污染其他系统 |
| **分阶段实施** | MVP 手工录入，v2.0 对接金蝶 ERP |
| **统一待办** | 复用 TodoTask 系统 |
| **全链追溯** | 支持正向/反向追溯，满足 BRCGS 4 小时召回要求 |
| **数据闭环** | 仓库 ↔ 暂存间 ↔ 生产的完整数据流 |
| **灵活扩展** | 预留条形码字段，v2.0 可引入扫码功能 |

---

## 2. 核心职责

1. **物料管理**: 物料基础信息、批次管理、库存管理
2. **出入库管理**: 物料入库、领料出库、退料、报废
3. **批次追溯**: 原料批次 → 生产批次 → 成品批次的全链条追溯
4. **供应商管理**: 供应商信息、资质管理、绩效评估
5. **物料平衡校验**: 领料数量 vs 配方用量 vs 实际产量的平衡验证
6. **库存预警**: 物料临期预警、过期锁定

---

## 3. 业务流程

### 3.1 核心流程

```
1. 物料入库流程
   供应商送货 → 来料检验(IQC) → 检验合格 → 入库单 → 库存+

2. 领料出库流程
   创建领料单 → 选择批次(FIFO) → 审批 → 出库单 → 仓库库存- / 暂存间库存+

3. 暂存间盘点流程
   上班盘点(期初) → 记录物料批次数量 → 下班盘点(期末) → 计算实际消耗

4. 生产消耗流程
   生产开始 → 从暂存间领料 → 生产记录(四级文件) → 产品入库

5. 物料平衡校验流程
   产品入库 → 校验: 期初 + 领料 - 期末 ≈ 配方用量 × 产量 → 偏差预警

6. 退料流程
   发现质量问题 → 创建退料单 → 审批 → 入库单 → 仓库库存+

7. 报废流程
   物料过期/损坏 → 创建报废单 → 审批 → 库存- → 报废记录归档

8. 批次追溯流程
   反向追溯: 成品批次 → 生产批次 → 原料批次 → 供应商批次
   正向追溯: 供应商批次 → 原料批次 → 生产批次 → 成品批次
```

### 3.2 关键业务场景

**场景 1: 原料入库**
1. 供应商送货(高筋面粉 500kg, 批次: SUP-001-20240101)
2. 质量部 IQC 检验(抽检 5 袋)
3. 检验合格 → 系统自动创建入库单
4. 仓库管理员确认入库
5. 系统记录: MaterialBatch 表、StockRecord 表、Material 表

**场景 2: 批次追溯(反向)**
1. 客户投诉: 曲奇饼干批次 FG-P001-20240615-001 有异物
2. 质量部输入成品批次号查询
3. 系统自动追溯: 成品 → 生产 → 领料 → 原料 → 供应商
4. 生成追溯报告(PDF), 耗时 < 4 小时(满足 BRCGS 要求)

---

## 4. 数据模型

### 4.1 核心数据表（13 个）

**物料管理**:
1. Material - 物料基础信息表
2. MaterialBatch - 物料批次表
3. StockRecord - 库存记录表（出入库流水）

**出入库管理**:
4. MaterialRequisition - 领料单表
5. MaterialRequisitionItem - 领料明细表
6. MaterialReturn - 退料单表
7. MaterialScrap - 报废单表

**供应商管理**:
8. Supplier - 供应商表
9. SupplierQualification - 供应商资质表

**批次追溯**:
10. BatchTraceability - 批次追溯关系表

**物料平衡**:
11. MaterialBalance - 物料平衡记录表

**暂存间管理**:
12. StagingAreaStock - 暂存间库存表
13. StagingAreaRecord - 暂存间盘点记录表

### 4.2 物料批次表示例

```prisma
model MaterialBatch {
  id                  String   @id @default(cuid())
  materialId          String              // 物料 ID
  batchNumber         String   @unique    // 批次号(系统生成)
  supplierBatchNumber String?             // 供应商批次号
  supplierId          String?             // 供应商 ID
  productionDate      DateTime?           // 生产日期
  expiryDate          DateTime?           // 到期日期
  shelfLife           Int?                // 保质期(天)
  stockQuantity       Float    @default(0) // 批次库存数量
  barcode             String?             // 条形码(v2.0 扩展)
  status              String   @default("normal") // normal | expired | locked
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@map("material_batches")
}
```

---

## 5. 业务规则

| 规则编号 | 规则描述 | 实现方式 |
|---------|----------|----------|
| **BR-101** | 物料批次号唯一 | @unique 约束 |
| **BR-102** | 领料遵循 FIFO 规则（先进先出） | 系统推荐最旧批次 |
| **BR-103** | 过期物料自动锁定，不可领用 | status = expired, 前端禁用 |
| **BR-104** | 物料平衡偏差 > 5% 时预警 | 后端校验逻辑 |
| **BR-105** | 批次追溯必须 < 4 小时完成 | BRCGS 合规要求 |
| **BR-106** | 供应商批次号必须记录 | 必填字段 |
| **BR-107** | 领料单需审批 | 工作流引擎 |
| **BR-108** | 暂存间每日盘点 | 定时提醒 |

---

**本文档完成 ✅**

---

## 业务规则（BR-136 ~ BR-180，共45条）

### 物料管理规则（BR-136 ~ BR-145）

| 编号 | 规则 | 实施方式 |
|------|------|----------|
| **BR-136** | 物料编码唯一：每个物料的 code 必须唯一(来自金蝶) | `Material.code @unique` |
| **BR-137** | 物料录入方式：MVP 阶段支持手工录入 + Excel 批量导入 | API: `POST /api/materials/import` |
| **BR-138** | Excel 导入字段：物料编码、名称、规格、单位、批次号、供应商批次、生产日期、保质期(天) | 导入模板固定格式 |
| **BR-139** | 批次号生成：优先使用供应商批次号,无则自动生成 `B{YYYYMMDD}-{序号}` | 后端自动生成 |
| **BR-140** | 同一物料多批次：同一物料可以有多个批次同时存在库存中 | `MaterialBatch.materialId` 非唯一 |
| **BR-141** | 批次状态：`normal`(正常) / `expired`(过期) / `locked`(锁定,不可用) | `MaterialBatch.status` 枚举 |
| **BR-142** | 过期自动锁定：系统每天自动检查批次到期日期,过期则锁定 | 定时任务(Cron Job) |
| **BR-143** | 临期预警：距离过期 < 30 天时,生成待办任务通知仓库管理员 | TodoTask + 定时任务 |
| **BR-144** | 过期物料处理：过期物料必须报废,生成报废单 | 报废流程 |
| **BR-145** | 条形码预留：数据库预留 `barcode` 字段,v2.0 启用扫码功能 | `MaterialBatch.barcode?` 可选字段 |

---

### 批次推荐规则（BR-146 ~ BR-150）

| 编号 | 规则 | 实施方式 |
|------|------|----------|
| **BR-146** | FIFO 强制模式（可配置）：系统强制 FIFO，领料时优先推荐最旧批次（入库时间最早）| SystemConfig.fifoEnforced (true/false) |
| **BR-146a** | 手动批次选择开关：保留手动选择批次开关，用于应对特殊情况（用户业务规则 BR-1.41）| SystemConfig.allowManualBatchSelection |
| **BR-146b** | 多批次混用：最早批次库存不足时，允许从多个批次领料（用户业务规则 BR-1.42）| 领料单可选择多个批次 |
| **BR-147** | 临期不优先（简化）：不要把系统搞太复杂，按入库时间 FIFO 即可（用户业务规则 BR-1.43）| 移除临期优先逻辑 |
| **BR-148** | 过期批次过滤：过期物料(status = expired)不显示在领料选择列表中 | 查询时过滤 `WHERE status != 'expired'` |
| **BR-149** | 库存充足校验：领料数量 > 批次库存时,提示"库存不足",允许选择其他批次 | 前端校验 + 后端校验 |

---

### 领料流程规则（BR-152 ~ BR-160）

| 编号 | 规则 | 实施方式 |
|------|------|----------|
| **BR-152** | 领料不关联配方：领料单不需要关联配方,不需要指定生产批次 | `MaterialRequisition.productionBatchId?` 可选 |
| **BR-153** | 领料审批：所有领料单必须经过审批(复用 v2.0.0 工作流引擎) | `MaterialRequisition.workflowId` |
| **BR-154** | 审批待办：领料单提交后,自动生成待办任务给审批人 | TodoTask 集成 |
| **BR-155** | 领料出库：审批通过后,仓库管理员确认出库,生成 StockRecord(type=out) | 出库操作 |
| **BR-156** | 库存扣减：出库时扣减批次库存 `MaterialBatch.stockQuantity -= actualQuantity` | 事务操作 |
| **BR-157** | 领料部门：支持生产部、工程部、质量部领料 | `MaterialRequisition.department` |
| **BR-158** | 补料单：补料单就是领料单,不单独设计 | 复用 MaterialRequisition |
| **BR-159** | 领料单号生成：`REQ-{YYYYMMDD}-{序号}` | 后端自动生成 |
| **BR-160** | 领料历史：支持查询历史领料单,按日期/部门/物料筛选 | 查询 API |

---

### 退料流程规则（BR-161 ~ BR-165）

| 编号 | 规则 | 实施方式 |
|------|------|----------|
| **BR-161** | 退料场景：领料后发现质量问题,退回仓库 | 退料单(复用 MaterialRequisition, 标记 type=return) |
| **BR-162** | 退料审批：退料单需要审批 | 工作流集成 |
| **BR-163** | 退料入库：审批通过后,自动生成入库单,恢复批次库存 | StockRecord(type=in) + 库存恢复 |
| **BR-164** | 退料数量：退料数量 ≤ 原领料数量 | 前端校验 + 后端校验 |
| **BR-165** | 数据闭环：出库数量 = 实际消耗 + 退料数量 | 物料平衡计算时考虑退料 |

---

### 报废流程规则（BR-166 ~ BR-170）

| 编号 | 规则 | 实施方式 |
|------|------|----------|
| **BR-166** | 报废场景：物料过期、损坏、质量问题 | 报废单 |
| **BR-167** | 报废审批：报废单需要审批 | 工作流集成 |
| **BR-168** | 报废出库：审批通过后,扣减库存,生成 StockRecord(type=out, relatedType=scrap) | 出库操作 |
| **BR-169** | 报废记录归档：报废单作为四级文件归档到文档系统 | 文档系统集成 |
| **BR-170** | 报废单号生成：`SCRAP-{YYYYMMDD}-{序号}` | 后端自动生成 |

---

### 盘点流程规则（BR-171 ~ BR-175）

| 编号 | 规则 | 实施方式 |
|------|------|----------|
| **BR-171** | 盘点类型：仓库盘点 + 暂存间盘点(上班/下班各一次) | `StagingInventory.inventoryType` = opening / closing |
| **BR-172** | 盘点审批：盘盈盘亏需要审批 | 工作流集成 |
| **BR-173** | 库存调整：审批通过后,按实际盘点数量更新库存 | `MaterialBatch.stockQuantity = 实际盘点数量` |
| **BR-174** | 盘点单录入：在系统内直接录入,不支持 Excel 导入 | 前端表单 |
| **BR-175** | 盘点单号生成：`INV-{YYYYMMDD}-{序号}` | 后端自动生成 |

---

### 物料平衡规则（BR-176 ~ BR-180）

| 编号 | 规则 | 实施方式 |
|------|------|----------|
| **BR-176** | 校验时机：产品入库时触发物料平衡校验 | 入库 API 触发 |
| **BR-177** | 校验公式：`期初 + 领料 - 期末 ≈ 配方用量 × 产量` | 后端计算 |
| **BR-178** | 允许偏差：由用户在系统设置中自定义(例如: ±5%) | 系统配置表 |
| **BR-179** | 偏差超标：超标时警告(不阻止保存),但需要填写偏差原因 | `MaterialBalance.deviationReason` 必填 |
| **BR-180** | 补料影响：补料会影响物料平衡计算,领料数量 += 补料数量 | 计算时汇总所有领料单 |

---

**BR 补充完成 ✅** (2026-02-14)
