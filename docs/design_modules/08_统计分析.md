# 统计分析（Phase 12）

> **来源**: DESIGN.md 第十三章（Phase 12）  
> **文档版本**: 1.0  
> **最后更新**: 2026-02-14  
> **实现状态**: ✅ 已实现（MVP Phase 12, 98.1% 完成）  
> **代码位置**: `client/src/views/statistics/`

---

## 1. 功能概述

偏离统计分析系统，提供偏离趋势分析、字段分布统计、部门偏离率对比等可视化图表。

### 1.1 核心特性

- ✅ **偏离趋势分析**: 折线图展示偏离次数随时间变化
- ✅ **字段分布统计**: 饼图展示各字段偏离占比
- ✅ **部门偏离率**: 柱状图对比各部门偏离率
- ✅ **ECharts 图表**: 使用 ECharts 6.0+ 生成图表
- ✅ **数据筛选**: 支持按时间范围、部门、字段筛选

---

## 2. 统计图表

### 2.1 偏离趋势分析（折线图）

**数据来源**: `deviation_reports` 表，按 `reported_at` 分组

**图表类型**: ECharts Line Chart

**X 轴**: 日期（最近 30 天）  
**Y 轴**: 偏离次数

**示例代码**:
```typescript
const option = {
  title: { text: '偏离趋势分析（最近30天）' },
  xAxis: { type: 'category', data: ['2026-01-15', '2026-01-16', ...] },
  yAxis: { type: 'value' },
  series: [{
    data: [12, 8, 15, 7, 10, ...],
    type: 'line',
    smooth: true
  }]
}
```

### 2.2 字段分布统计（饼图）

**数据来源**: `deviation_reports` 表，按 `field_name` 分组

**图表类型**: ECharts Pie Chart

**示例代码**:
```typescript
const option = {
  title: { text: '偏离字段分布' },
  series: [{
    type: 'pie',
    data: [
      { value: 45, name: '温度' },
      { value: 30, name: '时间' },
      { value: 25, name: '数量' }
    ]
  }]
}
```

### 2.3 部门偏离率（柱状图）

**数据来源**: `deviation_reports` JOIN `users` JOIN `departments`

**图表类型**: ECharts Bar Chart

**X 轴**: 部门名称  
**Y 轴**: 偏离率（%）

**示例代码**:
```typescript
const option = {
  title: { text: '部门偏离率对比' },
  xAxis: { type: 'category', data: ['生产部', '质量部', '研发部'] },
  yAxis: { type: 'value' },
  series: [{
    data: [8.5, 3.2, 1.5],
    type: 'bar'
  }]
}
```

---

## 3. 数据筛选

**筛选条件**:
- 时间范围：最近7天 / 最近30天 / 自定义
- 部门：全部 / 指定部门
- 字段：全部 / 指定字段

---

**本文档完成 ✅**

---

## 业务规则（BR-051 ~ BR-060, BR-071 ~ BR-090）

### 偏离统计业务规则（BR-051 ~ BR-060）

| 规则编号 | 规则描述 | 实施方式 |
|---------|----------|---------|
| **BR-051** | 偏离率 = (包含偏离的记录数 / 总记录数) * 100%，保留 2 位小数 | 统计计算逻辑 |
| **BR-052** | 统计时间范围支持预设（本周/本月/本季度）和自定义（开始日期-结束日期） | 前端日期选择器 |
| **BR-053** | 偏离趋势支持按日/周/月聚合，周聚合按 ISO Week，月聚合按 YYYY-MM | SQL 聚合查询 |
| **BR-054** | 偏离字段分布按偏离次数降序排列，显示占比（保留 1 位小数） | 排序 + 百分比计算 |
| **BR-055** | 部门偏离对比按偏离率升序排列，偏离率低的部门排名靠前 | 排序逻辑 |
| **BR-056** | 偏离统计权限：Admin 可查看全部部门，Leader 可查看本部门，User 不可访问统计页面 | 权限校验 + 路由守卫 |
| **BR-057** | 异常峰值标注：偏离次数 > 平均值 + 2*标准差 的日期标记为异常 | 统计学计算 |
| **BR-058** | 偏离统计数据可导出 Excel，包含多个 Sheet（总览、字段分布、部门对比、趋势数据） | 多 Sheet Excel 导出 |
| **BR-059** | 统计计算基于 DeviationReport 表，不直接查询 TaskRecord（性能优化） | 查询优化 |
| **BR-060** | 偏离统计支持实时刷新（点击刷新按钮，重新计算最新数据） | 手动刷新按钮 |

---

### 工作流引擎业务规则（BR-071 ~ BR-090）

| 规则编号 | 规则描述 | 规则类型 |
|---------|----------|---------|
| **BR-071** | 仅支持三级文件引用三级文件 | 约束 |
| **BR-072** | 引用Block不可编辑，但可删除 | 约束 |
| **BR-073** | 源文档审批通过后，触发异步同步队列 | 业务逻辑 |
| **BR-074** | 引用同步失败时，标记为"失效"并通知管理员 | 业务逻辑 |
| **BR-075** | 跨部门引用需要源文档查看权限 | 权限控制 |
| **BR-076** | 部门Leader可创建本部门工作流模板 | 权限控制 |
| **BR-077** | 工作流模板修改后，已进行中的流程不受影响 | 业务逻辑 |
| **BR-078** | 并行会签：任一审批人驳回，流程立即终止 | 业务逻辑 |
| **BR-079** | 驳回原因必填，且至少5个字 | 约束 |
| **BR-080** | 同意时审批意见可选 | 约束 |
| **BR-081** | 审批人离职/调岗，任务自动转给上级 | 业务逻辑 |
| **BR-082** | 审批人无上级时，任务转给Admin | 业务逻辑 |
| **BR-083** | Document.content 字段必须为Tiptap JSON格式 | 约束 |
| **BR-084** | 章节ID自动生成，格式：section-{slugified-title} | 业务逻辑 |
| **BR-085** | 上传的Word/PDF仅作为参考，不直接存储 | 业务逻辑 |
| **BR-086** | 引用关系创建时，需校验源文档和目标文档是否存在 | 约束 |
| **BR-087** | 引用关系创建时，需校验章节ID是否存在 | 约束 |
| **BR-088** | 同一源文档+目标文档+章节ID组合唯一 | 约束 |
| **BR-089** | 删除文档时，级联删除相关引用关系 | 业务逻辑 |

---

**BR 补充完成 ✅** (2026-02-14)
