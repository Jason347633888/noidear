# P1-2: 细粒度权限系统完整方案

> **来源**: DESIGN.md Chapter 22.2.2 (第 13526-13910 行)  
> **文档版本**: 3.0  
> **最后更新**: 2026-02-14  
> **技术债务优先级**: P1（高优先级）  
> **依赖**: Phase 10 跨部门权限功能的基础

---

## 目录

- [1. 业务规则](#1-业务规则)
- [2. API 设计](#2-api-设计)
- [3. 前端界面设计](#3-前端界面设计)
- [4. 实施检查清单](#4-实施检查清单)

---

## 1. 业务规则

### BR-349: 权限定义规则

- **权限编码格式**：`{action}:{scope}:{resource}`，如 `view:cross_department:document`
- **权限类别**：document（文档）、record（记录）、task（任务）、approval（审批）、system（系统）
- **权限范围**：department（本部门）、cross_department（跨部门）、global（全局）
- **权限不可删除**：已使用的权限不可删除，只能停用

---

### BR-350: 权限授予规则

- **授权权限**：仅管理员或部门主管可授予权限
- **授权原因**：必须填写授权原因（如"质量部需要跨部门查看生产记录"）
- **权限过期**：可设置权限过期时间（如临时授予 1 个月查看权限）
- **授权通知**：权限授予后自动通知被授权用户

---

### BR-351: 权限撤销规则

- **撤销权限**：管理员或原授权人可撤销权限
- **立即生效**：撤销后立即生效，用户刷新页面后失去权限
- **撤销通知**：权限撤销后自动通知被撤销用户

---

### BR-352: 资源级权限规则

- **资源级权限**：可针对特定资源授予权限（如仅查看特定文档 DOC-001）
- **优先级**：资源级权限优先于全局权限（如禁止查看 DOC-001，即使有全局查看权限）
- **资源删除**：资源删除时，自动删除该资源的所有资源级权限

---

### BR-353: 权限过期处理规则

- **定时检查**：每日凌晨 1 点检查过期权限
- **自动撤销**：过期权限自动撤销
- **过期通知**：过期前 3 天通知用户和授权人

---

## 2. API 设计

### 2.1 查询所有权限定义

```
GET /api/v1/permissions
```

**响应**:
```typescript
{
  "success": true,
  "data": [
    {
      "id": "perm_001",
      "code": "document:view",
      "name": "查看文档",
      "category": "document",
      "scope": "department",
      "description": "查看本部门文档"
    },
    {
      "id": "perm_002",
      "code": "document:view:cross_department",
      "name": "跨部门查看文档",
      "category": "document",
      "scope": "cross_department",
      "description": "查看其他部门文档"
    }
  ]
}
```

---

### 2.2 授予权限

```
POST /api/v1/user-permissions
```

**请求体**:
```typescript
{
  "userId": "user_123",
  "permissionId": "perm_002",
  "reason": "质量部需要跨部门查看生产记录",
  "expiresAt": "2026-03-13T23:59:59Z",  // 可选，权限过期时间
  "resourceType": "document",            // 可选，资源类型
  "resourceId": "doc_456"                // 可选，资源 ID
}
```

**响应**:
```typescript
{
  "success": true,
  "data": {
    "id": "up_789",
    "userId": "user_123",
    "permissionId": "perm_002",
    "grantedBy": "user_admin",
    "grantedByName": "管理员",
    "grantedAt": "2026-02-13T10:00:00Z",
    "expiresAt": "2026-03-13T23:59:59Z",
    "reason": "质量部需要跨部门查看生产记录"
  }
}
```

---

### 2.3 撤销权限

```
DELETE /api/v1/user-permissions/:id
```

**响应**:
```typescript
{
  "success": true,
  "message": "权限已撤销"
}
```

---

### 2.4 查询用户权限列表

```
GET /api/v1/user-permissions?userId=user_123
```

**响应**:
```typescript
{
  "success": true,
  "data": [
    {
      "id": "up_789",
      "permission": {
        "code": "document:view:cross_department",
        "name": "跨部门查看文档"
      },
      "grantedBy": "管理员",
      "grantedAt": "2026-02-13T10:00:00Z",
      "expiresAt": "2026-03-13T23:59:59Z",
      "status": "active"  // active | expired
    }
  ]
}
```

---

### 2.5 检查用户是否有特定权限

```
GET /api/v1/user-permissions/check?userId=user_123&permissionCode=document:view:cross_department
```

**响应**:
```typescript
{
  "success": true,
  "data": {
    "hasPermission": true,
    "expiresAt": "2026-03-13T23:59:59Z"
  }
}
```

---

## 3. 前端界面设计

### 3.1 用户权限管理页面

**页面路由**: `/users/:id/permissions`

**页面布局**:
```
┌────────────────────────────────────────────────────────────┐
│ 用户权限管理 - 张三（生产部）                 [+ 授予权限]  │
├────────────────────────────────────────────────────────────┤
│ 权限列表                                                    │
│ ┌────────────────────────────────────────────────────────┐ │
│ │ 权限名称           │ 范围     │ 授予人 │ 过期时间 │操作│ │
│ ├────────────────────────────────────────────────────────┤ │
│ │ 查看文档            │ 本部门   │ 管理员 │ 永久     │[撤]│ │
│ │ 跨部门查看文档      │ 跨部门   │ 管理员 │ 2026-03 │[撤]│ │
│ └────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────┘
```

---

### 3.2 授予权限对话框

**对话框尺寸**: `60% × 70%`

**对话框内容**:
```
┌─────────────────────────────────────────┐
│ 授予权限                         [×]     │
├─────────────────────────────────────────┤
│ *权限类别: [文档权限 ▼]                  │
│                                         │
│ *权限名称: [跨部门查看文档 ▼]            │
│                                         │
│ *授权原因:                               │
│ [___________________________________]   │
│ [___________________________________]   │
│                                         │
│ 权限过期时间: [2026-03-13 ▼]  (可选)    │
│                                         │
│ 资源级权限 (可选):                       │
│ 资源类型: [文档 ▼]                       │
│ 资源ID: [DOC-2026-001]                  │
│                                         │
│              [取消]  [确定授予]          │
└─────────────────────────────────────────┘
```

---

### 3.3 Vue 3 代码示例

```vue
<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import {
  getUserPermissions,
  grantPermission,
  revokePermission
} from '@/api/permission'

const userId = ref('')
const permissions = ref([])
const grantDialogVisible = ref(false)

const grantForm = ref({
  permissionId: '',
  reason: '',
  expiresAt: null,
  resourceType: null,
  resourceId: null
})

const fetchPermissions = async () => {
  const res = await getUserPermissions(userId.value)
  permissions.value = res.data
}

const handleGrant = async () => {
  try {
    await grantPermission({
      userId: userId.value,
      ...grantForm.value
    })
    ElMessage.success('权限授予成功')
    grantDialogVisible.value = false
    fetchPermissions()
  } catch (error) {
    ElMessage.error(error.message || '授予失败')
  }
}

const handleRevoke = async (permissionId: string) => {
  await ElMessageBox.confirm('确定撤销该权限？', '撤销权限', {
    type: 'warning'
  })

  try {
    await revokePermission(permissionId)
    ElMessage.success('权限已撤销')
    fetchPermissions()
  } catch (error) {
    ElMessage.error(error.message || '撤销失败')
  }
}

onMounted(() => {
  fetchPermissions()
})
</script>

<template>
  <div class="user-permissions">
    <el-button type="primary" @click="grantDialogVisible = true">
      + 授予权限
    </el-button>

    <el-table :data="permissions">
      <el-table-column prop="permission.name" label="权限名称" />
      <el-table-column prop="permission.scope" label="范围" />
      <el-table-column prop="grantedByName" label="授予人" />
      <el-table-column label="过期时间">
        <template #default="{ row }">
          {{ row.expiresAt || '永久' }}
        </template>
      </el-table-column>
      <el-table-column label="状态">
        <template #default="{ row }">
          <el-tag :type="row.status === 'active' ? 'success' : 'danger'">
            {{ row.status === 'active' ? '有效' : '已过期' }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column label="操作" width="80">
        <template #default="{ row }">
          <el-button
            link
            type="danger"
            @click="handleRevoke(row.id)"
          >
            撤销
          </el-button>
        </template>
      </el-table-column>
    </el-table>

    <!-- 授予权限对话框 -->
    <el-dialog
      v-model="grantDialogVisible"
      title="授予权限"
      width="60%"
    >
      <el-form :model="grantForm" label-width="120px">
        <el-form-item label="权限名称" required>
          <el-select v-model="grantForm.permissionId" placeholder="请选择">
            <el-option label="跨部门查看文档" value="perm_002" />
            <el-option label="编辑任务" value="perm_003" />
          </el-select>
        </el-form-item>
        <el-form-item label="授权原因" required>
          <el-input
            v-model="grantForm.reason"
            type="textarea"
            :rows="3"
            placeholder="请输入授权原因"
          />
        </el-form-item>
        <el-form-item label="权限过期时间">
          <el-date-picker
            v-model="grantForm.expiresAt"
            type="datetime"
            placeholder="选择日期时间"
          />
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="grantDialogVisible = false">取消</el-button>
        <el-button type="primary" @click="handleGrant">确定授予</el-button>
      </template>
    </el-dialog>
  </div>
</template>
```

---

## 4. 实施检查清单

### 4.1 数据模型

- [ ] 1a. Permission 表创建成功
- [ ] 1b. UserPermission 表创建成功
- [ ] 1c. 索引创建成功（userId, permissionId, expiresAt）
- [ ] 1d. 初始化 12+ 权限定义

---

### 4.2 API 实现

- [ ] 2a. GET /api/v1/permissions 实现
- [ ] 2b. POST /api/v1/user-permissions 实现
- [ ] 2c. DELETE /api/v1/user-permissions/:id 实现
- [ ] 2d. GET /api/v1/user-permissions 实现
- [ ] 2e. GET /api/v1/user-permissions/check 实现

---

### 4.3 权限守卫

- [ ] 3a. PermissionGuard 实现
- [ ] 3b. @RequirePermission() 装饰器实现
- [ ] 3c. 权限校验逻辑正确（含过期检查）
- [ ] 3d. 资源级权限校验正确

---

### 4.4 定时任务

- [ ] 4a. 每日检查过期权限定时任务
- [ ] 4b. 过期权限自动撤销
- [ ] 4c. 过期前 3 天通知用户

---

### 4.5 业务规则

- [ ] 5a. BR-349 权限定义规则验证通过
- [ ] 5b. BR-350 权限授予规则验证通过
- [ ] 5c. BR-351 权限撤销规则验证通过
- [ ] 5d. BR-352 资源级权限规则验证通过
- [ ] 5e. BR-353 权限过期处理规则验证通过

---

### 4.6 前端界面

- [ ] 6a. 用户权限管理页面实现
- [ ] 6b. 授予权限对话框实现
- [ ] 6c. 权限列表显示正确
- [ ] 6d. 过期状态标签显示正确

---

### 4.7 测试

- [ ] 7a. 权限授予场景测试通过
- [ ] 7b. 权限撤销场景测试通过
- [ ] 7c. 权限过期场景测试通过
- [ ] 7d. 资源级权限场景测试通过

---

**本文档完成 ✅**
