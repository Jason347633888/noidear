# 内审管理系统（Layer 2 体系管理）

> **来源**: DESIGN.md 第十六章（内审管理系统）  
> **文档版本**: 1.0  
> **最后更新**: 2026-02-14  
> **实现状态**: ⏳ 未实现（PRD + LLD 已完成）  
> **优先级**: ⭐⭐ 中等（Phase C 体系管理）  
> **依赖**: 动态表单引擎、TodoTask 统一待办、移动端应用

---

## 目录

- [1. 系统定位](#1-系统定位)
- [2. 业务流程](#2-业务流程)
- [3. 数据模型](#3-数据模型)
- [4. 业务规则](#4-业务规则)

---

## 1. 系统定位

**内审系统作为独立业务模块**（简化版），负责体系内审计划、审核执行、整改跟踪、内审报告归档。

### 1.1 核心优势

| 优势 | 说明 |
|------|------|
| **架构简化** | 不做条款匹配、不做检查表自动生成、不做移动端 |
| **灵活复用** | 支持复制历史内审计划，季度/半年/年度计划可重复利用 |
| **流程清晰** | 创建计划 → 启动审核 → 记录发现 → 生成待办 → 整改复审 → 归档报告 |
| **统一待办** | 复用 TodoTask 系统，整改任务统一管理 |
| **自动归档** | 内审报告自动生成 PDF 并归档到文档系统 |

### 1.2 核心职责

1. **内审计划管理**: 创建计划（季度/半年/年度）、勾选审核文档（按级别/部门）、复制历史计划（重复利用）
2. **审核执行**: 逐个审核文档、记录审核结果（符合/不符合）、记录不符合项（问题类型、责任人）
3. **整改跟踪**: 自动生成整改待办（TodoTask）、责任人提交整改、内审员复审验证
4. **内审报告归档**: 自动生成 PDF 报告、归档到文档系统（四级文件）

---

## 2. 业务流程

### 2.1 核心流程（简要版）

```
【内审计划管理】
Step 1: 创建内审计划
  ├── 输入基本信息（标题、类型、审核时间、内审员）
  ├── 勾选审核文档（按级别/部门筛选、批量勾选）
  └── 保存计划（状态: draft, 可随时启动）

Step 1.5: 复制历史内审计划（可选）
  ├── 选择历史计划 → 点击"复制"按钮
  ├── 系统自动复制文档列表、计划类型、基本配置
  ├── 修改标题、审核时间、内审员
  └── 保存新计划

【审核执行】
Step 2: 启动内审计划
  ├── 点击"启动内审"按钮 → 状态: draft → ongoing
  └── 进入审核页面（不生成待办任务）

Step 3: 内审员逐个审核文档
  ├── 查看文档列表（已勾选的 50 个文档）
  ├── 审核进度显示: "已审核 0/50"
  ├── 逐个审核:
  │   ├── 点击"审核" → 查看文档内容（预览/下载）
  │   ├── 填写审核结果: [符合] [不符合]
  │   ├── 如果选"不符合" → 填写问题详情:
  │   │   ├── 问题类型: [需要修改] [缺失记录] [文档缺失]
  │   │   ├── 问题描述: [文本框, 必填]
  │   │   ├── 责任部门: [下拉选择]
  │   │   ├── 责任人: [下拉选择]
  │   │   └── 整改期限: 自动计算（审核日期 + 30 天）
  │   ├── 点击"保存" → 生成 AuditFinding 记录
  │   └── 审核进度更新: "已审核 1/50"
  └── 所有文档审核完毕 → 审核进度: "已审核 50/50"

Step 4: 提交审核报告
  ├── 系统显示审核汇总（总数、符合、不符合、不符合项清单）
  ├── 内审员确认审核结果
  └── 点击"提交审核报告"

【整改跟踪】
Step 5: 系统自动生成整改待办
  ├── 内审计划状态: ongoing → pending_rectification
  ├── 自动生成整改待办任务（TodoTask）:
  │   ├── 待办 1:
  │   │   ├── 类型: audit_rectification
  │   │   ├── 关联: AuditFinding ID
  │   │   ├── 责任人: 李四（生产部）
  │   │   ├── 标题: "整改'GMP-SOP-001'审核发现"
  │   │   ├── 描述: "第 3.2 节清洁频次描述不清"
  │   │   └── 截止日期: 2024-04-15（审核日期 + 30 天）
  │   └── ... (共 5 个待办, 只针对"不符合"项)
  ├── 不符合项状态: pending → rectifying
  └── 发送通知给责任人

Step 6: 责任人整改
  ├── 责任人收到待办任务 → 进入"我的待办"查看详情
  ├── 整改文档:
  │   ├── 场景 1: 需要修改 → 修改文档 → 提交审批 → 生成新版本 v2.0
  │   ├── 场景 2: 缺失记录 → 补填四级记录表
  │   └── 场景 3: 文档缺失 → 创建新文档 → 提交审批
  ├── 提交复审:
  │   ├── 系统自动关联整改后的文档版本
  │   │   └── rectificationDocumentId = doc-001, rectificationVersion = "v2.0"
  │   ├── 不符合项状态: rectifying → pending_verification
  │   └── 待办状态: pending → pending_verification
  └── 等待内审员复审

Step 7: 内审员复审验证
  ├── 查看待复审的不符合项列表（5 个）
  ├── 逐个验证:
  │   ├── 点击不符合项 → 查看整改详情
  │   ├── 验证结果:
  │   │   ├── 通过:
  │   │   │   ├── 不符合项状态: pending_verification → verified
  │   │   │   ├── 待办任务状态: pending_verification → completed
  │   │   │   └── 记录验证人和验证时间
  │   │   └── 驳回:
  │   │       ├── 填写驳回原因
  │   │       ├── 不符合项状态: pending_verification → rectifying
  │   │       ├── 待办任务重新分配给责任人
  │   │       └── 责任人重新整改
  │   └── 继续验证下一个...
  └── 所有不符合项验证通过 → 可完成内审计划

【内审报告归档】
Step 8: 完成内审计划
  ├── 所有不符合项状态 = verified
  ├── 点击"完成内审"按钮 → 状态: pending_rectification → completed
  └── 系统自动生成内审报告

Step 9: 系统自动生成内审报告
  ├── 生成 PDF 报告内容:
  │   ├── 基本信息（标题、日期、内审员）
  │   ├── 审核范围（文档数量、级别分布）
  │   ├── 审核结果汇总（符合/不符合统计）
  │   ├── 不符合项清单（按部门、问题类型分组）
  │   └── 整改验证记录
  ├── 上传 PDF 到 MinIO
  └── 自动归档到文档系统（创建四级文件）:
      ├── 文档编号: REC-AUDIT-{YYYY}-{序号}（自动生成）
      ├── 文档标题: {内审标题}-内审报告-{日期}
      ├── 文档类型: 内审记录（固定）
      ├── 文件级别: 4
      └── 文件 URL: MinIO 路径
```

---

## 3. 数据模型

### 3.1 内审管理核心表（3 个）

**核心表**:
1. AuditPlan - 内审计划
2. AuditFinding - 审核发现（内审记录）
3. AuditReport - 内审报告（归档）

**内审计划表示例**:

```prisma
model AuditPlan {
  id          String   @id @default(cuid())
  title       String   // "2024-Q1 内审"
  type        String   // "quarterly" | "semiannual" | "annual"
  
  startDate   DateTime // 审核起始日期
  endDate     DateTime // 审核结束日期
  
  documentIds String[] // 计划审核的文档 ID 列表(批量勾选)
  
  status      String   @default("draft")
                       // draft: 草稿(可启动)
                       // ongoing: 审核中
                       // pending_rectification: 等待整改
                       // completed: 已完成
  
  auditorId   String   // 内审员
  createdBy   String   // 创建人
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  startedAt   DateTime? // 启动时间
  completedAt DateTime? // 完成时间
  
  auditor     User @relation("AuditedPlans", fields: [auditorId], references: [id])
  creator     User @relation("CreatedAuditPlans", fields: [createdBy], references: [id])
  
  findings    AuditFinding[]
  report      AuditReport?
  
  @@index([status, startDate])
  @@index([auditorId])
  @@index([createdBy])
}
```

**审核发现表示例**:

```prisma
model AuditFinding {
  id          String   @id @default(cuid())
  planId      String   // 所属内审计划
  
  documentId  String   // 关联的文档
  auditResult String   // "符合" | "不符合"
  
  // 以下字段仅在 auditResult = "不符合" 时填写
  issueType   String?  // "需要修改" | "缺失记录" | "文档缺失"
  description String?  // 问题描述(必填)
  
  department  String?  // 责任部门
  assigneeId  String?  // 责任人
  dueDate     DateTime? // 整改期限(审核日期 + 30 天)
  
  status      String   @default("pending")
                       // pending: 待整改(仅"不符合"项有此状态)
                       // rectifying: 整改中
                       // pending_verification: 待复审
                       // verified: 已验证通过
                       // rejected: 复审驳回
  
  // 整改证据(系统自动记录)
  rectificationDocumentId String?  // 整改后的文档 ID
  rectificationVersion    String?  // 整改后的文档版本号
  
  verifiedBy       String?  // 验证人(内审员)
  verifiedAt       DateTime?
  rejectionReason  String?  // 驳回原因
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  plan        AuditPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  document    Document @relation("AuditFindings", fields: [documentId], references: [id])
  assignee    User? @relation("AssignedAuditFindings", fields: [assigneeId], references: [id])
  verifier    User? @relation("VerifiedAuditFindings", fields: [verifiedBy], references: [id])
  
  @@index([planId, auditResult])
  @@index([assigneeId, status])
  @@index([status, dueDate])
}
```

---

## 4. 业务规则

### 4.1 内审计划规则（BR-116 ~ BR-120）

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-116 | **内审计划创建规则**: 标题必填（5-100字符）；类型必选（quarterly/semiannual/annual）；审核时间范围必填（startDate < endDate）；内审员必选且必须为在职员工；至少勾选 1 个审核文档 | 前端校验 + 后端校验 |
| BR-117 | **内审计划文档勾选规则**: 只能勾选已发布的文档（status = published）；支持按文档级别筛选（1/2/3/4）；支持按部门筛选；支持批量勾选/取消勾选；勾选后的文档列表保存到 documentIds 数组 | 前端组件 + 后端存储 |
| BR-118 | **内审计划复制规则**: 可以复制任意状态的历史计划；复制内容（文档列表、计划类型）；不复制内容（审核发现、审核报告、审核时间、内审员）；复制后的计划状态为 draft | 复制 API |
| BR-119 | **内审计划启动规则**: 只有 draft 状态的计划可以启动；启动后状态变为 ongoing；启动时不生成待办任务；启动后直接进入审核页面 | 状态机 |
| BR-120 | **内审计划状态流转**: draft（草稿）→ ongoing（审核中）→ pending_rectification（等待整改）→ completed（已完成） | 状态机 |

### 4.2 审核执行规则（BR-121 ~ BR-125）

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-121 | **审核文档记录规则**: 所有文档都必须记录审核结果（包括"符合"的）；审核结果只有两种（符合/不符合）；审核结果为"符合"时只记录 auditResult = "符合"，其他字段为 null；审核结果为"不符合"时必须填写问题类型、问题描述（最少 10 字符）、责任部门、责任人，dueDate 自动计算（审核日期 + 30 天） | 前端校验 + 后端校验 |
| BR-122 | **问题类型枚举**: "需要修改"（文档内容有错误或不完善，需要修改）；"缺失记录"（四级记录文件缺少应有的记录）；"文档缺失"（应该存在的文档不存在，需要创建） | 枚举类型 |
| BR-123 | **审核进度计算**: 审核进度 = 已审核文档数 / 计划审核文档数 × 100%；已审核文档 = 有 AuditFinding 记录的文档；所有文档审核完毕 = 审核进度 100% | 自动计算 |
| BR-124 | **审核报告提交条件**: 必须所有文档都已审核（审核进度 = 100%）；提交后生成整改待办任务（仅针对"不符合"项）；提交后内审计划状态变为 pending_rectification | 前端校验 + 自动触发 |
| BR-125 | **审核结果不可修改规则**: 审核报告提交后审核结果不可修改；如需修改必须"撤回审核报告"（状态: pending_rectification → ongoing）；撤回后已生成的整改待办任务自动删除 | 状态机 + 级联删除 |

### 4.3 整改跟踪规则（BR-126 ~ BR-130）

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-126 | **整改待办任务生成规则**: 提交审核报告时自动生成整改待办任务；只为"不符合"项生成待办；待办任务内容（type = audit_rectification，relatedId = AuditFinding.id，userId = AuditFinding.assigneeId，title = "整改'{文档标题}'审核发现"，description = AuditFinding.description，dueDate = AuditFinding.dueDate，priority = high） | TodoTask 自动创建 |
| BR-127 | **整改提交规则**: 责任人修改/补填文档后点击"提交复审"；系统自动记录整改证据（rectificationDocumentId、rectificationVersion）；不需要责任人填写整改说明；提交后不符合项状态变为 pending_verification，待办任务状态变为 pending_verification | 自动触发逻辑 |
| BR-128 | **整改复审验证规则**: 只有内审员可以验证整改；验证选项（通过：不符合项状态 → verified，待办任务状态 → completed，记录 verifiedBy/verifiedAt；驳回：不符合项状态 → rectifying，待办任务重新分配给责任人，记录 rejectionReason（必填），责任人重新整改） | 权限控制 + 状态机 |
| BR-129 | **整改期限监控规则**: 整改期限默认为审核日期 + 30 天；超过期限未整改时待办任务标记为"逾期"（dueDate < 当前日期），系统每天发送逾期提醒（邮件/站内信）；允许延期（责任人可申请延期需内审员审批，延期后更新 dueDate） | 定时任务 + 通知系统 |
| BR-130 | **内审计划完成条件**: 所有不符合项状态 = verified；满足条件后可点击"完成内审"；完成后内审计划状态变为 completed，自动生成内审报告 PDF，自动归档到文档系统 | 自动触发逻辑 |

### 4.4 内审报告规则（BR-131 ~ BR-135）

| 编号 | 规则 | 实现方式 |
|------|------|----------|
| BR-131 | **内审报告生成时机**: 内审计划状态变为 completed 时自动生成；生成内容包括基本信息（标题、日期、内审员）、审核范围（文档数量、级别分布、部门分布）、审核结果汇总（符合/不符合统计）、不符合项清单（按部门、问题类型分组）、整改验证记录（责任人、整改证据、验证结果） | PDF 生成 |
| BR-132 | **内审报告归档规则**: 生成 PDF 后自动归档到文档系统（创建四级文件）；文档编号 REC-AUDIT-{YYYY}-{序号}（序号为该年度内审报告的顺序号如 001, 002...）；文档标题 {内审标题}-内审报告-{完成日期}（示例"2024-Q1 内审-内审报告-2024-04-30"）；文档类型 audit_record（固定）；文件级别 4；归属部门质量部（固定） | 自动创建 Document |
| BR-133 | **内审报告 PDF 格式**: 包含基本信息、审核范围、审核结果汇总、不符合项清单表格、整改验证记录表格、统计分析（按部门分布、按问题类型分布、整改及时率、平均整改时长）、生成时间 | PDF 模板 |
| BR-134 | **内审报告唯一性**: 每个内审计划只能生成一次报告；重复生成返回 409 Conflict | `AuditReport.planId @unique` |
| BR-135 | **内审报告版本管理**: 内审报告归档后作为四级文件管理；如需修改报告需要创建新版本（Document.version）；历史版本可追溯 | Document 版本机制 |

---

**本文档完成 ✅**
