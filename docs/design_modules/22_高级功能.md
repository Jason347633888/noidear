# 高级功能（Advanced Features）

> **来源**: DESIGN.md 未来版本规划  
> **文档版本**: 1.0  
> **最后更新**: 2026-02-14  
> **实现状态**: 📋 规划中（Phase 2 / Phase B）  
> **优先级**: ⭐⭐ 中等（MVP 后实施）  
> **依赖**: MVP Phase 1-6 完成

---

## 说明

本文档记录 **MVP 之后** 的高级功能规划。这些功能将在 Phase 2（高级功能）和 Phase B（核心生产流程扩展）中实施。

---

## 目录

- [1. 高可用架构（Phase 2）](#1-高可用架构phase-2)
- [2. 工作流高级功能（v2.1.0）](#2-工作流高级功能v210)
- [3. 智能文档高级功能（v2.2.0）](#3-智能文档高级功能v220)
- [4. 核心生产流程扩展（Phase B）](#4-核心生产流程扩展phase-b)

---

## 1. 高可用架构（Phase 2）

### 1.1 负载均衡与集群

**目标**：支持 500+ 并发用户，提供 99.9% 可用性

**架构升级**：

```
负载均衡器（Nginx + Keepalived 主备）
    ↓
NestJS 应用集群（3+ 实例）
    ↓
┌─────────────┬─────────────┬─────────────┐
│ PostgreSQL  │   Redis     │ MinIO       │
│ 主从复制    │  Sentinel   │ 分布式集群  │
└─────────────┴─────────────┴─────────────┘
```

**关键技术**：
- NestJS 多实例部署 + PM2 进程管理
- PostgreSQL 主从复制（Patroni + etcd）
- Redis Sentinel（1 主 2 从）
- MinIO 分布式集群（4 节点，纠删码）
- Nginx Keepalived 双机热备

**实施优先级**: ⭐⭐ 中等  
**预估工作量**: 4-6 周

---

### 1.2 数据库读写分离

**目标**：提升数据库查询性能，降低主库压力

**实施方式**：
- Prisma 配置读写分离（主库写、从库读）
- 查询 API 路由到从库
- 写入/更新 API 路由到主库
- 主从延迟监控（Prometheus 告警）

**关键指标**：
- 查询响应时间 < 100ms（P95）
- 主从延迟 < 1s
- 读写比例 8:2

**实施优先级**: ⭐⭐ 中等  
**预估工作量**: 1-2 周

---

## 2. 工作流高级功能（v2.1.0）

### 2.1 条件分支

**功能**：根据表单字段值动态选择审批路径

**示例场景**：
- 金额 > 10000 元 → 需要总经理审批
- 金额 ≤ 10000 元 → 只需部门主管审批

**实施方式**：
- WorkflowTemplate.steps JSON 支持 `condition` 字段
- 支持逻辑表达式（如 `amount > 10000`）
- 工作流引擎动态计算下一步审批人

**实施优先级**: ⭐⭐ 中等  
**预估工作量**: 1-2 周

---

### 2.2 审批委托

**功能**：审批人可将待办任务委托给其他人

**实施方式**：
- WorkflowTask 表新增 `delegatedTo` 字段
- 委托历史记录（DelegationLog 表）
- 委托人仍可查看审批进度

**实施优先级**: ⭐ 低  
**预估工作量**: 1 周

---

### 2.3 审批抄送

**功能**：审批通过/驳回时自动抄送给相关人员

**实施方式**：
- WorkflowTemplate.steps 支持 `ccUsers` 字段
- 发送抄送通知（站内信 + 邮件）
- 抄送人可查看审批详情（只读）

**实施优先级**: ⭐ 低  
**预估工作量**: 0.5 周

---

## 3. 智能文档高级功能（v2.2.0）

### 3.1 文档智能推荐

**功能**：根据用户角色和历史操作推荐相关文档

**实施方式**：
- 记录用户查看/下载文档历史（DocumentViewLog 表）
- 协同过滤算法推荐相关文档
- 首页显示"推荐文档"模块

**实施优先级**: ⭐ 低  
**预估工作量**: 2 周

---

### 3.2 文档全文搜索

**功能**：支持 PDF/Word 文档全文搜索（OCR + 关键词索引）

**实施方式**：
- Elasticsearch 全文索引
- PDF 文本提取（pdf.js）
- Word 文本提取（mammoth.js）
- 搜索结果高亮显示

**实施优先级**: ⭐ 低  
**预估工作量**: 3-4 周

---

### 3.3 文档对比功能

**功能**：对比两个版本文档的差异（文本 diff）

**实施方式**：
- PDF 转文本后对比（diff 算法）
- 高亮显示新增/删除/修改内容
- 支持导出对比报告

**实施优先级**: ⭐ 低  
**预估工作量**: 2 周

---

## 4. 核心生产流程扩展（Phase B）

### 4.1 生产计划管理

**功能**：根据订单自动生成生产计划

**核心模块**：
- 订单管理（Order）
- 生产计划（ProductionPlan）
- 工单管理（WorkOrder）
- BOM 配方管理（Recipe）

**实施优先级**: ⭐⭐⭐ 高（Phase B 核心）  
**预估工作量**: 6-8 周

---

### 4.2 质量检验管理

**功能**：进货检验、过程检验、成品检验

**核心模块**：
- 检验项目（InspectionItem）
- 检验记录（InspectionRecord）
- 不合格品处理（NonConformity）

**实施优先级**: ⭐⭐⭐ 高（Phase B 核心）  
**预估工作量**: 4-6 周

---

### 4.3 仓库高级功能

**扩展功能**：
- 库存预警（最小库存/最大库存）
- 库存调拨（跨仓库转移）
- 盘点管理（定期盘点、差异分析）
- 库存报表（库龄分析、周转率）

**实施优先级**: ⭐⭐ 中等  
**预估工作量**: 2-3 周

---

### 4.4 设备高级功能

**扩展功能**：
- 设备备件管理（SparePart 表）
- 设备维修成本统计
- 设备效率分析（OEE 指标）
- 设备生命周期管理

**实施优先级**: ⭐⭐ 中等  
**预估工作量**: 2-3 周

---

## 5. 移动端高级功能

### 5.1 扫码功能（v2.0）

**功能**：扫描设备二维码、物料条形码

**实施方式**：
- 调用微信扫码 API（wx.scanCode）
- 支持二维码/条形码识别
- 自动填充表单字段

**实施优先级**: ⭐⭐ 中等  
**预估工作量**: 1 周

---

### 5.2 语音识别

**功能**：语音输入填写记录（现场免手输）

**实施方式**：
- 调用微信语音识别 API
- 语音转文本
- 自动填充 textarea 字段

**实施优先级**: ⭐ 低  
**预估工作量**: 1 周

---

## 6. 实施路线图

### Phase 2.1（2-3 个月）

**核心目标**：系统稳定性提升

- ✅ 高可用架构（负载均衡 + 主从复制）
- ✅ 数据库读写分离
- ✅ 性能优化（缓存策略、SQL 优化）
- ✅ 监控告警完善（Grafana 仪表板）

---

### Phase 2.2（3-4 个月）

**核心目标**：工作流引擎增强

- ✅ 条件分支
- ✅ 审批委托
- ✅ 审批抄送
- ✅ 工作流可视化设计器（低代码配置）

---

### Phase 2.3（4-6 个月）

**核心目标**：智能文档功能

- ✅ 文档智能推荐
- ✅ 文档全文搜索（Elasticsearch）
- ✅ 文档对比功能

---

### Phase B（6-12 个月）

**核心目标**：核心生产流程完整闭环

- ✅ 生产计划管理
- ✅ 质量检验管理
- ✅ 仓库高级功能
- ✅ 设备高级功能

---

## 7. 成功标准

### Phase 2 成功标准

**高可用架构**：
- ✅ 系统可用性 ≥ 99.9%（月度统计）
- ✅ 并发用户 ≥ 500
- ✅ API P99 响应时间 < 500ms

**工作流引擎**：
- ✅ 支持条件分支（至少 3 种逻辑运算符）
- ✅ 支持审批委托（委托历史可追溯）
- ✅ 支持审批抄送（抄送通知准确率 100%）

**智能文档**：
- ✅ 推荐准确率 ≥ 60%（用户点击率）
- ✅ 全文搜索召回率 ≥ 95%
- ✅ 文档对比准确率 ≥ 90%

---

### Phase B 成功标准

**生产计划管理**：
- ✅ 订单自动生成工单（准确率 100%）
- ✅ BOM 自动计算原料需求（误差 < 2%）
- ✅ 生产进度实时更新

**质量检验管理**：
- ✅ 检验记录 100% 数字化
- ✅ 不合格品处理闭环追溯
- ✅ 检验报告自动生成（PDF）

---

**本文档完成 ✅**

---

## 业务规则补充（BR-273, BR-277~280, BR-282~344）

### 智能文档引擎规则（BR-301 ~ BR-323）

| 编号 | 规则描述 | 实施方式 |
|------|----------|---------|
| **BR-301** | 文档关系图：自动分析文档引用关系，生成关系图谱 | 图数据库 + D3.js 可视化 |
| **BR-302** | 变更影响分析：修改文档时，自动分析影响范围 | 引用关系遍历算法 |
| **BR-303** | 版本对比：支持任意两个版本的文档对比 | Diff 算法 + 高亮显示 |
| **BR-304** | 协作编辑：多人同时编辑文档（冲突检测） | WebSocket + OT算法 |
| **BR-305** | 评论批注：支持在文档任意位置添加评论 | Tiptap 评论插件 |
| **BR-306** | @提及功能：评论中可以 @其他用户 | 用户提及组件 + 通知 |
| **BR-307** | 文档锁定：编辑中的文档锁定，其他人只读 | 分布式锁(Redis) |
| **BR-308** | 自动保存：每 30 秒自动保存草稿 | 定时器 + localStorage 备份 |
| **BR-309** | 历史版本回滚：可回滚到任意历史版本 | 版本快照 + 恢复操作 |
| **BR-310** | 文档模板：支持创建文档模板（预设格式） | 模板库 + 实例化 |
| **BR-311** | 富文本编辑器：支持表格、图片、公式 | Tiptap 扩展插件 |
| **BR-312** | Markdown 导入：支持导入 Markdown 文件 | Markdown 解析器 |
| **BR-313** | PDF 导出：文档导出为 PDF（带封面、目录） | Puppeteer + PDF 模板 |
| **BR-314** | Word 导出：文档导出为 Word（保留格式） | docx.js 库 |
| **BR-315** | 文档归档：归档后的文档不可编辑 | status = 'archived' 锁定 |
| **BR-316** | 文档作废：作废文档显示水印（红色斜体"作废"） | CSS 水印覆盖层 |
| **BR-317** | 文档搜索：全文搜索支持高亮关键词 | Elasticsearch + 高亮 |
| **BR-318** | 文档标签：支持添加标签分类文档 | Tag 表 + 多对多关联 |
| **BR-319** | 收藏夹：用户可以收藏常用文档 | Bookmark 表 |
| **BR-320** | 最近访问：记录用户最近访问的文档 | AccessLog 表 + 时间排序 |
| **BR-321** | 文档统计：显示文档阅读量、编辑次数 | 统计字段 + 计数器 |
| **BR-322** | 文档评分：用户可以对文档质量评分 | Rating 表 + 平均分 |
| **BR-323** | 文档分享：生成公开链接（可设置过期时间） | 分享token + 过期校验 |

---

### 工作流系统规则（BR-329~344）

| 编号 | 规则描述 | 实施方式 |
|------|----------|---------|
| **BR-329** | 工作流设计器：可视化拖拽设计工作流 | BPMN.js 引擎 |
| **BR-330** | 流程模板：支持创建流程模板（可复用） | WorkflowTemplate 表 |
| **BR-334** | 并行网关：支持并行分支（会签/或签） | BPMN 并行网关 |
| **BR-335** | 排他网关：支持条件分支（IF-ELSE） | BPMN 排他网关 |
| **BR-336** | 定时任务：支持定时触发流程 | Cron 表达式 + 调度器 |
| **BR-337** | 流程监控：实时查看流程执行状态 | 流程实例列表 + WebSocket |
| **BR-338** | 流程日志：记录每个节点的执行日志 | WorkflowLog 表 |
| **BR-339** | 流程回退：支持回退到上一步/任意步 | 历史节点列表 + 回退操作 |
| **BR-340** | 流程转办：当前节点可转办给其他人 | 转办操作 + 通知 |
| **BR-341** | 流程催办：超时未处理自动催办 | 定时任务 + 通知 |
| **BR-342** | 流程终止：流程发起人可终止流程 | 终止操作 + 权限校验 |
| **BR-343** | 流程暂停/恢复：支持暂停和恢复流程 | status = 'suspended' |
| **BR-344** | 流程统计：统计流程平均耗时、超时率 | 统计 SQL + 图表展示 |

---

### 运维监控规则（BR-273, BR-277~280, BR-282~289, BR-292~300）

| 编号 | 规则描述 | 实施方式 |
|------|----------|---------|
| **BR-273** | 系统 RPO 目标 24 小时，RTO 目标 2 小时 | 备份策略 + 恢复演练 |
| **BR-277** | HTTP 5xx 错误率 > 5% 触发告警 | Prometheus 告警规则 |
| **BR-278** | 登录失败次数 > 10次/分钟 触发告警（疑似暴力破解） | Prometheus 告警规则 |
| **BR-280** | 所有敏感操作必须记录审计日志 | SensitiveLog 拦截器 |
| **BR-282** | PostgreSQL 每天自动备份，保留 7 天 | Docker 定时任务 |
| **BR-283** | MinIO 文件每天自动备份，保留 7 天 | mc mirror 定时任务 |
| **BR-284** | Prometheus 指标保留 30 天 | Prometheus 配置 |
| **BR-285** | Loki 日志保留 30 天 | Loki 配置 |
| **BR-286** | API P99 响应时间 > 2秒 触发告警 | Prometheus 告警规则 |
| **BR-287** | 登录日志保留 90 天，权限变更/敏感操作永久保留 | 定时归档任务 |
| **BR-288** | 每月执行一次灾难恢复演练 | 运维流程 |
| **BR-289** | 审计日志归档到 MinIO audit-archive 桶 | 定时任务 + MinIO |
| **BR-292** | 系统监控指标采集间隔：15 秒 | Prometheus 配置 |
| **BR-293** | 告警通知方式：企业微信/邮件/短信 | 告警集成 |
| **BR-294** | 告警升级策略：Critical 立即通知，Warning 延迟 5 分钟 | 告警分级 |
| **BR-295** | 日志聚合：所有服务日志汇聚到 Loki | Loki Agent 配置 |
| **BR-296** | 日志查询：支持按时间、级别、服务筛选 | Loki Query 语法 |
| **BR-297** | 日志导出：支持导出查询结果为 JSON/CSV | 导出功能 |
| **BR-298** | 慢查询日志：SQL 执行时间 > 1 秒记录 | PostgreSQL 慢查询配置 |
| **BR-299** | API 访问日志：记录所有 API 请求（不含敏感字段） | 日志中间件 |
| **BR-300** | 性能分析：支持查看 API 耗时分布 | Prometheus + Grafana |

---

**BR 补充完成 ✅** (2026-02-14)
