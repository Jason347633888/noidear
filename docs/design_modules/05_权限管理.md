# 权限管理（RBAC）

> **来源**: DESIGN.md 第四章（核心功能模块）+ 第七章（数据模型）  
> **文档版本**: 1.0  
> **最后更新**: 2026-02-14  
> **实现状态**: ✅ 已实现（MVP Phase 1, 98.1% 完成）  
> **代码位置**: `server/src/modules/auth/` + `client/src/guards/`

---

## 目录

- [1. 功能概述](#1-功能概述)
- [2. 角色定义](#2-角色定义)
- [3. 权限控制](#3-权限控制)
- [4. 数据模型](#4-数据模型)
- [5. API 设计](#5-api-设计)

---

## 1. 功能概述

基于角色的访问控制（RBAC）系统，支持三种角色：Admin、Leader、User。

### 1.1 核心特性

- ✅ **三种角色**: Admin（管理员）、Leader（部门主管）、User（普通用户）
- ✅ **角色继承**: Admin > Leader > User
- ✅ **部门隔离**: 用户只能查看本部门的数据（除 Admin）
- ✅ **上级关系**: 用户必须有上级（用于审批流程）
- ✅ **兜底机制**: Admin 可以审批任何文件

### 1.2 MVP 限制

- ❌ **细粒度权限**: 不支持单独授予特定权限（如"跨部门查看记录"）
- ❌ **自定义角色**: 不支持创建新角色
- ❌ **权限过期**: 不支持临时权限授予

**注**: 细粒度权限见 [P1-2_细粒度权限.md](../technical_debt/P1-2_细粒度权限.md)

---

## 2. 角色定义

### 2.1 角色权限表

| 功能 | Admin | Leader | User |
|------|-------|--------|------|
| **用户管理** | ✅ 全部 | ❌ | ❌ |
| **部门管理** | ✅ 全部 | ❌ | ❌ |
| **文档上传** | ✅ | ✅ | ✅ |
| **文档审批** | ✅ 全部 | ✅ 本部门 | ✅ 被指定的 |
| **模板创建** | ✅ | ✅ | ❌ |
| **任务分发** | ✅ | ✅ | ❌ |
| **任务填写** | ✅ | ✅ | ✅ |
| **数据导出** | ✅ 全部 | ✅ 本部门 | ❌ |
| **统计分析** | ✅ 全部 | ✅ 本部门 | ❌ |

### 2.2 数据可见性规则

| 资源类型 | Admin | Leader | User |
|---------|-------|--------|------|
| **文档** | 全部 | 本部门 | 本部门（创建人或审批人） |
| **模板** | 全部 | 本部门 | 本部门 |
| **任务** | 全部 | 本部门 | 本部门 + 我的任务 |
| **记录** | 全部 | 本部门 | 我的记录 |
| **用户** | 全部 | 本部门 | 本部门 |

---

## 3. 权限控制

### 3.1 前端路由守卫

**路由权限配置**:
```typescript
// router/index.ts
const routes = [
  {
    path: '/users',
    component: UserList,
    meta: { requiresAuth: true, roles: ['admin'] }
  },
  {
    path: '/templates',
    component: TemplateList,
    meta: { requiresAuth: true, roles: ['admin', 'leader'] }
  },
  {
    path: '/my-tasks',
    component: TaskList,
    meta: { requiresAuth: true, roles: ['admin', 'leader', 'user'] }
  }
]
```

**路由守卫逻辑**:
```typescript
router.beforeEach((to, from, next) => {
  const user = store.state.user
  
  // 检查是否需要登录
  if (to.meta.requiresAuth && !user) {
    return next('/login')
  }
  
  // 检查角色权限
  if (to.meta.roles && !to.meta.roles.includes(user.role)) {
    return next('/403') // 无权限
  }
  
  next()
})
```

### 3.2 后端 API 权限装饰器

**NestJS 装饰器**:
```typescript
// decorators/roles.decorator.ts
export const Roles = (...roles: string[]) => SetMetadata('roles', roles)

// guards/roles.guard.ts
@Injectable()
export class RolesGuard implements CanActivate {
  canActivate(context: ExecutionContext): boolean {
    const requiredRoles = this.reflector.get<string[]>('roles', context.getHandler())
    if (!requiredRoles) {
      return true
    }
    
    const request = context.switchToHttp().getRequest()
    const user = request.user
    
    return requiredRoles.some(role => user.role === role)
  }
}
```

**使用示例**:
```typescript
@Controller('users')
export class UserController {
  @Get()
  @Roles('admin')  // 只有 admin 可访问
  findAll() {
    // ...
  }
}
```

---

## 4. 数据模型

### 4.1 用户表 (users)

```sql
users (
  id              SnowflakeID   PRIMARY KEY,
  username        VARCHAR(50)   UNIQUE NOT NULL,    -- 用户名
  password        VARCHAR(255)  NOT NULL,           -- bcrypt加密
  name            VARCHAR(100)  NOT NULL,           -- 姓名
  department_id   SnowflakeID   REFERENCES departments(id),
  role            VARCHAR(20)   NOT NULL DEFAULT 'user',  -- admin/leader/user
  superior_id     SnowflakeID   REFERENCES users(id),     -- 上级ID
  status          VARCHAR(10)   NOT NULL DEFAULT 'active', -- active/inactive
  login_attempts  INT           DEFAULT 0,               -- 登录失败次数
  locked_until    TIMESTAMP,                            -- 锁定截止时间
  created_at      TIMESTAMP   DEFAULT NOW(),
  updated_at      TIMESTAMP   DEFAULT NOW(),
  deleted_at      TIMESTAMP                              -- 软删除
);
```

### 4.2 权限表 (permissions) - P0-3 修复

```sql
-- P0-3 修复：细粒度权限控制
permissions (
  id          SnowflakeID   PRIMARY KEY,
  code        VARCHAR(50)   UNIQUE NOT NULL,     -- 权限代码
  name        VARCHAR(100)  NOT NULL,            -- 权限名称
  description VARCHAR(500),                       -- 权限说明
  category    VARCHAR(50)   NOT NULL,            -- 权限分类
  created_at  TIMESTAMP   DEFAULT NOW(),
  updated_at  TIMESTAMP   DEFAULT NOW()
);

user_permissions (
  id            SnowflakeID   PRIMARY KEY,
  user_id       SnowflakeID   REFERENCES users(id) ON DELETE CASCADE,
  permission_id SnowflakeID   REFERENCES permissions(id) ON DELETE CASCADE,
  granted_by    SnowflakeID   REFERENCES users(id),
  granted_at    TIMESTAMP   DEFAULT NOW(),
  UNIQUE(user_id, permission_id)
);
```

---

## 5. API 设计

### 5.1 认证 API

| 端点 | 方法 | 说明 | 权限 |
|------|------|------|------|
| `/api/v1/auth/login` | POST | 登录 | 公开 |
| `/api/v1/auth/me` | GET | 获取当前用户 | 已登录 |
| `/api/v1/auth/password` | PUT | 修改密码 | 已登录 |
| `/api/v1/auth/logout` | POST | 登出 | 已登录 |

### 5.2 登录 API

**请求**:
```http
POST /api/v1/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "12345678"
}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "user": {
      "id": "user_001",
      "username": "admin",
      "name": "管理员",
      "role": "admin",
      "departmentId": "dept_001",
      "departmentName": "总经办"
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

### 5.3 获取当前用户 API

**请求**:
```http
GET /api/v1/auth/me
Authorization: Bearer <token>
```

**响应**:
```json
{
  "success": true,
  "data": {
    "id": "user_001",
    "username": "admin",
    "name": "管理员",
    "role": "admin",
    "departmentId": "dept_001",
    "departmentName": "总经办",
    "permissions": ["viewAllRecords", "editUsers", "exportData"]
  }
}
```

---

**本文档完成 ✅**
