generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id
  username      String    @unique
  password      String
  name          String
  departmentId  String?
  department    Department? @relation("UserDepartment", fields: [departmentId], references: [id], onDelete: SetNull)
  role          String    @default("user")  // 保留（向后兼容）
  roleId        String?                     // P1-2: 新增角色外键
  roleObj       Role?     @relation("UserRole", fields: [roleId], references: [id], onDelete: SetNull)
  superiorId    String?
  superior      User?     @relation("UserSuperior", fields: [superiorId], references: [id], onDelete: SetNull)
  subordinates  User[]    @relation("UserSuperior")
  status        String    @default("active")
  loginAttempts Int       @default(0)
  lockedUntil   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?

  // 反向关系
  documentsCreated     Document[]       @relation("DocumentCreator")
  documentsApproved    Document[]       @relation("DocumentApprover")
  documentsArchived    Document[]       @relation("DocumentArchiver")
  documentsObsoleted   Document[]       @relation("DocumentObsoleter")
  versionsCreated      DocumentVersion[] @relation("VersionCreator")
  templatesCreated     Template[]       @relation("TemplateCreator")
  tasksCreated         Task[]           @relation("TaskCreator")
  taskRecordsSubmitted TaskRecord[]    @relation("RecordSubmitter")
  taskRecordsApproved  TaskRecord[]    @relation("RecordApprover")
  approvalsGiven       Approval[]       @relation("Approver")
  operationLogs        OperationLog[]
  notifications        Notification[]
  managedDepartments   Department[]     @relation("DepartmentManager")

  @@map("users")
}

model Department {
  id        String    @id
  code      String    @unique
  name      String
  parentId  String?
  parent    Department? @relation("DepartmentParent", fields: [parentId], references: [id], onDelete: SetNull)
  children  Department[] @relation("DepartmentParent")
  managerId String?
  manager   User?     @relation("DepartmentManager", fields: [managerId], references: [id], onDelete: SetNull)
  status    String    @default("active")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // 反向关系
  users          User[]          @relation("UserDepartment")
  numberRules    NumberRule[]
  pendingNumbers PendingNumber[]
  tasks          Task[]

  @@map("departments")
}

model NumberRule {
  id           String   @id
  level        Int
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  sequence     Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([level, departmentId])
  @@map("number_rules")
}

model PendingNumber {
  id           String     @id
  level        Int
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  number       String
  deletedAt    DateTime   @default(now())

  @@unique([level, departmentId, number])
  @@map("pending_numbers")
}

model Document {
  id          String    @id
  level       Int
  number      String    @unique
  title       String
  filePath    String
  fileName    String
  fileSize    Int
  fileType    String
  version     Decimal   @default(1.0) @db.Decimal(3, 1)
  status      String
  creatorId   String
  creator     User      @relation("DocumentCreator", fields: [creatorId], references: [id], onDelete: Restrict)
  approverId  String?
  approver    User?     @relation("DocumentApprover", fields: [approverId], references: [id], onDelete: SetNull)
  approvedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  // P1-1: 归档/作废字段
  archiveReason  String?
  archivedAt     DateTime?
  archivedBy     String?
  archiver       User?   @relation("DocumentArchiver", fields: [archivedBy], references: [id], onDelete: SetNull)
  obsoleteReason String?
  obsoletedAt    DateTime?
  obsoletedBy    String?
  obsoleter      User?   @relation("DocumentObsoleter", fields: [obsoletedBy], references: [id], onDelete: SetNull)

  // 反向关系
  versions    DocumentVersion[]
  approvals   Approval[]

  @@map("documents")
}

model DocumentVersion {
  id          String   @id
  documentId  String
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  version     Decimal  @db.Decimal(3, 1)
  filePath    String
  fileName    String
  fileSize    Int
  creatorId   String
  creator     User     @relation("VersionCreator", fields: [creatorId], references: [id], onDelete: Restrict)
  createdAt   DateTime @default(now())

  @@map("document_versions")
}

model Template {
  id        String   @id
  level     Int      @default(4)
  number    String   @unique
  title     String
  fieldsJson Json
  version   Decimal  @default(1.0) @db.Decimal(3, 1)
  status    String   @default("active")
  creatorId String
  creator   User     @relation("TemplateCreator", fields: [creatorId], references: [id], onDelete: Restrict)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  // 反向关系
  tasks       Task[]
  taskRecords TaskRecord[]

  @@map("templates")
}

model Task {
  id           String    @id
  templateId   String
  template     Template  @relation(fields: [templateId], references: [id], onDelete: Restrict)
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  deadline     DateTime
  status       String    @default("pending")
  creatorId    String
  creator      User      @relation("TaskCreator", fields: [creatorId], references: [id], onDelete: Restrict)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  // 反向关系
  records     TaskRecord[]

  @@index([departmentId])
  @@index([status])
  @@index([deadline])
  @@map("tasks")
}

model TaskRecord {
  id          String    @id
  taskId      String
  task        Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  templateId  String
  template    Template  @relation(fields: [templateId], references: [id], onDelete: Restrict)
  dataJson    Json
  status      String    @default("pending")
  submitterId String?
  submitter   User?     @relation("RecordSubmitter", fields: [submitterId], references: [id], onDelete: SetNull)
  submittedAt DateTime?
  approverId  String?
  approver    User?     @relation("RecordApprover", fields: [approverId], references: [id], onDelete: SetNull)
  approvedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  // Phase 7-8: 配方偏离检测
  relatedTemplateVersion Decimal?  @db.Decimal(3, 1)
  hasDeviation          Boolean   @default(false)
  deviationCount        Int       @default(0)

  // 反向关系
  approvals        Approval[]
  deviationReports DeviationReport[]

  @@map("task_records")
}

model Approval {
  id              String   @id
  documentId      String?
  document        Document? @relation(fields: [documentId], references: [id], onDelete: Cascade)
  recordId        String?
  record          TaskRecord? @relation(fields: [recordId], references: [id], onDelete: Cascade)
  approverId      String
  approver        User     @relation("Approver", fields: [approverId], references: [id], onDelete: Restrict)
  status          String
  comment         String?
  level           Int      @default(1)
  approvalChainId String?
  previousLevel   String?
  nextLevel       String?
  rejectionReason String?
  approvedAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt

  // Phase 7: 会签/顺签扩展字段
  approvalType    String   @default("single")  // single | countersign | sequential
  sequence        Int      @default(0)          // 顺签时的审批顺序
  groupId         String?                       // 会签/顺签分组标识

  @@index([approverId, status])
  @@index([recordId])
  @@index([documentId])
  @@index([approvalChainId])
  @@index([groupId])
  @@map("approvals")
}

model OperationLog {
  id         String   @id
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action     String
  module     String
  objectId   String
  objectType String
  details    Json?
  ip         String
  createdAt  DateTime @default(now())

  @@map("operation_logs")
}

model Notification {
  id        String    @id
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String
  title     String
  content   String?
  isRead    Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())

  @@map("notifications")
}

model DeviationReport {
  id              String     @id
  recordId        String
  record          TaskRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)
  templateId      String
  fieldName       String
  expectedValue   String
  actualValue     String
  toleranceMin    Float
  toleranceMax    Float
  deviationAmount Float
  deviationRate   Float      @default(0)
  deviationType   String
  reason          String
  status          String     @default("pending")
  reportedBy      String
  reportedAt      DateTime   @default(now())
  approvedBy      String?
  approvedAt      DateTime?
  comment         String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  deletedAt       DateTime?

  @@map("deviation_reports")
}

// P1-2: 角色权限系统
model Role {
  id          String   @id @default(cuid())
  code        String   @unique  // admin, leader, user
  name        String              // 管理员, 主管, 普通用户
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  users       User[]   @relation("UserRole")
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(cuid())
  resource    String              // document, template, task, approval
  action      String              // create, read, update, delete, approve
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  roles       RolePermission[]

  @@unique([resource, action])
  @@index([resource])
  @@map("permissions")
}

model RolePermission {
  id           String   @id @default(cuid())
  roleId       String
  role         Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}
