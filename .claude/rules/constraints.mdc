# AI实现约束清单

**优先级**: 最高
**目的**: 防止AI在实现过程中"乱发挥"

> **重要**: 本规则文件从所有角色和整个项目周期角度制定

## 角色覆盖

| 角色 | 关注点 | 约束章节 |
|------|--------|----------|
| AI/Agent | 技术选型、代码风格、功能边界 | 1-6章 |
| 前端开发者 | UI设计、组件规范 | 4章 |
| 后端开发者 | API设计、数据库、安全 | 5-7章 |
| 运维工程师 | 部署、监控、日志、备份 | 8章 |
| 测试工程师 | 测试规范、自动化 | 10章 |
| 项目主导者 | 设计变更、文档一致性 | 9章 |

## 项目周期覆盖

| 阶段 | 关注点 | 约束章节 |
|------|--------|----------|
| 需求 | 功能边界、不添加需求外功能 | 3章 |
| 设计 | 文档修改需讨论 | 9章 |
| 开发 | 技术选型、代码风格、API | 1-6章 |
| 测试 | 自动化优先、不改测试 | 10章 |
| 部署 | 部署规范、环境配置 | 8章 |
| 运维 | 日志、监控、备份 | 8章 |
| 迭代 | 版本管理、兼容性 | 11章 |

---

## 1. 技术选型约束（开发实现约束，不限制业务需求）

> **重要**: 本章约束仅针对开发实现方式，不限制业务功能扩展

| 约束项 | 具体要求 | 违规示例 |
|--------|----------|----------|
| **新增库需评估** | 参考 tech-stack.mdc 引入流程，允许直接引入轻量工具库 | 引入 jQuery、Moment.js |
| **禁止换框架** | Vue 3 → React、NestJS → Express | 私自重写为Express |
| **版本升级策略** | 补丁升级允许，小版本需评估，大版本需批准 | npm install vue@latest |

## 2. 代码风格约束

| 约束项 | 具体要求 | 违规示例 |
|--------|----------|----------|
| **禁止大重构** | 不修改文件结构、目录组织 | 把api/移到utils/ |
| **禁止重命名** | 不随意重命名文件、变量 | userService.ts → user.ts |
| **遵循模式** | 按文档中的模式实现 | 不用async/await改用.then |

## 3. 功能边界约束

| 约束项 | 具体要求 |
|--------|----------|
| **按需求实施** | 严格按照 docs/DESIGN.md 中定义的需求实施 |
| **禁止创新** | 不添加需求文档未定义的功能 |
| **遵循设计** | 实施前必须参考详细设计文档 |

## 4. UI设计约束

| 约束项 | 具体要求 |
|--------|----------|
| **组件库选择** | 必须用 Element Plus |
| **布局方式** | 必须用文档中的布局结构 |
| **样式规范** | 不自创样式，紧跟 Element Plus |
| **图标选择** | 必须用 Element Plus Icons |

## 5. 数据库约束

| 约束项 | 具体要求 |
|--------|----------|
| **Schema是真理** | 数据库结构以 schema.prisma 为准 |
| **优先使用 Prisma** | 标准 CRUD 用 Prisma，复杂查询可用 $queryRaw（参考 database.mdc）|
| **迁移记录** | 所有数据库变更必须生成迁移文件 |

## 6. API设计约束

| 约束项 | 具体要求 |
|--------|----------|
| **端点命名** | 必须用文档中的端点路径 |
| **请求方式** | 必须用文档中的HTTP方法 |
| **响应格式** | 必须符合文档中的错误码规范 |

## 7. 安全约束（覆盖所有角色）

### 7.1 数据安全

| 约束项 | 具体要求 | 适用角色 |
|--------|----------|----------|
| **禁止硬编码** | 密码、密钥、Token必须用环境变量 | AI、后端 |
| **敏感数据脱敏** | 日志中不打印敏感信息 | 后端、运维 |
| **最小权限** | 数据库连接使用最小必要权限 | 后端、DBA |
| **传输加密** | 所有API必须HTTPS | 运维、后端 |

### 7.2 输入安全

| 约束项 | 具体要求 | 适用角色 |
|--------|----------|----------|
| **必须校验** | 所有输入必须验证 | AI、后端 |
| **防止注入** | 参数化查询，XSS防护 | AI、后端 |
| **文件安全** | 文件上传类型限制、大小限制 | AI、后端 |

### 7.3 访问控制

| 约束项 | 具体要求 | 适用角色 |
|--------|----------|----------|
| **必须鉴权** | 未登录请求必须401 | AI、后端 |
| **权限检查** | 每个API必须检查权限 | AI、后端 |
| **审计日志** | 敏感操作必须记录日志 | 后端、运维 |

## 8. 运维约束（覆盖运维工程师角色）

### 8.1 部署规范

| 约束项 | 具体要求 |
|--------|----------|
| **环境隔离** | dev/staging/prod 环境严格分离 |
| **配置外部化** | 所有配置通过环境变量 |
| **不可变镜像** | Docker镜像构建后不修改 |
| **健康检查** | 必须实现健康检查端点 |

### 8.2 日志规范

| 约束项 | 具体要求 |
|--------|----------|
| **格式统一** | JSON格式，包含时间、级别、模块 |
| **级别正确** | ERROR用于错误，INFO用于操作 |
| **敏感过滤** | 密码、Token等不写入日志 |
| **保留期限** | 开发7天，生产30天 |

### 8.3 监控规范

| 约束项 | 具体要求 |
|--------|----------|
| **关键指标** | CPU、内存、磁盘、API响应时间 |
| **告警阈值** | CPU>80%、内存>85%、磁盘>90% |
| **可用性** | API可用性>99.9% |
| **响应时间** | P99 < 2秒 |

### 8.4 备份规范

| 约束项 | 具体要求 |
|--------|----------|
| **自动备份** | 数据库每日全量，MinIO每日增量 |
| **保留策略** | 数据库30天，MinIO 90天 |
| **恢复测试** | 每季度测试备份恢复 |
| **异地备份** | 生产环境考虑异地备份 |

### 8.5 容灾规范

| 约束项 | 具体要求 |
|--------|----------|
| **优雅关闭** | 支持SIGTERM，处理完当前请求 |
| **重试机制** | 失败操作自动重试（最多3次） |
| **熔断器** | 外部服务故障时自动熔断 |

## 9. 文档与变更约束（覆盖项目主导者角色）

### 9.1 文档维护

| 约束项 | 具体要求 | 适用角色 |
|--------|----------|----------|
| **设计文档** | 不自行修改 DESIGN.md，需讨论 | AI、开发者 |
| **测试用例** | 不自行修改 TEST-CASES.md，需讨论 | AI、测试 |
| **代码注释** | 只加必要的行内注释 | AI、开发者 |
| **README更新** | 新功能上线后更新README | 开发者 |

### 9.2 变更管理

| 约束项 | 具体要求 | 适用角色 |
|--------|----------|----------|
| **需求变更** | 必须记录在案，经过审批 | 项目主导者 |
| **设计变更** | 更新对应设计文档 | 开发者 |
| **架构变更** | 必须评审，影响范围评估 | 项目主导者 |

### 9.3 版本管理

| 约束项 | 具体要求 | 适用角色 |
|--------|----------|----------|
| **语义版本** | 主版本.次版本.修订号 | 开发者 |
| **变更日志** | 每个版本必须有CHANGELOG | 开发者 |
| **兼容性** | 破坏性变更必须大版本升级 | 开发者 |

## 10. 测试约束（覆盖测试工程师角色）

### 10.1 测试策略

| 约束项 | 具体要求 | 优先级 |
|--------|----------|--------|
| **自动化优先** | 优先写自动化测试 | 高 |
| **单元测试** | 核心逻辑必须有单元测试 | 高 |
| **集成测试** | API必须有集成测试 | 中 |
| **E2E测试** | 核心流程必须有E2E测试 | 中 |

### 10.1.1 前端E2E测试规则（新增）

| 约束项 | 具体要求 | 适用场景 |
|--------|----------|----------|
| **推荐使用 Playwright** | 前端 E2E 测试推荐使用 Playwright 或 Cypress | 完整用户流程测试 |
| **允许手动测试（MVP阶段）** | MVP 阶段允许 curl 测试 API + 手动点击验证 UI | 快速迭代验证 |
| **Chrome DevTools MCP** | 可选工具，复杂交互时使用 | 高级场景（可选）|
| **端到端验证** | 必须验证：页面渲染 → 用户交互 → API调用 → 结果展示 | 核心功能 |
| **渐进式测试** | MVP 阶段手动测试，稳定后补充自动化 | 项目周期 |

**当前项目状态**:
- ✅ 后端测试覆盖率 85.3%（164 tests passed）
- ⚠️ 前端未配置 E2E 测试框架
- 建议：稳定后补充 Playwright E2E 测试

### 10.2 测试数据

| 约束项 | 具体要求 |
|--------|----------|
| **模拟数据** | 测试数据用 Faker 或固定mock |
| **数据隔离** | 测试环境数据与生产隔离 |
| **可重复** | 测试必须可重复执行 |

### 10.3 测试覆盖

| 约束项 | 具体要求 |
|--------|----------|
| **边界测试** | 必须测试边界条件 |
| **异常测试** | 必须测试异常情况 |
| **安全测试** | 必须测试安全场景 10.4 |

### 测试纪律

| 约束项 | 具体要求 |
|--------|----------|
| **不改测试** | 不为通过测试而修改测试用例 |
| **测试隔离** | 测试之间互不影响 |
| **快速反馈** | 测试执行时间 < 5分钟 |

## 11. 性能与可扩展性约束

### 11.1 性能目标

| 指标 | 目标值 | 适用场景 |
|------|--------|----------|
| API响应时间 | P95 < 1秒 | 所有API |
| 页面加载时间 | < 3秒 | 前端页面 |
| 并发用户 | 50+ | 系统容量 |
| 数据库连接 | < 80% | 资源使用 |

### 11.2 可扩展性

| 约束项 | 具体要求 |
|--------|----------|
| **水平扩展** | 支持多实例部署 |
| **无状态** | 后端服务设计为无状态 |
| **缓存策略** | 热点数据必须缓存（Redis） |

## 12. 可访问性约束（覆盖最终用户角色）

### 12.1 基础可访问性

| 约束项 | 具体要求 |
|--------|----------|
| **键盘导航** | 所有功能可键盘操作 |
| **对比度** | 文字与背景对比度 > 4.5:1 |
| **图片替代** | 所有图片必须有alt文本 |
| **焦点指示** | 键盘焦点必须有可见指示 |

### 12.2 用户体验

| 约束项 | 具体要求 |
|--------|----------|
| **加载反馈** | 每个操作必须有加载反馈 |
| **错误提示** | 错误信息要友好、可理解 |
| **操作确认** | 危险操作必须有确认 |
| **响应式** | 适配1920x1080为主 |

## 13. 代码质量约束

### 13.1 静态检查

| 约束项 | 开发环境 | 生产环境 | 说明 |
|--------|----------|----------|------|
| **Lint通过** | warn | error | ESLint/Prettier 必须通过 |
| **类型安全** | error | error | TypeScript strict模式 |
| **no-console** | warn | error | 开发时允许调试，构建时必须移除 |
| **no-unused-vars** | warn | error | 开发时警告，构建时报错 |

### 13.2 代码复杂度

| 约束项 | 具体要求 |
|--------|----------|
| **函数长度** | 建议 < 50行，复杂业务逻辑允许 < 100行 |
| **文件长度** | 建议 < 500行，最大不超过 800行（与 CLAUDE.md 一致）|
| **圈复杂度** | 建议 < 10，最大不超过 15 |
| **重复代码** | 相同逻辑出现 ≥ 3 次时必须抽取（Rule of Three）|

**说明**:
- 通用工具函数、Service 方法：< 50 行
- Controller 方法（含参数验证）：< 80 行
- 复杂业务流程（工作流引擎、批次追溯）：< 100 行
- 超过 100 行必须拆分

### 13.3 依赖管理

| 约束项 | 具体要求 |
|--------|----------|
| **依赖锁定** | 使用package-lock.json或yarn.lock |
| **定期更新** | 每月检查安全漏洞 |
| **最小依赖** | 只引入必要的依赖 |

## 14. 数据管理约束

### 14.1 数据生命周期

| 约束项 | 具体要求 |
|--------|----------|
| **软删除** | 数据删除使用软删除（deleted_at） |
| **数据归档** | 超过1年的数据考虑归档 |
| **数据清理** | 清理策略必须定义 |

### 14.2 数据一致性

| 约束项 | 具体要求 |
|--------|----------|
| **事务** | 相关操作必须使用事务 |
| **乐观锁** | 并发更新使用乐观锁 |
| **唯一约束** | 业务唯一字段必须有唯一索引 |

---

## 15. 通用函数与代码复用约束（新增）

> **适用**: AI/Agent、前端开发者、后端开发者

### 15.1 工具函数管理

| 约束项 | 具体要求 | 违规处理 |
|--------|----------|----------|
| **工具函数统一** | 通用函数必须提取到 `client/src/utils/` 或 `server/src/common/utils/` | 重复实现已存在的函数 |
| **禁止重复实现** | 已存在的工具函数禁止重新实现 | 重构到公共目录 |
| **日期处理** | 必须使用 dayjs，禁止自己写日期格式化 | 自己写日期格式化 |
| **密码加密** | 必须使用 bcrypt，禁止自己实现加密 | 自己实现加密 |

### 15.2 前端组件复用

| 约束项 | 具体要求 | 违规示例 |
|--------|----------|----------|
| **公共组件** | 相同UI必须提取到 `client/src/components/` | 在多个页面重复写相同UI |
| **API封装** | 统一使用 `client/src/api/index.js` 的axios实例 | 直接使用axios |
| **状态管理** | 用户状态用user.js，消息状态用notification.js | 滥用多个store |
| **路由配置** | 统一在 `client/src/router/index.js` 中配置 | 分散路由配置 |
| **样式隔离** | 组件样式必须使用 scoped | 全局样式污染 |

### 15.3 后端模块复用

| 约束项 | 具体要求 | 违规示例 |
|--------|----------|----------|
| **Excel解析** | 必须使用 xlsx 库 | 使用其他解析库 |
| **JWT操作** | 必须使用 jsonwebtoken 库 | 自己实现JWT |
| **MinIO操作** | 必须使用 `server/src/common/utils/file.util.ts` | 直接调用MinIO API |

---

## 16. 异常处理约束（新增）

> **适用**: AI/Agent、前端开发者、后端开发者

### 16.1 后端异常处理

| 约束项 | 具体要求 | 违规处理 |
|--------|----------|----------|
| **try-catch** | 所有API必须有 try-catch 异常处理 | API无异常处理 |
| **错误格式** | 错误响应必须包含 code、message、details | 错误格式不统一 |
| **友好提示** | 错误信息对用户友好，不暴露内部细节 | 暴露内部错误堆栈 |
| **日志记录** | 错误必须记录日志（ERROR级别） | 错误不记录 |

### 16.2 前端异常处理

| 约束项 | 具体要求 |
|--------|----------|
| **请求错误** | 所有HTTP请求必须有错误处理 |
| **全局捕获** | 前端必须有全局错误捕获机制 |
| **错误提示** | 对用户显示友好的错误信息 |

---

## 17. 文件处理约束（新增）

> **适用**: AI/Agent、前端开发者、后端开发者
> **范围**: 仅限用户通过系统上传的业务文件，不包括开发过程中的临时文档（如 .md、.txt 等）

| 约束项 | 具体要求 | 违规处理 |
|--------|----------|----------|
| **用户上传文件类型** | 仅支持 PDF、Word、Excel（通过系统上传到 MinIO 的业务文件）| 上传其他类型文件 |
| **开发文档** | 允许创建 .md、.txt 等开发文档（用于临时总结、规划等）| 不受限制 |
| **文件大小** | 单文件最大 10MB | 无大小限制 |
| **上传方式** | 必须用 multipart/form-data | 其他上传方式 |
| **文件存储** | 必须上传到 MinIO，禁止存数据库 | 直接存数据库 |
| **进度反馈** | 文件上传必须有进度条 | 无进度反馈 |
| **文件名处理** | 上传前清理特殊字符，防止注入 | 未清理文件名 |

---

## 18. 国际化与字符串约束（新增）

> **适用**: AI/Agent、前端开发者

| 约束项 | 具体要求 |
|--------|----------|
| **界面语言** | 固定为中文，不做国际化 |
| **字符串提取** | 用户可见的字符串提取到常量 |
| **禁止硬编码文本** | 模板中的文字必须使用中文常量 |

---

## 19. 第三方集成约束（新增）

> **适用**: AI/Agent、后端开发者

| 约束项 | 具体要求 | 违规处理 |
|--------|----------|----------|
| **MinIO操作** | 必须使用 `server/src/common/utils/file.util.ts` | 直接调用MinIO API |
| **数据库操作** | 必须使用 Prisma Client | 直接执行SQL |
| **缓存操作** | 必须使用 Redis Client | 直接调用Redis |
| **禁止绕过封装** | 不能绕过现有封装直接调用第三方服务 | 直接调用第三方 |

---

## 20. 项目涉及的所有角色（新增）

| 角色 | 职责 | 核心关注点 |
|------|------|------------|
| **AI/Agent** | 代码实现 | 技术选型、代码风格、功能边界、安全 |
| **前端开发者** | Vue 3前端开发 | UI规范、组件复用、用户体验 |
| **后端开发者** | NestJS后端开发 | API设计、数据库、安全、性能 |
| **运维工程师** | 部署与运维 | Docker、日志、监控、备份 |
| **测试工程师** | 质量保障 | 测试覆盖、测试纪律 |
| **DBA** | 数据库管理 | 迁移、性能优化、数据一致性 |
| **项目主导者** | 项目管理 | 需求变更、文档维护、版本管理 |
| **最终用户** | 系统使用者 | 可访问性、用户体验 |

---

## 21. AI/Agent 实现前快速检查清单（新增，必须逐项通过）

在实现任何功能前，AI/Agent **必须**逐项回答以下问题：

### 技术选型检查（必须全部通过）
```
□ 1. 这个功能在 docs/DESIGN.md 需求文档中吗？
   - 是 → 继续
   - 否 → 停止，询问是否需要添加

□ 2. 这个库在技术栈清单里吗？
   - 前端：dayjs、lodash-es
   - 后端：xlsx、bcrypt、jsonwebtoken、class-validator
   - 是 → 继续
   - 否 → 停止，询问是否需要引入

□ 3. 这个框架是文档中指定的框架吗？
   - Vue 3 / NestJS
   - 是 → 继续
   - 否 → 停止，使用指定框架
```

### 代码规范检查（必须全部通过）
```
□ 4. 这个UI符合 Element Plus 规范吗？
   - 是 → 继续
   - 否 → 停止，改用 Element Plus 方式

□ 5. 这个API端点在文档里吗？
   - 是 → 继续
   - 否 → 停止，使用文档中定义的端点

□ 6. 这样改会破坏现有结构吗？
   - 不会 → 继续
   - 会 → 停止，讨论后再改

□ 7. 相同功能是否已存在公共函数/组件？
   - 是 → 使用现有函数/组件
   - 否 → 继续实现
```

### 安全检查（必须全部通过）
```
□ 8. 密码/密钥硬编码了吗？
   - 没有 → 继续
   - 有 → 停止，改用环境变量

□ 9. 敏感信息写入日志了吗？
   - 没有 → 继续
   - 有 → 停止，移除敏感信息

□ 10. 输入验证做了吗？
   - 是 → 继续
   - 否 → 停止，添加验证

□ 11. 权限检查做了吗？
   - 是 → 继续
   - 否 → 停止，添加权限检查

□ 12. 文件类型/大小是否限制？
   - 是 → 继续
   - 否 → 停止，添加限制
```

### 代码质量检查（必须全部通过）
```
□ 13. 异常处理是否完整？
   - 是 → 继续
   - 否 → 停止，补充异常处理

□ 14. ESLint/Prettier 能通过吗？
   - 能 → 继续
   - 否 → 停止，修复Lint问题

□ 15. 函数长度 < 50行吗？
   - 是 → 继续
   - 否 → 停止，拆分函数

□ 16. 重复代码提取了吗？
   - 是 → 继续
   - 否 → 停止，提取到公共模块
```

### 测试检查
```
□ 17. 有对应的测试吗？
   - 核心逻辑必须有测试
   - 是 → 继续
   - 否 → 补充测试

□ 18. 测试覆盖率达标吗？
   - 核心模块 > 80%
   - 是 → 继续
   - 否 → 补充测试
```

### 文档检查
```
□ 19. 代码注释充分吗？
   - 复杂逻辑必须注释
   - 是 → 继续
   - 否 → 补充注释

□ 20. 需要更新README吗？
   - 新功能上线后更新
   - 是 → 更新
   - 否 → 继续
```

**任何一项检查不通过，必须停止实现，先解决问题！**

---

## 22. 完整违规处理清单（新增）

| 场景 | 处理方式 | 责任人 |
|------|----------|--------|
| AI引入未授权库 | 回滚，移除该库 | AI |
| AI私自改架构 | 停止，讨论意图 | AI |
| AI添加需求外功能 | 不提交，标记为"待讨论" | AI |
| AI硬编码密码 | 立即修复，改用环境变量 | AI |
| AI跳过异常处理 | 立即补充，不允许上线 | AI |
| AI重复实现已有函数 | 重构，提取到公共模块 | AI |
| AI不使用Element Plus | 立即改用Element Plus | AI |
| AI不使用Prisma | 立即改用Prisma | AI |
| AI不限制文件类型/大小 | 立即添加限制 | AI |
| AI不校验输入 | 立即添加验证 | AI |
| 人类开发者违规 | 代码审查时拦截 | 开发者/Reviewer |
| 运维配置错误 | 回滚，发布补丁 | 运维工程师 |
| 测试覆盖不足 | 补充测试用例 | 测试工程师 |
| 数据库变更无迁移 | 补全迁移文件 | 后端/DBA |

---

## 23. 代码简洁性约束 - Good Taste（强制标准）

> **来源**: 用户核心哲学 - "好品味"是第一准则

### 23.1 消除边界原则

| 约束项 | 具体要求 | 来源 |
|--------|----------|------|
| **消除边界** | 优先重构代码使特殊情况消失，而非增加if判断 | Good Taste案例 |
| **优于判断** | 特殊情况消失优于特殊情况处理 | Good Taste |
| **优雅方案** | 追求优雅解决方案，不只是"能用" | Good Taste |

**示例**:
```
反例: 10行带if判断的链表删除
正例: 4行无条件分支（重构使边界消失）
```

### 23.2 函数短小原则

| 约束项 | 具体要求 | 来源 |
|--------|----------|------|
| **函数长度** | < 50行（强制） | 简洁执念 |
| **单一职责** | 函数只做一件事并做好 | 简洁执念 |
| **入口单一** | 函数只有一个入口一个出口 | 简洁执念 |

### 23.3 缩进限制原则

| 约束项 | 具体要求 | 来源 |
|--------|----------|------|
| **缩进层数** | 尽量避免超过3层缩进 | 简洁执念 |
| **超标重构** | 超过3层缩进应重构 | 简洁执念 |
| **卫语句** | 使用早期return减少嵌套 | 简洁执念 |

**重构方法**:
- 提取子函数
- 使用卫语句（早期return）
- 合并条件判断

### 23.4 命名清晰原则

| 约束项 | 具体要求 | 来源 |
|--------|----------|------|
| **命名风格** | 清晰直接，参考C风格 | 简洁执念 |
| **自解释** | 命名能说明用途，不过度缩写 | 简洁执念 |
| **一致性** | 同类型变量命名风格一致 | 简洁执念 |

---

## 24. 向后兼容约束 - Never break userspace（强制标准）

> **来源**: 用户核心哲学 - "我们不破坏用户空间"

### 24.1 禁止破坏原则

| 约束项 | 具体要求 | 来源 |
|--------|----------|------|
| **不破坏现有** | 任何代码变更不能破坏现有功能 | Never break userspace |
| **理论正确≠正确** | 即使"理论正确"，破坏现有也是bug | Never break userspace |
| **用户空间** | 内核服务用户，不是教育用户 | Never break userspace |

### 24.2 兼容优先原则

| 约束项 | 具体要求 | 来源 |
|--------|----------|------|
| **兼容性神圣** | 向后兼容性神圣不可侵犯 | Never break userspace |
| **渐进变更** | 破坏性变更必须走大版本升级流程 | Never break userspace |
| **废弃流程** | 废弃功能必须经过废弃流程 | 向后兼容 |

### 24.3 版本管理原则

| 约束项 | 具体要求 | 来源 |
|--------|----------|------|
| **语义版本** | 遵循主版本.次版本.修订号 | 向后兼容 |
| **破坏性变更** | 必须主版本升级 | 向后兼容 |
| **变更日志** | 每个版本必须有CHANGELOG | 向后兼容 |

---

## 25. 实用主义约束

> **来源**: 用户核心哲学 - "我是个该死的实用主义者"

### 25.1 真问题优先

| 约束项 | 具体要求 | 来源 |
|--------|----------|------|
| **拒绝臆想** | 解决真问题，拒绝臆想出来的威胁 | Linus问题1 |
| **问题验证** | 先确认这是真实问题 | Linus问题1 |
| **避免过度** | 不为假想威胁设计复杂方案 | Linus问题1 |

### 25.2 最简方案

| 约束项 | 具体要求 | 来源 |
|--------|----------|------|
| **寻找最简** | 永远寻找更简单的方法 | Linus问题2 |
| **KISS原则** | Keep It Simple, Stupid | 实用主义 |
| **拒绝复杂** | 拒绝"理论完美"但实际复杂的方案 | 实用主义 |

### 25.3 三问验证

| 约束项 | 具体要求 | 来源 |
|--------|----------|------|
| **问题1** | "这是个真问题还是臆想出来的？" | Linus问题1 |
| **问题2** | "有更简单的方法吗？" | Linus问题2 |
| **问题3** | "会破坏什么吗？" | Linus问题3 |

**AI行为**: 在实现任何功能前，必须先问自己这三个问题。

---

## 26. 沟通风格约束（对AI的强制要求）

> **来源**: 用户核心哲学 - "直接、犀利、零废话"

### 26.1 技术沟通原则

| 约束项 | 具体要求 | 来源 |
|--------|----------|------|
| **直接犀利** | 技术批评直接，不委婉、不模糊 | 沟通原则 |
| **代码评审** | 代码垃圾时，明确告知为什么垃圾 | 沟通原则 |
| **不说废话** | 零废话，效率优先 | 沟通原则 |

### 26.2 代码评审风格

| 约束项 | 具体要求 | 来源 |
|--------|----------|------|
| **明确指出** | 垃圾代码必须明确指出问题 | 沟通原则 |
| **说明原因** | 不仅指出问题，还要说明为什么 | 沟通原则 |
| **技术导向** | 批评针对技术问题，不针对人 | 沟通原则 |

**示例**:
```
反例: "这个代码可能有一些可以优化的地方"
正例: "这个函数超过100行，必须拆分成多个小于50行的函数。
       超过3层缩进会导致代码难以维护，应该使用卫语句重构。"
```

### 26.3 语言处理原则

| 约束项 | 具体要求 | 来源 |
|--------|----------|------|
| **英语思考** | 内部逻辑英语思考，对话中文输出 | 语言要求 |
| **中英对照** | 技术术语可保留英文 | 语言要求 |
| **清晰表达** | 用中文清晰表达技术内容 | 语言要求 |

### 26.4 需求确认流程

| 约束项 | 具体要求 | 来源 |
|--------|----------|------|
| **三问验证** | 每个方案先问3个Linus问题 | 需求确认 |
| **拒绝盲目** | 不盲目接受用户需求，先分析 | 需求确认 |
| **提出质疑** | 如果方案有问题，明确提出质疑 | 沟通原则 |

---

## 快速检查清单（实现前必读）

实现前检查：

```
1. 功能在 docs/DESIGN.md 需求文档中吗？
2. 这个库在技术栈清单里吗？
3. 这个UI符合 Element Plus 规范吗？
4. 这个API端点在文档里吗？
5. 这样改会破坏现有结构吗？
6. 密码/密钥硬编码了吗？
7. 敏感信息写入日志了吗？
8. 有对应的测试吗？
9. 性能达标吗？
10. 文档更新了吗？
11. 函数是否<50行？
12. 缩进是否超过3层？
13. 是否消除了边界情况？
14. 是否满足向后兼容？
```

---

## 违规处理

| 场景 | 处理方式 | 责任人 |
|------|----------|--------|
| AI引入未授权库 | 回滚，移除该库 | AI |
| AI私自改架构 | 停止，讨论意图 | AI |
| AI添加需求外功能 | 不提交，标记为"待讨论" | AI |
| AI硬编码密码 | 立即修复，改用环境变量 | AI |
| AI代码违反Good Taste | 重构，追求优雅方案 | AI |
| AI违反向后兼容 | 回滚，恢复兼容 | AI |
| AI沟通不直接 | 修正，直接犀利表达 | AI |
| 人类开发者违规 | 代码审查时拦截 | 开发者/Reviewer |
| 运维配置错误 | 回滚，发布补丁 | 运维工程师 |
| 测试覆盖不足 | 补充测试用例 | 测试工程师 |

---

## 规则版本管理

| 版本 | 日期 | 变更 |
|------|------|------|
| 4.0 | 2025-01-31 | 融入用户Coding Principle：代码简洁性(Good Taste)、向后兼容(Never break userspace)、实用主义、沟通风格 |
| 3.0 | 2025-01-31 | 完整版：新增通用函数、异常处理、文件处理、国际化、第三方集成、角色清单、快速检查清单、完整违规处理 |
| 2.0 | 2025-01-31 | 全面扩展，覆盖所有角色和项目周期 |
| 1.0 | 2025-01-31 | 初始版本 |

**审查日期**: 2025-01-31
**审查人**: 项目主导者
**下次审查**: 2025-03-01

---

## 27. Docker 开发环境约束（新增）

> **目的**: 明确项目使用 Docker 进行开发，本地不重复安装运行服务

### 27.1 服务运行方式

| 约束项 | 具体要求 | 违规示例 |
|--------|----------|----------|
| **数据库** | PostgreSQL 必须通过 Docker 运行 | 本地安装 PostgreSQL |
| **缓存** | Redis 必须通过 Docker 运行 | 本地安装 Redis |
| **对象存储** | MinIO 必须通过 Docker 运行 | 本地安装 MinIO |
| **不重复** | Docker 已有的服务，本地不再安装运行 | 本地起多个实例 |

### 27.2 连接方式

| 约束项 | 具体要求 | 连接地址示例 |
|--------|----------|--------------|
| **PostgreSQL** | 连接 Docker 容器 | `localhost:5432` |
| **Redis** | 连接 Docker 容器 | `localhost:6379` |
| **MinIO** | 连接 Docker 容器 | `localhost:9000` |

### 27.3 启动命令

```bash
# 开发环境启动（必须使用）
docker-compose up -d

# 不允许本地直接运行
# ❌ 不允许: pg_ctl start
# ❌ 不允许: redis-server
# ❌ 不允许: ./minio server
```

### 27.4 违规处理

| 场景 | 处理方式 |
|------|----------|
| 本地安装 PostgreSQL | 停止，使用 Docker |
| 本地安装 Redis | 停止，使用 Docker |
| 本地安装 MinIO | 停止，使用 Docker |
| 本地启动服务实例 | 停止，使用 Docker |
